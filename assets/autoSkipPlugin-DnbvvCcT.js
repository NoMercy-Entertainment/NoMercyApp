var d=Object.defineProperty;var y=(n,r,t)=>r in n?d(n,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[r]=t;var a=(n,r,t)=>y(n,typeof r!="symbol"?r+"":r,t);import{aa as c,R as m}from"./vue-ionic-D3xJGFcP.js";import{P as u}from"./video-player-B8ZC2WFO.js";import{bJ as l,bK as f}from"./index-m4cPkZcj.js";import{b as g}from"./buttons-DnucOQvv.js";class S extends u{constructor(){super(...arguments);a(this,"player",{});a(this,"route",{})}async initialize(t){this.player=t}use(){this.player.on("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.on("back",this.ended.bind(this)),this.player.on("ended",this.ended.bind(this)),this.player.on("finished",this.ended.bind(this)),this.route=c()}dispose(){this.player.off("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.off("back",this.ended.bind(this)),this.player.off("ended",this.ended.bind(this)),this.player.off("finished",this.ended.bind(this))}lastTimeTrigger(){var i;const t=this.episodeData(),e=l();(i=e==null?void 0:e.invoke)==null||i.call(e,"SetTime",t)}ended(){var e,i;const t=this.player.getCurrentTime()/this.player.getDuration()*100;if(this.player.isLastPlaylistItem()&&((e=this.player.playlistItem())==null?void 0:e.playlist_type)==="tv"&&t>=90){const s=l();s==null||s.invoke("RemoveWatched",this.episodeData()).then()}else if(this.player.isLastPlaylistItem()&&((i=this.player.playlistItem())==null?void 0:i.playlist_type)==="movie"&&t>=80){const s=l();s==null||s.invoke("RemoveWatched",this.episodeData()).then()}this.dispose(),this.player.dispose()}episodeData(){var h;const t=this.player.playlistItem();let e=(h=this.route)==null?void 0:h.path;e||(e=window.location.hash.replace("#","")),e||(e=location.pathname);const i=e==null?void 0:e.split("/");let s,o,p=t==null?void 0:t.tmdb_id;return i.at(-3)==="specials"?s=i.at(-2):i.at(-3)==="collection"&&(o=i.at(-2),p=t.id),{video_id:t==null?void 0:t.video_id,tmdb_id:p,playlist_type:i.at(-3),special_id:s,collection_id:o,video_type:t==null?void 0:t.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}}class T extends u{constructor(){super(...arguments);a(this,"player",{});a(this,"introPatterns",[/^OP$/ui,/^NCOP$/ui,/^Opening$/ui,/^Opening/ui,/^Opening Credits$/ui,/^Opening Theme$/ui,/^Opening Song$/ui,/^Epilogue$/ui]);a(this,"outroPatterns",[/^ED$/ui,/^PV$/ui,/^NCED$/ui,/^CM$/ui,/^Preview$/ui,/^Next Episode Preview$/ui,/^Next Time Preview$/ui,/^Outro$/ui,/^Ending/ui,/^Prologue$/ui,/^ED\+Cast$/ui,/^Credits$/ui,/^End Credits$/ui,/^Closing$/ui]);a(this,"buttons",{});a(this,"autoSkip",!1);a(this,"lastChapter","");a(this,"skipButtonElement",null)}initialize(t){this.player=t,this.player.options.introPatterns&&(this.introPatterns=this.player.options.introPatterns),this.player.options.outroPatterns&&(this.outroPatterns=this.player.options.outroPatterns),this.player.options.autoSkip!==void 0?this.autoSkip=this.player.options.autoSkip:this.autoSkip=localStorage.getItem("nmplayer-auto-skip")==="true",this.buttons=g()}use(){this.player.on("time",this.checkChapters.bind(this))}dispose(){this.player.off("time",this.checkChapters.bind(this))}getChapterType(t){return this.introPatterns.some(e=>e.test(t))?"intro":this.outroPatterns.some(e=>e.test(t))?"next":null}checkChapters(){if(!this.player.chapters||!this.player.chapters.cues||this.player.chapters.cues.length===0){this.hideSkipButton();return}if(this.player.chapters.errors.length>0){console.error("Error parsing chapters:",this.player.chapters.errors),this.hideSkipButton();return}const t=this.player.getVideoElement().currentTime;let e=this.getCurrentChapter(t);if(!e){this.hideSkipButton();return}if(this.shouldSkipChapter(e.text)){if(this.lastChapter!==e.text){this.lastChapter=e.text;const i=this.getNextChapter(e.endTime);if(!i){this.player.next(),this.lastChapter="";return}this.autoSkip?(this.hideSkipButton(),this.player.seek(i.startTime)):this.showSkipButton()}}else this.hideSkipButton()}isFirstOrLastEpisodeOfSeason(){const t=this.player.playlistItem();if(t.episode==1)return!0;const e=this.player.getPlaylist().map(o=>m(o)),s=f(e,"season")[t.season];return s?s.at(-1)==t:!1}shouldSkipChapter(t){return this.player.getCurrentTime()<this.player.getDuration()/2&&this.player.getPlaylistIndex()==0||this.player.getCurrentTime()>this.player.getDuration()/2&&this.player.isLastPlaylistItem()||this.isFirstOrLastEpisodeOfSeason()?!1:this.introPatterns.some(e=>e.test(t))||this.outroPatterns.some(e=>e.test(t))}getCurrentChapter(t){return this.player.chapters.cues.find(e=>t>=e.startTime&&t<=e.endTime)}getNextChapter(t){return this.player.chapters.cues.find(e=>e.startTime>=t)}showSkipButton(){if(this.skipButtonElement){this.skipButtonElement.classList.add("visible");return}const t=this.player.createElement("button","skip-chapter-button").addClasses(["skip-chapter-button","flex","items-center","justify-center","gap-2","text-sm","text-white","bg-neutral-800","rounded","hover:bg-neutral-700","px-2","py-1","absolute","bottom-20","right-6","z-10","transition-opacity","duration-300","opacity-0","invisible"]).appendTo(this.player.overlay).get();let i=this.getChapterType(this.lastChapter)==="intro"?this.player.localize("Skip intro"):this.player.localize("Skip outro");t.title=i,this.player.createSVGElement(t,"chevronR",this.buttons.chevronR,!1,!1).classList.add("w-4","h-4");const o=this.player.createElement("span","skip-chapter-text").addClasses(["hidden","md:inline"]).appendTo(t).get();o.textContent=i,t.addEventListener("click",this.player.nextChapter.bind(this.player)),this.skipButtonElement=t,requestAnimationFrame(()=>{t.classList.remove("opacity-0","invisible"),t.classList.add("opacity-100","visible")}),t.focus()}hideSkipButton(){this.skipButtonElement&&(this.skipButtonElement.classList.remove("opacity-100","visible"),this.skipButtonElement.classList.add("opacity-0","invisible"),setTimeout(()=>{this.skipButtonElement&&(this.skipButtonElement.remove(),this.skipButtonElement=null)},300))}}export{T as A,S};
