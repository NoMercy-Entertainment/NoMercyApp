var u=Object.defineProperty;var y=(r,s,e)=>s in r?u(r,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[s]=e;var o=(r,s,e)=>y(r,typeof s!="symbol"?s+"":s,e);import{be as c,es as h,bJ as g,et as f}from"./index-C1NpE9xT.js";import{P as d,S as m}from"./subtitles-octopus-Cuo72qQO.js";class T extends d{constructor(){super(...arguments);o(this,"player",{});o(this,"route",{})}async initialize(e){this.player=e}use(){this.player.on("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.on("back",this.ended.bind(this)),this.player.on("ended",this.ended.bind(this)),this.player.on("finished",this.ended.bind(this)),this.route=c()}dispose(){this.player.off("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.off("back",this.ended.bind(this)),this.player.off("ended",this.ended.bind(this)),this.player.off("finished",this.ended.bind(this))}lastTimeTrigger(){var i;const e=this.episodeData(),t=h();(i=t==null?void 0:t.invoke)==null||i.call(t,"SetTime",e)}ended(){var t,i;const e=this.player.getCurrentTime()/this.player.getDuration()*100;if(this.player.isLastPlaylistItem()&&((t=this.player.playlistItem())==null?void 0:t.playlist_type)==="tv"&&e>=90){const a=h();a==null||a.invoke("RemoveWatched",this.episodeData()).then()}else if(this.player.isLastPlaylistItem()&&((i=this.player.playlistItem())==null?void 0:i.playlist_type)==="movie"&&e>=80){const a=h();a==null||a.invoke("RemoveWatched",this.episodeData()).then()}this.dispose(),this.player.dispose()}episodeData(){var n;const e=this.player.playlistItem();let t=(n=this.route)==null?void 0:n.path;t||(t=window.location.hash.replace("#","")),t||(t=location.pathname);const i=t==null?void 0:t.split("/");let a,l,p=e==null?void 0:e.tmdb_id;return i.at(-3)==="specials"?a=i.at(-2):i.at(-3)==="collection"&&(l=i.at(-2),p=e.id),{video_id:e==null?void 0:e.video_id,tmdb_id:p,playlist_type:i.at(-3),special_id:a,collection_id:l,video_type:e==null?void 0:e.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}}class P extends d{constructor(){super(...arguments);o(this,"player",{});o(this,"chapterSkipPatterns",[/^OP$/ui,/^ED$/ui,/^PV$/ui,/^NCOP$/ui,/^NCED$/ui,/^CM$/ui,/^Preview$/ui,/^Next Episode Preview$/ui,/^Next Time Preview$/ui,/^Outro$/ui,/^Opening$/ui,/^Ending$/ui,/^Opening/ui,/^Ending/ui,/^Opening Credits$/ui,/^Ending Credits$/ui,/^Opening Theme$/ui,/^Ending Theme$/ui,/^Opening Song$/ui,/^Ending Song$/ui,/^Prologue$/ui,/^Epilogue$/ui,/^ED+Cast$/ui,/^Avant$/ui,/^Yokoku$/ui]);o(this,"lastChapter","")}initialize(e){this.player=e,this.player.options.chapterSkipPatterns&&(this.chapterSkipPatterns=this.player.options.chapterSkipPatterns)}use(){this.player.on("time",this.checkChapters.bind(this))}dispose(){this.player.off("time",this.checkChapters.bind(this))}checkChapters(){if(!this.player.chapters||!this.player.chapters.cues||this.player.chapters.cues.length===0)return;if(this.player.chapters.errors.length>0){console.error("Error parsing chapters:",this.player.chapters.errors);return}const e=this.player.getVideoElement().currentTime;let t=this.getCurrentChapter(e);if(t)for(;this.lastChapter!=t.text&&this.shouldSkipChapter(t.text);){this.lastChapter=t.text;const i=this.getNextChapter(t.endTime);if(!i){this.player.next(),this.lastChapter="";return}t=i,this.player.seek(t.startTime)}}isFirstOrLastEpisodeOfSeason(){const e=this.player.playlistItem();if(e.episode==1)return!0;const t=this.player.getPlaylist().map(l=>g(l)),a=f(t,"season")[e.season];return a?a.at(-1)==e:!1}shouldSkipChapter(e){return this.player.getCurrentTime()<this.player.getDuration()/2&&this.player.getPlaylistIndex()==0||this.player.getCurrentTime()>this.player.getDuration()/2&&this.player.isLastPlaylistItem()||this.isFirstOrLastEpisodeOfSeason()?!1:this.chapterSkipPatterns.some(t=>t.test(e))}getCurrentChapter(e){return this.player.chapters.cues.find(t=>e>=t.startTime&&e<=t.endTime)}getNextChapter(e){return this.player.chapters.cues.find(t=>t.startTime>=e)}}class k extends d{initialize(s){this.player=s}use(){this.player.on("captionsChanged",this.opus.bind(this))}dispose(){this.player.off("captionsChanged",this.opus.bind(this)),this.destroy()}destroy(){var s;(s=this.player.octopusInstance)==null||s.dispose(),this.player.octopusInstance=null}async opus(){var i,a;this.destroy();const s=this.player.getSubtitleFile()?`${this.player.options.basePath??""}${this.player.getSubtitleFile()}`:null;if(!s)return;const e=(i=s==null?void 0:s.match(/\w+\.\w+\.\w+$/u))==null?void 0:i[0];let[,,t]=e?e.split("."):[];if(t||(t=s.split(".").at(-1)||""),!(t!="ass"&&t!="ssa")&&s){await this.player.fetchFontFile();const l=(a=this.player.fonts)==null?void 0:a.map(n=>`${this.player.options.basePath??""}${n.file}`);this.player.getElement().querySelectorAll(".libassjs-canvas-parent").forEach(n=>n.remove());const p={video:this.player.getVideoElement(),subUrl:s,fonts:l,lossyRender:this.player.options.lossyRender,accessToken:this.player.options.accessToken,targetFps:this.player.options.targetFps,debug:this.player.options.debug,blendRender:this.player.options.blendRender,lazyFileLoading:this.player.options.lazyFileLoading,renderAhead:this.player.options.renderAhead,workerUrl:"/js/octopus/subtitles-octopus-worker.js",legacyWorkerUrl:"/js/octopus/subtitles-octopus-worker-legacy.js",fallbackFont:"/js/octopus/default.ttf",onReady:async()=>{},onError:n=>{console.error("opus error",n)}};console.log(p),s&&s.includes(".ass")&&(this.player.octopusInstance=new m(p))}}}export{P as A,k as O,T as S};
