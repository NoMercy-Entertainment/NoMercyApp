import{Bn as X,Bt as T,Gt as z,Ln as i,Mt as q,Rn as Z,Rt as o,Tt as H,Vn as v,Vt as w,Wt as ee,cn as c,fn as te,i as se,kn as k,qt as ae,u as oe,un as G,xn as Q,zt as re}from"./index-BvWvvCYJ.js";import"./dist-BihaqBnv.js";import"./esm-DfDPtva3.js";import"./esm-BqAMc7kU.js";import"./dist-V4VIRk0I.js";import"./focus-visible-BIx781Si.js";import"./index5-BzLuPScY.js";import"./client-CpuErVxZ.js";import"./ionic-global-CJmx_-hb.js";import"./hardware-back-button-B_o37u13.js";import"./index3-G0l1u6i6.js";import"./helpers-DowMkPjD.js";import"./index6-izL1HMLp.js";import"./index8-C7t1VdhY.js";import"./keyboard-DgjSUzE9.js";import"./index2-DPECLsCu.js";import"./ios.transition-DhveEC6M.js";import"./keyboard2-B9XnMMBK.js";import"./md.transition-BBFMewM_.js";import"./dir-t1mBJu83.js";import"./ui-Dy-CmVFO.js";import"./client-Cg1KDvig.js";import{g as Y,t as R}from"./currentServer-WcAeFY_n.js";import{s as ie}from"./config-BZ-AEJ_J.js";import"./core-B2UrLovc.js";import"./esm-BmSfvbpt.js";import"./global-BWQ-eDb8.js";import"./esm-B0CTWw_3.js";import"./bundle-mjs-D4lrAgGd.js";import{s as j}from"./user-UVXKBmDM.js";import{t as le}from"./serverClient-BAqmq0Lj.js";import"./router-B1ISlAzM.js";import"./utils-CG-VUeeR.js";import"./useBaseQuery-CObiDOM4.js";import"./useInfiniteServerClient-C-13EaEr.js";import"./SocketClient-C4CiAzV3.js";import"./useQueryClient-Do_6BzeG.js";import"./useQuery-DwL9nltn.js";import"./apiClient--wowvE-1.js";import"./notifications-BlOU5FHA.js";import"./utils-TI96o6zm.js";import"./deviceInfo-a8a7PneO.js";import"./auth-MTzvpPik.js";import"./MoooomIcon-BaTKWN1R.js";import"./useServerClient-DLV471Yh.js";import"./ScrollContainer-DjWu4Vc3.js";import"./useMounted-CnhTd848.js";import"./RipperOverlay-CzyITd0l.js";import"./HubConnection-Dx0QDLJI.js";import"./ripperSocket-CWtiUjVT.js";import"./Button-4dOHt061.js";import"./FloatingBackButton-BSBTmx49.js";import{t as ne}from"./DashboardLayout-C2xIJrWX.js";H();function ue(){const $=k(!1),x=k(0),b=k(0),E=k(0),P=k(0),r=k([]),f=k(!1);let m=null;function B(){b.value=r.value.filter(a=>a.status==="completed").length}function V(){f.value||(m?.postMessage({controls:{type:"pause"}}),r.value.forEach(a=>{a.status!=="completed"&&(a.status="paused",a.children.forEach(s=>{s.status!=="completed"&&(s.status="paused")}))}),f.value=!0)}function U(){if(f.value){const a=r.value.filter(s=>s.status==="paused");a.length>0&&(a[0].status="pending",a[0].children.forEach(s=>{s.status==="paused"&&(s.status="pending")}),a.slice(1).forEach(s=>{s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})}),m?.postMessage({controls:{type:"resume",pausedIds:a.map(s=>s.id)}})),f.value=!1}}function S(a){const s=r.value.find(e=>e.id===a);s&&(s.status==="downloading"||s.status==="pending"||s.status==="waiting")&&(m?.postMessage({controls:{type:"pauseItem",itemId:a}}),s.status="paused",s.children.forEach(e=>{(e.status==="downloading"||e.status==="pending"||e.status==="waiting")&&(e.status="paused")}),r.value.every(e=>e.status==="completed"||e.status==="paused")&&(f.value=!0))}function D(a){const s=r.value.find(e=>e.id===a);s&&s.status==="paused"&&(m?.postMessage({controls:{type:"resumeItem",itemId:a}}),r.value.find(e=>e.status==="downloading"||e.status==="pending")?(s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})):(s.status="pending",s.children.forEach(e=>{e.status==="paused"&&(e.status="pending")})),r.value.some(e=>e.status==="downloading"||e.status==="pending")&&(f.value=!1))}function A(a){m?.postMessage({controls:{action:"prioritize",itemId:a}})}async function F(a,s){$.value=!0;try{const{data:e}=await le().get(`/${s}/watch`),p=e.filter(t=>!!t?.file).map(t=>t.video_id),L=r.value.map(t=>t.id),N=p.some(t=>!L.includes(t))||L.some(t=>!p.includes(t));N?(x.value=0,b.value=0,r.value=[]):r.value=r.value.filter(t=>t.status==="completed"),r.value=await Promise.all(e.filter(t=>!!t?.file).map(async(t,h)=>{const l=t.tracks?.some(u=>u.kind==="subtitles"&&u.file),g=t.tracks?.some(u=>u.kind==="fonts"&&u.file),n=t.tracks?.some(u=>["thumbnails","sprite"].includes(u.kind)&&u.file);let M=!1;if(t.file.endsWith(".m3u8"))try{M=(await(await fetch(`${R.value?.serverBaseUrl}${t.file}`,{headers:{Authorization:`Bearer ${j.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(u){console.warn("Failed to check master playlist for audio:",u)}const _=[{type:"video",name:"Video",progress:0,status:"pending"}];return M&&_.push({type:"audio",name:"Audio",progress:0,status:"pending"}),l&&_.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),n&&_.push({type:"preview",name:"Preview",progress:0,status:"pending"}),g&&_.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:t.video_id,title:`${t.show}${t.season?` S${Y(t.season,2)}`:""}${t.episode?`E${Y(t.episode,2)}`:""} - ${t.title}`,image:t.image,progress:0,status:h===0?"pending":"waiting",children:_.map(u=>({...u,status:h===0?"pending":"waiting"}))}}));const C=e.filter(t=>!!t?.file).map(t=>{const h=t.tracks?.filter(n=>n.kind==="subtitles"&&n.file)?.map(n=>n.file),l=t.tracks?.filter(n=>n.kind==="fonts"&&n.file)?.map(n=>n.file),g=t.tracks?.filter(n=>["thumbnails","sprite"].includes(n.kind)&&n.file)?.map(n=>n.file);return{mediaId:t.video_id,mediaType:"video",mediaPath:t.file,baseUrl:R.value?.serverBaseUrl||"",token:j.value?.accessToken||"",...h?.length?{subtitlePaths:h}:{},...l?.length?{fontPaths:l}:{},...g?.length?{previewPaths:g}:{}}});if(!C.length)throw new Error("No valid files to download");return E.value=C.length,console.log("Starting download with tasks:",C),await new Promise((t,h)=>{m=new Worker(new URL("/assets/downloadWorker-Bef9Ut5E.js",""+import.meta.url),{type:"module"}),m.onerror=l=>{console.error("Worker error:",l),h(l)},m.onmessage=l=>{if(console.log("Worker message:",l.data),l.data.type==="error"&&l.data.error==="paused")return;const{type:g,progress:n,itemProgress:M,assetType:_,assetProgress:u,itemId:O,status:W,isNewQuery:J}=l.data;if(g==="progress"){if((N||!J)&&(x.value=Math.min(n,100)),P.value=M,O){const d=r.value.find(y=>y.id===O);if(d){if(_){const I=d.children.find(K=>K.type===_);I&&(I.progress=Math.min(u,100),I.status=I.progress===100?"completed":W)}const y=d.children.filter(I=>I.progress===100).length;d.progress=Math.round(y/d.children.length*100),d.progress===100?(d.status="completed",B()):W&&(d.status=W)}}}else if(g==="complete")B(),t(!0);else if(g==="error")l.data.error==="paused"?t(!1):h(l.data.error);else if(g==="status"){const d=r.value.find(y=>y.id===l.data.itemId);d&&d.status!=="completed"&&d.status!==l.data.status&&(d.status=l.data.status,d.children.forEach(y=>{y.status!=="completed"&&(y.status=l.data.status)}))}},m.postMessage({tasks:C,baseUrl:R.value?.serverBaseUrl,token:j.value?.accessToken,isNewQuery:N})}),!0}catch(e){return e==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",e),!1)}finally{f.value||(m?.terminate(),$.value=!1)}}return{isDownloading:$,progress:x,totalItems:E,completedItems:b,itemProgress:P,downloadQueue:r,isPaused:f,downloadPlaylist:F,pauseDownloads:V,resumeDownloads:U,pauseItem:S,resumeItem:D,prioritizeItem:A}}H();var de={class:"flex flex-col gap-2 p-4 overflow-clip col-span-12"},pe={class:"flex gap-4 max-h-[80vh] overflow-clip"},me={class:"w-2/5"},fe=["disabled"],ce={key:0,class:"mt-2 text-xs"},ge={class:"flex justify-between items-center mb-1"},ve={class:"w-full bg-surface-700 rounded h-1.5 mt-1"},we={key:0,class:"flex-1 overflow-y-auto available"},he={class:"grid gap-2"},_e={class:"flex justify-between items-center"},ye={class:"text-sm font-medium truncate flex items-center gap-2"},ke={key:0,class:"text-2xs text-slate-400"},xe={key:1,class:"text-2xs text-slate-400"},be=["onClick"],Ie={class:"flex gap-2"},Pe={class:"w-1/4 flex flex-col gap-2"},De=["src"],$e={class:"flex-1 min-w-0"},Ee={class:"grid grid-cols-1 gap-x-4 gap-y-0.5"},Be={class:"flex justify-between leading-0"},Ce={class:"w-full bg-surface-700 rounded h-1"},Me=ae({__name:"Desktop",setup($){const{isDownloading:x,progress:b,totalItems:E,completedItems:P,downloadQueue:r,isPaused:f,downloadPlaylist:m,pauseDownloads:B,resumeDownloads:V,pauseItem:U,resumeItem:S}=ue(),D=k("tv/138357");async function A(){await m("video",D.value)}return(F,a)=>{const s=te("InputText");return c(),re(i(oe),null,{default:Q(()=>[z(i(se),{fullscreen:!0},{default:Q(()=>[z(ne,{"grid-style":3,title:"Profile"},{default:Q(()=>[o("div",de,[a[2]||(a[2]=o("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),o("div",pe,[o("div",me,[z(s,{modelValue:D.value,"onUpdate:modelValue":a[0]||(a[0]=e=>D.value=e),class:"w-full text-sm"},null,8,["modelValue"]),o("button",{disabled:i(x),class:"bg-primary p-1.5 rounded disabled:opacity-50 mt-2 w-full text-sm",onClick:A},v(i(x)?"Downloading...":"Download Show"),9,fe),i(x)||i(P)?(c(),w("div",ce,[o("div",ge,[o("span",null,"Progress: "+v(i(b))+"% ("+v(i(P))+"/"+v(i(E))+")",1),o("button",{class:"text-xs px-2 py-0.5 rounded bg-surface-800",onClick:a[1]||(a[1]=e=>i(f)?i(V)():i(B)())},v(i(f)?"Resume All":"Pause All"),1)]),o("div",ve,[o("div",{style:X(`width: ${i(b)}%`),class:"bg-primary h-full rounded"},null,4)])])):T("",!0)]),i(r).length?(c(),w("div",we,[o("div",he,[(c(!0),w(q,null,G(i(r),e=>(c(),w("div",{key:e.id,class:"bg-surface-900/50 rounded p-4 flex flex-col gap-2"},[o("div",_e,[o("div",ye,[ee(v(e.title)+" ",1),e.status==="downloading"?(c(),w("span",ke,"(Downloading...)")):e.status==="waiting"?(c(),w("span",xe,"(Waiting...)")):T("",!0)]),e.status!=="completed"?(c(),w("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-surface-800",onClick:p=>e.status==="downloading"||e.status==="pending"||e.status==="waiting"?i(U)(e.id):i(S)(e.id)},v(e.status==="downloading"||e.status==="pending"||e.status==="waiting"?"Pause":"Resume"),9,be)):T("",!0)]),o("div",Ie,[o("div",Pe,[o("img",{src:`${i(ie)}${e.image}`,alt:"Item Image",class:"w-full h-auto aspect-video object-fit my-auto rounded"},null,8,De)]),o("div",$e,[o("div",Ee,[(c(!0),w(q,null,G(e.children,p=>(c(),w("div",{key:p.type,class:"text-2xs"},[o("div",Be,[o("span",null,v(p.name),1),o("span",null,v(p.progress)+"%",1)]),o("div",Ce,[o("div",{class:Z([{"bg-blue-500":p.type==="video","bg-green-500":p.type==="audio","bg-yellow-500":p.type==="subtitle","bg-purple-500":p.type==="preview","bg-pink-500":p.type==="font"},"h-full rounded"]),style:X(`width: ${p.progress}%`)},null,6)])]))),128))])])])]))),128))])])):T("",!0)])])]),_:1})]),_:1})]),_:1})}}}),Mt=Me;export{Mt as default};
