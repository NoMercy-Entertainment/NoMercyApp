import"./useBaseQuery-DyClHEGi.js";import"./useInfiniteServerClient-BzuDfoKL.js";import"./useQueryClient-DvzHjPa-.js";import"./useQuery-DhBBeAhd.js";import{Ac as H,Bs as G,Ci as W,Co as ee,Gc as r,Gs as l,Js as v,Ks as se,Mc as X,Nc as w,Ns as K,Oc as z,Qs as j,Rc as k,Si as te,Zs as ae,_c as q,_i as le,ec as oe,hc as g,ho as re,ni as J,qs as T,ta as F,yc as ie}from"./index-CvoOE5FB.js";import"./MoooomIcon-DvzE7qOo.js";import"./useServerClient-BusGKxx9.js";import"./ScrollContainer-dcdYhasp.js";import"./useMounted-BeJqIQ-_.js";import"./RipperOverlay-OzDsrhNA.js";import"./HubConnection-BgYujhqd.js";import"./ripperSocket-BwbJ4XA-.js";import"./Button-BCQ2DUBz.js";import"./FloatingBackButton-BOJYGekw.js";import{t as ne}from"./DashboardLayout-Cr3l0t2u.js";K();function ue(){const $=k(!1),x=k(0),b=k(0),E=k(0),P=k(0),o=k([]),f=k(!1);let c=null;function C(){b.value=o.value.filter(a=>a.status==="completed").length}function N(){f.value||(c?.postMessage({controls:{type:"pause"}}),o.value.forEach(a=>{a.status!=="completed"&&(a.status="paused",a.children.forEach(t=>{t.status!=="completed"&&(t.status="paused")}))}),f.value=!0)}function S(){if(f.value){const a=o.value.filter(t=>t.status==="paused");a.length>0&&(a[0].status="pending",a[0].children.forEach(t=>{t.status==="paused"&&(t.status="pending")}),a.slice(1).forEach(t=>{t.status="waiting",t.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})}),c?.postMessage({controls:{type:"resume",pausedIds:a.map(t=>t.id)}})),f.value=!1}}function A(a){const t=o.value.find(e=>e.id===a);t&&(t.status==="downloading"||t.status==="pending"||t.status==="waiting")&&(c?.postMessage({controls:{type:"pauseItem",itemId:a}}),t.status="paused",t.children.forEach(e=>{(e.status==="downloading"||e.status==="pending"||e.status==="waiting")&&(e.status="paused")}),o.value.every(e=>e.status==="completed"||e.status==="paused")&&(f.value=!0))}function D(a){const t=o.value.find(e=>e.id===a);t&&t.status==="paused"&&(c?.postMessage({controls:{type:"resumeItem",itemId:a}}),o.value.find(e=>e.status==="downloading"||e.status==="pending")?(t.status="waiting",t.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})):(t.status="pending",t.children.forEach(e=>{e.status==="paused"&&(e.status="pending")})),o.value.some(e=>e.status==="downloading"||e.status==="pending")&&(f.value=!1))}function U(a){c?.postMessage({controls:{action:"prioritize",itemId:a}})}async function R(a,t){$.value=!0;try{const{data:e}=await te().get(`/${t}/watch`),p=e.filter(s=>!!s?.file).map(s=>s.video_id),L=o.value.map(s=>s.id),V=p.some(s=>!L.includes(s))||L.some(s=>!p.includes(s));V?(x.value=0,b.value=0,o.value=[]):o.value=o.value.filter(s=>s.status==="completed"),o.value=await Promise.all(e.filter(s=>!!s?.file).map(async(s,h)=>{const i=s.tracks?.some(u=>u.kind==="subtitles"&&u.file),m=s.tracks?.some(u=>u.kind==="fonts"&&u.file),n=s.tracks?.some(u=>["thumbnails","sprite"].includes(u.kind)&&u.file);let B=!1;if(s.file.endsWith(".m3u8"))try{B=(await(await fetch(`${W.value?.serverBaseUrl}${s.file}`,{headers:{Authorization:`Bearer ${F.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(u){console.warn("Failed to check master playlist for audio:",u)}const _=[{type:"video",name:"Video",progress:0,status:"pending"}];return B&&_.push({type:"audio",name:"Audio",progress:0,status:"pending"}),i&&_.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),n&&_.push({type:"preview",name:"Preview",progress:0,status:"pending"}),m&&_.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:s.video_id,title:`${s.show}${s.season?` S${J(s.season,2)}`:""}${s.episode?`E${J(s.episode,2)}`:""} - ${s.title}`,image:s.image,progress:0,status:h===0?"pending":"waiting",children:_.map(u=>({...u,status:h===0?"pending":"waiting"}))}}));const M=e.filter(s=>!!s?.file).map(s=>{const h=s.tracks?.filter(n=>n.kind==="subtitles"&&n.file)?.map(n=>n.file),i=s.tracks?.filter(n=>n.kind==="fonts"&&n.file)?.map(n=>n.file),m=s.tracks?.filter(n=>["thumbnails","sprite"].includes(n.kind)&&n.file)?.map(n=>n.file);return{mediaId:s.video_id,mediaType:"video",mediaPath:s.file,baseUrl:W.value?.serverBaseUrl||"",token:F.value?.accessToken||"",...h?.length?{subtitlePaths:h}:{},...i?.length?{fontPaths:i}:{},...m?.length?{previewPaths:m}:{}}});if(!M.length)throw new Error("No valid files to download");return E.value=M.length,console.log("Starting download with tasks:",M),await new Promise((s,h)=>{c=new Worker(new URL("/assets/downloadWorker-DByD6aw9.js",""+import.meta.url),{type:"module"}),c.onerror=i=>{console.error("Worker error:",i),h(i)},c.onmessage=i=>{if(console.log("Worker message:",i.data),i.data.type==="error"&&i.data.error==="paused")return;const{type:m,progress:n,itemProgress:B,assetType:_,assetProgress:u,itemId:O,status:Q,isNewQuery:Y}=i.data;if(m==="progress"){if((V||!Y)&&(x.value=Math.min(n,100)),P.value=B,O){const d=o.value.find(y=>y.id===O);if(d){if(_){const I=d.children.find(Z=>Z.type===_);I&&(I.progress=Math.min(u,100),I.status=I.progress===100?"completed":Q)}const y=d.children.filter(I=>I.progress===100).length;d.progress=Math.round(y/d.children.length*100),d.progress===100?(d.status="completed",C()):Q&&(d.status=Q)}}}else if(m==="complete")C(),s(!0);else if(m==="error")i.data.error==="paused"?s(!1):h(i.data.error);else if(m==="status"){const d=o.value.find(y=>y.id===i.data.itemId);d&&d.status!=="completed"&&d.status!==i.data.status&&(d.status=i.data.status,d.children.forEach(y=>{y.status!=="completed"&&(y.status=i.data.status)}))}},c.postMessage({tasks:M,baseUrl:W.value?.serverBaseUrl,token:F.value?.accessToken,isNewQuery:V})}),!0}catch(e){return e==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",e),!1)}finally{f.value||(c?.terminate(),$.value=!1)}}return{isDownloading:$,progress:x,totalItems:E,completedItems:b,itemProgress:P,downloadQueue:o,isPaused:f,downloadPlaylist:R,pauseDownloads:N,resumeDownloads:S,pauseItem:A,resumeItem:D,prioritizeItem:U}}K();var de={class:"flex flex-col gap-2 p-4 overflow-clip col-span-12"},pe={class:"flex gap-4 max-h-[80vh] overflow-clip"},ce={class:"w-2/5"},fe=["disabled"],ge={key:0,class:"mt-2 text-xs"},me={class:"flex justify-between items-center mb-1"},ve={class:"w-full bg-surface-700 rounded h-1.5 mt-1"},we={key:0,class:"flex-1 overflow-y-auto available"},he={class:"grid gap-2"},_e={class:"flex justify-between items-center"},ye={class:"text-sm font-medium truncate flex items-center gap-2"},ke={key:0,class:"text-2xs text-slate-400"},xe={key:1,class:"text-2xs text-slate-400"},be=["onClick"],Ie={class:"flex gap-2"},Pe={class:"w-1/4 flex flex-col gap-2"},De=["src"],$e={class:"flex-1 min-w-0"},Ee={class:"grid grid-cols-1 gap-x-4 gap-y-0.5"},Ce={class:"flex justify-between leading-0"},Me={class:"w-full bg-surface-700 rounded h-1"},Be=oe({__name:"Desktop",setup($){const{isDownloading:x,progress:b,totalItems:E,completedItems:P,downloadQueue:o,isPaused:f,downloadPlaylist:c,pauseDownloads:C,resumeDownloads:N,pauseItem:S,resumeItem:A}=ue(),D=k("tv/138357");async function U(){await c("video",D.value)}return(R,a)=>{const t=ie("InputText");return g(),se(r(ee),null,{default:z(()=>[j(r(re),{fullscreen:!0},{default:z(()=>[j(ne,{"grid-style":3,title:"Profile"},{default:z(()=>[l("div",de,[a[2]||(a[2]=l("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),l("div",pe,[l("div",ce,[j(t,{modelValue:D.value,"onUpdate:modelValue":a[0]||(a[0]=e=>D.value=e),class:"w-full text-sm"},null,8,["modelValue"]),l("button",{disabled:r(x),class:"bg-primary p-1.5 rounded disabled:opacity-50 mt-2 w-full text-sm",onClick:U},w(r(x)?"Downloading...":"Download Show"),9,fe),r(x)||r(P)?(g(),v("div",ge,[l("div",me,[l("span",null,"Progress: "+w(r(b))+"% ("+w(r(P))+"/"+w(r(E))+")",1),l("button",{class:"text-xs px-2 py-0.5 rounded bg-surface-800",onClick:a[1]||(a[1]=e=>r(f)?r(N)():r(C)())},w(r(f)?"Resume All":"Pause All"),1)]),l("div",ve,[l("div",{style:X(`width: ${r(b)}%`),class:"bg-primary h-full rounded"},null,4)])])):T("",!0)]),r(o).length?(g(),v("div",we,[l("div",he,[(g(!0),v(G,null,q(r(o),e=>(g(),v("div",{key:e.id,class:"bg-surface-900/50 rounded p-4 flex flex-col gap-2"},[l("div",_e,[l("div",ye,[ae(w(e.title)+" ",1),e.status==="downloading"?(g(),v("span",ke,"(Downloading...)")):e.status==="waiting"?(g(),v("span",xe,"(Waiting...)")):T("",!0)]),e.status!=="completed"?(g(),v("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-surface-800",onClick:p=>e.status==="downloading"||e.status==="pending"||e.status==="waiting"?r(S)(e.id):r(A)(e.id)},w(e.status==="downloading"||e.status==="pending"||e.status==="waiting"?"Pause":"Resume"),9,be)):T("",!0)]),l("div",Ie,[l("div",Pe,[l("img",{src:`${r(le)}${e.image}`,alt:"Item Image",class:"w-full h-auto aspect-video object-fit my-auto rounded"},null,8,De)]),l("div",$e,[l("div",Ee,[(g(!0),v(G,null,q(e.children,p=>(g(),v("div",{key:p.type,class:"text-2xs"},[l("div",Ce,[l("span",null,w(p.name),1),l("span",null,w(p.progress)+"%",1)]),l("div",Me,[l("div",{class:H([{"bg-blue-500":p.type==="video","bg-green-500":p.type==="audio","bg-yellow-500":p.type==="subtitle","bg-purple-500":p.type==="preview","bg-pink-500":p.type==="font"},"h-full rounded"]),style:X(`width: ${p.progress}%`)},null,6)])]))),128))])])])]))),128))])])):T("",!0)])])]),_:1})]),_:1})]),_:1})}}}),Xe=Be;export{Xe as default};
