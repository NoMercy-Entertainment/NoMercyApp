import{An as x,Bn as te,Bt as C,Gt as N,Hn as G,Mt as H,Rt as n,Sn as Q,Tt as R,Un as y,Vt as h,Wt as se,cn as c,fn as ae,i as oe,jt as re,qt as J,u as ie,un as K,zn as i,zt as Y}from"./index-Dv83kAv_.js";import"./dist-BWFEUpD5.js";import"./esm-CjYSFQTD.js";import"./esm-B--WsoEr.js";import"./dist-CkXwLdCd.js";import"./client-Lt1iJPRU.js";import"./ionic-global-BrT5QOOk.js";import"./hardware-back-button-DUNt_0t6.js";import"./index3-D57DmiIb.js";import"./index8-CrgDNp2f.js";import"./keyboard-BGaVckUv.js";import"./index2-Bme3R7x6.js";import"./ios.transition-CmHvz4bI.js";import"./keyboard2-DeMt_g_-.js";import"./md.transition-DBZTZPtp.js";import"./ui-Dy0BhNPE.js";import"./client-D4e5iciK.js";import{g as q,t as W}from"./currentServer-CyRP1M2f.js";import{s as ne}from"./config-BZ-AEJ_J.js";import"./esm-ANv1qkIu.js";import"./global-Cl9NRZH-.js";import"./esm-CLtwhlBL.js";import"./bundle-mjs-m3ebY3zV.js";import{s as F}from"./user-Cpc-QsaC.js";import{t as le}from"./serverClient-Dh7JrGPq.js";import"./router-LUtA4OvS.js";import"./utils-S5luT9U1.js";import"./useInfiniteServerClient-r3ptfaNG.js";import"./SocketClient-CLd4yl1R.js";import"./apiClient-9DYr7MVK.js";import"./notifications-qUxNFD5p.js";import"./utils-DRKz5xy4.js";import"./deviceInfo-DoGAY46a.js";import"./auth-hpDtC4ST.js";import"./useServerClient-CvCiAwnH.js";import"./ScrollContainer-UnRcXO1f.js";import"./useMounted-BO0RWNIx.js";import"./RipperOverlay-DPcurQGk.js";import"./ripperSocket-66QK4sK-.js";import"./FloatingBackButton-DBcoXYDj.js";import{t as ue}from"./DashboardLayout-CDV4ClI3.js";R();function de(){const $=x(!1),g=x(0),v=x(0),a=x(0),_=x(0),r=x([]),f=x(!1);let m=null;function E(){v.value=r.value.filter(o=>o.status==="completed").length}function T(){f.value||(m?.postMessage({controls:{type:"pause"}}),r.value.forEach(o=>{o.status!=="completed"&&(o.status="paused",o.children.forEach(s=>{s.status!=="completed"&&(s.status="paused")}))}),f.value=!0)}function S(){if(f.value){const o=r.value.filter(s=>s.status==="paused");o.length>0&&(o[0].status="pending",o[0].children.forEach(s=>{s.status==="paused"&&(s.status="pending")}),o.slice(1).forEach(s=>{s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})}),m?.postMessage({controls:{type:"resume",pausedIds:o.map(s=>s.id)}})),f.value=!1}}function U(o){const s=r.value.find(e=>e.id===o);s&&(s.status==="downloading"||s.status==="pending"||s.status==="waiting")&&(m?.postMessage({controls:{type:"pauseItem",itemId:o}}),s.status="paused",s.children.forEach(e=>{(e.status==="downloading"||e.status==="pending"||e.status==="waiting")&&(e.status="paused")}),r.value.every(e=>e.status==="completed"||e.status==="paused")&&(f.value=!0))}function D(o){const s=r.value.find(e=>e.id===o);s&&s.status==="paused"&&(m?.postMessage({controls:{type:"resumeItem",itemId:o}}),r.value.find(e=>e.status==="downloading"||e.status==="pending")?(s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})):(s.status="pending",s.children.forEach(e=>{e.status==="paused"&&(e.status="pending")})),r.value.some(e=>e.status==="downloading"||e.status==="pending")&&(f.value=!1))}function V(o){m?.postMessage({controls:{action:"prioritize",itemId:o}})}async function j(o,s){$.value=!0;try{const{data:e}=await le().get(`/${s}/watch`),L=e.filter(t=>!!t?.file).map(t=>t.video_id),O=r.value.map(t=>t.id),A=L.some(t=>!O.includes(t))||O.some(t=>!L.includes(t));A?(g.value=0,v.value=0,r.value=[]):r.value=r.value.filter(t=>t.status==="completed"),r.value=await Promise.all(e.filter(t=>!!t?.file).map(async(t,b)=>{const l=t.tracks?.some(d=>d.kind==="subtitles"&&d.file),w=t.tracks?.some(d=>d.kind==="fonts"&&d.file),u=t.tracks?.some(d=>["thumbnails","sprite"].includes(d.kind)&&d.file);let B=!1;if(t.file.endsWith(".m3u8"))try{B=(await(await fetch(`${W.value?.serverBaseUrl}${t.file}`,{headers:{Authorization:`Bearer ${F.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(d){console.warn("Failed to check master playlist for audio:",d)}const k=[{type:"video",name:"Video",progress:0,status:"pending"}];return B&&k.push({type:"audio",name:"Audio",progress:0,status:"pending"}),l&&k.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),u&&k.push({type:"preview",name:"Preview",progress:0,status:"pending"}),w&&k.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:t.video_id,title:`${t.show}${t.season?` S${q(t.season,2)}`:""}${t.episode?`E${q(t.episode,2)}`:""} - ${t.title}`,image:t.image,progress:0,status:b===0?"pending":"waiting",children:k.map(d=>({...d,status:b===0?"pending":"waiting"}))}}));const M=e.filter(t=>!!t?.file).map(t=>{const b=t.tracks?.filter(u=>u.kind==="subtitles"&&u.file)?.map(u=>u.file),l=t.tracks?.filter(u=>u.kind==="fonts"&&u.file)?.map(u=>u.file),w=t.tracks?.filter(u=>["thumbnails","sprite"].includes(u.kind)&&u.file)?.map(u=>u.file);return{mediaId:t.video_id,mediaType:"video",mediaPath:t.file,baseUrl:W.value?.serverBaseUrl||"",token:F.value?.accessToken||"",...b?.length?{subtitlePaths:b}:{},...l?.length?{fontPaths:l}:{},...w?.length?{previewPaths:w}:{}}});if(!M.length)throw new Error("No valid files to download");return a.value=M.length,console.log("Starting download with tasks:",M),await new Promise((t,b)=>{m=new Worker(new URL("/assets/downloadWorker-Bu7z8Y_c.js",""+import.meta.url),{type:"module"}),m.onerror=l=>{console.error("Worker error:",l),b(l)},m.onmessage=l=>{if(console.log("Worker message:",l.data),l.data.type==="error"&&l.data.error==="paused")return;const{type:w,progress:u,itemProgress:B,assetType:k,assetProgress:d,itemId:X,status:z,isNewQuery:Z}=l.data;if(w==="progress"){if((A||!Z)&&(g.value=Math.min(u,100)),_.value=B,X){const p=r.value.find(I=>I.id===X);if(p){if(k){const P=p.children.find(ee=>ee.type===k);P&&(P.progress=Math.min(d,100),P.status=P.progress===100?"completed":z)}const I=p.children.filter(P=>P.progress===100).length;p.progress=Math.round(I/p.children.length*100),p.progress===100?(p.status="completed",E()):z&&(p.status=z)}}}else if(w==="complete")E(),t(!0);else if(w==="error")l.data.error==="paused"?t(!1):b(l.data.error);else if(w==="status"){const p=r.value.find(I=>I.id===l.data.itemId);p&&p.status!=="completed"&&p.status!==l.data.status&&(p.status=l.data.status,p.children.forEach(I=>{I.status!=="completed"&&(I.status=l.data.status)}))}},m.postMessage({tasks:M,baseUrl:W.value?.serverBaseUrl,token:F.value?.accessToken,isNewQuery:A})}),!0}catch(e){return e==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",e),!1)}finally{f.value||(m?.terminate(),$.value=!1)}}return{isDownloading:$,progress:g,totalItems:a,completedItems:v,itemProgress:_,downloadQueue:r,isPaused:f,downloadPlaylist:j,pauseDownloads:T,resumeDownloads:S,pauseItem:U,resumeItem:D,prioritizeItem:V}}R();var pe={class:"bg-surface-900/50 rounded p-4 grid gap-2"},me={class:"flex justify-between items-center"},fe={class:"text-sm font-medium truncate flex items-center gap-2"},ce={key:0,class:"text-2xs text-slate-400"},ge={key:1,class:"text-2xs text-slate-400"},ve={class:"flex gap-2"},we=["src"],he={class:"flex-1 min-w-0 grid gap-x-4 gap-y-0.5"},ye={class:"flex justify-between leading-0"},_e={class:"w-full bg-surface-700 rounded h-1"},be=J({__name:"DownloadQueueItem",props:{item:{},onPause:{type:Function},onResume:{type:Function}},setup($){const g=a=>({"bg-blue-500":a==="video","bg-green-500":a==="audio","bg-yellow-500":a==="subtitle","bg-purple-500":a==="preview","bg-pink-500":a==="font"}),v=a=>a==="downloading"||a==="pending"||a==="waiting";return(a,_)=>(c(),h("article",pe,[n("header",me,[n("h3",fe,[se(y(a.item.title)+" ",1),a.item.status==="downloading"?(c(),h("span",ce,"(Downloading...)")):a.item.status==="waiting"?(c(),h("span",ge,"(Waiting...)")):C("",!0)]),a.item.status!=="completed"?(c(),h("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-surface-800",onClick:_[0]||(_[0]=r=>v(a.item.status)?a.onPause(a.item.id):a.onResume(a.item.id))},y(v(a.item.status)?"Pause":"Resume"),1)):C("",!0)]),n("div",ve,[n("img",{src:`${i(ne)}${a.item.image}`,alt:"Item Image",class:"w-1/4 h-auto aspect-video object-fit rounded"},null,8,we),n("div",he,[(c(!0),h(H,null,K(a.item.children,r=>(c(),h("div",{key:r.type,class:"text-2xs"},[n("div",ye,[n("span",null,y(r.name),1),n("span",null,y(r.progress)+"%",1)]),n("div",_e,[n("div",{class:te([g(r.type),"h-full rounded"]),style:G(`width: ${r.progress}%`)},null,6)])]))),128))])])]))}}),ke=be;R();var Ie={class:"flex gap-4 max-h-[80vh] overflow-clip"},xe=["disabled"],Pe={key:0,class:"text-xs grid gap-1"},$e={class:"flex justify-between items-center"},De={class:"w-full bg-surface-700 rounded h-1.5 relative"},Ee={key:0,class:"flex-1 overflow-y-auto available grid gap-2 content-start"},Me=J({__name:"Desktop",setup($){const{isDownloading:g,progress:v,totalItems:a,completedItems:_,downloadQueue:r,isPaused:f,downloadPlaylist:m,pauseDownloads:E,resumeDownloads:T,pauseItem:S,resumeItem:U}=de(),D=x("tv/138357");async function V(){await m("video",D.value)}return(j,o)=>{const s=ae("InputText");return c(),Y(i(ie),null,{default:Q(()=>[N(i(oe),{fullscreen:!0},{default:Q(()=>[N(ue,{"grid-style":3,title:"Profile",class:"grid gap-2 p-4 col-span-12"},{default:Q(()=>[o[2]||(o[2]=n("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),n("div",Ie,[n("form",{class:"w-2/5 flex flex-col gap-2",onSubmit:re(V,["prevent"])},[N(s,{modelValue:D.value,"onUpdate:modelValue":o[0]||(o[0]=e=>D.value=e),class:"w-full text-sm"},null,8,["modelValue"]),n("button",{disabled:i(g),class:"bg-primary p-1.5 rounded disabled:opacity-50 text-sm",type:"submit"},y(i(g)?"Downloading...":"Download Show"),9,xe),i(g)||i(_)?(c(),h("div",Pe,[n("div",$e,[n("span",null,"Progress: "+y(i(v))+"% ("+y(i(_))+"/"+y(i(a))+")",1),n("button",{class:"text-xs px-2 py-0.5 rounded bg-surface-800",type:"button",onClick:o[1]||(o[1]=e=>i(f)?i(T)():i(E)())},y(i(f)?"Resume All":"Pause All"),1)]),n("div",De,[n("div",{style:G(`width: ${i(v)}%`),class:"bg-primary h-full rounded absolute inset-0"},null,4)])])):C("",!0)],32),i(r).length?(c(),h("div",Ee,[(c(!0),h(H,null,K(i(r),e=>(c(),Y(ke,{key:e.id,item:e,"on-pause":i(S),"on-resume":i(U)},null,8,["item","on-pause","on-resume"]))),128))])):C("",!0)])]),_:1})]),_:1})]),_:1})}}}),wt=Me;export{wt as default};
