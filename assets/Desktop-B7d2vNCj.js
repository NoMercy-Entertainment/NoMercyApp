import{K as D,aO as ee,aP as R,bo as L,bW as Y,aG as se,v as te,j as ae,o as h,a7 as X,x as G,aI as r,b$ as ne,a as o,c as x,h as W,t as b,av as Z,F as q,w as H,a6 as le,bV as oe,C as ie,bZ as ue}from"./index-B4CMrhNe.js";import{_ as re}from"./DashboardLayout.vue_vue_type_script_setup_true_lang-DAFpdXCF.js";import"./FloatingBackButton.vue_vue_type_script_setup_true_lang-DP86-IGI.js";import"./Button.vue_vue_type_script_setup_true_lang-D4wXJxDy.js";function de(){const V=D(!1),$=D(0),M=D(0),B=D(0),A=D(0),u=D([]),f=D(!1);let l=null;function N(){M.value=u.value.filter(n=>n.status==="completed").length}function j(){f.value||(l==null||l.postMessage({controls:{type:"pause"}}),u.value.forEach(n=>{n.status!=="completed"&&(n.status="paused",n.children.forEach(t=>{t.status!=="completed"&&(t.status="paused")}))}),f.value=!0)}function z(){if(f.value){const n=u.value.filter(t=>t.status==="paused");n.length>0&&(n[0].status="pending",n[0].children.forEach(t=>{t.status==="paused"&&(t.status="pending")}),n.slice(1).forEach(t=>{t.status="waiting",t.children.forEach(s=>{s.status==="paused"&&(s.status="waiting")})}),l==null||l.postMessage({controls:{type:"resume",pausedIds:n.map(t=>t.id)}})),f.value=!1}}function F(n){const t=u.value.find(s=>s.id===n);t&&(t.status==="downloading"||t.status==="pending"||t.status==="waiting")&&(l==null||l.postMessage({controls:{type:"pauseItem",itemId:n}}),t.status="paused",t.children.forEach(i=>{(i.status==="downloading"||i.status==="pending"||i.status==="waiting")&&(i.status="paused")}),u.value.every(i=>i.status==="completed"||i.status==="paused")&&(f.value=!0))}function S(n){const t=u.value.find(s=>s.id===n);t&&t.status==="paused"&&(l==null||l.postMessage({controls:{type:"resumeItem",itemId:n}}),u.value.find(p=>p.status==="downloading"||p.status==="pending")?(t.status="waiting",t.children.forEach(p=>{p.status==="paused"&&(p.status="waiting")})):(t.status="pending",t.children.forEach(p=>{p.status==="paused"&&(p.status="pending")})),u.value.some(p=>p.status==="downloading"||p.status==="pending")&&(f.value=!1))}function Q(n){l==null||l.postMessage({controls:{action:"prioritize",itemId:n}})}async function K(n,t){V.value=!0;try{const{data:s}=await ee().get(`/${t}/watch`),i=s.filter(e=>!!(e!=null&&e.file)).map(e=>e.video_id),p=u.value.map(e=>e.id),O=i.some(e=>!p.includes(e))||p.some(e=>!i.includes(e));O?($.value=0,M.value=0,u.value=[]):u.value=u.value.filter(e=>e.status==="completed"),u.value=await Promise.all(s.filter(e=>!!(e!=null&&e.file)).map(async(e,g)=>{var E,k,C,I,_;const w=(E=e.tracks)==null?void 0:E.some(a=>a.kind==="subtitles"&&a.file),y=(k=e.tracks)==null?void 0:k.some(a=>a.kind==="fonts"&&a.file),d=(C=e.tracks)==null?void 0:C.some(a=>["thumbnails","sprite"].includes(a.kind)&&a.file);let m=!1;if(e.file.endsWith(".m3u8"))try{m=(await(await fetch(`${(I=R.value)==null?void 0:I.serverBaseUrl}${e.file}`,{headers:{Authorization:`Bearer ${(_=L.value)==null?void 0:_.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(a){console.warn("Failed to check master playlist for audio:",a)}const v=[{type:"video",name:"Video",progress:0,status:"pending"}];return m&&v.push({type:"audio",name:"Audio",progress:0,status:"pending"}),w&&v.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),d&&v.push({type:"preview",name:"Preview",progress:0,status:"pending"}),y&&v.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:e.video_id,title:`${e.show}${e.season?` S${Y(e.season,2)}`:""}${e.episode?`E${Y(e.episode,2)}`:""} - ${e.title}`,image:e.image,progress:0,status:g===0?"pending":"waiting",children:v.map(a=>({...a,status:g===0?"pending":"waiting"}))}}));const U=s.filter(e=>!!(e!=null&&e.file)).map(e=>{var d,m,v,E,k,C,I,_;const g=(m=(d=e.tracks)==null?void 0:d.filter(a=>a.kind==="subtitles"&&a.file))==null?void 0:m.map(a=>a.file),w=(E=(v=e.tracks)==null?void 0:v.filter(a=>a.kind==="fonts"&&a.file))==null?void 0:E.map(a=>a.file),y=(C=(k=e.tracks)==null?void 0:k.filter(a=>["thumbnails","sprite"].includes(a.kind)&&a.file))==null?void 0:C.map(a=>a.file);return{mediaId:e.video_id,mediaType:"video",mediaPath:e.file,baseUrl:((I=R.value)==null?void 0:I.serverBaseUrl)||"",token:((_=L.value)==null?void 0:_.accessToken)||"",...g!=null&&g.length?{subtitlePaths:g}:{},...w!=null&&w.length?{fontPaths:w}:{},...y!=null&&y.length?{previewPaths:y}:{}}});if(!U.length)throw new Error("No valid files to download");return B.value=U.length,console.log("Starting download with tasks:",U),await new Promise((e,g)=>{var w,y;l=new Worker(new URL("/assets/downloadWorker-Dv6gNako.js",import.meta.url),{type:"module"}),l.onerror=d=>{console.error("Worker error:",d),g(d)},l.onmessage=d=>{if(console.log("Worker message:",d.data),d.data.type==="error"&&d.data.error==="paused")return;const{type:m,progress:v,itemProgress:E,assetType:k,assetProgress:C,itemId:I,status:_,isNewQuery:a}=d.data;if(m==="progress"){if((O||!a)&&($.value=Math.min(v,100)),A.value=E,I){const c=u.value.find(P=>P.id===I);if(c){if(k){const T=c.children.find(J=>J.type===k);T&&(T.progress=Math.min(C,100),T.status=T.progress===100?"completed":_)}const P=c.children.filter(T=>T.progress===100).length;c.progress=Math.round(P/c.children.length*100),c.progress===100?(c.status="completed",N()):_&&(c.status=_)}}}else if(m==="complete")N(),e(!0);else if(m==="error")d.data.error==="paused"?e(!1):g(d.data.error);else if(m==="status"){const c=u.value.find(P=>P.id===d.data.itemId);c&&c.status!=="completed"&&c.status!==d.data.status&&(c.status=d.data.status,c.children.forEach(P=>{P.status!=="completed"&&(P.status=d.data.status)}))}},l.postMessage({tasks:U,baseUrl:(w=R.value)==null?void 0:w.serverBaseUrl,token:(y=L.value)==null?void 0:y.accessToken,isNewQuery:O})}),!0}catch(s){return s==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",s),!1)}finally{f.value||(l==null||l.terminate(),V.value=!1)}}return{isDownloading:V,progress:$,totalItems:B,completedItems:M,itemProgress:A,downloadQueue:u,isPaused:f,downloadPlaylist:K,pauseDownloads:j,resumeDownloads:z,pauseItem:F,resumeItem:S,prioritizeItem:Q}}const ce={class:"flex flex-col gap-2 p-4 overflow-clip col-span-12"},pe={class:"flex gap-4 max-h-[80vh] overflow-clip"},fe={class:"w-2/5"},ge=["disabled"],me={key:0,class:"mt-2 text-xs"},ve={class:"flex justify-between items-center mb-1"},he={class:"w-full bg-neutral-700 rounded h-1.5 mt-1"},we={key:0,class:"flex-1 overflow-y-auto available"},ye={class:"grid gap-2"},_e={class:"flex justify-between items-center"},xe={class:"text-sm font-medium truncate flex items-center gap-2"},be={key:0,class:"text-2xs text-neutral-400"},ke={key:1,class:"text-2xs text-neutral-400"},Ie=["onClick"],Pe={class:"flex gap-2"},De={class:"w-1/4 flex flex-col gap-2"},$e=["src"],Ee={class:"flex-1 min-w-0"},Ce={class:"grid grid-cols-1 gap-x-4 gap-y-0.5"},Me={class:"flex justify-between leading-0"},Te={class:"w-full bg-neutral-700 rounded h-1"},Ne=se({__name:"Desktop",setup(V){const{isDownloading:$,progress:M,totalItems:B,completedItems:A,downloadQueue:u,isPaused:f,downloadPlaylist:l,pauseDownloads:N,resumeDownloads:j,pauseItem:z,resumeItem:F}=de(),S=D("tv/138357");async function Q(){await l("video",S.value)}return(K,n)=>{const t=te("InputText");return h(),ae(r(ue),null,{default:X(()=>[G(r(ne),{fullscreen:!0},{default:X(()=>[G(re,{gridStyle:3,title:"Profile"},{default:X(()=>[o("div",ce,[n[2]||(n[2]=o("h2",{class:"text-lg mb-2"},"Download for Offline Viewing",-1)),o("div",pe,[o("div",fe,[G(t,{modelValue:S.value,"onUpdate:modelValue":n[0]||(n[0]=s=>S.value=s),class:"w-full text-sm"},null,8,["modelValue"]),o("button",{onClick:Q,disabled:r($),class:"bg-primary p-1.5 rounded disabled:opacity-50 mt-2 w-full text-sm"},b(r($)?"Downloading...":"Download Show"),9,ge),r($)||r(A)?(h(),x("div",me,[o("div",ve,[o("span",null,"Progress: "+b(r(M))+"% ("+b(r(A))+"/"+b(r(B))+")",1),o("button",{onClick:n[1]||(n[1]=s=>r(f)?r(j)():r(N)()),class:"text-xs px-2 py-0.5 rounded bg-neutral-800"},b(r(f)?"Resume All":"Pause All"),1)]),o("div",he,[o("div",{class:"bg-primary h-full rounded",style:Z(`width: ${r(M)}%`)},null,4)])])):W("",!0)]),r(u).length?(h(),x("div",we,[o("div",ye,[(h(!0),x(q,null,H(r(u),s=>(h(),x("div",{key:s.id,class:"bg-neutral-900/50 rounded p-4 flex flex-col gap-2"},[o("div",_e,[o("div",xe,[le(b(s.title)+" ",1),s.status==="downloading"?(h(),x("span",be,"(Downloading...)")):s.status==="waiting"?(h(),x("span",ke,"(Waiting...)")):W("",!0)]),s.status!=="completed"?(h(),x("button",{key:0,onClick:i=>s.status==="downloading"||s.status==="pending"||s.status==="waiting"?r(z)(s.id):r(F)(s.id),class:"text-2xs px-2 py-0.5 rounded bg-neutral-800"},b(s.status==="downloading"||s.status==="pending"||s.status==="waiting"?"Pause":"Resume"),9,Ie)):W("",!0)]),o("div",Pe,[o("div",De,[o("img",{src:`${r(oe)}${s.image}`,class:"w-full h-auto aspect-video object-fit my-auto rounded"},null,8,$e)]),o("div",Ee,[o("div",Ce,[(h(!0),x(q,null,H(s.children,i=>(h(),x("div",{key:i.type,class:"text-2xs"},[o("div",Me,[o("span",null,b(i.name),1),o("span",null,b(i.progress)+"%",1)]),o("div",Te,[o("div",{class:ie([{"bg-blue-500":i.type==="video","bg-green-500":i.type==="audio","bg-yellow-500":i.type==="subtitle","bg-purple-500":i.type==="preview","bg-pink-500":i.type==="font"},"h-full rounded"]),style:Z(`width: ${i.progress}%`)},null,6)])]))),128))])])])]))),128))])])):W("",!0)])])]),_:1})]),_:1})]),_:1})}}});export{Ne as default};
