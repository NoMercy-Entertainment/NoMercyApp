import{d as D,$ as ee,k as se,c as te,o as h,p as L,z as O,a0 as u,av as ae,j as l,h as x,b as z,x as b,G as Y,F as H,q as J,A as oe,v as ne,as as le}from"./vue-ionic-9j_oSDCB.js";import{a as ie,c as X,u as q,o as K,bl as re}from"./index-DATP4gbU.js";import{_ as ue}from"./DashboardLayout.vue_vue_type_script_setup_true_lang-5kOJt03T.js";import"./vendor-Dgtccx1h.js";import"./icons-BW5E66pf.js";import"./rxjs-BCp2L9Rn.js";import"./media-C2AqgyMX.js";import"./api-BBofn2cc.js";import"./swiper-D00Cnjmx.js";import"./music-player-CxG_wAnH.js";import"./primevue-BfjCwqou.js";import"./useMounted-B-6V-qjk.js";import"./useServerClient-BylH-QFd.js";import"./useInfiniteServerClient-9DLF0yO9.js";import"./FloatingBackButton.vue_vue_type_script_setup_true_lang-CQGymnQN.js";import"./OptimizedIcon.vue_vue_type_script_setup_true_lang-CHVfvbJh.js";import"./Button.vue_vue_type_script_setup_true_lang-aQAcunBv.js";import"./ScrollContainer.vue_vue_type_script_setup_true_lang-dy9uASIl.js";import"./RipperOverlay.vue_vue_type_script_setup_true_lang-CDcRIMdg.js";import"./ripperSocket-BwBWUkNw.js";import"./Button.vue_vue_type_script_setup_true_lang-Cw5NIKe3.js";function de(){const N=D(!1),$=D(0),A=D(0),S=D(0),T=D(0),r=D([]),f=D(!1);let n=null;function U(){A.value=r.value.filter(o=>o.status==="completed").length}function W(){f.value||(n==null||n.postMessage({controls:{type:"pause"}}),r.value.forEach(o=>{o.status!=="completed"&&(o.status="paused",o.children.forEach(t=>{t.status!=="completed"&&(t.status="paused")}))}),f.value=!0)}function j(){if(f.value){const o=r.value.filter(t=>t.status==="paused");o.length>0&&(o[0].status="pending",o[0].children.forEach(t=>{t.status==="paused"&&(t.status="pending")}),o.slice(1).forEach(t=>{t.status="waiting",t.children.forEach(s=>{s.status==="paused"&&(s.status="waiting")})}),n==null||n.postMessage({controls:{type:"resume",pausedIds:o.map(t=>t.id)}})),f.value=!1}}function F(o){const t=r.value.find(s=>s.id===o);t&&(t.status==="downloading"||t.status==="pending"||t.status==="waiting")&&(n==null||n.postMessage({controls:{type:"pauseItem",itemId:o}}),t.status="paused",t.children.forEach(i=>{(i.status==="downloading"||i.status==="pending"||i.status==="waiting")&&(i.status="paused")}),r.value.every(i=>i.status==="completed"||i.status==="paused")&&(f.value=!0))}function B(o){const t=r.value.find(s=>s.id===o);t&&t.status==="paused"&&(n==null||n.postMessage({controls:{type:"resumeItem",itemId:o}}),r.value.find(p=>p.status==="downloading"||p.status==="pending")?(t.status="waiting",t.children.forEach(p=>{p.status==="paused"&&(p.status="waiting")})):(t.status="pending",t.children.forEach(p=>{p.status==="paused"&&(p.status="pending")})),r.value.some(p=>p.status==="downloading"||p.status==="pending")&&(f.value=!1))}function Q(o){n==null||n.postMessage({controls:{action:"prioritize",itemId:o}})}async function G(o,t){N.value=!0;try{const{data:s}=await ie().get(`/${t}/watch`),i=s.filter(e=>!!(e!=null&&e.file)).map(e=>e.video_id),p=r.value.map(e=>e.id),R=i.some(e=>!p.includes(e))||p.some(e=>!i.includes(e));R?($.value=0,A.value=0,r.value=[]):r.value=r.value.filter(e=>e.status==="completed"),r.value=await Promise.all(s.filter(e=>!!(e!=null&&e.file)).map(async(e,g)=>{var E,k,C,I,_;const w=(E=e.tracks)==null?void 0:E.some(a=>a.kind==="subtitles"&&a.file),y=(k=e.tracks)==null?void 0:k.some(a=>a.kind==="fonts"&&a.file),d=(C=e.tracks)==null?void 0:C.some(a=>["thumbnails","sprite"].includes(a.kind)&&a.file);let m=!1;if(e.file.endsWith(".m3u8"))try{m=(await(await fetch(`${(I=X.value)==null?void 0:I.serverBaseUrl}${e.file}`,{headers:{Authorization:`Bearer ${(_=q.value)==null?void 0:_.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(a){console.warn("Failed to check master playlist for audio:",a)}const v=[{type:"video",name:"Video",progress:0,status:"pending"}];return m&&v.push({type:"audio",name:"Audio",progress:0,status:"pending"}),w&&v.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),d&&v.push({type:"preview",name:"Preview",progress:0,status:"pending"}),y&&v.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:e.video_id,title:`${e.show}${e.season?` S${K(e.season,2)}`:""}${e.episode?`E${K(e.episode,2)}`:""} - ${e.title}`,image:e.image,progress:0,status:g===0?"pending":"waiting",children:v.map(a=>({...a,status:g===0?"pending":"waiting"}))}}));const V=s.filter(e=>!!(e!=null&&e.file)).map(e=>{var d,m,v,E,k,C,I,_;const g=(m=(d=e.tracks)==null?void 0:d.filter(a=>a.kind==="subtitles"&&a.file))==null?void 0:m.map(a=>a.file),w=(E=(v=e.tracks)==null?void 0:v.filter(a=>a.kind==="fonts"&&a.file))==null?void 0:E.map(a=>a.file),y=(C=(k=e.tracks)==null?void 0:k.filter(a=>["thumbnails","sprite"].includes(a.kind)&&a.file))==null?void 0:C.map(a=>a.file);return{mediaId:e.video_id,mediaType:"video",mediaPath:e.file,baseUrl:((I=X.value)==null?void 0:I.serverBaseUrl)||"",token:((_=q.value)==null?void 0:_.accessToken)||"",...g!=null&&g.length?{subtitlePaths:g}:{},...w!=null&&w.length?{fontPaths:w}:{},...y!=null&&y.length?{previewPaths:y}:{}}});if(!V.length)throw new Error("No valid files to download");return S.value=V.length,console.log("Starting download with tasks:",V),await new Promise((e,g)=>{var w,y;n=new Worker(new URL("/assets/downloadWorker-Dv6gNako.js",import.meta.url),{type:"module"}),n.onerror=d=>{console.error("Worker error:",d),g(d)},n.onmessage=d=>{if(console.log("Worker message:",d.data),d.data.type==="error"&&d.data.error==="paused")return;const{type:m,progress:v,itemProgress:E,assetType:k,assetProgress:C,itemId:I,status:_,isNewQuery:a}=d.data;if(m==="progress"){if((R||!a)&&($.value=Math.min(v,100)),T.value=E,I){const c=r.value.find(P=>P.id===I);if(c){if(k){const M=c.children.find(Z=>Z.type===k);M&&(M.progress=Math.min(C,100),M.status=M.progress===100?"completed":_)}const P=c.children.filter(M=>M.progress===100).length;c.progress=Math.round(P/c.children.length*100),c.progress===100?(c.status="completed",U()):_&&(c.status=_)}}}else if(m==="complete")U(),e(!0);else if(m==="error")d.data.error==="paused"?e(!1):g(d.data.error);else if(m==="status"){const c=r.value.find(P=>P.id===d.data.itemId);c&&c.status!=="completed"&&c.status!==d.data.status&&(c.status=d.data.status,c.children.forEach(P=>{P.status!=="completed"&&(P.status=d.data.status)}))}},n.postMessage({tasks:V,baseUrl:(w=X.value)==null?void 0:w.serverBaseUrl,token:(y=q.value)==null?void 0:y.accessToken,isNewQuery:R})}),!0}catch(s){return s==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",s),!1)}finally{f.value||(n==null||n.terminate(),N.value=!1)}}return{isDownloading:N,progress:$,totalItems:S,completedItems:A,itemProgress:T,downloadQueue:r,isPaused:f,downloadPlaylist:G,pauseDownloads:W,resumeDownloads:j,pauseItem:F,resumeItem:B,prioritizeItem:Q}}const ce={class:"flex flex-col gap-2 p-4 overflow-clip col-span-12"},pe={class:"flex gap-4 max-h-[80vh] overflow-clip"},fe={class:"w-2/5"},ge=["disabled"],me={key:0,class:"mt-2 text-xs"},ve={class:"flex justify-between items-center mb-1"},he={class:"w-full bg-neutral-700 rounded h-1.5 mt-1"},we={key:0,class:"flex-1 overflow-y-auto available"},ye={class:"grid gap-2"},_e={class:"flex justify-between items-center"},xe={class:"text-sm font-medium truncate flex items-center gap-2"},be={key:0,class:"text-2xs text-neutral-400"},ke={key:1,class:"text-2xs text-neutral-400"},Ie=["onClick"],Pe={class:"flex gap-2"},De={class:"w-1/4 flex flex-col gap-2"},$e=["src"],Ee={class:"flex-1 min-w-0"},Ce={class:"grid grid-cols-1 gap-x-4 gap-y-0.5"},Ae={class:"flex justify-between leading-0"},Me={class:"w-full bg-neutral-700 rounded h-1"},Ze=ee({__name:"Desktop",setup(N){const{isDownloading:$,progress:A,totalItems:S,completedItems:T,downloadQueue:r,isPaused:f,downloadPlaylist:n,pauseDownloads:U,resumeDownloads:W,pauseItem:j,resumeItem:F}=de(),B=D("tv/138357");async function Q(){await n("video",B.value)}return(G,o)=>{const t=se("InputText");return h(),te(u(le),null,{default:L(()=>[O(u(ae),{fullscreen:!0},{default:L(()=>[O(ue,{"grid-style":3,title:"Profile"},{default:L(()=>[l("div",ce,[o[2]||(o[2]=l("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),l("div",pe,[l("div",fe,[O(t,{modelValue:B.value,"onUpdate:modelValue":o[0]||(o[0]=s=>B.value=s),class:"w-full text-sm"},null,8,["modelValue"]),l("button",{disabled:u($),class:"bg-primary p-1.5 rounded disabled:opacity-50 mt-2 w-full text-sm",onClick:Q},b(u($)?"Downloading...":"Download Show"),9,ge),u($)||u(T)?(h(),x("div",me,[l("div",ve,[l("span",null,"Progress: "+b(u(A))+"% ("+b(u(T))+"/"+b(u(S))+")",1),l("button",{class:"text-xs px-2 py-0.5 rounded bg-neutral-800",onClick:o[1]||(o[1]=s=>u(f)?u(W)():u(U)())},b(u(f)?"Resume All":"Pause All"),1)]),l("div",he,[l("div",{class:"bg-primary h-full rounded",style:Y(`width: ${u(A)}%`)},null,4)])])):z("",!0)]),u(r).length?(h(),x("div",we,[l("div",ye,[(h(!0),x(H,null,J(u(r),s=>(h(),x("div",{key:s.id,class:"bg-neutral-900/50 rounded p-4 flex flex-col gap-2"},[l("div",_e,[l("div",xe,[oe(b(s.title)+" ",1),s.status==="downloading"?(h(),x("span",be,"(Downloading...)")):s.status==="waiting"?(h(),x("span",ke,"(Waiting...)")):z("",!0)]),s.status!=="completed"?(h(),x("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-neutral-800",onClick:i=>s.status==="downloading"||s.status==="pending"||s.status==="waiting"?u(j)(s.id):u(F)(s.id)},b(s.status==="downloading"||s.status==="pending"||s.status==="waiting"?"Pause":"Resume"),9,Ie)):z("",!0)]),l("div",Pe,[l("div",De,[l("img",{alt:"Item Image",src:`${u(re)}${s.image}`,class:"w-full h-auto aspect-video object-fit my-auto rounded"},null,8,$e)]),l("div",Ee,[l("div",Ce,[(h(!0),x(H,null,J(s.children,i=>(h(),x("div",{key:i.type,class:"text-2xs"},[l("div",Ae,[l("span",null,b(i.name),1),l("span",null,b(i.progress)+"%",1)]),l("div",Me,[l("div",{class:ne([{"bg-blue-500":i.type==="video","bg-green-500":i.type==="audio","bg-yellow-500":i.type==="subtitle","bg-purple-500":i.type==="preview","bg-pink-500":i.type==="font"},"h-full rounded"]),style:Y(`width: ${i.progress}%`)},null,6)])]))),128))])])])]))),128))])])):z("",!0)])])]),_:1})]),_:1})]),_:1})}}});export{Ze as default};
