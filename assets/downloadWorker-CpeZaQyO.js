(function(){"use strict";var _=function(){function n(){this.listeners={}}var a=n.prototype;return a.on=function(t,r){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(r)},a.off=function(t,r){if(!this.listeners[t])return!1;var s=this.listeners[t].indexOf(r);return this.listeners[t]=this.listeners[t].slice(0),this.listeners[t].splice(s,1),s>-1},a.trigger=function(t){var r=this.listeners[t];if(r)if(arguments.length===2)for(var s=r.length,o=0;o<s;++o)r[o].call(this,arguments[1]);else for(var f=Array.prototype.slice.call(arguments,1),m=r.length,l=0;l<m;++l)r[l].apply(this,f)},a.dispose=function(){this.listeners={}},a.pipe=function(t){this.on("data",function(r){t.push(r)})},n}();function H(){return H=Object.assign?Object.assign.bind():function(n){for(var a=1;a<arguments.length;a++){var e=arguments[a];for(var t in e)({}).hasOwnProperty.call(e,t)&&(n[t]=e[t])}return n},H.apply(null,arguments)}var et=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ot(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Y;typeof window<"u"?Y=window:typeof et<"u"?Y=et:typeof self<"u"?Y=self:Y={};var ut=Y,it=ot(ut),ft=function(a){return it.atob?it.atob(a):Buffer.from(a,"base64").toString("binary")};function gt(n){for(var a=ft(n),e=new Uint8Array(a.length),t=0;t<a.length;t++)e[t]=a.charCodeAt(t);return e}/*! @name m3u8-parser @version 7.2.0 @license Apache-2.0 */class dt extends _{constructor(){super(),this.buffer=""}push(a){let e;for(this.buffer+=a,e=this.buffer.indexOf(`
`);e>-1;e=this.buffer.indexOf(`
`))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)}}const ct="	",Q=function(n){const a=/([0-9.]*)?@?([0-9.]*)?/.exec(n||""),e={};return a[1]&&(e.length=parseInt(a[1],10)),a[2]&&(e.offset=parseInt(a[2],10)),e},mt=function(){const e="(?:"+"[^=]*"+")=(?:"+'"[^"]*"|[^,]*'+")";return new RegExp("(?:^|,)("+e+")")},b=function(n){const a={};if(!n)return a;const e=n.split(mt());let t=e.length,r;for(;t--;)e[t]!==""&&(r=/([^=]*)=(.*)/.exec(e[t]).slice(1),r[0]=r[0].replace(/^\s+|\s+$/g,""),r[1]=r[1].replace(/^\s+|\s+$/g,""),r[1]=r[1].replace(/^['"](.*)['"]$/g,"$1"),a[r[0]]=r[1]);return a},st=n=>{const a=n.split("x"),e={};return a[0]&&(e.width=parseInt(a[0],10)),a[1]&&(e.height=parseInt(a[1],10)),e};class ht extends _{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(a){let e,t;if(a=a.trim(),a.length===0)return;if(a[0]!=="#"){this.trigger("data",{type:"uri",uri:a});return}this.tagMappers.reduce((s,o)=>{const f=o(a);return f===a?s:s.concat([f])},[a]).forEach(s=>{for(let o=0;o<this.customParsers.length;o++)if(this.customParsers[o].call(this,s))return;if(s.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:s.slice(1)});return}if(s=s.replace("\r",""),e=/^#EXTM3U/.exec(s),e){this.trigger("data",{type:"tag",tagType:"m3u"});return}if(e=/^#EXTINF:([0-9\.]*)?,?(.*)?$/.exec(s),e){t={type:"tag",tagType:"inf"},e[1]&&(t.duration=parseFloat(e[1])),e[2]&&(t.title=e[2]),this.trigger("data",t);return}if(e=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"targetduration"},e[1]&&(t.duration=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-VERSION:([0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"version"},e[1]&&(t.version=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA-SEQUENCE:(\-?[0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"media-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\-?[0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(s),e){t={type:"tag",tagType:"playlist-type"},e[1]&&(t.playlistType=e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-BYTERANGE:(.*)?$/.exec(s),e){t=H(Q(e[1]),{type:"tag",tagType:"byterange"}),this.trigger("data",t);return}if(e=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(s),e){t={type:"tag",tagType:"allow-cache"},e[1]&&(t.allowed=!/NO/.test(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-MAP:(.*)$/.exec(s),e){if(t={type:"tag",tagType:"map"},e[1]){const o=b(e[1]);o.URI&&(t.uri=o.URI),o.BYTERANGE&&(t.byterange=Q(o.BYTERANGE))}this.trigger("data",t);return}if(e=/^#EXT-X-STREAM-INF:(.*)$/.exec(s),e){t={type:"tag",tagType:"stream-inf"},e[1]&&(t.attributes=b(e[1]),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=st(t.attributes.RESOLUTION)),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),t.attributes["PROGRAM-ID"]&&(t.attributes["PROGRAM-ID"]=parseInt(t.attributes["PROGRAM-ID"],10))),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA:(.*)$/.exec(s),e){t={type:"tag",tagType:"media"},e[1]&&(t.attributes=b(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-ENDLIST/.exec(s),e){this.trigger("data",{type:"tag",tagType:"endlist"});return}if(e=/^#EXT-X-DISCONTINUITY/.exec(s),e){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}if(e=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(s),e){t={type:"tag",tagType:"program-date-time"},e[1]&&(t.dateTimeString=e[1],t.dateTimeObject=new Date(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-KEY:(.*)$/.exec(s),e){t={type:"tag",tagType:"key"},e[1]&&(t.attributes=b(e[1]),t.attributes.IV&&(t.attributes.IV.substring(0,2).toLowerCase()==="0x"&&(t.attributes.IV=t.attributes.IV.substring(2)),t.attributes.IV=t.attributes.IV.match(/.{8}/g),t.attributes.IV[0]=parseInt(t.attributes.IV[0],16),t.attributes.IV[1]=parseInt(t.attributes.IV[1],16),t.attributes.IV[2]=parseInt(t.attributes.IV[2],16),t.attributes.IV[3]=parseInt(t.attributes.IV[3],16),t.attributes.IV=new Uint32Array(t.attributes.IV))),this.trigger("data",t);return}if(e=/^#EXT-X-START:(.*)$/.exec(s),e){t={type:"tag",tagType:"start"},e[1]&&(t.attributes=b(e[1]),t.attributes["TIME-OFFSET"]=parseFloat(t.attributes["TIME-OFFSET"]),t.attributes.PRECISE=/YES/.test(t.attributes.PRECISE)),this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-out-cont"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT:(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-out"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-IN:?(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-in"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-SKIP:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"skip"},t.attributes=b(e[1]),t.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(t.attributes["SKIPPED-SEGMENTS"]=parseInt(t.attributes["SKIPPED-SEGMENTS"],10)),t.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(t.attributes["RECENTLY-REMOVED-DATERANGES"]=t.attributes["RECENTLY-REMOVED-DATERANGES"].split(ct)),this.trigger("data",t);return}if(e=/^#EXT-X-PART:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"part"},t.attributes=b(e[1]),["DURATION"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),["INDEPENDENT","GAP"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=/YES/.test(t.attributes[o]))}),t.attributes.hasOwnProperty("BYTERANGE")&&(t.attributes.byterange=Q(t.attributes.BYTERANGE)),this.trigger("data",t);return}if(e=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"server-control"},t.attributes=b(e[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=/YES/.test(t.attributes[o]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PART-INF:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"part-inf"},t.attributes=b(e[1]),["PART-TARGET"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"preload-hint"},t.attributes=b(e[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(o){if(t.attributes.hasOwnProperty(o)){t.attributes[o]=parseInt(t.attributes[o],10);const f=o==="BYTERANGE-LENGTH"?"length":"offset";t.attributes.byterange=t.attributes.byterange||{},t.attributes.byterange[f]=t.attributes[o],delete t.attributes[o]}}),this.trigger("data",t);return}if(e=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"rendition-report"},t.attributes=b(e[1]),["LAST-MSN","LAST-PART"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseInt(t.attributes[o],10))}),this.trigger("data",t);return}if(e=/^#EXT-X-DATERANGE:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"daterange"},t.attributes=b(e[1]),["ID","CLASS"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=String(t.attributes[f]))}),["START-DATE","END-DATE"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=new Date(t.attributes[f]))}),["DURATION","PLANNED-DURATION"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=parseFloat(t.attributes[f]))}),["END-ON-NEXT"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=/YES/i.test(t.attributes[f]))}),["SCTE35-CMD"," SCTE35-OUT","SCTE35-IN"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=t.attributes[f].toString(16))});const o=/^X-([A-Z]+-)+[A-Z]+$/;for(const f in t.attributes){if(!o.test(f))continue;const m=/[0-9A-Fa-f]{6}/g.test(t.attributes[f]),l=/^\d+(\.\d+)?$/.test(t.attributes[f]);t.attributes[f]=m?t.attributes[f].toString(16):l?parseFloat(t.attributes[f]):String(t.attributes[f])}this.trigger("data",t);return}if(e=/^#EXT-X-INDEPENDENT-SEGMENTS/.exec(s),e){this.trigger("data",{type:"tag",tagType:"independent-segments"});return}if(e=/^#EXT-X-I-FRAMES-ONLY/.exec(s),e){this.trigger("data",{type:"tag",tagType:"i-frames-only"});return}if(e=/^#EXT-X-CONTENT-STEERING:(.*)$/.exec(s),e){t={type:"tag",tagType:"content-steering"},t.attributes=b(e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-I-FRAME-STREAM-INF:(.*)$/.exec(s),e){t={type:"tag",tagType:"i-frame-playlist"},t.attributes=b(e[1]),t.attributes.URI&&(t.uri=t.attributes.URI),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=st(t.attributes.RESOLUTION)),t.attributes["AVERAGE-BANDWIDTH"]&&(t.attributes["AVERAGE-BANDWIDTH"]=parseInt(t.attributes["AVERAGE-BANDWIDTH"],10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),this.trigger("data",t);return}if(e=/^#EXT-X-DEFINE:(.*)$/.exec(s),e){t={type:"tag",tagType:"define"},t.attributes=b(e[1]),this.trigger("data",t);return}this.trigger("data",{type:"tag",data:s.slice(4)})})}addParser({expression:a,customType:e,dataParser:t,segment:r}){typeof t!="function"&&(t=s=>s),this.customParsers.push(s=>{if(a.exec(s))return this.trigger("data",{type:"custom",data:t(s),customType:e,segment:r}),!0})}addTagMapper({expression:a,map:e}){const t=r=>a.test(r)?e(r):r;this.tagMappers.push(t)}}const lt=n=>n.toLowerCase().replace(/-(\w)/g,a=>a[1].toUpperCase()),x=function(n){const a={};return Object.keys(n).forEach(function(e){a[lt(e)]=n[e]}),a},z=function(n){const{serverControl:a,targetDuration:e,partTargetDuration:t}=n;if(!a)return;const r="#EXT-X-SERVER-CONTROL",s="holdBack",o="partHoldBack",f=e&&e*3,m=t&&t*2;e&&!a.hasOwnProperty(s)&&(a[s]=f,this.trigger("info",{message:`${r} defaulting HOLD-BACK to targetDuration * 3 (${f}).`})),f&&a[s]<f&&(this.trigger("warn",{message:`${r} clamping HOLD-BACK (${a[s]}) to targetDuration * 3 (${f})`}),a[s]=f),t&&!a.hasOwnProperty(o)&&(a[o]=t*3,this.trigger("info",{message:`${r} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${a[o]}).`})),t&&a[o]<m&&(this.trigger("warn",{message:`${r} clamping PART-HOLD-BACK (${a[o]}) to partTargetDuration * 2 (${m}).`}),a[o]=m)};class J extends _{constructor(a={}){super(),this.lineStream=new dt,this.parseStream=new ht,this.lineStream.pipe(this.parseStream),this.mainDefinitions=a.mainDefinitions||{},this.params=new URL(a.uri,"https://a.com").searchParams,this.lastProgramDateTime=null;const e=this,t=[];let r={},s,o,f=!1;const m=function(){},l={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},K="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";let C=0;this.manifest={allowCache:!0,discontinuityStarts:[],dateRanges:[],iFramePlaylists:[],segments:[]};let L=0,B=0;const y={};this.on("end",()=>{r.uri||!r.parts&&!r.preloadHints||(!r.map&&s&&(r.map=s),!r.key&&o&&(r.key=o),!r.timeline&&typeof C=="number"&&(r.timeline=C),this.manifest.preloadSegment=r)}),this.parseStream.on("data",function(i){let d,c;if(e.manifest.definitions){for(const g in e.manifest.definitions)if(i.uri&&(i.uri=i.uri.replace(`{$${g}}`,e.manifest.definitions[g])),i.attributes)for(const u in i.attributes)typeof i.attributes[u]=="string"&&(i.attributes[u]=i.attributes[u].replace(`{$${g}}`,e.manifest.definitions[g]))}({tag(){({version(){i.version&&(this.manifest.version=i.version)},"allow-cache"(){this.manifest.allowCache=i.allowed,"allowed"in i||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){const g={};"length"in i&&(r.byterange=g,g.length=i.length,"offset"in i||(i.offset=L)),"offset"in i&&(r.byterange=g,g.offset=i.offset),L=g.offset+g.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),i.title&&(r.title=i.title),i.duration>0&&(r.duration=i.duration),i.duration===0&&(r.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=t},key(){if(!i.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(i.attributes.METHOD==="NONE"){o=null;return}if(!i.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(i.attributes.KEYFORMAT==="com.apple.streamingkeydelivery"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:i.attributes};return}if(i.attributes.KEYFORMAT==="com.microsoft.playready"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.microsoft.playready"]={uri:i.attributes.URI};return}if(i.attributes.KEYFORMAT===K){if(["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(i.attributes.METHOD)===-1){this.trigger("warn",{message:"invalid key method provided for Widevine"});return}if(i.attributes.METHOD==="SAMPLE-AES-CENC"&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),i.attributes.URI.substring(0,23)!=="data:text/plain;base64,"){this.trigger("warn",{message:"invalid key URI provided for Widevine"});return}if(!(i.attributes.KEYID&&i.attributes.KEYID.substring(0,2)==="0x")){this.trigger("warn",{message:"invalid key ID provided for Widevine"});return}this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:i.attributes.KEYFORMAT,keyId:i.attributes.KEYID.substring(2)},pssh:gt(i.attributes.URI.split(",")[1])};return}i.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),o={method:i.attributes.METHOD||"AES-128",uri:i.attributes.URI},typeof i.attributes.IV<"u"&&(o.iv=i.attributes.IV)},"media-sequence"(){if(!isFinite(i.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+i.number});return}this.manifest.mediaSequence=i.number},"discontinuity-sequence"(){if(!isFinite(i.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+i.number});return}this.manifest.discontinuitySequence=i.number,C=i.number},"playlist-type"(){if(!/VOD|EVENT/.test(i.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+i.playlist});return}this.manifest.playlistType=i.playlistType},map(){s={},i.uri&&(s.uri=i.uri),i.byterange&&(s.byterange=i.byterange),o&&(s.key=o)},"stream-inf"(){if(this.manifest.playlists=t,this.manifest.mediaGroups=this.manifest.mediaGroups||l,!i.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}r.attributes||(r.attributes={}),H(r.attributes,i.attributes)},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||l,!(i.attributes&&i.attributes.TYPE&&i.attributes["GROUP-ID"]&&i.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}const g=this.manifest.mediaGroups[i.attributes.TYPE];g[i.attributes["GROUP-ID"]]=g[i.attributes["GROUP-ID"]]||{},d=g[i.attributes["GROUP-ID"]],c={default:/yes/i.test(i.attributes.DEFAULT)},c.default?c.autoselect=!0:c.autoselect=/yes/i.test(i.attributes.AUTOSELECT),i.attributes.LANGUAGE&&(c.language=i.attributes.LANGUAGE),i.attributes.URI&&(c.uri=i.attributes.URI),i.attributes["INSTREAM-ID"]&&(c.instreamId=i.attributes["INSTREAM-ID"]),i.attributes.CHARACTERISTICS&&(c.characteristics=i.attributes.CHARACTERISTICS),i.attributes.FORCED&&(c.forced=/yes/i.test(i.attributes.FORCED)),d[i.attributes.NAME]=c},discontinuity(){C+=1,r.discontinuity=!0,this.manifest.discontinuityStarts.push(t.length)},"program-date-time"(){typeof this.manifest.dateTimeString>"u"&&(this.manifest.dateTimeString=i.dateTimeString,this.manifest.dateTimeObject=i.dateTimeObject),r.dateTimeString=i.dateTimeString,r.dateTimeObject=i.dateTimeObject;const{lastProgramDateTime:g}=this;this.lastProgramDateTime=new Date(i.dateTimeString).getTime(),g===null&&this.manifest.segments.reduceRight((u,h)=>(h.programDateTime=u-h.duration*1e3,h.programDateTime),this.lastProgramDateTime)},targetduration(){if(!isFinite(i.duration)||i.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+i.duration});return}this.manifest.targetDuration=i.duration,z.call(this,this.manifest)},start(){if(!i.attributes||isNaN(i.attributes["TIME-OFFSET"])){this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});return}this.manifest.start={timeOffset:i.attributes["TIME-OFFSET"],precise:i.attributes.PRECISE}},"cue-out"(){r.cueOut=i.data},"cue-out-cont"(){r.cueOutCont=i.data},"cue-in"(){r.cueIn=i.data},skip(){this.manifest.skip=x(i.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",i.attributes,["SKIPPED-SEGMENTS"])},part(){f=!0;const g=this.manifest.segments.length,u=x(i.attributes);r.parts=r.parts||[],r.parts.push(u),u.byterange&&(u.byterange.hasOwnProperty("offset")||(u.byterange.offset=B),B=u.byterange.offset+u.byterange.length);const h=r.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${h} for segment #${g}`,i.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((T,p)=>{T.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${p} lacks required attribute(s): LAST-PART`})})},"server-control"(){const g=this.manifest.serverControl=x(i.attributes);g.hasOwnProperty("canBlockReload")||(g.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),z.call(this,this.manifest),g.canSkipDateranges&&!g.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){const g=this.manifest.segments.length,u=x(i.attributes),h=u.type&&u.type==="PART";r.preloadHints=r.preloadHints||[],r.preloadHints.push(u),u.byterange&&(u.byterange.hasOwnProperty("offset")||(u.byterange.offset=h?B:0,h&&(B=u.byterange.offset+u.byterange.length)));const T=r.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${T} for segment #${g}`,i.attributes,["TYPE","URI"]),!!u.type)for(let p=0;p<r.preloadHints.length-1;p++){const R=r.preloadHints[p];R.type&&R.type===u.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${T} for segment #${g} has the same TYPE ${u.type} as preload hint #${p}`})}},"rendition-report"(){const g=x(i.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(g);const u=this.manifest.renditionReports.length-1,h=["LAST-MSN","URI"];f&&h.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${u}`,i.attributes,h)},"part-inf"(){this.manifest.partInf=x(i.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",i.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),z.call(this,this.manifest)},daterange(){this.manifest.dateRanges.push(x(i.attributes));const g=this.manifest.dateRanges.length-1;this.warnOnMissingAttributes_(`#EXT-X-DATERANGE #${g}`,i.attributes,["ID","START-DATE"]);const u=this.manifest.dateRanges[g];u.endDate&&u.startDate&&new Date(u.endDate)<new Date(u.startDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE END-DATE must be equal to or later than the value of the START-DATE"}),u.duration&&u.duration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE DURATION must not be negative"}),u.plannedDuration&&u.plannedDuration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE PLANNED-DURATION must not be negative"});const h=!!u.endOnNext;if(h&&!u.class&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must have a CLASS attribute"}),h&&(u.duration||u.endDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must not contain DURATION or END-DATE attributes"}),u.duration&&u.endDate){const p=u.startDate.getTime()+u.duration*1e3;this.manifest.dateRanges[g].endDate=new Date(p)}if(!y[u.id])y[u.id]=u;else{for(const p in y[u.id])if(u[p]&&JSON.stringify(y[u.id][p])!==JSON.stringify(u[p])){this.trigger("warn",{message:"EXT-X-DATERANGE tags with the same ID in a playlist must have the same attributes values"});break}const T=this.manifest.dateRanges.findIndex(p=>p.id===u.id);this.manifest.dateRanges[T]=H(this.manifest.dateRanges[T],u),y[u.id]=H(y[u.id],u),this.manifest.dateRanges.pop()}},"independent-segments"(){this.manifest.independentSegments=!0},"i-frames-only"(){this.manifest.iFramesOnly=!0,this.requiredCompatibilityversion(this.manifest.version,4)},"content-steering"(){this.manifest.contentSteering=x(i.attributes),this.warnOnMissingAttributes_("#EXT-X-CONTENT-STEERING",i.attributes,["SERVER-URI"])},define(){this.manifest.definitions=this.manifest.definitions||{};const g=(u,h)=>{if(u in this.manifest.definitions){this.trigger("error",{message:`EXT-X-DEFINE: Duplicate name ${u}`});return}this.manifest.definitions[u]=h};if("QUERYPARAM"in i.attributes){if("NAME"in i.attributes||"IMPORT"in i.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}const u=this.params.get(i.attributes.QUERYPARAM);if(!u){this.trigger("error",{message:`EXT-X-DEFINE: No query param ${i.attributes.QUERYPARAM}`});return}g(i.attributes.QUERYPARAM,decodeURIComponent(u));return}if("NAME"in i.attributes){if("IMPORT"in i.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}if(!("VALUE"in i.attributes)||typeof i.attributes.VALUE!="string"){this.trigger("error",{message:`EXT-X-DEFINE: No value for ${i.attributes.NAME}`});return}g(i.attributes.NAME,i.attributes.VALUE);return}if("IMPORT"in i.attributes){if(!this.mainDefinitions[i.attributes.IMPORT]){this.trigger("error",{message:`EXT-X-DEFINE: No value ${i.attributes.IMPORT} to import, or IMPORT used on main playlist`});return}g(i.attributes.IMPORT,this.mainDefinitions[i.attributes.IMPORT]);return}this.trigger("error",{message:"EXT-X-DEFINE: No attribute"})},"i-frame-playlist"(){this.manifest.iFramePlaylists.push({attributes:i.attributes,uri:i.uri,timeline:C}),this.warnOnMissingAttributes_("#EXT-X-I-FRAME-STREAM-INF",i.attributes,["BANDWIDTH","URI"])}}[i.tagType]||m).call(e)},uri(){r.uri=i.uri,t.push(r),this.manifest.targetDuration&&!("duration"in r)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),r.duration=this.manifest.targetDuration),o&&(r.key=o),r.timeline=C,s&&(r.map=s),B=0,this.lastProgramDateTime!==null&&(r.programDateTime=this.lastProgramDateTime,this.lastProgramDateTime+=r.duration*1e3),r={}},comment(){},custom(){i.segment?(r.custom=r.custom||{},r.custom[i.customType]=i.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[i.customType]=i.data)}})[i.type].call(e)})}requiredCompatibilityversion(a,e){(a<e||!a)&&this.trigger("warn",{message:`manifest must be at least version ${e}`})}warnOnMissingAttributes_(a,e,t){const r=[];t.forEach(function(s){e.hasOwnProperty(s)||r.push(s)}),r.length&&this.trigger("warn",{message:`${a} lacks required attribute(s): ${r.join(", ")}`})}push(a){this.lineStream.push(a)}end(){this.lineStream.push(`
`),this.manifest.dateRanges.length&&this.lastProgramDateTime===null&&this.trigger("warn",{message:"A playlist with EXT-X-DATERANGE tag must contain atleast one EXT-X-PROGRAM-DATE-TIME tag"}),this.lastProgramDateTime=null,this.trigger("end")}addParser(a){this.parseStream.addParser(a)}addTagMapper(a){this.parseStream.addTagMapper(a)}}let O=!1;const w=new Set;let E=null,at=[];async function M(n,a,e){const t=n.startsWith("http")?n:`${a}${n}`,r=await fetch(t,{headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw new Error(`Failed to fetch ${n}: ${r.statusText}`);return r}async function N(n){return new Promise((a,e)=>{O||n&&w.has(n)?e(new Error("paused")):a()})}function D(n,a){self.postMessage({type:"status",itemId:n,status:a})}const V=new Map,Z=new Map;function F(n,a){return`${n}:${a}`}async function rt(n,a,e,t){let r=0;for(const s of a){const o=s.path.substring(0,s.path.lastIndexOf("/"));for(const f of s.segments){const m=f.uri.startsWith("http")?f.uri:`${o}/${f.uri}`,l=F(n,m);await(E==null?void 0:E.match(l))&&(t.add(l),r++)}}return r}async function pt(n,a,e){var m,l,K,C,L,B,y,i;if(E||(E=await caches.open("offline-content-v1")),await N(n.mediaId),O||w.has(n.mediaId))return!1;const t=new Map;V.has(n.mediaId)||V.set(n.mediaId,new Set);const r=V.get(n.mediaId);Z.has(n.mediaId)||Z.set(n.mediaId,new Set);const s=Z.get(n.mediaId),o=(d,c,g=0)=>{if(!t.has(d)){const u={type:d,total:c,completed:g};t.set(d,u);const h=v();self.postMessage({type:"progress",progress:h.progress,currentItem:h.completedItems,totalItems:h.totalItems,itemProgress:Math.round(g/c*100),assetType:d,assetProgress:Math.round(g/c*100),itemId:n.mediaId,status:"downloading"}),g===c&&d!=="video"&&d!=="audio"&&r.add(d)}},f=d=>{const c=t.get(d);if(c){c.completed++;const g=Math.round(c.completed/c.total*100);g===100&&d!=="video"&&d!=="audio"&&r.add(d);const h=g===100&&!(d==="video"||d==="audio"),T=v();self.postMessage({type:"progress",progress:T.progress,currentItem:T.completedItems,totalItems:T.totalItems,itemProgress:g,assetType:d,assetProgress:g,itemId:n.mediaId,status:h?"completed":"downloading"})}};try{if(await N(n.mediaId),n.mediaPath.includes(".m3u8")){const c=await(await M(n.mediaPath,a,e)).text(),g=new J;g.push(c),g.end();const u=g.manifest,h=n.mediaPath.substring(0,n.mediaPath.lastIndexOf("/"));let T=0;const p=[];if((m=u.playlists)!=null&&m.length)for(const R of u.playlists){const P=R.uri.startsWith("http")?R.uri:`${h}/${R.uri}`,I=await(await M(P,a,e)).text(),A=new J;A.push(I),A.end(),(l=A.manifest.segments)!=null&&l.length&&(T+=A.manifest.segments.length,p.push({path:P,segments:A.manifest.segments}))}else(K=u.segments)!=null&&K.length&&(T=u.segments.length,p.push({path:n.mediaPath,segments:u.segments}));if(T>0){const R=await rt(n.mediaId,p,"video",s);o("video",T,R);for(const P of p){const $=P.path.substring(0,P.path.lastIndexOf("/"));for(const I of P.segments){await N(n.mediaId);const A=I.uri.startsWith("http")?I.uri:`${$}/${I.uri}`,X=F(n.mediaId,A);if(s.has(X))continue;if(await E.match(X)){s.add(X);continue}await N(n.mediaId);const S=await M(A,a,e).then(tt=>tt.blob()),nt=new Response(S.slice(0));await E.put(X,nt),s.add(X),f("video")}}}if((C=u.mediaGroups)!=null&&C.AUDIO){let R=0;const P=[];for(const $ of Object.values(u.mediaGroups.AUDIO))for(const I of Object.values($)){if(!I.uri)continue;const A=I.uri.startsWith("http")?I.uri:`${h}/${I.uri}`,q=await(await M(A,a,e)).text(),S=new J;S.push(q),S.end(),(L=S.manifest.segments)!=null&&L.length&&(R+=S.manifest.segments.length,P.push({path:A,segments:S.manifest.segments}))}if(R>0){const $=await rt(n.mediaId,P,"audio",s);o("audio",R,$);for(const I of P){const A=I.path.substring(0,I.path.lastIndexOf("/"));for(const X of I.segments){await N(n.mediaId);const q=X.uri.startsWith("http")?X.uri:`${A}/${X.uri}`,S=F(n.mediaId,q);if(s.has(S))continue;if(await E.match(S)){s.add(S);continue}await N(n.mediaId);const tt=await M(q,a,e).then(Tt=>Tt.blob()),Et=new Response(tt.slice(0));await E.put(S,Et),s.add(S),f("audio")}}}}}else{const d=F(n.mediaId,n.mediaPath);if(await E.match(d))r.add("video"),self.postMessage({type:"progress",progress:v().progress,currentItem:v().completedItems,totalItems:v().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:n.mediaId,status:"downloading"});else{const g=`${a}${n.mediaPath}`,u=await fetch(g,{headers:{Authorization:`Bearer ${e}`}});if(!u.ok)throw new Error(`Failed to download video: ${u.statusText}`);await E.put(d,u.clone()),r.add("video"),self.postMessage({type:"progress",progress:v().progress,currentItem:v().completedItems,totalItems:v().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:n.mediaId,status:"downloading"})}}if((B=n.subtitlePaths)!=null&&B.length){o("subtitle",n.subtitlePaths.length);for(const d of n.subtitlePaths){const c=F(n.mediaId,d);if(!await E.match(c)){await N(n.mediaId);const u=await M(d,a,e);await E.put(c,u.clone())}f("subtitle")}}if((y=n.previewPaths)!=null&&y.length){o("preview",n.previewPaths.length);for(const d of n.previewPaths){const c=F(n.mediaId,d);if(!await E.match(c)){await N(n.mediaId);const u=await M(d,a,e);await E.put(c,u.clone())}f("preview")}}if((i=n.fontPaths)!=null&&i.length){let d=0;const c=[];for(const g of n.fontPaths){const h=await(await M(g,a,e)).json();d+=h.length,c.push({path:g,fonts:h})}o("font",d);for(const{path:g,fonts:u}of c){const h=F(n.mediaId,g);if(await E.match(h))u.forEach(()=>f("font"));else{await N(n.mediaId);const p=g.substring(0,g.lastIndexOf("/")+1);for(const R of u){await N(n.mediaId);const P=`${p}fonts/${R.file}`,$=F(n.mediaId,P);if(await E.match($))f("font");else{const A=await M(P,a,e);await E.put($,A.clone()),f("font")}}await E.put(h,new Response(JSON.stringify(u)))}}}}catch(d){if((d==null?void 0:d.message)==="paused")return!1;throw d}}let U=[],W="",j="";async function k(n,a,e){let t=0;for(;t<n.length;){const s=n[t];D(s.mediaId,"downloading"),n.slice(t+1).forEach(o=>{!G.get(o.mediaId)&&!w.has(o.mediaId)&&D(o.mediaId,"waiting")});try{if(O){D(s.mediaId,"paused");return}if(w.has(s.mediaId)){D(s.mediaId,"paused"),t++;continue}if(at=[{taskIndex:U.indexOf(s),promise:pt(s,a,e)}],D(s.mediaId,"downloading"),await at[0].promise===!1){if(D(s.mediaId,"paused"),O)return;t++}else D(s.mediaId,"completed"),t++}catch(o){if((o==null?void 0:o.message)==="paused"){if(D(s.mediaId,"paused"),O)return;t++}else throw D(s.mediaId,"error"),o}}if(n.filter(s=>w.has(s.mediaId)).length===0){const s=v();self.postMessage({type:"complete",progress:s.progress,currentItem:s.completedItems,totalItems:s.totalItems})}}const G=new Map;function v(){const n=Array.from(G.values()).filter(e=>e).length;let a=0;return U.forEach(e=>{var t,r,s;if(G.get(e.mediaId))a+=100;else if(V.has(e.mediaId)){const o=new Set(["video"]);(t=e.subtitlePaths)!=null&&t.length&&o.add("subtitle"),(r=e.fontPaths)!=null&&r.length&&o.add("font"),(s=e.previewPaths)!=null&&s.length&&o.add("preview");const f=V.get(e.mediaId),m=Array.from(o).filter(l=>f.has(l)).length;a+=m/o.size*100}}),{progress:Math.round(a/U.length),completedItems:n,totalItems:U.length}}self.onmessage=async n=>{const{tasks:a,controls:e}=n.data;if(a&&(U=a,W=n.data.baseUrl,j=n.data.token,G.clear(),w.clear()),e){const{type:r,itemId:s}=e;switch(r){case"pause":O=!0,U.forEach(m=>{G.get(m.mediaId)||(w.add(m.mediaId),self.postMessage({type:"status",itemId:m.mediaId,status:"paused"}))});break;case"resume":O=!1,w.clear();const o=e.pausedIds||[],f=U.filter(m=>!G.get(m.mediaId)&&o.includes(m.mediaId));if(f.length){f.forEach(m=>{D(m.mediaId,"pending")});try{await k(f,W,j)}catch(m){console.error("Failed to resume queue:",m)}}break;case"pauseItem":s&&(w.add(s),D(s,"paused"));break;case"resumeItem":if(s){w.delete(s),D(s,"pending");const m=U.find(l=>l.mediaId===s);if(m&&!G.get(m.mediaId))try{const l=O;O=!1,await k([m],W,j),O=l}catch(l){console.error("Failed to resume item:",l),D(s,"error")}}break}return}const t=a.filter(r=>!G.get(r.mediaId));await k(t,W,j)}})();
//# sourceMappingURL=downloadWorker-CpeZaQyO.js.map
