import{$ as p,ek as l}from"./index-DhiqRu-L.js";import{P as r,S as h}from"./subtitles-octopus-DMalgE0y.js";class d extends r{player={};route={};async initialize(e){this.player=e}use(){this.player.on("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.on("back",this.ended.bind(this)),this.player.on("ended",this.ended.bind(this)),this.player.on("finished",this.ended.bind(this)),this.route=p()}dispose(){this.player.off("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.off("back",this.ended.bind(this)),this.player.off("ended",this.ended.bind(this)),this.player.off("finished",this.ended.bind(this))}lastTimeTrigger(){const e=this.episodeData();l()?.invoke("SetTime",e)}ended(){const e=this.player.getCurrentTime()/this.player.getDuration()*100;this.player.isLastPlaylistItem()&&this.player.playlistItem()?.playlist_type==="tv"&&e>=90?l()?.invoke("RemoveWatched",this.episodeData()).then():this.player.isLastPlaylistItem()&&this.player.playlistItem()?.playlist_type==="movie"&&e>=80&&l()?.invoke("RemoveWatched",this.episodeData()).then()}episodeData(){const e=this.player.playlistItem();let t=this.route?.path;t||(t=window.location.hash.replace("#","")),t||(t=location.pathname);const s=t?.split("/");let a,o,i=e?.tmdb_id??s.at(-2);return s.at(-3)==="specials"?a=s.at(-2):s.at(-3)==="collection"&&(o=s.at(-2),i=e.id),{video_id:e?.video_id,tmdb_id:i,playlist_type:s.at(-3),special_id:a,collection_id:o,video_type:e?.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}}class u extends r{initialize(e){this.player=e}use(){this.player.on("captionsChanged",this.opus.bind(this)),this.resizeObserver=new ResizeObserver(()=>{this.resize()}),this.resizeObserver.observe(this.player.container)}dispose(){this.player.off("captionsChanged",this.opus.bind(this)),this.resizeObserver?.disconnect(),this.destroy()}destroy(){this.player.octopusInstance?.dispose(),this.player.octopusInstance=null}async opus(){this.destroy();const e=this.player.getSubtitleFile()?`${this.player.options.basePath??""}${this.player.getSubtitleFile()}`:null;if(!e)return;const t=e?.match(/\w+\.\w+\.\w+$/u)?.[0];let[,,s]=t?t.split("."):[];if(s||(s=e.split(".").at(-1)||""),!(s!="ass"&&s!="ssa")&&e){await this.player.fetchFontFile();const a=this.player.fonts?.map(i=>encodeURI(`${this.player.options.basePath??""}${i.file}`));this.player.getElement().querySelectorAll(".libassjs-canvas-parent").forEach(i=>i.remove());const o={video:this.player.getVideoElement(),subUrl:encodeURI(e),fonts:a,lossyRender:this.player.options.lossyRender,accessToken:this.player.options.accessToken,targetFps:this.player.options.targetFps,debug:this.player.options.debug,blendRender:this.player.options.blendRender,lazyFileLoading:this.player.options.lazyFileLoading,renderAhead:this.player.options.renderAhead,workerUrl:"/js/octopus/subtitles-octopus-worker.js",legacyWorkerUrl:"/js/octopus/subtitles-octopus-worker-legacy.js",fallbackFont:"/js/octopus/default.ttf",onReady:async()=>{this.resize()},onError:i=>{console.error("opus error",i)}};e&&e.includes(".ass")&&(this.player.octopusInstance=new h(o))}}resize(){!this.player?.octopusInstance?.canvasParent||!this.subtitleOverlay||(this.player.octopusInstance.canvasParent.style.width=this.subtitleOverlay.style.width,this.player.octopusInstance.canvasParent.style.height=this.subtitleOverlay.style.height,this.player.octopusInstance.canvasParent.style.position=this.subtitleOverlay.style.position,this.player.octopusInstance.canvasParent.style.top=this.subtitleOverlay.style.top,this.player.octopusInstance.canvasParent.style.left=this.subtitleOverlay.style.left,this.player.octopusInstance.canvasParent.style.transform=this.subtitleOverlay.style.transform)}}export{u as O,d as S};
