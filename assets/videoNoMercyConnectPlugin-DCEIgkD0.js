import{Ns as o,Rc as r,Uo as d,Wo as c,Ws as h,i as u,ka as p,m as y}from"./index-CJcxWh6B.js";import{c as f}from"./VideoPlayer-Bm2DB99r.js";o();var l=r({});const m=h(()=>l.value);function v(t){l.value=t}d();var k=class extends f{player={};route={};playerState=void 0;connectedDevices=[];currentVideoDeviceId=null;currentList=null;socket=null;async initialize(t){this.player=t,this.socket=y()}use(){this.player.on("ready",this.ready.bind(this)),this.player.on("dispose",this.handleDispose.bind(this)),this.route=c(),this.socket?.on("VideoPlayerState",this.handleVideoPlayerState.bind(this)),this.socket?.on("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),this.socket?.on("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}dispose(){this.player.off("ready",this.ready.bind(this)),this.player.off("dispose",this.handleDispose.bind(this)),this.socket?.off("VideoPlayerState",this.handleVideoPlayerState.bind(this)),this.socket?.off("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),this.socket?.off("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}episodeData(){const t=this.player.playlistItem();let i=this.route?.path;i||(i=window.location.hash.replace("#","")),i||(i=location.pathname);const e=i?.split("/");let a,s,n=t?.tmdb_id??e.at(-2);return e.at(-3)==="specials"?a=e.at(-2):e.at(-3)==="collection"&&(s=e.at(-2),n=t.id??e.at(-2)),{video_id:t?.video_id,tmdb_id:n,playlist_type:e.at(-3),special_id:a,collection_id:s,video_type:t?.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}ready(){const t=this.episodeData();this.socket?.invoke("StartPlaybackCommand",t?.playlist_type,t?.tmdb_id,t?.tmdb_id),this.socket?.invoke("Devices").then(this.handleVideoConnectedDevicesState.bind(this))}handleDispose(){this.socket?.invoke("PlaybackCommand","stop",null)}handleVideoBroadcastStatus(t){if(t)for(const i of t.events){const e=i.deviceBroadcastStatus;this.currentVideoDeviceId=e.device_id,e.device_id===p.value?this.player.setMute(!1):this.player.setMute(!0)}}handleVideoPlayerState(t){if(t)for(const i of t.events){if(i.type!=="PlayerStateChanged")continue;const e=i.event.state;this.playerState=e,v(e),console.log(e),e.current_list&&u.replace(e.current_list).then();const a=(Date.now()-e.timestamp)/1e3/2,s=e.progress_ms>=1?(e.progress_ms+a)/1e3:e.progress_ms/1e3;this.currentVideoDeviceId=e.device_id,this.player.setVolume(e.volume_percentage),this.player.setMute(e.muted_state),this.setPlayState(e),this.player.once("seeked",()=>{this.setPlayState(e)}),this.player.on("item",()=>{this.setPlayState(e)}),this.setSeek(s),this.player.on("playlist",()=>{this.player.once("item",()=>{this.setSeek(s)}),this.setItemFromIndex(e)}),this.player.getPlaylist().length===0||this.currentList!=e.current_list?(this.currentList=e.current_list,this.player.setPlaylist(e.playlist)):this.setItemFromIndex(e),setTimeout(()=>{this.changeAudioTrack(e),this.changeCaptionTrack(e),this.changeQualityLevel(e)},150),this.player.on("audioTracks",()=>{this.changeAudioTrack(e)}),this.player.on("captionsList",()=>{this.changeCaptionTrack(e)}),this.player.on("levels",()=>{this.changeQualityLevel(e)})}}setSeek(t){t!==0&&Math.abs(this.player.getCurrentTime()-t)>.75&&this.player.seek(t)}setItemFromIndex(t){const i=t.playlist.findIndex(e=>e.video_id===t.item.video_id);i!==this.player.getPlaylistIndex()&&this.player.playVideo(i)}setPlayState(t){t.is_playing?this.player.play().then():this.player.pause()}changeQualityLevel(t){if(t.current_quality?.width!=null){const i=this.player.getQualityLevels().findIndex(e=>e.width===t.current_quality.width);i!=null&&this.player.setCurrentQuality(i)}else this.player.setCurrentQuality(-1)}changeCaptionTrack(t){if(t.current_caption?.language!=null){const i=this.player.getCaptionsList().findIndex(e=>e.language===t.current_caption.language&&e.type===t.current_caption.type&&e.ext===t.current_caption.codec);i!=null&&this.player.setCurrentCaption(i-1)}else this.player.setCurrentCaption(-1)}changeAudioTrack(t){if(t.current_audio?.language!=null){const i=this.player.getAudioTracks().findIndex(e=>e.language===t.current_audio?.language);i!=null&&this.player.setCurrentAudioTrack(i)}else this.player.setCurrentAudioTrack(-1)}handleVideoConnectedDevicesState(t){this.connectedDevices=t}};export{k as t};
