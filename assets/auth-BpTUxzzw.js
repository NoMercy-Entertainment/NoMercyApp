import{mt as h}from"./index-CJ3av9Nr.js";import{t as u}from"./client-CPKuC57Q.js";import{a as k,t as m}from"./config-BZ-AEJ_J.js";import{n as l,s as d,t as g}from"./user-Creb9Pvq.js";var w="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function s(e){console.error(e)}s.prototype=new Error;s.prototype.name="InvalidCharacterError";function _(e=""){const r=String(e).replace(/[=]+$/u,"");if(r.length%4===1)throw new s("'atob' failed: The string to be decoded is not correctly encoded.");let t=0,o=0,i=0,n="";for(let a;a=r.charAt(i++);~a&&(o=t%4?o*64+a:a,t++%4)&&(n+=String.fromCharCode(255&o>>(-2*t&6))))a=w.indexOf(a);return n}var f=typeof window<"u"&&window.atob&&window.atob.bind(window)||_;function v(e){return decodeURIComponent(f(e).replace(/(.)/gu,(r,t)=>{let o=t.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o=`0${o}`),`%${o}`}))}function b(e){let r=e.replace(/-/gu,"+").replace(/_/gu,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return v(r)}catch{return f(r)}}function c(e){console.error(e)}c.prototype=new Error;c.prototype.name="InvalidTokenError";function y(e,r){if(typeof e!="string")throw new c("Invalid token specified: must be a string");r=r||{};const t=r.header===!0?0:1,o=e.split(".")[t];if(typeof o!="string")throw new c(`Invalid token specified: missing part #${t+1}`);let i;try{i=b(o)}catch(n){throw new c(`Invalid token specified: invalid base64 for part #${t+1} (${n.message})`)}try{return JSON.parse(i)}catch(n){throw new c(`Invalid token specified: invalid json for part #${t+1} (${n.message})`)}}function I(e){return y(e)}var S=e=>u({baseUrl:`https://cdn${k}.nomercy.tv`,timeout:e}),D=window.location.href.startsWith("file://")?"http://localhost:5173":window.location.origin,T="nomercy-ui";function j(){return new Promise((e,r)=>{const t=location.search.split("refreshToken=")?.[1]?.split("&")?.[0]??localStorage.getItem("refresh_token")??void 0;if(!t)throw new Error("No refresh token available");S().post(`${m}token`,{grant_type:"refresh_token",client_id:T,client_secret:"",refresh_token:t},{headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"}}).then(o=>($(o.data),e(o))).catch(o=>(console.error(o),p(),sessionStorage.clear(),localStorage.clear(),location.reload(),r(o)))})}function $(e){l({...d.value,refreshIn:new Date(Date.now()+e.expires_in*1e3).getTime(),accessToken:e.access_token,refreshToken:e.refresh_token,idToken:e.id_token,expiresIn:e.expires_in}),h("capacitor")&&(localStorage.setItem("access_token",e.access_token),localStorage.setItem("refresh_token",e.refresh_token),localStorage.setItem("id_token",e.id_token));try{const r=I(e.id_token);console.log("decodedToken",r),l({...d.value,name:r.display_name,email:r.email,id:r.sub,locale:r.locale})}catch(r){console.error(r)}}function p(){localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("id_token")}function A(){g.value?.logout(),p(),sessionStorage.clear(),localStorage.clear()}export{A as n,j as r,p as t};
