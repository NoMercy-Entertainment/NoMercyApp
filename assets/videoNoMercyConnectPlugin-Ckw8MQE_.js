var y=Object.defineProperty;var m=(r,l,t)=>l in r?y(r,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[l]=t;var a=(r,l,t)=>m(r,typeof l!="symbol"?l+"":l,t);import{aa as u,R as f,d as g,C as k}from"./vue-ionic-Ct1zWn9G.js";import{P as d}from"./video-player-DcJP85So.js";import{bF as p,bG as v,av as b,r as C}from"./index-BFqbVQ32.js";import{b as S}from"./buttons-DnucOQvv.js";class E extends d{constructor(){super(...arguments);a(this,"player",{});a(this,"route",{})}async initialize(t){this.player=t}use(){this.player.on("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.on("back",this.ended.bind(this)),this.player.on("ended",this.ended.bind(this)),this.player.on("finished",this.ended.bind(this)),this.route=u()}dispose(){this.player.off("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.off("back",this.ended.bind(this)),this.player.off("ended",this.ended.bind(this)),this.player.off("finished",this.ended.bind(this))}lastTimeTrigger(){var e;const t=this.episodeData(),i=p();(e=i==null?void 0:i.invoke)==null||e.call(i,"SetTime",t)}ended(){var i,e;const t=this.player.getCurrentTime()/this.player.getDuration()*100;if(this.player.isLastPlaylistItem()&&((i=this.player.playlistItem())==null?void 0:i.playlist_type)==="tv"&&t>=90){const s=p();s==null||s.invoke("RemoveWatched",this.episodeData()).then()}else if(this.player.isLastPlaylistItem()&&((e=this.player.playlistItem())==null?void 0:e.playlist_type)==="movie"&&t>=80){const s=p();s==null||s.invoke("RemoveWatched",this.episodeData()).then()}}episodeData(){var h;const t=this.player.playlistItem();let i=(h=this.route)==null?void 0:h.path;i||(i=window.location.hash.replace("#","")),i||(i=location.pathname);const e=i==null?void 0:i.split("/");let s,n,o=(t==null?void 0:t.tmdb_id)??e.at(-2);return e.at(-3)==="specials"?s=e.at(-2):e.at(-3)==="collection"&&(n=e.at(-2),o=t.id),{video_id:t==null?void 0:t.video_id,tmdb_id:o,playlist_type:e.at(-3),special_id:s,collection_id:n,video_type:t==null?void 0:t.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}}class B extends d{constructor(){super(...arguments);a(this,"player",{});a(this,"introPatterns",[/^OP$/iu,/^NCOP$/iu,/^Opening$/iu,/^Opening/iu,/^Opening Credits$/iu,/^Opening Theme$/iu,/^Opening Song$/iu,/^Epilogue$/iu]);a(this,"outroPatterns",[/^ED$/iu,/^PV$/iu,/^NCED$/iu,/^CM$/iu,/^Preview$/iu,/^Next Episode Preview$/iu,/^Next Time Preview$/iu,/^Outro$/iu,/^Ending/iu,/^Prologue$/iu,/^ED\+Cast$/iu,/^Credits$/iu,/^End Credits$/iu,/^Closing$/iu]);a(this,"buttons",{});a(this,"autoSkip",!1);a(this,"lastChapter","");a(this,"skipButtonElement",null)}initialize(t){this.player=t,!this.player.options.disableAutoPlayback&&(this.player.options.introPatterns&&(this.introPatterns=this.player.options.introPatterns),this.player.options.outroPatterns&&(this.outroPatterns=this.player.options.outroPatterns),this.player.options.autoSkip!==void 0?this.autoSkip=this.player.options.autoSkip:this.autoSkip=localStorage.getItem("nmplayer-auto-skip")==="true",this.buttons=S())}use(){this.player.options.disableAutoPlayback||this.player.on("time",this.checkChapters.bind(this))}dispose(){this.player.options.disableAutoPlayback||this.player.off("time",this.checkChapters.bind(this))}getChapterType(t){return this.introPatterns.some(i=>i.test(t))?"intro":this.outroPatterns.some(i=>i.test(t))?"next":null}checkChapters(){if(!this.player.chapters||!this.player.chapters.cues||this.player.chapters.cues.length===0){this.hideSkipButton();return}if(this.player.chapters.errors.length>0){console.error("Error parsing chapters:",this.player.chapters.errors),this.hideSkipButton();return}const t=this.player.getVideoElement().currentTime;let i=this.getCurrentChapter(t);if(!i){this.hideSkipButton();return}if(this.shouldSkipChapter(i.text)){if(this.lastChapter!==i.text){this.lastChapter=i.text;const e=this.getNextChapter(i.endTime);if(!e){this.player.next(),this.lastChapter="";return}this.autoSkip?(this.hideSkipButton(),this.player.seek(e.startTime)):this.showSkipButton()}}else this.hideSkipButton()}isFirstOrLastEpisodeOfSeason(){const t=this.player.playlistItem();if(t.episode===1)return!0;const i=this.player.getPlaylist().map(n=>f(n)),s=v(i,"season")[t.season];return s?s.at(-1)===t:!1}shouldSkipChapter(t){return this.player.getCurrentTime()<this.player.getDuration()/2&&this.player.getPlaylistIndex()===0||this.player.getCurrentTime()>this.player.getDuration()/2&&this.player.isLastPlaylistItem()||this.isFirstOrLastEpisodeOfSeason()?!1:this.introPatterns.some(i=>i.test(t))||this.outroPatterns.some(i=>i.test(t))}getCurrentChapter(t){return this.player.chapters.cues.find(i=>t>=i.startTime&&t<=i.endTime)}getNextChapter(t){return this.player.chapters.cues.find(i=>i.startTime>=t)}showSkipButton(){if(this.skipButtonElement){this.skipButtonElement.classList.add("visible");return}const t=this.player.createElement("button","skip-chapter-button").addClasses(["skip-chapter-button","flex","items-center","justify-center","gap-2","text-sm","text-white","bg-neutral-800","rounded","hover:bg-neutral-700","px-2","py-1","absolute","bottom-20","right-6","z-10","transition-opacity","duration-300","opacity-0","invisible"]).appendTo(this.player.overlay).get();let e=this.getChapterType(this.lastChapter)==="intro"?this.player.localize("Skip intro"):this.player.localize("Skip outro");t.title=e;const s=this.player.createElement("span","skip-chapter-text").addClasses(["hidden","md:inline"]).appendTo(t).get();s.textContent=e,this.player.createSVGElement(t,"chevronR",this.buttons.chevronR,!1,!1).classList.add("w-4","h-4"),t.addEventListener("click",this.player.nextChapter.bind(this.player)),this.skipButtonElement=t,requestAnimationFrame(()=>{t.classList.remove("opacity-0","invisible"),t.classList.add("opacity-100","visible")}),t.focus()}hideSkipButton(){this.skipButtonElement&&(this.skipButtonElement.classList.remove("opacity-100","visible"),this.skipButtonElement.classList.add("opacity-0","invisible"),setTimeout(()=>{this.skipButtonElement&&(this.skipButtonElement.remove(),this.skipButtonElement=null)},300))}}const c=g({});k(()=>c.value);function P(r){c.value=r}class V extends d{constructor(){super(...arguments);a(this,"player",{});a(this,"route",{});a(this,"playerState");a(this,"connectedDevices",[]);a(this,"currentVideoDeviceId",null);a(this,"currentList",null);a(this,"socket",null)}async initialize(t){this.player=t,this.socket=p()}use(){var t,i,e;this.player.on("ready",this.ready.bind(this)),this.player.on("dispose",this.handleDispose.bind(this)),this.route=u(),(t=this.socket)==null||t.on("VideoPlayerState",this.handleVideoPlayerState.bind(this)),(i=this.socket)==null||i.on("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),(e=this.socket)==null||e.on("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}dispose(){var t,i,e;this.player.off("ready",this.ready.bind(this)),this.player.off("dispose",this.handleDispose.bind(this)),(t=this.socket)==null||t.off("VideoPlayerState",this.handleVideoPlayerState.bind(this)),(i=this.socket)==null||i.off("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),(e=this.socket)==null||e.off("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}episodeData(){var h;const t=this.player.playlistItem();let i=(h=this.route)==null?void 0:h.path;i||(i=window.location.hash.replace("#","")),i||(i=location.pathname);const e=i==null?void 0:i.split("/");let s,n,o=(t==null?void 0:t.tmdb_id)??e.at(-2);return e.at(-3)==="specials"?s=e.at(-2):e.at(-3)==="collection"&&(n=e.at(-2),o=t.id??e.at(-2)),{video_id:t==null?void 0:t.video_id,tmdb_id:o,playlist_type:e.at(-3),special_id:s,collection_id:n,video_type:t==null?void 0:t.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}ready(){var i,e;const t=this.episodeData();(i=this.socket)==null||i.invoke("StartPlaybackCommand",t==null?void 0:t.playlist_type,t==null?void 0:t.tmdb_id,t==null?void 0:t.tmdb_id),(e=this.socket)==null||e.invoke("Devices").then(this.handleVideoConnectedDevicesState.bind(this))}handleDispose(){var t;(t=this.socket)==null||t.invoke("PlaybackCommand","stop",null)}handleVideoBroadcastStatus(t){if(t)for(const i of t.events){const e=i.deviceBroadcastStatus;this.currentVideoDeviceId=e.device_id,e.device_id===b.value?this.player.setMute(!1):this.player.setMute(!0)}}handleVideoPlayerState(t){if(t)for(const i of t.events){if(i.type!=="PlayerStateChanged")continue;const e=i.event.state;this.playerState=e,P(e),console.log(e),e.current_list&&C.replace(e.current_list).then();const s=(Date.now()-e.timestamp)/1e3/2,n=e.progress_ms>=1?(e.progress_ms+s)/1e3:e.progress_ms/1e3;this.currentVideoDeviceId=e.device_id,this.player.setVolume(e.volume_percentage),this.player.setMute(e.muted_state),this.setPlayState(e),this.player.once("seeked",()=>{this.setPlayState(e)}),this.player.on("item",()=>{this.setPlayState(e)}),this.setSeek(n),this.player.on("playlist",()=>{this.player.once("item",()=>{this.setSeek(n)}),this.setItemFromIndex(e)}),this.player.getPlaylist().length===0||this.currentList!=e.current_list?(this.currentList=e.current_list,this.player.setPlaylist(e.playlist)):this.setItemFromIndex(e),setTimeout(()=>{this.changeAudioTrack(e),this.changeCaptionTrack(e),this.changeQualityLevel(e)},150),this.player.on("audioTracks",()=>{this.changeAudioTrack(e)}),this.player.on("captionsList",()=>{this.changeCaptionTrack(e)}),this.player.on("levels",()=>{this.changeQualityLevel(e)})}}setSeek(t){t!==0&&Math.abs(this.player.getCurrentTime()-t)>.75&&this.player.seek(t)}setItemFromIndex(t){const i=t.playlist.findIndex(e=>e.video_id===t.item.video_id);i!==this.player.getPlaylistIndex()&&this.player.playVideo(i)}setPlayState(t){t.is_playing?this.player.play().then():this.player.pause()}changeQualityLevel(t){var i;if(((i=t.current_quality)==null?void 0:i.width)!=null){const e=this.player.getQualityLevels().findIndex(s=>s.width===t.current_quality.width);console.log("Quality index: ",e,t.current_quality),e!=null&&this.player.setCurrentQuality(e)}else this.player.setCurrentQuality(-1)}changeCaptionTrack(t){var i;if(((i=t.current_caption)==null?void 0:i.language)!=null){const e=this.player.getCaptionsList().findIndex(s=>s.language===t.current_caption.language&&s.type===t.current_caption.type&&s.ext===t.current_caption.codec);e!=null&&this.player.setCurrentCaption(e-1)}else this.player.setCurrentCaption(-1)}changeAudioTrack(t){var i;if(((i=t.current_audio)==null?void 0:i.language)!=null){const e=this.player.getAudioTracks().findIndex(s=>{var n;return s.language===((n=t.current_audio)==null?void 0:n.language)});e!=null&&this.player.setCurrentAudioTrack(e)}else this.player.setCurrentAudioTrack(-1)}handleVideoConnectedDevicesState(t){this.connectedDevices=t}}export{B as A,E as S,V};
