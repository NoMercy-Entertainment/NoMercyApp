var u=Object.defineProperty;var y=(a,s,e)=>s in a?u(a,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[s]=e;var o=(a,s,e)=>(y(a,typeof s!="symbol"?s+"":s,e),e);import{P as p,S as c}from"./subtitles-octopus-C7T3ERAH.js";import{en as d,bz as g,eo as f}from"./index-D3Ykw4sr.js";class $ extends p{constructor(){super(...arguments);o(this,"player",{})}initialize(e){this.player=e}use(){this.player.on("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.on("back",this.ended.bind(this)),this.player.on("ended",this.ended.bind(this)),this.player.on("finished",this.ended.bind(this))}dispose(){this.player.off("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.off("back",this.ended.bind(this)),this.player.off("ended",this.ended.bind(this)),this.player.off("finished",this.ended.bind(this))}lastTimeTrigger(){var i;console.log("lastTimeTrigger");const e=this.episodeData(),t=d();(i=t==null?void 0:t.invoke)==null||i.call(t,"SetTime",e)}ended(){if(this.player.isLastPlaylistItem()){const e=d();e==null||e.invoke("RemoveWatched",this.episodeData())}this.dispose(),this.player.dispose()}episodeData(){const e=this.player.playlistItem(),t=location.hash.split("/");let i,r;return t.at(-3)==="specials"?i=t.at(-2):t.at(-3)==="collection"&&(r=t.at(-2)),{video_id:e==null?void 0:e.video_id,tmdb_id:e==null?void 0:e.tmdb_id,playlist_type:t.at(-3),special_id:i,collection_id:r,video_type:e==null?void 0:e.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}}class T extends p{constructor(){super(...arguments);o(this,"player",{});o(this,"chapterSkipPatterns",[/^OP$/ui,/^ED$/ui,/^PV$/ui,/^NCOP$/ui,/^NCED$/ui,/^CM$/ui,/^Preview$/ui,/^Next Episode Preview$/ui,/^Next Time Preview$/ui,/^Outro$/ui,/^Opening$/ui,/^Ending$/ui,/^Opening Credits$/ui,/^Ending Credits$/ui,/^Opening Theme$/ui,/^Ending Theme$/ui,/^Opening Song$/ui,/^Ending Song$/ui,/^Prologue$/ui,/^Epilogue$/ui,/^ED+Cast$/ui,/^Avant$/ui,/^Yokoku$/ui]);o(this,"lastChapter","")}initialize(e){this.player=e,this.player.options.chapterSkipPatterns&&(this.chapterSkipPatterns=this.player.options.chapterSkipPatterns)}use(){this.player.on("time",this.checkChapters.bind(this))}dispose(){this.player.off("time",this.checkChapters.bind(this))}checkChapters(){if(!this.player.chapters||!this.player.chapters.cues||this.player.chapters.cues.length===0)return;if(this.player.chapters.errors.length>0){console.error("Error parsing chapters:",this.player.chapters.errors);return}const e=this.player.getVideoElement().currentTime;let t=this.getCurrentChapter(e);if(t)for(;this.lastChapter!=t.text&&this.shouldSkipChapter(t.text);){this.lastChapter=t.text;const i=this.getNextChapter(t.endTime);if(!i){this.player.next(),this.lastChapter="";return}t=i,this.player.seek(t.startTime)}}isFirstOrLastEpisodeOfSeason(){const e=this.player.playlistItem();if(e.episode==1)return!0;const t=this.player.getPlaylist().map(l=>g(l)),r=f(t,"season")[e.season];return r?r.at(-1)==e:!1}shouldSkipChapter(e){return this.player.getCurrentTime()<this.player.getDuration()/2&&this.player.getPlaylistIndex()==0||this.player.getCurrentTime()>this.player.getDuration()/2&&this.player.isLastPlaylistItem()||this.isFirstOrLastEpisodeOfSeason()?!1:this.chapterSkipPatterns.some(t=>t.test(e))}getCurrentChapter(e){return this.player.chapters.cues.find(t=>e>=t.startTime&&e<=t.endTime)}getNextChapter(e){return this.player.chapters.cues.find(t=>t.startTime>=e)}}class P extends p{initialize(s){this.player=s}use(){this.player.on("captionsChanged",this.opus.bind(this))}dispose(){this.player.off("captionsChanged",this.opus.bind(this)),this.destroy()}destroy(){var s;(s=this.player.octopusInstance)==null||s.dispose(),this.player.octopusInstance=null}async opus(){var i,r;this.destroy();const s=this.player.getSubtitleFile()?`${this.player.options.basePath??""}${this.player.getSubtitleFile()}`:null;if(!s)return;const e=(i=s==null?void 0:s.match(/\w+\.\w+\.\w+$/u))==null?void 0:i[0];let[,,t]=e?e.split("."):[];if(t||(t=s.split(".").at(-1)||""),!(t!="ass"&&t!="ssa")&&s){await this.player.fetchFontFile();const l=(r=this.player.fonts)==null?void 0:r.map(n=>`${this.player.options.basePath??""}${n.file}`);this.player.getElement().querySelectorAll(".libassjs-canvas-parent").forEach(n=>n.remove());const h={video:this.player.getVideoElement(),subUrl:s,fonts:l,lossyRender:this.player.options.lossyRender,accessToken:this.player.options.accessToken,targetFps:this.player.options.targetFps,debug:this.player.options.debug,blendRender:this.player.options.blendRender,lazyFileLoading:this.player.options.lazyFileLoading,renderAhead:this.player.options.renderAhead,workerUrl:"/js/octopus/subtitles-octopus-worker.js",legacyWorkerUrl:"/js/octopus/subtitles-octopus-worker-legacy.js",fallbackFont:"/js/octopus/default.ttf",onReady:async()=>{},onError:n=>{console.error("opus error",n)}};console.log(h),s&&s.includes(".ass")&&(this.player.octopusInstance=new c(h))}}}export{T as A,P as O,$ as S};
//# sourceMappingURL=octopusPlugin-CkIk8wt0.js.map
