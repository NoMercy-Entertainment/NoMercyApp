{"version":3,"file":"octopusPlugin-BNhipimT.js","sources":["../../src/lib/VideoPlayer/plugins/syncPlugin.ts","../../src/lib/VideoPlayer/plugins/autoSkipPlugin.ts","../../node_modules/@nomercy-entertainment/nomercy-video-player/src/plugins/octopusPlugin.ts"],"sourcesContent":["import Plugin from '@nomercy-entertainment/nomercy-video-player/src/plugin';\nimport type {NMPlayer, PlaylistItem} from \"@nomercy-entertainment/nomercy-video-player/src/types\";\n\nimport {useSocket} from \"@/store/socket\";\n\nexport interface SyncPluginArgs {\n\tbasePath: string;\n\taccessToken: string,\n}\n\nexport class SyncPlugin extends Plugin {\n\tplayer: NMPlayer<SyncPluginArgs> = <NMPlayer<SyncPluginArgs>>{};\n\n\tasync initialize(player: NMPlayer<SyncPluginArgs>) {\n\t\tthis.player = player;\n\t}\n\n\tuse() {\n\t\tthis.player.on('lastTimeTrigger', this.lastTimeTrigger.bind(this));\n\n\t\tthis.player.on('back', this.ended.bind(this));\n\t\tthis.player.on('ended', this.ended.bind(this));\n\t\tthis.player.on('finished', this.ended.bind(this));\n\t}\n\n\tdispose() {\n\t\tthis.player.off('lastTimeTrigger', this.lastTimeTrigger.bind(this));\n\n\t\tthis.player.off('back', this.ended.bind(this));\n\t\tthis.player.off('ended', this.ended.bind(this));\n\t\tthis.player.off('finished', this.ended.bind(this));\n\t}\n\n\tlastTimeTrigger(){\n\t\tconsole.log('lastTimeTrigger');\n\t\tconst data = this.episodeData();\n\n\t\tconst socket = useSocket();\n\t\tsocket?.invoke?.('SetTime', data);\n\t}\n\n\tended(){\n\t\tif (this.player.isLastPlaylistItem()) {\n\t\t\tconst socket = useSocket();\n\t\t\tsocket?.invoke('RemoveWatched', this.episodeData());\n\t\t}\n\n\t\tthis.dispose();\n\t\tthis.player.dispose();\n\t}\n\n\tepisodeData() {\n\t\tconst current = this.player.playlistItem() as  PlaylistItem & {\n\t\t\ttmdb_id: number,\n\t\t\tspecial_id: number,\n\t\t\tvideo_type: string,\n\t\t\tvideo_id: number;\n\t\t};\n\n\t\tconst route = location.hash.split('/');\n\n\t\tlet specialId: string|undefined;\n\t\tlet collectionId: number|undefined;\n\t\tif (route.at(-3) === 'specials') {\n\t\t\tspecialId = route.at(-2) as string;\n\t\t} else if (route.at(-3) === 'collection') {\n\t\t\tcollectionId = route.at(-2) as unknown as number;\n\t\t}\n\n\t\treturn {\n\t\t\tvideo_id: current?.video_id,\n\t\t\ttmdb_id: current?.tmdb_id,\n\t\t\tplaylist_type: route.at(-3),\n\t\t\tspecial_id: specialId,\n\t\t\tcollection_id: collectionId,\n\t\t\tvideo_type: current?.video_type,\n\t\t\t// @ts-ignore\n\t\t\ttime: Math.floor(this.player.getCurrentTime() || 0),\n\t\t};\n\t}\n}\n","import {toRaw} from \"vue\";\n\nimport Plugin from '@nomercy-entertainment/nomercy-video-player/src/plugin';\nimport {NMPlayer} from '@nomercy-entertainment/nomercy-video-player/src/types';\n\nimport {groupBy} from '@/lib/stringArray';\n\nexport interface AutoSkipPluginArgs {\n}\n\nexport class AutoSkipPlugin extends Plugin {\n\tplayer: NMPlayer<AutoSkipPluginArgs> = <NMPlayer<AutoSkipPluginArgs>>{};\n\n\tchapterSkipPatterns: RegExp[] = [\n\t\t/^OP$/ui,\n\t\t/^ED$/ui,\n\t\t/^PV$/ui,\n\t\t/^NCOP$/ui,\n\t\t/^NCED$/ui,\n\t\t/^CM$/ui,\n\t\t/^Preview$/ui,\n\t\t/^Next Episode Preview$/ui,\n\t\t/^Next Time Preview$/ui,\n\t\t// /^Intro$/ui,\n\t\t/^Outro$/ui,\n\t\t/^Opening$/ui,\n\t\t/^Ending$/ui,\n\t\t/^Opening Credits$/ui,\n\t\t/^Ending Credits$/ui,\n\t\t/^Opening Theme$/ui,\n\t\t/^Ending Theme$/ui,\n\t\t/^Opening Song$/ui,\n\t\t/^Ending Song$/ui,\n\t\t/^Prologue$/ui,\n\t\t/^Epilogue$/ui,\n\t\t/^ED+Cast$/ui,\n\n\t\t/^Avant$/ui,\n\t\t/^Yokoku$/ui,\n\t];\n\n\tinitialize(player: NMPlayer<AutoSkipPluginArgs>) {\n\t\tthis.player = player;\n\n\t\tif (this.player.options.chapterSkipPatterns) {\n\t\t\tthis.chapterSkipPatterns = this.player.options.chapterSkipPatterns;\n\t\t}\n\t}\n\n\tuse() {\n\t\tthis.player.on('time', this.checkChapters.bind(this));\n\t}\n\n\tdispose() {\n\t\tthis.player.off('time', this.checkChapters.bind(this));\n\t}\n\n\tlastChapter: string = '';\n\n\tcheckChapters(): void {\n\t\tif (!this.player.chapters || !this.player.chapters.cues || this.player.chapters.cues.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tif (this.player.chapters.errors.length > 0) {\n\t\t\tconsole.error('Error parsing chapters:', this.player.chapters.errors);\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentTime = this.player.getVideoElement().currentTime;\n\t\tlet currentChapter = this.getCurrentChapter(currentTime);\n\t\tif (!currentChapter) return;\n\n\t\twhile (this.lastChapter != currentChapter.text && this.shouldSkipChapter(currentChapter.text)) {\n\t\t\tthis.lastChapter = currentChapter.text;\n\t\t\tconst nextChapter = this.getNextChapter(currentChapter.endTime);\n\t\t\tif (!nextChapter) {\n\t\t\t\tthis.player.next();\n\t\t\t\tthis.lastChapter = '';\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcurrentChapter = nextChapter;\n\t\t\tthis.player.seek(currentChapter.startTime);\n\t\t}\n\t}\n\n\tisFirstOrLastEpisodeOfSeason(): boolean {\n\t\tconst playlistItem = this.player.playlistItem();\n\t\tif (playlistItem.episode == 1) return true;\n\n\t\tconst playlist = this.player.getPlaylist().map((item) => toRaw(item as any));\n\n\t\tconst seasons = groupBy(playlist, 'season');\n\t\tconst season = seasons[playlistItem.season as number];\n\n\t\tif (!season) return false;\n\n\t\treturn season.at(-1) == playlistItem;\n\t}\n\n\tshouldSkipChapter(chapterTitle: string): boolean {\n\t\tif (this.player.getCurrentTime() < this.player.getDuration() / 2 && this.player.getPlaylistIndex() == 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (this.player.getCurrentTime() > this.player.getDuration() / 2 && this.player.isLastPlaylistItem()) {\n\t\t\treturn false;\n\t\t}\n\t\tif (this.isFirstOrLastEpisodeOfSeason()) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.chapterSkipPatterns.some(pattern => pattern.test(chapterTitle));\n\t}\n\n\tgetCurrentChapter(currentTime: number) {\n\t\treturn this.player.chapters.cues.find((chapter) => currentTime >= chapter.startTime && currentTime <= chapter.endTime);\n\t}\n\n\tgetNextChapter(currentEndTime: number) {\n\t\treturn this.player.chapters.cues.find((chapter) => chapter.startTime >= currentEndTime);\n\t}\n}\n","// @ts-nocheck\nimport SubtitlesOctopus from '../../public/js/octopus/subtitles-octopus';\n\nimport Plugin from '../plugin';\nimport type { NMPlayer } from '../types';\n\nexport interface OctopusPluginArgs {\n\taccessToken: string;\n\tdebug: boolean;\n\ttargetFps: number,\n\tblendRender: boolean,\n\tlazyFileLoading: boolean,\n\trenderAhead: boolean,\n}\n\nexport class OctopusPlugin extends Plugin {\n\tplayer: NMPlayer<OctopusPluginArgs>;\n\n\tinitialize(player: NMPlayer<OctopusPluginArgs>): void {\n\t\tthis.player = player;\n\t\t// Initialize the plugin with the player\n\t}\n\n\tuse(): void {\n\t\t// this.player.on('item', this.destroy.bind(this));\n\t\tthis.player.on('captionsChanged', this.opus.bind(this));\n\t}\n\n\tdispose(): void {\n\t\t// this.player.off('item', this.destroy.bind(this));\n\t\tthis.player.off('captionsChanged', this.opus.bind(this));\n\n\t\tthis.destroy();\n\t}\n\n\tdestroy(): void {\n\t\tthis.player.octopusInstance?.dispose();\n\t\tthis.player.octopusInstance = null;\n\t}\n\n\tasync opus(): Promise<void> {\n\t\tthis.destroy();\n\n\t\tconst subtitleURL = this.player.getSubtitleFile() ? `${this.player.options.basePath ?? ''}${this.player.getSubtitleFile()}` : null;\n\t\tif (!subtitleURL) return;\n\n\t\tconst tag = subtitleURL?.match(/\\w+\\.\\w+\\.\\w+$/u)?.[0];\n\t\tlet [,, ext] = tag ? tag.split('.') : [];\n\t\tif (!ext) {\n\t\t\tconst parts = subtitleURL.split('.');\n\t\t\text = parts.at(-1) || '';\n\t\t}\n\n\t\tif (ext != 'ass' && ext != 'ssa') return;\n\n\t\tif (subtitleURL) {\n\t\t\tawait this.player.fetchFontFile();\n\n\t\t\tconst fontFiles: string[] = this.player.fonts\n\t\t\t\t?.map((f: any) => `${this.player.options.basePath ?? ''}${f.file}`);\n\n\t\t\t(this.player.getElement()\n\t\t\t\t.querySelectorAll('.libassjs-canvas-parent') as NodeListOf<HTMLDivElement>)\n\t\t\t\t.forEach(el => el.remove());\n\n\t\t\tconst options = {\n\t\t\t\tvideo: this.player.getVideoElement(),\n\t\t\t\tsubUrl: subtitleURL,\n\t\t\t\tfonts: fontFiles,\n\t\t\t\tlossyRender: this.player.options.lossyRender,\n\t\t\t\taccessToken: this.player.options.accessToken,\n\t\t\t\ttargetFps: this.player.options.targetFps,\n\t\t\t\tdebug: this.player.options.debug,\n\t\t\t\tblendRender: this.player.options.blendRender,\n\t\t\t\tlazyFileLoading: this.player.options.lazyFileLoading,\n\t\t\t\trenderAhead: this.player.options.renderAhead,\n\t\t\t\tworkerUrl: '/js/octopus/subtitles-octopus-worker.js',\n\t\t\t\tlegacyWorkerUrl: '/js/octopus/subtitles-octopus-worker-legacy.js',\n\t\t\t\tfallbackFont: '/js/octopus/default.ttf',\n\t\t\t\tonReady: async () => {\n\t\t\t\t\t// this.player.play();\n\t\t\t\t},\n\t\t\t\tonError: (event: any) => {\n\t\t\t\t\tconsole.error('opus error', event);\n\t\t\t\t},\n\t\t\t};\n\n\t\t\tconsole.log(options);\n\n\t\t\tif (subtitleURL && subtitleURL.includes('.ass')) {\n\t\t\t\tthis.player.octopusInstance = new SubtitlesOctopus(options);\n\t\t\t}\n\t\t}\n\t};\n}\n\nexport default OctopusPlugin;\n"],"names":["SyncPlugin","Plugin","__publicField","player","data","socket","useSocket","_a","current","route","specialId","collectionId","AutoSkipPlugin","currentTime","currentChapter","nextChapter","playlistItem","playlist","item","toRaw","season","groupBy","chapterTitle","pattern","chapter","currentEndTime","OctopusPlugin","subtitleURL","tag","ext","fontFiles","_b","f","el","options","event","SubtitlesOctopus"],"mappings":"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","x_google_ignoreList":[2]}