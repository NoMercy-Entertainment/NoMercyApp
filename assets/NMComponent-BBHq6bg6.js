import{An as k,Bt as x,Dn as I,En as D,Fn as N,Gt as U,I as K,Ln as f,Lt as B,M as w,Mt as F,Nn as Q,On as T,Tt as C,Vt as O,_ as j,an as A,cn as _,en as P,jn as $,mn as V,on as z,qt as G,un as H,yn as c,zt as J}from"./index-BVMfOxho.js";import{t as W}from"./currentServer-wKQllb71.js";import{d as S}from"./core-DZundPdS.js";import{t as E}from"./serverClient-DP8QK8AC.js";import{T as X,t as Y}from"./router-CwEKSEy2.js";import{N as Z,O as tt,_ as q,k as et,p as st,r as at,t as nt}from"./utils-CgFfn36P.js";import{rt as it,tt as b}from"./SocketClient-Ci81BRq-.js";import{t as rt}from"./useQueryClient-B99C1vuk.js";import{t as ot}from"./useQuery-AxjyXFw9.js";import{t as ut}from"./useMutationState-0LdbJHFD.js";var lt=class extends Z{#s;#a=void 0;#t;#e;constructor(t,e){super(),this.#s=t,this.setOptions(e),this.bindMethods(),this.#n()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){const e=this.options;this.options=this.#s.defaultMutationOptions(t),tt(this.options,e)||this.#s.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#t,observer:this}),e?.mutationKey&&this.options.mutationKey&&q(e.mutationKey)!==q(this.options.mutationKey)?this.reset():this.#t?.state.status==="pending"&&this.#t.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#t?.removeObserver(this)}onMutationUpdate(t){this.#n(),this.#i(t)}getCurrentResult(){return this.#a}reset(){this.#t?.removeObserver(this),this.#t=void 0,this.#n(),this.#i()}mutate(t,e){return this.#e=e,this.#t?.removeObserver(this),this.#t=this.#s.getMutationCache().build(this.#s,this.options),this.#t.addObserver(this),this.#t.execute(t)}#n(){const t=this.#t?.state??it();this.#a={...t,isPending:t.status==="pending",isSuccess:t.status==="success",isError:t.status==="error",isIdle:t.status==="idle",mutate:this.mutate,reset:this.reset}}#i(t){st.batch(()=>{if(this.#e&&this.hasListeners()){const e=this.#a.variables,a=this.#a.context;t?.type==="success"?(this.#e.onSuccess?.(t.data,e,a),this.#e.onSettled?.(t.data,null,e,a)):t?.type==="error"&&(this.#e.onError?.(t.error,e,a),this.#e.onSettled?.(void 0,t.error,e,a))}this.listeners.forEach(e=>{e(this.#a)})})}};function ct(t,e){const a=e||rt(),n=B(()=>a.defaultMutationOptions(nt(t))),r=new lt(a,n.value),s=n.value.shallow?k(r.getCurrentResult()):I(r.getCurrentResult()),p=r.subscribe(o=>{at(s,o)}),u=(o,y)=>{r.mutate(o,y).catch(()=>{})};c(n,()=>{r.setOptions(n.value)}),D(()=>{p()});const m=n.value.shallow?$(s):T(s),l=N(m);return c(()=>s.error,o=>{if(o&&et(n.value.throwOnError,[o]))throw o}),{...l,mutate:u,mutateAsync:s.mutate,reset:s.reset}}w();C();function v(t){const e=K(),a=[];return(t??e?.path)?.split("/").slice(1).forEach(n=>{n.includes("?")?(a.push(n.split("?")[0]),a.push(n.split("?")[1].split("=")[1])):a.push(n)}),a}function ht({queryKey:t,path:e}={queryKey:void 0,path:void 0}){return ut({mutationKey:t??v(e)})}var dt=S();c(dt,async t=>{t&&(await b.invalidateQueries(),b.getMutationCache().clear())});c(W,async(t,e)=>{if(!t){X();return}e?.id&&t.id!==e.id&&(await b.invalidateQueries(),b.getMutationCache().clear())});function pt({queryKey:t,path:e}={queryKey:void 0,path:void 0}){return ot({queryKey:t??v(e),queryFn:async()=>E().get(e??Y.currentRoute.value.path,{params:{}}).then(({data:a})=>a.data)})}function mt({queryKey:t,path:e,homeData:a}){return ct({mutationKey:t??v(e),mutationFn:async n=>{const r=[...a.value?.map(s=>structuredClone(Q(s)))??[]];for(const s of n)await E().post(e??s.update.link,{replace_id:s.update.body.replace_id}).then(p=>{for(let u=0;u<r.length;u++)r[u].id===s.update?.body?.replace_id&&(r[u]=p.data?.data[0])});return r}})}C();w();var ft={key:0,class:"grid w-available h-available place-items-center"},vt=G({__name:"NMComponent",props:{path:{type:String,required:!1,default:void 0},options:{type:Object,required:!1,default:()=>({keepForever:!0,queryKey:v()})}},setup(t){const e=t,a=new Set(["Home","Libraries","Music Start"]),n=e.options.queryKey??v(),r=ht({queryKey:n,path:e.path}),{data:s,isLoading:p}=pt({queryKey:n,path:e.path}),{data:u,mutate:m}=mt({queryKey:n,homeData:s}),l=S(),o=K();function y(){if(!s.value||!l.value)return;const i=s.value.filter(h=>h?.update?.when==="pageLoad")??[];i.length>0&&m(i)}function L(){if(!s.value||!l.value)return;const i=s.value.filter(h=>h?.update?.when==="online")??[];i.length>0&&m(i)}function M(i){const h=i;if(!s.value||!l.value)return;const d=s.value.filter(g=>g?.id===h.detail.id)??[];d.length>0&&m(d)}function R(){return a.has(o.name)}return A(()=>{document.addEventListener("mutateId",M),s.value&&l.value&&R()&&y()}),z(()=>{document.removeEventListener("mutateId",M)}),c(l,i=>{i&&L()}),c(s,i=>{i&&requestIdleCallback(()=>{document.dispatchEvent(new Event("indexer"))})}),c(()=>o.name,i=>{s.value&&l.value&&a.has(i)&&y()}),(i,h)=>f(p)?(_(),O("div",ft,[U(f(j),{class:"ion-padding",name:"crescent"})])):f(r)?x("",!0):(_(!0),O(F,{key:1},H(f(u)??f(s)??[],(d,g)=>(_(),J(V(d?.component),P({key:d.id,index:g},{ref_for:!0},d.props),null,16,["index"]))),128))}}),St=vt;export{St as t};
