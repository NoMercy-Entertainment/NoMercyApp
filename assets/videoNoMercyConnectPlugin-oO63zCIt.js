var u=Object.defineProperty;var f=(n,o,e)=>o in n?u(n,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[o]=e;var l=(n,o,e)=>f(n,typeof o!="symbol"?o+"":o,e);import{aa as c,d as m,C as g}from"./vue-ionic-DerxjBh9.js";import{P as p}from"./video-player-DmVd3h04.js";import{bG as h,av as v,r as _}from"./index-VvjVXp0-.js";class T extends p{constructor(){super(...arguments);l(this,"player",{});l(this,"route",{})}async initialize(e){this.player=e}use(){this.player.on("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.on("back",this.ended.bind(this)),this.player.on("ended",this.ended.bind(this)),this.player.on("finished",this.ended.bind(this)),this.route=c()}dispose(){this.player.off("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.off("back",this.ended.bind(this)),this.player.off("ended",this.ended.bind(this)),this.player.off("finished",this.ended.bind(this))}lastTimeTrigger(){var t;const e=this.episodeData(),i=h();(t=i==null?void 0:i.invoke)==null||t.call(i,"SetTime",e)}ended(){var i,t;const e=this.player.getCurrentTime()/this.player.getDuration()*100;if(this.player.isLastPlaylistItem()&&((i=this.player.playlistItem())==null?void 0:i.playlist_type)==="tv"&&e>=90){const s=h();s==null||s.invoke("RemoveWatched",this.episodeData()).then()}else if(this.player.isLastPlaylistItem()&&((t=this.player.playlistItem())==null?void 0:t.playlist_type)==="movie"&&e>=80){const s=h();s==null||s.invoke("RemoveWatched",this.episodeData()).then()}}episodeData(){var r;const e=this.player.playlistItem();let i=(r=this.route)==null?void 0:r.path;i||(i=window.location.hash.replace("#","")),i||(i=location.pathname);const t=i==null?void 0:i.split("/");let s,a,d=(e==null?void 0:e.tmdb_id)??t.at(-2);return t.at(-3)==="specials"?s=t.at(-2):t.at(-3)==="collection"&&(a=t.at(-2),d=e.id),{video_id:e==null?void 0:e.video_id,tmdb_id:d,playlist_type:t.at(-3),special_id:s,collection_id:a,video_type:e==null?void 0:e.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}}const y=m({});g(()=>y.value);function b(n){y.value=n}class P extends p{constructor(){super(...arguments);l(this,"player",{});l(this,"route",{});l(this,"playerState");l(this,"connectedDevices",[]);l(this,"currentVideoDeviceId",null);l(this,"currentList",null);l(this,"socket",null)}async initialize(e){this.player=e,this.socket=h()}use(){var e,i,t;this.player.on("ready",this.ready.bind(this)),this.player.on("dispose",this.handleDispose.bind(this)),this.route=c(),(e=this.socket)==null||e.on("VideoPlayerState",this.handleVideoPlayerState.bind(this)),(i=this.socket)==null||i.on("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),(t=this.socket)==null||t.on("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}dispose(){var e,i,t;this.player.off("ready",this.ready.bind(this)),this.player.off("dispose",this.handleDispose.bind(this)),(e=this.socket)==null||e.off("VideoPlayerState",this.handleVideoPlayerState.bind(this)),(i=this.socket)==null||i.off("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),(t=this.socket)==null||t.off("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}episodeData(){var r;const e=this.player.playlistItem();let i=(r=this.route)==null?void 0:r.path;i||(i=window.location.hash.replace("#","")),i||(i=location.pathname);const t=i==null?void 0:i.split("/");let s,a,d=(e==null?void 0:e.tmdb_id)??t.at(-2);return t.at(-3)==="specials"?s=t.at(-2):t.at(-3)==="collection"&&(a=t.at(-2),d=e.id??t.at(-2)),{video_id:e==null?void 0:e.video_id,tmdb_id:d,playlist_type:t.at(-3),special_id:s,collection_id:a,video_type:e==null?void 0:e.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}ready(){var i,t;const e=this.episodeData();(i=this.socket)==null||i.invoke("StartPlaybackCommand",e==null?void 0:e.playlist_type,e==null?void 0:e.tmdb_id,e==null?void 0:e.tmdb_id),(t=this.socket)==null||t.invoke("Devices").then(this.handleVideoConnectedDevicesState.bind(this))}handleDispose(){var e;(e=this.socket)==null||e.invoke("PlaybackCommand","stop",null)}handleVideoBroadcastStatus(e){if(e)for(const i of e.events){const t=i.deviceBroadcastStatus;this.currentVideoDeviceId=t.device_id,t.device_id===v.value?this.player.setMute(!1):this.player.setMute(!0)}}handleVideoPlayerState(e){if(e)for(const i of e.events){if(i.type!=="PlayerStateChanged")continue;const t=i.event.state;this.playerState=t,b(t),console.log(t),t.current_list&&_.replace(t.current_list).then();const s=(Date.now()-t.timestamp)/1e3/2,a=t.progress_ms>=1?(t.progress_ms+s)/1e3:t.progress_ms/1e3;this.currentVideoDeviceId=t.device_id,this.player.setVolume(t.volume_percentage),this.player.setMute(t.muted_state),this.setPlayState(t),this.player.once("seeked",()=>{this.setPlayState(t)}),this.player.on("item",()=>{this.setPlayState(t)}),this.setSeek(a),this.player.on("playlist",()=>{this.player.once("item",()=>{this.setSeek(a)}),this.setItemFromIndex(t)}),this.player.getPlaylist().length===0||this.currentList!=t.current_list?(this.currentList=t.current_list,this.player.setPlaylist(t.playlist)):this.setItemFromIndex(t),setTimeout(()=>{this.changeAudioTrack(t),this.changeCaptionTrack(t),this.changeQualityLevel(t)},150),this.player.on("audioTracks",()=>{this.changeAudioTrack(t)}),this.player.on("captionsList",()=>{this.changeCaptionTrack(t)}),this.player.on("levels",()=>{this.changeQualityLevel(t)})}}setSeek(e){e!==0&&Math.abs(this.player.getCurrentTime()-e)>.75&&this.player.seek(e)}setItemFromIndex(e){const i=e.playlist.findIndex(t=>t.video_id===e.item.video_id);i!==this.player.getPlaylistIndex()&&this.player.playVideo(i)}setPlayState(e){e.is_playing?this.player.play().then():this.player.pause()}changeQualityLevel(e){var i;if(((i=e.current_quality)==null?void 0:i.width)!=null){const t=this.player.getQualityLevels().findIndex(s=>s.width===e.current_quality.width);t!=null&&this.player.setCurrentQuality(t)}else this.player.setCurrentQuality(-1)}changeCaptionTrack(e){var i;if(((i=e.current_caption)==null?void 0:i.language)!=null){const t=this.player.getCaptionsList().findIndex(s=>s.language===e.current_caption.language&&s.type===e.current_caption.type&&s.ext===e.current_caption.codec);t!=null&&this.player.setCurrentCaption(t-1)}else this.player.setCurrentCaption(-1)}changeAudioTrack(e){var i;if(((i=e.current_audio)==null?void 0:i.language)!=null){const t=this.player.getAudioTracks().findIndex(s=>{var a;return s.language===((a=e.current_audio)==null?void 0:a.language)});t!=null&&this.player.setCurrentAudioTrack(t)}else this.player.setCurrentAudioTrack(-1)}handleVideoConnectedDevicesState(e){this.connectedDevices=e}}export{T as S,P as V};
