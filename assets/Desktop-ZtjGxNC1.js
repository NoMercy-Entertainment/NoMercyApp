import{C as L,Et as K,J as c,O as ee,Ot as Y,Q as te,S as i,T as h,Tt as u,X as J,c as F,ct as se,g as Z,gt as I,h as ae,j as q,k as oe,kt as y,w as M}from"./i18n-Cs-AFcrY.js";import"./ionic-XwZpO7IE.js";import"./vue-core-CKeWI2Kt.js";import"./query-28IwY2wK.js";import{Ea as N,Qi as z,Zi as re,_i as X,ki as ie}from"./index-CpapolHX.js";import"./useInfiniteServerClient-CzMUf_PK.js";import"./useServerClient-1EesMW3F.js";import"./ScrollContainer-NuTTzR7r.js";import"./useMounted-18HlRU8K.js";import"./RipperOverlay-d-TYVwF-.js";import"./ripperSocket-DvqsFU_1.js";import"./FloatingBackButton-DfxyIRfC.js";import{t as ne}from"./DashboardLayout-n634qIFw.js";F();function le(){const $=I(!1),g=I(0),v=I(0),a=I(0),_=I(0),r=I([]),m=I(!1);let f=null;function E(){v.value=r.value.filter(o=>o.status==="completed").length}function S(){m.value||(f?.postMessage({controls:{type:"pause"}}),r.value.forEach(o=>{o.status!=="completed"&&(o.status="paused",o.children.forEach(s=>{s.status!=="completed"&&(s.status="paused")}))}),m.value=!0)}function B(){if(m.value){const o=r.value.filter(s=>s.status==="paused");o.length>0&&(o[0].status="pending",o[0].children.forEach(s=>{s.status==="paused"&&(s.status="pending")}),o.slice(1).forEach(s=>{s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})}),f?.postMessage({controls:{type:"resume",pausedIds:o.map(s=>s.id)}})),m.value=!1}}function Q(o){const s=r.value.find(e=>e.id===o);s&&(s.status==="downloading"||s.status==="pending"||s.status==="waiting")&&(f?.postMessage({controls:{type:"pauseItem",itemId:o}}),s.status="paused",s.children.forEach(e=>{(e.status==="downloading"||e.status==="pending"||e.status==="waiting")&&(e.status="paused")}),r.value.every(e=>e.status==="completed"||e.status==="paused")&&(m.value=!0))}function D(o){const s=r.value.find(e=>e.id===o);s&&s.status==="paused"&&(f?.postMessage({controls:{type:"resumeItem",itemId:o}}),r.value.find(e=>e.status==="downloading"||e.status==="pending")?(s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})):(s.status="pending",s.children.forEach(e=>{e.status==="paused"&&(e.status="pending")})),r.value.some(e=>e.status==="downloading"||e.status==="pending")&&(m.value=!1))}function U(o){f?.postMessage({controls:{action:"prioritize",itemId:o}})}async function W(o,s){$.value=!0;try{const{data:e}=await re().get(`/${s}/watch`),j=e.filter(t=>!!t?.file).map(t=>t.video_id),R=r.value.map(t=>t.id),V=j.some(t=>!R.includes(t))||R.some(t=>!j.includes(t));V?(g.value=0,v.value=0,r.value=[]):r.value=r.value.filter(t=>t.status==="completed"),r.value=await Promise.all(e.filter(t=>!!t?.file).map(async(t,k)=>{const n=t.tracks?.some(d=>d.kind==="subtitles"&&d.file),w=t.tracks?.some(d=>d.kind==="fonts"&&d.file),l=t.tracks?.some(d=>["thumbnails","sprite"].includes(d.kind)&&d.file);let C=!1;if(t.file.endsWith(".m3u8"))try{C=(await(await fetch(`${z.value?.serverBaseUrl}${t.file}`,{headers:{Authorization:`Bearer ${N.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(d){console.warn("Failed to check master playlist for audio:",d)}const b=[{type:"video",name:"Video",progress:0,status:"pending"}];return C&&b.push({type:"audio",name:"Audio",progress:0,status:"pending"}),n&&b.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),l&&b.push({type:"preview",name:"Preview",progress:0,status:"pending"}),w&&b.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:t.video_id,title:`${t.show}${t.season?` S${X(t.season,2)}`:""}${t.episode?`E${X(t.episode,2)}`:""} - ${t.title}`,image:t.image,progress:0,status:k===0?"pending":"waiting",children:b.map(d=>({...d,status:k===0?"pending":"waiting"}))}}));const T=e.filter(t=>!!t?.file).map(t=>{const k=t.tracks?.filter(l=>l.kind==="subtitles"&&l.file)?.map(l=>l.file),n=t.tracks?.filter(l=>l.kind==="fonts"&&l.file)?.map(l=>l.file),w=t.tracks?.filter(l=>["thumbnails","sprite"].includes(l.kind)&&l.file)?.map(l=>l.file);return{mediaId:t.video_id,mediaType:"video",mediaPath:t.file,baseUrl:z.value?.serverBaseUrl||"",token:N.value?.accessToken||"",...k?.length?{subtitlePaths:k}:{},...n?.length?{fontPaths:n}:{},...w?.length?{previewPaths:w}:{}}});if(!T.length)throw new Error("No valid files to download");return a.value=T.length,console.log("Starting download with tasks:",T),await new Promise((t,k)=>{f=new Worker(new URL("/assets/downloadWorker-Bu7z8Y_c.js",""+import.meta.url),{type:"module"}),f.onerror=n=>{console.error("Worker error:",n),k(n)},f.onmessage=n=>{if(console.log("Worker message:",n.data),n.data.type==="error"&&n.data.error==="paused")return;const{type:w,progress:l,itemProgress:C,assetType:b,assetProgress:d,itemId:O,status:A,isNewQuery:G}=n.data;if(w==="progress"){if((V||!G)&&(g.value=Math.min(l,100)),_.value=C,O){const p=r.value.find(x=>x.id===O);if(p){if(b){const P=p.children.find(H=>H.type===b);P&&(P.progress=Math.min(d,100),P.status=P.progress===100?"completed":A)}const x=p.children.filter(P=>P.progress===100).length;p.progress=Math.round(x/p.children.length*100),p.progress===100?(p.status="completed",E()):A&&(p.status=A)}}}else if(w==="complete")E(),t(!0);else if(w==="error")n.data.error==="paused"?t(!1):k(n.data.error);else if(w==="status"){const p=r.value.find(x=>x.id===n.data.itemId);p&&p.status!=="completed"&&p.status!==n.data.status&&(p.status=n.data.status,p.children.forEach(x=>{x.status!=="completed"&&(x.status=n.data.status)}))}},f.postMessage({tasks:T,baseUrl:z.value?.serverBaseUrl,token:N.value?.accessToken,isNewQuery:V})}),!0}catch(e){return e==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",e),!1)}finally{m.value||(f?.terminate(),$.value=!1)}}return{isDownloading:$,progress:g,totalItems:a,completedItems:v,itemProgress:_,downloadQueue:r,isPaused:m,downloadPlaylist:W,pauseDownloads:S,resumeDownloads:B,pauseItem:Q,resumeItem:D,prioritizeItem:U}}F();var ue={class:"bg-surface-900/50 rounded p-4 grid gap-2"},de={class:"flex justify-between items-center"},pe={class:"text-sm font-medium truncate flex items-center gap-2"},fe={key:0,class:"text-2xs text-slate-400"},me={key:1,class:"text-2xs text-slate-400"},ce={class:"flex gap-2"},ge=["src"],ve={class:"flex-1 min-w-0 grid gap-x-4 gap-y-0.5"},we={class:"flex justify-between leading-0"},he={class:"w-full bg-surface-700 rounded h-1"},ye=q({__name:"DownloadQueueItem",props:{item:{},onPause:{type:Function},onResume:{type:Function}},setup($){const g=a=>({"bg-blue-500":a==="video","bg-green-500":a==="audio","bg-yellow-500":a==="subtitle","bg-purple-500":a==="preview","bg-pink-500":a==="font"}),v=a=>a==="downloading"||a==="pending"||a==="waiting";return(a,_)=>(c(),h("article",ue,[i("header",de,[i("h3",pe,[ee(y(a.item.title)+" ",1),a.item.status==="downloading"?(c(),h("span",fe,"(Downloading...)")):a.item.status==="waiting"?(c(),h("span",me,"(Waiting...)")):M("",!0)]),a.item.status!=="completed"?(c(),h("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-surface-800",onClick:_[0]||(_[0]=r=>v(a.item.status)?a.onPause(a.item.id):a.onResume(a.item.id))},y(v(a.item.status)?"Pause":"Resume"),1)):M("",!0)]),i("div",ce,[i("img",{src:`${u(ie)}${a.item.image}`,alt:"Item Image",class:"w-1/4 h-auto aspect-video object-fit rounded"},null,8,ge),i("div",ve,[(c(!0),h(Z,null,J(a.item.children,r=>(c(),h("div",{key:r.type,class:"text-2xs"},[i("div",we,[i("span",null,y(r.name),1),i("span",null,y(r.progress)+"%",1)]),i("div",he,[i("div",{class:K([g(r.type),"h-full rounded"]),style:Y(`width: ${r.progress}%`)},null,6)])]))),128))])])]))}}),_e=ye;F();var ke={class:"flex gap-4 max-h-[80vh] overflow-clip"},be=["disabled"],xe={key:0,class:"text-xs grid gap-1"},Ie={class:"flex justify-between items-center"},Pe={class:"w-full bg-surface-700 rounded h-1.5 relative"},$e={key:0,class:"flex-1 overflow-y-auto available grid gap-2 content-start"},De=q({__name:"Desktop",setup($){const{isDownloading:g,progress:v,totalItems:a,completedItems:_,downloadQueue:r,isPaused:m,downloadPlaylist:f,pauseDownloads:E,resumeDownloads:S,pauseItem:B,resumeItem:Q}=le(),D=I("tv/138357");async function U(){await f("video",D.value)}return(W,o)=>{const s=te("InputText");return c(),L(ne,{"grid-style":3,title:"Profile",class:"grid gap-2 p-4 col-span-12"},{default:se(()=>[o[2]||(o[2]=i("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),i("div",ke,[i("form",{class:"w-2/5 flex flex-col gap-2",onSubmit:ae(U,["prevent"])},[oe(s,{modelValue:D.value,"onUpdate:modelValue":o[0]||(o[0]=e=>D.value=e),class:"w-full text-sm"},null,8,["modelValue"]),i("button",{disabled:u(g),class:"bg-primary p-1.5 rounded disabled:opacity-50 text-sm",type:"submit"},y(u(g)?"Downloading...":"Download Show"),9,be),u(g)||u(_)?(c(),h("div",xe,[i("div",Ie,[i("span",null,"Progress: "+y(u(v))+"% ("+y(u(_))+"/"+y(u(a))+")",1),i("button",{class:"text-xs px-2 py-0.5 rounded bg-surface-800",type:"button",onClick:o[1]||(o[1]=e=>u(m)?u(S)():u(E)())},y(u(m)?"Resume All":"Pause All"),1)]),i("div",Pe,[i("div",{style:Y(`width: ${u(v)}%`),class:"bg-primary h-full rounded absolute inset-0"},null,4)])])):M("",!0)],32),u(r).length?(c(),h("div",$e,[(c(!0),h(Z,null,J(u(r),e=>(c(),L(_e,{key:e.id,item:e,"on-pause":u(B),"on-resume":u(Q)},null,8,["item","on-pause","on-resume"]))),128))])):M("",!0)])]),_:1})}}}),We=De;export{We as default};
