var d=Object.defineProperty;var c=(o,e,t)=>e in o?d(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var p=(o,e,t)=>c(o,typeof e!="symbol"?e+"":e,t);import{Y as u,ej as h}from"./index-DkQngsHe.js";import{P as y,S as b}from"./subtitles-octopus-BvnPWJkB.js";class m extends y{constructor(){super(...arguments);p(this,"player",{});p(this,"route",{})}async initialize(t){this.player=t}use(){this.player.on("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.on("back",this.ended.bind(this)),this.player.on("ended",this.ended.bind(this)),this.player.on("finished",this.ended.bind(this)),this.route=u()}dispose(){this.player.off("lastTimeTrigger",this.lastTimeTrigger.bind(this)),this.player.off("back",this.ended.bind(this)),this.player.off("ended",this.ended.bind(this)),this.player.off("finished",this.ended.bind(this))}lastTimeTrigger(){const t=this.episodeData(),s=h();s==null||s.invoke("SetTime",t)}ended(){var s,a;const t=this.player.getCurrentTime()/this.player.getDuration()*100;if(this.player.isLastPlaylistItem()&&((s=this.player.playlistItem())==null?void 0:s.playlist_type)==="tv"&&t>=90){const i=h();i==null||i.invoke("RemoveWatched",this.episodeData()).then()}else if(this.player.isLastPlaylistItem()&&((a=this.player.playlistItem())==null?void 0:a.playlist_type)==="movie"&&t>=80){const i=h();i==null||i.invoke("RemoveWatched",this.episodeData()).then()}}episodeData(){var l;const t=this.player.playlistItem();let s=(l=this.route)==null?void 0:l.path;s||(s=window.location.hash.replace("#","")),s||(s=location.pathname);const a=s==null?void 0:s.split("/");let i,n,r=(t==null?void 0:t.tmdb_id)??a.at(-2);return a.at(-3)==="specials"?i=a.at(-2):a.at(-3)==="collection"&&(n=a.at(-2),r=t.id),{video_id:t==null?void 0:t.video_id,tmdb_id:r,playlist_type:a.at(-3),special_id:i,collection_id:n,video_type:t==null?void 0:t.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}}class I extends y{initialize(e){this.player=e}use(){this.player.on("captionsChanged",this.opus.bind(this)),this.resizeObserver=new ResizeObserver(()=>{this.resize()}),this.resizeObserver.observe(this.player.container)}dispose(){var e;this.player.off("captionsChanged",this.opus.bind(this)),(e=this.resizeObserver)==null||e.disconnect(),this.destroy()}destroy(){var e;(e=this.player.octopusInstance)==null||e.dispose(),this.player.octopusInstance=null}async opus(){var a,i;this.destroy();const e=this.player.getSubtitleFile()?`${this.player.options.basePath??""}${this.player.getSubtitleFile()}`:null;if(!e)return;const t=(a=e==null?void 0:e.match(/\w+\.\w+\.\w+$/u))==null?void 0:a[0];let[,,s]=t?t.split("."):[];if(s||(s=e.split(".").at(-1)||""),!(s!="ass"&&s!="ssa")&&e){await this.player.fetchFontFile();const n=(i=this.player.fonts)==null?void 0:i.map(l=>`${this.player.options.basePath??""}${l.file}`);this.player.getElement().querySelectorAll(".libassjs-canvas-parent").forEach(l=>l.remove());const r={video:this.player.getVideoElement(),subUrl:e,fonts:n,lossyRender:this.player.options.lossyRender,accessToken:this.player.options.accessToken,targetFps:this.player.options.targetFps,debug:this.player.options.debug,blendRender:this.player.options.blendRender,lazyFileLoading:this.player.options.lazyFileLoading,renderAhead:this.player.options.renderAhead,workerUrl:"/js/octopus/subtitles-octopus-worker.js",legacyWorkerUrl:"/js/octopus/subtitles-octopus-worker-legacy.js",fallbackFont:"/js/octopus/default.ttf",onReady:async()=>{this.resize()},onError:l=>{console.error("opus error",l)}};e&&e.includes(".ass")&&(this.player.octopusInstance=new b(r))}}resize(){var e,t;!((t=(e=this.player)==null?void 0:e.octopusInstance)!=null&&t.canvasParent)||!this.subtitleOverlay||(this.player.octopusInstance.canvasParent.style.width=this.subtitleOverlay.style.width,this.player.octopusInstance.canvasParent.style.height=this.subtitleOverlay.style.height,this.player.octopusInstance.canvasParent.style.position=this.subtitleOverlay.style.position,this.player.octopusInstance.canvasParent.style.top=this.subtitleOverlay.style.top,this.player.octopusInstance.canvasParent.style.left=this.subtitleOverlay.style.left,this.player.octopusInstance.canvasParent.style.transform=this.subtitleOverlay.style.transform)}}export{I as O,m as S};
