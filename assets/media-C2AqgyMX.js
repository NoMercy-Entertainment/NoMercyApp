var zS=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function QS(v){return v&&v.__esModule&&Object.prototype.hasOwnProperty.call(v,"default")?v.default:v}function ZS(v){if(Object.prototype.hasOwnProperty.call(v,"__esModule"))return v;var e=v.default;if(typeof e=="function"){var r=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};r.prototype=e.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(v).forEach(function(n){var l=Object.getOwnPropertyDescriptor(v,n);Object.defineProperty(r,n,l.get?l:{enumerable:!0,get:function(){return v[n]}})}),r}var za={exports:{}},Vh;function JS(){return Vh||(Vh=1,function(v,e){(function r(n){(function(l,f){v.exports=f()})(this,function(){function l(u,d){(d==null||d>u.length)&&(d=u.length);for(var o=0,s=Array(d);o<d;o++)s[o]=u[o];return s}function f(u,d,o){if(D())return Reflect.construct.apply(null,arguments);var s=[null];s.push.apply(s,d);var t=new(u.bind.apply(u,s));return o&&$(t,o.prototype),t}function c(u,d){for(var o=0;o<d.length;o++){var s=d[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(u,K(s.key),s)}}function y(u,d,o){return d&&c(u.prototype,d),o&&c(u,o),Object.defineProperty(u,"prototype",{writable:!1}),u}function S(u,d){var o=typeof Symbol<"u"&&u[Symbol.iterator]||u["@@iterator"];if(o)return(o=o.call(u)).next.bind(o);if(Array.isArray(u)||(o=z(u))||d){o&&(u=o);var s=0;return function(){return s>=u.length?{done:!0}:{done:!1,value:u[s++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function T(u,d,o){return(d=K(d))in u?Object.defineProperty(u,d,{value:o,enumerable:!0,configurable:!0,writable:!0}):u[d]=o,u}function A(){return A=Object.assign?Object.assign.bind():function(u){for(var d=1;d<arguments.length;d++){var o=arguments[d];for(var s in o)({}).hasOwnProperty.call(o,s)&&(u[s]=o[s])}return u},A.apply(null,arguments)}function L(u){return L=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(d){return d.__proto__||Object.getPrototypeOf(d)},L(u)}function b(u,d){u.prototype=Object.create(d.prototype),u.prototype.constructor=u,$(u,d)}function C(u){try{return Function.toString.call(u).indexOf("[native code]")!==-1}catch{return typeof u=="function"}}function D(){try{var u=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(D=function(){return!!u})()}function M(u,d){var o=Object.keys(u);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(u);d&&(s=s.filter(function(t){return Object.getOwnPropertyDescriptor(u,t).enumerable})),o.push.apply(o,s)}return o}function F(u){for(var d=1;d<arguments.length;d++){var o=arguments[d]!=null?arguments[d]:{};d%2?M(Object(o),!0).forEach(function(s){T(u,s,o[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(o)):M(Object(o)).forEach(function(s){Object.defineProperty(u,s,Object.getOwnPropertyDescriptor(o,s))})}return u}function $(u,d){return $=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,s){return o.__proto__=s,o},$(u,d)}function H(u,d){if(typeof u!="object"||!u)return u;var o=u[Symbol.toPrimitive];if(o!==void 0){var s=o.call(u,d);if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(d==="string"?String:Number)(u)}function K(u){var d=H(u,"string");return typeof d=="symbol"?d:d+""}function z(u,d){if(u){if(typeof u=="string")return l(u,d);var o={}.toString.call(u).slice(8,-1);return o==="Object"&&u.constructor&&(o=u.constructor.name),o==="Map"||o==="Set"?Array.from(u):o==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?l(u,d):void 0}}function Q(u){var d=typeof Map=="function"?new Map:void 0;return Q=function(o){if(o===null||!C(o))return o;if(typeof o!="function")throw new TypeError("Super expression must either be null or a function");if(d!==void 0){if(d.has(o))return d.get(o);d.set(o,s)}function s(){return f(o,arguments,L(this).constructor)}return s.prototype=Object.create(o.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),$(s,o)},Q(u)}function ne(){try{return crypto.randomUUID()}catch{try{var u=URL.createObjectURL(new Blob),d=u.toString();return URL.revokeObjectURL(u),d.slice(d.lastIndexOf("/")+1)}catch{var o=new Date().getTime(),s="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var h=(o+Math.random()*16)%16|0;return o=Math.floor(o/16),(a=="x"?h:h&3|8).toString(16)});return s}}}function Z(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var ie={exports:{}},le;function ee(){return le||(le=1,function(u){var d=Object.prototype.hasOwnProperty,o="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(o=!1));function t(g,m,p){this.fn=g,this.context=m,this.once=p||!1}function i(g,m,p,E,x){if(typeof p!="function")throw new TypeError("The listener must be a function");var I=new t(p,E||g,x),R=o?o+m:m;return g._events[R]?g._events[R].fn?g._events[R]=[g._events[R],I]:g._events[R].push(I):(g._events[R]=I,g._eventsCount++),g}function a(g,m){--g._eventsCount===0?g._events=new s:delete g._events[m]}function h(){this._events=new s,this._eventsCount=0}h.prototype.eventNames=function(){var m=[],p,E;if(this._eventsCount===0)return m;for(E in p=this._events)d.call(p,E)&&m.push(o?E.slice(1):E);return Object.getOwnPropertySymbols?m.concat(Object.getOwnPropertySymbols(p)):m},h.prototype.listeners=function(m){var p=o?o+m:m,E=this._events[p];if(!E)return[];if(E.fn)return[E.fn];for(var x=0,I=E.length,R=new Array(I);x<I;x++)R[x]=E[x].fn;return R},h.prototype.listenerCount=function(m){var p=o?o+m:m,E=this._events[p];return E?E.fn?1:E.length:0},h.prototype.emit=function(m,p,E,x,I,R){var _=o?o+m:m;if(!this._events[_])return!1;var P=this._events[_],O=arguments.length,N,U;if(P.fn){switch(P.once&&this.removeListener(m,P.fn,void 0,!0),O){case 1:return P.fn.call(P.context),!0;case 2:return P.fn.call(P.context,p),!0;case 3:return P.fn.call(P.context,p,E),!0;case 4:return P.fn.call(P.context,p,E,x),!0;case 5:return P.fn.call(P.context,p,E,x,I),!0;case 6:return P.fn.call(P.context,p,E,x,I,R),!0}for(U=1,N=new Array(O-1);U<O;U++)N[U-1]=arguments[U];P.fn.apply(P.context,N)}else{var B=P.length,G;for(U=0;U<B;U++)switch(P[U].once&&this.removeListener(m,P[U].fn,void 0,!0),O){case 1:P[U].fn.call(P[U].context);break;case 2:P[U].fn.call(P[U].context,p);break;case 3:P[U].fn.call(P[U].context,p,E);break;case 4:P[U].fn.call(P[U].context,p,E,x);break;default:if(!N)for(G=1,N=new Array(O-1);G<O;G++)N[G-1]=arguments[G];P[U].fn.apply(P[U].context,N)}}return!0},h.prototype.on=function(m,p,E){return i(this,m,p,E,!1)},h.prototype.once=function(m,p,E){return i(this,m,p,E,!0)},h.prototype.removeListener=function(m,p,E,x){var I=o?o+m:m;if(!this._events[I])return this;if(!p)return a(this,I),this;var R=this._events[I];if(R.fn)R.fn===p&&(!x||R.once)&&(!E||R.context===E)&&a(this,I);else{for(var _=0,P=[],O=R.length;_<O;_++)(R[_].fn!==p||x&&!R[_].once||E&&R[_].context!==E)&&P.push(R[_]);P.length?this._events[I]=P.length===1?P[0]:P:a(this,I)}return this},h.prototype.removeAllListeners=function(m){var p;return m?(p=o?o+m:m,this._events[p]&&a(this,p)):(this._events=new s,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=o,h.EventEmitter=h,u.exports=h}(ie)),ie.exports}var ve=ee(),Ee=Z(ve),Ne={exports:{}},Ce;function _e(){return Ce||(Ce=1,function(u,d){(function(o){var s=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,t=/^(?=([^\/?#]*))\1([^]*)$/,i=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,h={buildAbsoluteURL:function(g,m,p){if(p=p||{},g=g.trim(),m=m.trim(),!m){if(!p.alwaysNormalize)return g;var E=h.parseURL(g);if(!E)throw new Error("Error trying to parse base URL.");return E.path=h.normalizePath(E.path),h.buildURLFromParts(E)}var x=h.parseURL(m);if(!x)throw new Error("Error trying to parse relative URL.");if(x.scheme)return p.alwaysNormalize?(x.path=h.normalizePath(x.path),h.buildURLFromParts(x)):m;var I=h.parseURL(g);if(!I)throw new Error("Error trying to parse base URL.");if(!I.netLoc&&I.path&&I.path[0]!=="/"){var R=t.exec(I.path);I.netLoc=R[1],I.path=R[2]}I.netLoc&&!I.path&&(I.path="/");var _={scheme:I.scheme,netLoc:x.netLoc,path:null,params:x.params,query:x.query,fragment:x.fragment};if(!x.netLoc&&(_.netLoc=I.netLoc,x.path[0]!=="/"))if(!x.path)_.path=I.path,x.params||(_.params=I.params,x.query||(_.query=I.query));else{var P=I.path,O=P.substring(0,P.lastIndexOf("/")+1)+x.path;_.path=h.normalizePath(O)}return _.path===null&&(_.path=p.alwaysNormalize?h.normalizePath(x.path):x.path),h.buildURLFromParts(_)},parseURL:function(g){var m=s.exec(g);return m?{scheme:m[1]||"",netLoc:m[2]||"",path:m[3]||"",params:m[4]||"",query:m[5]||"",fragment:m[6]||""}:null},normalizePath:function(g){for(g=g.split("").reverse().join("").replace(i,"");g.length!==(g=g.replace(a,"")).length;);return g.split("").reverse().join("")},buildURLFromParts:function(g){return g.scheme+g.netLoc+g.path+g.params+g.query+g.fragment}};u.exports=h})()}(Ne)),Ne.exports}var xe=_e(),ue=Number.isFinite||function(u){return typeof u=="number"&&isFinite(u)},Re=Number.isSafeInteger||function(u){return typeof u=="number"&&Math.abs(u)<=me},me=Number.MAX_SAFE_INTEGER||9007199254740991,se=function(u){return u.NETWORK_ERROR="networkError",u.MEDIA_ERROR="mediaError",u.KEY_SYSTEM_ERROR="keySystemError",u.MUX_ERROR="muxError",u.OTHER_ERROR="otherError",u}({}),q=function(u){return u.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",u.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",u.KEY_SYSTEM_NO_SESSION="keySystemNoSession",u.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",u.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",u.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",u.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",u.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",u.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",u.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",u.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",u.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",u.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",u.MANIFEST_LOAD_ERROR="manifestLoadError",u.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",u.MANIFEST_PARSING_ERROR="manifestParsingError",u.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",u.LEVEL_EMPTY_ERROR="levelEmptyError",u.LEVEL_LOAD_ERROR="levelLoadError",u.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",u.LEVEL_PARSING_ERROR="levelParsingError",u.LEVEL_SWITCH_ERROR="levelSwitchError",u.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",u.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",u.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",u.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",u.FRAG_LOAD_ERROR="fragLoadError",u.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",u.FRAG_DECRYPT_ERROR="fragDecryptError",u.FRAG_PARSING_ERROR="fragParsingError",u.FRAG_GAP="fragGap",u.REMUX_ALLOC_ERROR="remuxAllocError",u.KEY_LOAD_ERROR="keyLoadError",u.KEY_LOAD_TIMEOUT="keyLoadTimeOut",u.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",u.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",u.BUFFER_APPEND_ERROR="bufferAppendError",u.BUFFER_APPENDING_ERROR="bufferAppendingError",u.BUFFER_STALLED_ERROR="bufferStalledError",u.BUFFER_FULL_ERROR="bufferFullError",u.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",u.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",u.ASSET_LIST_LOAD_ERROR="assetListLoadError",u.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",u.ASSET_LIST_PARSING_ERROR="assetListParsingError",u.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",u.INTERNAL_EXCEPTION="internalException",u.INTERNAL_ABORTED="aborted",u.ATTACH_MEDIA_ERROR="attachMediaError",u.UNKNOWN="unknown",u}({}),k=function(u){return u.MEDIA_ATTACHING="hlsMediaAttaching",u.MEDIA_ATTACHED="hlsMediaAttached",u.MEDIA_DETACHING="hlsMediaDetaching",u.MEDIA_DETACHED="hlsMediaDetached",u.MEDIA_ENDED="hlsMediaEnded",u.STALL_RESOLVED="hlsStallResolved",u.BUFFER_RESET="hlsBufferReset",u.BUFFER_CODECS="hlsBufferCodecs",u.BUFFER_CREATED="hlsBufferCreated",u.BUFFER_APPENDING="hlsBufferAppending",u.BUFFER_APPENDED="hlsBufferAppended",u.BUFFER_EOS="hlsBufferEos",u.BUFFERED_TO_END="hlsBufferedToEnd",u.BUFFER_FLUSHING="hlsBufferFlushing",u.BUFFER_FLUSHED="hlsBufferFlushed",u.MANIFEST_LOADING="hlsManifestLoading",u.MANIFEST_LOADED="hlsManifestLoaded",u.MANIFEST_PARSED="hlsManifestParsed",u.LEVEL_SWITCHING="hlsLevelSwitching",u.LEVEL_SWITCHED="hlsLevelSwitched",u.LEVEL_LOADING="hlsLevelLoading",u.LEVEL_LOADED="hlsLevelLoaded",u.LEVEL_UPDATED="hlsLevelUpdated",u.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",u.LEVELS_UPDATED="hlsLevelsUpdated",u.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",u.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",u.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",u.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",u.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",u.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",u.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",u.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",u.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",u.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",u.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",u.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",u.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",u.CUES_PARSED="hlsCuesParsed",u.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",u.INIT_PTS_FOUND="hlsInitPtsFound",u.FRAG_LOADING="hlsFragLoading",u.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",u.FRAG_LOADED="hlsFragLoaded",u.FRAG_DECRYPTED="hlsFragDecrypted",u.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",u.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",u.FRAG_PARSING_METADATA="hlsFragParsingMetadata",u.FRAG_PARSED="hlsFragParsed",u.FRAG_BUFFERED="hlsFragBuffered",u.FRAG_CHANGED="hlsFragChanged",u.FPS_DROP="hlsFpsDrop",u.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",u.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",u.ERROR="hlsError",u.DESTROYING="hlsDestroying",u.KEY_LOADING="hlsKeyLoading",u.KEY_LOADED="hlsKeyLoaded",u.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",u.BACK_BUFFER_REACHED="hlsBackBufferReached",u.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",u.ASSET_LIST_LOADING="hlsAssetListLoading",u.ASSET_LIST_LOADED="hlsAssetListLoaded",u.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",u.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",u.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",u.INTERSTITIAL_STARTED="hlsInterstitialStarted",u.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",u.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",u.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",u.INTERSTITIAL_ENDED="hlsInterstitialEnded",u.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",u.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",u.EVENT_CUE_ENTER="hlsEventCueEnter",u}({}),Te={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},pe={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"},Ke=function(){function u(o,s,t){s===void 0&&(s=0),t===void 0&&(t=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=o,this.alpha_=o?Math.exp(Math.log(.5)/o):0,this.estimate_=s,this.totalWeight_=t}var d=u.prototype;return d.sample=function(s,t){var i=Math.pow(this.alpha_,s);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=s},d.getTotalWeight=function(){return this.totalWeight_},d.getEstimate=function(){if(this.alpha_){var s=1-Math.pow(this.alpha_,this.totalWeight_);if(s)return this.estimate_/s}return this.estimate_},u}(),et=function(){function u(o,s,t,i){i===void 0&&(i=100),this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=t,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Ke(o),this.fast_=new Ke(s),this.defaultTTFB_=i,this.ttfb_=new Ke(o)}var d=u.prototype;return d.update=function(s,t){var i=this.slow_,a=this.fast_,h=this.ttfb_;i.halfLife!==s&&(this.slow_=new Ke(s,i.getEstimate(),i.getTotalWeight())),a.halfLife!==t&&(this.fast_=new Ke(t,a.getEstimate(),a.getTotalWeight())),h.halfLife!==s&&(this.ttfb_=new Ke(s,h.getEstimate(),h.getTotalWeight()))},d.sample=function(s,t){s=Math.max(s,this.minDelayMs_);var i=8*t,a=s/1e3,h=i/a;this.fast_.sample(a,h),this.slow_.sample(a,h)},d.sampleTTFB=function(s){var t=s/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(s,5))},d.canEstimate=function(){return this.fast_.getTotalWeight()>=this.minWeight_},d.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},d.getEstimateTTFB=function(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_},d.destroy=function(){},y(u,[{key:"defaultEstimate",get:function(){return this.defaultEstimate_}}])}(),st=function(d,o){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;var s="["+d+"]:";this.trace=lt,this.debug=o.debug.bind(null,s),this.log=o.log.bind(null,s),this.warn=o.warn.bind(null,s),this.info=o.info.bind(null,s),this.error=o.error.bind(null,s)},lt=function(){},ir={trace:lt,debug:lt,log:lt,warn:lt,info:lt,error:lt};function ii(){return A({},ir)}function On(u,d){var o=self.console[u];return o?o.bind(self.console,(d?"["+d+"] ":"")+"["+u+"] >"):lt}function ls(u,d,o){return d[u]?d[u].bind(d):On(u,o)}var Hr=ii();function si(u,d,o){var s=ii();if(typeof console=="object"&&u===!0||typeof u=="object"){var t=["debug","log","info","warn","error"];t.forEach(function(i){s[i]=ls(i,u,o)});try{s.log('Debug logs enabled for "'+d+'" in hls.js version 1.6.0')}catch{return ii()}t.forEach(function(i){Hr[i]=ls(i,u)})}else A(Hr,s);return s}var Ye=Hr;function Ue(u){if(u===void 0&&(u=!0),!(typeof self>"u")){var d=(u||!self.MediaSource)&&self.ManagedMediaSource;return d||self.MediaSource||self.WebKitMediaSource}}function bt(u){return typeof self<"u"&&u===self.ManagedMediaSource}function Nt(u,d){var o=Object.keys(u),s=Object.keys(d),t=o.length,i=s.length;return!t||!i||t===i&&!o.some(function(a){return s.indexOf(a)===-1})}function mt(u,d){if(d===void 0&&(d=!1),typeof TextDecoder<"u"){var o=new TextDecoder("utf-8"),s=o.decode(u);if(d){var t=s.indexOf("\0");return t!==-1?s.substring(0,t):s}return s.replace(/\0/g,"")}for(var i=u.length,a,h,g,m="",p=0;p<i;){if(a=u[p++],a===0&&d)return m;if(a===0||a===3)continue;switch(a>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:m+=String.fromCharCode(a);break;case 12:case 13:h=u[p++],m+=String.fromCharCode((a&31)<<6|h&63);break;case 14:h=u[p++],g=u[p++],m+=String.fromCharCode((a&15)<<12|(h&63)<<6|(g&63)<<0);break}}return m}var dt={hexDump:function(d){for(var o="",s=0;s<d.length;s++){var t=d[s].toString(16);t.length<2&&(t="0"+t),o+=t}return o}},sr=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}},Ve={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"},ki=function(){function u(o){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof o=="string"&&(o={url:o}),this.base=o,Mn(this,"stats")}var d=u.prototype;return d.setByteRange=function(s,t){var i=s.split("@",2),a;i.length===1?a=(t==null?void 0:t.byteRangeEndOffset)||0:a=parseInt(i[1]),this._byteRange=[a,parseInt(i[0])+a]},d.clearElementaryStreamInfo=function(){var s=this.elementaryStreams;s[Ve.AUDIO]=null,s[Ve.VIDEO]=null,s[Ve.AUDIOVIDEO]=null},y(u,[{key:"baseurl",get:function(){return this.base.url}},{key:"byteRange",get:function(){return this._byteRange===null?[]:this._byteRange}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"elementaryStreams",get:function(){if(this._streams===null){var s;this._streams=(s={},s[Ve.AUDIO]=null,s[Ve.VIDEO]=null,s[Ve.AUDIOVIDEO]=null,s)}return this._streams},set:function(s){this._streams=s}},{key:"hasStats",get:function(){return this._stats!==null}},{key:"hasStreams",get:function(){return this._streams!==null}},{key:"stats",get:function(){return this._stats===null&&(this._stats=new sr),this._stats},set:function(s){this._stats=s}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=xe.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(s){this._url=s}}])}();function ct(u){return u.sn!=="initSegment"}var ni=function(u){function d(s,t){var i;return i=u.call(this,t)||this,i._decryptdata=null,i._programDateTime=null,i._ref=null,i._bitrate=void 0,i.rawProgramDateTime=null,i.tagList=[],i.duration=0,i.sn=0,i.levelkeys=void 0,i.type=void 0,i.loader=null,i.keyLoader=null,i.level=-1,i.cc=0,i.startPTS=void 0,i.endPTS=void 0,i.startDTS=void 0,i.endDTS=void 0,i.start=0,i.playlistOffset=0,i.deltaPTS=void 0,i.maxStartPTS=void 0,i.minEndPTS=void 0,i.data=void 0,i.bitrateTest=!1,i.title=null,i.initSegment=null,i.endList=void 0,i.gap=void 0,i.urlId=0,i.type=s,i}b(d,u);var o=d.prototype;return o.addStart=function(t){this.setStart(this.start+t)},o.setStart=function(t){this.start=t,this._ref&&(this._ref.start=t)},o.setDuration=function(t){this.duration=t,this._ref&&(this._ref.duration=t)},o.setKeyFormat=function(t){if(this.levelkeys){var i=this.levelkeys[t];i&&!this._decryptdata&&(this._decryptdata=i.getDecryptData(this.sn))}},o.abortRequests=function(){var t,i;(t=this.loader)==null||t.abort(),(i=this.keyLoader)==null||i.abort()},o.setElementaryStreamInfo=function(t,i,a,h,g,m){m===void 0&&(m=!1);var p=this.elementaryStreams,E=p[t];if(!E){p[t]={startPTS:i,endPTS:a,startDTS:h,endDTS:g,partial:m};return}E.startPTS=Math.min(E.startPTS,i),E.endPTS=Math.max(E.endPTS,a),E.startDTS=Math.min(E.startDTS,h),E.endDTS=Math.max(E.endDTS,g)},y(d,[{key:"byteLength",get:function(){if(this.hasStats){var t=this.stats.total;if(t)return t}if(this.byteRange){var i=this.byteRange[0],a=this.byteRange[1];if(ue(i)&&ue(a))return a-i}return null}},{key:"bitrate",get:function(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null},set:function(t){this._bitrate=t}},{key:"decryptdata",get:function(){var t=this.levelkeys;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){var i=this.levelkeys.identity;if(i)this._decryptdata=i.getDecryptData(this.sn);else{var a=Object.keys(this.levelkeys);if(a.length===1)return this._decryptdata=this.levelkeys[a[0]].getDecryptData(this.sn)}}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null)return null;var t=ue(this.duration)?this.duration:0;return this.programDateTime+t*1e3}},{key:"encrypted",get:function(){var t;if((t=this._decryptdata)!=null&&t.encrypted)return!0;if(this.levelkeys){var i=Object.keys(this.levelkeys),a=i.length;if(a>1||a===1&&this.levelkeys[i[0]].encrypted)return!0}return!1}},{key:"programDateTime",get:function(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime},set:function(t){if(!ue(t)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=t}},{key:"ref",get:function(){return ct(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}}])}(ki),Yr=function(u){function d(o,s,t,i,a){var h;h=u.call(this,t)||this,h.fragOffset=0,h.duration=0,h.gap=!1,h.independent=!1,h.relurl=void 0,h.fragment=void 0,h.index=void 0,h.duration=o.decimalFloatingPoint("DURATION"),h.gap=o.bool("GAP"),h.independent=o.bool("INDEPENDENT"),h.relurl=o.enumeratedString("URI"),h.fragment=s,h.index=i;var g=o.enumeratedString("BYTERANGE");return g&&h.setByteRange(g,a),a&&(h.fragOffset=a.fragOffset+a.duration),h}return b(d,u),y(d,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var s=this.elementaryStreams;return!!(s.audio||s.video||s.audiovideo)}}])}(ki);function wi(u,d){var o=Object.getPrototypeOf(u);if(o){var s=Object.getOwnPropertyDescriptor(o,d);return s||wi(o,d)}}function Mn(u,d){var o=wi(u,d);o&&(o.enumerable=!0,Object.defineProperty(u,d,o))}var Wr=Math.pow(2,32)-1,us=[].push,Pr={video:1,audio:2,id3:3,text:4};function At(u){return String.fromCharCode.apply(null,u)}function ll(u,d){var o=u[d]<<8|u[d+1];return o<0?65536+o:o}function Pe(u,d){var o=hl(u,d);return o<0?4294967296+o:o}function ul(u,d){var o=Pe(u,d);return o*=Math.pow(2,32),o+=Pe(u,d+4),o}function hl(u,d){return u[d]<<24|u[d+1]<<16|u[d+2]<<8|u[d+3]}function Fn(u,d,o){u[d]=o>>24,u[d+1]=o>>16&255,u[d+2]=o>>8&255,u[d+3]=o&255}function Lc(u){for(var d=u.byteLength,o=0;o<d;){var s=Pe(u,o);if(s>8&&u[o+4]===109&&u[o+5]===111&&u[o+6]===111&&u[o+7]===102)return!0;o=s>1?o+s:d}return!1}function we(u,d){var o=[];if(!d.length)return o;for(var s=u.byteLength,t=0;t<s;){var i=Pe(u,t),a=At(u.subarray(t+4,t+8)),h=i>1?t+i:s;if(a===d[0])if(d.length===1)o.push(u.subarray(t+8,h));else{var g=we(u.subarray(t+8,h),d.slice(1));g.length&&us.apply(o,g)}t=h}return o}function Ic(u){var d=[],o=u[0],s=8,t=Pe(u,s);s+=4;var i=0,a=0;o===0?(i=Pe(u,s),a=Pe(u,s+4),s+=8):(i=ul(u,s),a=ul(u,s+8),s+=16),s+=2;var h=u.length+a,g=ll(u,s);s+=2;for(var m=0;m<g;m++){var p=s,E=Pe(u,p);p+=4;var x=E&2147483647,I=(E&2147483648)>>>31;if(I===1)return Ye.warn("SIDX has hierarchical references (not supported)"),null;var R=Pe(u,p);p+=4,d.push({referenceSize:x,subsegmentDuration:R,info:{duration:R/t,start:h,end:h+x-1}}),h+=x,p+=4,s=p}return{earliestPresentationTime:i,timescale:t,version:o,referencesCount:g,references:d}}function fl(u){for(var d=[],o=we(u,["moov","trak"]),s=0;s<o.length;s++){var t=o[s],i=we(t,["tkhd"])[0];if(i){var a=i[0],h=Pe(i,a===0?12:20),g=we(t,["mdia","mdhd"])[0];if(g){a=g[0];var m=Pe(g,a===0?12:20),p=we(t,["mdia","hdlr"])[0];if(p){var E=At(p.subarray(8,12)),x={soun:Ve.AUDIO,vide:Ve.VIDEO}[E],I=we(t,["mdia","minf","stbl","stsd"])[0],R=Rc(I);x?(d[h]={timescale:m,type:x,stsd:R},d[x]=F({timescale:m,id:h},R)):d[h]={timescale:m,type:E,stsd:R}}}}}var _=we(u,["moov","mvex","trex"]);return _.forEach(function(P){var O=Pe(P,4),N=d[O];N&&(N.default={duration:Pe(P,12),flags:Pe(P,20)})}),d}function Rc(u){var d=u.subarray(8),o=d.subarray(86),s=At(d.subarray(4,8)),t=s,i,a=s==="enca"||s==="encv";if(a){var h=we(d,[s])[0],g=h.subarray(s==="enca"?28:78),m=we(g,["sinf"]);m.forEach(function(Dt){var Lt=we(Dt,["schm"])[0];if(Lt){var vt=At(Lt.subarray(4,8));if(vt==="cbcs"||vt==="cenc"){var St=we(Dt,["frma"])[0];St&&(t=At(St))}}})}var p=t;switch(t){case"avc1":case"avc2":case"avc3":case"avc4":{var E=we(o,["avcC"])[0];t+="."+fs(E[1])+fs(E[2])+fs(E[3]),i=hs(p==="avc1"?"dva1":"dvav",o);break}case"mp4a":{var x=we(d,[s])[0],I=we(x.subarray(28),["esds"])[0];if(I&&I.length>7){var R=4;if(I[R++]!==3)break;R=Nn(I,R),R+=2;var _=I[R++];if(_&128&&(R+=2),_&64&&(R+=I[R++]),I[R++]!==4)break;R=Nn(I,R);var P=I[R++];if(P===64)t+="."+fs(P);else break;if(R+=12,I[R++]!==5)break;R=Nn(I,R);var O=I[R++],N=(O&248)>>3;N===31&&(N+=1+((O&7)<<3)+((I[R]&224)>>5)),t+="."+N}break}case"hvc1":case"hev1":{var U=we(o,["hvcC"]);if(U){var B=U[0],G=B[1],Y=["","A","B","C"][G>>6],V=G&31,j=Pe(B,2),ae=(G&32)>>5?"H":"L",X=B[12],W=B.subarray(6,12);t+="."+Y+V,t+="."+j.toString(16).toUpperCase(),t+="."+ae+X;for(var J="",oe=W.length;oe--;){var ge=W[oe];if(ge||J){var ce=ge.toString(16).toUpperCase();J="."+ce+J}}t+=J}i=hs(p=="hev1"?"dvhe":"dvh1",o);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{t=hs(t,o)||t;break}case"vp09":{var he=we(o,["vpcC"])[0],ye=he[4],Se=he[5],Le=he[6]>>4&15;t+="."+nr(ye)+"."+nr(Se)+"."+nr(Le);break}case"av01":{var Ie=we(o,["av1C"])[0],He=Ie[1]>>>5,Oe=Ie[1]&31,je=Ie[2]>>>7?"H":"M",Fe=(Ie[2]&64)>>6,Xe=(Ie[2]&32)>>5,ze=He===2&&Fe?Xe?12:10:Fe?10:8,it=(Ie[2]&16)>>4,yt=(Ie[2]&8)>>3,gt=(Ie[2]&4)>>2,nt=Ie[2]&3,Et=1,ut=1,Ge=1,Mt=0;t+="."+He+"."+nr(Oe)+je+"."+nr(ze)+"."+it+"."+yt+gt+nt+"."+nr(Et)+"."+nr(ut)+"."+nr(Ge)+"."+Mt,i=hs("dav1",o);break}}return{codec:t,encrypted:a,supplemental:i}}function hs(u,d){var o=we(d,["dvvC"]),s=o.length?o[0]:we(d,["dvcC"])[0];if(s){var t=s[2]>>1&127,i=s[2]<<5&32|s[3]>>3&31;return u+"."+nr(t)+"."+nr(i)}}function Nn(u,d){for(var o=d+5;u[d++]&128&&d<o;);return d}function fs(u){return("0"+u.toString(16).toUpperCase()).slice(-2)}function nr(u){return(u<10?"0":"")+u}function bc(u,d){if(!u||!d)return u;var o=d.keyId;if(o&&d.isCommonEncryption){var s=we(u,["moov","trak"]);s.forEach(function(t){var i=we(t,["mdia","minf","stbl","stsd"])[0],a=i.subarray(8),h=we(a,["enca"]),g=h.length>0;g||(h=we(a,["encv"])),h.forEach(function(m){var p=g?m.subarray(28):m.subarray(78),E=we(p,["sinf"]);E.forEach(function(x){var I=dl(x);if(I){var R=I.subarray(8,24);R.some(function(_){return _!==0})||(Ye.log("[eme] Patching keyId in 'enc"+(g?"a":"v")+">sinf>>tenc' box: "+dt.hexDump(R)+" -> "+dt.hexDump(o)),I.set(o,8))}})})})}return u}function dl(u){var d=we(u,["schm"])[0];if(d){var o=At(d.subarray(4,8));if(o==="cbcs"||o==="cenc")return we(u,["schi","tenc"])[0]}return null}function _c(u,d){return we(d,["moof","traf"]).reduce(function(o,s){var t=we(s,["tfdt"])[0],i=t[0],a=we(s,["tfhd"]).reduce(function(h,g){var m=Pe(g,4),p=u[m];if(p){var E=Pe(t,4);if(i===1){if(E===Wr)return Ye.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),h;E*=Wr+1,E+=Pe(t,8)}var x=p.timescale||9e4,I=E/x;if(ue(I)&&(h===null||I<h))return I}return h},null);return a!==null&&ue(a)&&(o===null||a<o)?a:o},null)}function Dc(u,d){for(var o=0,s=0,t=0,i=we(u,["moof","traf"]),a=0;a<i.length;a++){var h=i[a],g=we(h,["tfhd"])[0],m=Pe(g,4),p=d[m];if(p){var E=p.default,x=Pe(g,0)|(E==null?void 0:E.flags),I=E==null?void 0:E.duration;x&8&&(x&2?I=Pe(g,12):I=Pe(g,8));for(var R=p.timescale||9e4,_=we(h,["trun"]),P=0;P<_.length;P++){if(o=Cc(_[P]),!o&&I){var O=Pe(_[P],4);o=I*O}p.type===Ve.VIDEO?s+=o/R:p.type===Ve.AUDIO&&(t+=o/R)}}}if(s===0&&t===0){for(var N=1/0,U=0,B=0,G=we(u,["sidx"]),Y=0;Y<G.length;Y++){var V=Ic(G[Y]);if(V!=null&&V.references){N=Math.min(N,V.earliestPresentationTime/V.timescale);var j=V.references.reduce(function(ae,X){return ae+X.info.duration||0},0);U=Math.max(U,j+V.earliestPresentationTime/V.timescale),B=U-N}}if(B&&ue(B))return B}return s||t}function Cc(u){var d=Pe(u,0),o=8;d&1&&(o+=4),d&4&&(o+=4);for(var s=0,t=Pe(u,4),i=0;i<t;i++){if(d&256){var a=Pe(u,o);s+=a,o+=4}d&512&&(o+=4),d&1024&&(o+=4),d&2048&&(o+=4)}return s}function Pc(u,d,o){we(d,["moof","traf"]).forEach(function(s){we(s,["tfhd"]).forEach(function(t){var i=Pe(t,4),a=u[i];if(a){var h=a.timescale||9e4;we(s,["tfdt"]).forEach(function(g){var m=g[0],p=o*h;if(p){var E=Pe(g,4);if(m===0)E-=p,E=Math.max(E,0),Fn(g,4,E);else{E*=Math.pow(2,32),E+=Pe(g,8),E-=p,E=Math.max(E,0);var x=Math.floor(E/(Wr+1)),I=Math.floor(E%(Wr+1));Fn(g,4,x),Fn(g,8,I)}}})}})})}function kc(u){var d={valid:null,remainder:null},o=we(u,["moof"]);if(o.length<2)return d.remainder=u,d;var s=o[o.length-1];return d.valid=u.slice(0,s.byteOffset-8),d.remainder=u.slice(s.byteOffset-8),d}function Yt(u,d){var o=new Uint8Array(u.length+d.length);return o.set(u),o.set(d,u.length),o}function cl(u,d){var o=[],s=d.samples,t=d.timescale,i=d.id,a=!1,h=we(s,["moof"]);return h.map(function(g){var m=g.byteOffset-8,p=we(g,["traf"]);p.map(function(E){var x=we(E,["tfdt"]).map(function(I){var R=I[0],_=Pe(I,4);return R===1&&(_*=Math.pow(2,32),_+=Pe(I,8)),_/t})[0];return x!==void 0&&(u=x),we(E,["tfhd"]).map(function(I){var R=Pe(I,4),_=Pe(I,0)&16777215,P=(_&1)!==0,O=(_&2)!==0,N=(_&8)!==0,U=0,B=(_&16)!==0,G=0,Y=(_&32)!==0,V=8;R===i&&(P&&(V+=8),O&&(V+=4),N&&(U=Pe(I,V),V+=4),B&&(G=Pe(I,V),V+=4),Y&&(V+=4),d.type==="video"&&(a=ds(d.codec)),we(E,["trun"]).map(function(j){var ae=j[0],X=Pe(j,0)&16777215,W=(X&1)!==0,J=0,oe=(X&4)!==0,ge=(X&256)!==0,ce=0,he=(X&512)!==0,ye=0,Se=(X&1024)!==0,Le=(X&2048)!==0,Ie=0,He=Pe(j,4),Oe=8;W&&(J=Pe(j,Oe),Oe+=4),oe&&(Oe+=4);for(var je=J+m,Fe=0;Fe<He;Fe++){if(ge?(ce=Pe(j,Oe),Oe+=4):ce=U,he?(ye=Pe(j,Oe),Oe+=4):ye=G,Se&&(Oe+=4),Le&&(ae===0?Ie=Pe(j,Oe):Ie=hl(j,Oe),Oe+=4),d.type===Ve.VIDEO)for(var Xe=0;Xe<ye;){var ze=Pe(s,je);if(je+=4,wc(a,s[je])){var it=s.subarray(je,je+ze);Un(it,a?2:1,u+Ie/t,o)}je+=ze,Xe+=ze+4}u+=ce/t}}))})})}),o}function ds(u){if(!u)return!1;var d=u.substring(0,4);return d==="hvc1"||d==="hev1"||d==="dvh1"||d==="dvhe"}function wc(u,d){if(u){var o=d>>1&63;return o===39||o===40}else{var s=d&31;return s===6}}function Un(u,d,o,s){var t=gl(u),i=0;i+=d;for(var a=0,h=0,g=0;i<t.length;){a=0;do{if(i>=t.length)break;g=t[i++],a+=g}while(g===255);h=0;do{if(i>=t.length)break;g=t[i++],h+=g}while(g===255);var m=t.length-i,p=i;if(h<m)i+=h;else if(h>m){Ye.error("Malformed SEI payload. "+h+" is too small, only "+m+" bytes left to parse.");break}if(a===4){var E=t[p++];if(E===181){var x=ll(t,p);if(p+=2,x===49){var I=Pe(t,p);if(p+=4,I===1195456820){var R=t[p++];if(R===3){var _=t[p++],P=31&_,O=64&_,N=O?2+P*3:0,U=new Uint8Array(N);if(O){U[0]=_;for(var B=1;B<N;B++)U[B]=t[p++]}s.push({type:R,payloadType:a,pts:o,bytes:U})}}}}}else if(a===5&&h>16){for(var G=[],Y=0;Y<16;Y++){var V=t[p++].toString(16);G.push(V.length==1?"0"+V:V),(Y===3||Y===5||Y===7||Y===9)&&G.push("-")}for(var j=h-16,ae=new Uint8Array(j),X=0;X<j;X++)ae[X]=t[p++];s.push({payloadType:a,pts:o,uuid:G.join(""),userData:mt(ae),userDataBytes:ae})}}}function gl(u){for(var d=u.byteLength,o=[],s=1;s<d-2;)u[s]===0&&u[s+1]===0&&u[s+2]===3?(o.push(s+2),s+=2):s++;if(o.length===0)return u;var t=d-o.length,i=new Uint8Array(t),a=0;for(s=0;s<t;a++,s++)a===o[0]&&(a++,o.shift()),i[s]=u[a];return i}function Oc(u){var d=u[0],o="",s="",t=0,i=0,a=0,h=0,g=0,m=0;if(d===0){for(;At(u.subarray(m,m+1))!=="\0";)o+=At(u.subarray(m,m+1)),m+=1;for(o+=At(u.subarray(m,m+1)),m+=1;At(u.subarray(m,m+1))!=="\0";)s+=At(u.subarray(m,m+1)),m+=1;s+=At(u.subarray(m,m+1)),m+=1,t=Pe(u,12),i=Pe(u,16),h=Pe(u,20),g=Pe(u,24),m=28}else if(d===1){m+=4,t=Pe(u,m),m+=4;var p=Pe(u,m);m+=4;var E=Pe(u,m);for(m+=4,a=Math.pow(2,32)*p+E,Re(a)||(a=Number.MAX_SAFE_INTEGER,Ye.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),h=Pe(u,m),m+=4,g=Pe(u,m),m+=4;At(u.subarray(m,m+1))!=="\0";)o+=At(u.subarray(m,m+1)),m+=1;for(o+=At(u.subarray(m,m+1)),m+=1;At(u.subarray(m,m+1))!=="\0";)s+=At(u.subarray(m,m+1)),m+=1;s+=At(u.subarray(m,m+1)),m+=1}var x=u.subarray(m,u.byteLength);return{schemeIdUri:o,value:s,timeScale:t,presentationTime:a,presentationTimeDelta:i,eventDuration:h,id:g,payload:x}}function Mc(u){for(var d=arguments.length,o=new Array(d>1?d-1:0),s=1;s<d;s++)o[s-1]=arguments[s];for(var t=o.length,i=8,a=t;a--;)i+=o[a].byteLength;var h=new Uint8Array(i);for(h[0]=i>>24&255,h[1]=i>>16&255,h[2]=i>>8&255,h[3]=i&255,h.set(u,4),a=0,i=8;a<t;a++)h.set(o[a],i),i+=o[a].byteLength;return h}function Fc(u,d,o){if(u.byteLength!==16)throw new RangeError("Invalid system id");var s,t;s=0,t=new Uint8Array;var i;s>0?(i=new Uint8Array(4),d.length>0&&new DataView(i.buffer).setUint32(0,d.length,!1)):i=new Uint8Array;var a=new Uint8Array(4);return o&&o.byteLength>0&&new DataView(a.buffer).setUint32(0,o.byteLength,!1),Mc([112,115,115,104],new Uint8Array([s,0,0,0]),u,i,t,a,o||new Uint8Array)}function Nc(u){var d=[];if(u instanceof ArrayBuffer)for(var o=u.byteLength,s=0;s+32<o;){var t=new DataView(u,s),i=Uc(t);d.push(i),s+=i.size}return d}function Uc(u){var d=u.getUint32(0),o=u.byteOffset,s=u.byteLength;if(s<d)return{offset:o,size:s};var t=u.getUint32(4);if(t!==1886614376)return{offset:o,size:d};var i=u.getUint32(8)>>>24;if(i!==0&&i!==1)return{offset:o,size:d};var a=u.buffer,h=dt.hexDump(new Uint8Array(a,o+12,16)),g=u.getUint32(28),m=null,p=null;if(i===0){if(d-32<g||g<22)return{offset:o,size:d};p=new Uint8Array(a,o+32,g)}else if(i===1){if(!g||s<o+32+g*16+16)return{offset:o,size:d};m=[];for(var E=0;E<g;E++)m.push(new Uint8Array(a,o+32+E*16,16))}return{version:i,systemId:h,kids:m,data:p,offset:o,size:d}}var vl=function(){return/\(Windows.+Firefox\//i.test(navigator.userAgent)},ai={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function ml(u,d){var o=ai[d];return!!o&&!!o[u.slice(0,4)]}function Bn(u,d,o){return o===void 0&&(o=!0),!u.split(",").some(function(s){return!pl(s,d,o)})}function pl(u,d,o){var s;o===void 0&&(o=!0);var t=Ue(o);return(s=t==null?void 0:t.isTypeSupported(Oi(u,d)))!=null?s:!1}function Oi(u,d){return d+"/mp4;codecs="+u}function yl(u){if(u){var d=u.substring(0,4);return ai.video[d]}return 2}function cs(u){var d=vl();return u.split(",").reduce(function(o,s){var t=d&&ds(s),i=t?9:ai.video[s];return i?(i*2+o)/(o?3:2):(ai.audio[s]+o)/(o?2:1)},0)}var Gn={};function Bc(u,d){if(d===void 0&&(d=!0),Gn[u])return Gn[u];for(var o={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[u],s=0;s<o.length;s++){var t;if(pl(o[s],"audio",d))return Gn[u]=o[s],o[s];if(o[s]==="mp3"&&(t=Ue(d))!=null&&t.isTypeSupported("audio/mpeg"))return""}return u}var Gc=/flac|opus|mp4a\.40\.34/i;function gs(u,d){return d===void 0&&(d=!0),u.replace(Gc,function(o){return Bc(o.toLowerCase(),d)})}function $c(u,d){var o=[];if(u)for(var s=u.split(","),t=0;t<s.length;t++)ml(s[t],"video")||o.push(s[t]);return d&&o.push(d),o.join(",")}function vs(u,d){if(u&&(u.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(u)!==-1))return u;if(d){var o=d.split(",");if(o.length>1){if(u){for(var s=o.length;s--;)if(o[s].substring(0,4)===u.substring(0,4))return o[s]}return o[0]}}return d||u}function Kc(u){for(var d=u.split(","),o=0;o<d.length;o++){var s=d[o].split(".");if(s.length>2){var t=s.shift()+".";t+=parseInt(s.shift()).toString(16),t+=("000"+parseInt(s.shift()).toString(16)).slice(-4),d[o]=t}}return d.join(",")}function Vc(u){if(u.startsWith("av01.")){for(var d=u.split("."),o=["0","111","01","01","01","0"],s=d.length;s>4&&s<10;s++)d[s]=o[s-4];return d.join(".")}return u}function El(u){var d=Ue(u)||{isTypeSupported:function(){return!1}};return{mpeg:d.isTypeSupported("audio/mpeg"),mp3:d.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:d.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Tl(u){return u.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}var Sl={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function Al(u,d){return{supported:!1,configurations:d,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:u}}var xl={};function Hc(u,d,o,s,t,i){var a=u.audioCodec?u.audioGroups:null,h=i==null?void 0:i.audioCodec,g=i==null?void 0:i.channels,m=g?parseInt(g):h?1/0:2,p=null;if(a!=null&&a.length)try{a.length===1&&a[0]?p=d.groups[a[0]].channels:p=a.reduce(function(E,x){if(x){var I=d.groups[x];if(!I)throw new Error("Audio track group "+x+" not found");Object.keys(I.channels).forEach(function(R){E[R]=(E[R]||0)+I.channels[R]})}return E},{2:0})}catch{return!0}return u.videoCodec!==void 0&&(u.width>1920&&u.height>1088||u.height>1920&&u.width>1088||u.frameRate>Math.max(s,30)||u.videoRange!=="SDR"&&u.videoRange!==o||u.bitrate>Math.max(t,8e6))||!!p&&ue(m)&&Object.keys(p).some(function(E){return parseInt(E)>m})}function Ll(u,d,o){var s=u.videoCodec,t=u.audioCodec;if(!s&&!t||!o)return Promise.resolve(Sl);var i=[];if(s){var a={width:u.width,height:u.height,bitrate:Math.ceil(Math.max(u.bitrate*.9,u.averageBitrate)),framerate:u.frameRate||30},h=u.videoRange;h!=="SDR"&&(a.transferFunction=h.toLowerCase());var g=s.split(","),m=navigator.userAgent;if(g.some(function(p){return ds(p)})&&vl())return Promise.resolve(Al(new Error("Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: ("+m+")"),i));i.push.apply(i,g.map(function(p){return{type:"media-source",video:F(F({},a),{},{contentType:Oi(Vc(p),"video")})}}))}return t&&u.audioGroups&&u.audioGroups.forEach(function(p){var E;p&&((E=d.groups[p])==null||E.tracks.forEach(function(x){if(x.groupId===p){var I=x.channels||"",R=parseFloat(I);ue(R)&&R>2&&i.push.apply(i,t.split(",").map(function(_){return{type:"media-source",audio:{contentType:Oi(_,"audio"),channels:""+R}}}))}}))}),Promise.all(i.map(function(p){var E=Yc(p);return xl[E]||(xl[E]=o.decodingInfo(p))})).then(function(p){return{supported:!p.some(function(E){return!E.supported}),configurations:i,decodingInfoResults:p}}).catch(function(p){return{supported:!1,configurations:i,decodingInfoResults:[],error:p}})}function Yc(u){var d=u.audio,o=u.video,s=o||d;if(s){var t=Tl(s.contentType);if(o)return"r"+o.height+"x"+o.width+"f"+Math.ceil(o.framerate)+(o.transferFunction||"sd")+"_"+t+"_"+Math.ceil(o.bitrate/1e5);if(d)return"c"+d.channels+(d.spatialRendering?"s":"n")+"_"+t}return""}var $n=["NONE","TYPE-0","TYPE-1",null];function Wc(u){return $n.indexOf(u)>-1}var ms=["SDR","PQ","HLG"];function qc(u){return!!u&&ms.indexOf(u)>-1}var ps={No:"",Yes:"YES",v2:"v2"};function Il(u){var d=u.canSkipUntil,o=u.canSkipDateRanges,s=u.age,t=s<d/2;return d&&t?o?ps.v2:ps.Yes:ps.No}var Rl=function(){function u(o,s,t){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=o,this.part=s,this.skip=t}var d=u.prototype;return d.addDirectives=function(s){var t=new self.URL(s);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href},u}(),Mi=function(){function u(o){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[o.url],this._attrs=[o.attrs],this.bitrate=o.bitrate,o.details&&(this.details=o.details),this.id=o.id||0,this.name=o.name,this.width=o.width||0,this.height=o.height||0,this.frameRate=o.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=o.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=o.audioCodec,this.videoCodec=o.videoCodec,this.codecSet=[o.videoCodec,o.audioCodec].filter(function(i){return!!i}).map(function(i){return i.substring(0,4)}).join(","),"supplemental"in o){var s;this.supplemental=o.supplemental;var t=(s=o.supplemental)==null?void 0:s.videoCodec;t&&t!==o.videoCodec&&(this.codecSet+=","+t.substring(0,4))}this.addGroupId("audio",o.attrs.AUDIO),this.addGroupId("text",o.attrs.SUBTITLES)}var d=u.prototype;return d.hasAudioGroup=function(s){return bl(this._audioGroups,s)},d.hasSubtitleGroup=function(s){return bl(this._subtitleGroups,s)},d.addGroupId=function(s,t){if(t){if(s==="audio"){var i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(s==="text"){var a=this._subtitleGroups;a||(a=this._subtitleGroups=[]),a.indexOf(t)===-1&&a.push(t)}}},d.addFallback=function(){},y(u,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"averageBitrate",get:function(){return this._avgBitrate||this.realBitrate||this.bitrate}},{key:"attrs",get:function(){return this._attrs[0]}},{key:"codecs",get:function(){return this.attrs.CODECS||""}},{key:"pathwayId",get:function(){return this.attrs["PATHWAY-ID"]||"."}},{key:"videoRange",get:function(){return this.attrs["VIDEO-RANGE"]||"SDR"}},{key:"score",get:function(){return this.attrs.optionalFloat("SCORE",0)}},{key:"uri",get:function(){return this.url[0]||""}},{key:"audioGroups",get:function(){return this._audioGroups}},{key:"subtitleGroups",get:function(){return this._subtitleGroups}},{key:"urlId",get:function(){return 0},set:function(s){}},{key:"audioGroupIds",get:function(){return this.audioGroups?[this.audioGroupId]:void 0}},{key:"textGroupIds",get:function(){return this.subtitleGroups?[this.textGroupId]:void 0}},{key:"audioGroupId",get:function(){var s;return(s=this.audioGroups)==null?void 0:s[0]}},{key:"textGroupId",get:function(){var s;return(s=this.subtitleGroups)==null?void 0:s[0]}}])}();function bl(u,d){return!d||!u?!1:u.indexOf(d)!==-1}function jc(){if(typeof matchMedia=="function"){var u=matchMedia("(dynamic-range: high)"),d=matchMedia("bad query");if(u.media!==d.media)return u.matches===!0}return!1}function Xc(u,d){var o=!1,s=[];if(u&&(o=u!=="SDR",s=[u]),d){s=d.allowedVideoRanges||ms.slice(0);var t=s.join("")!=="SDR"&&!d.videoCodec;o=d.preferHDR!==void 0?d.preferHDR:t&&jc(),o||(s=["SDR"])}return{preferHDR:o,allowedVideoRanges:s}}var zc=function(d){var o=new WeakSet;return function(s,t){if(d&&(t=d(s,t)),typeof t=="object"&&t!==null){if(o.has(t))return;o.add(t)}return t}},at=function(d,o){return JSON.stringify(d,zc(o))};function Qc(u,d,o,s,t){for(var i=Object.keys(u),a=s==null?void 0:s.channels,h=s==null?void 0:s.audioCodec,g=t==null?void 0:t.videoCodec,m=a&&parseInt(a)===2,p=!1,E=!1,x=1/0,I=1/0,R=1/0,_=1/0,P=0,O=[],N=Xc(d,t),U=N.preferHDR,B=N.allowedVideoRanges,G=function(){var J=u[i[Y]];p||(p=J.channels[2]>0),x=Math.min(x,J.minHeight),I=Math.min(I,J.minFramerate),R=Math.min(R,J.minBitrate);var oe=B.filter(function(ge){return J.videoRanges[ge]>0});oe.length>0&&(E=!0)},Y=i.length;Y--;)G();x=ue(x)?x:0,I=ue(I)?I:0;var V=Math.max(1080,x),j=Math.max(30,I);R=ue(R)?R:o,o=Math.max(R,o),E||(d=void 0);var ae=i.length>1,X=i.reduce(function(W,J){var oe=u[J];if(J===W)return W;if(O=E?B.filter(function(ge){return oe.videoRanges[ge]>0}):[],ae){if(oe.minBitrate>o)return ar(J,"min bitrate of "+oe.minBitrate+" > current estimate of "+o),W;if(!oe.hasDefaultAudio)return ar(J,"no renditions with default or auto-select sound found"),W;if(h&&J.indexOf(h.substring(0,4))%5!==0)return ar(J,'audio codec preference "'+h+'" not found'),W;if(a&&!m){if(!oe.channels[a])return ar(J,"no renditions with "+a+" channel sound found (channels options: "+Object.keys(oe.channels)+")"),W}else if((!h||m)&&p&&oe.channels[2]===0)return ar(J,"no renditions with stereo sound found"),W;if(oe.minHeight>V)return ar(J,"min resolution of "+oe.minHeight+" > maximum of "+V),W;if(oe.minFramerate>j)return ar(J,"min framerate of "+oe.minFramerate+" > maximum of "+j),W;if(!O.some(function(ge){return oe.videoRanges[ge]>0}))return ar(J,"no variants with VIDEO-RANGE of "+at(O)+" found"),W;if(g&&J.indexOf(g.substring(0,4))%5!==0)return ar(J,'video codec preference "'+g+'" not found'),W;if(oe.maxScore<P)return ar(J,"max score of "+oe.maxScore+" < selected max of "+P),W}return W&&(cs(J)>=cs(W)||oe.fragmentError>u[W].fragmentError)?W:(_=oe.minIndex,P=oe.maxScore,J)},void 0);return{codecSet:X,videoRanges:O,preferHDR:U,minFramerate:I,minBitrate:R,minIndex:_}}function ar(u,d){Ye.log('[abr] start candidates with "'+u+'" ignored because '+d)}function _l(u){return u.reduce(function(d,o){var s=d.groups[o.groupId];s||(s=d.groups[o.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),s.tracks.push(o);var t=o.channels||"2";return s.channels[t]=(s.channels[t]||0)+1,s.hasDefault=s.hasDefault||o.default,s.hasAutoSelect=s.hasAutoSelect||o.autoselect,s.hasDefault&&(d.hasDefaultAudio=!0),s.hasAutoSelect&&(d.hasAutoSelectAudio=!0),d},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Zc(u,d,o,s){return u.slice(o,s+1).reduce(function(t,i,a){if(!i.codecSet)return t;var h=i.audioGroups,g=t[i.codecSet];g||(t[i.codecSet]=g={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:a,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!h,fragmentError:0}),g.minBitrate=Math.min(g.minBitrate,i.bitrate);var m=Math.min(i.height,i.width);return g.minHeight=Math.min(g.minHeight,m),g.minFramerate=Math.min(g.minFramerate,i.frameRate),g.minIndex=Math.min(g.minIndex,a),g.maxScore=Math.max(g.maxScore,i.score),g.fragmentError+=i.fragmentError,g.videoRanges[i.videoRange]=(g.videoRanges[i.videoRange]||0)+1,h&&h.forEach(function(p){if(p){var E=d.groups[p];E&&(g.hasDefaultAudio=g.hasDefaultAudio||d.hasDefaultAudio?E.hasDefault:E.hasAutoSelect||!d.hasDefaultAudio&&!d.hasAutoSelectAudio,Object.keys(E.channels).forEach(function(x){g.channels[x]=(g.channels[x]||0)+E.channels[x]}))}}),t},{})}function Dl(u){if(!u)return u;var d=u,o=d.lang,s=d.assocLang,t=d.characteristics,i=d.channels,a=d.audioCodec;return{lang:o,assocLang:s,characteristics:t,channels:i,audioCodec:a}}function or(u,d,o){if("attrs"in u){var s=d.indexOf(u);if(s!==-1)return s}for(var t=0;t<d.length;t++){var i=d[t];if(qr(u,i,o))return t}return-1}function qr(u,d,o){var s=u.groupId,t=u.name,i=u.lang,a=u.assocLang,h=u.default,g=u.forced;return(s===void 0||d.groupId===s)&&(t===void 0||d.name===t)&&(i===void 0||Jc(i,d.lang))&&(i===void 0||d.assocLang===a)&&(h===void 0||d.default===h)&&(g===void 0||d.forced===g)&&(!("characteristics"in u)||eg(u.characteristics||"",d.characteristics))&&(o===void 0||o(u,d))}function Jc(u,d){return d===void 0&&(d="--"),u.length===d.length?u===d:u.startsWith(d)||d.startsWith(u)}function eg(u,d){d===void 0&&(d="");var o=u.split(","),s=d.split(",");return o.length===s.length&&!o.some(function(t){return s.indexOf(t)===-1})}function jr(u,d){var o=u.audioCodec,s=u.channels;return(o===void 0||(d.audioCodec||"").substring(0,4)===o.substring(0,4))&&(s===void 0||s===(d.channels||"2"))}function tg(u,d,o,s,t){var i=d[s],a=d.reduce(function(x,I,R){var _=I.uri,P=x[_]||(x[_]=[]);return P.push(R),x},{}),h=a[i.uri];h.length>1&&(s=Math.max.apply(Math,h));var g=i.videoRange,m=i.frameRate,p=i.codecSet.substring(0,4),E=Cl(d,s,function(x){if(x.videoRange!==g||x.frameRate!==m||x.codecSet.substring(0,4)!==p)return!1;var I=x.audioGroups,R=o.filter(function(_){return!I||I.indexOf(_.groupId)!==-1});return or(u,R,t)>-1});return E>-1?E:Cl(d,s,function(x){var I=x.audioGroups,R=o.filter(function(_){return!I||I.indexOf(_.groupId)!==-1});return or(u,R,t)>-1})}function Cl(u,d,o){for(var s=d;s>-1;s--)if(o(u[s]))return s;for(var t=d+1;t<u.length;t++)if(o(u[t]))return t;return-1}function ys(u,d){var o;return!!u&&u!==((o=d.loadLevelObj)==null?void 0:o.uri)}var rg=function(u){function d(s){var t;return t=u.call(this,"abr",s.logger)||this,t.hls=void 0,t.lastLevelLoadSec=0,t.lastLoadedFragLevel=-1,t.firstSelection=-1,t._nextAutoLevel=-1,t.nextAutoLevelKey="",t.audioTracksByGroup=null,t.codecTiers=null,t.timer=-1,t.fragCurrent=null,t.partCurrent=null,t.bitrateTestDelay=0,t.rebufferNotice=-1,t.bwEstimator=void 0,t._abandonRulesCheck=function(i){var a,h=t,g=h.fragCurrent,m=h.partCurrent,p=h.hls,E=p.autoLevelEnabled,x=p.media;if(!(!g||!x)){var I=performance.now(),R=m?m.stats:g.stats,_=m?m.duration:g.duration,P=I-R.loading.start,O=p.minAutoLevel,N=g.level,U=t._nextAutoLevel;if(R.aborted||R.loaded&&R.loaded===R.total||N<=O){t.clearTimer(),t._nextAutoLevel=-1;return}if(E){var B=U>-1&&U!==N,G=!!i||B;if(!(!G&&(x.paused||!x.playbackRate||!x.readyState))){var Y=p.mainForwardBufferInfo;if(!(!G&&Y===null)){var V=t.bwEstimator.getEstimateTTFB(),j=Math.abs(x.playbackRate);if(!(P<=Math.max(V,1e3*(_/(j*2))))){var ae=Y?Y.len/j:0,X=R.loading.first?R.loading.first-R.loading.start:-1,W=R.loaded&&X>-1,J=t.getBwEstimate(),oe=p.levels,ge=oe[N],ce=Math.max(R.loaded,Math.round(_*(g.bitrate||ge.averageBitrate)/8)),he=W?P-X:P;he<1&&W&&(he=Math.min(P,R.loaded*8/J));var ye=W?R.loaded*1e3/he:0,Se=V/1e3,Le=ye?(ce-R.loaded)/ye:ce*8/J+Se;if(!(Le<=ae)){var Ie=ye?ye*8:J,He=((a=(i==null?void 0:i.details)||t.hls.latestLevelDetails)==null?void 0:a.live)===!0,Oe=t.hls.config.abrBandWidthUpFactor,je=Number.POSITIVE_INFINITY,Fe;for(Fe=N-1;Fe>O;Fe--){var Xe=oe[Fe].maxBitrate,ze=!oe[Fe].details||He;if(je=t.getTimeToLoadFrag(Se,Ie,_*Xe,ze),je<Math.min(ae,_+Se))break}if(!(je>=Le)&&!(je>_*10)){W?t.bwEstimator.sample(P-Math.min(V,X),R.loaded):t.bwEstimator.sampleTTFB(P);var it=oe[Fe].maxBitrate;t.getBwEstimate()*Oe>it&&t.resetEstimator(it);var yt=t.findBestLevel(it,O,Fe,0,ae,1,1);yt>-1&&(Fe=yt),t.warn("Fragment "+g.sn+(m?" part "+m.index:"")+" of level "+N+` is loading too slowly;
      Fragment duration: `+g.duration.toFixed(3)+`
      Time to underbuffer: `+ae.toFixed(3)+` s
      Estimated load time for current fragment: `+Le.toFixed(3)+` s
      Estimated load time for down switch fragment: `+je.toFixed(3)+` s
      TTFB estimate: `+(X|0)+` ms
      Current BW estimate: `+(ue(J)?J|0:"Unknown")+` bps
      New BW estimate: `+(t.getBwEstimate()|0)+` bps
      Switching to level `+Fe+" @ "+(it|0)+" bps"),p.nextLoadLevel=p.nextAutoLevel=Fe,t.clearTimer();var gt=function(){if(t.clearTimer(),t.fragCurrent===g&&t.hls.loadLevel===Fe&&Fe>0){var Et=t.getStarvationDelay();if(t.warn("Aborting inflight request "+(Fe>0?"and switching down":"")+`
      Fragment duration: `+g.duration.toFixed(3)+` s
      Time to underbuffer: `+Et.toFixed(3)+" s"),g.abortRequests(),t.fragCurrent=t.partCurrent=null,Fe>O){var ut=t.findBestLevel(t.hls.levels[O].bitrate,O,Fe,0,Et,1,1);ut===-1&&(ut=O),t.hls.nextLoadLevel=t.hls.nextAutoLevel=ut,t.resetEstimator(t.hls.levels[ut].bitrate)}}};B||Le>je*2?gt():t.timer=self.setInterval(gt,je*1e3),p.trigger(k.FRAG_LOAD_EMERGENCY_ABORTED,{frag:g,part:m,stats:R})}}}}}}}},t.hls=s,t.bwEstimator=t.initEstimator(),t.registerListeners(),t}b(d,u);var o=d.prototype;return o.resetEstimator=function(t){t&&(this.log("setting initial bwe to "+t),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()},o.initEstimator=function(){var t=this.hls.config;return new et(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)},o.registerListeners=function(){var t=this.hls;t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.FRAG_LOADING,this.onFragLoading,this),t.on(k.FRAG_LOADED,this.onFragLoaded,this),t.on(k.FRAG_BUFFERED,this.onFragBuffered,this),t.on(k.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(k.LEVEL_LOADED,this.onLevelLoaded,this),t.on(k.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(k.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(k.ERROR,this.onError,this)},o.unregisterListeners=function(){var t=this.hls;t&&(t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.FRAG_LOADING,this.onFragLoading,this),t.off(k.FRAG_LOADED,this.onFragLoaded,this),t.off(k.FRAG_BUFFERED,this.onFragBuffered,this),t.off(k.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(k.LEVEL_LOADED,this.onLevelLoaded,this),t.off(k.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(k.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(k.ERROR,this.onError,this))},o.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null},o.onManifestLoading=function(t,i){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()},o.onLevelsUpdated=function(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null},o.onMaxAutoLevelUpdated=function(){this.firstSelection=-1,this.nextAutoLevelKey=""},o.onFragLoading=function(t,i){var a=i.frag;if(!this.ignoreFragment(a)){if(!a.bitrateTest){var h;this.fragCurrent=a,this.partCurrent=(h=i.part)!=null?h:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}},o.onLevelSwitching=function(t,i){this.clearTimer()},o.onError=function(t,i){if(!i.fatal)switch(i.details){case q.BUFFER_ADD_CODEC_ERROR:case q.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case q.FRAG_LOAD_TIMEOUT:{var a=i.frag,h=this.fragCurrent,g=this.partCurrent;if(a&&h&&a.sn===h.sn&&a.level===h.level){var m=performance.now(),p=g?g.stats:a.stats,E=m-p.loading.start,x=p.loading.first?p.loading.first-p.loading.start:-1,I=p.loaded&&x>-1;if(I){var R=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(E-Math.min(R,x),p.loaded)}else this.bwEstimator.sampleTTFB(E)}break}}},o.getTimeToLoadFrag=function(t,i,a,h){var g=t+a/i,m=h?t+this.lastLevelLoadSec:0;return g+m},o.onLevelLoaded=function(t,i){var a=this.hls.config,h=i.stats.loading,g=h.end-h.first;ue(g)&&(this.lastLevelLoadSec=g/1e3),i.details.live?this.bwEstimator.update(a.abrEwmaSlowLive,a.abrEwmaFastLive):this.bwEstimator.update(a.abrEwmaSlowVoD,a.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(i.levelInfo)},o.onFragLoaded=function(t,i){var a=i.frag,h=i.part,g=h?h.stats:a.stats;if(a.type===pe.MAIN&&this.bwEstimator.sampleTTFB(g.loading.first-g.loading.start),!this.ignoreFragment(a)){if(this.clearTimer(),a.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){var m=h?h.duration:a.duration,p=this.hls.levels[a.level],E=(p.loaded?p.loaded.bytes:0)+g.loaded,x=(p.loaded?p.loaded.duration:0)+m;p.loaded={bytes:E,duration:x},p.realBitrate=Math.round(8*E/x)}if(a.bitrateTest){var I={stats:g,frag:a,part:h,id:a.type};this.onFragBuffered(k.FRAG_BUFFERED,I),a.bitrateTest=!1}else this.lastLoadedFragLevel=a.level}},o.onFragBuffered=function(t,i){var a=i.frag,h=i.part,g=h!=null&&h.stats.loaded?h.stats:a.stats;if(!g.aborted&&!this.ignoreFragment(a)){var m=g.parsing.end-g.loading.start-Math.min(g.loading.first-g.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(m,g.loaded),g.bwEstimate=this.getBwEstimate(),a.bitrateTest?this.bitrateTestDelay=m/1e3:this.bitrateTestDelay=0}},o.ignoreFragment=function(t){return t.type!==pe.MAIN||t.sn==="initSegment"},o.clearTimer=function(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)},o.getAutoLevelKey=function(){return this.getBwEstimate()+"_"+this.getStarvationDelay().toFixed(2)},o.getNextABRAutoLevel=function(){var t=this.fragCurrent,i=this.partCurrent,a=this.hls;if(a.levels.length<=1)return a.loadLevel;var h=a.maxAutoLevel,g=a.config,m=a.minAutoLevel,p=i?i.duration:t?t.duration:0,E=this.getBwEstimate(),x=this.getStarvationDelay(),I=g.abrBandWidthFactor,R=g.abrBandWidthUpFactor;if(x){var _=this.findBestLevel(E,m,h,x,0,I,R);if(_>=0)return this.rebufferNotice=-1,_}var P=p?Math.min(p,g.maxStarvationDelay):g.maxStarvationDelay;if(!x){var O=this.bitrateTestDelay;if(O){var N=p?Math.min(p,g.maxLoadingDelay):g.maxLoadingDelay;P=N-O,this.info("bitrate test took "+Math.round(1e3*O)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*P)+" ms"),I=R=1}}var U=this.findBestLevel(E,m,h,x,P,I,R);if(this.rebufferNotice!==U&&(this.rebufferNotice=U,this.info((x?"rebuffering expected":"buffer is empty")+", optimal quality level "+U)),U>-1)return U;var B=a.levels[m],G=a.loadLevelObj;return G&&(B==null?void 0:B.bitrate)<G.bitrate?m:a.loadLevel},o.getStarvationDelay=function(){var t=this.hls,i=t.media;if(!i)return 1/0;var a=i&&i.playbackRate!==0?Math.abs(i.playbackRate):1,h=t.mainForwardBufferInfo;return(h?h.len:0)/a},o.getBwEstimate=function(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate},o.findBestLevel=function(t,i,a,h,g,m,p){var E,x=this,I=h+g,R=this.lastLoadedFragLevel,_=R===-1?this.hls.firstLevel:R,P=this.fragCurrent,O=this.partCurrent,N=this.hls,U=N.levels,B=N.allAudioTracks,G=N.loadLevel,Y=N.config;if(U.length===1)return 0;var V=U[_],j=!!((E=this.hls.latestLevelDetails)!=null&&E.live),ae=G===-1||R===-1,X,W="SDR",J=(V==null?void 0:V.frameRate)||0,oe=Y.audioPreference,ge=Y.videoPreference,ce=this.audioTracksByGroup||(this.audioTracksByGroup=_l(B)),he=-1;if(ae){if(this.firstSelection!==-1)return this.firstSelection;var ye=this.codecTiers||(this.codecTiers=Zc(U,ce,i,a)),Se=Qc(ye,W,t,oe,ge),Le=Se.codecSet,Ie=Se.videoRanges,He=Se.minFramerate,Oe=Se.minBitrate,je=Se.minIndex,Fe=Se.preferHDR;he=je,X=Le,W=Fe?Ie[Ie.length-1]:Ie[0],J=He,t=Math.max(t,Oe),this.log("picked start tier "+at(Se))}else X=V==null?void 0:V.codecSet,W=V==null?void 0:V.videoRange;for(var Xe=O?O.duration:P?P.duration:0,ze=this.bwEstimator.getEstimateTTFB()/1e3,it=[],yt=function(){var ut,Ge=U[nt],Mt=nt>_;if(!Ge)return 0;if(Y.useMediaCapabilities&&!Ge.supportedResult&&!Ge.supportedPromise){var Dt=navigator.mediaCapabilities;typeof(Dt==null?void 0:Dt.decodingInfo)=="function"&&(Hc(Ge,ce,W,J,t,oe)||ds(Ge.videoCodec))?(Ge.supportedPromise=Ll(Ge,ce,Dt),Ge.supportedPromise.then(function(jt){if(x.hls){Ge.supportedResult=jt;var mi=x.hls.levels,er=mi.indexOf(Ge);jt.error?x.warn('MediaCapabilities decodingInfo error: "'+jt.error+'" for level '+er+" "+at(jt)):jt.supported||(x.warn("Unsupported MediaCapabilities decodingInfo result for level "+er+" "+at(jt)),er>-1&&mi.length>1&&(x.log("Removing unsupported level "+er),x.hls.removeLevel(er),x.hls.loadLevel===-1&&(x.hls.nextLoadLevel=0)))}})):Ge.supportedResult=Sl}if((X&&Ge.codecSet!==X||W&&Ge.videoRange!==W||Mt&&J>Ge.frameRate||!Mt&&J>0&&J<Ge.frameRate||Ge.supportedResult&&!((ut=Ge.supportedResult.decodingInfoResults)!=null&&ut[0].smooth))&&(!ae||nt!==he))return it.push(nt),0;var Lt=Ge.details,vt=(O?Lt==null?void 0:Lt.partTarget:Lt==null?void 0:Lt.averagetargetduration)||Xe,St;Mt?St=p*t:St=m*t;var ht=Xe&&h>=Xe*2&&g===0?Ge.averageBitrate:Ge.maxBitrate,Tt=x.getTimeToLoadFrag(ze,St,ht*vt,Lt===void 0),fr=St>=ht&&(nt===R||Ge.loadError===0&&Ge.fragmentError===0)&&(Tt<=ze||!ue(Tt)||j&&!x.bitrateTestDelay||Tt<I);if(fr){var Mr=x.forcedAutoLevel;return nt!==G&&(Mr===-1||Mr!==G)&&(it.length&&x.trace("Skipped level(s) "+it.join(",")+" of "+a+' max with CODECS and VIDEO-RANGE:"'+U[it[0]].codecs+'" '+U[it[0]].videoRange+'; not compatible with "'+X+'" '+W),x.info("switch candidate:"+_+"->"+nt+" adjustedbw("+Math.round(St)+")-bitrate="+Math.round(St-ht)+" ttfb:"+ze.toFixed(1)+" avgDuration:"+vt.toFixed(1)+" maxFetchDuration:"+I.toFixed(1)+" fetchDuration:"+Tt.toFixed(1)+" firstSelection:"+ae+" codecSet:"+Ge.codecSet+" videoRange:"+Ge.videoRange+" hls.loadLevel:"+G)),ae&&(x.firstSelection=nt),{v:nt}}},gt,nt=a;nt>=i;nt--)if(gt=yt(),gt!==0&&gt)return gt.v;return-1},o.deriveNextAutoLevel=function(t){var i=this.hls,a=i.maxAutoLevel,h=i.minAutoLevel;return Math.min(Math.max(t,h),a)},y(d,[{key:"firstAutoLevel",get:function(){var t=this.hls,i=t.maxAutoLevel,a=t.minAutoLevel,h=this.getBwEstimate(),g=this.hls.config.maxStarvationDelay,m=this.findBestLevel(h,a,i,0,g,1,1);if(m>-1)return m;var p=this.hls.firstLevel,E=Math.min(Math.max(p,a),i);return this.warn("Could not find best starting auto level. Defaulting to first in playlist "+p+" clamped to "+E),E}},{key:"forcedAutoLevel",get:function(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}},{key:"nextAutoLevel",get:function(){var t=this.forcedAutoLevel,i=this.bwEstimator,a=i.canEstimate(),h=this.lastLoadedFragLevel>-1;if(t!==-1&&(!a||!h||this.nextAutoLevelKey===this.getAutoLevelKey()))return t;var g=a&&h?this.getNextABRAutoLevel():this.firstAutoLevel;if(t!==-1){var m=this.hls.levels;if(m.length>Math.max(t,g)&&m[t].loadError<=m[g].loadError)return t}return this._nextAutoLevel=g,this.nextAutoLevelKey=this.getAutoLevelKey(),g},set:function(t){var i=this.deriveNextAutoLevel(t);this._nextAutoLevel!==i&&(this.nextAutoLevelKey="",this._nextAutoLevel=i)}}])}(st),Kn={search:function(d,o){for(var s=0,t=d.length-1,i=null,a=null;s<=t;){i=(s+t)/2|0,a=d[i];var h=o(a);if(h>0)s=i+1;else if(h<0)t=i-1;else return a}return null}};function ig(u,d,o){if(d===null||!Array.isArray(u)||!u.length||!ue(d))return null;var s=u[0].programDateTime;if(d<(s||0))return null;var t=u[u.length-1].endProgramDateTime;if(d>=(t||0))return null;o=o||0;for(var i=0;i<u.length;++i){var a=u[i];if(ng(d,o,a))return a}return null}function Xr(u,d,o,s,t){o===void 0&&(o=0),s===void 0&&(s=0),t===void 0&&(t=.005);var i=null;if(u){i=d[1+u.sn-d[0].sn]||null;var a=u.endDTS-o;a>0&&a<15e-7&&(o+=15e-7),i&&u.level!==i.level&&i.end<=u.end&&(i=d[2+u.sn-d[0].sn]||null)}else o===0&&d[0].start===0&&(i=d[0]);if(i&&((!u||u.level===i.level)&&Pl(o,s,i)===0||sg(i,u,Math.min(t,s))))return i;var h=Kn.search(d,Pl.bind(null,o,s));return h&&(h!==u||!i)?h:i}function sg(u,d,o){if(d&&d.start===0&&d.level<u.level&&(d.endPTS||0)>0){var s=d.tagList.reduce(function(t,i){return i[0]==="INF"&&(t+=parseFloat(i[1])),t},o);return u.start<=s}return!1}function Pl(u,d,o){if(u===void 0&&(u=0),d===void 0&&(d=0),o.start<=u&&o.start+o.duration>u)return 0;var s=Math.min(d,o.duration+(o.deltaPTS?o.deltaPTS:0));return o.start+o.duration-s<=u?1:o.start-s>u&&o.start?-1:0}function ng(u,d,o){var s=Math.min(d,o.duration+(o.deltaPTS?o.deltaPTS:0))*1e3,t=o.endProgramDateTime||0;return t-s>u}function kl(u,d){return Kn.search(u,function(o){return o.cc<d?1:o.cc>d?-1:0})}function ag(u,d,o){if(u&&u.startCC<=d&&u.endCC>=d){var s=o.start,t=o.end,i=u.fragments;if(!o.relurl){var a=u.fragmentHint;a&&(i=i.concat(a))}return Kn.search(i,function(h){return h.cc<d||h.end<=s?1:h.cc>d||h.start>=t?-1:0})}return null}function Es(u){switch(u.details){case q.FRAG_LOAD_TIMEOUT:case q.KEY_LOAD_TIMEOUT:case q.LEVEL_LOAD_TIMEOUT:case q.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function wl(u,d){var o=Es(d);return u.default[(o?"timeout":"error")+"Retry"]}function Vn(u,d){var o=u.backoff==="linear"?1:Math.pow(2,d);return Math.min(o*u.retryDelayMs,u.maxRetryDelayMs)}function Ol(u){return F(F({},u),{errorRetry:null,timeoutRetry:null})}function Ts(u,d,o,s){if(!u)return!1;var t=s==null?void 0:s.code,i=d<u.maxNumRetry&&(og(t)||!!o);return u.shouldRetry?u.shouldRetry(u,d,o,s,i):i}function og(u){return u===0&&navigator.onLine===!1||!!u&&(u<400||u>499)}var Ot={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},Zt={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2},lg=function(u){function d(s){var t;return t=u.call(this,"error-controller",s.logger)||this,t.hls=void 0,t.playlistError=0,t.penalizedRenditions={},t.hls=s,t.registerListeners(),t}b(d,u);var o=d.prototype;return o.registerListeners=function(){var t=this.hls;t.on(k.ERROR,this.onError,this),t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.LEVEL_UPDATED,this.onLevelUpdated,this)},o.unregisterListeners=function(){var t=this.hls;t&&(t.off(k.ERROR,this.onError,this),t.off(k.ERROR,this.onErrorOut,this),t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.LEVEL_UPDATED,this.onLevelUpdated,this))},o.destroy=function(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}},o.startLoad=function(t){},o.stopLoad=function(){this.playlistError=0},o.getVariantLevelIndex=function(t){return(t==null?void 0:t.type)===pe.MAIN?t.level:this.hls.loadLevel},o.onManifestLoading=function(){this.playlistError=0,this.penalizedRenditions={}},o.onLevelUpdated=function(){this.playlistError=0},o.onError=function(t,i){var a;if(!i.fatal){var h=this.hls,g=i.context;switch(i.details){case q.FRAG_LOAD_ERROR:case q.FRAG_LOAD_TIMEOUT:case q.KEY_LOAD_ERROR:case q.KEY_LOAD_TIMEOUT:i.errorAction=this.getFragRetryOrSwitchAction(i);return;case q.FRAG_PARSING_ERROR:if((a=i.frag)!=null&&a.gap){i.errorAction=Fi();return}case q.FRAG_GAP:case q.FRAG_DECRYPT_ERROR:{i.errorAction=this.getFragRetryOrSwitchAction(i),i.errorAction.action=Ot.SendAlternateToPenaltyBox;return}case q.LEVEL_EMPTY_ERROR:case q.LEVEL_PARSING_ERROR:{var m,p,E=i.parent===pe.MAIN?i.level:h.loadLevel;i.details===q.LEVEL_EMPTY_ERROR&&((m=i.context)!=null&&(p=m.levelDetails)!=null&&p.live)?i.errorAction=this.getPlaylistRetryOrSwitchAction(i,E):(i.levelRetry=!1,i.errorAction=this.getLevelSwitchAction(i,E))}return;case q.LEVEL_LOAD_ERROR:case q.LEVEL_LOAD_TIMEOUT:typeof(g==null?void 0:g.level)=="number"&&(i.errorAction=this.getPlaylistRetryOrSwitchAction(i,g.level));return;case q.AUDIO_TRACK_LOAD_ERROR:case q.AUDIO_TRACK_LOAD_TIMEOUT:case q.SUBTITLE_LOAD_ERROR:case q.SUBTITLE_TRACK_LOAD_TIMEOUT:if(g){var x=h.loadLevelObj;if(x&&(g.type===Te.AUDIO_TRACK&&x.hasAudioGroup(g.groupId)||g.type===Te.SUBTITLE_TRACK&&x.hasSubtitleGroup(g.groupId))){i.errorAction=this.getPlaylistRetryOrSwitchAction(i,h.loadLevel),i.errorAction.action=Ot.SendAlternateToPenaltyBox,i.errorAction.flags=Zt.MoveAllAlternatesMatchingHost;return}}return;case q.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{var I=h.loadLevelObj,R=I==null?void 0:I.attrs["HDCP-LEVEL"];R?i.errorAction={action:Ot.SendAlternateToPenaltyBox,flags:Zt.MoveAllAlternatesMatchingHDCP,hdcpLevel:R}:this.keySystemError(i)}return;case q.BUFFER_ADD_CODEC_ERROR:case q.REMUX_ALLOC_ERROR:case q.BUFFER_APPEND_ERROR:if(!i.errorAction){var _;i.errorAction=this.getLevelSwitchAction(i,(_=i.level)!=null?_:h.loadLevel)}return;case q.INTERNAL_EXCEPTION:case q.BUFFER_APPENDING_ERROR:case q.BUFFER_FULL_ERROR:case q.LEVEL_SWITCH_ERROR:case q.BUFFER_STALLED_ERROR:case q.BUFFER_SEEK_OVER_HOLE:case q.BUFFER_NUDGE_ON_STALL:i.errorAction=Fi();return}i.type===se.KEY_SYSTEM_ERROR&&this.keySystemError(i)}},o.keySystemError=function(t){var i=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,i)},o.getPlaylistRetryOrSwitchAction=function(t,i){var a=this.hls,h=wl(a.config.playlistLoadPolicy,t),g=this.playlistError++,m=Ts(h,g,Es(t),t.response);if(m)return{action:Ot.RetryRequest,flags:Zt.None,retryConfig:h,retryCount:g};var p=this.getLevelSwitchAction(t,i);return h&&(p.retryConfig=h,p.retryCount=g),p},o.getFragRetryOrSwitchAction=function(t){var i=this.hls,a=this.getVariantLevelIndex(t.frag),h=i.levels[a],g=i.config,m=g.fragLoadPolicy,p=g.keyLoadPolicy,E=wl(t.details.startsWith("key")?p:m,t),x=i.levels.reduce(function(_,P){return _+P.fragmentError},0);if(h){t.details!==q.FRAG_GAP&&h.fragmentError++;var I=Ts(E,x,Es(t),t.response);if(I)return{action:Ot.RetryRequest,flags:Zt.None,retryConfig:E,retryCount:x}}var R=this.getLevelSwitchAction(t,a);return E&&(R.retryConfig=E,R.retryCount=x),R},o.getLevelSwitchAction=function(t,i){var a=this.hls;i==null&&(i=a.loadLevel);var h=this.hls.levels[i];if(h){var g,m,p=t.details;h.loadError++,p===q.BUFFER_APPEND_ERROR&&h.fragmentError++;var E=-1,x=a.levels,I=a.loadLevel,R=a.minAutoLevel,_=a.maxAutoLevel;a.autoLevelEnabled||(a.loadLevel=-1);for(var P=(g=t.frag)==null?void 0:g.type,O=P===pe.AUDIO&&p===q.FRAG_PARSING_ERROR||t.sourceBufferName==="audio"&&(p===q.BUFFER_ADD_CODEC_ERROR||p===q.BUFFER_APPEND_ERROR),N=O&&x.some(function(W){var J=W.audioCodec;return h.audioCodec!==J}),U=t.sourceBufferName==="video"&&(p===q.BUFFER_ADD_CODEC_ERROR||p===q.BUFFER_APPEND_ERROR),B=U&&x.some(function(W){var J=W.codecSet,oe=W.audioCodec;return h.codecSet!==J&&h.audioCodec===oe}),G=(m=t.context)!=null?m:{},Y=G.type,V=G.groupId,j=function(){var J=(X+I)%x.length;if(J!==I&&J>=R&&J<=_&&x[J].loadError===0){var oe,ge,ce=x[J];if(p===q.FRAG_GAP&&P===pe.MAIN&&t.frag){var he=x[J].details;if(he){var ye=Xr(t.frag,he.fragments,t.frag.start);if(ye!=null&&ye.gap)return 0}}else{if(Y===Te.AUDIO_TRACK&&ce.hasAudioGroup(V)||Y===Te.SUBTITLE_TRACK&&ce.hasSubtitleGroup(V))return 0;if(P===pe.AUDIO&&(oe=h.audioGroups)!=null&&oe.some(function(Se){return ce.hasAudioGroup(Se)})||P===pe.SUBTITLE&&(ge=h.subtitleGroups)!=null&&ge.some(function(Se){return ce.hasSubtitleGroup(Se)})||N&&h.audioCodec===ce.audioCodec||!N&&h.audioCodec!==ce.audioCodec||B&&h.codecSet===ce.codecSet)return 0}return E=J,1}},ae,X=x.length;X--&&(ae=j(),!(ae!==0&&ae===1)););if(E>-1&&a.loadLevel!==E)return t.levelRetry=!0,this.playlistError=0,{action:Ot.SendAlternateToPenaltyBox,flags:Zt.None,nextAutoLevel:E}}return{action:Ot.SendAlternateToPenaltyBox,flags:Zt.MoveAllAlternatesMatchingHost}},o.onErrorOut=function(t,i){var a;switch((a=i.errorAction)==null?void 0:a.action){case Ot.DoNothing:break;case Ot.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(i),!i.errorAction.resolved&&i.details!==q.FRAG_GAP?i.fatal=!0:/MediaSource readyState: ended/.test(i.error.message)&&(this.warn('MediaSource ended after "'+i.sourceBufferName+'" sourceBuffer append error. Attempting to recover from media error.'),this.hls.recoverMediaError());break}if(i.fatal){this.hls.stopLoad();return}},o.sendAlternateToPenaltyBox=function(t){var i=this.hls,a=t.errorAction;if(a){var h=a.flags,g=a.hdcpLevel,m=a.nextAutoLevel;switch(h){case Zt.None:this.switchLevel(t,m);break;case Zt.MoveAllAlternatesMatchingHDCP:g&&(i.maxHdcpLevel=$n[$n.indexOf(g)-1],a.resolved=!0),this.warn('Restricting playback to HDCP-LEVEL of "'+i.maxHdcpLevel+'" or lower');break}a.resolved||this.switchLevel(t,m)}},o.switchLevel=function(t,i){if(i!==void 0&&t.errorAction&&(this.warn("switching to level "+i+" after "+t.details),this.hls.nextAutoLevel=i,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,t.details===q.BUFFER_ADD_CODEC_ERROR&&t.mimeType&&t.sourceBufferName!=="audiovideo"))for(var a=Tl(t.mimeType),h=this.hls.levels,g=h.length;g--;)h[g][t.sourceBufferName+"Codec"]===a&&this.hls.removeLevel(g)},d}(st);function Fi(u){var d={action:Ot.DoNothing,flags:Zt.None};return u&&(d.resolved=!0),d}var xt={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"},ug=function(){function u(o){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=o,this._registerListeners()}var d=u.prototype;return d._registerListeners=function(){var s=this.hls;s.on(k.MANIFEST_LOADING,this.onManifestLoading,this),s.on(k.BUFFER_APPENDED,this.onBufferAppended,this),s.on(k.FRAG_BUFFERED,this.onFragBuffered,this),s.on(k.FRAG_LOADED,this.onFragLoaded,this)},d._unregisterListeners=function(){var s=this.hls;s.off(k.MANIFEST_LOADING,this.onManifestLoading,this),s.off(k.BUFFER_APPENDED,this.onBufferAppended,this),s.off(k.FRAG_BUFFERED,this.onFragBuffered,this),s.off(k.FRAG_LOADED,this.onFragLoaded,this)},d.destroy=function(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null},d.getAppendedFrag=function(s,t){var i=this.activePartLists[t];if(i)for(var a=i.length;a--;){var h=i[a];if(!h)break;var g=h.end;if(h.start<=s&&g!==null&&s<=g)return h}return this.getBufferedFrag(s,t)},d.getBufferedFrag=function(s,t){return this.getFragAtPos(s,t,!0)},d.getFragAtPos=function(s,t,i){for(var a=this.fragments,h=Object.keys(a),g=h.length;g--;){var m=a[h[g]];if((m==null?void 0:m.body.type)===t&&(!i||m.buffered)){var p=m.body;if(p.start<=s&&s<=p.end)return p}}return null},d.detectEvictedFragments=function(s,t,i,a,h){var g=this;this.timeRanges&&(this.timeRanges[s]=t);var m=(a==null?void 0:a.fragment.sn)||-1;Object.keys(this.fragments).forEach(function(p){var E=g.fragments[p];if(E&&!(m>=E.body.sn)){if(!E.buffered&&(!E.loaded||h)){E.body.type===i&&g.removeFragment(E.body);return}var x=E.range[s];if(x){if(x.time.length===0){g.removeFragment(E.body);return}x.time.some(function(I){var R=!g.isTimeBuffered(I.startPTS,I.endPTS,t);return R&&g.removeFragment(E.body),R})}}})},d.detectPartialFragments=function(s){var t=this,i=this.timeRanges;if(!(!i||s.frag.sn==="initSegment")){var a=s.frag,h=oi(a),g=this.fragments[h];if(!(!g||g.buffered&&a.gap)){var m=!a.relurl;if(Object.keys(i).forEach(function(E){var x=a.elementaryStreams[E];if(x){var I=i[E],R=m||x.partial===!0;g.range[E]=t.getBufferedTimes(a,s.part,R,I)}}),g.loaded=null,Object.keys(g.range).length){g.buffered=!0;var p=g.body.endList=a.endList||g.body.endList;p&&(this.endListFragments[g.body.type]=g),Ss(g)||this.removeParts(a.sn-1,a.type)}else this.removeFragment(g.body)}}},d.removeParts=function(s,t){var i=this.activePartLists[t];i&&(this.activePartLists[t]=i.filter(function(a){return a.fragment.sn>=s}))},d.fragBuffered=function(s,t){var i=oi(s),a=this.fragments[i];!a&&t&&(a=this.fragments[i]={body:s,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},s.gap&&(this.hasGaps=!0)),a&&(a.loaded=null,a.buffered=!0)},d.getBufferedTimes=function(s,t,i,a){for(var h={time:[],partial:i},g=s.start,m=s.end,p=s.minEndPTS||m,E=s.maxStartPTS||g,x=0;x<a.length;x++){var I=a.start(x)-this.bufferPadding,R=a.end(x)+this.bufferPadding;if(E>=I&&p<=R){h.time.push({startPTS:Math.max(g,a.start(x)),endPTS:Math.min(m,a.end(x))});break}else if(g<R&&m>I){var _=Math.max(g,a.start(x)),P=Math.min(m,a.end(x));P>_&&(h.partial=!0,h.time.push({startPTS:_,endPTS:P}))}else if(m<=I)break}return h},d.getPartialFragment=function(s){var t=null,i,a,h,g=0,m=this.bufferPadding,p=this.fragments;return Object.keys(p).forEach(function(E){var x=p[E];x&&Ss(x)&&(a=x.body.start-m,h=x.body.end+m,s>=a&&s<=h&&(i=Math.min(s-a,h-s),g<=i&&(t=x.body,g=i)))}),t},d.isEndListAppended=function(s){var t=this.endListFragments[s];return t!==void 0&&(t.buffered||Ss(t))},d.getState=function(s){var t=oi(s),i=this.fragments[t];return i?i.buffered?Ss(i)?xt.PARTIAL:xt.OK:xt.APPENDING:xt.NOT_LOADED},d.isTimeBuffered=function(s,t,i){for(var a,h,g=0;g<i.length;g++){if(a=i.start(g)-this.bufferPadding,h=i.end(g)+this.bufferPadding,s>=a&&t<=h)return!0;if(t<=a)return!1}return!1},d.onManifestLoading=function(){this.removeAllFragments()},d.onFragLoaded=function(s,t){if(!(t.frag.sn==="initSegment"||t.frag.bitrateTest)){var i=t.frag,a=t.part?null:t,h=oi(i);this.fragments[h]={body:i,appendedPTS:null,loaded:a,buffered:!1,range:Object.create(null)}}},d.onBufferAppended=function(s,t){var i=t.frag,a=t.part,h=t.timeRanges,g=t.type;if(i.sn!=="initSegment"){var m=i.type;if(a){var p=this.activePartLists[m];p||(this.activePartLists[m]=p=[]),p.push(a)}this.timeRanges=h;var E=h[g];this.detectEvictedFragments(g,E,m,a)}},d.onFragBuffered=function(s,t){this.detectPartialFragments(t)},d.hasFragment=function(s){var t=oi(s);return!!this.fragments[t]},d.hasFragments=function(s){var t=this.fragments,i=Object.keys(t);if(!s)return i.length>0;for(var a=i.length;a--;){var h=t[i[a]];if((h==null?void 0:h.body.type)===s)return!0}return!1},d.hasParts=function(s){var t;return!!((t=this.activePartLists[s])!=null&&t.length)},d.removeFragmentsInRange=function(s,t,i,a,h){var g=this;a&&!this.hasGaps||Object.keys(this.fragments).forEach(function(m){var p=g.fragments[m];if(p){var E=p.body;E.type!==i||a&&!E.gap||E.start<t&&E.end>s&&(p.buffered||h)&&g.removeFragment(E)}})},d.removeFragment=function(s){var t=oi(s);s.clearElementaryStreamInfo();var i=this.activePartLists[s.type];if(i){var a=s.sn;this.activePartLists[s.type]=i.filter(function(h){return h.fragment.sn!==a})}delete this.fragments[t],s.endList&&delete this.endListFragments[s.type]},d.removeAllFragments=function(){var s,t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;var i=(s=this.hls)==null||(t=s.latestLevelDetails)==null?void 0:t.partList;i&&i.forEach(function(a){return a.clearElementaryStreamInfo()})},u}();function Ss(u){var d,o,s;return u.buffered&&(u.body.gap||((d=u.range.video)==null?void 0:d.partial)||((o=u.range.audio)==null?void 0:o.partial)||((s=u.range.audiovideo)==null?void 0:s.partial))}function oi(u){return u.type+"_"+u.level+"_"+u.sn}var kr={cbc:0,ctr:1},hg=function(){function u(o,s,t){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=o,this.aesIV=s,this.aesMode=t}var d=u.prototype;return d.decrypt=function(s,t){switch(this.aesMode){case kr.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,s);case kr.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,s);default:throw new Error("[AESCrypto] invalid aes mode "+this.aesMode)}},u}();function fg(u){var d=u.byteLength,o=d&&new DataView(u.buffer).getUint8(d-1);return o?u.slice(0,d-o):u}var dg=function(){function u(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var d=u.prototype;return d.uint8ArrayToUint32Array_=function(s){for(var t=new DataView(s),i=new Uint32Array(4),a=0;a<4;a++)i[a]=t.getUint32(a*4);return i},d.initTable=function(){var s=this.sBox,t=this.invSBox,i=this.subMix,a=i[0],h=i[1],g=i[2],m=i[3],p=this.invSubMix,E=p[0],x=p[1],I=p[2],R=p[3],_=new Uint32Array(256),P=0,O=0,N=0;for(N=0;N<256;N++)N<128?_[N]=N<<1:_[N]=N<<1^283;for(N=0;N<256;N++){var U=O^O<<1^O<<2^O<<3^O<<4;U=U>>>8^U&255^99,s[P]=U,t[U]=P;var B=_[P],G=_[B],Y=_[G],V=_[U]*257^U*16843008;a[P]=V<<24|V>>>8,h[P]=V<<16|V>>>16,g[P]=V<<8|V>>>24,m[P]=V,V=Y*16843009^G*65537^B*257^P*16843008,E[U]=V<<24|V>>>8,x[U]=V<<16|V>>>16,I[U]=V<<8|V>>>24,R[U]=V,P?(P=B^_[_[_[Y^B]]],O^=_[_[O]]):P=O=1}},d.expandKey=function(s){for(var t=this.uint8ArrayToUint32Array_(s),i=!0,a=0;a<t.length&&i;)i=t[a]===this.key[a],a++;if(!i){this.key=t;var h=this.keySize=t.length;if(h!==4&&h!==6&&h!==8)throw new Error("Invalid aes key size="+h);var g=this.ksRows=(h+6+1)*4,m,p,E=this.keySchedule=new Uint32Array(g),x=this.invKeySchedule=new Uint32Array(g),I=this.sBox,R=this.rcon,_=this.invSubMix,P=_[0],O=_[1],N=_[2],U=_[3],B,G;for(m=0;m<g;m++){if(m<h){B=E[m]=t[m];continue}G=B,m%h===0?(G=G<<8|G>>>24,G=I[G>>>24]<<24|I[G>>>16&255]<<16|I[G>>>8&255]<<8|I[G&255],G^=R[m/h|0]<<24):h>6&&m%h===4&&(G=I[G>>>24]<<24|I[G>>>16&255]<<16|I[G>>>8&255]<<8|I[G&255]),E[m]=B=(E[m-h]^G)>>>0}for(p=0;p<g;p++)m=g-p,p&3?G=E[m]:G=E[m-4],p<4||m<=4?x[p]=G:x[p]=P[I[G>>>24]]^O[I[G>>>16&255]]^N[I[G>>>8&255]]^U[I[G&255]],x[p]=x[p]>>>0}},d.networkToHostOrderSwap=function(s){return s<<24|(s&65280)<<8|(s&16711680)>>8|s>>>24},d.decrypt=function(s,t,i){for(var a=this.keySize+6,h=this.invKeySchedule,g=this.invSBox,m=this.invSubMix,p=m[0],E=m[1],x=m[2],I=m[3],R=this.uint8ArrayToUint32Array_(i),_=R[0],P=R[1],O=R[2],N=R[3],U=new Int32Array(s),B=new Int32Array(U.length),G,Y,V,j,ae,X,W,J,oe,ge,ce,he,ye,Se,Le=this.networkToHostOrderSwap;t<U.length;){for(oe=Le(U[t]),ge=Le(U[t+1]),ce=Le(U[t+2]),he=Le(U[t+3]),ae=oe^h[0],X=he^h[1],W=ce^h[2],J=ge^h[3],ye=4,Se=1;Se<a;Se++)G=p[ae>>>24]^E[X>>16&255]^x[W>>8&255]^I[J&255]^h[ye],Y=p[X>>>24]^E[W>>16&255]^x[J>>8&255]^I[ae&255]^h[ye+1],V=p[W>>>24]^E[J>>16&255]^x[ae>>8&255]^I[X&255]^h[ye+2],j=p[J>>>24]^E[ae>>16&255]^x[X>>8&255]^I[W&255]^h[ye+3],ae=G,X=Y,W=V,J=j,ye=ye+4;G=g[ae>>>24]<<24^g[X>>16&255]<<16^g[W>>8&255]<<8^g[J&255]^h[ye],Y=g[X>>>24]<<24^g[W>>16&255]<<16^g[J>>8&255]<<8^g[ae&255]^h[ye+1],V=g[W>>>24]<<24^g[J>>16&255]<<16^g[ae>>8&255]<<8^g[X&255]^h[ye+2],j=g[J>>>24]<<24^g[ae>>16&255]<<16^g[X>>8&255]<<8^g[W&255]^h[ye+3],B[t]=Le(G^_),B[t+1]=Le(j^P),B[t+2]=Le(V^O),B[t+3]=Le(Y^N),_=oe,P=ge,O=ce,N=he,t=t+4}return B.buffer},u}(),cg=function(){function u(o,s,t){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=o,this.key=s,this.aesMode=t}var d=u.prototype;return d.expandKey=function(){var s=gg(this.aesMode);return this.subtle.importKey("raw",this.key,{name:s},!1,["encrypt","decrypt"])},u}();function gg(u){switch(u){case kr.cbc:return"AES-CBC";case kr.ctr:return"AES-CTR";default:throw new Error("[FastAESKey] invalid aes mode "+u)}}var vg=16,Hn=function(){function u(o,s){var t=s===void 0?{}:s,i=t.removePKCS7Padding,a=i===void 0?!0:i;if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=o.enableSoftwareAES,this.removePKCS7Padding=a,a)try{var h=self.crypto;h&&(this.subtle=h.subtle||h.webkitSubtle)}catch{}this.useSoftware=!this.subtle}var d=u.prototype;return d.destroy=function(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null},d.isSync=function(){return this.useSoftware},d.flush=function(){var s=this.currentResult,t=this.remainderData;if(!s||t)return this.reset(),null;var i=new Uint8Array(s);return this.reset(),this.removePKCS7Padding?fg(i):i},d.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},d.decrypt=function(s,t,i,a){var h=this;return this.useSoftware?new Promise(function(g,m){var p=ArrayBuffer.isView(s)?s:new Uint8Array(s);h.softwareDecrypt(p,t,i,a);var E=h.flush();E?g(E.buffer):m(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(s),t,i,a)},d.softwareDecrypt=function(s,t,i,a){var h=this.currentIV,g=this.currentResult,m=this.remainderData;if(a!==kr.cbc||t.byteLength!==16)return Ye.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),m&&(s=Yt(m,s),this.remainderData=null);var p=this.getValidChunk(s);if(!p.length)return null;h&&(i=h);var E=this.softwareDecrypter;E||(E=this.softwareDecrypter=new dg),E.expandKey(t);var x=g;return this.currentResult=E.decrypt(p.buffer,0,i),this.currentIV=p.slice(-16).buffer,x||null},d.webCryptoDecrypt=function(s,t,i,a){var h=this;if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(s,t,i,a));this.key=t,this.fastAesKey=new cg(this.subtle,t,a)}return this.fastAesKey.expandKey().then(function(g){if(!h.subtle)return Promise.reject(new Error("web crypto not initialized"));h.logOnce("WebCrypto AES decrypt");var m=new hg(h.subtle,new Uint8Array(i),a);return m.decrypt(s.buffer,g)}).catch(function(g){return Ye.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, "+g.name+": "+g.message),h.onWebCryptoError(s,t,i,a)})},d.onWebCryptoError=function(s,t,i,a){var h=this.enableSoftwareAES;if(h){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(s,t,i,a);var g=this.flush();if(g)return g.buffer}throw new Error("WebCrypto"+(h?" and softwareDecrypt":"")+": failed to decrypt data")},d.getValidChunk=function(s){var t=s,i=s.length-s.length%vg;return i!==s.length&&(t=s.slice(0,i),this.remainderData=s.slice(i)),t},d.logOnce=function(s){this.logEnabled&&(Ye.log("[decrypter]: "+s),this.logEnabled=!1)},u}(),Ml=Math.pow(2,17),mg=function(){function u(o){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=o}var d=u.prototype;return d.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},d.abort=function(){this.loader&&this.loader.abort()},d.load=function(s,t){var i=this,a=s.url;if(!a)return Promise.reject(new Tr({type:se.NETWORK_ERROR,details:q.FRAG_LOAD_ERROR,fatal:!1,frag:s,error:new Error("Fragment does not have a "+(a?"part list":"url")),networkDetails:null}));this.abort();var h=this.config,g=h.fLoader,m=h.loader;return new Promise(function(p,E){if(i.loader&&i.loader.destroy(),s.gap)if(s.tagList.some(function(O){return O[0]==="GAP"})){E(Nl(s));return}else s.gap=!1;var x=i.loader=g?new g(h):new m(h),I=Fl(s);s.loader=x;var R=Ol(h.fragLoadPolicy.default),_={loadPolicy:R,timeout:R.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:s.sn==="initSegment"?1/0:Ml};s.stats=x.stats;var P={onSuccess:function(N,U,B,G){i.resetLoader(s,x);var Y=N.data;B.resetIV&&s.decryptdata&&(s.decryptdata.iv=new Uint8Array(Y.slice(0,16)),Y=Y.slice(16)),p({frag:s,part:null,payload:Y,networkDetails:G})},onError:function(N,U,B,G){i.resetLoader(s,x),E(new Tr({type:se.NETWORK_ERROR,details:q.FRAG_LOAD_ERROR,fatal:!1,frag:s,response:F({url:a,data:void 0},N),error:new Error("HTTP Error "+N.code+" "+N.text),networkDetails:B,stats:G}))},onAbort:function(N,U,B){i.resetLoader(s,x),E(new Tr({type:se.NETWORK_ERROR,details:q.INTERNAL_ABORTED,fatal:!1,frag:s,error:new Error("Aborted"),networkDetails:B,stats:N}))},onTimeout:function(N,U,B){i.resetLoader(s,x),E(new Tr({type:se.NETWORK_ERROR,details:q.FRAG_LOAD_TIMEOUT,fatal:!1,frag:s,error:new Error("Timeout after "+_.timeout+"ms"),networkDetails:B,stats:N}))}};t&&(P.onProgress=function(O,N,U,B){return t({frag:s,part:null,payload:U,networkDetails:B})}),x.load(I,_,P)})},d.loadPart=function(s,t,i){var a=this;this.abort();var h=this.config,g=h.fLoader,m=h.loader;return new Promise(function(p,E){if(a.loader&&a.loader.destroy(),s.gap||t.gap){E(Nl(s,t));return}var x=a.loader=g?new g(h):new m(h),I=Fl(s,t);s.loader=x;var R=Ol(h.fragLoadPolicy.default),_={loadPolicy:R,timeout:R.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Ml};t.stats=x.stats,x.load(I,_,{onSuccess:function(O,N,U,B){a.resetLoader(s,x),a.updateStatsFromPart(s,t);var G={frag:s,part:t,payload:O.data,networkDetails:B};i(G),p(G)},onError:function(O,N,U,B){a.resetLoader(s,x),E(new Tr({type:se.NETWORK_ERROR,details:q.FRAG_LOAD_ERROR,fatal:!1,frag:s,part:t,response:F({url:I.url,data:void 0},O),error:new Error("HTTP Error "+O.code+" "+O.text),networkDetails:U,stats:B}))},onAbort:function(O,N,U){s.stats.aborted=t.stats.aborted,a.resetLoader(s,x),E(new Tr({type:se.NETWORK_ERROR,details:q.INTERNAL_ABORTED,fatal:!1,frag:s,part:t,error:new Error("Aborted"),networkDetails:U,stats:O}))},onTimeout:function(O,N,U){a.resetLoader(s,x),E(new Tr({type:se.NETWORK_ERROR,details:q.FRAG_LOAD_TIMEOUT,fatal:!1,frag:s,part:t,error:new Error("Timeout after "+_.timeout+"ms"),networkDetails:U,stats:O}))}})})},d.updateStatsFromPart=function(s,t){var i=s.stats,a=t.stats,h=a.total;if(i.loaded+=a.loaded,h){var g=Math.round(s.duration/t.duration),m=Math.min(Math.round(i.loaded/h),g),p=g-m,E=p*Math.round(i.loaded/m);i.total=i.loaded+E}else i.total=Math.max(i.loaded,i.total);var x=i.loading,I=a.loading;x.start?x.first+=I.first-I.start:(x.start=I.start,x.first=I.first),x.end=I.end},d.resetLoader=function(s,t){s.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()},u}();function Fl(u,d){d===void 0&&(d=null);var o=d||u,s={frag:u,part:d,responseType:"arraybuffer",url:o.url,headers:{},rangeStart:0,rangeEnd:0},t=o.byteRangeStartOffset,i=o.byteRangeEndOffset;if(ue(t)&&ue(i)){var a,h=t,g=i;if(u.sn==="initSegment"&&pg((a=u.decryptdata)==null?void 0:a.method)){var m=i-t;m%16&&(g=i+(16-m%16)),t!==0&&(s.resetIV=!0,h=t-16)}s.rangeStart=h,s.rangeEnd=g}return s}function Nl(u,d){var o=new Error("GAP "+(u.gap?"tag":"attribute")+" found"),s={type:se.MEDIA_ERROR,details:q.FRAG_GAP,fatal:!1,frag:u,error:o,networkDetails:null};return d&&(s.part=d),(d||u).stats.aborted=!0,new Tr(s)}function pg(u){return u==="AES-128"||u==="AES-256"}var Tr=function(u){function d(o){var s;return s=u.call(this,o.error.message)||this,s.data=void 0,s.data=o,s}return b(d,u),d}(Q(Error)),Ul=function(u){function d(s,t){var i;return i=u.call(this,s,t)||this,i._boundTick=void 0,i._tickTimer=null,i._tickInterval=null,i._tickCallCount=0,i._boundTick=i.tick.bind(i),i}b(d,u);var o=d.prototype;return o.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},o.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},o.onHandlerDestroyed=function(){},o.hasInterval=function(){return!!this._tickInterval},o.hasNextTick=function(){return!!this._tickTimer},o.setInterval=function(t){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)},o.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},o.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},o.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},o.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},o.doTick=function(){},d}(st),Yn=function(d,o,s,t,i,a){t===void 0&&(t=0),i===void 0&&(i=-1),a===void 0&&(a=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=As(),this.buffering={audio:As(),video:As(),audiovideo:As()},this.level=d,this.sn=o,this.id=s,this.size=t,this.part=i,this.partial=a};function As(){return{start:0,executeStart:0,executeEnd:0,end:0}}var Bl={length:0,start:function(){return 0},end:function(){return 0}},We=function(){function u(){}return u.isBuffered=function(o,s){if(o){for(var t=u.getBuffered(o),i=t.length;i--;)if(s>=t.start(i)&&s<=t.end(i))return!0}return!1},u.bufferedRanges=function(o){if(o){var s=u.getBuffered(o);return u.timeRangesToArray(s)}return[]},u.timeRangesToArray=function(o){for(var s=[],t=0;t<o.length;t++)s.push({start:o.start(t),end:o.end(t)});return s},u.bufferInfo=function(o,s,t){if(o){var i=u.bufferedRanges(o);if(i.length)return u.bufferedInfo(i,s,t)}return{len:0,start:s,end:s,bufferedIndex:-1}},u.bufferedInfo=function(o,s,t){s=Math.max(0,s),o.length>1&&o.sort(function(O,N){return O.start-N.start||N.end-O.end});var i=-1,a=[];if(t)for(var h=0;h<o.length;h++){s>=o[h].start&&s<=o[h].end&&(i=h);var g=a.length;if(g){var m=a[g-1].end;o[h].start-m<t?o[h].end>m&&(a[g-1].end=o[h].end):a.push(o[h])}else a.push(o[h])}else a=o;for(var p=0,E,x=s,I=s,R=0;R<a.length;R++){var _=a[R].start,P=a[R].end;if(i===-1&&s>=_&&s<=P&&(i=R),s+t>=_&&s<P)x=_,I=P,p=I-s;else if(s+t<_){E=_;break}}return{len:p,start:x||0,end:I||0,nextStart:E,buffered:o,bufferedIndex:i}},u.getBuffered=function(o){try{return o.buffered||Bl}catch(s){return Ye.log("failed to get media.buffered",s),Bl}},u}(),Gl=/\{\$([a-zA-Z0-9-_]+)\}/g;function $l(u){return Gl.test(u)}function Wn(u,d){if(u.variableList!==null||u.hasVariableRefs){var o=u.variableList;return d.replace(Gl,function(s){var t=s.substring(2,s.length-1),i=o==null?void 0:o[t];return i===void 0?(u.playlistParsingError||(u.playlistParsingError=new Error('Missing preceding EXT-X-DEFINE tag for Variable Reference: "'+t+'"')),s):i})}return d}function Kl(u,d,o){var s=u.variableList;s||(u.variableList=s={});var t,i;if("QUERYPARAM"in d){t=d.QUERYPARAM;try{var a=new self.URL(o).searchParams;if(a.has(t))i=a.get(t);else throw new Error('"'+t+'" does not match any query parameter in URI: "'+o+'"')}catch(h){u.playlistParsingError||(u.playlistParsingError=new Error("EXT-X-DEFINE QUERYPARAM: "+h.message))}}else t=d.NAME,i=d.VALUE;t in s?u.playlistParsingError||(u.playlistParsingError=new Error('EXT-X-DEFINE duplicate Variable Name declarations: "'+t+'"')):s[t]=i||""}function yg(u,d,o){var s=d.IMPORT;if(o&&s in o){var t=u.variableList;t||(u.variableList=t={}),t[s]=o[s]}else u.playlistParsingError||(u.playlistParsingError=new Error('EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "'+s+'"'))}var Eg=/^(\d+)x(\d+)$/,Vl=/(.+?)=(".*?"|.*?)(?:,|$)/g,pt=function(){function u(o,s){typeof o=="string"&&(o=u.parseAttrList(o,s)),A(this,o)}var d=u.prototype;return d.decimalInteger=function(s){var t=parseInt(this[s],10);return t>Number.MAX_SAFE_INTEGER?1/0:t},d.hexadecimalInteger=function(s){if(this[s]){var t=(this[s]||"0x").slice(2);t=(t.length&1?"0":"")+t;for(var i=new Uint8Array(t.length/2),a=0;a<t.length/2;a++)i[a]=parseInt(t.slice(a*2,a*2+2),16);return i}return null},d.hexadecimalIntegerAsNumber=function(s){var t=parseInt(this[s],16);return t>Number.MAX_SAFE_INTEGER?1/0:t},d.decimalFloatingPoint=function(s){return parseFloat(this[s])},d.optionalFloat=function(s,t){var i=this[s];return i?parseFloat(i):t},d.enumeratedString=function(s){return this[s]},d.enumeratedStringList=function(s,t){var i=this[s];return(i?i.split(/[ ,]+/):[]).reduce(function(a,h){return a[h.toLowerCase()]=!0,a},t)},d.bool=function(s){return this[s]==="YES"},d.decimalResolution=function(s){var t=Eg.exec(this[s]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}},u.parseAttrList=function(s,t){var i,a={},h='"';for(Vl.lastIndex=0;(i=Vl.exec(s))!==null;){var g=i[1].trim(),m=i[2],p=m.indexOf(h)===0&&m.lastIndexOf(h)===m.length-1,E=!1;if(p)m=m.slice(1,-1);else switch(g){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":E=!0}if(t&&(p||E))m=Wn(t,m);else if(!E&&!p)switch(g){case"CLOSED-CAPTIONS":if(m==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":Ye.warn(s+": attribute "+g+" is missing quotes")}a[g]=m}return a},y(u,[{key:"clientAttrs",get:function(){return Object.keys(this).filter(function(s){return s.substring(0,2)==="X-"})}}])}(),Tg="com.apple.hls.interstitial";function Sg(u){return u!=="ID"&&u!=="CLASS"&&u!=="CUE"&&u!=="START-DATE"&&u!=="DURATION"&&u!=="END-DATE"&&u!=="END-ON-NEXT"}function Ag(u){return u==="SCTE35-OUT"||u==="SCTE35-IN"||u==="SCTE35-CMD"}var Hl=function(){function u(d,o,s){var t;if(s===void 0&&(s=0),this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(o==null?void 0:o.tagAnchor)||null,this.tagOrder=(t=o==null?void 0:o.tagOrder)!=null?t:s,o){var i=o.attr;for(var a in i)if(Object.prototype.hasOwnProperty.call(d,a)&&d[a]!==i[a]){Ye.warn('DATERANGE tag attribute: "'+a+'" does not match for tags with ID: "'+d.ID+'"'),this._badValueForSameId=a;break}d=A(new pt({}),i,d)}if(this.attr=d,o?(this._startDate=o._startDate,this._cue=o._cue,this._endDate=o._endDate,this._dateAtEnd=o._dateAtEnd):this._startDate=new Date(d["START-DATE"]),"END-DATE"in this.attr){var h=(o==null?void 0:o.endDate)||new Date(this.attr["END-DATE"]);ue(h.getTime())&&(this._endDate=h)}}return y(u,[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"cue",get:function(){var o=this._cue;return o===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):o}},{key:"startTime",get:function(){var o=this.tagAnchor;return o===null||o.programDateTime===null?(Ye.warn('Expected tagAnchor Fragment with PDT set for DateRange "'+this.id+'": '+o),NaN):o.start+(this.startDate.getTime()-o.programDateTime)/1e3}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){var o=this._endDate||this._dateAtEnd;if(o)return o;var s=this.duration;return s!==null?this._dateAtEnd=new Date(this._startDate.getTime()+s*1e3):null}},{key:"duration",get:function(){if("DURATION"in this.attr){var o=this.attr.decimalFloatingPoint("DURATION");if(ue(o))return o}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}},{key:"endOnNext",get:function(){return this.attr.bool("END-ON-NEXT")}},{key:"isInterstitial",get:function(){return this.class===Tg}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&ue(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}])}(),xg=10,Lg=function(){function u(o){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=o}var d=u.prototype;return d.reloaded=function(s){if(!s){this.advanced=!0,this.updated=!0;return}var t=this.lastPartSn-s.lastPartSn,i=this.lastPartIndex-s.lastPartIndex;this.updated=this.endSN!==s.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>s.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(s.misses*.6):this.misses=s.misses+1},y(u,[{key:"hasProgramDateTime",get:function(){return this.fragments.length?ue(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||xg}},{key:"drift",get:function(){var s=this.driftEndTime-this.driftStartTime;if(s>0){var t=this.driftEnd-this.driftStart;return t*1e3/s}return 1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var s;return(s=this.partList)!=null&&s.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var s;return(s=this.fragments)!=null&&s.length?this.fragments[this.fragments.length-1].end:0}},{key:"fragmentStart",get:function(){var s;return(s=this.fragments)!=null&&s.length?this.fragments[0].start:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var s;return(s=this.partList)!=null&&s.length?this.partList[this.partList.length-1].index:-1}},{key:"maxPartIndex",get:function(){var s=this.partList;if(s){var t=this.lastPartIndex;if(t!==-1){for(var i=s.length;i--;)if(s[i].index>t)return s[i].index;return t}}return 0}},{key:"lastPartSn",get:function(){var s;return(s=this.partList)!=null&&s.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}},{key:"expired",get:function(){if(this.live&&this.age&&this.misses<3){var s=this.partEnd-this.fragmentStart;return this.age>Math.max(s,this.totalduration)+this.levelTargetDuration}return!1}}])}();function li(u){return u==="AES-128"||u==="AES-256"||u==="AES-256-CTR"}function qn(u){switch(u){case"AES-128":case"AES-256":return kr.cbc;case"AES-256-CTR":return kr.ctr;default:throw new Error("invalid full segment method "+u)}}function jn(u){return Uint8Array.from(atob(u),function(d){return d.charCodeAt(0)})}function Xn(u){return Uint8Array.from(unescape(encodeURIComponent(u)),function(d){return d.charCodeAt(0)})}function Ig(u){var d=Xn(u).subarray(0,16),o=new Uint8Array(16);return o.set(d,16-d.length),o}function Rg(u){var d=function(s,t,i){var a=s[t];s[t]=s[i],s[i]=a};d(u,0,3),d(u,1,2),d(u,4,5),d(u,6,7)}function bg(u){var d=u.split(":"),o=null;if(d[0]==="data"&&d.length===2){var s=d[1].split(";"),t=s[s.length-1].split(",");if(t.length===2){var i=t[0]==="base64",a=t[1];i?(s.splice(-1,1),o=jn(a)):o=Ig(a)}}return o}var xs=typeof self<"u"?self:void 0,Qe={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Ut={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function zn(u){switch(u){case Ut.FAIRPLAY:return Qe.FAIRPLAY;case Ut.PLAYREADY:return Qe.PLAYREADY;case Ut.WIDEVINE:return Qe.WIDEVINE;case Ut.CLEARKEY:return Qe.CLEARKEY}}var Ls={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Qn(u){if(u===Ls.WIDEVINE)return Qe.WIDEVINE;if(u===Ls.PLAYREADY)return Qe.PLAYREADY;if(u===Ls.CENC||u===Ls.CLEARKEY)return Qe.CLEARKEY}function Zn(u){switch(u){case Qe.FAIRPLAY:return Ut.FAIRPLAY;case Qe.PLAYREADY:return Ut.PLAYREADY;case Qe.WIDEVINE:return Ut.WIDEVINE;case Qe.CLEARKEY:return Ut.CLEARKEY}}function Is(u){var d=u.drmSystems,o=u.widevineLicenseUrl,s=d?[Qe.FAIRPLAY,Qe.WIDEVINE,Qe.PLAYREADY,Qe.CLEARKEY].filter(function(t){return!!d[t]}):[];return!s[Qe.WIDEVINE]&&o&&s.push(Qe.WIDEVINE),s}var Yl=function(u){return xs!=null&&(u=xs.navigator)!=null&&u.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function _g(u,d,o,s){var t;switch(u){case Qe.FAIRPLAY:t=["cenc","sinf"];break;case Qe.WIDEVINE:case Qe.PLAYREADY:t=["cenc"];break;case Qe.CLEARKEY:t=["cenc","keyids"];break;default:throw new Error("Unknown key-system: "+u)}return Dg(t,d,o,s)}function Dg(u,d,o,s){var t={initDataTypes:u,persistentState:s.persistentState||"optional",distinctiveIdentifier:s.distinctiveIdentifier||"optional",sessionTypes:s.sessionTypes||[s.sessionType||"temporary"],audioCapabilities:d.map(function(i){return{contentType:"audio/mp4; codecs="+i,robustness:s.audioRobustness||"",encryptionScheme:s.audioEncryptionScheme||null}}),videoCapabilities:o.map(function(i){return{contentType:"video/mp4; codecs="+i,robustness:s.videoRobustness||"",encryptionScheme:s.videoEncryptionScheme||null}})};return[t]}function Wl(u){var d=new Uint16Array(u.buffer,u.byteOffset,u.byteLength/2),o=String.fromCharCode.apply(null,Array.from(d)),s=o.substring(o.indexOf("<"),o.length),t=new DOMParser,i=t.parseFromString(s,"text/xml"),a=i.getElementsByTagName("KID")[0];if(a){var h=a.childNodes[0]?a.childNodes[0].nodeValue:a.getAttribute("VALUE");if(h){var g=jn(h).subarray(0,16);return Rg(g),g}}return null}var Rs={},Jn=function(){function u(o,s,t,i,a){i===void 0&&(i=[1]),a===void 0&&(a=null),this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=o,this.uri=s,this.keyFormat=t,this.keyFormatVersions=i,this.iv=a,this.encrypted=o?o!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!li(o)}u.clearKeyUriToKeyIdMap=function(){Rs={}};var d=u.prototype;return d.isSupported=function(){if(this.method){if(li(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Ut.FAIRPLAY:case Ut.WIDEVINE:case Ut.PLAYREADY:case Ut.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1},d.getDecryptData=function(s){if(!this.encrypted||!this.uri)return null;if(li(this.method)&&this.uri&&!this.iv){typeof s!="number"&&(Ye.warn('missing IV for initialization segment with method="'+this.method+'" - compliance issue'),s=0);var t=Cg(s),i=new u(this.method,this.uri,"identity",this.keyFormatVersions,t);return i}var a=bg(this.uri);if(a)switch(this.keyFormat){case Ut.WIDEVINE:this.pssh=a,a.length>=22&&(this.keyId=a.subarray(a.length-22,a.length-6));break;case Ut.PLAYREADY:{var h=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Fc(h,null,a),this.keyId=Wl(a);break}default:{var g=a.subarray(0,16);if(g.length!==16){var m=new Uint8Array(16);m.set(g,16-g.length),g=m}this.keyId=g;break}}if(!this.keyId||this.keyId.byteLength!==16){var p=Rs[this.uri];if(!p){var E=Object.keys(Rs).length%Number.MAX_SAFE_INTEGER;p=new Uint8Array(16);var x=new DataView(p.buffer,12,4);x.setUint32(0,E),Rs[this.uri]=p}this.keyId=p}return this},u}();function Cg(u){for(var d=new Uint8Array(16),o=12;o<16;o++)d[o]=u>>8*(15-o)&255;return d}var ql=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,jl=/#EXT-X-MEDIA:(.*)/g,Pg=/^#EXT(?:INF|-X-TARGETDURATION):/m,ea=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),kg=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),Ni=function(){function u(){}return u.findGroup=function(o,s){for(var t=0;t<o.length;t++){var i=o[t];if(i.id===s)return i}},u.resolve=function(o,s){return xe.buildAbsoluteURL(s,o,{alwaysNormalize:!0})},u.isMediaPlaylist=function(o){return Pg.test(o)},u.parseMasterPlaylist=function(o,s){var t=$l(o),i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:t},a=[];ql.lastIndex=0;for(var h;(h=ql.exec(o))!=null;)if(h[1]){var g,m=new pt(h[1],i),p=Wn(i,h[2]),E={attrs:m,bitrate:m.decimalInteger("BANDWIDTH")||m.decimalInteger("AVERAGE-BANDWIDTH"),name:m.NAME,url:u.resolve(p,s)},x=m.decimalResolution("RESOLUTION");x&&(E.width=x.width,E.height=x.height),Zl(m.CODECS,E);var I=m["SUPPLEMENTAL-CODECS"];I&&(E.supplemental={},Zl(I,E.supplemental)),(g=E.unknownCodecs)!=null&&g.length||a.push(E),i.levels.push(E)}else if(h[3]){var R=h[3],_=h[4];switch(R){case"SESSION-DATA":{var P=new pt(_,i),O=P["DATA-ID"];O&&(i.sessionData===null&&(i.sessionData={}),i.sessionData[O]=P);break}case"SESSION-KEY":{var N=zl(_,s,i);N.encrypted&&N.isSupported()?(i.sessionKeys===null&&(i.sessionKeys=[]),i.sessionKeys.push(N)):Ye.warn('[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "'+_+'"');break}case"DEFINE":{{var U=new pt(_,i);Kl(i,U,s)}break}case"CONTENT-STEERING":{var B=new pt(_,i);i.contentSteering={uri:u.resolve(B["SERVER-URI"],s),pathwayId:B["PATHWAY-ID"]||"."};break}case"START":{i.startTimeOffset=Ql(_);break}}}var G=a.length>0&&a.length<i.levels.length;return i.levels=G?a:i.levels,i.levels.length===0&&(i.playlistParsingError=new Error("no levels found in manifest")),i},u.parseMasterPlaylistMedia=function(o,s,t){var i,a={},h=t.levels,g={AUDIO:h.map(function(G){return{id:G.attrs.AUDIO,audioCodec:G.audioCodec}}),SUBTITLES:h.map(function(G){return{id:G.attrs.SUBTITLES,textCodec:G.textCodec}}),"CLOSED-CAPTIONS":[]},m=0;for(jl.lastIndex=0;(i=jl.exec(o))!==null;){var p=new pt(i[1],t),E=p.TYPE;if(E){var x=g[E],I=a[E]||[];a[E]=I;var R=p.LANGUAGE,_=p["ASSOC-LANGUAGE"],P=p.CHANNELS,O=p.CHARACTERISTICS,N=p["INSTREAM-ID"],U={attrs:p,bitrate:0,id:m++,groupId:p["GROUP-ID"]||"",name:p.NAME||R||"",type:E,default:p.bool("DEFAULT"),autoselect:p.bool("AUTOSELECT"),forced:p.bool("FORCED"),lang:R,url:p.URI?u.resolve(p.URI,s):""};if(_&&(U.assocLang=_),P&&(U.channels=P),O&&(U.characteristics=O),N&&(U.instreamId=N),x!=null&&x.length){var B=u.findGroup(x,U.groupId)||x[0];Jl(U,B,"audioCodec"),Jl(U,B,"textCodec")}I.push(U)}}return a},u.parseLevelPlaylist=function(o,s,t,i,a,h){var g,m={url:s},p=new Lg(s),E=p.fragments,x=[],I=null,R=0,_=0,P=0,O=0,N=0,U=null,B=new ni(i,m),G,Y,V,j=-1,ae=!1,X=null,W;if(ea.lastIndex=0,p.m3u8=o,p.hasVariableRefs=$l(o),((g=ea.exec(o))==null?void 0:g[0])!=="#EXTM3U")return p.playlistParsingError=new Error("Missing format identifier #EXTM3U"),p;for(;(G=ea.exec(o))!==null;){ae&&(ae=!1,B=new ni(i,m),B.playlistOffset=P,B.start=P,B.sn=R,B.cc=O,N&&(B.bitrate=N),B.level=t,I&&(B.initSegment=I,I.rawProgramDateTime&&(B.rawProgramDateTime=I.rawProgramDateTime,I.rawProgramDateTime=null),X&&(B.setByteRange(X),X=null)));var J=G[1];if(J){B.duration=parseFloat(J);var oe=(" "+G[2]).slice(1);B.title=oe||null,B.tagList.push(oe?["INF",J,oe]:["INF",J])}else if(G[3]){if(ue(B.duration)){B.playlistOffset=P,B.start=P,V&&tu(B,V,p),B.sn=R,B.level=t,B.cc=O,E.push(B);var ge=(" "+G[3]).slice(1);B.relurl=Wn(p,ge),ta(B,U,x),U=B,P+=B.duration,R++,_=0,ae=!0}}else{if(G=G[0].match(kg),!G){Ye.warn("No matches on slow regex match for level playlist!");continue}for(Y=1;Y<G.length&&G[Y]===void 0;Y++);var ce=(" "+G[Y]).slice(1),he=(" "+G[Y+1]).slice(1),ye=G[Y+2]?(" "+G[Y+2]).slice(1):null;switch(ce){case"BYTERANGE":U?B.setByteRange(he,U):B.setByteRange(he);break;case"PROGRAM-DATE-TIME":B.rawProgramDateTime=he,B.tagList.push(["PROGRAM-DATE-TIME",he]),j===-1&&(j=E.length);break;case"PLAYLIST-TYPE":p.type&&Sr(p,ce,G),p.type=he.toUpperCase();break;case"MEDIA-SEQUENCE":p.startSN!==0?Sr(p,ce,G):E.length>0&&ru(p,ce,G),R=p.startSN=parseInt(he);break;case"SKIP":{p.skippedSegments&&Sr(p,ce,G);var Se=new pt(he,p),Le=Se.decimalInteger("SKIPPED-SEGMENTS");if(ue(Le)){p.skippedSegments+=Le;for(var Ie=Le;Ie--;)E.push(null);R+=Le}var He=Se.enumeratedString("RECENTLY-REMOVED-DATERANGES");He&&(p.recentlyRemovedDateranges=(p.recentlyRemovedDateranges||[]).concat(He.split("	")));break}case"TARGETDURATION":p.targetduration!==0&&Sr(p,ce,G),p.targetduration=Math.max(parseInt(he),1);break;case"VERSION":p.version!==null&&Sr(p,ce,G),p.version=parseInt(he);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":p.live||Sr(p,ce,G),p.live=!1;break;case"#":(he||ye)&&B.tagList.push(ye?[he,ye]:[he]);break;case"DISCONTINUITY":O++,B.tagList.push(["DIS"]);break;case"GAP":B.gap=!0,B.tagList.push([ce]);break;case"BITRATE":B.tagList.push([ce,he]),N=parseInt(he)*1e3,ue(N)?B.bitrate=N:N=0;break;case"DATERANGE":{var Oe=new pt(he,p),je=new Hl(Oe,p.dateRanges[Oe.ID],p.dateRangeTagCount);p.dateRangeTagCount++,je.isValid||p.skippedSegments?p.dateRanges[je.id]=je:Ye.warn('Ignoring invalid DATERANGE tag: "'+he+'"'),B.tagList.push(["EXT-X-DATERANGE",he]);break}case"DEFINE":{{var Fe=new pt(he,p);"IMPORT"in Fe?yg(p,Fe,h):Kl(p,Fe,s)}break}case"DISCONTINUITY-SEQUENCE":p.startCC!==0?Sr(p,ce,G):E.length>0&&ru(p,ce,G),p.startCC=O=parseInt(he);break;case"KEY":{var Xe=zl(he,s,p);if(Xe.isSupported()){if(Xe.method==="NONE"){V=void 0;break}V||(V={}),V[Xe.keyFormat]&&(V=A({},V)),V[Xe.keyFormat]=Xe}else Ye.warn('[Keys] Ignoring invalid EXT-X-KEY tag: "'+he+'"');break}case"START":p.startTimeOffset=Ql(he);break;case"MAP":{var ze=new pt(he,p);if(B.duration){var it=new ni(i,m);eu(it,ze,t,V),I=it,B.initSegment=I,I.rawProgramDateTime&&!B.rawProgramDateTime&&(B.rawProgramDateTime=I.rawProgramDateTime)}else{var yt=B.byteRangeEndOffset;if(yt){var gt=B.byteRangeStartOffset;X=yt-gt+"@"+gt}else X=null;eu(B,ze,t,V),I=B,ae=!0}I.cc=O;break}case"SERVER-CONTROL":{W&&Sr(p,ce,G),W=new pt(he),p.canBlockReload=W.bool("CAN-BLOCK-RELOAD"),p.canSkipUntil=W.optionalFloat("CAN-SKIP-UNTIL",0),p.canSkipDateRanges=p.canSkipUntil>0&&W.bool("CAN-SKIP-DATERANGES"),p.partHoldBack=W.optionalFloat("PART-HOLD-BACK",0),p.holdBack=W.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{p.partTarget&&Sr(p,ce,G);var nt=new pt(he);p.partTarget=nt.decimalFloatingPoint("PART-TARGET");break}case"PART":{var Et=p.partList;Et||(Et=p.partList=[]);var ut=_>0?Et[Et.length-1]:void 0,Ge=_++,Mt=new pt(he,p),Dt=new Yr(Mt,B,m,Ge,ut);Et.push(Dt),B.duration+=Dt.duration;break}case"PRELOAD-HINT":{var Lt=new pt(he,p);p.preloadHint=Lt;break}case"RENDITION-REPORT":{var vt=new pt(he,p);p.renditionReports=p.renditionReports||[],p.renditionReports.push(vt);break}default:Ye.warn("line parsed but not handled: "+G);break}}}U&&!U.relurl?(E.pop(),P-=U.duration,p.partList&&(p.fragmentHint=U)):p.partList&&(ta(B,U,x),B.cc=O,p.fragmentHint=B,V&&tu(B,V,p)),p.targetduration||(p.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));var St=E.length,ht=E[0],Tt=E[St-1];if(P+=p.skippedSegments*p.targetduration,P>0&&St&&Tt){p.averagetargetduration=P/St;var fr=Tt.sn;p.endSN=fr!=="initSegment"?fr:0,p.live||(Tt.endList=!0),ht&&p.startCC===void 0&&(p.startCC=ht.cc),j>0&&(Og(E,j),ht&&x.unshift(ht))}else p.endSN=0,p.startCC=0;return p.fragmentHint&&(P+=p.fragmentHint.duration),p.totalduration=P,x.length&&p.dateRangeTagCount&&ht&&Xl(x,p),p.endCC=O,p},u}();function Xl(u,d){for(var o=u.length,s=u[o-1],t=d.live?1/0:d.totalduration,i=Object.keys(d.dateRanges),a=i.length;a--;){var h=d.dateRanges[i[a]],g=h.startDate.getTime();h.tagAnchor=s.ref;for(var m=o;m--;){var p=wg(d,g,u,m,t);if(p!==-1){h.tagAnchor=d.fragments[p].ref;break}}}}function wg(u,d,o,s,t){var i=o[s];if(i){var a=i.programDateTime;if(d>=a||s===0){var h,g=(((h=o[s+1])==null?void 0:h.start)||t)-i.start;if(d<=a+g*1e3){var m=o[s].sn-u.startSN,p=u.fragments;if(p.length>o.length)for(var E=o[s+1]||p[p.length-1],x=E.sn-u.startSN,I=x;I>m;I--){var R=p[I].programDateTime;if(d>=R&&d<R+p[I].duration*1e3)return I}return m}}}return-1}function zl(u,d,o){var s,t,i=new pt(u,o),a=(s=i.METHOD)!=null?s:"",h=i.URI,g=i.hexadecimalInteger("IV"),m=i.KEYFORMATVERSIONS,p=(t=i.KEYFORMAT)!=null?t:"identity";h&&i.IV&&!g&&Ye.error("Invalid IV: "+i.IV);var E=h?Ni.resolve(h,d):"",x=(m||"1").split("/").map(Number).filter(Number.isFinite);return new Jn(a,E,p,x,g)}function Ql(u){var d=new pt(u),o=d.decimalFloatingPoint("TIME-OFFSET");return ue(o)?o:null}function Zl(u,d){var o=(u||"").split(/[ ,]+/).filter(function(s){return s});["video","audio","text"].forEach(function(s){var t=o.filter(function(i){return ml(i,s)});t.length&&(d[s+"Codec"]=t.map(function(i){return i.split("/")[0]}).join(","),o=o.filter(function(i){return t.indexOf(i)===-1}))}),d.unknownCodecs=o}function Jl(u,d,o){var s=d[o];s&&(u[o]=s)}function Og(u,d){for(var o=u[d],s=d;s--;){var t=u[s];if(!t)return;t.programDateTime=o.programDateTime-t.duration*1e3,o=t}}function ta(u,d,o){u.rawProgramDateTime?o.push(u):d!=null&&d.programDateTime&&(u.programDateTime=d.endProgramDateTime)}function eu(u,d,o,s){u.relurl=d.URI,d.BYTERANGE&&u.setByteRange(d.BYTERANGE),u.level=o,u.sn="initSegment",s&&(u.levelkeys=s),u.initSegment=null}function tu(u,d,o){u.levelkeys=d;var s=o.encryptedFragments;(!s.length||s[s.length-1].levelkeys!==d)&&Object.keys(d).some(function(t){return d[t].isCommonEncryption})&&s.push(u)}function Sr(u,d,o){u.playlistParsingError=new Error("#EXT-X-"+d+" must not appear more than once ("+o[0]+")")}function ru(u,d,o){u.playlistParsingError=new Error("#EXT-X-"+d+" must appear before the first Media Segment ("+o[0]+")")}function ra(u,d){var o=d.startPTS;if(ue(o)){var s=0,t;d.sn>u.sn?(s=o-u.start,t=u):(s=u.start-o,t=d),t.duration!==s&&t.setDuration(s)}else if(d.sn>u.sn){var i=u.cc===d.cc;i&&u.minEndPTS?d.setStart(u.start+(u.minEndPTS-u.start)):d.setStart(u.start+u.duration)}else d.setStart(Math.max(u.start-d.duration,0))}function iu(u,d,o,s,t,i){var a=s-o;a<=0&&(Ye.warn("Fragment should have a positive duration",d),s=o+d.duration,i=t+d.duration);var h=o,g=s,m=d.startPTS,p=d.endPTS;if(ue(m)){var E=Math.abs(m-o);ue(d.deltaPTS)?d.deltaPTS=Math.max(E,d.deltaPTS):d.deltaPTS=E,h=Math.max(o,m),o=Math.min(o,m),t=Math.min(t,d.startDTS),g=Math.min(s,p),s=Math.max(s,p),i=Math.max(i,d.endDTS)}var x=o-d.start;d.start!==0&&d.setStart(o),d.setDuration(s-d.start),d.startPTS=o,d.maxStartPTS=h,d.startDTS=t,d.endPTS=s,d.minEndPTS=g,d.endDTS=i;var I=d.sn;if(!u||I<u.startSN||I>u.endSN)return 0;var R,_=I-u.startSN,P=u.fragments;for(P[_]=d,R=_;R>0;R--)ra(P[R],P[R-1]);for(R=_;R<P.length-1;R++)ra(P[R],P[R+1]);return u.fragmentHint&&ra(P[P.length-1],u.fragmentHint),u.PTSKnown=u.alignedSliding=!0,x}function Mg(u,d){if(u!==d){for(var o=null,s=u.fragments,t=s.length-1;t>=0;t--){var i=s[t].initSegment;if(i){o=i;break}}u.fragmentHint&&delete u.fragmentHint.endPTS;var a;Ug(u,d,function(R,_,P,O){if(d.skippedSegments&&_.cc!==R.cc)for(var N=R.cc-_.cc,U=P;U<O.length;U++)O[U].cc+=N;ue(R.startPTS)&&ue(R.endPTS)&&(_.setStart(_.startPTS=R.startPTS),_.startDTS=R.startDTS,_.maxStartPTS=R.maxStartPTS,_.endPTS=R.endPTS,_.endDTS=R.endDTS,_.minEndPTS=R.minEndPTS,_.setDuration(R.endPTS-R.startPTS),_.duration&&(a=_),d.PTSKnown=d.alignedSliding=!0),R.hasStreams&&(_.elementaryStreams=R.elementaryStreams),_.loader=R.loader,R.hasStats&&(_.stats=R.stats),R.initSegment&&(_.initSegment=R.initSegment,o=R.initSegment)});var h=d.fragments,g=d.fragmentHint?h.concat(d.fragmentHint):h;if(o&&g.forEach(function(R){var _;R&&(!R.initSegment||R.initSegment.relurl===((_=o)==null?void 0:_.relurl))&&(R.initSegment=o)}),d.skippedSegments)if(d.deltaUpdateFailed=h.some(function(R){return!R}),d.deltaUpdateFailed){Ye.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var m=d.skippedSegments;m--;)h.shift();d.startSN=h[0].sn}else{d.endCC=h[h.length-1].cc,d.canSkipDateRanges&&(d.dateRanges=Fg(u.dateRanges,d));var p=u.fragments.filter(function(R){return R.rawProgramDateTime});if(u.hasProgramDateTime&&!d.hasProgramDateTime)for(var E=1;E<g.length;E++)g[E].programDateTime===null&&ta(g[E],g[E-1],p);Xl(p,d)}Ng(u.partList,d.partList,function(R,_){_.elementaryStreams=R.elementaryStreams,_.stats=R.stats}),a?iu(d,a,a.startPTS,a.endPTS,a.startDTS,a.endDTS):nu(u,d),h.length&&(d.totalduration=d.edge-h[0].start),d.driftStartTime=u.driftStartTime,d.driftStart=u.driftStart;var x=d.advancedDateTime;if(d.advanced&&x){var I=d.edge;d.driftStart||(d.driftStartTime=x,d.driftStart=I),d.driftEndTime=x,d.driftEnd=I}else d.driftEndTime=u.driftEndTime,d.driftEnd=u.driftEnd,d.advancedDateTime=u.advancedDateTime;d.requestScheduled===-1&&(d.requestScheduled=u.requestScheduled)}}function Fg(u,d){var o=d.dateRanges,s=d.recentlyRemovedDateranges,t=A({},u);s&&s.forEach(function(h){delete t[h]});var i=Object.keys(t),a=i.length;return a&&Object.keys(o).forEach(function(h){var g=t[h],m=new Hl(o[h].attr,g);m.isValid?(t[h]=m,g||(m.tagOrder+=a)):Ye.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+at(o[h].attr)+'"')}),t}function Ng(u,d,o){if(u&&d)for(var s=0,t=0,i=u.length;t<=i;t++){var a=u[t],h=d[t+s];a&&h&&a.index===h.index&&a.fragment.sn===h.fragment.sn?o(a,h):s--}}function Ug(u,d,o){for(var s=d.skippedSegments,t=Math.max(u.startSN,d.startSN)-d.startSN,i=(u.fragmentHint?1:0)+(s?d.endSN:Math.min(u.endSN,d.endSN))-d.startSN,a=d.startSN-u.startSN,h=d.fragmentHint?d.fragments.concat(d.fragmentHint):d.fragments,g=u.fragmentHint?u.fragments.concat(u.fragmentHint):u.fragments,m=t;m<=i;m++){var p=g[a+m],E=h[m];if(s&&!E&&p&&(E=d.fragments[m]=p),p&&E){if(o(p,E,m,h),p.url&&p.url!==E.url){d.playlistParsingError=su("media sequence mismatch "+E.sn+":",u,d,p,E);return}else if(p.cc!==E.cc){d.playlistParsingError=su("discontinuity sequence mismatch ("+p.cc+"!="+E.cc+")",u,d,p,E);return}}}}function su(u,d,o,s,t){return new Error(u+" "+t.url+`
Playlist starting @`+d.startSN+`
`+d.m3u8+`

Playlist starting @`+o.startSN+`
`+o.m3u8)}function nu(u,d,o){o===void 0&&(o=!0);var s=d.startSN+d.skippedSegments-u.startSN,t=u.fragments,i=s>=0,a=0;if(i&&s<t.length)a=t[s].start;else if(i&&d.startSN===u.endSN+1)a=u.fragmentEnd;else if(i&&o)a=u.fragmentStart+s*d.levelTargetDuration;else if(!d.skippedSegments&&d.fragmentStart===0)a=u.fragmentStart;else return;ia(d,a)}function ia(u,d){if(d){for(var o=u.fragments,s=u.skippedSegments;s<o.length;s++)o[s].addStart(d);u.fragmentHint&&u.fragmentHint.addStart(d)}}function au(u,d){d===void 0&&(d=1/0);var o=1e3*u.targetduration;if(u.updated){var s=u.fragments,t=4;if(s.length&&o*t>d){var i=s[s.length-1].duration*1e3;i<o&&(o=i)}}else o/=2;return Math.round(o)}function Bg(u,d,o){if(!u)return null;var s=u.fragments[d-u.startSN];return s||(s=u.fragmentHint,s&&s.sn===d)?s:d<u.startSN&&o&&o.sn===d?o:null}function ou(u,d,o){return u?lu(u.partList,d,o):null}function lu(u,d,o){if(u)for(var s=u.length;s--;){var t=u[s];if(t.index===o&&t.fragment.sn===d)return t}return null}function uu(u){u.forEach(function(d,o){var s;(s=d.details)==null||s.fragments.forEach(function(t){t.level=o,t.initSegment&&(t.initSegment.level=o)})})}function Ui(u,d){for(var o=0,s=u.length;o<s;o++){var t;if(((t=u[o])==null?void 0:t.cc)===d)return u[o]}return null}function Gg(u,d){return!!(u&&d.startCC<u.endCC&&d.endCC>u.startCC)}function hu(u,d){if(u){var o=u.start+d;u.start=u.startPTS=o,u.endPTS=o+u.duration}}function fu(u,d){for(var o=d.fragments,s=0,t=o.length;s<t;s++)hu(o[s],u);d.fragmentHint&&hu(d.fragmentHint,u),d.alignedSliding=!0}function $g(u,d){u&&(du(d,u),!d.alignedSliding&&u&&bs(d,u),!d.alignedSliding&&u&&!d.skippedSegments&&nu(u,d,!1))}function du(u,d){if(Gg(d,u)){var o=Math.min(d.endCC,u.endCC),s=Ui(d.fragments,o),t=Ui(u.fragments,o);if(!(!s||!t)){Ye.log("Aligning playlist at start of dicontinuity sequence "+o);var i=s.start-t.start;fu(i,u)}}}function bs(u,d){if(!(!u.hasProgramDateTime||!d.hasProgramDateTime)){var o=u.fragments,s=d.fragments;if(!(!o.length||!s.length)){var t,i,a=Math.min(d.endCC,u.endCC);d.startCC<a&&u.startCC<a&&(t=Ui(s,a),i=Ui(o,a)),(!t||!i)&&(t=s[Math.floor(s.length/2)],i=Ui(o,t.cc)||o[Math.floor(o.length/2)]);var h=t.programDateTime,g=i.programDateTime;if(!(!h||!g)){var m=(g-h)/1e3-(i.start-t.start);fu(m,u)}}}}var Kg={toString:function(d){for(var o="",s=d.length,t=0;t<s;t++)o+="["+d.start(t).toFixed(3)+"-"+d.end(t).toFixed(3)+"]";return o}},fe={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},sa=function(u){function d(s,t,i,a,h){var g;return g=u.call(this,a,s.logger)||this,g.hls=void 0,g.fragPrevious=null,g.fragCurrent=null,g.fragmentTracker=void 0,g.transmuxer=null,g._state=fe.STOPPED,g.playlistType=void 0,g.media=null,g.mediaBuffer=null,g.config=void 0,g.bitrateTest=!1,g.lastCurrentTime=0,g.nextLoadPosition=0,g.startPosition=0,g.startTimeOffset=null,g.retryDate=0,g.levels=null,g.fragmentLoader=void 0,g.keyLoader=void 0,g.levelLastLoaded=null,g.startFragRequested=!1,g.decrypter=void 0,g.initPTS=[],g.buffering=!0,g.loadingParts=!1,g.loopSn=void 0,g.onMediaSeeking=function(){var m=g,p=m.config,E=m.fragCurrent,x=m.media,I=m.mediaBuffer,R=m.state,_=x?x.currentTime:0,P=We.bufferInfo(I||x,_,p.maxBufferHole);if(g.log("media seeking to "+(ue(_)?_.toFixed(3):_)+", state: "+R),g.state===fe.ENDED)g.resetLoadingState();else if(E){var O=p.maxFragLookUpTolerance,N=E.start-O,U=E.start+E.duration+O;if(!P.len||U<P.start||N>P.end){var B=_>U;(_<N||B)&&(B&&E.loader&&(g.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),E.abortRequests(),g.resetLoadingState()),g.fragPrevious=null)}}if(x){g.fragmentTracker.removeFragmentsInRange(_,1/0,g.playlistType,!0);var G=g.lastCurrentTime;if(_>G&&(g.lastCurrentTime=_),!g.loadingParts){var Y=Math.max(P.end,_),V=g.shouldLoadParts(g.getLevelDetails(),Y);V&&(g.log("LL-Part loading ON after seeking to "+_.toFixed(2)+" with buffer @"+Y.toFixed(2)),g.loadingParts=V)}}!g.hls.hasEnoughToStart&&!P.len&&(g.log("setting startPosition to "+_+" because of seek before start"),g.nextLoadPosition=g.startPosition=_),g.tickImmediate()},g.onMediaEnded=function(){g.log("setting startPosition to 0 because media ended"),g.startPosition=g.lastCurrentTime=0},g.playlistType=h,g.hls=s,g.fragmentLoader=new mg(s.config),g.keyLoader=i,g.fragmentTracker=t,g.config=s.config,g.decrypter=new Hn(s.config),g}b(d,u);var o=d.prototype;return o.registerListeners=function(){var t=this.hls;t.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(k.ERROR,this.onError,this)},o.unregisterListeners=function(){var t=this.hls;t.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(k.ERROR,this.onError,this)},o.doTick=function(){this.onTickEnd()},o.onTickEnd=function(){},o.startLoad=function(t){},o.stopLoad=function(){if(this.state!==fe.STOPPED){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);var t=this.fragCurrent;t!=null&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=fe.STOPPED}},o.pauseBuffering=function(){this.buffering=!1},o.resumeBuffering=function(){this.buffering=!0},o._streamEnded=function(t,i){if(i.live||!this.media)return!1;var a=t.end||0,h=this.config.timelineOffset||0;if(a<=h)return!1;var g=t.nextStart,m=g&&g>h&&g<i.edge;if(m||this.media.currentTime<t.start)return!1;var p=i.partList;if(p!=null&&p.length){var E=p[p.length-1],x=We.isBuffered(this.media,E.start+E.duration/2);return x}var I=i.fragments[i.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(I)},o.getLevelDetails=function(){if(this.levels&&this.levelLastLoaded!==null){var t;return(t=this.levelLastLoaded)==null?void 0:t.details}},o.onMediaAttached=function(t,i){var a=this.media=this.mediaBuffer=i.media;a.removeEventListener("seeking",this.onMediaSeeking),a.removeEventListener("ended",this.onMediaEnded),a.addEventListener("seeking",this.onMediaSeeking),a.addEventListener("ended",this.onMediaEnded);var h=this.config;this.levels&&h.autoStartLoad&&this.state===fe.STOPPED&&this.startLoad(h.startPosition)},o.onMediaDetaching=function(t,i){var a=!!i.transferMedia,h=this.media;if(h!==null){if(h.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),h.removeEventListener("seeking",this.onMediaSeeking),h.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!a&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,a){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}},o.onManifestLoading=function(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1},o.onError=function(t,i){},o.onManifestLoaded=function(t,i){this.startTimeOffset=i.startTimeOffset},o.onHandlerDestroying=function(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),u.prototype.onHandlerDestroying.call(this),this.hls=this.onMediaSeeking=this.onMediaEnded=null},o.onHandlerDestroyed=function(){this.state=fe.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,u.prototype.onHandlerDestroyed.call(this)},o.loadFragment=function(t,i,a){this.startFragRequested=!0,this._loadFragForPlayback(t,i,a)},o._loadFragForPlayback=function(t,i,a){var h=this,g=function(p){var E=p.frag;if(h.fragContextChanged(E)){h.warn(E.type+" sn: "+E.sn+(p.part?" part: "+p.part.index:"")+" of "+h.fragInfo(E,!1,p.part)+") was dropped during download."),h.fragmentTracker.removeFragment(E);return}E.stats.chunkCount++,h._handleFragmentLoadProgress(p)};this._doFragLoad(t,i,a,g).then(function(m){if(m){var p=h.state,E=m.frag;if(h.fragContextChanged(E)){(p===fe.FRAG_LOADING||!h.fragCurrent&&p===fe.PARSING)&&(h.fragmentTracker.removeFragment(E),h.state=fe.IDLE);return}"payload"in m&&(h.log("Loaded "+E.type+" sn: "+E.sn+" of "+h.playlistLabel()+" "+E.level),h.hls.trigger(k.FRAG_LOADED,m)),h._handleFragmentLoadComplete(m)}}).catch(function(m){h.state===fe.STOPPED||h.state===fe.ERROR||(h.warn("Frag error: "+((m==null?void 0:m.message)||m)),h.resetFragmentLoading(t))})},o.clearTrackerIfNeeded=function(t){var i,a=this.fragmentTracker,h=a.getState(t);if(h===xt.APPENDING){var g=t.type,m=this.getFwdBufferInfo(this.mediaBuffer,g),p=Math.max(t.duration,m?m.len:this.config.maxBufferLength),E=this.backtrackFragment,x=E?t.sn-E.sn:0;(x===1||this.reduceMaxBufferLength(p,t.duration))&&a.removeFragment(t)}else((i=this.mediaBuffer)==null?void 0:i.buffered.length)===0?a.removeAllFragments():a.hasParts(t.type)&&(a.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),a.getState(t)===xt.PARTIAL&&a.removeFragment(t))},o.checkLiveUpdate=function(t){if(t.updated&&!t.live){var i=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:i,part:null,stats:i.stats,id:i.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)},o.waitForLive=function(t){var i=t.details;return(i==null?void 0:i.live)&&i.type!=="EVENT"&&(this.levelLastLoaded!==t||i.expired)},o.flushMainBuffer=function(t,i,a){if(a===void 0&&(a=null),!!(t-i)){var h={startOffset:t,endOffset:i,type:a};this.hls.trigger(k.BUFFER_FLUSHING,h)}},o._loadInitSegment=function(t,i){var a=this;this._doFragLoad(t,i).then(function(h){var g=h==null?void 0:h.frag;if(!g||a.fragContextChanged(g)||!a.levels)throw new Error("init load aborted");return h}).then(function(h){var g=a.hls,m=h.frag,p=h.payload,E=m.decryptdata;if(p&&p.byteLength>0&&E!=null&&E.key&&E.iv&&li(E.method)){var x=self.performance.now();return a.decrypter.decrypt(new Uint8Array(p),E.key.buffer,E.iv.buffer,qn(E.method)).catch(function(I){throw g.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_DECRYPT_ERROR,fatal:!1,error:I,reason:I.message,frag:m}),I}).then(function(I){var R=self.performance.now();return g.trigger(k.FRAG_DECRYPTED,{frag:m,payload:I,stats:{tstart:x,tdecrypt:R}}),h.payload=I,a.completeInitSegmentLoad(h)})}return a.completeInitSegmentLoad(h)}).catch(function(h){a.state===fe.STOPPED||a.state===fe.ERROR||(a.warn(h),a.resetFragmentLoading(t))})},o.completeInitSegmentLoad=function(t){var i=this.levels;if(!i)throw new Error("init load aborted, missing levels");var a=t.frag.stats;this.state!==fe.STOPPED&&(this.state=fe.IDLE),t.frag.data=new Uint8Array(t.payload),a.parsing.start=a.buffering.start=self.performance.now(),a.parsing.end=a.buffering.end=self.performance.now(),this.tick()},o.fragContextChanged=function(t){var i=this.fragCurrent;return!t||!i||t.sn!==i.sn||t.level!==i.level},o.fragBufferedComplete=function(t,i){var a=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log("Buffered "+t.type+" sn: "+t.sn+(i?" part: "+i.index:"")+" of "+this.fragInfo(t,!1,i)+" > buffer:"+(a?Kg.toString(We.getBuffered(a)):"(detached)")+")"),ct(t)){var h;if(t.type!==pe.SUBTITLE){var g=t.elementaryStreams;if(!Object.keys(g).some(function(p){return!!g[p]})){this.state=fe.IDLE;return}}var m=(h=this.levels)==null?void 0:h[t.level];m!=null&&m.fragmentError&&(this.log("Resetting level fragment error count of "+m.fragmentError+" on frag buffered"),m.fragmentError=0)}this.state=fe.IDLE},o._handleFragmentLoadComplete=function(t){var i=this.transmuxer;if(i){var a=t.frag,h=t.part,g=t.partsLoaded,m=!g||g.length===0||g.some(function(E){return!E}),p=new Yn(a.level,a.sn,a.stats.chunkCount+1,0,h?h.index:-1,!m);i.flush(p)}},o._handleFragmentLoadProgress=function(t){},o._doFragLoad=function(t,i,a,h){var g,m=this;a===void 0&&(a=null),this.fragCurrent=t;var p=i==null?void 0:i.details;if(!this.levels||!p)throw new Error("frag load aborted, missing level"+(p?"":" detail")+"s");var E=null;t.encrypted&&!((g=t.decryptdata)!=null&&g.key)?(this.log("Loading key for "+t.sn+" of ["+p.startSN+"-"+p.endSN+"], "+this.playlistLabel()+" "+t.level),this.state=fe.KEY_LOADING,this.fragCurrent=t,E=this.keyLoader.load(t).then(function(B){if(!m.fragContextChanged(B.frag))return m.hls.trigger(k.KEY_LOADED,B),m.state===fe.KEY_LOADING&&(m.state=fe.IDLE),B}),this.hls.trigger(k.KEY_LOADING,{frag:t}),this.fragCurrent===null&&(E=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!t.encrypted&&p.encryptedFragments.length&&this.keyLoader.loadClear(t,p.encryptedFragments);var x=this.fragPrevious;if(ct(t)&&(!x||t.sn!==x.sn)){var I=this.shouldLoadParts(i.details,t.end);I!==this.loadingParts&&(this.log("LL-Part loading "+(I?"ON":"OFF")+" loading sn "+(x==null?void 0:x.sn)+"->"+t.sn),this.loadingParts=I)}if(a=Math.max(t.start,a||0),this.loadingParts&&ct(t)){var R=p.partList;if(R&&h){a>t.end&&p.fragmentHint&&(t=p.fragmentHint);var _=this.getNextPart(R,t,a);if(_>-1){var P=R[_];t=this.fragCurrent=P.fragment,this.log("Loading "+t.type+" sn: "+t.sn+" part: "+P.index+" ("+_+"/"+(R.length-1)+") of "+this.fragInfo(t,!1,P)+") cc: "+t.cc+" ["+p.startSN+"-"+p.endSN+"], target: "+parseFloat(a.toFixed(3))),this.nextLoadPosition=P.start+P.duration,this.state=fe.FRAG_LOADING;var O;return E?O=E.then(function(B){return!B||m.fragContextChanged(B.frag)?null:m.doFragPartsLoad(t,P,i,h)}).catch(function(B){return m.handleFragLoadError(B)}):O=this.doFragPartsLoad(t,P,i,h).catch(function(B){return m.handleFragLoadError(B)}),this.hls.trigger(k.FRAG_LOADING,{frag:t,part:P,targetBufferTime:a}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):O}else if(!t.url||this.loadedEndOfParts(R,a))return Promise.resolve(null)}}if(ct(t)&&this.loadingParts)this.log("LL-Part loading OFF after next part miss @"+a.toFixed(2)),this.loadingParts=!1;else if(!t.url)return Promise.resolve(null);this.log("Loading "+t.type+" sn: "+t.sn+" of "+this.fragInfo(t,!1)+") cc: "+t.cc+" "+(p?"["+p.startSN+"-"+p.endSN+"]":"")+", target: "+parseFloat(a.toFixed(3))),ue(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=fe.FRAG_LOADING;var N=this.config.progressive,U;return N&&E?U=E.then(function(B){return!B||m.fragContextChanged(B==null?void 0:B.frag)?null:m.fragmentLoader.load(t,h)}).catch(function(B){return m.handleFragLoadError(B)}):U=Promise.all([this.fragmentLoader.load(t,N?h:void 0),E]).then(function(B){var G=B[0];return!N&&G&&h&&h(G),G}).catch(function(B){return m.handleFragLoadError(B)}),this.hls.trigger(k.FRAG_LOADING,{frag:t,targetBufferTime:a}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):U},o.doFragPartsLoad=function(t,i,a,h){var g=this;return new Promise(function(m,p){var E,x=[],I=(E=a.details)==null?void 0:E.partList,R=function(P){g.fragmentLoader.loadPart(t,P,h).then(function(O){x[P.index]=O;var N=O.part;g.hls.trigger(k.FRAG_LOADED,O);var U=ou(a.details,t.sn,P.index+1)||lu(I,t.sn,P.index+1);if(U)R(U);else return m({frag:t,part:N,partsLoaded:x})}).catch(p)};R(i)})},o.handleFragLoadError=function(t){if("data"in t){var i=t.data;t.data&&i.details===q.INTERNAL_ABORTED?this.handleFragLoadAborted(i.frag,i.part):this.hls.trigger(k.ERROR,i)}else this.hls.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null},o._handleTransmuxerFlush=function(t){var i=this.getCurrentContext(t);if(!i||this.state!==fe.PARSING){!this.fragCurrent&&this.state!==fe.STOPPED&&this.state!==fe.ERROR&&(this.state=fe.IDLE);return}var a=i.frag,h=i.part,g=i.level,m=self.performance.now();a.stats.parsing.end=m,h&&(h.stats.parsing.end=m);var p=this.getLevelDetails(),E=p&&a.sn>p.endSN,x=E||this.shouldLoadParts(p,a.end);x!==this.loadingParts&&(this.log("LL-Part loading "+(x?"ON":"OFF")+" after parsing segment ending @"+a.end.toFixed(2)),this.loadingParts=x),this.updateLevelTiming(a,h,g,t.partial)},o.shouldLoadParts=function(t,i){if(this.config.lowLatencyMode){if(!t)return this.loadingParts;if(t!=null&&t.partList){var a,h=t.partList[0],g=h.end+(((a=t.fragmentHint)==null?void 0:a.duration)||0);if(i>=g){var m,p=this.hls.hasEnoughToStart?((m=this.media)==null?void 0:m.currentTime)||this.lastCurrentTime:this.getLoadPosition();if(p>h.start-h.fragment.duration)return!0}}}return!1},o.getCurrentContext=function(t){var i=this.levels,a=this.fragCurrent,h=t.level,g=t.sn,m=t.part;if(!(i!=null&&i[h]))return this.warn("Levels object was unset while buffering fragment "+g+" of "+this.playlistLabel()+" "+h+". The current chunk will not be buffered."),null;var p=i[h],E=p.details,x=m>-1?ou(E,g,m):null,I=x?x.fragment:Bg(E,g,a);return I?(a&&a!==I&&(I.stats=a.stats),{frag:I,part:x,level:p}):null},o.bufferFragmentData=function(t,i,a,h,g){var m;if(!(!t||this.state!==fe.PARSING)){var p=t.data1,E=t.data2,x=p;if(p&&E&&(x=Yt(p,E)),!!((m=x)!=null&&m.length)){var I={type:t.type,frag:i,part:a,chunkMeta:h,parent:i.type,data:x};if(this.hls.trigger(k.BUFFER_APPENDING,I),t.dropped&&t.independent&&!a){if(g)return;this.flushBufferGap(i)}}}},o.flushBufferGap=function(t){var i=this.media;if(i){if(!We.isBuffered(i,i.currentTime)){this.flushMainBuffer(0,t.start);return}var a=i.currentTime,h=We.bufferInfo(i,a,0),g=t.duration,m=Math.min(this.config.maxFragLookUpTolerance*2,g*.25),p=Math.max(Math.min(t.start-m,h.end-m),a+m);t.start-p>m&&this.flushMainBuffer(p,t.start)}},o.getFwdBufferInfo=function(t,i){var a,h=this.getLoadPosition();if(!ue(h))return null;var g=this.lastCurrentTime>h,m=g||(a=this.media)!=null&&a.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(t,h,i,m)},o.getFwdBufferInfoAtPos=function(t,i,a,h){var g=We.bufferInfo(t,i,h);if(g.len===0&&g.nextStart!==void 0){var m=this.fragmentTracker.getBufferedFrag(i,a);if(m&&(g.nextStart<=m.end||m.gap)){var p=Math.max(Math.min(g.nextStart,m.end)-i,h);return We.bufferInfo(t,i,p)}}return g},o.getMaxBufferLength=function(t){var i=this.config,a;return t?a=Math.max(8*i.maxBufferSize/t,i.maxBufferLength):a=i.maxBufferLength,Math.min(a,i.maxMaxBufferLength)},o.reduceMaxBufferLength=function(t,i){var a=this.config,h=Math.max(Math.min(t-i,a.maxBufferLength),i),g=Math.max(t-i*3,a.maxMaxBufferLength/2,h);return g>=h?(a.maxMaxBufferLength=g,this.warn("Reduce max buffer length to "+g+"s"),!0):!1},o.getAppendedFrag=function(t,i){var a;i===void 0&&(i=pe.MAIN);var h=(a=this.fragmentTracker)==null?void 0:a.getAppendedFrag(t,i);return h&&"fragment"in h?h.fragment:h},o.getNextFragment=function(t,i){var a=i.fragments,h=a.length;if(!h)return null;var g=this.config,m=a[0].start,p=g.lowLatencyMode&&!!i.partList,E=null;if(i.live){var x=g.initialLiveManifestSize;if(h<x)return this.warn("Not enough fragments to start playback (have: "+h+", need: "+x+")"),null;if(!i.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||t<m){var I;p&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),E=this.getInitialLiveFragment(i,a);var R=this.hls.startPosition,_=this.hls.liveSyncPosition,P=E?(R!==-1&&R>=m?R:_)||E.start:t;this.log("Setting startPosition to "+P+" to match start frag at live edge. mainStart: "+R+" liveSyncPosition: "+_+" frag.start: "+((I=E)==null?void 0:I.start)),this.startPosition=this.nextLoadPosition=P}}else t<=m&&(E=a[0]);if(!E){var O=this.loadingParts?i.partEnd:i.fragmentEnd;E=this.getFragmentAtPosition(t,O,i)}var N=this.filterReplacedPrimary(E,i);if(!N&&E){var U=E.sn-i.startSN;N=this.filterReplacedPrimary(a[U+1]||null,i)}return this.mapToInitFragWhenRequired(N)},o.isLoopLoading=function(t,i){var a=this.fragmentTracker.getState(t);return(a===xt.OK||a===xt.PARTIAL&&!!t.gap)&&this.nextLoadPosition>i},o.getNextFragmentLoopLoading=function(t,i,a,h,g){var m=null;if(t.gap&&(m=this.getNextFragment(this.nextLoadPosition,i),m&&!m.gap&&a.nextStart)){var p=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,a.nextStart,h,0);if(p!==null&&a.len+p.len>=g){var E=m.sn;return this.loopSn!==E&&(this.log('buffer full after gaps in "'+h+'" playlist starting at sn: '+E),this.loopSn=E),null}}return this.loopSn=void 0,m},o.filterReplacedPrimary=function(t,i){if(!t)return t;if(cu(this.hls.config)&&t.type!==pe.SUBTITLE){var a=this.hls.interstitialsManager,h=a==null?void 0:a.bufferingItem;if(h){var g=h.event;if(g){if(g.appendInPlace||Math.abs(t.start-h.start)>1||h.start===0)return null}else if(t.end<=h.start&&(i==null?void 0:i.live)===!1||t.start>h.end&&h.nextEvent&&(h.nextEvent.appendInPlace||t.start-h.end>1))return null}var m=a==null?void 0:a.playerQueue;if(m)for(var p=m.length;p--;){var E=m[p].interstitial;if(E.appendInPlace&&t.start>=E.startTime&&t.end<=E.resumeTime)return null}}return t},o.mapToInitFragWhenRequired=function(t){return t!=null&&t.initSegment&&!(t!=null&&t.initSegment.data)&&!this.bitrateTest?t.initSegment:t},o.getNextPart=function(t,i,a){for(var h=-1,g=!1,m=!0,p=0,E=t.length;p<E;p++){var x=t[p];if(m=m&&!x.independent,h>-1&&a<x.start)break;var I=x.loaded;I?h=-1:(g||x.independent||m)&&x.fragment===i&&(h=p),g=I}return h},o.loadedEndOfParts=function(t,i){var a=t[t.length-1];return a&&i>a.start&&a.loaded},o.getInitialLiveFragment=function(t,i){var a=this.fragPrevious,h=null;if(a){if(t.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+a.programDateTime),h=ig(i,a.endProgramDateTime,this.config.maxFragLookUpTolerance)),!h){var g=a.sn+1;if(g>=t.startSN&&g<=t.endSN){var m=i[g-t.startSN];a.cc===m.cc&&(h=m,this.log("Live playlist, switching playlist, load frag with next SN: "+h.sn))}h||(h=kl(i,a.cc),h&&this.log("Live playlist, switching playlist, load frag with same CC: "+h.sn))}}else{var p=this.hls.liveSyncPosition;p!==null&&(h=this.getFragmentAtPosition(p,this.bitrateTest?t.fragmentEnd:t.edge,t))}return h},o.getFragmentAtPosition=function(t,i,a){var h=this.config,g=this.fragPrevious,m=a.fragments,p=a.endSN,E=a.fragmentHint,x=h.maxFragLookUpTolerance,I=a.partList,R=!!(this.loadingParts&&I!=null&&I.length&&E);R&&E&&!this.bitrateTest&&I[I.length-1].fragment.sn===E.sn&&(m=m.concat(E),p=E.sn);var _;if(t<i){var P,O=t<this.lastCurrentTime,N=O||t>i-x||(P=this.media)!=null&&P.paused||!this.startFragRequested?0:x;_=Xr(g,m,t,N)}else _=m[m.length-1];if(_){var U=_.sn-a.startSN,B=this.fragmentTracker.getState(_);if((B===xt.OK||B===xt.PARTIAL&&_.gap)&&(g=_),g&&_.sn===g.sn&&(!R||I[0].fragment.sn>_.sn||!a.live&&!R)){var G=g&&_.level===g.level;if(G){var Y=m[U+1];_.sn<p&&this.fragmentTracker.getState(Y)!==xt.OK?_=Y:_=null}}}return _},o.alignPlaylists=function(t,i,a){var h=t.fragments.length;if(!h)return this.warn("No fragments in live playlist"),0;var g=t.fragmentStart,m=!i,p=t.alignedSliding&&ue(g);if(m||!p&&!g){$g(a,t);var E=t.fragmentStart;return this.log("Live playlist sliding: "+E.toFixed(2)+" start-sn: "+(i?i.startSN:"na")+"->"+t.startSN+" fragments: "+h),E}return g},o.waitForCdnTuneIn=function(t){var i=3;return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,t.partTarget*i)},o.setStartPosition=function(t,i){var a=this.startPosition;a<i&&(a=-1);var h=this.timelineOffset;if(a===-1){var g=this.startTimeOffset!==null,m=g?this.startTimeOffset:t.startTimeOffset;m!==null&&ue(m)?(a=i+m,m<0&&(a+=t.edge),a=Math.min(Math.max(i,a),i+t.totalduration),this.log("Setting startPosition to "+a+" for start time offset "+m+" found in "+(g?"multivariant":"media")+" playlist"),this.startPosition=a):t.live?(a=this.hls.liveSyncPosition||i,this.log("Setting startPosition to -1 to start at live edge "+a),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=a=0),this.lastCurrentTime=a+h}this.nextLoadPosition=a+h},o.getLoadPosition=function(){var t,i=this.media,a=0;return(t=this.hls)!=null&&t.hasEnoughToStart&&i?a=i.currentTime:this.nextLoadPosition>=0&&(a=this.nextLoadPosition),a},o.handleFragLoadAborted=function(t,i){this.transmuxer&&t.type===this.playlistType&&ct(t)&&t.stats.aborted&&(this.warn("Fragment "+t.sn+(i?" part "+i.index:"")+" of "+this.playlistLabel()+" "+t.level+" was aborted"),this.resetFragmentLoading(t))},o.resetFragmentLoading=function(t){(!this.fragCurrent||!this.fragContextChanged(t)&&this.state!==fe.FRAG_LOADING_WAITING_RETRY)&&(this.state=fe.IDLE)},o.onFragmentOrKeyLoadError=function(t,i){if(i.chunkMeta&&!i.frag){var a=this.getCurrentContext(i.chunkMeta);a&&(i.frag=a.frag)}var h=i.frag;if(!(!h||h.type!==t||!this.levels)){if(this.fragContextChanged(h)){var g;this.warn("Frag load error must match current frag to retry "+h.url+" > "+((g=this.fragCurrent)==null?void 0:g.url));return}var m=i.details===q.FRAG_GAP;m&&this.fragmentTracker.fragBuffered(h,!0);var p=i.errorAction,E=p||{},x=E.action,I=E.flags,R=E.retryCount,_=R===void 0?0:R,P=E.retryConfig,O=!!p&&!!P,N=O&&x===Ot.RetryRequest,U=O&&!p.resolved&&I===Zt.MoveAllAlternatesMatchingHost;if(!N&&U&&ct(h)&&!h.endList)this.resetFragmentErrors(t),this.treatAsGap(h),p.resolved=!0;else if((N||U)&&_<P.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);var B=Vn(P,_);this.warn("Fragment "+h.sn+" of "+t+" "+h.level+" errored with "+i.details+", retrying loading "+(_+1)+"/"+P.maxNumRetry+" in "+B+"ms"),p.resolved=!0,this.retryDate=self.performance.now()+B,this.state=fe.FRAG_LOADING_WAITING_RETRY}else if(P&&p)if(this.resetFragmentErrors(t),_<P.maxNumRetry)!m&&x!==Ot.RemoveAlternatePermanently&&(p.resolved=!0);else{this.warn(i.details+" reached or exceeded max retry ("+_+")");return}else x===Ot.SendAlternateToPenaltyBox?this.state=fe.WAITING_LEVEL:this.state=fe.ERROR;this.tickImmediate()}},o.reduceLengthAndFlushBuffer=function(t){if(this.state===fe.PARSING||this.state===fe.PARSED){var i=t.frag,a=t.parent,h=this.getFwdBufferInfo(this.mediaBuffer,a),g=h&&h.len>.5;g&&this.reduceMaxBufferLength(h.len,(i==null?void 0:i.duration)||10);var m=!g;return m&&this.warn("Buffer full error while media.currentTime is not buffered, flush "+a+" buffer"),i&&(this.fragmentTracker.removeFragment(i),this.nextLoadPosition=i.start),this.resetLoadingState(),m}return!1},o.resetFragmentErrors=function(t){t===pe.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==fe.STOPPED&&(this.state=fe.IDLE)},o.afterBufferFlushed=function(t,i,a){if(t){var h=We.getBuffered(t);this.fragmentTracker.detectEvictedFragments(i,h,a),this.state===fe.ENDED&&this.resetLoadingState()}},o.resetLoadingState=function(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==fe.STOPPED&&(this.state=fe.IDLE)},o.resetStartWhenNotLoaded=function(t){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;var i=t?t.details:null;i!=null&&i.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(i,i.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},o.resetWhenMissingContext=function(t){this.warn("The loading context changed while buffering fragment "+t.sn+" of "+this.playlistLabel()+" "+t.level+". This chunk will not be buffered."),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()},o.removeUnbufferedFrags=function(t){t===void 0&&(t=0),this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)},o.updateLevelTiming=function(t,i,a,h){var g=this,m=a.details;if(!m){this.warn("level.details undefined");return}var p=Object.keys(t.elementaryStreams).reduce(function(I,R){var _=t.elementaryStreams[R];if(_){var P=_.endPTS-_.startPTS;if(P<=0)return g.warn("Could not parse fragment "+t.sn+" "+R+" duration reliably ("+P+")"),I||!1;var O=h?0:iu(m,t,_.startPTS,_.endPTS,_.startDTS,_.endDTS);return g.hls.trigger(k.LEVEL_PTS_UPDATED,{details:m,level:a,drift:O,type:R,frag:t,start:_.startPTS,end:_.endPTS}),!0}return I},!1);if(!p){var E;if(a.fragmentError===0&&this.treatAsGap(t,a),((E=this.transmuxer)==null?void 0:E.error)===null){var x=new Error("Found no media in fragment "+t.sn+" of "+this.playlistLabel()+" "+t.level+" resetting transmuxer to fallback to playlist timing");if(this.warn(x.message),this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_PARSING_ERROR,fatal:!1,error:x,frag:t,reason:"Found no media in msn "+t.sn+" of "+this.playlistLabel()+' "'+a.url+'"'}),!this.hls)return;this.resetTransmuxer()}}this.state=fe.PARSED,this.log("Parsed "+t.type+" sn: "+t.sn+(i?" part: "+i.index:"")+" of "+this.fragInfo(t,!1,i)+")"),this.hls.trigger(k.FRAG_PARSED,{frag:t,part:i})},o.playlistLabel=function(){return this.playlistType===pe.MAIN?"level":"track"},o.fragInfo=function(t,i,a){var h,g;return i===void 0&&(i=!0),this.playlistLabel()+" "+t.level+" ("+(a?"part":"frag")+":["+((h=i&&!a?t.startPTS:(a||t).start)!=null?h:NaN).toFixed(3)+"-"+((g=i&&!a?t.endPTS:(a||t).end)!=null?g:NaN).toFixed(3)+"]"+(a&&t.type==="main"?"INDEPENDENT="+(a.independent?"YES":"NO"):"")},o.treatAsGap=function(t,i){i&&i.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)},o.resetTransmuxer=function(){var t;(t=this.transmuxer)==null||t.reset()},o.recoverWorkerError=function(t){t.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())},y(d,[{key:"startPositionValue",get:function(){var t=this.nextLoadPosition,i=this.startPosition;return i===-1&&t?t:i}},{key:"bufferingEnabled",get:function(){return this.buffering}},{key:"inFlightFrag",get:function(){return{frag:this.fragCurrent,state:this.state}}},{key:"timelineOffset",get:function(){var t=this.config.timelineOffset;if(t){var i;return((i=this.getLevelDetails())==null?void 0:i.appliedTimelineOffset)||t}return 0}},{key:"primaryPrefetch",get:function(){if(cu(this.hls.config)){var t,i,a=(t=this.hls.interstitialsManager)==null||(i=t.playingItem)==null?void 0:i.event;if(a)return!0}return!1}},{key:"state",get:function(){return this._state},set:function(t){var i=this._state;i!==t&&(this._state=t,this.log(i+"->"+t))}}])}(Ul);function cu(u){return!!u.interstitialsController&&u.enableInterstitialPlayback!==!1}var gu=function(){function u(){this.chunks=[],this.dataLength=0}var d=u.prototype;return d.push=function(s){this.chunks.push(s),this.dataLength+=s.length},d.flush=function(){var s=this.chunks,t=this.dataLength,i;if(s.length)s.length===1?i=s[0]:i=Vg(s,t);else return new Uint8Array(0);return this.reset(),i},d.reset=function(){this.chunks.length=0,this.dataLength=0},u}();function Vg(u,d){for(var o=new Uint8Array(d),s=0,t=0;t<u.length;t++){var i=u[t];o.set(i,s),s+=i.length}return o}function vu(u,d){return d+10<=u.length&&u[d]===51&&u[d+1]===68&&u[d+2]===73&&u[d+3]<255&&u[d+4]<255&&u[d+6]<128&&u[d+7]<128&&u[d+8]<128&&u[d+9]<128}function na(u,d){return d+10<=u.length&&u[d]===73&&u[d+1]===68&&u[d+2]===51&&u[d+3]<255&&u[d+4]<255&&u[d+6]<128&&u[d+7]<128&&u[d+8]<128&&u[d+9]<128}function _s(u,d){var o=0;return o=(u[d]&127)<<21,o|=(u[d+1]&127)<<14,o|=(u[d+2]&127)<<7,o|=u[d+3]&127,o}function Bi(u,d){for(var o=d,s=0;na(u,d);){s+=10;var t=_s(u,d+6);s+=t,vu(u,d+10)&&(s+=10),d+=s}if(s>0)return u.subarray(o,o+s)}function Hg(u,d,o,s){var t=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],i=d[o+2],a=i>>2&15;if(a>12){var h=new Error("invalid ADTS sampling index:"+a);u.emit(k.ERROR,k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_PARSING_ERROR,fatal:!0,error:h,reason:h.message});return}var g=(i>>6&3)+1,m=d[o+3]>>6&3|(i&1)<<2,p="mp4a.40."+g,E=t[a],x=a;(g===5||g===29)&&(x-=3);var I=[g<<3|(x&14)>>1,(x&1)<<7|m<<3];return Ye.log("manifest codec:"+s+", parsed codec:"+p+", channels:"+m+", rate:"+E+" (ADTS object type:"+g+" sampling index:"+a+")"),{config:I,samplerate:E,channelCount:m,codec:p,parsedCodec:p,manifestCodec:s}}function mu(u,d){return u[d]===255&&(u[d+1]&246)===240}function pu(u,d){return u[d+1]&1?7:9}function aa(u,d){return(u[d+3]&3)<<11|u[d+4]<<3|(u[d+5]&224)>>>5}function Yg(u,d){return d+5<u.length}function Ds(u,d){return d+1<u.length&&mu(u,d)}function Wg(u,d){return Yg(u,d)&&mu(u,d)&&aa(u,d)<=u.length-d}function qg(u,d){if(Ds(u,d)){var o=pu(u,d);if(d+o>=u.length)return!1;var s=aa(u,d);if(s<=o)return!1;var t=d+s;return t===u.length||Ds(u,t)}return!1}function yu(u,d,o,s,t){if(!u.samplerate){var i=Hg(d,o,s,t);if(!i)return;A(u,i)}}function Eu(u){return 1024*9e4/u}function jg(u,d){var o=pu(u,d);if(d+o<=u.length){var s=aa(u,d)-o;if(s>0)return{headerLength:o,frameLength:s}}}function Tu(u,d,o,s,t){var i=Eu(u.samplerate),a=s+t*i,h=jg(d,o),g;if(h){var m=h.frameLength,p=h.headerLength,E=p+m,x=Math.max(0,o+E-d.length);x?(g=new Uint8Array(E-p),g.set(d.subarray(o+p,d.length),0)):g=d.subarray(o+p,o+E);var I={unit:g,pts:a};return x||u.samples.push(I),{sample:I,length:E,missing:x}}var R=d.length-o;g=new Uint8Array(R),g.set(d.subarray(o,d.length),0);var _={unit:g,pts:a};return{sample:_,length:R,missing:-1}}function Xg(u,d){return na(u,d)&&_s(u,d+6)+10<=u.length-d}function zg(u){if(!(u.size<2)){var d=mt(u.data,!0),o=new Uint8Array(u.data.subarray(d.length+1));return{key:u.type,info:d,data:o.buffer}}}function Qg(u){if(!(u.size<2)){if(u.type==="TXXX"){var d=1,o=mt(u.data.subarray(d),!0);d+=o.length+1;var s=mt(u.data.subarray(d));return{key:u.type,info:o,data:s}}var t=mt(u.data.subarray(1));return{key:u.type,info:"",data:t}}}function Zg(u){if(u.type==="WXXX"){if(u.size<2)return;var d=1,o=mt(u.data.subarray(d),!0);d+=o.length+1;var s=mt(u.data.subarray(d));return{key:u.type,info:o,data:s}}var t=mt(u.data);return{key:u.type,info:"",data:t}}function Jg(u){return btoa(String.fromCharCode.apply(String,u))}function Su(u,d){if(u<0)return-Su(-u,d);var o=Math.pow(10,d),s=Math.abs(u*o%1-.5)<Number.EPSILON;if(s){var t=Math.floor(u*o);return(t%2===0?t:t+1)/o}else return Math.round(u*o)/o}function e0(u,d){var o=new URL(u),s=new URL(d);if(o.origin!==s.origin)return u;for(var t=o.pathname.split("/").slice(1),i=s.pathname.split("/").slice(1,-1);t[0]===i[0];)t.shift(),i.shift();for(;i.length;)i.shift(),t.unshift("..");return t.join("/")}function t0(u){return u instanceof ArrayBuffer?u:u.byteOffset==0&&u.byteLength==u.buffer.byteLength?u.buffer:new Uint8Array(u).buffer}function oa(u,d,o){return d===void 0&&(d=0),o===void 0&&(o=1/0),r0(u,d,o,Uint8Array)}function r0(u,d,o,s){var t=i0(u),i=1;"BYTES_PER_ELEMENT"in s&&(i=s.BYTES_PER_ELEMENT);var a=s0(u)?u.byteOffset:0,h=(a+u.byteLength)/i,g=(a+d)/i,m=Math.floor(Math.max(0,Math.min(g,h))),p=Math.floor(Math.min(m+Math.max(o,0),h));return new s(t,m,p-m)}function i0(u){return u instanceof ArrayBuffer?u:u.buffer}function s0(u){return u&&u.buffer instanceof ArrayBuffer&&u.byteLength!==void 0&&u.byteOffset!==void 0}function n0(u){var d={key:u.type,description:"",data:"",mimeType:null,pictureType:null},o=3;if(!(u.size<2)){if(u.data[0]!==o){console.log("Ignore frame with unrecognized character encoding");return}var s=u.data.subarray(1).indexOf(0);if(s!==-1){var t=mt(oa(u.data,1,s)),i=u.data[2+s],a=u.data.subarray(3+s).indexOf(0);if(a!==-1){var h=mt(oa(u.data,3+s,a)),g;return t==="-->"?g=mt(oa(u.data,4+s+a)):g=t0(u.data.subarray(4+s+a)),d.mimeType=t,d.pictureType=i,d.description=h,d.data=g,d}}}}function a0(u){return u.type==="PRIV"?zg(u):u.type[0]==="W"?Zg(u):u.type==="APIC"?n0(u):Qg(u)}function o0(u){var d=String.fromCharCode(u[0],u[1],u[2],u[3]),o=_s(u,4),s=10;return{type:d,size:o,data:u.subarray(s,s+o)}}var Cs=10,l0=10;function Au(u){for(var d=0,o=[];na(u,d);){var s=_s(u,d+6);u[d+5]>>6&1&&(d+=Cs),d+=Cs;for(var t=d+s;d+l0<t;){var i=o0(u.subarray(d)),a=a0(i);a&&o.push(a),d+=i.size+Cs}vu(u,d)&&(d+=Cs)}return o}function xu(u){return u&&u.key==="PRIV"&&u.info==="com.apple.streaming.transportStreamTimestamp"}function u0(u){if(u.data.byteLength===8){var d=new Uint8Array(u.data),o=d[3]&1,s=(d[4]<<23)+(d[5]<<15)+(d[6]<<7)+d[7];return s/=45,o&&(s+=4772185884e-2),Math.round(s)}}function la(u){for(var d=Au(u),o=0;o<d.length;o++){var s=d[o];if(xu(s))return u0(s)}}var Kt=function(u){return u.audioId3="org.id3",u.dateRange="com.apple.quicktime.HLS",u.emsg="https://aomedia.org/emsg/ID3",u.misbklv="urn:misb:KLV:bin:1910.1",u}({});function lr(u,d){return u===void 0&&(u=""),d===void 0&&(d=9e4),{type:u,id:-1,pid:-1,inputTimeScale:d,sequenceNumber:-1,samples:[],dropped:0}}var ua=function(){function u(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var d=u.prototype;return d.resetInitSegment=function(s,t,i,a){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},d.resetTimeStamp=function(s){this.initPTS=s,this.resetContiguity()},d.resetContiguity=function(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},d.canParse=function(s,t){return!1},d.appendFrame=function(s,t,i){},d.demux=function(s,t){this.cachedData&&(s=Yt(this.cachedData,s),this.cachedData=null);var i=Bi(s,0),a=i?i.length:0,h,g=this._audioTrack,m=this._id3Track,p=i?la(i):void 0,E=s.length;for((this.basePTS===null||this.frameIndex===0&&ue(p))&&(this.basePTS=h0(p,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&m.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Kt.audioId3,duration:Number.POSITIVE_INFINITY});a<E;){if(this.canParse(s,a)){var x=this.appendFrame(g,s,a);x?(this.frameIndex++,this.lastPTS=x.sample.pts,a+=x.length,h=a):a=E}else Xg(s,a)?(i=Bi(s,a),m.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Kt.audioId3,duration:Number.POSITIVE_INFINITY}),a+=i.length,h=a):a++;if(a===E&&h!==E){var I=s.slice(h);this.cachedData?this.cachedData=Yt(this.cachedData,I):this.cachedData=I}}return{audioTrack:g,videoTrack:lr(),id3Track:m,textTrack:lr()}},d.demuxSampleAes=function(s,t,i){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},d.flush=function(s){var t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:lr(),id3Track:this._id3Track,textTrack:lr()}},d.destroy=function(){this.cachedData=null,this._audioTrack=this._id3Track=void 0},u}(),h0=function(d,o,s){if(ue(d))return d*90;var t=s?s.baseTime*9e4/s.timescale:0;return o*9e4+t},Ps=null,f0=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],d0=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],c0=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],g0=[0,1,1,4];function Lu(u,d,o,s,t){if(!(o+24>d.length)){var i=Iu(d,o);if(i&&o+i.frameLength<=d.length){var a=i.samplesPerFrame*9e4/i.sampleRate,h=s+t*a,g={unit:d.subarray(o,o+i.frameLength),pts:h,dts:h};return u.config=[],u.channelCount=i.channelCount,u.samplerate=i.sampleRate,u.samples.push(g),{sample:g,length:i.frameLength,missing:0}}}}function Iu(u,d){var o=u[d+1]>>3&3,s=u[d+1]>>1&3,t=u[d+2]>>4&15,i=u[d+2]>>2&3;if(o!==1&&t!==0&&t!==15&&i!==3){var a=u[d+2]>>1&1,h=u[d+3]>>6,g=o===3?3-s:s===3?3:4,m=f0[g*14+t-1]*1e3,p=o===3?0:o===2?1:2,E=d0[p*3+i],x=h===3?1:2,I=c0[o][s],R=g0[s],_=I*8*R,P=Math.floor(I*m/E+a)*R;if(Ps===null){var O=navigator.userAgent||"",N=O.match(/Chrome\/(\d+)/i);Ps=N?parseInt(N[1]):0}var U=!!Ps&&Ps<=87;return U&&s===2&&m>=224e3&&h===0&&(u[d+3]=u[d+3]|128),{sampleRate:E,channelCount:x,frameLength:P,samplesPerFrame:_}}}function ha(u,d){return u[d]===255&&(u[d+1]&224)===224&&(u[d+1]&6)!==0}function Ru(u,d){return d+1<u.length&&ha(u,d)}function v0(u,d){var o=4;return ha(u,d)&&o<=u.length-d}function bu(u,d){if(d+1<u.length&&ha(u,d)){var o=4,s=Iu(u,d),t=o;s!=null&&s.frameLength&&(t=s.frameLength);var i=d+t;return i===u.length||Ru(u,i)}return!1}var m0=function(u){function d(s,t){var i;return i=u.call(this)||this,i.observer=void 0,i.config=void 0,i.observer=s,i.config=t,i}b(d,u);var o=d.prototype;return o.resetInitSegment=function(t,i,a,h){u.prototype.resetInitSegment.call(this,t,i,a,h),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:i,duration:h,inputTimeScale:9e4,dropped:0}},d.probe=function(t,i){if(!t)return!1;var a=Bi(t,0),h=(a==null?void 0:a.length)||0;if(bu(t,h))return!1;for(var g=t.length;h<g;h++)if(qg(t,h))return i.log("ADTS sync word found !"),!0;return!1},o.canParse=function(t,i){return Wg(t,i)},o.appendFrame=function(t,i,a){yu(t,this.observer,i,a,t.manifestCodec);var h=Tu(t,i,a,this.basePTS,this.frameIndex);if(h&&h.missing===0)return h},d}(ua),_u=function(d,o){var s=0,t=5;o+=t;for(var i=new Uint32Array(1),a=new Uint32Array(1),h=new Uint8Array(1);t>0;){h[0]=d[o];var g=Math.min(t,8),m=8-g;a[0]=4278190080>>>24+m<<m,i[0]=(h[0]&a[0])>>m,s=s?s<<g|i[0]:i[0],o+=1,t-=g}return s},p0=function(u){function d(s){var t;return t=u.call(this)||this,t.observer=void 0,t.observer=s,t}b(d,u);var o=d.prototype;return o.resetInitSegment=function(t,i,a,h){u.prototype.resetInitSegment.call(this,t,i,a,h),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:i,duration:h,inputTimeScale:9e4,dropped:0}},o.canParse=function(t,i){return i+64<t.length},o.appendFrame=function(t,i,a){var h=Du(t,i,a,this.basePTS,this.frameIndex);if(h!==-1){var g=t.samples[t.samples.length-1];return{sample:g,length:h,missing:0}}},d.probe=function(t){if(!t)return!1;var i=Bi(t,0);if(!i)return!1;var a=i.length;return t[a]===11&&t[a+1]===119&&la(i)!==void 0&&_u(t,a)<16},d}(ua);function Du(u,d,o,s,t){if(o+8>d.length||d[o]!==11||d[o+1]!==119)return-1;var i=d[o+4]>>6;if(i>=3)return-1;var a=[48e3,44100,32e3],h=a[i],g=d[o+4]&63,m=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920],p=m[g*3+i]*2;if(o+p>d.length)return-1;var E=d[o+6]>>5,x=0;E===2?x+=2:(E&1&&E!==1&&(x+=2),E&4&&(x+=2));var I=(d[o+6]<<8|d[o+7])>>12-x&1,R=[2,1,2,3,3,4,4,5],_=R[E]+I,P=d[o+5]>>3,O=d[o+5]&7,N=new Uint8Array([i<<6|P<<1|O>>2,(O&3)<<6|E<<3|I<<2|g>>4,g<<4&224]),U=1536/h*9e4,B=s+t*U,G=d.subarray(o,o+p);return u.config=N,u.channelCount=_,u.samplerate=h,u.samples.push({unit:G,pts:B}),p}var y0=function(u){function d(){return u.apply(this,arguments)||this}b(d,u);var o=d.prototype;return o.resetInitSegment=function(t,i,a,h){u.prototype.resetInitSegment.call(this,t,i,a,h),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:i,duration:h,inputTimeScale:9e4,dropped:0}},d.probe=function(t){if(!t)return!1;var i=Bi(t,0),a=(i==null?void 0:i.length)||0;if(i&&t[a]===11&&t[a+1]===119&&la(i)!==void 0&&_u(t,a)<=16)return!1;for(var h=t.length;a<h;a++)if(bu(t,a))return Ye.log("MPEG Audio sync word found !"),!0;return!1},o.canParse=function(t,i){return v0(t,i)},o.appendFrame=function(t,i,a){if(this.basePTS!==null)return Lu(t,i,a,this.basePTS,this.frameIndex)},d}(ua),E0=/\/emsg[-/]ID3/i,T0=function(){function u(o,s){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=s}var d=u.prototype;return d.resetTimeStamp=function(){},d.resetInitSegment=function(s,t,i,a){var h=this.videoTrack=lr("video",1),g=this.audioTrack=lr("audio",1),m=this.txtTrack=lr("text",1);if(this.id3Track=lr("id3",1),this.timeOffset=0,!!(s!=null&&s.byteLength)){var p=fl(s);if(p.video){var E=p.video,x=E.id,I=E.timescale,R=E.codec,_=E.supplemental;h.id=x,h.timescale=m.timescale=I,h.codec=R,h.supplemental=_}if(p.audio){var P=p.audio,O=P.id,N=P.timescale,U=P.codec;g.id=O,g.timescale=N,g.codec=U}m.id=Pr.text,h.sampleDuration=0,h.duration=g.duration=a}},d.resetContiguity=function(){this.remainderData=null},u.probe=function(s){return Lc(s)},d.demux=function(s,t){this.timeOffset=t;var i=s,a=this.videoTrack,h=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Yt(this.remainderData,s));var g=kc(i);this.remainderData=g.remainder,a.samples=g.valid||new Uint8Array}else a.samples=i;var m=this.extractID3Track(a,t);return h.samples=cl(t,a),{videoTrack:a,audioTrack:this.audioTrack,id3Track:m,textTrack:this.txtTrack}},d.flush=function(){var s=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;var a=this.extractID3Track(t,this.timeOffset);return i.samples=cl(s,t),{videoTrack:t,audioTrack:lr(),id3Track:a,textTrack:lr()}},d.extractID3Track=function(s,t){var i=this,a=this.id3Track;if(s.samples.length){var h=we(s.samples,["emsg"]);h&&h.forEach(function(g){var m=Oc(g);if(E0.test(m.schemeIdUri)){var p=Cu(m,t),E=m.eventDuration===4294967295?Number.POSITIVE_INFINITY:m.eventDuration/m.timeScale;E<=.001&&(E=Number.POSITIVE_INFINITY);var x=m.payload;a.samples.push({data:x,len:x.byteLength,dts:p,pts:p,type:Kt.emsg,duration:E})}else if(i.config.enableEmsgKLVMetadata&&m.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){var I=Cu(m,t);a.samples.push({data:m.payload,len:m.payload.byteLength,dts:I,pts:I,type:Kt.misbklv,duration:Number.POSITIVE_INFINITY})}})}return a},d.demuxSampleAes=function(s,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},d.destroy=function(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0},u}();function Cu(u,d){return ue(u.presentationTime)?u.presentationTime/u.timeScale:d+u.presentationTimeDelta/u.timeScale}var S0=function(){function u(o,s,t){this.keyData=void 0,this.decrypter=void 0,this.keyData=t,this.decrypter=new Hn(s,{removePKCS7Padding:!1})}var d=u.prototype;return d.decryptBuffer=function(s){return this.decrypter.decrypt(s,this.keyData.key.buffer,this.keyData.iv.buffer,kr.cbc)},d.decryptAacSample=function(s,t,i){var a=this,h=s[t].unit;if(!(h.length<=16)){var g=h.subarray(16,h.length-h.length%16),m=g.buffer.slice(g.byteOffset,g.byteOffset+g.length);this.decryptBuffer(m).then(function(p){var E=new Uint8Array(p);h.set(E,16),a.decrypter.isSync()||a.decryptAacSamples(s,t+1,i)})}},d.decryptAacSamples=function(s,t,i){for(;;t++){if(t>=s.length){i();return}if(!(s[t].unit.length<32)&&(this.decryptAacSample(s,t,i),!this.decrypter.isSync()))return}},d.getAvcEncryptedData=function(s){for(var t=Math.floor((s.length-48)/160)*16+16,i=new Int8Array(t),a=0,h=32;h<s.length-16;h+=160,a+=16)i.set(s.subarray(h,h+16),a);return i},d.getAvcDecryptedUnit=function(s,t){for(var i=new Uint8Array(t),a=0,h=32;h<s.length-16;h+=160,a+=16)s.set(i.subarray(a,a+16),h);return s},d.decryptAvcSample=function(s,t,i,a,h){var g=this,m=gl(h.data),p=this.getAvcEncryptedData(m);this.decryptBuffer(p.buffer).then(function(E){h.data=g.getAvcDecryptedUnit(m,E),g.decrypter.isSync()||g.decryptAvcSamples(s,t,i+1,a)})},d.decryptAvcSamples=function(s,t,i,a){if(s instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=s.length){a();return}for(var h=s[t].units;!(i>=h.length);i++){var g=h[i];if(!(g.data.length<=48||g.type!==1&&g.type!==5)&&(this.decryptAvcSample(s,t,i,a,g),!this.decrypter.isSync()))return}}},u}(),Pu=function(){function u(){this.VideoSample=null}var d=u.prototype;return d.createVideoSample=function(s,t,i){return{key:s,frame:!1,pts:t,dts:i,units:[],length:0}},d.getLastNalUnit=function(s){var t,i=this.VideoSample,a;if((!i||i.units.length===0)&&(i=s[s.length-1]),(t=i)!=null&&t.units){var h=i.units;a=h[h.length-1]}return a},d.pushAccessUnit=function(s,t){if(s.units.length&&s.frame){if(s.pts===void 0){var i=t.samples,a=i.length;if(a){var h=i[a-1];s.pts=h.pts,s.dts=h.dts}else{t.dropped++;return}}t.samples.push(s)}},d.parseNALu=function(s,t,i){var a=t.byteLength,h=s.naluState||0,g=h,m=[],p=0,E,x,I,R=-1,_=0;for(h===-1&&(R=0,_=this.getNALuType(t,0),h=0,p=1);p<a;){if(E=t[p++],!h){h=E?0:1;continue}if(h===1){h=E?0:2;continue}if(!E)h=3;else if(E===1){if(x=p-h-1,R>=0){var P={data:t.subarray(R,x),type:_};m.push(P)}else{var O=this.getLastNalUnit(s.samples);O&&(g&&p<=4-g&&O.state&&(O.data=O.data.subarray(0,O.data.byteLength-g)),x>0&&(O.data=Yt(O.data,t.subarray(0,x)),O.state=0))}p<a?(I=this.getNALuType(t,p),R=p,_=I,h=0):h=-1}else h=0}if(R>=0&&h>=0){var N={data:t.subarray(R,a),type:_,state:h};m.push(N)}if(m.length===0){var U=this.getLastNalUnit(s.samples);U&&(U.data=Yt(U.data,t))}return s.naluState=h,m},u}(),Gi=function(){function u(o){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=o,this.bytesAvailable=o.byteLength,this.word=0,this.bitsAvailable=0}var d=u.prototype;return d.loadWord=function(){var s=this.data,t=this.bytesAvailable,i=s.byteLength-t,a=new Uint8Array(4),h=Math.min(4,t);if(h===0)throw new Error("no bytes available");a.set(s.subarray(i,i+h)),this.word=new DataView(a.buffer).getUint32(0),this.bitsAvailable=h*8,this.bytesAvailable-=h},d.skipBits=function(s){var t;s=Math.min(s,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>s?(this.word<<=s,this.bitsAvailable-=s):(s-=this.bitsAvailable,t=s>>3,s-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=s,this.bitsAvailable-=s)},d.readBits=function(s){var t=Math.min(this.bitsAvailable,s),i=this.word>>>32-t;if(s>32&&Ye.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=s-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i},d.skipLZ=function(){var s;for(s=0;s<this.bitsAvailable;++s)if((this.word&2147483648>>>s)!==0)return this.word<<=s,this.bitsAvailable-=s,s;return this.loadWord(),s+this.skipLZ()},d.skipUEG=function(){this.skipBits(1+this.skipLZ())},d.skipEG=function(){this.skipBits(1+this.skipLZ())},d.readUEG=function(){var s=this.skipLZ();return this.readBits(s+1)-1},d.readEG=function(){var s=this.readUEG();return 1&s?1+s>>>1:-1*(s>>>1)},d.readBoolean=function(){return this.readBits(1)===1},d.readUByte=function(){return this.readBits(8)},d.readUShort=function(){return this.readBits(16)},d.readUInt=function(){return this.readBits(32)},u}(),ku=function(u){function d(){return u.apply(this,arguments)||this}b(d,u);var o=d.prototype;return o.parsePES=function(t,i,a,h){var g=this,m=this.parseNALu(t,a.data,h),p=this.VideoSample,E,x=!1;a.data=null,p&&m.length&&!t.audFound&&(this.pushAccessUnit(p,t),p=this.VideoSample=this.createVideoSample(!1,a.pts,a.dts)),m.forEach(function(I){var R,_;switch(I.type){case 1:{var P=!1;E=!0;var O=I.data;if(x&&O.length>4){var N=g.readSliceType(O);(N===2||N===4||N===7||N===9)&&(P=!0)}if(P){var U;(U=p)!=null&&U.frame&&!p.key&&(g.pushAccessUnit(p,t),p=g.VideoSample=null)}p||(p=g.VideoSample=g.createVideoSample(!0,a.pts,a.dts)),p.frame=!0,p.key=P;break}case 5:E=!0,(R=p)!=null&&R.frame&&!p.key&&(g.pushAccessUnit(p,t),p=g.VideoSample=null),p||(p=g.VideoSample=g.createVideoSample(!0,a.pts,a.dts)),p.key=!0,p.frame=!0;break;case 6:{E=!0,Un(I.data,1,a.pts,i.samples);break}case 7:{var B,G;E=!0,x=!0;var Y=I.data,V=g.readSPS(Y);if(!t.sps||t.width!==V.width||t.height!==V.height||((B=t.pixelRatio)==null?void 0:B[0])!==V.pixelRatio[0]||((G=t.pixelRatio)==null?void 0:G[1])!==V.pixelRatio[1]){t.width=V.width,t.height=V.height,t.pixelRatio=V.pixelRatio,t.sps=[Y];for(var j=Y.subarray(1,4),ae="avc1.",X=0;X<3;X++){var W=j[X].toString(16);W.length<2&&(W="0"+W),ae+=W}t.codec=ae}break}case 8:E=!0,t.pps=[I.data];break;case 9:E=!0,t.audFound=!0,(_=p)!=null&&_.frame&&(g.pushAccessUnit(p,t),p=null),p||(p=g.VideoSample=g.createVideoSample(!1,a.pts,a.dts));break;case 12:E=!0;break;default:E=!1;break}if(p&&E){var J=p.units;J.push(I)}}),h&&p&&(this.pushAccessUnit(p,t),this.VideoSample=null)},o.getNALuType=function(t,i){return t[i]&31},o.readSliceType=function(t){var i=new Gi(t);return i.readUByte(),i.readUEG(),i.readUEG()},o.skipScalingList=function(t,i){for(var a=8,h=8,g,m=0;m<t;m++)h!==0&&(g=i.readEG(),h=(a+g+256)%256),a=h===0?a:h},o.readSPS=function(t){var i=new Gi(t),a=0,h=0,g=0,m=0,p,E,x,I=i.readUByte.bind(i),R=i.readBits.bind(i),_=i.readUEG.bind(i),P=i.readBoolean.bind(i),O=i.skipBits.bind(i),N=i.skipEG.bind(i),U=i.skipUEG.bind(i),B=this.skipScalingList.bind(this);I();var G=I();if(R(5),O(3),I(),U(),G===100||G===110||G===122||G===244||G===44||G===83||G===86||G===118||G===128){var Y=_();if(Y===3&&O(1),U(),U(),O(1),P())for(E=Y!==3?8:12,x=0;x<E;x++)P()&&(x<6?B(16,i):B(64,i))}U();var V=_();if(V===0)_();else if(V===1)for(O(1),N(),N(),p=_(),x=0;x<p;x++)N();U(),O(1);var j=_(),ae=_(),X=R(1);X===0&&O(1),O(1),P()&&(a=_(),h=_(),g=_(),m=_());var W=[1,1];if(P()&&P()){var J=I();switch(J){case 1:W=[1,1];break;case 2:W=[12,11];break;case 3:W=[10,11];break;case 4:W=[16,11];break;case 5:W=[40,33];break;case 6:W=[24,11];break;case 7:W=[20,11];break;case 8:W=[32,11];break;case 9:W=[80,33];break;case 10:W=[18,11];break;case 11:W=[15,11];break;case 12:W=[64,33];break;case 13:W=[160,99];break;case 14:W=[4,3];break;case 15:W=[3,2];break;case 16:W=[2,1];break;case 255:{W=[I()<<8|I(),I()<<8|I()];break}}}return{width:Math.ceil((j+1)*16-a*2-h*2),height:(2-X)*(ae+1)*16-(X?2:4)*(g+m),pixelRatio:W}},d}(Pu),wu=function(u){function d(){for(var s,t=arguments.length,i=new Array(t),a=0;a<t;a++)i[a]=arguments[a];return s=u.call.apply(u,[this].concat(i))||this,s.initVPS=null,s}b(d,u);var o=d.prototype;return o.parsePES=function(t,i,a,h){var g=this,m=this.parseNALu(t,a.data,h),p=this.VideoSample,E,x=!1;a.data=null,p&&m.length&&!t.audFound&&(this.pushAccessUnit(p,t),p=this.VideoSample=this.createVideoSample(!1,a.pts,a.dts)),m.forEach(function(I){var R,_;switch(I.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:p||(p=g.VideoSample=g.createVideoSample(!1,a.pts,a.dts)),p.frame=!0,E=!0;break;case 16:case 17:case 18:case 21:if(E=!0,x){var P;(P=p)!=null&&P.frame&&!p.key&&(g.pushAccessUnit(p,t),p=g.VideoSample=null)}p||(p=g.VideoSample=g.createVideoSample(!0,a.pts,a.dts)),p.key=!0,p.frame=!0;break;case 19:case 20:E=!0,(R=p)!=null&&R.frame&&!p.key&&(g.pushAccessUnit(p,t),p=g.VideoSample=null),p||(p=g.VideoSample=g.createVideoSample(!0,a.pts,a.dts)),p.key=!0,p.frame=!0;break;case 39:E=!0,Un(I.data,2,a.pts,i.samples);break;case 32:E=!0,t.vps||(typeof t.params!="object"&&(t.params={}),t.params=A(t.params,g.readVPS(I.data)),g.initVPS=I.data),t.vps=[I.data];break;case 33:if(E=!0,x=!0,t.vps!==void 0&&t.vps[0]!==g.initVPS&&t.sps!==void 0&&!g.matchSPS(t.sps[0],I.data)&&(g.initVPS=t.vps[0],t.sps=t.pps=void 0),!t.sps){var O=g.readSPS(I.data);t.width=O.width,t.height=O.height,t.pixelRatio=O.pixelRatio,t.codec=O.codecString,t.sps=[],typeof t.params!="object"&&(t.params={});for(var N in O.params)t.params[N]=O.params[N]}g.pushParameterSet(t.sps,I.data,t.vps),p||(p=g.VideoSample=g.createVideoSample(!0,a.pts,a.dts)),p.key=!0;break;case 34:if(E=!0,typeof t.params=="object"){if(!t.pps){t.pps=[];var U=g.readPPS(I.data);for(var B in U)t.params[B]=U[B]}g.pushParameterSet(t.pps,I.data,t.vps)}break;case 35:E=!0,t.audFound=!0,(_=p)!=null&&_.frame&&(g.pushAccessUnit(p,t),p=null),p||(p=g.VideoSample=g.createVideoSample(!1,a.pts,a.dts));break;default:E=!1;break}if(p&&E){var G=p.units;G.push(I)}}),h&&p&&(this.pushAccessUnit(p,t),this.VideoSample=null)},o.pushParameterSet=function(t,i,a){(a&&a[0]===this.initVPS||!a&&!t.length)&&t.push(i)},o.getNALuType=function(t,i){return(t[i]&126)>>>1},o.ebsp2rbsp=function(t){for(var i=new Uint8Array(t.byteLength),a=0,h=0;h<t.byteLength;h++)h>=2&&t[h]===3&&t[h-1]===0&&t[h-2]===0||(i[a]=t[h],a++);return new Uint8Array(i.buffer,0,a)},o.pushAccessUnit=function(t,i){u.prototype.pushAccessUnit.call(this,t,i),this.initVPS&&(this.initVPS=null)},o.readVPS=function(t){var i=new Gi(t);i.readUByte(),i.readUByte(),i.readBits(4),i.skipBits(2),i.readBits(6);var a=i.readBits(3),h=i.readBoolean();return{numTemporalLayers:a+1,temporalIdNested:h}},o.readSPS=function(t){var i=new Gi(this.ebsp2rbsp(t));i.readUByte(),i.readUByte(),i.readBits(4);var a=i.readBits(3);i.readBoolean();for(var h=i.readBits(2),g=i.readBoolean(),m=i.readBits(5),p=i.readUByte(),E=i.readUByte(),x=i.readUByte(),I=i.readUByte(),R=i.readUByte(),_=i.readUByte(),P=i.readUByte(),O=i.readUByte(),N=i.readUByte(),U=i.readUByte(),B=i.readUByte(),G=[],Y=[],V=0;V<a;V++)G.push(i.readBoolean()),Y.push(i.readBoolean());if(a>0)for(var j=a;j<8;j++)i.readBits(2);for(var ae=0;ae<a;ae++)G[ae]&&(i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte(),i.readUByte()),Y[ae]&&i.readUByte();i.readUEG();var X=i.readUEG();X==3&&i.skipBits(1);var W=i.readUEG(),J=i.readUEG(),oe=i.readBoolean(),ge=0,ce=0,he=0,ye=0;oe&&(ge+=i.readUEG(),ce+=i.readUEG(),he+=i.readUEG(),ye+=i.readUEG());for(var Se=i.readUEG(),Le=i.readUEG(),Ie=i.readUEG(),He=i.readBoolean(),Oe=He?0:a;Oe<=a;Oe++)i.skipUEG(),i.skipUEG(),i.skipUEG();i.skipUEG(),i.skipUEG(),i.skipUEG(),i.skipUEG(),i.skipUEG(),i.skipUEG();var je=i.readBoolean();if(je){var Fe=i.readBoolean();if(Fe)for(var Xe=0;Xe<4;Xe++)for(var ze=0;ze<(Xe===3?2:6);ze++){var it=i.readBoolean();if(!it)i.readUEG();else{var yt=Math.min(64,1<<4+(Xe<<1));Xe>1&&i.readEG();for(var gt=0;gt<yt;gt++)i.readEG()}}}i.readBoolean(),i.readBoolean();var nt=i.readBoolean();nt&&(i.readUByte(),i.skipUEG(),i.skipUEG(),i.readBoolean());for(var Et=i.readUEG(),ut=0,Ge=0;Ge<Et;Ge++){var Mt=!1;if(Ge!==0&&(Mt=i.readBoolean()),Mt){Ge===Et&&i.readUEG(),i.readBoolean(),i.readUEG();for(var Dt=0,Lt=0;Lt<=ut;Lt++){var vt=i.readBoolean(),St=!1;vt||(St=i.readBoolean()),(vt||St)&&Dt++}ut=Dt}else{var ht=i.readUEG(),Tt=i.readUEG();ut=ht+Tt;for(var fr=0;fr<ht;fr++)i.readUEG(),i.readBoolean();for(var Mr=0;Mr<Tt;Mr++)i.readUEG(),i.readBoolean()}}var jt=i.readBoolean();if(jt)for(var mi=i.readUEG(),er=0;er<mi;er++){for(var Vs=0;Vs<Ie+4;Vs++)i.readBits(1);i.readBits(1)}var pi=0,Fr=1,yi=1,Nr=!0,Hs=1,Ei=0;i.readBoolean(),i.readBoolean();var Wi=!1,Ys=i.readBoolean();if(Ys){var qi=i.readBoolean();if(qi){var kt=i.readUByte(),Ws=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],qs=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];kt>0&&kt<16?(Fr=Ws[kt-1],yi=qs[kt-1]):kt===255&&(Fr=i.readBits(16),yi=i.readBits(16))}var Ka=i.readBoolean();Ka&&i.readBoolean();var Va=i.readBoolean();if(Va){i.readBits(3),i.readBoolean();var Ha=i.readBoolean();Ha&&(i.readUByte(),i.readUByte(),i.readUByte())}var Ya=i.readBoolean();Ya&&(i.readUEG(),i.readUEG()),i.readBoolean(),i.readBoolean(),i.readBoolean(),Wi=i.readBoolean(),Wi&&(ge+=i.readUEG(),ce+=i.readUEG(),he+=i.readUEG(),ye+=i.readUEG());var Wa=i.readBoolean();if(Wa){Hs=i.readBits(32),Ei=i.readBits(32);var Ti=i.readBoolean();Ti&&i.readUEG();var js=i.readBoolean();if(js){var Xs=i.readBoolean(),zs=i.readBoolean(),ji=!1;(Xs||zs)&&(ji=i.readBoolean(),ji&&(i.readUByte(),i.readBits(5),i.readBoolean(),i.readBits(5)),i.readBits(4),i.readBits(4),ji&&i.readBits(4),i.readBits(5),i.readBits(5),i.readBits(5));for(var Fh=0;Fh<=a;Fh++){Nr=i.readBoolean();var tp=Nr||i.readBoolean(),Nh=!1;tp?i.readEG():Nh=i.readBoolean();var Uh=Nh?1:i.readUEG()+1;if(Xs)for(var Bh=0;Bh<Uh;Bh++)i.readUEG(),i.readUEG(),ji&&(i.readUEG(),i.readUEG()),i.skipBits(1);if(zs)for(var Gh=0;Gh<Uh;Gh++)i.readUEG(),i.readUEG(),ji&&(i.readUEG(),i.readUEG()),i.skipBits(1)}}}var rp=i.readBoolean();rp&&(i.readBoolean(),i.readBoolean(),i.readBoolean(),pi=i.readUEG())}var $h=W,Kh=J;if(oe||Wi){var Qs=1,qa=1;X===1?Qs=qa=2:X==2&&(Qs=2),$h=W-Qs*ce-Qs*ge,Kh=J-qa*ye-qa*he}for(var ip=h?["A","B","C"][h]:"",sp=p<<24|E<<16|x<<8|I,ja=0,Zs=0;Zs<32;Zs++)ja=(ja|(sp>>Zs&1)<<31-Zs)>>>0;var Xa=ja.toString(16);m===1&&Xa==="2"&&(Xa="6");var np=g?"H":"L";return{codecString:"hvc1."+ip+m+"."+Xa+"."+np+B+".B0",params:{general_tier_flag:g,general_profile_idc:m,general_profile_space:h,general_profile_compatibility_flags:[p,E,x,I],general_constraint_indicator_flags:[R,_,P,O,N,U],general_level_idc:B,bit_depth:Se+8,bit_depth_luma_minus8:Se,bit_depth_chroma_minus8:Le,min_spatial_segmentation_idc:pi,chroma_format_idc:X,frame_rate:{fixed:Nr,fps:Ei/Hs}},width:$h,height:Kh,pixelRatio:[Fr,yi]}},o.readPPS=function(t){var i=new Gi(this.ebsp2rbsp(t));i.readUByte(),i.readUByte(),i.skipUEG(),i.skipUEG(),i.skipBits(2),i.skipBits(3),i.skipBits(2),i.skipUEG(),i.skipUEG(),i.skipEG(),i.skipBits(2);var a=i.readBoolean();a&&i.skipUEG(),i.skipEG(),i.skipEG(),i.skipBits(4);var h=i.readBoolean(),g=i.readBoolean(),m=1;return g&&h?m=0:g?m=3:h&&(m=2),{parallelismType:m}},o.matchSPS=function(t,i){return String.fromCharCode.apply(null,t).substr(3)===String.fromCharCode.apply(null,i).substr(3)},d}(Pu),_t=188,A0=function(){function u(o,s,t,i){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=o,this.config=s,this.typeSupported=t,this.logger=i,this.videoParser=null}u.probe=function(s,t){var i=u.syncOffset(s);return i>0&&t.warn("MPEG2-TS detected but first sync word found @ offset "+i),i!==-1},u.syncOffset=function(s){for(var t=s.length,i=Math.min(_t*5,t-_t)+1,a=0;a<i;){for(var h=!1,g=-1,m=0,p=a;p<t;p+=_t)if(s[p]===71&&(t-p===_t||s[p+_t]===71)){if(m++,g===-1&&(g=p,g!==0&&(i=Math.min(g+_t*99,s.length-_t)+1)),h||(h=fa(s,p)===0),h&&m>1&&(g===0&&m>2||p+_t>i))return g}else{if(m)return-1;break}a++}return-1},u.createTrack=function(s,t){return{container:s==="video"||s==="audio"?"video/mp2t":void 0,type:s,id:Pr[s],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:s==="audio"?t:void 0}};var d=u.prototype;return d.resetInitSegment=function(s,t,i,a){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=u.createTrack("video"),this._videoTrack.duration=a,this._audioTrack=u.createTrack("audio",a),this._id3Track=u.createTrack("id3"),this._txtTrack=u.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i},d.resetTimeStamp=function(){},d.resetContiguity=function(){var s=this._audioTrack,t=this._videoTrack,i=this._id3Track;s&&(s.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null},d.demux=function(s,t,i,a){i===void 0&&(i=!1),a===void 0&&(a=!1),i||(this.sampleAes=null);var h,g=this._videoTrack,m=this._audioTrack,p=this._id3Track,E=this._txtTrack,x=g.pid,I=g.pesData,R=m.pid,_=p.pid,P=m.pesData,O=p.pesData,N=null,U=this.pmtParsed,B=this._pmtId,G=s.length;if(this.remainderData&&(s=Yt(this.remainderData,s),G=s.length,this.remainderData=null),G<_t&&!a)return this.remainderData=s,{audioTrack:m,videoTrack:g,id3Track:p,textTrack:E};var Y=Math.max(0,u.syncOffset(s));G-=(G-Y)%_t,G<s.byteLength&&!a&&(this.remainderData=new Uint8Array(s.buffer,G,s.buffer.byteLength-G));for(var V=0,j=Y;j<G;j+=_t)if(s[j]===71){var ae=!!(s[j+1]&64),X=fa(s,j),W=(s[j+3]&48)>>4,J=void 0;if(W>1){if(J=j+5+s[j+4],J===j+_t)continue}else J=j+4;switch(X){case x:if(ae){if(I&&(h=ui(I,this.logger))){if(this.videoParser===null)switch(g.segmentCodec){case"avc":this.videoParser=new ku;break;case"hevc":this.videoParser=new wu;break}this.videoParser!==null&&this.videoParser.parsePES(g,E,h,!1)}I={data:[],size:0}}I&&(I.data.push(s.subarray(J,j+_t)),I.size+=j+_t-J);break;case R:if(ae){if(P&&(h=ui(P,this.logger)))switch(m.segmentCodec){case"aac":this.parseAACPES(m,h);break;case"mp3":this.parseMPEGPES(m,h);break;case"ac3":this.parseAC3PES(m,h);break}P={data:[],size:0}}P&&(P.data.push(s.subarray(J,j+_t)),P.size+=j+_t-J);break;case _:ae&&(O&&(h=ui(O,this.logger))&&this.parseID3PES(p,h),O={data:[],size:0}),O&&(O.data.push(s.subarray(J,j+_t)),O.size+=j+_t-J);break;case 0:ae&&(J+=s[J]+1),B=this._pmtId=x0(s,J);break;case B:{ae&&(J+=s[J]+1);var oe=L0(s,J,this.typeSupported,i,this.observer,this.logger);x=oe.videoPid,x>0&&(g.pid=x,g.segmentCodec=oe.segmentVideoCodec),R=oe.audioPid,R>0&&(m.pid=R,m.segmentCodec=oe.segmentAudioCodec),_=oe.id3Pid,_>0&&(p.pid=_),N!==null&&!U&&(this.logger.warn("MPEG-TS PMT found at "+j+" after unknown PID '"+N+"'. Backtracking to sync byte @"+Y+" to parse all TS packets."),N=null,j=Y-188),U=this.pmtParsed=!0;break}case 17:case 8191:break;default:N=X;break}}else V++;V>0&&da(this.observer,new Error("Found "+V+" TS packet/s that do not start with 0x47"),void 0,this.logger),g.pesData=I,m.pesData=P,p.pesData=O;var ge={audioTrack:m,videoTrack:g,id3Track:p,textTrack:E};return a&&this.extractRemainingSamples(ge),ge},d.flush=function(){var s=this.remainderData;this.remainderData=null;var t;return s?t=this.demux(s,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t},d.extractRemainingSamples=function(s){var t=s.audioTrack,i=s.videoTrack,a=s.id3Track,h=s.textTrack,g=i.pesData,m=t.pesData,p=a.pesData,E;if(g&&(E=ui(g,this.logger))){if(this.videoParser===null)switch(i.segmentCodec){case"avc":this.videoParser=new ku;break;case"hevc":this.videoParser=new wu;break}this.videoParser!==null&&(this.videoParser.parsePES(i,h,E,!0),i.pesData=null)}else i.pesData=g;if(m&&(E=ui(m,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,E);break;case"mp3":this.parseMPEGPES(t,E);break;case"ac3":this.parseAC3PES(t,E);break}t.pesData=null}else m!=null&&m.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=m;p&&(E=ui(p,this.logger))?(this.parseID3PES(a,E),a.pesData=null):a.pesData=p},d.demuxSampleAes=function(s,t,i){var a=this.demux(s,i,!0,!this.config.progressive),h=this.sampleAes=new S0(this.observer,this.config,t);return this.decrypt(a,h)},d.decrypt=function(s,t){return new Promise(function(i){var a=s.audioTrack,h=s.videoTrack;a.samples&&a.segmentCodec==="aac"?t.decryptAacSamples(a.samples,0,function(){h.samples?t.decryptAvcSamples(h.samples,0,0,function(){i(s)}):i(s)}):h.samples&&t.decryptAvcSamples(h.samples,0,0,function(){i(s)})})},d.destroy=function(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0},d.parseAACPES=function(s,t){var i=0,a=this.aacOverFlow,h=t.data;if(a){this.aacOverFlow=null;var g=a.missing,m=a.sample.unit.byteLength;if(g===-1)h=Yt(a.sample.unit,h);else{var p=m-g;a.sample.unit.set(h.subarray(0,g),p),s.samples.push(a.sample),i=a.missing}}var E,x;for(E=i,x=h.length;E<x-1&&!Ds(h,E);E++);if(E!==i){var I,R=E<x-1;if(R?I="AAC PES did not start with ADTS header,offset:"+E:I="No ADTS header found in AAC PES",da(this.observer,new Error(I),R,this.logger),!R)return}yu(s,this.observer,h,E,this.audioCodec);var _;if(t.pts!==void 0)_=t.pts;else if(a){var P=Eu(s.samplerate);_=a.sample.pts+P}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var O=0,N;E<x;)if(N=Tu(s,h,E,_,O),E+=N.length,N.missing){this.aacOverFlow=N;break}else for(O++;E<x-1&&!Ds(h,E);E++);},d.parseMPEGPES=function(s,t){var i=t.data,a=i.length,h=0,g=0,m=t.pts;if(m===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;g<a;)if(Ru(i,g)){var p=Lu(s,i,g,m,h);if(p)g+=p.length,h++;else break}else g++},d.parseAC3PES=function(s,t){{var i=t.data,a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}for(var h=i.length,g=0,m=0,p;m<h&&(p=Du(s,i,m,a,g++))>0;)m+=p}},d.parseID3PES=function(s,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}var i=A({},t,{type:this._videoTrack?Kt.emsg:Kt.audioId3,duration:Number.POSITIVE_INFINITY});s.samples.push(i)},u}();function fa(u,d){return((u[d+1]&31)<<8)+u[d+2]}function x0(u,d){return(u[d+10]&31)<<8|u[d+11]}function L0(u,d,o,s,t,i){var a={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},h=(u[d+1]&15)<<8|u[d+2],g=d+3+h-4,m=(u[d+10]&15)<<8|u[d+11];for(d+=12+m;d<g;){var p=fa(u,d),E=(u[d+3]&15)<<8|u[d+4];switch(u[d]){case 207:if(!s){ca("ADTS AAC",i);break}case 15:a.audioPid===-1&&(a.audioPid=p);break;case 21:a.id3Pid===-1&&(a.id3Pid=p);break;case 219:if(!s){ca("H.264",i);break}case 27:a.videoPid===-1&&(a.videoPid=p);break;case 3:case 4:!o.mpeg&&!o.mp3?i.log("MPEG audio found, not supported in this browser"):a.audioPid===-1&&(a.audioPid=p,a.segmentAudioCodec="mp3");break;case 193:if(!s){ca("AC-3",i);break}case 129:o.ac3?a.audioPid===-1&&(a.audioPid=p,a.segmentAudioCodec="ac3"):i.log("AC-3 audio found, not supported in this browser");break;case 6:if(a.audioPid===-1&&E>0)for(var x=d+5,I=E;I>2;){var R=u[x];switch(R){case 106:o.ac3!==!0?i.log("AC-3 audio found, not supported in this browser for now"):(a.audioPid=p,a.segmentAudioCodec="ac3");break}var _=u[x+1]+2;x+=_,I-=_}break;case 194:case 135:return da(t,new Error("Unsupported EC-3 in M2TS found"),void 0,i),a;case 36:a.videoPid===-1&&(a.videoPid=p,a.segmentVideoCodec="hevc",i.log("HEVC in M2TS found"));break}d+=E+5}return a}function da(u,d,o,s){s.warn("parsing error: "+d.message),u.emit(k.ERROR,k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_PARSING_ERROR,fatal:!1,levelRetry:o,error:d,reason:d.message})}function ca(u,d){d.log(u+" with AES-128-CBC encryption found in unencrypted stream")}function ui(u,d){var o=0,s,t,i,a,h,g=u.data;if(!u||u.size===0)return null;for(;g[0].length<19&&g.length>1;)g[0]=Yt(g[0],g[1]),g.splice(1,1);s=g[0];var m=(s[0]<<16)+(s[1]<<8)+s[2];if(m===1){if(t=(s[4]<<8)+s[5],t&&t>u.size-6)return null;var p=s[7];p&192&&(a=(s[9]&14)*536870912+(s[10]&255)*4194304+(s[11]&254)*16384+(s[12]&255)*128+(s[13]&254)/2,p&64?(h=(s[14]&14)*536870912+(s[15]&255)*4194304+(s[16]&254)*16384+(s[17]&255)*128+(s[18]&254)/2,a-h>60*9e4&&(d.warn(Math.round((a-h)/9e4)+"s delta between PTS and DTS, align them"),a=h)):h=a),i=s[8];var E=i+9;if(u.size<=E)return null;u.size-=E;for(var x=new Uint8Array(u.size),I=0,R=g.length;I<R;I++){s=g[I];var _=s.byteLength;if(E)if(E>_){E-=_;continue}else s=s.subarray(E),_-=E,E=0;x.set(s,o),o+=_}return t&&(t-=i+3),{data:x,pts:a,dts:h,len:t}}return null}var I0=function(){function u(){}return u.getSilentFrame=function(o,s){switch(o){case"mp4a.40.2":if(s===1)return new Uint8Array([0,200,0,128,35,128]);if(s===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(s===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(s===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(s===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(s===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(s===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(s===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(s===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},u}(),wr=Math.pow(2,32)-1,Pt=function(){function u(){}return u.init=function(){u.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var o;for(o in u.types)u.types.hasOwnProperty(o)&&(u.types[o]=[o.charCodeAt(0),o.charCodeAt(1),o.charCodeAt(2),o.charCodeAt(3)]);var s=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),t=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);u.HDLR_TYPES={video:s,audio:t};var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),a=new Uint8Array([0,0,0,0,0,0,0,0]);u.STTS=u.STSC=u.STCO=a,u.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),u.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),u.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),u.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var h=new Uint8Array([105,115,111,109]),g=new Uint8Array([97,118,99,49]),m=new Uint8Array([0,0,0,1]);u.FTYP=u.box(u.types.ftyp,h,m,h,g),u.DINF=u.box(u.types.dinf,u.box(u.types.dref,i))},u.box=function(o){for(var s=8,t=arguments.length,i=new Array(t>1?t-1:0),a=1;a<t;a++)i[a-1]=arguments[a];for(var h=i.length,g=h;h--;)s+=i[h].byteLength;var m=new Uint8Array(s);for(m[0]=s>>24&255,m[1]=s>>16&255,m[2]=s>>8&255,m[3]=s&255,m.set(o,4),h=0,s=8;h<g;h++)m.set(i[h],s),s+=i[h].byteLength;return m},u.hdlr=function(o){return u.box(u.types.hdlr,u.HDLR_TYPES[o])},u.mdat=function(o){return u.box(u.types.mdat,o)},u.mdhd=function(o,s){s*=o;var t=Math.floor(s/(wr+1)),i=Math.floor(s%(wr+1));return u.box(u.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,o>>24&255,o>>16&255,o>>8&255,o&255,t>>24,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,85,196,0,0]))},u.mdia=function(o){return u.box(u.types.mdia,u.mdhd(o.timescale||0,o.duration||0),u.hdlr(o.type),u.minf(o))},u.mfhd=function(o){return u.box(u.types.mfhd,new Uint8Array([0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255]))},u.minf=function(o){return o.type==="audio"?u.box(u.types.minf,u.box(u.types.smhd,u.SMHD),u.DINF,u.stbl(o)):u.box(u.types.minf,u.box(u.types.vmhd,u.VMHD),u.DINF,u.stbl(o))},u.moof=function(o,s,t){return u.box(u.types.moof,u.mfhd(o),u.traf(t,s))},u.moov=function(o){for(var s=o.length,t=[];s--;)t[s]=u.trak(o[s]);return u.box.apply(null,[u.types.moov,u.mvhd(o[0].timescale||0,o[0].duration||0)].concat(t).concat(u.mvex(o)))},u.mvex=function(o){for(var s=o.length,t=[];s--;)t[s]=u.trex(o[s]);return u.box.apply(null,[u.types.mvex].concat(t))},u.mvhd=function(o,s){s*=o;var t=Math.floor(s/(wr+1)),i=Math.floor(s%(wr+1)),a=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,o>>24&255,o>>16&255,o>>8&255,o&255,t>>24,t>>16&255,t>>8&255,t&255,i>>24,i>>16&255,i>>8&255,i&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return u.box(u.types.mvhd,a)},u.sdtp=function(o){var s=o.samples||[],t=new Uint8Array(4+s.length),i,a;for(i=0;i<s.length;i++)a=s[i].flags,t[i+4]=a.dependsOn<<4|a.isDependedOn<<2|a.hasRedundancy;return u.box(u.types.sdtp,t)},u.stbl=function(o){return u.box(u.types.stbl,u.stsd(o),u.box(u.types.stts,u.STTS),u.box(u.types.stsc,u.STSC),u.box(u.types.stsz,u.STSZ),u.box(u.types.stco,u.STCO))},u.avc1=function(o){var s=[],t=[],i,a,h;for(i=0;i<o.sps.length;i++)a=o.sps[i],h=a.byteLength,s.push(h>>>8&255),s.push(h&255),s=s.concat(Array.prototype.slice.call(a));for(i=0;i<o.pps.length;i++)a=o.pps[i],h=a.byteLength,t.push(h>>>8&255),t.push(h&255),t=t.concat(Array.prototype.slice.call(a));var g=u.box(u.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|o.sps.length].concat(s).concat([o.pps.length]).concat(t))),m=o.width,p=o.height,E=o.pixelRatio[0],x=o.pixelRatio[1];return u.box(u.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,m>>8&255,m&255,p>>8&255,p&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),g,u.box(u.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),u.box(u.types.pasp,new Uint8Array([E>>24,E>>16&255,E>>8&255,E&255,x>>24,x>>16&255,x>>8&255,x&255])))},u.esds=function(o){var s=o.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2].concat(s,[6,1,2]))},u.audioStsd=function(o){var s=o.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,o.channelCount||0,0,16,0,0,0,0,s>>8&255,s&255,0,0])},u.mp4a=function(o){return u.box(u.types.mp4a,u.audioStsd(o),u.box(u.types.esds,u.esds(o)))},u.mp3=function(o){return u.box(u.types[".mp3"],u.audioStsd(o))},u.ac3=function(o){return u.box(u.types["ac-3"],u.audioStsd(o),u.box(u.types.dac3,o.config))},u.stsd=function(o){var s=o.segmentCodec;if(o.type==="audio"){if(s==="aac")return u.box(u.types.stsd,u.STSD,u.mp4a(o));if(s==="ac3"&&o.config)return u.box(u.types.stsd,u.STSD,u.ac3(o));if(s==="mp3"&&o.codec==="mp3")return u.box(u.types.stsd,u.STSD,u.mp3(o))}else if(o.pps&&o.sps){if(s==="avc")return u.box(u.types.stsd,u.STSD,u.avc1(o));if(s==="hevc"&&o.vps)return u.box(u.types.stsd,u.STSD,u.hvc1(o))}else throw new Error("video track missing pps or sps");throw new Error("unsupported "+o.type+" segment codec ("+s+"/"+o.codec+")")},u.tkhd=function(o){var s=o.id,t=(o.duration||0)*(o.timescale||0),i=o.width||0,a=o.height||0,h=Math.floor(t/(wr+1)),g=Math.floor(t%(wr+1));return u.box(u.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,s>>24&255,s>>16&255,s>>8&255,s&255,0,0,0,0,h>>24,h>>16&255,h>>8&255,h&255,g>>24,g>>16&255,g>>8&255,g&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,i&255,0,0,a>>8&255,a&255,0,0]))},u.traf=function(o,s){var t=u.sdtp(o),i=o.id,a=Math.floor(s/(wr+1)),h=Math.floor(s%(wr+1));return u.box(u.types.traf,u.box(u.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])),u.box(u.types.tfdt,new Uint8Array([1,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,h>>24,h>>16&255,h>>8&255,h&255])),u.trun(o,t.length+16+20+8+16+8+8),t)},u.trak=function(o){return o.duration=o.duration||4294967295,u.box(u.types.trak,u.tkhd(o),u.mdia(o))},u.trex=function(o){var s=o.id;return u.box(u.types.trex,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},u.trun=function(o,s){var t=o.samples||[],i=t.length,a=12+16*i,h=new Uint8Array(a),g,m,p,E,x,I;for(s+=8+a,h.set([o.type==="video"?1:0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,i&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255],0),g=0;g<i;g++)m=t[g],p=m.duration,E=m.size,x=m.flags,I=m.cts,h.set([p>>>24&255,p>>>16&255,p>>>8&255,p&255,E>>>24&255,E>>>16&255,E>>>8&255,E&255,x.isLeading<<2|x.dependsOn,x.isDependedOn<<6|x.hasRedundancy<<4|x.paddingValue<<1|x.isNonSync,x.degradPrio&61440,x.degradPrio&15,I>>>24&255,I>>>16&255,I>>>8&255,I&255],12+16*g);return u.box(u.types.trun,h)},u.initSegment=function(o){u.types||u.init();var s=u.moov(o),t=Yt(u.FTYP,s);return t},u.hvc1=function(o){for(var s=o.params,t=[o.vps,o.sps,o.pps],i=4,a=new Uint8Array([1,s.general_profile_space<<6|(s.general_tier_flag?32:0)|s.general_profile_idc,s.general_profile_compatibility_flags[0],s.general_profile_compatibility_flags[1],s.general_profile_compatibility_flags[2],s.general_profile_compatibility_flags[3],s.general_constraint_indicator_flags[0],s.general_constraint_indicator_flags[1],s.general_constraint_indicator_flags[2],s.general_constraint_indicator_flags[3],s.general_constraint_indicator_flags[4],s.general_constraint_indicator_flags[5],s.general_level_idc,240|s.min_spatial_segmentation_idc>>8,255&s.min_spatial_segmentation_idc,252|s.parallelismType,252|s.chroma_format_idc,248|s.bit_depth_luma_minus8,248|s.bit_depth_chroma_minus8,0,parseInt(s.frame_rate.fps),i-1|s.temporal_id_nested<<2|s.num_temporal_layers<<3|(s.frame_rate.fixed?64:0),t.length]),h=a.length,g=0;g<t.length;g+=1){h+=3;for(var m=0;m<t[g].length;m+=1)h+=2+t[g][m].length}var p=new Uint8Array(h);p.set(a,0),h=a.length;for(var E=t.length-1,x=0;x<t.length;x+=1){p.set(new Uint8Array([32+x|(x===E?128:0),0,t[x].length]),h),h+=3;for(var I=0;I<t[x].length;I+=1)p.set(new Uint8Array([t[x][I].length>>8,t[x][I].length&255]),h),h+=2,p.set(t[x][I],h),h+=t[x][I].length}var R=u.box(u.types.hvcC,p),_=o.width,P=o.height,O=o.pixelRatio[0],N=o.pixelRatio[1];return u.box(u.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,_>>8&255,_&255,P>>8&255,P&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),R,u.box(u.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),u.box(u.types.pasp,new Uint8Array([O>>24,O>>16&255,O>>8&255,O&255,N>>24,N>>16&255,N>>8&255,N&255])))},u}();Pt.types=void 0,Pt.HDLR_TYPES=void 0,Pt.STTS=void 0,Pt.STSC=void 0,Pt.STCO=void 0,Pt.STSZ=void 0,Pt.VMHD=void 0,Pt.SMHD=void 0,Pt.STSD=void 0,Pt.FTYP=void 0,Pt.DINF=void 0;var Ou=9e4;function ga(u,d,o,s){o===void 0&&(o=1),s===void 0&&(s=!1);var t=u*d*o;return s?Math.round(t):t}function R0(u,d,o,s){return o===void 0&&(o=1),s===void 0&&(s=!1),ga(u,d,1/o,s)}function $i(u,d){return ga(u,1e3,1/Ou,d)}function b0(u,d){return d===void 0&&(d=1),ga(u,Ou,1/d)}var _0=10*1e3,D0=1024,C0=1152,P0=1536,hi=null,va=null;function Mu(u,d,o,s){return{duration:d,size:o,cts:s,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:u?2:1,isNonSync:u?0:1}}}var ks=function(){function u(o,s,t,i){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=o,this.config=s,this.typeSupported=t,this.logger=i,this.ISGenerated=!1,hi===null){var a=navigator.userAgent||"",h=a.match(/Chrome\/(\d+)/i);hi=h?parseInt(h[1]):0}if(va===null){var g=navigator.userAgent.match(/Safari\/(\d+)/i);va=g?parseInt(g[1]):0}}var d=u.prototype;return d.destroy=function(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null},d.resetTimeStamp=function(s){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=s},d.resetNextTimestamp=function(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},d.resetInitSegment=function(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0},d.getVideoStartPts=function(s){var t=!1,i=s[0].pts,a=s.reduce(function(h,g){var m=g.pts,p=m-h;return p<-4294967296&&(t=!0,m=Wt(m,i),p=m-h),p>0?h:m},i);return t&&this.logger.debug("PTS rollover detected"),a},d.remux=function(s,t,i,a,h,g,m,p){var E,x,I,R,_,P,O=h,N=h,U=s.pid>-1,B=t.pid>-1,G=t.samples.length,Y=s.samples.length>0,V=m&&G>0||G>1,j=(!U||Y)&&(!B||V)||this.ISGenerated||m;if(j){if(this.ISGenerated){var ae,X,W,J,oe=this.videoTrackConfig;(oe&&(t.width!==oe.width||t.height!==oe.height||((ae=t.pixelRatio)==null?void 0:ae[0])!==((X=oe.pixelRatio)==null?void 0:X[0])||((W=t.pixelRatio)==null?void 0:W[1])!==((J=oe.pixelRatio)==null?void 0:J[1]))||!oe&&V||this.nextAudioPts===null&&Y)&&this.resetInitSegment()}this.ISGenerated||(I=this.generateIS(s,t,h,g));var ge=this.isVideoContiguous,ce=-1,he;if(V&&(ce=k0(t.samples),!ge&&this.config.forceKeyFrameOnDiscontinuity))if(P=!0,ce>0){this.logger.warn("[mp4-remuxer]: Dropped "+ce+" out of "+G+" video samples due to a missing keyframe");var ye=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(ce),t.dropped+=ce,N+=(t.samples[0].pts-ye)/t.inputTimeScale,he=N}else ce===-1&&(this.logger.warn("[mp4-remuxer]: No keyframe found out of "+G+" video samples"),P=!1);if(this.ISGenerated){if(Y&&V){var Se=this.getVideoStartPts(t.samples),Le=Wt(s.samples[0].pts,Se)-Se,Ie=Le/t.inputTimeScale;O+=Math.max(0,Ie),N+=Math.max(0,-Ie)}if(Y){if(s.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),I=this.generateIS(s,t,h,g)),x=this.remuxAudio(s,O,this.isAudioContiguous,g,B||V||p===pe.AUDIO?N:void 0),V){var He=x?x.endPTS-x.startPTS:0;t.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),I=this.generateIS(s,t,h,g)),E=this.remuxVideo(t,N,ge,He)}}else V&&(E=this.remuxVideo(t,N,ge,0));E&&(E.firstKeyFrame=ce,E.independent=ce!==-1,E.firstKeyFramePTS=he)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(_=Fu(i,h,this._initPTS,this._initDTS)),a.samples.length&&(R=Nu(a,h,this._initPTS))),{audio:x,video:E,initSegment:I,independent:P,text:R,id3:_}},d.generateIS=function(s,t,i,a){var h=s.samples,g=t.samples,m=this.typeSupported,p={},E=this._initPTS,x=!E||a,I="audio/mp4",R,_,P;if(x&&(R=_=1/0),s.config&&h.length){switch(s.timescale=s.samplerate,s.segmentCodec){case"mp3":m.mpeg?(I="audio/mpeg",s.codec=""):m.mp3&&(s.codec="mp3");break;case"ac3":s.codec="ac-3";break}p.audio={id:"audio",container:I,codec:s.codec,initSegment:s.segmentCodec==="mp3"&&m.mpeg?new Uint8Array(0):Pt.initSegment([s]),metadata:{channelCount:s.channelCount}},x&&(P=s.inputTimeScale,!E||P!==E.timescale?R=_=h[0].pts-Math.round(P*i):x=!1)}if(t.sps&&t.pps&&g.length){if(t.timescale=t.inputTimeScale,p.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:Pt.initSegment([t]),metadata:{width:t.width,height:t.height}},x)if(P=t.inputTimeScale,!E||P!==E.timescale){var O=this.getVideoStartPts(g),N=Math.round(P*i);_=Math.min(_,Wt(g[0].dts,O)-N),R=Math.min(R,O-N)}else x=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(p).length)return this.ISGenerated=!0,x?(this._initPTS={baseTime:R,timescale:P},this._initDTS={baseTime:_,timescale:P}):R=P=void 0,{tracks:p,initPTS:R,timescale:P}},d.remuxVideo=function(s,t,i,a){var h=s.inputTimeScale,g=s.samples,m=[],p=g.length,E=this._initPTS,x=this.nextAvcDts,I=8,R=this.videoSampleDuration,_,P,O=Number.POSITIVE_INFINITY,N=Number.NEGATIVE_INFINITY,U=!1;if(!i||x===null){var B=t*h,G=g[0].pts-Wt(g[0].dts,g[0].pts);hi&&x!==null&&Math.abs(B-G-x)<15e3?i=!0:x=B-G}for(var Y=E.baseTime*h/E.timescale,V=0;V<p;V++){var j=g[V];j.pts=Wt(j.pts-Y,x),j.dts=Wt(j.dts-Y,x),j.dts<g[V>0?V-1:V].dts&&(U=!0)}U&&g.sort(function(Ti,js){var Xs=Ti.dts-js.dts,zs=Ti.pts-js.pts;return Xs||zs}),_=g[0].dts,P=g[g.length-1].dts;var ae=P-_,X=ae?Math.round(ae/(p-1)):R||s.inputTimeScale/30;if(i){var W=_-x,J=W>X,oe=W<-1;if((J||oe)&&(J?this.logger.warn((s.segmentCodec||"").toUpperCase()+": "+$i(W,!0)+" ms ("+W+"dts) hole between fragments detected at "+t.toFixed(3)):this.logger.warn((s.segmentCodec||"").toUpperCase()+": "+$i(-W,!0)+" ms ("+W+"dts) overlapping between fragments detected at "+t.toFixed(3)),!oe||x>=g[0].pts||hi)){_=x;var ge=g[0].pts-W;if(J)g[0].dts=_,g[0].pts=ge;else for(var ce=!0,he=0;he<g.length&&!(g[he].dts>ge&&ce);he++){var ye=g[he].pts;if(g[he].dts-=W,g[he].pts-=W,he<g.length-1){var Se=g[he+1].pts,Le=g[he].pts,Ie=Se<=Le,He=Se<=ye;ce=Ie==He}}this.logger.log("Video: Initial PTS/DTS adjusted: "+$i(ge,!0)+"/"+$i(_,!0)+", delta: "+$i(W,!0)+" ms")}}_=Math.max(0,_);for(var Oe=0,je=0,Fe=_,Xe=0;Xe<p;Xe++){for(var ze=g[Xe],it=ze.units,yt=it.length,gt=0,nt=0;nt<yt;nt++)gt+=it[nt].data.length;je+=gt,Oe+=yt,ze.length=gt,ze.dts<Fe?(ze.dts=Fe,Fe+=X/4|0||1):Fe=ze.dts,O=Math.min(ze.pts,O),N=Math.max(ze.pts,N)}P=g[p-1].dts;var Et=je+4*Oe+8,ut;try{ut=new Uint8Array(Et)}catch(Ti){this.observer.emit(k.ERROR,k.ERROR,{type:se.MUX_ERROR,details:q.REMUX_ALLOC_ERROR,fatal:!1,error:Ti,bytes:Et,reason:"fail allocating video mdat "+Et});return}var Ge=new DataView(ut.buffer);Ge.setUint32(0,Et),ut.set(Pt.types.mdat,4);for(var Mt=!1,Dt=Number.POSITIVE_INFINITY,Lt=Number.POSITIVE_INFINITY,vt=Number.NEGATIVE_INFINITY,St=Number.NEGATIVE_INFINITY,ht=0;ht<p;ht++){for(var Tt=g[ht],fr=Tt.units,Mr=0,jt=0,mi=fr.length;jt<mi;jt++){var er=fr[jt],Vs=er.data,pi=er.data.byteLength;Ge.setUint32(I,pi),I+=4,ut.set(Vs,I),I+=pi,Mr+=4+pi}var Fr=void 0;if(ht<p-1)R=g[ht+1].dts-Tt.dts,Fr=g[ht+1].pts-Tt.pts;else{var yi=this.config,Nr=ht>0?Tt.dts-g[ht-1].dts:X;if(Fr=ht>0?Tt.pts-g[ht-1].pts:X,yi.stretchShortVideoTrack&&this.nextAudioPts!==null){var Hs=Math.floor(yi.maxBufferHole*h),Ei=(a?O+a*h:this.nextAudioPts)-Tt.pts;Ei>Hs?(R=Ei-Nr,R<0?R=Nr:Mt=!0,this.logger.log("[mp4-remuxer]: It is approximately "+Ei/90+" ms to the next segment; using duration "+R/90+" ms for the last video frame.")):R=Nr}else R=Nr}var Wi=Math.round(Tt.pts-Tt.dts);Dt=Math.min(Dt,R),vt=Math.max(vt,R),Lt=Math.min(Lt,Fr),St=Math.max(St,Fr),m.push(Mu(Tt.key,R,Mr,Wi))}if(m.length){if(hi){if(hi<70){var Ys=m[0].flags;Ys.dependsOn=2,Ys.isNonSync=0}}else if(va&&St-Lt<vt-Dt&&X/vt<.025&&m[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var qi=_,kt=0,Ws=m.length;kt<Ws;kt++){var qs=qi+m[kt].duration,Ka=qi+m[kt].cts;if(kt<Ws-1){var Va=qs+m[kt+1].cts;m[kt].duration=Va-Ka}else m[kt].duration=kt?m[kt-1].duration:X;m[kt].cts=0,qi=qs}}}R=Mt||!R?X:R,this.nextAvcDts=x=P+R,this.videoSampleDuration=R,this.isVideoContiguous=!0;var Ha=Pt.moof(s.sequenceNumber++,_,A(s,{samples:m})),Ya="video",Wa={data1:Ha,data2:ut,startPTS:O/h,endPTS:(N+R)/h,startDTS:_/h,endDTS:x/h,type:Ya,hasAudio:!1,hasVideo:!0,nb:m.length,dropped:s.dropped};return s.samples=[],s.dropped=0,Wa},d.getSamplesPerFrame=function(s){switch(s.segmentCodec){case"mp3":return C0;case"ac3":return P0;default:return D0}},d.remuxAudio=function(s,t,i,a,h){var g=s.inputTimeScale,m=s.samplerate?s.samplerate:g,p=g/m,E=this.getSamplesPerFrame(s),x=E*p,I=this._initPTS,R=s.segmentCodec==="mp3"&&this.typeSupported.mpeg,_=[],P=h!==void 0,O=s.samples,N=R?0:8,U=this.nextAudioPts||-1,B=t*g,G=I.baseTime*g/I.timescale;if(this.isAudioContiguous=i=i||O.length&&U>0&&(a&&Math.abs(B-U)<9e3||Math.abs(Wt(O[0].pts-G,B)-U)<20*x),O.forEach(function(vt){vt.pts=Wt(vt.pts-G,B)}),!i||U<0){if(O=O.filter(function(vt){return vt.pts>=0}),!O.length)return;h===0?U=0:a&&!P?U=Math.max(0,B):U=O[0].pts}if(s.segmentCodec==="aac")for(var Y=this.config.maxAudioFramesDrift,V=0,j=U;V<O.length;V++){var ae=O[V],X=ae.pts,W=X-j,J=Math.abs(1e3*W/g);if(W<=-Y*x&&P)V===0&&(this.logger.warn("Audio frame @ "+(X/g).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*W/g)+" ms."),this.nextAudioPts=U=j=X);else if(W>=Y*x&&J<_0&&P){var oe=Math.round(W/x);j=X-oe*x,j<0&&(oe--,j+=x),V===0&&(this.nextAudioPts=U=j),this.logger.warn("[mp4-remuxer]: Injecting "+oe+" audio frame @ "+(j/g).toFixed(3)+"s due to "+Math.round(1e3*W/g)+" ms gap.");for(var ge=0;ge<oe;ge++){var ce=Math.max(j,0),he=I0.getSilentFrame(s.parsedCodec||s.manifestCodec||s.codec,s.channelCount);he||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),he=ae.unit.subarray()),O.splice(V,0,{unit:he,pts:ce}),j+=x,V++}}ae.pts=j,j+=x}for(var ye=null,Se=null,Le,Ie=0,He=O.length;He--;)Ie+=O[He].unit.byteLength;for(var Oe=0,je=O.length;Oe<je;Oe++){var Fe=O[Oe],Xe=Fe.unit,ze=Fe.pts;if(Se!==null){var it=_[Oe-1];it.duration=Math.round((ze-Se)/p)}else if(i&&s.segmentCodec==="aac"&&(ze=U),ye=ze,Ie>0){Ie+=N;try{Le=new Uint8Array(Ie)}catch(vt){this.observer.emit(k.ERROR,k.ERROR,{type:se.MUX_ERROR,details:q.REMUX_ALLOC_ERROR,fatal:!1,error:vt,bytes:Ie,reason:"fail allocating audio mdat "+Ie});return}if(!R){var yt=new DataView(Le.buffer);yt.setUint32(0,Ie),Le.set(Pt.types.mdat,4)}}else return;Le.set(Xe,N);var gt=Xe.byteLength;N+=gt,_.push(Mu(!0,E,gt,0)),Se=ze}var nt=_.length;if(nt){var Et=_[_.length-1];this.nextAudioPts=U=Se+p*Et.duration;var ut=R?new Uint8Array(0):Pt.moof(s.sequenceNumber++,ye/p,A({},s,{samples:_}));s.samples=[];var Ge=ye/g,Mt=U/g,Dt="audio",Lt={data1:ut,data2:Le,startPTS:Ge,endPTS:Mt,startDTS:Ge,endDTS:Mt,type:Dt,hasAudio:!0,hasVideo:!1,nb:nt};return this.isAudioContiguous=!0,Lt}},u}();function Wt(u,d){var o;if(d===null)return u;for(d<u?o=-8589934592:o=8589934592;Math.abs(u-d)>4294967296;)u+=o;return u}function k0(u){for(var d=0;d<u.length;d++)if(u[d].key)return d;return-1}function Fu(u,d,o,s){var t=u.samples.length;if(t){for(var i=u.inputTimeScale,a=0;a<t;a++){var h=u.samples[a];h.pts=Wt(h.pts-o.baseTime*i/o.timescale,d*i)/i,h.dts=Wt(h.dts-s.baseTime*i/s.timescale,d*i)/i}var g=u.samples;return u.samples=[],{samples:g}}}function Nu(u,d,o){var s=u.samples.length;if(s){for(var t=u.inputTimeScale,i=0;i<s;i++){var a=u.samples[i];a.pts=Wt(a.pts-o.baseTime*t/o.timescale,d*t)/t}u.samples.sort(function(g,m){return g.pts-m.pts});var h=u.samples;return u.samples=[],{samples:h}}}var w0=function(){function u(o,s,t,i){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.logger=i}var d=u.prototype;return d.destroy=function(){},d.resetTimeStamp=function(s){this.initPTS=s,this.lastEndTime=null},d.resetNextTimestamp=function(){this.lastEndTime=null},d.resetInitSegment=function(s,t,i,a){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(bc(s,a)),this.emitInitSegment=!0},d.generateInitSegment=function(s){var t=this.audioCodec,i=this.videoCodec;if(!(s!=null&&s.byteLength)){this.initTracks=void 0,this.initData=void 0;return}var a=this.initData=fl(s);a.audio&&(t=Uu(a.audio,Ve.AUDIO)),a.video&&(i=Uu(a.video,Ve.VIDEO));var h={};a.audio&&a.video?h.audiovideo={container:"video/mp4",codec:t+","+i,supplemental:a.video.supplemental,initSegment:s,id:"main"}:a.audio?h.audio={container:"audio/mp4",codec:t,initSegment:s,id:"audio"}:a.video?h.video={container:"video/mp4",codec:i,supplemental:a.video.supplemental,initSegment:s,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=h},d.remux=function(s,t,i,a,h,g){var m,p,E=this.initPTS,x=this.lastEndTime,I={audio:void 0,video:void 0,text:a,id3:i,initSegment:void 0};ue(x)||(x=this.lastEndTime=h||0);var R=t.samples;if(!(R!=null&&R.length))return I;var _={initPTS:void 0,timescale:1},P=this.initData;if((m=P)!=null&&m.length||(this.generateInitSegment(R),P=this.initData),!((p=P)!=null&&p.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),I;this.emitInitSegment&&(_.tracks=this.initTracks,this.emitInitSegment=!1);var O=Dc(R,P),N=_c(P,R),U=N===null?h:N;(g||!E)&&(O0(E,U,h,O)||_.timescale!==E.timescale)&&(_.initPTS=U-h,E&&E.timescale===1&&this.logger.warn("Adjusting initPTS @"+h+" from "+E.baseTime/E.timescale+" to "+_.initPTS),this.initPTS=E={baseTime:_.initPTS,timescale:1});var B=s?U-E.baseTime/E.timescale:x,G=B+O;Pc(P,R,E.baseTime/E.timescale),O>0?this.lastEndTime=G:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var Y=!!P.audio,V=!!P.video,j="";Y&&(j+="audio"),V&&(j+="video");var ae={data1:R,startPTS:B,startDTS:B,endPTS:G,endDTS:G,type:j,hasAudio:Y,hasVideo:V,nb:1,dropped:0};return I.audio=ae.type==="audio"?ae:void 0,I.video=ae.type!=="audio"?ae:void 0,I.initSegment=_,I.id3=Fu(i,h,E,E),a.samples.length&&(I.text=Nu(a,h,E)),I},u}();function O0(u,d,o,s){if(u===null)return!0;var t=Math.max(s,1),i=d-u.baseTime/u.timescale;return Math.abs(i-o)>t}function Uu(u,d){var o=u==null?void 0:u.codec;if(o&&o.length>4)return o;if(d===Ve.AUDIO){if(o==="ec-3"||o==="ac-3"||o==="alac")return o;if(o==="fLaC"||o==="Opus"){var s=!1;return gs(o,s)}return Ye.warn('Unhandled audio codec "'+o+'" in mp4 MAP'),o||"mp4a"}return Ye.warn('Unhandled video codec "'+o+'" in mp4 MAP'),o||"avc1"}var Ar;try{Ar=self.performance.now.bind(self.performance)}catch{Ar=Date.now}var ws=[{demux:T0,remux:w0},{demux:A0,remux:ks},{demux:m0,remux:ks},{demux:y0,remux:ks}];ws.splice(2,0,{demux:p0,remux:ks});var ma=function(){function u(o,s,t,i,a,h){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=o,this.typeSupported=s,this.config=t,this.id=a,this.logger=h}var d=u.prototype;return d.configure=function(s){this.transmuxConfig=s,this.decrypter&&this.decrypter.reset()},d.push=function(s,t,i,a){var h=this,g=i.transmuxing;g.executeStart=Ar();var m=new Uint8Array(s),p=this.currentTransmuxState,E=this.transmuxConfig;a&&(this.currentTransmuxState=a);var x=a||p,I=x.contiguous,R=x.discontinuity,_=x.trackSwitch,P=x.accurateTimeOffset,O=x.timeOffset,N=x.initSegmentChange,U=E.audioCodec,B=E.videoCodec,G=E.defaultInitPts,Y=E.duration,V=E.initSegmentData,j=M0(m,t);if(j&&li(j.method)){var ae=this.getDecrypter(),X=qn(j.method);if(ae.isSync()){var W=ae.softwareDecrypt(m,j.key.buffer,j.iv.buffer,X),J=i.part>-1;if(J){var oe=ae.flush();W=oe&&oe.buffer}if(!W)return g.executeEnd=Ar(),pa(i);m=new Uint8Array(W)}else return this.asyncResult=!0,this.decryptionPromise=ae.webCryptoDecrypt(m,j.key.buffer,j.iv.buffer,X).then(function(Se){var Le=h.push(Se,null,i);return h.decryptionPromise=null,Le}),this.decryptionPromise}var ge=this.needsProbing(R,_);if(ge){var ce=this.configureTransmuxer(m);if(ce)return this.logger.warn("[transmuxer] "+ce.message),this.observer.emit(k.ERROR,k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_PARSING_ERROR,fatal:!1,error:ce,reason:ce.message}),g.executeEnd=Ar(),pa(i)}(R||_||N||ge)&&this.resetInitSegment(V,U,B,Y,t),(R||N||ge)&&this.resetInitialTimestamp(G),I||this.resetContiguity();var he=this.transmux(m,j,O,P,i);this.asyncResult=zr(he);var ye=this.currentTransmuxState;return ye.contiguous=!0,ye.discontinuity=!1,ye.trackSwitch=!1,g.executeEnd=Ar(),he},d.flush=function(s){var t=this,i=s.transmuxing;i.executeStart=Ar();var a=this.decrypter,h=this.currentTransmuxState,g=this.decryptionPromise;if(g)return this.asyncResult=!0,g.then(function(){return t.flush(s)});var m=[],p=h.timeOffset;if(a){var E=a.flush();E&&m.push(this.push(E.buffer,null,s))}var x=this.demuxer,I=this.remuxer;if(!x||!I){i.executeEnd=Ar();var R=[pa(s)];return this.asyncResult?Promise.resolve(R):R}var _=x.flush(p);return zr(_)?(this.asyncResult=!0,_.then(function(P){return t.flushRemux(m,P,s),m})):(this.flushRemux(m,_,s),this.asyncResult?Promise.resolve(m):m)},d.flushRemux=function(s,t,i){var a=t.audioTrack,h=t.videoTrack,g=t.id3Track,m=t.textTrack,p=this.currentTransmuxState,E=p.accurateTimeOffset,x=p.timeOffset;this.logger.log("[transmuxer.ts]: Flushed "+this.id+" sn: "+i.sn+(i.part>-1?" part: "+i.part:"")+" of "+(this.id===pe.MAIN?"level":"track")+" "+i.level);var I=this.remuxer.remux(a,h,g,m,x,E,!0,this.id);s.push({remuxResult:I,chunkMeta:i}),i.transmuxing.executeEnd=Ar()},d.resetInitialTimestamp=function(s){var t=this.demuxer,i=this.remuxer;!t||!i||(t.resetTimeStamp(s),i.resetTimeStamp(s))},d.resetContiguity=function(){var s=this.demuxer,t=this.remuxer;!s||!t||(s.resetContiguity(),t.resetNextTimestamp())},d.resetInitSegment=function(s,t,i,a,h){var g=this.demuxer,m=this.remuxer;!g||!m||(g.resetInitSegment(s,t,i,a),m.resetInitSegment(s,t,i,h))},d.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},d.transmux=function(s,t,i,a,h){var g;return t&&t.method==="SAMPLE-AES"?g=this.transmuxSampleAes(s,t,i,a,h):g=this.transmuxUnencrypted(s,i,a,h),g},d.transmuxUnencrypted=function(s,t,i,a){var h=this.demuxer.demux(s,t,!1,!this.config.progressive),g=h.audioTrack,m=h.videoTrack,p=h.id3Track,E=h.textTrack,x=this.remuxer.remux(g,m,p,E,t,i,!1,this.id);return{remuxResult:x,chunkMeta:a}},d.transmuxSampleAes=function(s,t,i,a,h){var g=this;return this.demuxer.demuxSampleAes(s,t,i).then(function(m){var p=g.remuxer.remux(m.audioTrack,m.videoTrack,m.id3Track,m.textTrack,i,a,!1,g.id);return{remuxResult:p,chunkMeta:h}})},d.configureTransmuxer=function(s){for(var t=this.config,i=this.observer,a=this.typeSupported,h,g=0,m=ws.length;g<m;g++){var p;if((p=ws[g].demux)!=null&&p.probe(s,this.logger)){h=ws[g];break}}if(!h)return new Error("Failed to find demuxer by probing fragment data");var E=this.demuxer,x=this.remuxer,I=h.remux,R=h.demux;(!x||!(x instanceof I))&&(this.remuxer=new I(i,t,a,this.logger)),(!E||!(E instanceof R))&&(this.demuxer=new R(i,t,a,this.logger),this.probe=R.probe)},d.needsProbing=function(s,t){return!this.demuxer||!this.remuxer||s||t},d.getDecrypter=function(){var s=this.decrypter;return s||(s=this.decrypter=new Hn(this.config)),s},u}();function M0(u,d){var o=null;return u.byteLength>0&&(d==null?void 0:d.key)!=null&&d.iv!==null&&d.method!=null&&(o=d),o}var pa=function(d){return{remuxResult:{},chunkMeta:d}};function zr(u){return"then"in u&&u.then instanceof Function}var F0=function(d,o,s,t,i){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=d,this.videoCodec=o,this.initSegmentData=s,this.duration=t,this.defaultInitPts=i||null},N0=function(d,o,s,t,i,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=d,this.contiguous=o,this.accurateTimeOffset=s,this.trackSwitch=t,this.timeOffset=i,this.initSegmentChange=a},ya=[];typeof n<"u"&&n&&U0();function U0(){self.addEventListener("message",function(u){var d=u.data,o=d.instanceNo;if(o!==void 0){var s=ya[o];if(d.cmd==="reset"&&(delete ya[d.resetNo],s&&s.destroy(),d.cmd="init"),d.cmd==="init"){var t=JSON.parse(d.config),i=new Ee;i.on(k.FRAG_DECRYPTED,fi),i.on(k.ERROR,fi);var a=si(t.debug,d.id);B0(a,o),ya[o]=new ma(i,d.typeSupported,t,"",d.id,a),fi("init",null,o);return}if(s)switch(d.cmd){case"configure":{s.configure(d.config);break}case"demux":{var h=s.push(d.data,d.decryptdata,d.chunkMeta,d.state);zr(h)?h.then(function(p){Ea(self,p,o)}).catch(function(p){fi(k.ERROR,{instanceNo:o,type:se.MEDIA_ERROR,details:q.FRAG_PARSING_ERROR,chunkMeta:d.chunkMeta,fatal:!1,error:p,err:p,reason:"transmuxer-worker push error"},o)}):Ea(self,h,o);break}case"flush":{var g=d.chunkMeta,m=s.flush(g);zr(m)?m.then(function(p){Gu(self,p,g,o)}).catch(function(p){fi(k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_PARSING_ERROR,chunkMeta:d.chunkMeta,fatal:!1,error:p,err:p,reason:"transmuxer-worker flush error"},o)}):Gu(self,m,g,o);break}}}})}function Ea(u,d,o){if(G0(d.remuxResult))return!1;var s=[],t=d.remuxResult,i=t.audio,a=t.video;return i&&Bu(s,i),a&&Bu(s,a),u.postMessage({event:"transmuxComplete",data:d,instanceNo:o},s),!0}function Bu(u,d){d.data1&&u.push(d.data1.buffer),d.data2&&u.push(d.data2.buffer)}function Gu(u,d,o,s){var t=d.reduce(function(i,a){return Ea(u,a,s)||i},!1);t||u.postMessage({event:"transmuxComplete",data:d[0],instanceNo:s}),u.postMessage({event:"flush",data:o,instanceNo:s})}function fi(u,d,o){self.postMessage({event:u,data:d,instanceNo:o})}function B0(u,d){var o=function(i){var a=function(g){fi("workerLog",{logType:i,message:g},d)};u[i]=a};for(var s in u)o(s)}function G0(u){return!u.audio&&!u.video&&!u.text&&!u.id3&&!u.initSegment}var Ki="1.6.0",di={};function $0(){return typeof r=="function"}function K0(){var u=di[Ki];if(u)return u.clientCount++,u;var d=new self.Blob(["var exports={};var module={exports:exports};function define(f){f()};define.amd=true;("+r.toString()+")(true);"],{type:"text/javascript"}),o=self.URL.createObjectURL(d),s=new self.Worker(o),t={worker:s,objectURL:o,clientCount:1};return di[Ki]=t,t}function V0(u){var d=di[u];if(d)return d.clientCount++,d;var o=new self.URL(u,self.location.href).href,s=new self.Worker(o),t={worker:s,scriptURL:o,clientCount:1};return di[u]=t,t}function H0(u){var d=di[u||Ki];if(d){var o=d.clientCount--;if(o===1){var s=d.worker,t=d.objectURL;delete di[u||Ki],t&&self.URL.revokeObjectURL(t),s.terminate()}}}var $u=0,Ku=function(){function u(o,s,t,i){var a=this;this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=$u++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=function(I){var R=I.data,_=a.hls;if(!(!_||!(R!=null&&R.event)||R.instanceNo!==a.instanceNo))switch(R.event){case"init":{var P,O=(P=a.workerContext)==null?void 0:P.objectURL;O&&self.URL.revokeObjectURL(O);break}case"transmuxComplete":{a.handleTransmuxComplete(R.data);break}case"flush":{a.onFlush(R.data);break}case"workerLog":{_.logger[R.data.logType]&&_.logger[R.data.logType](R.data.message);break}default:{R.data=R.data||{},R.data.frag=a.frag,R.data.part=a.part,R.data.id=a.id,_.trigger(R.event,R.data);break}}},this.onWorkerError=function(I){if(a.hls){var R=new Error(I.message+"  ("+I.filename+":"+I.lineno+")");a.hls.config.enableWorker=!1,a.hls.logger.warn('Error in "'+a.id+'" Web Worker, fallback to inline'),a.hls.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:R})}};var h=o.config;this.hls=o,this.id=s,this.useWorker=!!h.enableWorker,this.onTransmuxComplete=t,this.onFlush=i;var g=function(R,_){_=_||{},_.frag=a.frag||void 0,R===k.ERROR&&(_=_,_.parent=a.id,_.part=a.part,a.error=_.error),a.hls.trigger(R,_)};this.observer=new Ee,this.observer.on(k.FRAG_DECRYPTED,g),this.observer.on(k.ERROR,g);var m=El(h.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){var p=this.hls.logger,E=h.workerPath||$0();if(E){try{h.workerPath?(p.log("loading Web Worker "+h.workerPath+' for "'+s+'"'),this.workerContext=V0(h.workerPath)):(p.log('injecting Web Worker for "'+s+'"'),this.workerContext=K0());var x=this.workerContext.worker;x.addEventListener("message",this.onWorkerMessage),x.addEventListener("error",this.onWorkerError),x.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:m,id:s,config:at(h)})}catch(I){p.warn('Error setting up "'+s+'" Web Worker, fallback to inline',I),this.terminateWorker(),this.error=null,this.transmuxer=new ma(this.observer,m,h,"",s,o.logger)}return}}this.transmuxer=new ma(this.observer,m,h,"",s,o.logger)}var d=u.prototype;return d.reset=function(){if(this.frag=null,this.part=null,this.workerContext){var s=this.instanceNo;this.instanceNo=$u++;var t=this.hls.config,i=El(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:s,typeSupported:i,id:this.id,config:at(t)})}},d.terminateWorker=function(){if(this.workerContext){var s=this.workerContext.worker;this.workerContext=null,s.removeEventListener("message",this.onWorkerMessage),s.removeEventListener("error",this.onWorkerError),H0(this.hls.config.workerPath)}},d.destroy=function(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{var s=this.transmuxer;s&&(s.destroy(),this.transmuxer=null)}var t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null},d.push=function(s,t,i,a,h,g,m,p,E,x){var I,R,_=this;E.transmuxing.start=self.performance.now();var P=this.instanceNo,O=this.transmuxer,N=g?g.start:h.start,U=h.decryptdata,B=this.frag,G=!(B&&h.cc===B.cc),Y=!(B&&E.level===B.level),V=B?E.sn-B.sn:-1,j=this.part?E.part-this.part.index:-1,ae=V===0&&E.id>1&&E.id===(B==null?void 0:B.stats.chunkCount),X=!Y&&(V===1||V===0&&(j===1||ae&&j<=0)),W=self.performance.now();(Y||V||h.stats.parsing.start===0)&&(h.stats.parsing.start=W),g&&(j||!X)&&(g.stats.parsing.start=W);var J=!(B&&((I=h.initSegment)==null?void 0:I.url)===((R=B.initSegment)==null?void 0:R.url)),oe=new N0(G,X,p,Y,N,J);if(!X||G||J){this.hls.logger.log("[transmuxer-interface]: Starting new transmux session for "+h.type+" sn: "+E.sn+(E.part>-1?" part: "+E.part:"")+" "+(this.id===pe.MAIN?"level":"track")+": "+E.level+" id: "+E.id+`
        discontinuity: `+G+`
        trackSwitch: `+Y+`
        contiguous: `+X+`
        accurateTimeOffset: `+p+`
        timeOffset: `+N+`
        initSegmentChange: `+J);var ge=new F0(i,a,t,m,x);this.configureTransmuxer(ge)}if(this.frag=h,this.part=g,this.workerContext)this.workerContext.worker.postMessage({instanceNo:P,cmd:"demux",data:s,decryptdata:U,chunkMeta:E,state:oe},s instanceof ArrayBuffer?[s]:[]);else if(O){var ce=O.push(s,U,E,oe);zr(ce)?ce.then(function(he){_.handleTransmuxComplete(he)}).catch(function(he){_.transmuxerError(he,E,"transmuxer-interface push error")}):this.handleTransmuxComplete(ce)}},d.flush=function(s){var t=this;s.transmuxing.start=self.performance.now();var i=this.instanceNo,a=this.transmuxer;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:i,cmd:"flush",chunkMeta:s});else if(a){var h=a.flush(s);zr(h)?h.then(function(g){t.handleFlushResult(g,s)}).catch(function(g){t.transmuxerError(g,s,"transmuxer-interface flush error")}):this.handleFlushResult(h,s)}},d.transmuxerError=function(s,t,i){this.hls&&(this.error=s,this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:s,err:s,reason:i}))},d.handleFlushResult=function(s,t){var i=this;s.forEach(function(a){i.handleTransmuxComplete(a)}),this.onFlush(t)},d.configureTransmuxer=function(s){var t=this.instanceNo,i=this.transmuxer;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:s}):i&&i.configure(s)},d.handleTransmuxComplete=function(s){s.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(s)},u}(),Vu=100,Y0=function(u){function d(s,t,i){var a;return a=u.call(this,s,t,i,"audio-stream-controller",pe.AUDIO)||this,a.mainAnchor=null,a.mainFragLoading=null,a.audioOnly=!1,a.bufferedTrack=null,a.switchingTrack=null,a.trackId=-1,a.waitingData=null,a.mainDetails=null,a.flushing=!1,a.bufferFlushed=!1,a.cachedTrackLoadedData=null,a.registerListeners(),a}b(d,u);var o=d.prototype;return o.onHandlerDestroying=function(){this.unregisterListeners(),u.prototype.onHandlerDestroying.call(this),this.resetItem()},o.resetItem=function(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null},o.registerListeners=function(){u.prototype.registerListeners.call(this);var t=this.hls;t.on(k.LEVEL_LOADED,this.onLevelLoaded,this),t.on(k.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(k.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(k.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(k.BUFFER_RESET,this.onBufferReset,this),t.on(k.BUFFER_CREATED,this.onBufferCreated,this),t.on(k.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(k.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(k.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(k.FRAG_LOADING,this.onFragLoading,this),t.on(k.FRAG_BUFFERED,this.onFragBuffered,this)},o.unregisterListeners=function(){var t=this.hls;t&&(u.prototype.unregisterListeners.call(this),t.off(k.LEVEL_LOADED,this.onLevelLoaded,this),t.off(k.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(k.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(k.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(k.BUFFER_RESET,this.onBufferReset,this),t.off(k.BUFFER_CREATED,this.onBufferCreated,this),t.off(k.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(k.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(k.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(k.FRAG_LOADING,this.onFragLoading,this),t.off(k.FRAG_BUFFERED,this.onFragBuffered,this))},o.onInitPtsFound=function(t,i){var a=i.frag,h=i.id,g=i.initPTS,m=i.timescale;if(h===pe.MAIN){var p=a.cc,E=this.fragCurrent;if(this.initPTS[p]={baseTime:g,timescale:m},this.log("InitPTS for cc: "+p+" found from main: "+g+"/"+m),this.mainAnchor=a,this.state===fe.WAITING_INIT_PTS){var x=this.waitingData;(!x&&!this.loadingParts||x&&x.frag.cc!==p)&&(this.nextLoadPosition=this.findSyncFrag(a).start),this.tick()}else!this.hls.hasEnoughToStart&&E&&E.cc!==p?(this.startFragRequested=!1,this.nextLoadPosition=this.findSyncFrag(a).start,E.abortRequests(),this.resetLoadingState()):this.state===fe.IDLE&&this.tick()}},o.findSyncFrag=function(t){var i=this.getLevelDetails(),a=t.cc;return ag(i,a,t)||i&&kl(i.fragments,a)||t},o.startLoad=function(t,i){if(!this.levels){this.startPosition=t,this.state=fe.STOPPED;return}var a=this.lastCurrentTime;this.stopLoad(),this.setInterval(Vu),a>0&&t===-1?(this.log("Override startPosition with lastCurrentTime @"+a.toFixed(3)),t=a,this.state=fe.IDLE):this.state=fe.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=i?-1:t,this.tick()},o.doTick=function(){switch(this.state){case fe.IDLE:this.doTickIdle();break;case fe.WAITING_TRACK:{var t=this.levels,i=this.trackId,a=t==null?void 0:t[i],h=a==null?void 0:a.details;if(h&&!this.waitForLive(a)){if(this.waitForCdnTuneIn(h))break;this.state=fe.WAITING_INIT_PTS}break}case fe.FRAG_LOADING_WAITING_RETRY:{var g,m=performance.now(),p=this.retryDate;if(!p||m>=p||(g=this.media)!=null&&g.seeking){var E=this.levels,x=this.trackId;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((E==null?void 0:E[x])||null),this.state=fe.IDLE}break}case fe.WAITING_INIT_PTS:{var I=this.waitingData;if(I){var R=I.frag,_=I.part,P=I.cache,O=I.complete,N=this.mainAnchor;if(this.initPTS[R.cc]!==void 0){this.waitingData=null,this.state=fe.FRAG_LOADING;var U=P.flush().buffer,B={frag:R,part:_,payload:U,networkDetails:null};this._handleFragmentLoadProgress(B),O&&u.prototype._handleFragmentLoadComplete.call(this,B)}else N&&N.cc!==I.frag.cc&&(this.log("Waiting fragment cc ("+R.cc+") cancelled because video is at cc "+N.cc),this.nextLoadPosition=this.findSyncFrag(N).start,this.clearWaitingFragment())}else this.state=fe.IDLE}}this.onTickEnd()},o.clearWaitingFragment=function(){var t=this.waitingData;t&&(this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.state!==fe.STOPPED&&(this.state=fe.IDLE))},o.resetLoadingState=function(){this.clearWaitingFragment(),u.prototype.resetLoadingState.call(this)},o.onTickEnd=function(){var t=this.media;t!=null&&t.readyState&&(this.lastCurrentTime=t.currentTime)},o.doTickIdle=function(){var t,i=this.hls,a=this.levels,h=this.media,g=this.trackId,m=i.config;if(!(!this.buffering||!h&&!this.primaryPrefetch&&(this.startFragRequested||!m.startFragPrefetch)||!(a!=null&&a[g]))){var p=a[g],E=p.details;if(!E||this.waitForLive(p)||this.waitForCdnTuneIn(E)){this.state=fe.WAITING_TRACK,this.startFragRequested=!1;return}var x=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&x&&(this.bufferFlushed=!1,this.afterBufferFlushed(x,Ve.AUDIO,pe.AUDIO));var I=this.getFwdBufferInfo(x,pe.AUDIO);if(I!==null){if(!this.switchingTrack&&this._streamEnded(I,E)){i.trigger(k.BUFFER_EOS,{type:"audio"}),this.state=fe.ENDED;return}var R=I.len,_=i.maxBufferLength,P=E.fragments,O=P[0].start,N=this.getLoadPosition(),U=this.flushing?N:I.end;if(this.switchingTrack&&h){var B=N;E.PTSKnown&&B<O&&(I.end>O||I.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),h.currentTime=O+.05)}if(!(R>=_&&!this.switchingTrack&&U<P[P.length-1].start)){var G=this.getNextFragment(U,E);if(G&&this.isLoopLoading(G,U)&&(G=this.getNextFragmentLoopLoading(G,E,I,pe.MAIN,_)),!G){this.bufferFlushed=!0;return}var Y=((t=this.mainFragLoading)==null?void 0:t.frag)||null;if(!this.audioOnly&&this.startFragRequested&&Y&&ct(G)&&!G.endList&&(!E.live||!this.loadingParts&&U<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(Y)===xt.OK&&(this.mainFragLoading=Y=null),Y&&ct(Y))){if(G.start>Y.end){var V=this.fragmentTracker.getFragAtPos(U,pe.MAIN);V&&V.end>Y.end&&(Y=V,this.mainFragLoading={frag:V,targetBufferTime:null})}var j=G.start>Y.end;if(j)return}this.loadFragment(G,p,U)}}}},o.onMediaDetaching=function(t,i){this.bufferFlushed=this.flushing=!1,u.prototype.onMediaDetaching.call(this,t,i)},o.onAudioTracksUpdated=function(t,i){var a=i.audioTracks;this.resetTransmuxer(),this.levels=a.map(function(h){return new Mi(h)})},o.onAudioTrackSwitching=function(t,i){var a=!!i.url;this.trackId=i.id;var h=this.fragCurrent;h&&(h.abortRequests(),this.removeUnbufferedFrags(h.start)),this.resetLoadingState(),a?(this.switchingTrack=i,this.flushAudioIfNeeded(i),this.state!==fe.STOPPED&&(this.setInterval(Vu),this.state=fe.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=i,this.clearInterval())},o.onManifestLoading=function(){u.prototype.onManifestLoading.call(this),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1},o.onLevelLoaded=function(t,i){this.mainDetails=i.details;var a=this.cachedTrackLoadedData;a&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(k.AUDIO_TRACK_LOADED,a))},o.onAudioTrackLoaded=function(t,i){var a,h=this.levels,g=i.details,m=i.id,p=i.groupId,E=i.track;if(!h){this.warn("Audio tracks reset while loading track "+m+' "'+E.name+'" of "'+p+'"');return}var x=this.mainDetails;if(!x||g.endCC>x.endCC||x.expired){this.cachedTrackLoadedData=i,this.state!==fe.STOPPED&&(this.state=fe.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log("Audio track "+m+' "'+E.name+'" of "'+p+'" loaded ['+g.startSN+","+g.endSN+"]"+(g.lastPartSn?"[part-"+g.lastPartSn+"-"+g.lastPartIndex+"]":"")+",duration:"+g.totalduration);var I=h[m],R=0;if(g.live||(a=I.details)!=null&&a.live){if(this.checkLiveUpdate(g),g.deltaUpdateFailed)return;if(I.details){var _;R=this.alignPlaylists(g,I.details,(_=this.levelLastLoaded)==null?void 0:_.details)}g.alignedSliding||(du(g,x),g.alignedSliding||bs(g,x),R=g.fragmentStart)}I.details=g,this.levelLastLoaded=I,this.startFragRequested||this.setStartPosition(x,R),this.hls.trigger(k.AUDIO_TRACK_UPDATED,{details:g,id:m,groupId:i.groupId}),this.state===fe.WAITING_TRACK&&!this.waitForCdnTuneIn(g)&&(this.state=fe.IDLE),this.tick()},o._handleFragmentLoadProgress=function(t){var i,a=t.frag,h=t.part,g=t.payload,m=this.config,p=this.trackId,E=this.levels;if(!E){this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+a.sn+" of level "+a.level+" will not be buffered");return}var x=E[p];if(!x){this.warn("Audio track is undefined on fragment load progress");return}var I=x.details;if(!I){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(a.start);return}var R=m.defaultAudioCodec||x.audioCodec||"mp4a.40.2",_=this.transmuxer;_||(_=this.transmuxer=new Ku(this.hls,pe.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var P=this.initPTS[a.cc],O=(i=a.initSegment)==null?void 0:i.data;if(P!==void 0){var N=!1,U=h?h.index:-1,B=U!==-1,G=new Yn(a.level,a.sn,a.stats.chunkCount,g.byteLength,U,B);_.push(g,O,R,"",a,h,I.totalduration,N,G,P)}else{this.log("Unknown video PTS for cc "+a.cc+", waiting for video PTS before demuxing audio frag "+a.sn+" of ["+I.startSN+" ,"+I.endSN+"],track "+p);var Y=this.waitingData=this.waitingData||{frag:a,part:h,cache:new gu,complete:!1},V=Y.cache;V.push(new Uint8Array(g)),this.state!==fe.STOPPED&&(this.state=fe.WAITING_INIT_PTS)}},o._handleFragmentLoadComplete=function(t){if(this.waitingData){this.waitingData.complete=!0;return}u.prototype._handleFragmentLoadComplete.call(this,t)},o.onBufferReset=function(){this.mediaBuffer=null},o.onBufferCreated=function(t,i){this.bufferFlushed=this.flushing=!1;var a=i.tracks.audio;a&&(this.mediaBuffer=a.buffer||null)},o.onFragLoading=function(t,i){!this.audioOnly&&i.frag.type===pe.MAIN&&ct(i.frag)&&(this.mainFragLoading=i,this.state===fe.IDLE&&this.tick())},o.onFragBuffered=function(t,i){var a=i.frag,h=i.part;if(a.type!==pe.AUDIO){!this.audioOnly&&a.type===pe.MAIN&&!a.elementaryStreams.video&&!a.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(a)){this.warn("Fragment "+a.sn+(h?" p: "+h.index:"")+" of level "+a.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+(this.switchingTrack?this.switchingTrack.name:"false"));return}if(ct(a)){this.fragPrevious=a;var g=this.switchingTrack;g&&(this.bufferedTrack=g,this.switchingTrack=null,this.hls.trigger(k.AUDIO_TRACK_SWITCHED,F({},g)))}this.fragBufferedComplete(a,h),this.media&&this.tick()},o.onError=function(t,i){var a;if(i.fatal){this.state=fe.ERROR;return}switch(i.details){case q.FRAG_GAP:case q.FRAG_PARSING_ERROR:case q.FRAG_DECRYPT_ERROR:case q.FRAG_LOAD_ERROR:case q.FRAG_LOAD_TIMEOUT:case q.KEY_LOAD_ERROR:case q.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(pe.AUDIO,i);break;case q.AUDIO_TRACK_LOAD_ERROR:case q.AUDIO_TRACK_LOAD_TIMEOUT:case q.LEVEL_PARSING_ERROR:!i.levelRetry&&this.state===fe.WAITING_TRACK&&((a=i.context)==null?void 0:a.type)===Te.AUDIO_TRACK&&(this.state=fe.IDLE);break;case q.BUFFER_ADD_CODEC_ERROR:case q.BUFFER_APPEND_ERROR:if(i.parent!=="audio")return;this.resetLoadingState();break;case q.BUFFER_FULL_ERROR:if(i.parent!=="audio")return;this.reduceLengthAndFlushBuffer(i)&&(this.bufferedTrack=null,u.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio"));break;case q.INTERNAL_EXCEPTION:this.recoverWorkerError(i);break}},o.onBufferFlushing=function(t,i){var a=i.type;a!==Ve.VIDEO&&(this.flushing=!0)},o.onBufferFlushed=function(t,i){var a=i.type;if(a!==Ve.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===fe.ENDED&&(this.state=fe.IDLE);var h=this.mediaBuffer||this.media;h&&(this.afterBufferFlushed(h,a,pe.AUDIO),this.tick())}},o._handleTransmuxComplete=function(t){var i,a="audio",h=this.hls,g=t.remuxResult,m=t.chunkMeta,p=this.getCurrentContext(m);if(!p){this.resetWhenMissingContext(m);return}var E=p.frag,x=p.part,I=p.level,R=I.details,_=g.audio,P=g.text,O=g.id3,N=g.initSegment;if(this.fragContextChanged(E)||!R){this.fragmentTracker.removeFragment(E);return}if(this.state=fe.PARSING,this.switchingTrack&&_&&this.completeAudioSwitch(this.switchingTrack),N!=null&&N.tracks){var U=E.initSegment||E;this._bufferInitSegment(I,N.tracks,U,m),h.trigger(k.FRAG_PARSING_INIT_SEGMENT,{frag:U,id:a,tracks:N.tracks})}if(_){var B=_.startPTS,G=_.endPTS,Y=_.startDTS,V=_.endDTS;x&&(x.elementaryStreams[Ve.AUDIO]={startPTS:B,endPTS:G,startDTS:Y,endDTS:V}),E.setElementaryStreamInfo(Ve.AUDIO,B,G,Y,V),this.bufferFragmentData(_,E,x,m)}if(O!=null&&(i=O.samples)!=null&&i.length){var j=A({id:a,frag:E,details:R},O);h.trigger(k.FRAG_PARSING_METADATA,j)}if(P){var ae=A({id:a,frag:E,details:R},P);h.trigger(k.FRAG_PARSING_USERDATA,ae)}},o._bufferInitSegment=function(t,i,a,h){if(this.state===fe.PARSING&&(i.video&&delete i.video,i.audiovideo&&delete i.audiovideo,!!i.audio)){var g=i.audio;g.id=pe.AUDIO;var m=t.audioCodec;this.log("Init audio buffer, container:"+g.container+", codecs[level/parsed]=["+m+"/"+g.codec+"]"),m&&m.split(",").length===1&&(g.levelCodec=m),this.hls.trigger(k.BUFFER_CODECS,i);var p=g.initSegment;if(p!=null&&p.byteLength){var E={type:"audio",frag:a,part:null,chunkMeta:h,parent:a.type,data:p};this.hls.trigger(k.BUFFER_APPENDING,E)}this.tickImmediate()}},o.loadFragment=function(t,i,a){var h=this.fragmentTracker.getState(t);if(this.switchingTrack||h===xt.NOT_LOADED||h===xt.PARTIAL){var g;if(!ct(t))this._loadInitSegment(t,i);else if((g=i.details)!=null&&g.live&&!this.initPTS[t.cc]){this.log("Waiting for video PTS in continuity counter "+t.cc+" of live stream before loading audio fragment "+t.sn+" of level "+this.trackId),this.state=fe.WAITING_INIT_PTS;var m=this.mainDetails;m&&m.fragmentStart!==i.details.fragmentStart&&bs(i.details,m)}else u.prototype.loadFragment.call(this,t,i,a)}else this.clearTrackerIfNeeded(t)},o.flushAudioIfNeeded=function(t){if(this.media&&this.bufferedTrack){var i=this.bufferedTrack,a=i.name,h=i.lang,g=i.assocLang,m=i.characteristics,p=i.audioCodec,E=i.channels;qr({name:a,lang:h,assocLang:g,characteristics:m,audioCodec:p,channels:E},t,jr)||(ys(t.url,this.hls)?(this.log("Switching audio track : flushing all audio"),u.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=t)}},o.completeAudioSwitch=function(t){var i=this.hls;this.flushAudioIfNeeded(t),this.bufferedTrack=t,this.switchingTrack=null,i.trigger(k.AUDIO_TRACK_SWITCHED,F({},t))},d}(sa),Ta=function(u){function d(s,t){var i;return i=u.call(this,t,s.logger)||this,i.hls=void 0,i.canLoad=!1,i.timer=-1,i.hls=s,i}b(d,u);var o=d.prototype;return o.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},o.clearTimer=function(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)},o.startLoad=function(){this.canLoad=!0,this.loadPlaylist()},o.stopLoad=function(){this.canLoad=!1,this.clearTimer()},o.switchParams=function(t,i,a){var h=i==null?void 0:i.renditionReports;if(h){for(var g=-1,m=0;m<h.length;m++){var p=h[m],E=void 0;try{E=new self.URL(p.URI,i.url).href}catch(O){this.warn("Could not construct new URL for Rendition Report: "+O),E=p.URI||""}if(E===t){g=m;break}else E===t.substring(0,E.length)&&(g=m)}if(g!==-1){var x=h[g],I=parseInt(x["LAST-MSN"])||(i==null?void 0:i.lastPartSn),R=parseInt(x["LAST-PART"])||(i==null?void 0:i.lastPartIndex);if(this.hls.config.lowLatencyMode){var _=Math.min(i.age-i.partTarget,i.targetduration);R>=0&&_>i.partTarget&&(R+=1)}var P=a&&Il(a);return new Rl(I,R>=0?R:void 0,P)}}},o.loadPlaylist=function(t){this.clearTimer()},o.loadingPlaylist=function(t,i){this.clearTimer()},o.shouldLoadPlaylist=function(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)},o.getUrlWithDirectives=function(t,i){if(i)try{return i.addDirectives(t)}catch(a){this.warn("Could not construct new URL with HLS Delivery Directives: "+a)}return t},o.playlistLoaded=function(t,i,a){var h=i.details,g=i.stats,m=self.performance.now(),p=g.loading.first?Math.max(0,m-g.loading.first):0;h.advancedDateTime=Date.now()-p;var E=this.hls.config.timelineOffset;if(E!==h.appliedTimelineOffset){var x=Math.max(E||0,0);h.appliedTimelineOffset=x,h.fragments.forEach(function(Ie){Ie.start=Ie.playlistOffset+x})}if(h.live||a!=null&&a.live){var I="levelInfo"in i?i.levelInfo:i.track;if(h.reloaded(a),a&&h.fragments.length>0){Mg(a,h);var R=h.playlistParsingError;if(R){this.warn(R);var _=this.hls;if(!_.config.ignorePlaylistParsingErrors){var P,O=i.networkDetails;_.trigger(k.ERROR,{type:se.NETWORK_ERROR,details:q.LEVEL_PARSING_ERROR,fatal:!1,url:h.url,error:R,reason:R.message,level:i.level||void 0,parent:(P=h.fragments[0])==null?void 0:P.type,networkDetails:O,stats:g});return}h.playlistParsingError=null}}h.requestScheduled===-1&&(h.requestScheduled=g.loading.start);var N=this.hls.mainForwardBufferInfo,U=N?N.end-N.len:0,B=(h.edge-U)*1e3,G=au(h,B);if(h.requestScheduled+G<m?h.requestScheduled=m:h.requestScheduled+=G,this.log("live playlist "+t+" "+(h.advanced?"REFRESHED "+h.lastPartSn+"-"+h.lastPartIndex:h.updated?"UPDATED":"MISSED")),!this.canLoad||!h.live)return;var Y,V=void 0,j=void 0;if(h.canBlockReload&&h.endSN&&h.advanced){var ae=this.hls.config.lowLatencyMode,X=h.lastPartSn,W=h.endSN,J=h.lastPartIndex,oe=J!==-1,ge=X===W;oe?ge?(V=W+1,j=ae?0:J):(V=X,j=ae?J+1:h.maxPartIndex):V=W+1;var ce=h.age,he=ce+h.ageHeader,ye=Math.min(he-h.partTarget,h.targetduration*1.5);if(ye>0){if(he>h.targetduration*3)this.log("Playlist last advanced "+ce.toFixed(2)+"s ago. Omitting segment and part directives."),V=void 0,j=void 0;else if(a!=null&&a.tuneInGoal&&he-h.partTarget>a.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+a.tuneInGoal+" to: "+ye+" with playlist age: "+h.age),ye=0;else{var Se=Math.floor(ye/h.targetduration);if(V+=Se,j!==void 0){var Le=Math.round(ye%h.targetduration/h.partTarget);j+=Le}this.log("CDN Tune-in age: "+h.ageHeader+"s last advanced "+ce.toFixed(2)+"s goal: "+ye+" skip sn "+Se+" to part "+j)}h.tuneInGoal=ye}if(Y=this.getDeliveryDirectives(h,i.deliveryDirectives,V,j),ae||!ge){h.requestScheduled=m,this.loadingPlaylist(I,Y);return}}else(h.canBlockReload||h.canSkipUntil)&&(Y=this.getDeliveryDirectives(h,i.deliveryDirectives,V,j));Y&&V!==void 0&&h.canBlockReload&&(h.requestScheduled=g.loading.first+Math.max(G-p*2,G/2)),this.scheduleLoading(I,Y,h)}else this.clearTimer()},o.scheduleLoading=function(t,i,a){var h=this,g=a||t.details;if(!g){this.loadingPlaylist(t,i);return}var m=self.performance.now(),p=g.requestScheduled;if(m>=p){this.loadingPlaylist(t,i);return}var E=p-m;this.log("reload live playlist "+(t.name||t.bitrate+"bps")+" in "+Math.round(E)+" ms"),this.clearTimer(),this.timer=self.setTimeout(function(){return h.loadingPlaylist(t,i)},E)},o.getDeliveryDirectives=function(t,i,a,h){var g=Il(t);return i!=null&&i.skip&&t.deltaUpdateFailed&&(a=i.msn,h=i.part,g=ps.No),new Rl(a,h,g)},o.checkRetry=function(t){var i=this,a=t.details,h=Es(t),g=t.errorAction,m=g||{},p=m.action,E=m.retryCount,x=E===void 0?0:E,I=m.retryConfig,R=!!g&&!!I&&(p===Ot.RetryRequest||!g.resolved&&p===Ot.SendAlternateToPenaltyBox);if(R){var _;if(x>=I.maxNumRetry)return!1;if(h&&(_=t.context)!=null&&_.deliveryDirectives)this.warn("Retrying playlist loading "+(x+1)+"/"+I.maxNumRetry+' after "'+a+'" without delivery-directives'),this.loadPlaylist();else{var P=Vn(I,x);this.clearTimer(),this.timer=self.setTimeout(function(){return i.loadPlaylist()},P),this.warn("Retrying playlist loading "+(x+1)+"/"+I.maxNumRetry+' after "'+a+'" in '+P+"ms")}t.levelRetry=!0,g.resolved=!0}return R},d}(st);function Hu(u,d){if(u.length!==d.length)return!1;for(var o=0;o<u.length;o++)if(!Vi(u[o].attrs,d[o].attrs))return!1;return!0}function Vi(u,d,o){var s=u["STABLE-RENDITION-ID"];return s&&!o?s===d["STABLE-RENDITION-ID"]:!(o||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(function(t){return u[t]!==d[t]})}function Sa(u,d){return d.label.toLowerCase()===u.name.toLowerCase()&&(!d.language||d.language.toLowerCase()===(u.lang||"").toLowerCase())}var W0=function(u){function d(s){var t;return t=u.call(this,s,"audio-track-controller")||this,t.tracks=[],t.groupIds=null,t.tracksInGroup=[],t.trackId=-1,t.currentTrack=null,t.selectDefaultTrack=!0,t.registerListeners(),t}b(d,u);var o=d.prototype;return o.registerListeners=function(){var t=this.hls;t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.MANIFEST_PARSED,this.onManifestParsed,this),t.on(k.LEVEL_LOADING,this.onLevelLoading,this),t.on(k.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(k.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(k.ERROR,this.onError,this)},o.unregisterListeners=function(){var t=this.hls;t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.MANIFEST_PARSED,this.onManifestParsed,this),t.off(k.LEVEL_LOADING,this.onLevelLoading,this),t.off(k.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(k.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(k.ERROR,this.onError,this)},o.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,u.prototype.destroy.call(this)},o.onManifestLoading=function(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0},o.onManifestParsed=function(t,i){this.tracks=i.audioTracks||[]},o.onAudioTrackLoaded=function(t,i){var a=i.id,h=i.groupId,g=i.details,m=this.tracksInGroup[a];if(!m||m.groupId!==h){this.warn("Audio track with id:"+a+" and group:"+h+" not found in active group "+(m==null?void 0:m.groupId));return}var p=m.details;m.details=i.details,this.log("Audio track "+a+' "'+m.name+'" lang:'+m.lang+" group:"+h+" loaded ["+g.startSN+"-"+g.endSN+"]"),a===this.trackId&&this.playlistLoaded(a,i,p)},o.onLevelLoading=function(t,i){this.switchLevel(i.level)},o.onLevelSwitching=function(t,i){this.switchLevel(i.level)},o.switchLevel=function(t){var i=this.hls.levels[t];if(i){var a=i.audioGroups||null,h=this.groupIds,g=this.currentTrack;if(!a||(h==null?void 0:h.length)!==(a==null?void 0:a.length)||a!=null&&a.some(function(N){return(h==null?void 0:h.indexOf(N))===-1})){this.groupIds=a,this.trackId=-1,this.currentTrack=null;var m=this.tracks.filter(function(N){return!a||a.indexOf(N.groupId)!==-1});if(m.length)this.selectDefaultTrack&&!m.some(function(N){return N.default})&&(this.selectDefaultTrack=!1),m.forEach(function(N,U){N.id=U});else if(!g&&!this.tracksInGroup.length)return;this.tracksInGroup=m;var p=this.hls.config.audioPreference;if(!g&&p){var E=or(p,m,jr);if(E>-1)g=m[E];else{var x=or(p,this.tracks);g=this.tracks[x]}}var I=this.findTrackId(g);I===-1&&g&&(I=this.findTrackId(null));var R={audioTracks:m};this.log("Updating audio tracks, "+m.length+" track(s) found in group(s): "+(a==null?void 0:a.join(","))),this.hls.trigger(k.AUDIO_TRACKS_UPDATED,R);var _=this.trackId;if(I!==-1&&_===-1)this.setAudioTrack(I);else if(m.length&&_===-1){var P,O=new Error("No audio track selected for current audio group-ID(s): "+((P=this.groupIds)==null?void 0:P.join(","))+" track count: "+m.length);this.warn(O.message),this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:O})}}}},o.onError=function(t,i){i.fatal||!i.context||i.context.type===Te.AUDIO_TRACK&&i.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(i.context.groupId)!==-1)&&this.checkRetry(i)},o.setAudioOption=function(t){var i=this.hls;if(i.config.audioPreference=t,t){var a=this.allAudioTracks;if(this.selectDefaultTrack=!1,a.length){var h=this.currentTrack;if(h&&qr(t,h,jr))return h;var g=or(t,this.tracksInGroup,jr);if(g>-1){var m=this.tracksInGroup[g];return this.setAudioTrack(g),m}else if(h){var p=i.loadLevel;p===-1&&(p=i.firstAutoLevel);var E=tg(t,i.levels,a,p,jr);if(E===-1)return null;i.nextLoadLevel=E}if(t.channels||t.audioCodec){var x=or(t,a);if(x>-1)return a[x]}}}return null},o.setAudioTrack=function(t){var i=this.tracksInGroup;if(t<0||t>=i.length){this.warn("Invalid audio track id: "+t);return}this.selectDefaultTrack=!1;var a=this.currentTrack,h=i[t],g=h.details&&!h.details.live;if(!(t===this.trackId&&h===a&&g)&&(this.log("Switching to audio-track "+t+' "'+h.name+'" lang:'+h.lang+" group:"+h.groupId+" channels:"+h.channels),this.trackId=t,this.currentTrack=h,this.hls.trigger(k.AUDIO_TRACK_SWITCHING,F({},h)),!g)){var m=this.switchParams(h.url,a==null?void 0:a.details,h.details);this.loadPlaylist(m)}},o.findTrackId=function(t){for(var i=this.tracksInGroup,a=0;a<i.length;a++){var h=i[a];if(!(this.selectDefaultTrack&&!h.default)&&(!t||qr(t,h,jr)))return a}if(t){for(var g=t.name,m=t.lang,p=t.assocLang,E=t.characteristics,x=t.audioCodec,I=t.channels,R=0;R<i.length;R++){var _=i[R];if(qr({name:g,lang:m,assocLang:p,characteristics:E,audioCodec:x,channels:I},_,jr))return R}for(var P=0;P<i.length;P++){var O=i[P];if(Vi(t.attrs,O.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return P}for(var N=0;N<i.length;N++){var U=i[N];if(Vi(t.attrs,U.attrs,["LANGUAGE"]))return N}}return-1},o.loadPlaylist=function(t){u.prototype.loadPlaylist.call(this);var i=this.currentTrack;this.shouldLoadPlaylist(i)&&ys(i.url,this.hls)&&this.scheduleLoading(i,t)},o.loadingPlaylist=function(t,i){u.prototype.loadingPlaylist.call(this,t,i);var a=t.id,h=t.groupId,g=this.getUrlWithDirectives(t.url,i),m=t.details,p=m==null?void 0:m.age;this.log("Loading audio-track "+a+' "'+t.name+'" lang:'+t.lang+" group:"+h+((i==null?void 0:i.msn)!==void 0?" at sn "+i.msn+" part "+i.part:"")+(p&&m.live?" age "+p.toFixed(1)+(m.type&&" "+m.type||""):"")+" "+g),this.hls.trigger(k.AUDIO_TRACK_LOADING,{url:g,id:a,groupId:h,deliveryDirectives:i||null,track:t})},y(d,[{key:"allAudioTracks",get:function(){return this.tracks}},{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}}])}(Ta),q0=function(){function u(o){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=o}var d=u.prototype;return d.destroy=function(){this.tracks=this.queues=null},d.append=function(s,t,i){if(!(this.queues===null||this.tracks===null)){var a=this.queues[t];a.push(s),a.length===1&&!i&&this.executeNext(t)}},d.appendBlocker=function(s){var t=this;return new Promise(function(i){var a={label:"async-blocker",execute:i,onStart:function(){},onComplete:function(){},onError:function(){}};t.append(a,s)})},d.prependBlocker=function(s){var t=this;return new Promise(function(i){if(t.queues){var a={label:"async-blocker-prepend",execute:i,onStart:function(){},onComplete:function(){},onError:function(){}};t.queues[s].unshift(a)}})},d.removeBlockers=function(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(function(s){var t,i=(t=s[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(s[0].execute(),s.splice(0,1))})},d.unblockAudio=function(s){if(this.queues!==null){var t=this.queues.audio;t[0]===s&&this.shiftAndExecuteNext("audio")}},d.executeNext=function(s){if(!(this.queues===null||this.tracks===null)){var t=this.queues[s];if(t.length){var i=t[0];try{i.execute()}catch(g){var a;if(i.onError(g),this.queues===null||this.tracks===null)return;var h=(a=this.tracks[s])==null?void 0:a.buffer;h!=null&&h.updating||this.shiftAndExecuteNext(s)}}}},d.shiftAndExecuteNext=function(s){this.queues!==null&&(this.queues[s].shift(),this.executeNext(s))},d.current=function(s){var t;return((t=this.queues)==null?void 0:t[s][0])||null},d.toString=function(){var s=this.queues,t=this.tracks;return s===null||t===null?"<destroyed>":`
`+this.list("video")+`
`+this.list("audio")+`
`+this.list("audiovideo")+"}"},d.list=function(s){var t,i;return(t=this.queues)!=null&&t[s]||(i=this.tracks)!=null&&i[s]?s+": ("+this.listSbInfo(s)+") "+this.listOps(s):""},d.listSbInfo=function(s){var t,i=(t=this.tracks)==null?void 0:t[s],a=i==null?void 0:i.buffer;return a?"SourceBuffer"+(a.updating?" updating":"")+(i.ended?" ended":"")+(i.ending?" ending":""):"none"},d.listOps=function(s){var t;return((t=this.queues)==null?void 0:t[s].map(function(i){return i.label}).join(", "))||""},u}(),Yu=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Wu="HlsJsTrackRemovedError",j0=function(u){function d(o){var s;return s=u.call(this,o)||this,s.name=Wu,s}return b(d,u),d}(Q(Error)),X0=function(u){function d(s,t){var i;return i=u.call(this,"buffer-controller",s.logger)||this,i.hls=void 0,i.fragmentTracker=void 0,i.details=null,i._objectUrl=null,i.operationQueue=null,i.bufferCodecEventsTotal=0,i.media=null,i.mediaSource=null,i.lastMpegAudioChunk=null,i.blockedAudioAppend=null,i.lastVideoAppendEnd=0,i.appendSource=void 0,i.transferData=void 0,i.overrides=void 0,i.appendErrors={audio:0,video:0,audiovideo:0},i.tracks={},i.sourceBuffers=[[null,null],[null,null]],i._onEndStreaming=function(a){var h;i.hls&&((h=i.mediaSource)==null?void 0:h.readyState)==="open"&&i.hls.pauseBuffering()},i._onStartStreaming=function(a){i.hls&&i.hls.resumeBuffering()},i._onMediaSourceOpen=function(a){var h=i,g=h.media,m=h.mediaSource;a&&i.log("Media source opened"),!(!g||!m)&&(m.removeEventListener("sourceopen",i._onMediaSourceOpen),g.removeEventListener("emptied",i._onMediaEmptied),i.updateDuration(),i.hls.trigger(k.MEDIA_ATTACHED,{media:g,mediaSource:m}),i.mediaSource!==null&&i.checkPendingTracks())},i._onMediaSourceClose=function(){i.log("Media source closed")},i._onMediaSourceEnded=function(){i.log("Media source ended")},i._onMediaEmptied=function(){var a=i,h=a.mediaSrc,g=a._objectUrl;h!==g&&i.error("Media element src was set while attaching MediaSource ("+g+" > "+h+")")},i.hls=s,i.fragmentTracker=t,i.appendSource=bt(Ue(s.config.preferManagedMediaSource)),i.initTracks(),i.registerListeners(),i}b(d,u);var o=d.prototype;return o.hasSourceTypes=function(){return Object.keys(this.tracks).length>0},o.destroy=function(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null},o.registerListeners=function(){var t=this.hls;t.on(k.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.MANIFEST_PARSED,this.onManifestParsed,this),t.on(k.BUFFER_RESET,this.onBufferReset,this),t.on(k.BUFFER_APPENDING,this.onBufferAppending,this),t.on(k.BUFFER_CODECS,this.onBufferCodecs,this),t.on(k.BUFFER_EOS,this.onBufferEos,this),t.on(k.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(k.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(k.FRAG_PARSED,this.onFragParsed,this),t.on(k.FRAG_CHANGED,this.onFragChanged,this),t.on(k.ERROR,this.onError,this)},o.unregisterListeners=function(){var t=this.hls;t.off(k.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.MANIFEST_PARSED,this.onManifestParsed,this),t.off(k.BUFFER_RESET,this.onBufferReset,this),t.off(k.BUFFER_APPENDING,this.onBufferAppending,this),t.off(k.BUFFER_CODECS,this.onBufferCodecs,this),t.off(k.BUFFER_EOS,this.onBufferEos,this),t.off(k.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(k.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(k.FRAG_PARSED,this.onFragParsed,this),t.off(k.FRAG_CHANGED,this.onFragChanged,this),t.off(k.ERROR,this.onError,this)},o.transferMedia=function(){var t=this,i=this.media,a=this.mediaSource;if(!i)return null;var h={};if(this.operationQueue){var g=this.isUpdating();g||this.operationQueue.removeBlockers();var m=this.isQueued();(g||m)&&this.warn("Transfering MediaSource with"+(m?" operations in queue":"")+(g?" updating SourceBuffer(s)":"")+" "+this.operationQueue),this.operationQueue.destroy()}var p=this.transferData;return!this.sourceBufferCount&&p&&p.mediaSource===a?A(h,p.tracks):this.sourceBuffers.forEach(function(E){var x=E[0];x&&(h[x]=A({},t.tracks[x]),t.removeBuffer(x)),E[0]=E[1]=null}),{media:i,mediaSource:a,tracks:h}},o.initTracks=function(){var t={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=t,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0},o.onManifestLoading=function(){this.bufferCodecEventsTotal=0,this.details=null},o.onManifestParsed=function(t,i){var a,h=2;(i.audio&&!i.video||!i.altAudio)&&(h=1),this.bufferCodecEventsTotal=h,this.log(h+" bufferCodec event(s) expected."),(a=this.transferData)!=null&&a.mediaSource&&this.sourceBufferCount&&h&&this.bufferCreated()},o.onMediaAttaching=function(t,i){var a=this.media=i.media,h=Ue(this.appendSource);if(this.transferData=this.overrides=void 0,a&&h){var g=!!i.mediaSource;(g||i.overrides)&&(this.transferData=i,this.overrides=i.overrides);var m=this.mediaSource=i.mediaSource||new h;if(this.assignMediaSource(m),g)this._objectUrl=a.src,this.attachTransferred();else{var p=this._objectUrl=self.URL.createObjectURL(m);if(this.appendSource)try{a.removeAttribute("src");var E=self.ManagedMediaSource;a.disableRemotePlayback=a.disableRemotePlayback||E&&m instanceof E,qu(a),z0(a,p),a.load()}catch{a.src=p}else a.src=p}a.addEventListener("emptied",this._onMediaEmptied)}},o.assignMediaSource=function(t){var i,a;this.log((((i=this.transferData)==null?void 0:i.mediaSource)===t?"transferred":"created")+" media source: "+((a=t.constructor)==null?void 0:a.name)),t.addEventListener("sourceopen",this._onMediaSourceOpen),t.addEventListener("sourceended",this._onMediaSourceEnded),t.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.addEventListener("startstreaming",this._onStartStreaming),t.addEventListener("endstreaming",this._onEndStreaming))},o.attachTransferred=function(){var t=this,i=this.media,a=this.transferData;if(!(!a||!i)){var h=this.tracks,g=a.tracks,m=g?Object.keys(g):null,p=m?m.length:0,E=function(){t.media&&t.mediaSourceOpenOrEnded&&t._onMediaSourceOpen()};if(g&&m&&p){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log("attachTransferred: (bufferCodecEventsTotal "+this.bufferCodecEventsTotal+`)
required tracks: `+at(h,function(_,P){return _==="initSegment"?void 0:P})+`;
transfer tracks: `+at(g,function(_,P){return _==="initSegment"?void 0:P})+"}"),!Nt(g,h)){a.mediaSource=null,a.tracks=void 0;var x=i.currentTime,I=this.details,R=Math.max(x,(I==null?void 0:I.fragments[0].start)||0);if(R-x>1){this.log("attachTransferred: waiting for playback to reach new tracks start time "+x+" -> "+R);return}this.warn('attachTransferred: resetting MediaSource for incompatible tracks ("'+Object.keys(g)+'"->"'+Object.keys(h)+'") start time: '+R+" currentTime: "+x),this.onMediaDetaching(k.MEDIA_DETACHING,{}),this.onMediaAttaching(k.MEDIA_ATTACHING,a),i.currentTime=R;return}this.transferData=void 0,m.forEach(function(_){var P=_,O=g[P];if(O){var N=O.buffer;if(N){var U=t.fragmentTracker,B=O.id;if(U.hasFragments(B)||U.hasParts(B)){var G=We.getBuffered(N);U.detectEvictedFragments(P,G,B,null,!0)}var Y=Aa(P),V=[P,N];t.sourceBuffers[Y]=V,N.updating&&t.operationQueue&&t.operationQueue.prependBlocker(P),t.trackSourceBuffer(P,O)}}}),E(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),E()}},o.onMediaDetaching=function(t,i){var a=this,h=!!i.transferMedia;this.transferData=this.overrides=void 0;var g=this.media,m=this.mediaSource,p=this._objectUrl;if(m){if(this.log("media source "+(h?"transferring":"detaching")),h)this.sourceBuffers.forEach(function(R){var _=R[0];_&&a.removeBuffer(_)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){var E=m.readyState==="open";try{for(var x=m.sourceBuffers,I=x.length;I--;)E&&x[I].abort(),m.removeSourceBuffer(x[I]);E&&m.endOfStream()}catch(R){this.warn("onMediaDetaching: "+R.message+" while calling endOfStream")}}this.sourceBufferCount&&this.onBufferReset()}m.removeEventListener("sourceopen",this._onMediaSourceOpen),m.removeEventListener("sourceended",this._onMediaSourceEnded),m.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(m.removeEventListener("startstreaming",this._onStartStreaming),m.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}g&&(g.removeEventListener("emptied",this._onMediaEmptied),h||(p&&self.URL.revokeObjectURL(p),this.mediaSrc===p?(g.removeAttribute("src"),this.appendSource&&qu(g),g.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(k.MEDIA_DETACHED,i)},o.onBufferReset=function(){var t=this;this.sourceBuffers.forEach(function(i){var a=i[0];a&&t.resetBuffer(a)}),this.initTracks()},o.resetBuffer=function(t){var i,a=(i=this.tracks[t])==null?void 0:i.buffer;if(this.removeBuffer(t),a)try{var h;(h=this.mediaSource)!=null&&h.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(a)}catch(g){this.warn("onBufferReset "+t,g)}delete this.tracks[t]},o.removeBuffer=function(t){this.removeBufferListeners(t),this.sourceBuffers[Aa(t)]=[null,null];var i=this.tracks[t];i&&(i.buffer=void 0)},o.resetQueue=function(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new q0(this.tracks)},o.onBufferCodecs=function(t,i){var a=this,h=this.tracks,g=Object.keys(i);this.log('BUFFER_CODECS: "'+g+'" (current SB count '+this.sourceBufferCount+")");var m="audiovideo"in i&&(h.audio||h.video)||h.audiovideo&&("audio"in i||"video"in i),p=!m&&this.sourceBufferCount&&this.media&&g.some(function(E){return!h[E]});if(m||p){this.warn('Unsupported transition between "'+Object.keys(h)+'" and "'+g+'" SourceBuffers');return}g.forEach(function(E){var x,I,R,_=i[E],P=_.id,O=_.codec,N=_.levelCodec,U=_.container,B=_.metadata,G=_.supplemental,Y=h[E],V=(x=a.transferData)==null||(I=x.tracks)==null?void 0:I[E],j=V!=null&&V.buffer?V:Y,ae=(j==null?void 0:j.pendingCodec)||(j==null?void 0:j.codec),X=j==null?void 0:j.levelCodec;Y||(Y=h[E]={buffer:void 0,listeners:[],codec:O,supplemental:G,container:U,levelCodec:N,metadata:B,id:P});var W=vs(ae,X),J=W==null?void 0:W.replace(Yu,"$1"),oe=vs(O,N),ge=(R=oe)==null?void 0:R.replace(Yu,"$1");oe&&W&&J!==ge&&(E.slice(0,5)==="audio"&&(oe=gs(oe,a.appendSource)),a.log("switching codec "+ae+" to "+oe),oe!==(Y.pendingCodec||Y.codec)&&(Y.pendingCodec=oe),Y.container=U,a.appendChangeType(E,U,oe))}),(this.tracksReady||this.sourceBufferCount)&&(i.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()},o.appendChangeType=function(t,i,a){var h=this,g=i+";codecs="+a,m={label:"change-type="+g,execute:function(){var E=h.tracks[t];if(E){var x=E.buffer;x!=null&&x.changeType&&(h.log("changing "+t+" sourceBuffer type to "+g),x.changeType(g),E.codec=a,E.container=i)}h.shiftAndExecuteNext(t)},onStart:function(){},onComplete:function(){},onError:function(E){h.warn("Failed to change "+t+" SourceBuffer type",E)}};this.append(m,t,this.isPending(this.tracks[t]))},o.blockAudio=function(t){var i,a=this,h=t.start,g=h+t.duration*.05,m=((i=this.fragmentTracker.getAppendedFrag(h,pe.MAIN))==null?void 0:i.gap)===!0;if(!m){var p={label:"block-audio",execute:function(){var x,I=a.tracks.video;(a.lastVideoAppendEnd>g||I!=null&&I.buffer&&We.isBuffered(I.buffer,g)||((x=a.fragmentTracker.getAppendedFrag(g,pe.MAIN))==null?void 0:x.gap)===!0)&&(a.blockedAudioAppend=null,a.shiftAndExecuteNext("audio"))},onStart:function(){},onComplete:function(){},onError:function(x){a.warn("Error executing block-audio operation",x)}};this.blockedAudioAppend={op:p,frag:t},this.append(p,"audio",!0)}},o.unblockAudio=function(){var t=this.blockedAudioAppend,i=this.operationQueue;t&&i&&(this.blockedAudioAppend=null,i.unblockAudio(t.op))},o.onBufferAppending=function(t,i){var a=this,h=this.tracks,g=i.data,m=i.type,p=i.parent,E=i.frag,x=i.part,I=i.chunkMeta,R=I.buffering[m],_=E.sn,P=self.performance.now();R.start=P;var O=E.stats.buffering,N=x?x.stats.buffering:null;O.start===0&&(O.start=P),N&&N.start===0&&(N.start=P);var U=h.audio,B=!1;m==="audio"&&(U==null?void 0:U.container)==="audio/mpeg"&&(B=!this.lastMpegAudioChunk||I.id===1||this.lastMpegAudioChunk.sn!==I.sn,this.lastMpegAudioChunk=I);var G=this.tracks.video,Y=G==null?void 0:G.buffer;if(Y&&_!=="initSegment"){var V=x||E,j=this.blockedAudioAppend;if(m==="audio"&&p!=="main"&&!this.blockedAudioAppend){var ae=V.start,X=ae+V.duration*.05,W=Y.buffered,J=this.currentOp("video");!W.length&&!J?this.blockAudio(V):!J&&!We.isBuffered(Y,X)&&this.lastVideoAppendEnd<X&&this.blockAudio(V)}else if(m==="video"){var oe=V.end;if(j){var ge=j.frag.start;(oe>ge||oe<this.lastVideoAppendEnd||We.isBuffered(Y,ge))&&this.unblockAudio()}this.lastVideoAppendEnd=oe}}var ce=(x||E).start,he={label:"append-"+m,execute:function(){if(R.executeStart=self.performance.now(),B){var Se=a.tracks[m];if(Se){var Le=Se.buffer;if(Le){var Ie=ce-Le.timestampOffset;Math.abs(Ie)>=.1&&(a.log("Updating audio SourceBuffer timestampOffset to "+ce+" (delta: "+Ie+") sn: "+_+")"),Le.timestampOffset=ce)}}}a.appendExecutor(g,m)},onStart:function(){},onComplete:function(){var Se=self.performance.now();R.executeEnd=R.end=Se,O.first===0&&(O.first=Se),N&&N.first===0&&(N.first=Se);var Le={};a.sourceBuffers.forEach(function(Ie){var He=Ie[0],Oe=Ie[1];He&&(Le[He]=We.getBuffered(Oe))}),a.appendErrors[m]=0,m==="audio"||m==="video"?a.appendErrors.audiovideo=0:(a.appendErrors.audio=0,a.appendErrors.video=0),a.hls.trigger(k.BUFFER_APPENDED,{type:m,frag:E,part:x,chunkMeta:I,parent:E.type,timeRanges:Le})},onError:function(Se){var Le,Ie={type:se.MEDIA_ERROR,parent:E.type,details:q.BUFFER_APPEND_ERROR,sourceBufferName:m,frag:E,part:x,chunkMeta:I,error:Se,err:Se,fatal:!1};if(Se.code===DOMException.QUOTA_EXCEEDED_ERR)Ie.details=q.BUFFER_FULL_ERROR;else if(Se.code===DOMException.INVALID_STATE_ERR&&a.mediaSourceOpenOrEnded&&!((Le=a.media)!=null&&Le.error))Ie.errorAction=Fi(!0);else if(Se.name===Wu)a.sourceBufferCount===0?Ie.errorAction=Fi(!0):++a.appendErrors[m];else{var He=++a.appendErrors[m];a.warn("Failed "+He+"/"+a.hls.config.appendErrorMaxRetry+' times to append segment in "'+m+'" sourceBuffer'),He>=a.hls.config.appendErrorMaxRetry&&(Ie.fatal=!0)}a.hls.trigger(k.ERROR,Ie)}};this.append(he,m,this.isPending(this.tracks[m]))},o.getFlushOp=function(t,i,a){var h=this;return this.log('queuing "'+t+'" remove '+i+"-"+a),{label:"remove",execute:function(){h.removeExecutor(t,i,a)},onStart:function(){},onComplete:function(){h.hls.trigger(k.BUFFER_FLUSHED,{type:t})},onError:function(m){h.warn("Failed to remove "+i+"-"+a+' from "'+t+'" SourceBuffer',m)}}},o.onBufferFlushing=function(t,i){var a=this,h=i.type,g=i.startOffset,m=i.endOffset;h?this.append(this.getFlushOp(h,g,m),h):this.sourceBuffers.forEach(function(p){var E=p[0];E&&a.append(a.getFlushOp(E,g,m),E)})},o.onFragParsed=function(t,i){var a=this,h=i.frag,g=i.part,m=[],p=g?g.elementaryStreams:h.elementaryStreams;p[Ve.AUDIOVIDEO]?m.push("audiovideo"):(p[Ve.AUDIO]&&m.push("audio"),p[Ve.VIDEO]&&m.push("video"));var E=function(){var I=self.performance.now();h.stats.buffering.end=I,g&&(g.stats.buffering.end=I);var R=g?g.stats:h.stats;a.hls.trigger(k.FRAG_BUFFERED,{frag:h,part:g,stats:R,id:h.type})};m.length===0&&this.warn("Fragments must have at least one ElementaryStreamType set. type: "+h.type+" level: "+h.level+" sn: "+h.sn),this.blockBuffers(E,m)},o.onFragChanged=function(t,i){this.trimBuffers()},o.onBufferEos=function(t,i){var a=this,h;this.sourceBuffers.forEach(function(p){var E=p[0];if(E){var x=a.tracks[E];(!i.type||i.type===E)&&(x.ending=!0,x.ended||(x.ended=!0,a.log(E+" buffer reached EOS")))}});var g=((h=this.overrides)==null?void 0:h.endOfStream)!==!1,m=this.sourceBufferCount>0&&!this.sourceBuffers.some(function(p){var E,x=p[0];return x&&!((E=a.tracks[x])!=null&&E.ended)});m&&(g?(this.log("Queueing EOS"),this.blockUntilOpen(function(){a.tracksEnded();var p=a.mediaSource;if(!p||p.readyState!=="open"){p&&a.log("Could not call mediaSource.endOfStream(). mediaSource.readyState: "+p.readyState);return}a.log("Calling mediaSource.endOfStream()"),p.endOfStream(),a.hls.trigger(k.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(k.BUFFERED_TO_END,void 0)))},o.tracksEnded=function(){var t=this;this.sourceBuffers.forEach(function(i){var a=i[0];if(a!==null){var h=t.tracks[a];h&&(h.ending=!1)}})},o.onLevelUpdated=function(t,i){var a=i.details;a.fragments.length&&(this.details=a,this.updateDuration())},o.updateDuration=function(){var t=this,i=this.getDurationAndRange();i&&this.blockUntilOpen(function(){return t.updateMediaSource(i)})},o.onError=function(t,i){if(i.details===q.BUFFER_APPEND_ERROR&&i.frag){var a,h=(a=i.errorAction)==null?void 0:a.nextAutoLevel;ue(h)&&h!==i.frag.level&&this.resetAppendErrors()}},o.resetAppendErrors=function(){this.appendErrors={audio:0,video:0,audiovideo:0}},o.trimBuffers=function(){var t=this.hls,i=this.details,a=this.media;if(!(!a||i===null)&&this.sourceBufferCount){var h=t.config,g=a.currentTime,m=i.levelTargetDuration,p=i.live&&h.liveBackBufferLength!==null?h.liveBackBufferLength:h.backBufferLength;if(ue(p)&&p>=0){var E=Math.max(p,m),x=Math.floor(g/m)*m-E;this.flushBackBuffer(g,m,x)}if(ue(h.frontBufferFlushThreshold)&&h.frontBufferFlushThreshold>0){var I=Math.max(h.maxBufferLength,h.frontBufferFlushThreshold),R=Math.max(I,m),_=Math.floor(g/m)*m+R;this.flushFrontBuffer(g,m,_)}}},o.flushBackBuffer=function(t,i,a){var h=this;this.sourceBuffers.forEach(function(g){var m=g[0],p=g[1];if(p){var E=We.getBuffered(p);if(E.length>0&&a>E.start(0)){var x;h.hls.trigger(k.BACK_BUFFER_REACHED,{bufferEnd:a});var I=h.tracks[m];if((x=h.details)!=null&&x.live)h.hls.trigger(k.LIVE_BACK_BUFFER_REACHED,{bufferEnd:a});else if(I!=null&&I.ended){h.log("Cannot flush "+m+" back buffer while SourceBuffer is in ended state");return}h.hls.trigger(k.BUFFER_FLUSHING,{startOffset:0,endOffset:a,type:m})}}})},o.flushFrontBuffer=function(t,i,a){var h=this;this.sourceBuffers.forEach(function(g){var m=g[0],p=g[1];if(p){var E=We.getBuffered(p),x=E.length;if(x<2)return;var I=E.start(x-1),R=E.end(x-1);if(a>I||t>=I&&t<=R)return;h.hls.trigger(k.BUFFER_FLUSHING,{startOffset:I,endOffset:1/0,type:m})}})},o.getDurationAndRange=function(){var t,i=this.details,a=this.mediaSource;if(!i||!this.media||(a==null?void 0:a.readyState)!=="open")return null;var h=i.edge;if(i.live&&this.hls.config.liveDurationInfinity){var g=i.fragments.length;if(g&&i.live&&a.setLiveSeekableRange){var m=Math.max(0,i.fragmentStart),p=Math.max(m,h);return{duration:1/0,start:m,end:p}}return{duration:1/0}}var E=(t=this.overrides)==null?void 0:t.duration;if(E)return ue(E)?{duration:E}:null;var x=this.media.duration,I=ue(a.duration)?a.duration:0;return h>I&&h>x||!ue(x)?{duration:h}:null},o.updateMediaSource=function(t){var i=t.duration,a=t.start,h=t.end,g=this.mediaSource;!this.media||!g||g.readyState!=="open"||(g.duration!==i&&(ue(i)&&this.log("Updating MediaSource duration to "+i.toFixed(3)),g.duration=i),a!==void 0&&h!==void 0&&(this.log("MediaSource duration is set to "+g.duration+". Setting seekable range to "+a+"-"+h+"."),g.setLiveSeekableRange(a,h)))},o.checkPendingTracks=function(){var t=this.bufferCodecEventsTotal,i=this.pendingTrackCount,a=this.tracks;if(this.log("checkPendingTracks (pending: "+i+" codec events expected: "+t+") "+at(a)),this.tracksReady){var h,g=(h=this.transferData)==null?void 0:h.tracks;g&&Object.keys(g).length?this.attachTransferred():this.createSourceBuffers()}},o.bufferCreated=function(){var t=this;if(this.sourceBufferCount){var i={};this.sourceBuffers.forEach(function(h){var g=h[0],m=h[1];if(g){var p=t.tracks[g];i[g]={buffer:m,container:p.container,codec:p.codec,supplemental:p.supplemental,levelCodec:p.levelCodec,id:p.id,metadata:p.metadata}}}),this.hls.trigger(k.BUFFER_CREATED,{tracks:i}),this.log("SourceBuffers created. Running queue: "+this.operationQueue),this.sourceBuffers.forEach(function(h){var g=h[0];t.executeNext(g)})}else{var a=new Error("could not create source buffer for media codec(s)");this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:a,reason:a.message})}},o.createSourceBuffers=function(){var t=this.tracks,i=this.sourceBuffers,a=this.mediaSource;if(!a)throw new Error("createSourceBuffers called when mediaSource was null");for(var h in t){var g=h,m=t[g];if(this.isPending(m)){var p=this.getTrackCodec(m,g),E=m.container+";codecs="+p;m.codec=p,this.log("creating sourceBuffer("+E+")"+(this.currentOp(g)?" Queued":"")+" "+at(m));try{var x=a.addSourceBuffer(E),I=Aa(g),R=[g,x];i[I]=R,m.buffer=x}catch(P){var _;this.error("error while trying to add sourceBuffer: "+P.message),this.shiftAndExecuteNext(g),(_=this.operationQueue)==null||_.removeBlockers(),delete this.tracks[g],this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:P,sourceBufferName:g,mimeType:E,parent:m.id});return}this.trackSourceBuffer(g,m)}}this.bufferCreated()},o.getTrackCodec=function(t,i){var a=t.supplemental,h=t.codec;a&&(i==="video"||i==="audiovideo")&&Bn(a,"video")&&(h=$c(h,a));var g=vs(h,t.levelCodec);return g?i.slice(0,5)==="audio"?gs(g,this.appendSource):g:""},o.trackSourceBuffer=function(t,i){var a=this,h=i.buffer;if(h){var g=this.getTrackCodec(i,t);this.tracks[t]={buffer:h,codec:g,container:i.container,levelCodec:i.levelCodec,supplemental:i.supplemental,metadata:i.metadata,id:i.id,listeners:[]},this.removeBufferListeners(t),this.addBufferListener(t,"updatestart",this.onSBUpdateStart),this.addBufferListener(t,"updateend",this.onSBUpdateEnd),this.addBufferListener(t,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(t,"bufferedchange",function(m,p){var E=p.removedRanges;E!=null&&E.length&&a.hls.trigger(k.BUFFER_FLUSHED,{type:m})})}},o.onSBUpdateStart=function(t){var i=this.currentOp(t);i&&i.onStart()},o.onSBUpdateEnd=function(t){var i;if(((i=this.mediaSource)==null?void 0:i.readyState)==="closed"){this.resetBuffer(t);return}var a=this.currentOp(t);a&&(a.onComplete(),this.shiftAndExecuteNext(t))},o.onSBUpdateError=function(t,i){var a,h=new Error(t+" SourceBuffer error. MediaSource readyState: "+((a=this.mediaSource)==null?void 0:a.readyState));this.error(""+h,i),this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:h,fatal:!1});var g=this.currentOp(t);g&&g.onError(h)},o.removeExecutor=function(t,i,a){var h=this.media,g=this.mediaSource,m=this.tracks[t],p=m==null?void 0:m.buffer;if(!h||!g||!p){this.warn("Attempting to remove from the "+t+" SourceBuffer, but it does not exist"),this.shiftAndExecuteNext(t);return}var E=ue(h.duration)?h.duration:1/0,x=ue(g.duration)?g.duration:1/0,I=Math.max(0,i),R=Math.min(a,E,x);R>I&&(!m.ending||m.ended)?(m.ended=!1,this.log("Removing ["+I+","+R+"] from the "+t+" SourceBuffer"),p.remove(I,R)):this.shiftAndExecuteNext(t)},o.appendExecutor=function(t,i){var a=this.tracks[i],h=a==null?void 0:a.buffer;if(!h)throw new j0("Attempting to append to the "+i+" SourceBuffer, but it does not exist");a.ending=!1,a.ended=!1,h.appendBuffer(t)},o.blockUntilOpen=function(t){this.isUpdating()||this.isQueued()?this.blockBuffers(t):t()},o.isUpdating=function(){return this.sourceBuffers.some(function(t){var i=t[0],a=t[1];return i&&a.updating})},o.isQueued=function(){var t=this;return this.sourceBuffers.some(function(i){var a=i[0];return a&&!!t.currentOp(a)})},o.isPending=function(t){return!!t&&!t.buffer},o.blockBuffers=function(t,i){var a=this;if(i===void 0&&(i=this.sourceBufferTypes),!i.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(t);return}var h=this.operationQueue,g=i.map(function(p){return a.appendBlocker(p)}),m=i.length>1&&!!this.blockedAudioAppend;m&&this.unblockAudio(),Promise.all(g).then(function(p){h===a.operationQueue&&(t(),a.stepOperationQueue(i))})},o.stepOperationQueue=function(t){var i=this;t.forEach(function(a){var h,g=(h=i.tracks[a])==null?void 0:h.buffer;!g||g.updating||i.shiftAndExecuteNext(a)})},o.append=function(t,i,a){this.operationQueue&&this.operationQueue.append(t,i,a)},o.appendBlocker=function(t){if(this.operationQueue)return this.operationQueue.appendBlocker(t)},o.currentOp=function(t){return this.operationQueue?this.operationQueue.current(t):null},o.executeNext=function(t){t&&this.operationQueue&&this.operationQueue.executeNext(t)},o.shiftAndExecuteNext=function(t){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(t)},o.addBufferListener=function(t,i,a){var h=this.tracks[t];if(h){var g=h.buffer;if(g){var m=a.bind(this,t);h.listeners.push({event:i,listener:m}),g.addEventListener(i,m)}}},o.removeBufferListeners=function(t){var i=this.tracks[t];if(i){var a=i.buffer;a&&(i.listeners.forEach(function(h){a.removeEventListener(h.event,h.listener)}),i.listeners.length=0)}},y(d,[{key:"mediaSourceOpenOrEnded",get:function(){var t,i=(t=this.mediaSource)==null?void 0:t.readyState;return i==="open"||i==="ended"}},{key:"sourceBufferTracks",get:function(){var t=this;return Object.keys(this.tracks).reduce(function(i,a){var h=t.tracks[a];return i[a]={id:h.id,container:h.container,codec:h.codec,levelCodec:h.levelCodec},i},{})}},{key:"bufferedToEnd",get:function(){var t=this;return this.sourceBufferCount>0&&!this.sourceBuffers.some(function(i){var a,h,g=i[0];return g&&(!((a=t.tracks[g])!=null&&a.ended)||((h=t.tracks[g])==null?void 0:h.ending))})}},{key:"tracksReady",get:function(){var t=this.pendingTrackCount;return t>0&&(t>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}},{key:"mediaSrc",get:function(){var t,i,a=((t=this.media)==null||(i=t.querySelector)==null?void 0:i.call(t,"source"))||this.media;return a==null?void 0:a.src}},{key:"pendingTrackCount",get:function(){var t=this;return Object.keys(this.tracks).reduce(function(i,a){return i+(t.isPending(t.tracks[a])?1:0)},0)}},{key:"sourceBufferCount",get:function(){return this.sourceBuffers.reduce(function(t,i){var a=i[0];return t+(a?1:0)},0)}},{key:"sourceBufferTypes",get:function(){return this.sourceBuffers.map(function(t){var i=t[0];return i}).filter(function(t){return!!t})}}])}(st);function qu(u){var d=u.querySelectorAll("source");[].slice.call(d).forEach(function(o){u.removeChild(o)})}function z0(u,d){var o=self.document.createElement("source");o.type="video/mp4",o.src=d,u.appendChild(o)}function Aa(u){return u==="audio"?1:0}var Q0=function(){function u(o){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=o,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var d=u.prototype;return d.setStreamController=function(s){this.streamController=s},d.destroy=function(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},d.registerListeners=function(){var s=this.hls;s.on(k.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),s.on(k.MEDIA_ATTACHING,this.onMediaAttaching,this),s.on(k.MANIFEST_PARSED,this.onManifestParsed,this),s.on(k.LEVELS_UPDATED,this.onLevelsUpdated,this),s.on(k.BUFFER_CODECS,this.onBufferCodecs,this),s.on(k.MEDIA_DETACHING,this.onMediaDetaching,this)},d.unregisterListener=function(){var s=this.hls;s.off(k.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),s.off(k.MEDIA_ATTACHING,this.onMediaAttaching,this),s.off(k.MANIFEST_PARSED,this.onManifestParsed,this),s.off(k.LEVELS_UPDATED,this.onLevelsUpdated,this),s.off(k.BUFFER_CODECS,this.onBufferCodecs,this),s.off(k.MEDIA_DETACHING,this.onMediaDetaching,this)},d.onFpsDropLevelCapping=function(s,t){var i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})},d.onMediaAttaching=function(s,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()},d.onManifestParsed=function(s,t){var i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()},d.onLevelsUpdated=function(s,t){this.timer&&ue(this.autoLevelCapping)&&this.detectPlayerSize()},d.onBufferCodecs=function(s,t){var i=this.hls;i.config.capLevelToPlayerSize&&t.video&&this.startCapping()},d.onMediaDetaching=function(){this.stopCapping(),this.media=null},d.detectPlayerSize=function(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}var s=this.hls.levels;if(s.length){var t=this.hls,i=this.getMaxLevel(s.length-1);i!==this.autoLevelCapping&&t.logger.log("Setting autoLevelCapping to "+i+": "+s[i].height+"p@"+s[i].bitrate+" for media "+this.mediaWidth+"x"+this.mediaHeight),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}},d.getMaxLevel=function(s){var t=this,i=this.hls.levels;if(!i.length)return-1;var a=i.filter(function(h,g){return t.isLevelAllowed(h)&&g<=s});return this.clientRect=null,u.getMaxLevelByMediaSize(a,this.mediaWidth,this.mediaHeight)},d.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},d.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},d.getDimensions=function(){if(this.clientRect)return this.clientRect;var s=this.media,t={width:0,height:0};if(s){var i=s.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||s.width||0,t.height=i.bottom-i.top||s.height||0)}return this.clientRect=t,t},d.isLevelAllowed=function(s){var t=this.restrictedLevels;return!t.some(function(i){return s.bitrate===i.bitrate&&s.width===i.width&&s.height===i.height})},u.getMaxLevelByMediaSize=function(s,t,i){if(!(s!=null&&s.length))return-1;for(var a=function(x,I){return I?x.width!==I.width||x.height!==I.height:!0},h=s.length-1,g=Math.max(t,i),m=0;m<s.length;m+=1){var p=s[m];if((p.width>=g||p.height>=g)&&a(p,s[m+1])){h=m;break}}return h},y(u,[{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var s=1;if(!this.hls.config.ignoreDevicePixelRatio)try{s=self.devicePixelRatio}catch{}return Math.min(s,this.hls.config.maxDevicePixelRatio)}}])}(),Z0={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Bt=Z0,J0={HLS:"h"},ev=J0,tv="CMCD-Object",rv="CMCD-Request",iv="CMCD-Session",sv="CMCD-Status",Hi={OBJECT:tv,REQUEST:rv,SESSION:iv,STATUS:sv},ci,nv=(ci={},ci[Hi.OBJECT]=["br","d","ot","tb"],ci[Hi.REQUEST]=["bl","dl","mtp","nor","nrr","su"],ci[Hi.SESSION]=["cid","pr","sf","sid","st","v"],ci[Hi.STATUS]=["bs","rtp"],ci),xa=function u(d,o){Array.isArray(d)&&(d=d.map(function(s){return s instanceof u?s:new u(s)})),this.value=d,this.params=o},av="Dict";function ov(u){return Array.isArray(u)?JSON.stringify(u):u instanceof Map?"Map{}":u instanceof Set?"Set{}":typeof u=="object"?JSON.stringify(u):String(u)}function lv(u,d,o,s){return new Error("failed to "+u+' "'+ov(d)+'" as '+o,{cause:s})}function ur(u,d,o){return lv("serialize",u,d,o)}var ju=function(d){this.description=d},Xu="Bare Item",uv="Boolean";function hv(u){if(typeof u!="boolean")throw ur(u,uv);return u?"?1":"?0"}var fv="Byte Sequence";function dv(u){if(ArrayBuffer.isView(u)===!1)throw ur(u,fv);return":"+Jg(u)+":"}var cv="Integer";function gv(u){return u<-999999999999999||999999999999999<u}function zu(u){if(gv(u))throw ur(u,cv);return u.toString()}function vv(u){return"@"+zu(u.getTime()/1e3)}var mv="Decimal";function pv(u){var d=Su(u,3);if(Math.floor(Math.abs(d)).toString().length>12)throw ur(u,mv);var o=d.toString();return o.includes(".")?o:o+".0"}var yv="String",Ev=/[\x00-\x1f\x7f]+/;function Tv(u){if(Ev.test(u))throw ur(u,yv);return'"'+u.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}function Sv(u){return u.description||u.toString().slice(7,-1)}var Av="Token";function Qu(u){var d=Sv(u);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(d)===!1)throw ur(d,Av);return d}function La(u){switch(typeof u){case"number":if(!ue(u))throw ur(u,Xu);return Number.isInteger(u)?zu(u):pv(u);case"string":return Tv(u);case"symbol":return Qu(u);case"boolean":return hv(u);case"object":if(u instanceof Date)return vv(u);if(u instanceof Uint8Array)return dv(u);if(u instanceof ju)return Qu(u);default:throw ur(u,Xu)}}var xv="Key";function Ia(u){if(/^[a-z*][a-z0-9\-_.*]*$/.test(u)===!1)throw ur(u,xv);return u}function Ra(u){return u==null?"":Object.entries(u).map(function(d){var o=d[0],s=d[1];return s===!0?";"+Ia(o):";"+Ia(o)+"="+La(s)}).join("")}function Zu(u){return u instanceof xa?""+La(u.value)+Ra(u.params):La(u)}function Lv(u){return"("+u.value.map(Zu).join(" ")+")"+Ra(u.params)}function Iv(u,d){if(d===void 0&&(d={whitespace:!0}),typeof u!="object")throw ur(u,av);var o=u instanceof Map?u.entries():Object.entries(u),s=d!=null&&d.whitespace?" ":"";return Array.from(o).map(function(t){var i=t[0],a=t[1];a instanceof xa||(a=new xa(a));var h=Ia(i);return a.value===!0?h+=Ra(a.params):(h+="=",Array.isArray(a.value)?h+=Lv(a):h+=Zu(a)),h}).join(","+s)}function Rv(u,d){return Iv(u,d)}function bv(u){return u==="ot"||u==="sf"||u==="st"}function _v(u){return typeof u=="number"?ue(u):u!=null&&u!==""&&u!==!1}var Os=function(d){return Math.round(d)},Dv=function(d,o){return o!=null&&o.baseUrl&&(d=e0(d,o.baseUrl)),encodeURIComponent(d)},Ms=function(d){return Os(d/100)*100},Cv={br:Os,d:Os,bl:Ms,dl:Ms,mtp:Ms,nor:Dv,rtp:Ms,tb:Os};function Pv(u,d){var o={};if(u==null||typeof u!="object")return o;var s=Object.keys(u).sort(),t=A({},Cv,d==null?void 0:d.formatters),i=d==null?void 0:d.filter;return s.forEach(function(a){if(!(i!=null&&i(a))){var h=u[a],g=t[a];g&&(h=g(h,d)),!(a==="v"&&h===1)&&(a=="pr"&&h===1||_v(h)&&(bv(a)&&typeof h=="string"&&(h=new ju(h)),o[a]=h))}}),o}function Ju(u,d){return d===void 0&&(d={}),u?Rv(Pv(u,d),A({whitespace:!1},d)):""}function kv(u,d){d===void 0&&(d={});var o={};if(!u)return o;var s=Object.entries(u),t=Object.entries(nv).concat(Object.entries((d==null?void 0:d.customHeaderMap)||{})),i=s.reduce(function(a,h){var g,m,p=h[0],E=h[1],x=((g=t.find(function(I){return I[1].includes(p)}))===null||g===void 0?void 0:g[0])||Hi.REQUEST;return(m=a[x])!==null&&m!==void 0||(a[x]={}),a[x][p]=E,a},{});return Object.entries(i).reduce(function(a,h){var g=h[0],m=h[1];return a[g]=Ju(m,d),a},o)}function wv(u,d,o){return A(u,kv(d,o))}var Ov="CMCD";function Mv(u,d){if(d===void 0&&(d={}),!u)return"";var o=Ju(u,d);return Ov+"="+encodeURIComponent(o)}var eh=/CMCD=[^&#]+/;function Fv(u,d,o){var s=Mv(d,o);if(!s)return u;if(eh.test(u))return u.replace(eh,s);var t=u.includes("?")?"&":"?";return""+u+t+s}var Nv=function(){function u(o){var s=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){s.initialized&&(s.starved=!0),s.buffering=!0},this.onPlaying=function(){s.initialized||(s.initialized=!0),s.buffering=!1},this.applyPlaylistData=function(a){try{s.apply(a,{ot:Bt.MANIFEST,su:!s.initialized})}catch(h){s.hls.logger.warn("Could not generate manifest CMCD data.",h)}},this.applyFragmentData=function(a){try{var h=a.frag,g=a.part,m=s.hls.levels[h.level],p=s.getObjectType(h),E={d:(g||h).duration*1e3,ot:p};(p===Bt.VIDEO||p===Bt.AUDIO||p==Bt.MUXED)&&(E.br=m.bitrate/1e3,E.tb=s.getTopBandwidth(p)/1e3,E.bl=s.getBufferLength(p));var x=g?s.getNextPart(g):s.getNextFrag(h);x!=null&&x.url&&x.url!==h.url&&(E.nor=x.url),s.apply(a,E)}catch(I){s.hls.logger.warn("Could not generate segment CMCD data.",I)}},this.hls=o;var t=this.config=o.config,i=t.cmcd;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||o.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}var d=u.prototype;return d.registerListeners=function(){var s=this.hls;s.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),s.on(k.MEDIA_DETACHED,this.onMediaDetached,this),s.on(k.BUFFER_CREATED,this.onBufferCreated,this)},d.unregisterListeners=function(){var s=this.hls;s.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),s.off(k.MEDIA_DETACHED,this.onMediaDetached,this),s.off(k.BUFFER_CREATED,this.onBufferCreated,this)},d.destroy=function(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null},d.onMediaAttached=function(s,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},d.onMediaDetached=function(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},d.onBufferCreated=function(s,t){var i,a;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(a=t.tracks.video)==null?void 0:a.buffer},d.createData=function(){var s;return{v:1,sf:ev.HLS,sid:this.sid,cid:this.cid,pr:(s=this.media)==null?void 0:s.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},d.apply=function(s,t){t===void 0&&(t={}),A(t,this.createData());var i=t.ot===Bt.INIT||t.ot===Bt.VIDEO||t.ot===Bt.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);var a=this.includeKeys;a&&(t=Object.keys(t).reduce(function(g,m){return a.includes(m)&&(g[m]=t[m]),g},{}));var h={baseUrl:s.url};this.useHeaders?(s.headers||(s.headers={}),wv(s.headers,t,h)):s.url=Fv(s.url,t,h)},d.getNextFrag=function(s){var t,i=(t=this.hls.levels[s.level])==null?void 0:t.details;if(i){var a=s.sn-i.startSN;return i.fragments[a+1]}},d.getNextPart=function(s){var t,i,a=s.index,h=s.fragment,g=(t=this.hls.levels[h.level])==null||(i=t.details)==null?void 0:i.partList;if(g)for(var m=h.sn,p=g.length-1;p>=0;p--){var E=g[p];if(E.index===a&&E.fragment.sn===m)return g[p+1]}},d.getObjectType=function(s){var t=s.type;if(t==="subtitle")return Bt.TIMED_TEXT;if(s.sn==="initSegment")return Bt.INIT;if(t==="audio")return Bt.AUDIO;if(t==="main")return this.hls.audioTracks.length?Bt.VIDEO:Bt.MUXED},d.getTopBandwidth=function(s){var t=0,i,a=this.hls;if(s===Bt.AUDIO)i=a.audioTracks;else{var h=a.maxAutoLevel,g=h>-1?h+1:a.levels.length;i=a.levels.slice(0,g)}for(var m=S(i),p;!(p=m()).done;){var E=p.value;E.bitrate>t&&(t=E.bitrate)}return t>0?t:NaN},d.getBufferLength=function(s){var t=this.media,i=s===Bt.AUDIO?this.audioBuffer:this.videoBuffer;if(!i||!t)return NaN;var a=We.bufferInfo(i,t.currentTime,this.config.maxBufferHole);return a.len*1e3},d.createPlaylistLoader=function(){var s=this.config.pLoader,t=this.applyPlaylistData,i=s||this.config.loader;return function(){function a(g){this.loader=void 0,this.loader=new i(g)}var h=a.prototype;return h.destroy=function(){this.loader.destroy()},h.abort=function(){this.loader.abort()},h.load=function(m,p,E){t(m),this.loader.load(m,p,E)},y(a,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}])}()},d.createFragmentLoader=function(){var s=this.config.fLoader,t=this.applyFragmentData,i=s||this.config.loader;return function(){function a(g){this.loader=void 0,this.loader=new i(g)}var h=a.prototype;return h.destroy=function(){this.loader.destroy()},h.abort=function(){this.loader.abort()},h.load=function(m,p,E){t(m),this.loader.load(m,p,E)},y(a,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}])}()},u}(),Uv=3e5,Bv=function(u){function d(s){var t;return t=u.call(this,"content-steering",s.logger)||this,t.hls=void 0,t.loader=null,t.uri=null,t.pathwayId=".",t._pathwayPriority=null,t.timeToLoad=300,t.reloadTimer=-1,t.updated=0,t.started=!1,t.enabled=!0,t.levels=null,t.audioTracks=null,t.subtitleTracks=null,t.penalizedPathways={},t.hls=s,t.registerListeners(),t}b(d,u);var o=d.prototype;return o.registerListeners=function(){var t=this.hls;t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(k.MANIFEST_PARSED,this.onManifestParsed,this),t.on(k.ERROR,this.onError,this)},o.unregisterListeners=function(){var t=this.hls;t&&(t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(k.MANIFEST_PARSED,this.onManifestParsed,this),t.off(k.ERROR,this.onError,this))},o.pathways=function(){return(this.levels||[]).reduce(function(t,i){return t.indexOf(i.pathwayId)===-1&&t.push(i.pathwayId),t},[])},o.startLoad=function(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){var t=this.timeToLoad*1e3-(performance.now()-this.updated);if(t>0){this.scheduleRefresh(this.uri,t);return}}this.loadSteeringManifest(this.uri)}},o.stopLoad=function(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()},o.clearTimeout=function(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)},o.destroy=function(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null},o.removeLevel=function(t){var i=this.levels;i&&(this.levels=i.filter(function(a){return a!==t}))},o.onManifestLoading=function(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null},o.onManifestLoaded=function(t,i){var a=i.contentSteering;a!==null&&(this.pathwayId=a.pathwayId,this.uri=a.uri,this.started&&this.startLoad())},o.onManifestParsed=function(t,i){this.audioTracks=i.audioTracks,this.subtitleTracks=i.subtitleTracks},o.onError=function(t,i){var a=i.errorAction;if((a==null?void 0:a.action)===Ot.SendAlternateToPenaltyBox&&a.flags===Zt.MoveAllAlternatesMatchingHost){var h=this.levels,g=this._pathwayPriority,m=this.pathwayId;if(i.context){var p=i.context,E=p.groupId,x=p.pathwayId,I=p.type;E&&h?m=this.getPathwayForGroupId(E,I,m):x&&(m=x)}m in this.penalizedPathways||(this.penalizedPathways[m]=performance.now()),!g&&h&&(g=this.pathways()),g&&g.length>1&&(this.updatePathwayPriority(g),a.resolved=this.pathwayId!==m),a.resolved||this.warn("Could not resolve "+i.details+' ("'+i.error.message+'") with content-steering for Pathway: '+m+" levels: "+(h&&h.length)+" priorities: "+at(g)+" penalized: "+at(this.penalizedPathways))}},o.filterParsedLevels=function(t){this.levels=t;var i=this.getLevelsForPathway(this.pathwayId);if(i.length===0){var a=t[0].pathwayId;this.log("No levels found in Pathway "+this.pathwayId+'. Setting initial Pathway to "'+a+'"'),i=this.getLevelsForPathway(a),this.pathwayId=a}return i.length!==t.length&&this.log("Found "+i.length+"/"+t.length+' levels in Pathway "'+this.pathwayId+'"'),i},o.getLevelsForPathway=function(t){return this.levels===null?[]:this.levels.filter(function(i){return t===i.pathwayId})},o.updatePathwayPriority=function(t){this._pathwayPriority=t;var i,a=this.penalizedPathways,h=performance.now();Object.keys(a).forEach(function(I){h-a[I]>Uv&&delete a[I]});for(var g=0;g<t.length;g++){var m=t[g];if(!(m in a)){if(m===this.pathwayId)return;var p=this.hls.nextLoadLevel,E=this.hls.levels[p];if(i=this.getLevelsForPathway(m),i.length>0){this.log('Setting Pathway to "'+m+'"'),this.pathwayId=m,uu(i),this.hls.trigger(k.LEVELS_UPDATED,{levels:i});var x=this.hls.levels[p];E&&x&&this.levels&&(x.attrs["STABLE-VARIANT-ID"]!==E.attrs["STABLE-VARIANT-ID"]&&x.bitrate!==E.bitrate&&this.log("Unstable Pathways change from bitrate "+E.bitrate+" to "+x.bitrate),this.hls.nextLoadLevel=p);break}}}},o.getPathwayForGroupId=function(t,i,a){for(var h=this.getLevelsForPathway(a).concat(this.levels||[]),g=0;g<h.length;g++)if(i===Te.AUDIO_TRACK&&h[g].hasAudioGroup(t)||i===Te.SUBTITLE_TRACK&&h[g].hasSubtitleGroup(t))return h[g].pathwayId;return a},o.clonePathways=function(t){var i=this,a=this.levels;if(a){var h={},g={};t.forEach(function(m){var p=m.ID,E=m["BASE-ID"],x=m["URI-REPLACEMENT"];if(!a.some(function(R){return R.pathwayId===p})){var I=i.getLevelsForPathway(E).map(function(R){var _=new pt(R.attrs);_["PATHWAY-ID"]=p;var P=_.AUDIO&&_.AUDIO+"_clone_"+p,O=_.SUBTITLES&&_.SUBTITLES+"_clone_"+p;P&&(h[_.AUDIO]=P,_.AUDIO=P),O&&(g[_.SUBTITLES]=O,_.SUBTITLES=O);var N=rh(R.uri,_["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",x),U=new Mi({attrs:_,audioCodec:R.audioCodec,bitrate:R.bitrate,height:R.height,name:R.name,url:N,videoCodec:R.videoCodec,width:R.width});if(R.audioGroups)for(var B=1;B<R.audioGroups.length;B++)U.addGroupId("audio",R.audioGroups[B]+"_clone_"+p);if(R.subtitleGroups)for(var G=1;G<R.subtitleGroups.length;G++)U.addGroupId("text",R.subtitleGroups[G]+"_clone_"+p);return U});a.push.apply(a,I),th(i.audioTracks,h,x,p),th(i.subtitleTracks,g,x,p)}})}},o.loadSteeringManifest=function(t){var i=this,a=this.hls.config,h=a.loader;this.loader&&this.loader.destroy(),this.loader=new h(a);var g;try{g=new self.URL(t)}catch{this.enabled=!1,this.log("Failed to parse Steering Manifest URI: "+t);return}if(g.protocol!=="data:"){var m=(this.hls.bandwidthEstimate||a.abrEwmaDefaultEstimate)|0;g.searchParams.set("_HLS_pathway",this.pathwayId),g.searchParams.set("_HLS_throughput",""+m)}var p={responseType:"json",url:g.href},E=a.steeringManifestLoadPolicy.default,x=E.errorRetry||E.timeoutRetry||{},I={loadPolicy:E,timeout:E.maxLoadTimeMs,maxRetry:x.maxNumRetry||0,retryDelay:x.retryDelayMs||0,maxRetryDelay:x.maxRetryDelayMs||0},R={onSuccess:function(P,O,N,U){i.log('Loaded steering manifest: "'+g+'"');var B=P.data;if((B==null?void 0:B.VERSION)!==1){i.log("Steering VERSION "+B.VERSION+" not supported!");return}i.updated=performance.now(),i.timeToLoad=B.TTL;var G=B["RELOAD-URI"],Y=B["PATHWAY-CLONES"],V=B["PATHWAY-PRIORITY"];if(G)try{i.uri=new self.URL(G,g).href}catch{i.enabled=!1,i.log("Failed to parse Steering Manifest RELOAD-URI: "+G);return}i.scheduleRefresh(i.uri||N.url),Y&&i.clonePathways(Y);var j={steeringManifest:B,url:g.toString()};i.hls.trigger(k.STEERING_MANIFEST_LOADED,j),V&&i.updatePathwayPriority(V)},onError:function(P,O,N,U){if(i.log("Error loading steering manifest: "+P.code+" "+P.text+" ("+O.url+")"),i.stopLoad(),P.code===410){i.enabled=!1,i.log("Steering manifest "+O.url+" no longer available");return}var B=i.timeToLoad*1e3;if(P.code===429){var G=i.loader;if(typeof(G==null?void 0:G.getResponseHeader)=="function"){var Y=G.getResponseHeader("Retry-After");Y&&(B=parseFloat(Y)*1e3)}i.log("Steering manifest "+O.url+" rate limited");return}i.scheduleRefresh(i.uri||O.url,B)},onTimeout:function(P,O,N){i.log("Timeout loading steering manifest ("+O.url+")"),i.scheduleRefresh(i.uri||O.url)}};this.log("Requesting steering manifest: "+g),this.loader.load(p,I,R)},o.scheduleRefresh=function(t,i){var a=this;i===void 0&&(i=this.timeToLoad*1e3),this.clearTimeout(),this.reloadTimer=self.setTimeout(function(){var h,g=(h=a.hls)==null?void 0:h.media;if(g&&!g.ended){a.loadSteeringManifest(t);return}a.scheduleRefresh(t,a.timeToLoad*1e3)},i)},y(d,[{key:"pathwayPriority",get:function(){return this._pathwayPriority},set:function(t){this.updatePathwayPriority(t)}}])}(st);function th(u,d,o,s){u&&Object.keys(d).forEach(function(t){var i=u.filter(function(a){return a.groupId===t}).map(function(a){var h=A({},a);return h.details=void 0,h.attrs=new pt(h.attrs),h.url=h.attrs.URI=rh(a.url,a.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",o),h.groupId=h.attrs["GROUP-ID"]=d[t],h.attrs["PATHWAY-ID"]=s,h});u.push.apply(u,i)})}function rh(u,d,o,s){var t=s.HOST,i=s.PARAMS,a=s[o],h;d&&(h=a==null?void 0:a[d],h&&(u=h));var g=new self.URL(u);return t&&!h&&(g.host=t),i&&Object.keys(i).sort().forEach(function(m){m&&g.searchParams.set(m,i[m])}),g.href}var ih=function(u){function d(s){var t;return t=u.call(this,"eme",s.logger)||this,t.hls=void 0,t.config=void 0,t.media=null,t.keyFormatPromise=null,t.keySystemAccessPromises={},t._requestLicenseFailureCount=0,t.mediaKeySessions=[],t.keyIdToKeySessionPromise={},t.setMediaKeysQueue=d.CDMCleanupPromise?[d.CDMCleanupPromise]:[],t.onMediaEncrypted=function(i){var a=i.initDataType,h=i.initData,g='"'+i.type+'" event: init data type: "'+a+'"';if(t.debug(g),h!==null){if(!t.keyFormatPromise){var m=Object.keys(t.keySystemAccessPromises);m.length||(m=Is(t.config));var p=m.map(Zn).filter(function(E){return!!E});t.keyFormatPromise=t.getKeyFormatPromise(p)}t.keyFormatPromise.then(function(E){var x=zn(E),I,R;if(a==="sinf"){if(x!==Qe.FAIRPLAY){t.warn('Ignoring unexpected "'+i.type+'" event with init data type: "'+a+'" for selected key-system '+x);return}var _=At(new Uint8Array(h));try{var P=jn(JSON.parse(_).sinf),O=dl(P);if(!O)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");I=new Uint8Array(O.subarray(8,24)),R=Qe.FAIRPLAY}catch(ge){t.warn(g+" Failed to parse sinf: "+ge);return}}else{if(x!==Qe.WIDEVINE&&x!==Qe.PLAYREADY){t.warn('Ignoring unexpected "'+i.type+'" event with init data type: "'+a+'" for selected key-system '+x);return}var N=Nc(h),U=N.filter(function(ge){return!!ge.systemId&&Qn(ge.systemId)===x});U.length>1&&t.warn(g+" Using first of "+U.length+" pssh found for selected key-system "+x);var B=U[0];if(!B){N.length===0||N.some(function(ge){return!ge.systemId})?t.warn(g+" contains incomplete or invalid pssh data"):t.log("ignoring "+g+" for "+N.map(function(ge){return Qn(ge.systemId)}).join(",")+" pssh data in favor of playlist keys");return}if(R=Qn(B.systemId),B.version===0&&B.data)if(R===Qe.WIDEVINE){var G=B.data.length-22;I=new Uint8Array(B.data.subarray(G,G+16))}else R===Qe.PLAYREADY&&(I=Wl(B.data))}if(!(!R||!I)){for(var Y=dt.hexDump(I),V=t,j=V.keyIdToKeySessionPromise,ae=V.mediaKeySessions,X=j[Y],W=function(){var ce=ae[oe],he=ce.decryptdata;if(!he.keyId)return 0;var ye=dt.hexDump(he.keyId);if(Y===ye||he.uri.replace(/-/g,"").indexOf(Y)!==-1)return X=j[ye],he.pssh||(delete j[ye],he.pssh=new Uint8Array(h),he.keyId=I,X=j[Y]=X.then(function(){return t.generateRequestWithPreferredKeySession(ce,a,h,"encrypted-event-key-match")}),X.catch(function(Se){return t.handleError(Se)})),1},J,oe=0;oe<ae.length&&(J=W(),!(J!==0&&J===1));oe++);if(!X){if(R!==x){t.log('Ignoring "'+i.type+'" event with '+R+" init data for selected key-system "+x);return}X=j[Y]=t.getKeySystemSelectionPromise([R]).then(function(ge){var ce,he=ge.keySystem,ye=ge.mediaKeys;t.throwIfDestroyed();var Se=new Jn("ISO-23001-7",Y,(ce=Zn(he))!=null?ce:"");return Se.pssh=new Uint8Array(h),Se.keyId=I,t.attemptSetMediaKeys(he,ye).then(function(){t.throwIfDestroyed();var Le=t.createMediaKeySessionContext({decryptdata:Se,keySystem:he,mediaKeys:ye});return t.generateRequestWithPreferredKeySession(Le,a,h,"encrypted-event-no-match")})}),X.catch(function(ge){return t.handleError(ge)})}}})}},t.onWaitingForKey=function(i){t.log('"'+i.type+'" event')},t.hls=s,t.config=s.config,t.registerListeners(),t}b(d,u);var o=d.prototype;return o.destroy=function(){var t=this.media;this.unregisterListeners(),this.onMediaDetached(),this._clear(t);var i=this.config;i.requestMediaKeySystemAccessFunc=null,i.licenseXhrSetup=i.licenseResponseCallback=void 0,i.drmSystems=i.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null},o.registerListeners=function(){this.hls.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(k.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(k.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(k.MANIFEST_LOADED,this.onManifestLoaded,this)},o.unregisterListeners=function(){this.hls.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(k.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(k.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(k.MANIFEST_LOADED,this.onManifestLoaded,this)},o.getLicenseServerUrl=function(t){var i=this.config,a=i.drmSystems,h=i.widevineLicenseUrl,g=a[t];if(g)return g.licenseUrl;if(t===Qe.WIDEVINE&&h)return h},o.getLicenseServerUrlOrThrow=function(t){var i=this.getLicenseServerUrl(t);if(i===void 0)throw new Error('no license server URL configured for key-system "'+t+'"');return i},o.getServerCertificateUrl=function(t){var i=this.config.drmSystems,a=i[t];if(a)return a.serverCertificateUrl;this.log('No Server Certificate in config.drmSystems["'+t+'"]')},o.attemptKeySystemAccess=function(t){var i=this,a=this.hls.levels,h=function(E,x,I){return!!E&&I.indexOf(E)===x},g=a.map(function(p){return p.audioCodec}).filter(h),m=a.map(function(p){return p.videoCodec}).filter(h);return g.length+m.length===0&&m.push("avc1.42e01e"),new Promise(function(p,E){var x=function(R){var _=R.shift();i.getMediaKeysPromise(_,g,m).then(function(P){return p({keySystem:_,mediaKeys:P})}).catch(function(P){R.length?x(R):P instanceof qt?E(P):E(new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_NO_ACCESS,error:P,fatal:!0},P.message))})};x(t)})},o.requestMediaKeySystemAccess=function(t,i){var a=this.config.requestMediaKeySystemAccessFunc;if(typeof a!="function"){var h="Configured requestMediaKeySystemAccess is not a function "+a;return Yl===null&&self.location.protocol==="http:"&&(h="navigator.requestMediaKeySystemAccess is not available over insecure protocol "+location.protocol),Promise.reject(new Error(h))}return a(t,i)},o.getMediaKeysPromise=function(t,i,a){var h=this,g=_g(t,i,a,this.config.drmSystemOptions),m=this.keySystemAccessPromises[t],p=m==null?void 0:m.keySystemAccess;if(!p){this.log('Requesting encrypted media "'+t+'" key-system access with config: '+at(g)),p=this.requestMediaKeySystemAccess(t,g);var E=this.keySystemAccessPromises[t]={keySystemAccess:p};return p.catch(function(x){h.log('Failed to obtain access to key-system "'+t+'": '+x)}),p.then(function(x){h.log('Access for key-system "'+x.keySystem+'" obtained');var I=h.fetchServerCertificate(t);return h.log('Create media-keys for "'+t+'"'),E.mediaKeys=x.createMediaKeys().then(function(R){return h.log('Media-keys created for "'+t+'"'),I.then(function(_){return _?h.setMediaKeysServerCertificate(R,t,_):R})}),E.mediaKeys.catch(function(R){h.error('Failed to create media-keys for "'+t+'"}: '+R)}),E.mediaKeys})}return p.then(function(){return m.mediaKeys})},o.createMediaKeySessionContext=function(t){var i=t.decryptdata,a=t.keySystem,h=t.mediaKeys;this.log('Creating key-system session "'+a+'" keyId: '+dt.hexDump(i.keyId||[]));var g=h.createSession(),m={decryptdata:i,keySystem:a,mediaKeys:h,mediaKeysSession:g,keyStatus:"status-pending"};return this.mediaKeySessions.push(m),m},o.renewKeySession=function(t){var i=t.decryptdata;if(i.pssh){var a=this.createMediaKeySessionContext(t),h=this.getKeyIdString(i),g="cenc";this.keyIdToKeySessionPromise[h]=this.generateRequestWithPreferredKeySession(a,g,i.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)},o.getKeyIdString=function(t){if(!t)throw new Error("Could not read keyId of undefined decryptdata");if(t.keyId===null)throw new Error("keyId is null");return dt.hexDump(t.keyId)},o.updateKeySession=function(t,i){var a,h=t.mediaKeysSession;return this.log('Updating key-session "'+h.sessionId+'" for keyID '+dt.hexDump(((a=t.decryptdata)==null?void 0:a.keyId)||[])+`
      } (data length: `+(i&&i.byteLength)+")"),h.update(i)},o.selectKeySystemFormat=function(t){var i=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: "+t.sn+" "+t.type+": "+t.level+") key formats "+i.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(i)),this.keyFormatPromise},o.getKeyFormatPromise=function(t){var i=this;return new Promise(function(a,h){var g=Is(i.config),m=t.map(zn).filter(function(p){return!!p&&g.indexOf(p)!==-1});return i.getKeySystemSelectionPromise(m).then(function(p){var E=p.keySystem,x=Zn(E);x?a(x):h(new Error('Unable to find format for key-system "'+E+'"'))}).catch(h)})},o.loadKey=function(t){var i=this,a=t.keyInfo.decryptdata,h=this.getKeyIdString(a),g="(keyId: "+h+' format: "'+a.keyFormat+'" method: '+a.method+" uri: "+a.uri+")";this.log("Starting session for key "+g);var m=this.keyIdToKeySessionPromise[h];if(!m){m=this.getKeySystemForKeyPromise(a).then(function(E){var x=E.keySystem,I=E.mediaKeys;return i.throwIfDestroyed(),i.log("Handle encrypted media sn: "+t.frag.sn+" "+t.frag.type+": "+t.frag.level+" using key "+g),i.attemptSetMediaKeys(x,I).then(function(){return i.throwIfDestroyed(),i.createMediaKeySessionContext({keySystem:x,mediaKeys:I,decryptdata:a})})});var p=this.keyIdToKeySessionPromise[h]=m.then(function(E){var x="cenc",I=a.pssh?a.pssh.buffer:null;return i.generateRequestWithPreferredKeySession(E,x,I,"playlist-key")});p.catch(function(E){return i.handleError(E)})}return m},o.throwIfDestroyed=function(t){if(!this.hls)throw new Error("invalid state")},o.handleError=function(t){this.hls&&(this.error(t.message),t instanceof qt?this.hls.trigger(k.ERROR,t.data):this.hls.trigger(k.ERROR,{type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))},o.getKeySystemForKeyPromise=function(t){var i=this.getKeyIdString(t),a=this.keyIdToKeySessionPromise[i];if(!a){var h=zn(t.keyFormat),g=h?[h]:Is(this.config);return this.attemptKeySystemAccess(g)}return a},o.getKeySystemSelectionPromise=function(t){if(t.length||(t=Is(this.config)),t.length===0)throw new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options "+at({drmSystems:this.config.drmSystems}));return this.attemptKeySystemAccess(t)},o.attemptSetMediaKeys=function(t,i){var a=this,h=this.setMediaKeysQueue.slice();this.log('Setting media-keys for "'+t+'"');var g=Promise.all(h).then(function(){if(!a.media)throw new Error("Attempted to set mediaKeys without media element attached");return a.media.setMediaKeys(i)});return this.setMediaKeysQueue.push(g),g.then(function(){a.log('Media-keys set for "'+t+'"'),h.push(g),a.setMediaKeysQueue=a.setMediaKeysQueue.filter(function(m){return h.indexOf(m)===-1})})},o.generateRequestWithPreferredKeySession=function(t,i,a,h){var g,m,p=this,E=(g=this.config.drmSystems)==null||(m=g[t.keySystem])==null?void 0:m.generateRequest;if(E)try{var x=E.call(this.hls,i,a,t);if(!x)throw new Error("Invalid response from configured generateRequest filter");i=x.initDataType,a=x.initData?x.initData:null,t.decryptdata.pssh=a?new Uint8Array(a):null}catch(U){var I;if(this.warn(U.message),(I=this.hls)!=null&&I.config.debug)throw U}if(a===null)return this.log('Skipping key-session request for "'+h+'" (no initData)'),Promise.resolve(t);var R=this.getKeyIdString(t.decryptdata);this.log('Generating key-session request for "'+h+'": '+R+" (init data type: "+i+" length: "+(a?a.byteLength:null)+")");var _=new Ee,P=t._onmessage=function(U){var B=t.mediaKeysSession;if(!B){_.emit("error",new Error("invalid state"));return}var G=U.messageType,Y=U.message;p.log('"'+G+'" message event for session "'+B.sessionId+'" message size: '+Y.byteLength),G==="license-request"||G==="license-renewal"?p.renewLicense(t,Y).catch(function(V){_.eventNames().length?_.emit("error",V):p.handleError(V)}):G==="license-release"?t.keySystem===Qe.FAIRPLAY&&(p.updateKeySession(t,Xn("acknowledged")),p.removeSession(t)):p.warn('unhandled media key message type "'+G+'"')},O=t._onkeystatuseschange=function(U){var B=t.mediaKeysSession;if(!B){_.emit("error",new Error("invalid state"));return}p.onKeyStatusChange(t);var G=t.keyStatus;_.emit("keyStatus",G),G==="expired"&&(p.warn(t.keySystem+" expired for key "+R),p.renewKeySession(t))};t.mediaKeysSession.addEventListener("message",P),t.mediaKeysSession.addEventListener("keystatuseschange",O);var N=new Promise(function(U,B){_.on("error",B),_.on("keyStatus",function(G){G.startsWith("usable")?U():G==="output-restricted"?B(new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):G==="internal-error"?B(new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},'key status changed to "'+G+'"')):G==="expired"?B(new Error("key expired while generating request")):p.warn('unhandled key status change "'+G+'"')})});return t.mediaKeysSession.generateRequest(i,a).then(function(){var U;p.log('Request generated for key-session "'+((U=t.mediaKeysSession)==null?void 0:U.sessionId)+'" keyId: '+R)}).catch(function(U){throw new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_NO_SESSION,error:U,fatal:!1},"Error generating key-session request: "+U)}).then(function(){return N}).catch(function(U){throw _.removeAllListeners(),p.removeSession(t),U}).then(function(){return _.removeAllListeners(),t})},o.onKeyStatusChange=function(t){var i=this;t.mediaKeysSession.keyStatuses.forEach(function(a,h){i.log('key status change "'+a+'" for keyStatuses keyId: '+dt.hexDump("buffer"in h?new Uint8Array(h.buffer,h.byteOffset,h.byteLength):new Uint8Array(h))+" session keyId: "+dt.hexDump(new Uint8Array(t.decryptdata.keyId||[]))+" uri: "+t.decryptdata.uri),t.keyStatus=a})},o.fetchServerCertificate=function(t){var i=this.config,a=i.loader,h=new a(i),g=this.getServerCertificateUrl(t);return g?(this.log('Fetching server certificate for "'+t+'"'),new Promise(function(m,p){var E={responseType:"arraybuffer",url:g},x=i.certLoadPolicy.default,I={loadPolicy:x,timeout:x.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},R={onSuccess:function(P,O,N,U){m(P.data)},onError:function(P,O,N,U){p(new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:N,response:F({url:E.url,data:void 0},P)},'"'+t+'" certificate request failed ('+g+"). Status: "+P.code+" ("+P.text+")"))},onTimeout:function(P,O,N){p(new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:N,response:{url:E.url,data:void 0}},'"'+t+'" certificate request timed out ('+g+")"))},onAbort:function(P,O,N){p(new Error("aborted"))}};h.load(E,I,R)})):Promise.resolve()},o.setMediaKeysServerCertificate=function(t,i,a){var h=this;return new Promise(function(g,m){t.setServerCertificate(a).then(function(p){h.log("setServerCertificate "+(p?"success":"not supported by CDM")+" ("+(a==null?void 0:a.byteLength)+') on "'+i+'"'),g(t)}).catch(function(p){m(new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:p,fatal:!0},p.message))})})},o.renewLicense=function(t,i){var a=this;return this.requestLicense(t,new Uint8Array(i)).then(function(h){return a.updateKeySession(t,new Uint8Array(h)).catch(function(g){throw new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:g,fatal:!0},g.message)})})},o.unpackPlayReadyKeyMessage=function(t,i){var a=String.fromCharCode.apply(null,new Uint16Array(i.buffer));if(!a.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),i;var h=new DOMParser().parseFromString(a,"application/xml"),g=h.querySelectorAll("HttpHeader");if(g.length>0)for(var m,p=0,E=g.length;p<E;p++){var x,I;m=g[p];var R=(x=m.querySelector("name"))==null?void 0:x.textContent,_=(I=m.querySelector("value"))==null?void 0:I.textContent;R&&_&&t.setRequestHeader(R,_)}var P=h.querySelector("Challenge"),O=P==null?void 0:P.textContent;if(!O)throw new Error("Cannot find <Challenge> in key message");return Xn(atob(O))},o.setupLicenseXHR=function(t,i,a,h){var g=this,m=this.config.licenseXhrSetup;return m?Promise.resolve().then(function(){if(!a.decryptdata)throw new Error("Key removed");return m.call(g.hls,t,i,a,h)}).catch(function(p){if(!a.decryptdata)throw p;return t.open("POST",i,!0),m.call(g.hls,t,i,a,h)}).then(function(p){t.readyState||t.open("POST",i,!0);var E=p||h;return{xhr:t,licenseChallenge:E}}):(t.open("POST",i,!0),Promise.resolve({xhr:t,licenseChallenge:h}))},o.requestLicense=function(t,i){var a=this,h=this.config.keyLoadPolicy.default;return new Promise(function(g,m){var p=a.getLicenseServerUrlOrThrow(t.keySystem);a.log("Sending license request to URL: "+p);var E=new XMLHttpRequest;E.responseType="arraybuffer",E.onreadystatechange=function(){if(!a.hls||!t.mediaKeysSession)return m(new Error("invalid state"));if(E.readyState===4)if(E.status===200){a._requestLicenseFailureCount=0;var x=E.response;a.log("License received "+(x instanceof ArrayBuffer?x.byteLength:x));var I=a.config.licenseResponseCallback;if(I)try{x=I.call(a.hls,E,p,t)}catch(O){a.error(O)}g(x)}else{var R=h.errorRetry,_=R?R.maxNumRetry:0;if(a._requestLicenseFailureCount++,a._requestLicenseFailureCount>_||E.status>=400&&E.status<500)m(new qt({type:se.KEY_SYSTEM_ERROR,details:q.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:E,response:{url:p,data:void 0,code:E.status,text:E.statusText}},"License Request XHR failed ("+p+"). Status: "+E.status+" ("+E.statusText+")"));else{var P=_-a._requestLicenseFailureCount+1;a.warn("Retrying license request, "+P+" attempts left"),a.requestLicense(t,i).then(g,m)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=E,a.setupLicenseXHR(E,p,t,i).then(function(x){var I=x.xhr,R=x.licenseChallenge;t.keySystem==Qe.PLAYREADY&&(R=a.unpackPlayReadyKeyMessage(I,R)),I.send(R)})})},o.onMediaAttached=function(t,i){if(this.config.emeEnabled){var a=i.media;this.media=a,a.removeEventListener("encrypted",this.onMediaEncrypted),a.removeEventListener("waitingforkey",this.onWaitingForKey),a.addEventListener("encrypted",this.onMediaEncrypted),a.addEventListener("waitingforkey",this.onWaitingForKey)}},o.onMediaDetached=function(){var t=this.media;t&&(t.removeEventListener("encrypted",this.onMediaEncrypted),t.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null)},o._clear=function(t){var i=this,a,h=this.mediaKeySessions;this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Jn.clearKeyUriToKeyIdMap();var g=h.length;d.CDMCleanupPromise=Promise.all(h.map(function(m){return i.removeSession(m)}).concat(t==null||(a=t.setMediaKeys(null))==null?void 0:a.catch(function(m){var p;i.log("Could not clear media keys: "+m),(p=i.hls)==null||p.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error("Could not clear media keys: "+m)})}))).then(function(){g&&(i.log("finished closing key sessions and clearing media keys"),h.length=0)}).catch(function(m){var p;i.log("Could not close sessions and clear media keys: "+m),(p=i.hls)==null||p.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error("Could not close sessions and clear media keys: "+m)})})},o.onManifestLoading=function(){this.keyFormatPromise=null},o.onManifestLoaded=function(t,i){var a=i.sessionKeys;if(!(!a||!this.config.emeEnabled)&&!this.keyFormatPromise){var h=a.reduce(function(g,m){return g.indexOf(m.keyFormat)===-1&&g.push(m.keyFormat),g},[]);this.log("Selecting key-system from session-keys "+h.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(h)}},o.removeSession=function(t){var i=this,a=t.mediaKeysSession,h=t.licenseXhr;if(a){this.log("Remove licenses and keys and close session "+a.sessionId),t._onmessage&&(a.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(a.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),h&&h.readyState!==XMLHttpRequest.DONE&&h.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;var g=this.mediaKeySessions.indexOf(t);return g>-1&&this.mediaKeySessions.splice(g,1),a.remove().catch(function(m){var p;i.log("Could not remove session: "+m),(p=i.hls)==null||p.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error("Could not remove session: "+m)})}).then(function(){return a.close()}).catch(function(m){var p;i.log("Could not close session: "+m),(p=i.hls)==null||p.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error("Could not close session: "+m)})})}},d}(st);ih.CDMCleanupPromise=void 0;var qt=function(u){function d(o,s){var t;return t=u.call(this,s)||this,t.data=void 0,o.error||(o.error=new Error(s)),t.data=o,o.err=o.error,t}return b(d,u),d}(Q(Error)),Gv=function(){function u(o){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=o,this.registerListeners()}var d=u.prototype;return d.setStreamController=function(s){this.streamController=s},d.registerListeners=function(){this.hls.on(k.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(k.MEDIA_DETACHING,this.onMediaDetaching,this)},d.unregisterListeners=function(){this.hls.off(k.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(k.MEDIA_DETACHING,this.onMediaDetaching,this)},d.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},d.onMediaAttaching=function(s,t){var i=this.hls.config;if(i.capLevelOnFPSDrop){var a=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=a,a&&typeof a.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}},d.onMediaDetaching=function(){this.media=null},d.checkFPS=function(s,t,i){var a=performance.now();if(t){if(this.lastTime){var h=a-this.lastTime,g=i-this.lastDroppedFrames,m=t-this.lastDecodedFrames,p=1e3*g/h,E=this.hls;if(E.trigger(k.FPS_DROP,{currentDropped:g,currentDecoded:m,totalDroppedFrames:i}),p>0&&g>E.config.fpsDroppedMonitoringThreshold*m){var x=E.currentLevel;E.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+x),x>0&&(E.autoLevelCapping===-1||E.autoLevelCapping>=x)&&(x=x-1,E.trigger(k.FPS_DROP_LEVEL_CAPPING,{level:x,droppedLevel:E.currentLevel}),E.autoLevelCapping=x,this.streamController.nextLevelSwitch())}}this.lastTime=a,this.lastDroppedFrames=i,this.lastDecodedFrames=t}},d.checkFPSInterval=function(){var s=this.media;if(s)if(this.isVideoPlaybackQualityAvailable){var t=s.getVideoPlaybackQuality();this.checkFPS(s,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(s,s.webkitDecodedFrameCount,s.webkitDroppedFrameCount)},u}();function Yi(u){for(var d=5381,o=u.length;o;)d=d*33^u.charCodeAt(--o);return(d>>>0).toString()}var gi=.025,Fs=function(u){return u[u.Point=0]="Point",u[u.Range=1]="Range",u}({});function $v(u,d,o){return u.identifier+"-"+(o+1)+"-"+Yi(d)}var Kv=function(){function u(o,s){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=s,this.dateRange=o,this.setDateRange(o)}var d=u.prototype;return d.setDateRange=function(s){this.dateRange=s,this.resumeOffset=s.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=s.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=s.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=s.attr.enumeratedStringList("X-SNAP",this.snapOptions)},d.reset=function(){var s;this.appendInPlaceStarted=!1,(s=this.assetListLoader)==null||s.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)},d.isAssetPastPlayoutLimit=function(s){if(s>=this.assetList.length)return!0;var t=this.playoutLimit;if(s<=0||isNaN(t))return!1;var i=this.assetList[s].startOffset;return i>t},d.findAssetIndex=function(s){var t=this.assetList.indexOf(s);return t},d.toString=function(){return Vv(this)},y(u,[{key:"identifier",get:function(){return this.dateRange.id}},{key:"startDate",get:function(){return this.dateRange.startDate}},{key:"startTime",get:function(){var s=this.dateRange.startTime;if(this.snapOptions.out){var t=this.dateRange.tagAnchor;if(t)return ba(s,t)}return s}},{key:"startOffset",get:function(){return this.cue.pre?0:this.startTime}},{key:"startIsAligned",get:function(){if(this.startTime===0||this.snapOptions.out)return!0;var s=this.dateRange.tagAnchor;if(s){var t=this.dateRange.startTime,i=ba(t,s);return t-i<.1}return!1}},{key:"resumptionOffset",get:function(){var s=this.resumeOffset,t=ue(s)?s:this.duration;return this.cumulativeDuration+t}},{key:"resumeTime",get:function(){var s=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){var t=this.resumeAnchor;if(t)return ba(s,t)}return s}},{key:"appendInPlace",get:function(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<gi))},set:function(s){if(this.appendInPlaceStarted){this.resetOnResume=!s;return}this.appendInPlaceDisabled=!s}},{key:"timelineStart",get:function(){return this._timelineStart!==null?this._timelineStart:this.startTime},set:function(s){this._timelineStart=s}},{key:"duration",get:function(){var s=this.playoutLimit,t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(s)&&s<t&&(t=s),t},set:function(s){this._duration=s}},{key:"cue",get:function(){return this.dateRange.cue}},{key:"timelineOccupancy",get:function(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Fs.Range:Fs.Point}},{key:"supplementsPrimary",get:function(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}},{key:"contentMayVary",get:function(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}},{key:"assetUrl",get:function(){return this.dateRange.attr["X-ASSET-URI"]}},{key:"assetListUrl",get:function(){return this.dateRange.attr["X-ASSET-LIST"]}},{key:"baseUrl",get:function(){return this.base.url}},{key:"assetListLoaded",get:function(){return this.assetList.length>0||this.assetListResponse!==null}}])}();function ba(u,d){return u-d.start<d.duration/2&&!(Math.abs(u-(d.start+d.duration))<gi)?d.start:d.start+d.duration}function sh(u,d,o){var s=new self.URL(u,o);return s.protocol!=="data:"&&s.searchParams.set("_HLS_primary_id",d),s}function Vv(u){return'["'+u.identifier+'" '+(u.cue.pre?"<pre>":u.cue.post?"<post>":"")+u.timelineStart.toFixed(2)+"-"+u.resumeTime.toFixed(2)+"]"}function _a(u){var d=u.timelineStart,o=u.duration||0;return'["'+u.identifier+'" '+d.toFixed(2)+"-"+(d+o).toFixed(2)+"]"}var Hv=function(){function u(o,s,t,i){var a=this;this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=function(){var p=a.interstitial,E=p.playoutLimit,x=a.currentTime;a.startOffset+x>=E&&a.hls.trigger(k.PLAYOUT_LIMIT_REACHED,{})};var h=this.hls=new o(s);this.interstitial=t,this.assetItem=i;var g=i.uri;try{g=sh(g,h.sessionId).href}catch{}h.loadSource(g);var m=function(){a.hasDetails=!0};h.once(k.LEVEL_LOADED,m),h.once(k.AUDIO_TRACK_LOADED,m),h.once(k.SUBTITLE_TRACK_LOADED,m),h.on(k.MEDIA_ATTACHING,function(p,E){var x=E.media;a.removeMediaListeners(),a.mediaAttached=x;var I=a.interstitial;I.playoutLimit&&x.addEventListener("timeupdate",a.checkPlayout)})}var d=u.prototype;return d.bufferedInPlaceToEnd=function(s){var t;if(!this.interstitial.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!s||!this._bufferedEosTime)return!1;var i=this.timelineOffset,a=We.bufferInfo(s,i,0),h=this.getAssetTime(a.end);return h>=this._bufferedEosTime-.02},d.getAssetTime=function(s){var t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,s-t),i)},d.removeMediaListeners=function(){var s=this.mediaAttached;s&&(this._currentTime=s.currentTime,this.bufferSnapShot(),s.removeEventListener("timeupdate",this.checkPlayout))},d.bufferSnapShot=function(){if(this.mediaAttached){var s;(s=this.hls)!=null&&s.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}},d.destroy=function(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null},d.attachMedia=function(s){this.hls.attachMedia(s)},d.detachMedia=function(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()},d.resumeBuffering=function(){this.hls.resumeBuffering()},d.pauseBuffering=function(){this.hls.pauseBuffering()},d.transferMedia=function(){return this.bufferSnapShot(),this.hls.transferMedia()},d.on=function(s,t,i){this.hls.on(s,t)},d.once=function(s,t,i){this.hls.once(s,t)},d.off=function(s,t,i){this.hls.off(s,t)},d.toString=function(){var s,t;return"HlsAssetPlayer: "+_a(this.assetItem)+" "+((s=this.hls)==null?void 0:s.sessionId)+" "+((t=this.interstitial)!=null&&t.appendInPlace?"append-in-place":"")},y(u,[{key:"destroyed",get:function(){var s;return!((s=this.hls)!=null&&s.userConfig)}},{key:"assetId",get:function(){return this.assetItem.identifier}},{key:"interstitialId",get:function(){return this.assetItem.parentIdentifier}},{key:"media",get:function(){var s;return((s=this.hls)==null?void 0:s.media)||null}},{key:"bufferedEnd",get:function(){var s=this.media||this.mediaAttached;if(!s)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;var t=We.bufferInfo(s,s.currentTime,.001);return this.getAssetTime(t.end)}},{key:"currentTime",get:function(){var s=this.media||this.mediaAttached;return s?this.getAssetTime(s.currentTime):this._currentTime||0}},{key:"duration",get:function(){var s=this.assetItem.duration;return s||0}},{key:"remaining",get:function(){var s=this.duration;return s?Math.max(0,s-this.currentTime):0}},{key:"startOffset",get:function(){return this.assetItem.startOffset}},{key:"timelineOffset",get:function(){var s;return((s=this.hls)==null?void 0:s.config.timelineOffset)||0},set:function(s){var t=this.timelineOffset;if(s!==t){var i=s-t;if(Math.abs(i)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=s}}}}])}(),nh=.033,Yv=function(u){function d(s,t){var i;return i=u.call(this,"interstitials-sched",t)||this,i.onScheduleUpdate=void 0,i.eventMap={},i.events=null,i.items=null,i.durations={primary:0,playout:0,integrated:0},i.onScheduleUpdate=s,i}b(d,u);var o=d.prototype;return o.destroy=function(){this.reset(),this.onScheduleUpdate=null},o.reset=function(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(function(t){return t.reset()}),this.events=this.items=null},o.resetErrorsInRange=function(t,i){return this.events?this.events.reduce(function(a,h){return t<=h.startOffset&&i>h.startOffset?(delete h.error,a+1):a},0):0},o.getEvent=function(t){return t&&this.eventMap[t]||null},o.hasEvent=function(t){return t in this.eventMap},o.findItemIndex=function(t,i){if(t.event)return this.findEventIndex(t.event.identifier);var a=-1;t.nextEvent?a=this.findEventIndex(t.nextEvent.identifier)-1:t.previousEvent&&(a=this.findEventIndex(t.previousEvent.identifier)+1);var h=this.items;if(h)for(h[a]||(i===void 0&&(i=t.start),a=this.findItemIndexAtTime(i));a>=0&&(g=h[a])!=null&&g.event;){var g;a--}return a},o.findItemIndexAtTime=function(t,i){var a=this.items;if(a)for(var h=0;h<a.length;h++){var g=a[h];if(i&&i!=="primary"&&(g=g[i]),t===g.start||t>g.start&&t<g.end)return h}return-1},o.findJumpRestrictedIndex=function(t,i){var a=this.items;if(a)for(var h=t;h<=i&&a[h];h++){var g=a[h].event;if(g!=null&&g.restrictions.jump&&!g.appendInPlace)return h}return-1},o.findEventIndex=function(t){var i=this.items;if(i)for(var a=i.length;a--;){var h;if(((h=i[a].event)==null?void 0:h.identifier)===t)return a}return-1},o.findAssetIndex=function(t,i){var a=t.assetList,h=a.length;if(h>1)for(var g=0;g<h;g++){var m=a[g];if(!m.error){var p=m.timelineStart;if(i===p||i>p&&i<p+(m.duration||0))return g}}return 0},o.parseInterstitialDateRanges=function(t,i){var a=this,h=t.main.details,g=h.dateRanges,m=this.events,p=this.parseDateRanges(g,{url:h.url},i),E=Object.keys(g),x=m?m.filter(function(I){return!E.includes(I.identifier)}):[];p.length&&p.sort(function(I,R){var _=I.cue.pre,P=I.cue.post,O=R.cue.pre,N=R.cue.post;if(_&&!O)return-1;if(O&&!_||P&&!N)return 1;if(N&&!P)return-1;if(!_&&!O&&!P&&!N){var U=I.startTime,B=R.startTime;if(U!==B)return U-B}return I.dateRange.tagOrder-R.dateRange.tagOrder}),this.events=p,x.forEach(function(I){a.removeEvent(I)}),this.updateSchedule(t,x)},o.updateSchedule=function(t,i){i===void 0&&(i=[]);var a=this.events||[];if(a.length||i.length||this.length<2){var h=this.items,g=this.parseSchedule(a,t),m=i.length||(h==null?void 0:h.length)!==g.length||g.some(function(p,E){return Math.abs(p.playout.start-h[E].playout.start)>.005||Math.abs(p.playout.end-h[E].playout.end)>.005});m&&(this.items=g,this.onScheduleUpdate(i,h))}},o.parseDateRanges=function(t,i,a){for(var h=[],g=Object.keys(t),m=0;m<g.length;m++){var p=g[m],E=t[p];if(E.isInterstitial){var x=this.eventMap[p];x?x.setDateRange(E):(x=new Kv(E,i),this.eventMap[p]=x,a===!1&&(x.appendInPlace=a)),h.push(x)}}return h},o.parseSchedule=function(t,i){var a=[],h=i.main.details,g=h.live?1/0:h.edge,m=0;if(t=t.filter(function(N){return!N.error&&!(N.cue.once&&N.hasPlayed)}),t.length){this.resolveOffsets(t,i);var p=0,E=0;if(t.forEach(function(N,U){var B=N.cue.pre,G=N.cue.post,Y=t[U-1]||null,V=N.appendInPlace,j=G?g:N.startOffset,ae=N.duration,X=N.timelineOccupancy===Fs.Range?ae:0,W=N.resumptionOffset,J=(Y==null?void 0:Y.startTime)===j,oe=j+N.cumulativeDuration,ge=V?oe+ae:j+W;if(B||!G&&j<=0){var ce=E;E+=X,N.timelineStart=oe;var he=m;m+=ae,a.push({event:N,start:oe,end:ge,playout:{start:he,end:m},integrated:{start:ce,end:E}})}else if(j<=g){if(!J){var ye=j-p;if(ye>nh){var Se=p,Le=E;E+=ye;var Ie=m;m+=ye;var He={previousEvent:t[U-1]||null,nextEvent:N,start:Se,end:Se+ye,playout:{start:Ie,end:m},integrated:{start:Le,end:E}};a.push(He)}else ye>0&&Y&&(Y.cumulativeDuration+=ye,a[a.length-1].end=j)}G&&(ge=oe),N.timelineStart=oe;var Oe=E;E+=X;var je=m;m+=ae,a.push({event:N,start:oe,end:ge,playout:{start:je,end:m},integrated:{start:Oe,end:E}})}else return;var Fe=N.resumeTime;G||Fe>g?p=g:p=Fe}),p<g){var x,I=p,R=E,_=g-p;E+=_;var P=m;m+=_,a.push({previousEvent:((x=a[a.length-1])==null?void 0:x.event)||null,nextEvent:null,start:p,end:I+_,playout:{start:P,end:m},integrated:{start:R,end:E}})}this.setDurations(g,m,E)}else{var O=0;a.push({previousEvent:null,nextEvent:null,start:O,end:g,playout:{start:O,end:g},integrated:{start:O,end:g}}),this.setDurations(g,g,g)}return a},o.setDurations=function(t,i,a){this.durations={primary:t,playout:i,integrated:a}},o.resolveOffsets=function(t,i){var a=this,h=i.main.details,g=h.live?1/0:h.edge,m=0,p=-1;t.forEach(function(E,x){var I=E.cue.pre,R=E.cue.post,_=I?0:R?g:E.startTime;a.updateAssetDurations(E);var P=p===_;if(P?E.cumulativeDuration=m:(m=0,p=_),!R&&E.snapOptions.in&&(E.resumeAnchor=Xr(null,h.fragments,E.startOffset+E.resumptionOffset,0,0)||void 0),E.appendInPlace&&!E.appendInPlaceStarted){var O=a.primaryCanResumeInPlaceAt(E,i);O||(E.appendInPlace=!1)}if(!E.appendInPlace&&x+1<t.length){var N=t[x+1].startTime-t[x].resumeTime;N<nh&&(t[x+1].appendInPlace=!1,t[x+1].appendInPlace&&a.warn("Could not change append strategy for abutting event "+E))}var U=ue(E.resumeOffset)?E.resumeOffset:E.duration;m+=U})},o.primaryCanResumeInPlaceAt=function(t,i){var a=this,h=t.resumeTime,g=t.startTime+t.resumptionOffset;if(Math.abs(h-g)>gi)return this.log('"'+t.identifier+'" resumption '+h+" not aligned with estimated timeline end "+g),!1;if(!i)return this.log('"'+t.identifier+'" resumption '+h+" can not be aligned with media (none selected)"),!1;var m=Object.keys(i);return!m.some(function(p){var E=i[p].details,x=E.edge;if(h>=x)return a.log('"'+t.identifier+'" resumption '+h+" past "+p+" playlist end "+x),!1;var I=Xr(null,E.fragments,h);if(!I)return a.log('"'+t.identifier+'" resumption '+h+" does not align with any fragments in "+p+" playlist ("+E.fragStart+"-"+E.fragmentEnd+")"),!0;var R=p==="audio"?.175:0,_=Math.abs(I.start-h)<gi+R||Math.abs(I.end-h)<gi+R;return _?!1:(a.log('"'+t.identifier+'" resumption '+h+" not aligned with "+p+" fragment bounds ("+I.start+"-"+I.end+" sn: "+I.sn+" cc: "+I.cc+")"),!0)})},o.updateAssetDurations=function(t){if(t.assetListLoaded){var i=t.timelineStart,a=0,h=!1,g=!1;t.assetList.forEach(function(m,p){var E=i+a;m.startOffset=a,m.timelineStart=E,h||(h=m.duration===null),g||(g=!!m.error);var x=m.error?0:m.duration||0;a+=x}),h&&!g?t.duration=Math.max(a,t.duration):t.duration=a}},o.removeEvent=function(t){t.reset(),delete this.eventMap[t.identifier]},y(d,[{key:"duration",get:function(){var t=this.items;return t?t[t.length-1].end:0}},{key:"length",get:function(){return this.items?this.items.length:0}},{key:"assetIdAtEnd",get:function(){var t,i,a=(t=this.items)==null||(i=t[this.length-1])==null?void 0:i.event;if(a){var h=a.assetList,g=h[h.length-1];if(g)return g.identifier}return null}}])}(st);function Or(u){return"["+(u.event?'"'+u.event.identifier+'"':"primary")+": "+u.start.toFixed(2)+"-"+u.end.toFixed(2)+"]"}var Wv=function(){function u(o){this.hls=void 0,this.hls=o}var d=u.prototype;return d.destroy=function(){this.hls=null},d.loadAssetList=function(s,t){var i=this,a=s.assetListUrl,h;try{h=sh(a,this.hls.sessionId,s.baseUrl)}catch(P){var g=this.assignAssetListError(s,q.ASSET_LIST_LOAD_ERROR,P,a);this.hls.trigger(k.ERROR,g);return}t&&h.protocol!=="data:"&&h.searchParams.set("_HLS_start_offset",""+t);var m=this.hls.config,p=m.loader,E=new p(m),x={responseType:"json",url:h.href},I=m.interstitialAssetListLoadPolicy.default,R={loadPolicy:I,timeout:I.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},_={onSuccess:function(O,N,U,B){var G=O.data,Y=G==null?void 0:G.ASSETS;if(!Array.isArray(Y)){var V=i.assignAssetListError(s,q.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),U.url,N,B);i.hls.trigger(k.ERROR,V);return}s.assetListResponse=G,i.hls.trigger(k.ASSET_LIST_LOADED,{event:s,assetListResponse:G,networkDetails:B})},onError:function(O,N,U,B){var G=i.assignAssetListError(s,q.ASSET_LIST_LOAD_ERROR,new Error("Error loading X-ASSET-LIST: HTTP status "+O.code+" "+O.text+" ("+N.url+")"),N.url,B,U);i.hls.trigger(k.ERROR,G)},onTimeout:function(O,N,U){var B=i.assignAssetListError(s,q.ASSET_LIST_LOAD_TIMEOUT,new Error("Timeout loading X-ASSET-LIST ("+N.url+")"),N.url,O,U);i.hls.trigger(k.ERROR,B)}};return E.load(x,R,_),this.hls.trigger(k.ASSET_LIST_LOADING,{event:s}),E},d.assignAssetListError=function(s,t,i,a,h,g){return s.error=i,{type:se.NETWORK_ERROR,details:t,fatal:!1,interstitial:s,url:a,error:i,networkDetails:g,stats:h}},u}();function xr(u,d,o){hr(u,d,o),u.addEventListener(d,o)}function hr(u,d,o){u.removeEventListener(d,o)}function ah(u){u==null||u.play().catch(function(){})}var qv=function(u){function d(s,t){var i;return i=u.call(this,"interstitials",s.logger)||this,i.HlsPlayerClass=void 0,i.hls=void 0,i.assetListLoader=void 0,i.mediaSelection=null,i.altSelection=null,i.media=null,i.detachedData=null,i.requiredTracks=null,i.manager=null,i.playerQueue=[],i.bufferedPos=-1,i.timelinePos=-1,i.schedule=void 0,i.playingItem=null,i.bufferingItem=null,i.waitingItem=null,i.endedItem=null,i.playingAsset=null,i.endedAsset=null,i.bufferingAsset=null,i.shouldPlay=!1,i.onPlay=function(){i.shouldPlay=!0},i.onPause=function(){i.shouldPlay=!1},i.onSeeking=function(){var a=i.currentTime;if(!(a===void 0||i.playbackDisabled)){var h=a-i.timelinePos,g=Math.abs(h)<1/7056e5;if(!g){var m=h<=-.01;i.timelinePos=a,i.bufferedPos=a;var p=i.playingItem;if(!p){i.checkBuffer();return}if(m){var E=i.schedule.resetErrorsInRange(a,a-h);E&&i.updateSchedule()}if(i.checkBuffer(),m&&a<p.start||a>=p.end){var x,I=i.schedule.findItemIndexAtTime(i.timelinePos);if(!i.isInterstitial(p)&&(x=i.media)!=null&&x.paused&&(i.shouldPlay=!1),!m){var R=i.findItemIndex(p);if(I>R){var _=i.schedule.findJumpRestrictedIndex(R+1,I);if(_>R){i.setSchedulePosition(_);return}}}i.setSchedulePosition(I);return}var P=i.playingAsset;if(!P){if(i.playingLastItem&&i.isInterstitial(p)){var O=p.event.assetList[0];O&&(i.endedItem=i.playingItem,i.playingItem=null,i.setScheduleToAssetAtTime(a,O))}return}var N=P.timelineStart,U=P.duration||0;(m&&a<N||a>=N+U)&&i.setScheduleToAssetAtTime(a,P)}}},i.onTimeupdate=function(){var a=i.currentTime;if(!(a===void 0||i.playbackDisabled)){if(a>i.timelinePos)i.timelinePos=a,a>i.bufferedPos&&i.checkBuffer();else return;var h=i.playingItem;if(!(!h||i.playingLastItem)){if(a>=h.end){i.timelinePos=h.end;var g=i.findItemIndex(h);i.setSchedulePosition(g+1)}var m=i.playingAsset;if(m){var p=m.timelineStart+(m.duration||0);a>=p&&i.setScheduleToAssetAtTime(a,m)}}}},i.onScheduleUpdate=function(a,h){var g=i.schedule,m=i.playingItem,p=g.events||[],E=g.items||[],x=g.durations,I=a.map(function(N){return N.identifier}),R=!!(p.length||I.length);if(R&&i.log("INTERSTITIALS_UPDATED ("+p.length+"): "+p+`
Schedule: `+E.map(function(N){return Or(N)})),I.length&&i.log("Removed events "+I),i.playerQueue.forEach(function(N){if(N.interstitial.appendInPlace){var U=N.assetItem.timelineStart,B=N.timelineOffset-U;if(B)try{N.timelineOffset=U}catch(G){Math.abs(B)>gi&&i.warn(G+' ("'+N.assetId+'" '+N.timelineOffset+"->"+U+")")}}}),m){var _=i.updateItem(m,i.timelinePos);i.itemsMatch(m,_)&&(i.playingItem=_,i.waitingItem=i.endedItem=null)}else i.waitingItem=i.updateItem(i.waitingItem),i.endedItem=i.updateItem(i.endedItem);var P=i.bufferingItem;if(P){var O=i.updateItem(P,i.bufferedPos);i.itemsMatch(P,O)?i.bufferingItem=O:P.event&&(i.bufferingItem=i.playingItem,i.clearInterstitial(P.event,null))}if(a.forEach(function(N){N.assetList.forEach(function(U){i.clearAssetPlayer(U.identifier,null)})}),R||h){if(i.hls.trigger(k.INTERSTITIALS_UPDATED,{events:p.slice(0),schedule:E.slice(0),durations:x,removedIds:I}),i.isInterstitial(m)&&I.includes(m.event.identifier)){i.warn('Interstitial "'+m.event.identifier+'" removed while playing'),i.primaryFallback(m.event);return}i.checkBuffer()}},i.hls=s,i.HlsPlayerClass=t,i.assetListLoader=new Wv(s),i.schedule=new Yv(i.onScheduleUpdate,s.logger),i.registerListeners(),i}b(d,u);var o=d.prototype;return o.registerListeners=function(){var t=this.hls;t.on(k.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(k.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(k.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),t.on(k.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(k.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),t.on(k.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),t.on(k.ASSET_LIST_LOADED,this.onAssetListLoaded,this),t.on(k.BUFFER_APPENDED,this.onBufferAppended,this),t.on(k.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(k.BUFFERED_TO_END,this.onBufferedToEnd,this),t.on(k.MEDIA_ENDED,this.onMediaEnded,this),t.on(k.ERROR,this.onError,this),t.on(k.DESTROYING,this.onDestroying,this)},o.unregisterListeners=function(){var t=this.hls;t&&(t.off(k.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(k.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(k.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),t.off(k.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(k.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),t.off(k.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),t.off(k.ASSET_LIST_LOADED,this.onAssetListLoaded,this),t.off(k.BUFFER_CODECS,this.onBufferCodecs,this),t.off(k.BUFFER_APPENDED,this.onBufferAppended,this),t.off(k.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(k.BUFFERED_TO_END,this.onBufferedToEnd,this),t.off(k.MEDIA_ENDED,this.onMediaEnded,this),t.off(k.ERROR,this.onError,this),t.off(k.DESTROYING,this.onDestroying,this))},o.startLoad=function(){this.resumeBuffering()},o.stopLoad=function(){this.pauseBuffering()},o.resumeBuffering=function(){var t;(t=this.getBufferingPlayer())==null||t.resumeBuffering()},o.pauseBuffering=function(){var t;(t=this.getBufferingPlayer())==null||t.pauseBuffering()},o.destroy=function(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null},o.onDestroying=function(){var t=this.primaryMedia||this.media;t&&this.removeMediaListeners(t)},o.removeMediaListeners=function(t){hr(t,"play",this.onPlay),hr(t,"pause",this.onPause),hr(t,"seeking",this.onSeeking),hr(t,"timeupdate",this.onTimeupdate)},o.onMediaAttaching=function(t,i){var a=this.media=i.media;xr(a,"seeking",this.onSeeking),xr(a,"timeupdate",this.onTimeupdate),xr(a,"play",this.onPlay),xr(a,"pause",this.onPause)},o.onMediaAttached=function(t,i){var a=this.effectivePlayingItem,h=this.detachedData;if(this.detachedData=null,a===null)this.checkStart();else if(!h){this.clearScheduleState();var g=this.findItemIndex(a);this.setSchedulePosition(g)}},o.clearScheduleState=function(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null},o.onMediaDetaching=function(t,i){var a=!!i.transferMedia,h=this.media;if(this.media=null,!a&&(h&&this.removeMediaListeners(h),this.detachedData)){var g=this.getBufferingPlayer();g&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,g.detachMedia()),this.shouldPlay=!1}},o.isInterstitial=function(t){return!!(t!=null&&t.event)},o.retreiveMediaSource=function(t,i){var a=this.getAssetPlayer(t);a&&this.transferMediaFromPlayer(a,i)},o.transferMediaFromPlayer=function(t,i){var a=t.interstitial.appendInPlace,h=t.media;if(a&&h===this.primaryMedia){if(this.bufferingAsset=null,(!i||this.isInterstitial(i)&&!i.event.appendInPlace)&&i&&h){this.detachedData={media:h};return}var g=t.transferMedia();this.log("transfer MediaSource from "+t+" "+at(g)),this.detachedData=g}else i&&h&&(this.shouldPlay||(this.shouldPlay=!h.paused))},o.transferMediaTo=function(t,i){var a,h=this,g;if(t.media!==i){var m=null,p=this.hls,E=t!==p,x=E&&t.interstitial.appendInPlace,I=(a=this.detachedData)==null?void 0:a.mediaSource,R;if(p.media)x&&(m=p.transferMedia(),this.detachedData=m),R="Primary";else if(I){var _=this.getBufferingPlayer();_?(m=_.transferMedia(),R=""+_):R="detached MediaSource"}else R="detached media";if(!m){if(I)m=this.detachedData,this.log("using detachedData: MediaSource "+at(m));else if(!this.detachedData||p.media===i){var P=this.playerQueue;P.length>1&&P.forEach(function(B){if(E&&B.interstitial.appendInPlace!==x){var G=B.interstitial;h.clearInterstitial(B.interstitial,null),G.appendInPlace=!1,G.appendInPlace&&h.warn("Could not change append strategy for queued assets "+G)}}),this.hls.detachMedia(),this.detachedData={media:i}}}var O=m&&"mediaSource"in m&&((g=m.mediaSource)==null?void 0:g.readyState)!=="closed",N=O&&m?m:i;if(this.log((O?"transfering MediaSource":"attaching media")+" to "+(E?t:"Primary")+" from "+R),N===m){var U=E&&t.assetId===this.schedule.assetIdAtEnd;N.overrides={duration:this.schedule.duration,endOfStream:!E||U,cueRemoval:!E}}t.attachMedia(N)}},o.onInterstitialCueEnter=function(){this.onTimeupdate()},o.checkStart=function(){var t=this.schedule,i=t.events;if(!(!i||this.playbackDisabled||!this.media)){this.bufferedPos===-1&&(this.bufferedPos=0);var a=this.timelinePos,h=this.effectivePlayingItem;if(a===-1){var g=this.hls.startPosition;if(this.timelinePos=g,i.length&&i[0].cue.pre){var m=t.findEventIndex(i[0].identifier);this.setSchedulePosition(m)}else if(g>=0||!this.primaryLive){var p=this.timelinePos=g>0?g:0,E=t.findItemIndexAtTime(p);this.setSchedulePosition(E)}}else if(h&&!this.playingItem){var x=t.findItemIndex(h);this.setSchedulePosition(x)}}},o.advanceAfterAssetEnded=function(t,i,a){var h=a+1;if(!t.isAssetPastPlayoutLimit(h)&&!t.assetList[h].error)this.setSchedulePosition(i,h);else{var g=this.schedule.items;if(g){var m=i+1,p=g.length;if(m>=p){this.setSchedulePosition(-1);return}var E=t.resumeTime;this.timelinePos<E&&(this.timelinePos=E,this.checkBuffer()),this.setSchedulePosition(m)}}},o.setScheduleToAssetAtTime=function(t,i){var a=this.schedule,h=i.parentIdentifier,g=a.getEvent(h);if(g){var m=a.findEventIndex(h),p=a.findAssetIndex(g,t);this.setSchedulePosition(m,p)}},o.setSchedulePosition=function(t,i){var a=this.schedule.items;if(!(!a||this.playbackDisabled)){this.log("setSchedulePosition "+t+", "+i);var h=t>=0?a[t]:null,g=this.playingItem,m=this.playingLastItem;if(this.isInterstitial(g)){var p,E=g.event,x=this.playingAsset,I=x==null?void 0:x.identifier,R=I?this.getAssetPlayer(I):null;if(R&&I&&(!this.eventItemsMatch(g,h)||i!==void 0&&I!==((p=E.assetList)==null?void 0:p[i].identifier))){var _,P=E.findAssetIndex(x);this.log("INTERSTITIAL_ASSET_ENDED "+(P+1)+"/"+E.assetList.length+" "+_a(x)),this.endedAsset=x,this.playingAsset=null,this.hls.trigger(k.INTERSTITIAL_ASSET_ENDED,{asset:x,assetListIndex:P,event:E,schedule:a.slice(0),scheduleIndex:t,player:R}),this.retreiveMediaSource(I,h),R.media&&!((_=this.detachedData)!=null&&_.mediaSource)&&R.detachMedia()}if(!this.eventItemsMatch(g,h)&&(this.endedItem=g,this.playingItem=null,this.log("INTERSTITIAL_ENDED "+E+" "+Or(g)),E.hasPlayed=!0,this.hls.trigger(k.INTERSTITIAL_ENDED,{event:E,schedule:a.slice(0),scheduleIndex:t}),E.cue.once)){this.updateSchedule();var O=this.schedule.items;if(h&&O){var N=this.schedule.findItemIndex(h);this.advanceSchedule(N,O,i,g,m)}return}}this.advanceSchedule(t,a,i,g,m)}},o.advanceSchedule=function(t,i,a,h,g){var m=this,p=t>=0?i[t]:null,E=this.primaryMedia,x=this.playerQueue;if(x.length&&x.forEach(function(B){var G=B.interstitial,Y=m.schedule.findEventIndex(G.identifier);(Y<t||Y>t+1)&&m.clearInterstitial(G,p)}),this.isInterstitial(p)){this.timelinePos=Math.min(Math.max(this.timelinePos,p.start),p.end);var I=p.event;a===void 0&&(a=this.schedule.findAssetIndex(I,this.timelinePos));var R=this.waitingItem;this.assetsBuffered(p,E)||this.setBufferingItem(p);var _=this.preloadAssets(I,a);if(this.eventItemsMatch(p,R||h)||(this.waitingItem=p,this.log("INTERSTITIAL_STARTED "+Or(p)+" "+(I.appendInPlace?"append in place":"")),this.hls.trigger(k.INTERSTITIAL_STARTED,{event:I,schedule:i.slice(0),scheduleIndex:t})),!I.assetListLoaded){this.log("Waiting for ASSET-LIST to complete loading "+I);return}if(I.assetListLoader&&(I.assetListLoader.destroy(),I.assetListLoader=void 0),!E){this.log("Waiting for attachMedia to start Interstitial "+I);return}this.waitingItem=this.endedItem=null,this.playingItem=p;var P=I.assetList[a];if(!P){var O=i[t+1],N=this.media;O&&N&&!this.isInterstitial(O)&&N.currentTime<O.start&&(N.currentTime=this.timelinePos=O.start),this.advanceAfterAssetEnded(I,t,a||0);return}if(_||(_=this.getAssetPlayer(P.identifier)),_===null||_.destroyed){var U=I.assetList.length;this.warn("asset "+(a+1)+"/"+U+" player destroyed "+I),_=this.createAssetPlayer(I,P,a)}if(!this.eventItemsMatch(p,this.bufferingItem)&&I.appendInPlace&&this.isAssetBuffered(P))return;this.startAssetPlayer(_,a,i,t,E),this.shouldPlay&&ah(_.media)}else p!==null?(this.resumePrimary(p,t,h),this.shouldPlay&&ah(this.hls.media)):g&&this.isInterstitial(h)&&(this.endedItem=null,this.playingItem=h,h.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))},o.resumePrimary=function(t,i,a){var h;if(this.playingItem=t,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(t),this.log("resuming "+Or(t)),!((h=this.detachedData)!=null&&h.mediaSource)){var g=this.timelinePos;(g<t.start||g>=t.end)&&(g=this.getPrimaryResumption(t,i),this.timelinePos=g),this.attachPrimary(g,t)}if(a){var m=this.schedule.items;m&&(this.log("resumed "+Or(t)),this.hls.trigger(k.INTERSTITIALS_PRIMARY_RESUMED,{schedule:m.slice(0),scheduleIndex:i}),this.checkBuffer())}},o.getPrimaryResumption=function(t,i){var a=t.start;if(this.primaryLive){var h=this.primaryDetails;if(i===0)return this.hls.startPosition;if(h&&(a<h.fragmentStart||a>h.edge))return this.hls.liveSyncPosition||-1}return a},o.isAssetBuffered=function(t){var i=this.getAssetPlayer(t.identifier);if(i!=null&&i.hls)return i.hls.bufferedToEnd;var a=We.bufferInfo(this.primaryMedia,this.timelinePos,0);return a.end+1>=t.timelineStart+(t.duration||0)},o.attachPrimary=function(t,i,a){i?this.setBufferingItem(i):this.bufferingItem=this.playingItem,this.bufferingAsset=null;var h=this.primaryMedia;if(h){var g=this.hls;g.media?this.checkBuffer():(this.transferMediaTo(g,h),a&&this.startLoadingPrimaryAt(t,a)),a||(this.timelinePos=t,this.startLoadingPrimaryAt(t,a))}},o.startLoadingPrimaryAt=function(t,i){var a,h=this.hls;!h.loadingEnabled||!h.media||Math.abs((((a=h.mainForwardBufferInfo)==null?void 0:a.start)||h.media.currentTime)-t)>.5?h.startLoad(t,i):h.bufferingEnabled||h.resumeBuffering()},o.onManifestLoading=function(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(k.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(k.BUFFER_CODECS,this.onBufferCodecs,this)},o.onLevelUpdated=function(t,i){if(i.level!==-1){var a=this.hls.levels[i.level],h=F(F({},this.mediaSelection||this.altSelection),{},{main:a});this.mediaSelection=h,this.schedule.parseInterstitialDateRanges(h,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}},o.onAudioTrackUpdated=function(t,i){var a=this.hls.audioTracks[i.id],h=this.mediaSelection;if(!h){this.altSelection=F(F({},this.altSelection),{},{audio:a});return}var g=F(F({},h),{},{audio:a});this.mediaSelection=g},o.onSubtitleTrackUpdated=function(t,i){var a=this.hls.subtitleTracks[i.id],h=this.mediaSelection;if(!h){this.altSelection=F(F({},this.altSelection),{},{subtitles:a});return}var g=F(F({},h),{},{subtitles:a});this.mediaSelection=g},o.onAudioTrackSwitching=function(t,i){var a=Dl(i);this.playerQueue.forEach(function(h){return h.hls.setAudioOption(i)||h.hls.setAudioOption(a)})},o.onSubtitleTrackSwitch=function(t,i){var a=Dl(i);this.playerQueue.forEach(function(h){return h.hls.setSubtitleOption(i)||i.id!==-1&&h.hls.setSubtitleOption(a)})},o.onBufferCodecs=function(t,i){var a=i.tracks;a&&(this.requiredTracks=a)},o.onBufferAppended=function(t,i){this.checkBuffer()},o.onBufferFlushed=function(t,i){var a=this.playingItem;if(a&&!this.itemsMatch(a,this.bufferingItem)&&!this.isInterstitial(a)){var h=this.timelinePos;this.bufferedPos=h,this.checkBuffer()}},o.onBufferedToEnd=function(t){var i=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&i){for(var a=0;a<i.length;a++){var h=i[a];if(h.cue.post){var g,m=this.schedule.findEventIndex(h.identifier),p=(g=this.schedule.items)==null?void 0:g[m];this.isInterstitial(p)&&this.eventItemsMatch(p,this.bufferingItem)&&this.bufferedToItem(p,0);break}}this.bufferedPos=Number.MAX_VALUE}},o.onMediaEnded=function(t){var i=this.playingItem;if(!this.playingLastItem&&i){var a=this.findItemIndex(i);this.setSchedulePosition(a+1)}else this.shouldPlay=!1},o.updateItem=function(t,i){var a=this.schedule.items;if(t&&a){var h=this.findItemIndex(t,i);return a[h]||null}return null},o.itemsMatch=function(t,i){return!!i&&(t===i||t.event&&i.event&&this.eventItemsMatch(t,i)||!t.event&&!i.event&&this.findItemIndex(t)===this.findItemIndex(i))},o.eventItemsMatch=function(t,i){var a;return!!i&&(t===i||t.event.identifier===((a=i.event)==null?void 0:a.identifier))},o.findItemIndex=function(t,i){return t?this.schedule.findItemIndex(t,i):-1},o.updateSchedule=function(){var t=this.mediaSelection;t&&this.schedule.updateSchedule(t,[])},o.checkBuffer=function(t){var i=this.schedule.items;if(i){var a=We.bufferInfo(this.primaryMedia,this.timelinePos,0);t&&(this.bufferedPos=this.timelinePos),t||(t=a.len<1),this.updateBufferedPos(a.end,i,t)}},o.updateBufferedPos=function(t,i,a){var h=this.schedule,g=this.bufferingItem;if(!(this.bufferedPos>t)){if(i.length===1&&this.itemsMatch(i[0],g)){this.bufferedPos=t;return}var m=this.playingItem,p=this.findItemIndex(m),E=h.findItemIndexAtTime(t);if(this.bufferedPos<t){var x,I,R=this.findItemIndex(g),_=Math.min(R+1,i.length-1),P=i[_];if((E===-1&&g&&t>=g.end||(x=P.event)!=null&&x.appendInPlace&&t+.01>=P.start)&&(E=_),_-p>1&&(g==null||(I=g.event)==null?void 0:I.appendInPlace)===!1)return;if(this.bufferedPos=t,E>R&&E>p)this.bufferedToItem(P);else{var O=this.primaryDetails;this.primaryLive&&O&&t>O.edge-O.targetduration&&P.start<O.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(P)&&this.preloadAssets(P.event,0)}}else a&&m&&!this.itemsMatch(m,g)&&(E===p?this.bufferedToItem(m):E===p+1&&this.bufferedToItem(i[E]))}},o.assetsBuffered=function(t,i){var a=this,h=t.event.assetList;return h.length===0?!1:!t.event.assetList.some(function(g){var m=a.getAssetPlayer(g.identifier);return!(m!=null&&m.bufferedInPlaceToEnd(i))})},o.setBufferingItem=function(t){var i=this,a=this.bufferingItem,h=this.schedule;if(this.itemsMatch(t,a))this.bufferingItem!==t&&(this.bufferingItem=t);else{var g=h.items,m=h.events;if(!g||!m)return a;var p=this.isInterstitial(t),E=this.getBufferingPlayer();if(this.bufferingItem=t,this.bufferedPos=Math.max(t.start,Math.min(t.end,this.timelinePos)),!this.playbackDisabled){var x=E?E.remaining:a?a.end-this.timelinePos:0;this.log("buffered to boundary "+Or(t)+(a?" ("+x.toFixed(2)+" remaining)":"")),p?t.event.assetList.forEach(function(I){var R=i.getAssetPlayer(I.identifier);R&&R.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(function(I){return I.pauseBuffering()}))}this.hls.trigger(k.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:m.slice(0),schedule:g.slice(0),bufferingIndex:this.findItemIndex(t),playingIndex:this.findItemIndex(this.playingItem)})}return a},o.bufferedToItem=function(t,i){i===void 0&&(i=0);var a=this.setBufferingItem(t);if(!this.playbackDisabled){if(this.isInterstitial(t))this.bufferedToEvent(t,i);else if(a!==null){this.bufferingAsset=null;var h=this.detachedData;if(h)if(h.mediaSource){var g=!0;this.attachPrimary(t.start,t,g)}else this.preloadPrimary(t);else this.preloadPrimary(t)}}},o.preloadPrimary=function(t){var i=this.findItemIndex(t),a=this.getPrimaryResumption(t,i);this.startLoadingPrimaryAt(a)},o.bufferedToEvent=function(t,i){var a=t.event,h=a.assetList.length===0&&!a.assetListLoader,g=a.cue.once;if(h||!g){var m=this.preloadAssets(a,i);if(m!=null&&m.interstitial.appendInPlace){var p=a.assetList[i],E=this.primaryMedia;p&&E&&this.bufferAssetPlayer(m,E)}}},o.preloadAssets=function(t,i){var a=t.assetUrl,h=t.assetList.length,g=h===0&&!t.assetListLoader,m=t.cue.once;if(g){var p=t.timelineStart;if(t.appendInPlace){var E,x=this.playingItem;!this.isInterstitial(x)&&(x==null||(E=x.nextEvent)==null?void 0:E.identifier)===t.identifier&&this.flushFrontBuffer(p+.25)}var I,R=0;if(!this.playingItem&&this.primaryLive&&(R=this.hls.startPosition,R===-1&&(R=this.hls.liveSyncPosition||0)),R&&!(t.cue.pre||t.cue.post)){var _=R-p;_>0&&(I=Math.round(_*1e3)/1e3)}if(this.log("Load interstitial asset "+(i+1)+"/"+(a?1:h)+" "+t+(I?" live-start: "+R+" start-offset: "+I:"")),a)return this.createAsset(t,0,0,p,t.duration,a);var P=this.assetListLoader.loadAssetList(t,I);P&&(t.assetListLoader=P)}else if(!m&&h){for(var O=i;O<h;O++){var N=t.assetList[O],U=this.getAssetPlayerQueueIndex(N.identifier);(U===-1||this.playerQueue[U].destroyed)&&!N.error&&this.createAssetPlayer(t,N,O)}return this.getAssetPlayer(t.assetList[i].identifier)}return null},o.flushFrontBuffer=function(t){var i=this,a=this.requiredTracks;if(a){this.log("Removing front buffer starting at "+t);var h=Object.keys(a);h.forEach(function(g){i.hls.trigger(k.BUFFER_FLUSHING,{startOffset:t,endOffset:1/0,type:g})})}},o.getAssetPlayerQueueIndex=function(t){for(var i=this.playerQueue,a=0;a<i.length;a++)if(t===i[a].assetId)return a;return-1},o.getAssetPlayer=function(t){var i=this.getAssetPlayerQueueIndex(t);return this.playerQueue[i]||null},o.getBufferingPlayer=function(){var t=this.playerQueue,i=this.primaryMedia;if(i){for(var a=0;a<t.length;a++)if(t[a].media===i)return t[a]}return null},o.createAsset=function(t,i,a,h,g,m){var p={parentIdentifier:t.identifier,identifier:$v(t,m,i),duration:g,startOffset:a,timelineStart:h,uri:m};return this.createAssetPlayer(t,p,i)},o.createAssetPlayer=function(t,i,a){var h=this;this.log("create HLSAssetPlayer for "+_a(i));var g=this.hls,m=g.userConfig,p=m.videoPreference,E=g.loadLevelObj||g.levels[g.currentLevel];(p||E)&&(p=A({},p),E.videoCodec&&(p.videoCodec=E.videoCodec),E.videoRange&&(p.allowedVideoRanges=[E.videoRange]));var x=g.audioTracks[g.audioTrack],I=g.subtitleTracks[g.subtitleTrack],R=0;if(this.primaryLive||t.appendInPlace){var _=this.timelinePos-i.timelineStart;if(_>1){var P=i.duration;P&&_<P&&(R=_)}}var O=i.identifier,N=F(F({},m),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:g.sessionId,assetPlayerId:O,abrEwmaDefaultEstimate:g.bandwidthEstimate,interstitialsController:void 0,startPosition:R,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:p,audioPreference:x||m.audioPreference,subtitlePreference:I||m.subtitlePreference});t.appendInPlace&&(t.appendInPlaceStarted=!0,i.timelineStart&&(N.timelineOffset=i.timelineStart));var U=N.cmcd;U!=null&&U.sessionId&&U.contentId&&(N.cmcd=A({},U,{contentId:Yi(i.uri)})),this.getAssetPlayer(O)&&this.warn("Duplicate date range identifier "+t+" and asset "+O);var B=new Hv(this.HlsPlayerClass,N,t,i);this.playerQueue.push(B),t.assetList[a]=i;var G=function(X){if(X.live){var W=new Error("Interstitials MUST be VOD assets "+t),J={fatal:!0,type:se.OTHER_ERROR,details:q.INTERSTITIAL_ASSET_ITEM_ERROR,error:W};h.handleAssetItemError(J,t,h.schedule.findEventIndex(t.identifier),a,W.message);return}var oe=X.edge-X.fragmentStart,ge=i.duration;(ge===null||oe>ge)&&(h.log('Interstitial asset "'+O+'" duration change '+ge+" > "+oe),i.duration=oe,h.updateSchedule())};B.on(k.LEVEL_UPDATED,function(ae,X){var W=X.details;return G(W)}),B.on(k.LEVEL_PTS_UPDATED,function(ae,X){var W=X.details;return G(W)});var Y=function(X,W){var J=h.getAssetPlayer(O);if(J&&W.tracks){J.off(k.BUFFER_CODECS,Y),J.tracks=W.tracks;var oe=h.primaryMedia;h.bufferingAsset===J.assetItem&&oe&&!J.media&&h.bufferAssetPlayer(J,oe)}};B.on(k.BUFFER_CODECS,Y);var V=function(){var X,W=h.getAssetPlayer(O);if(h.log("buffered to end of asset "+W),!!W){var J=h.schedule.findEventIndex(t.identifier),oe=t.findAssetIndex(i),ge=oe+1,ce=(X=h.schedule.items)==null?void 0:X[J];if(h.isInterstitial(ce))if(oe!==-1&&!t.isAssetPastPlayoutLimit(ge)&&!t.assetList[ge].error)h.bufferedToItem(ce,ge);else{var he,ye=(he=h.schedule.items)==null?void 0:he[J+1];ye&&h.bufferedToItem(ye)}}};B.on(k.BUFFERED_TO_END,V);var j=function(X){return function(){var W=h.getAssetPlayer(O);if(W){h.shouldPlay=!0;var J=h.schedule.findEventIndex(t.identifier);h.advanceAfterAssetEnded(t,J,X)}}};return B.once(k.MEDIA_ENDED,j(a)),B.once(k.PLAYOUT_LIMIT_REACHED,j(1/0)),B.on(k.ERROR,function(ae,X){var W=h.getAssetPlayer(O);if(X.details===q.BUFFER_STALLED_ERROR){if(W!=null&&W.media){var J=W.currentTime,oe=W.duration-J;J&&t.appendInPlace&&oe/W.media.playbackRate<.5?(h.log("Advancing buffer past end of asset "+O+" "+t+" at "+W.media.currentTime),V()):(h.warn("Stalled at "+J+" of "+(J+oe)+" in asset "+O+" "+t),h.onTimeupdate(),h.checkBuffer(!0))}return}h.handleAssetItemError(X,t,h.schedule.findEventIndex(t.identifier),a,"Asset player error "+X.error+" "+t)}),B.on(k.DESTROYING,function(){var ae=h.getAssetPlayer(O);if(ae){var X=new Error("Asset player destroyed unexpectedly "+O),W={fatal:!0,type:se.OTHER_ERROR,details:q.INTERSTITIAL_ASSET_ITEM_ERROR,error:X};h.handleAssetItemError(W,t,h.schedule.findEventIndex(t.identifier),a,X.message)}}),this.hls.trigger(k.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:i,assetListIndex:a,event:t,player:B}),B},o.clearInterstitial=function(t,i){var a=this;t.assetList.forEach(function(h){a.clearAssetPlayer(h.identifier,i)}),t.reset()},o.clearAssetPlayer=function(t,i){var a=this.getAssetPlayerQueueIndex(t);if(a!==-1){this.log('clearAssetPlayer "'+t+'" toSegment: '+(i&&Or(i)));var h=this.playerQueue[a];this.transferMediaFromPlayer(h,i),this.playerQueue.splice(a,1),h.destroy()}},o.emptyPlayerQueue=function(){for(var t;t=this.playerQueue.pop();)t.destroy();this.playerQueue=[]},o.startAssetPlayer=function(t,i,a,h,g){var m=t.interstitial,p=t.assetItem,E=t.assetId,x=m.assetList.length,I=this.playingAsset;this.endedAsset=null,this.playingAsset=p,(!I||I.identifier!==E)&&(I&&(this.clearAssetPlayer(I.identifier,a[h]),delete I.error),this.log("INTERSTITIAL_ASSET_STARTED "+(i+1)+"/"+x+" "+t),this.hls.trigger(k.INTERSTITIAL_ASSET_STARTED,{asset:p,assetListIndex:i,event:m,schedule:a.slice(0),scheduleIndex:h,player:t})),this.bufferAssetPlayer(t,g)},o.bufferAssetPlayer=function(t,i){var a,h,g=t.interstitial,m=t.assetItem,p=t.assetId,E=this.schedule.findEventIndex(g.identifier),x=(a=this.schedule.items)==null?void 0:a[E];if(x){this.setBufferingItem(x),this.bufferingAsset=m;var I=this.getBufferingPlayer();if(I!==t){var R=g.appendInPlace;if(!(R&&(I==null?void 0:I.interstitial.appendInPlace)===!1)){var _=(I==null?void 0:I.tracks)||((h=this.detachedData)==null?void 0:h.tracks)||this.requiredTracks;if(R&&m!==this.playingAsset){if(!t.tracks)return;if(_&&!Nt(_,t.tracks)){var P=new Error('Asset "'+p+`" SourceBuffer tracks ('`+Object.keys(t.tracks)+"') are not compatible with primary content tracks ('"+Object.keys(_)+"')"),O={fatal:!0,type:se.OTHER_ERROR,details:q.INTERSTITIAL_ASSET_ITEM_ERROR,error:P},N=g.findAssetIndex(m);this.handleAssetItemError(O,g,E,N,P.message);return}}this.transferMediaTo(t,i)}}}},o.handleAssetItemError=function(t,i,a,h,g){if(t.details!==q.BUFFER_STALLED_ERROR){var m=i.assetList[h]||null,p=null;if(m){var E=this.getAssetPlayerQueueIndex(m.identifier);p=this.playerQueue[E]||null}var x=this.schedule.items,I=A({},t,{fatal:!1,errorAction:Fi(!0),asset:m,assetListIndex:h,event:i,schedule:x,scheduleIndex:a,player:p});if(this.warn("Asset item error: "+t.error),this.hls.trigger(k.INTERSTITIAL_ASSET_ERROR,I),!!t.fatal){var R=new Error(g);m&&(this.playingAsset!==m&&this.clearAssetPlayer(m.identifier,null),m.error=R),i.assetList.some(function(_){return!_.error})?i.appendInPlace&&(i.error=R):i.error=R,this.primaryFallback(i)}}},o.primaryFallback=function(t){var i=t.timelineStart,a=this.effectivePlayingItem;if(this.updateSchedule(),a){this.log('Fallback to primary from event "'+t.identifier+'" start: '+i+" pos: "+this.timelinePos+" playing: "+(a?Or(a):"<none>")+" error: "+t.error),t.appendInPlace&&(this.attachPrimary(i,null),this.flushFrontBuffer(i));var h=this.timelinePos;h===-1&&(h=this.hls.startPosition);var g=this.updateItem(a,h);if(this.itemsMatch(a,g))this.clearInterstitial(t,null);else{var m=this.schedule.findItemIndexAtTime(h);this.setSchedulePosition(m)}}else this.checkStart()},o.onAssetListLoaded=function(t,i){var a=this,h,g=i.event,m=g.identifier,p=i.assetListResponse.ASSETS;if(this.schedule.hasEvent(m)){var E=g.timelineStart,x=g.duration,I=0;p.forEach(function(j,ae){var X=parseFloat(j.DURATION);a.createAsset(g,ae,I,E+I,X,j.URI),I+=X}),g.duration=I,this.log("Loaded asset-list with duration: "+I+" (was: "+x+") "+g);var R=this.waitingItem,_=(R==null?void 0:R.event.identifier)===m;this.updateSchedule();var P=(h=this.bufferingItem)==null?void 0:h.event;if(_){var O,N=this.schedule.findEventIndex(m),U=(O=this.schedule.items)==null?void 0:O[N];if(U){if(!this.playingItem&&this.timelinePos>U.end){var B=this.schedule.findItemIndexAtTime(this.timelinePos);if(B!==N){g.error=new Error("Interstitial no longer within playback range "+this.timelinePos+" "+g),this.primaryFallback(g);return}}this.setBufferingItem(U)}this.setSchedulePosition(N)}else if((P==null?void 0:P.identifier)===m&&P.appendInPlace){var G=g.assetList[0],Y=this.getAssetPlayer(G.identifier),V=this.primaryMedia;G&&Y&&V&&this.bufferAssetPlayer(Y,V)}}},o.onError=function(t,i){switch(i.details){case q.ASSET_LIST_PARSING_ERROR:case q.ASSET_LIST_LOAD_ERROR:case q.ASSET_LIST_LOAD_TIMEOUT:{var a=i.interstitial;a&&this.primaryFallback(a);break}case q.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}},y(d,[{key:"interstitialsManager",get:function(){if(!this.manager){if(!this.hls)return null;var t=this,i=function(){return t.bufferingItem||t.waitingItem},a=function(_){return _&&t.getAssetPlayer(_.identifier)},h=function(_,P,O,N,U){if(_){var B=_[P].start,G=_.event;if(G){if(P==="playout"||G.timelineOccupancy!==Fs.Point){var Y=a(O);(Y==null?void 0:Y.interstitial)===G&&(B+=Y.assetItem.startOffset+Y[U])}}else{var V=N==="bufferedPos"?m():t[N];B+=V-_.start}return B}return 0},g=function(_,P){if(_!==0&&P!=="primary"&&t.schedule.length){var O,N=t.schedule.findItemIndexAtTime(_),U=(O=t.schedule.items)==null?void 0:O[N];if(U){var B=U[P].start-U.start;return _+B}}return _},m=function(){var _=t.bufferedPos;return _===Number.MAX_VALUE?p("primary"):Math.max(_,0)},p=function(_){var P;return(P=t.primaryDetails)!=null&&P.live?t.primaryDetails.edge:t.schedule.durations[_]},E=function(_,P){var O,N,U=t.effectivePlayingItem;if(!(U!=null&&(O=U.event)!=null&&O.restrictions.skip)){t.log("seek to "+_+' "'+P+'"');var B=t.effectivePlayingItem,G=t.schedule.findItemIndexAtTime(_,P),Y=(N=t.schedule.items)==null?void 0:N[G],V=t.getBufferingPlayer(),j=V==null?void 0:V.interstitial,ae=j==null?void 0:j.appendInPlace,X=B&&t.itemsMatch(B,Y);if(B&&(ae||X)){var W=a(t.playingAsset),J=(W==null?void 0:W.media)||t.primaryMedia;if(J){var oe=P==="primary"?J.currentTime:h(B,P,t.playingAsset,"timelinePos","currentTime"),ge=_-oe,ce=(ae?oe:J.currentTime)+ge;if(ce>=0&&(!W||ae||ce<=W.duration)){J.currentTime=ce;return}}}if(Y){var he=_;if(P!=="primary"){var ye=Y[P].start,Se=_-ye;he=Y.start+Se}var Le=!t.isInterstitial(Y);if((!t.isInterstitial(B)||B.event.appendInPlace)&&(Le||Y.event.appendInPlace)){var Ie=t.media||(ae?V==null?void 0:V.media:null);Ie&&(Ie.currentTime=he)}else if(B){var He=t.findItemIndex(B);if(G>He){var Oe=t.schedule.findJumpRestrictedIndex(He+1,G);if(Oe>He){t.setSchedulePosition(Oe);return}}var je=0;if(Le)t.timelinePos=he,t.checkBuffer();else{var Fe,Xe=Y==null||(Fe=Y.event)==null?void 0:Fe.assetList;if(Xe)for(var ze=_-(Y[P]||Y).start,it=Xe.length;it--;){var yt=Xe[it];if(yt.duration&&ze>=yt.startOffset&&ze<yt.startOffset+yt.duration){je=it;break}}}t.setSchedulePosition(G,je)}}}},x=function(){var _=t.effectivePlayingItem;if(t.isInterstitial(_))return _;var P=i();return t.isInterstitial(P)?P:null},I={get currentTime(){var R=x(),_=t.effectivePlayingItem;return _&&_===R?h(_,"playout",t.effectivePlayingAsset,"timelinePos","currentTime")-_.playout.start:0},set currentTime(R){var _=x(),P=t.effectivePlayingItem;P&&P===_&&E(R+P.playout.start,"playout")},get duration(){var R=x();return R?R.playout.end-R.playout.start:0},get assetPlayers(){var R,_=(R=x())==null?void 0:R.event.assetList;return _?_.map(function(P){return t.getAssetPlayer(P.identifier)}):[]},get playingIndex(){var R,_=(R=x())==null?void 0:R.event;return _&&t.effectivePlayingAsset?_.findAssetIndex(t.effectivePlayingAsset):-1},get scheduleItem(){return x()}};this.manager={get events(){var R,_;return((R=t.schedule)==null||(_=R.events)==null?void 0:_.slice(0))||[]},get schedule(){var R,_;return((R=t.schedule)==null||(_=R.items)==null?void 0:_.slice(0))||[]},get interstitialPlayer(){return x()?I:null},get playerQueue(){return t.playerQueue.slice(0)},get bufferingAsset(){return t.bufferingAsset},get bufferingItem(){return i()},get bufferingIndex(){var R=i();return t.findItemIndex(R)},get playingAsset(){return t.effectivePlayingAsset},get playingItem(){return t.effectivePlayingItem},get playingIndex(){var R=t.effectivePlayingItem;return t.findItemIndex(R)},primary:{get bufferedEnd(){return m()},get currentTime(){var R=t.timelinePos;return R>0?R:0},set currentTime(R){E(R,"primary")},get duration(){return p("primary")},get seekableStart(){var R;return((R=t.primaryDetails)==null?void 0:R.fragmentStart)||0}},integrated:{get bufferedEnd(){return h(i(),"integrated",t.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return h(t.effectivePlayingItem,"integrated",t.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(R){E(R,"integrated")},get duration(){return p("integrated")},get seekableStart(){var R;return g(((R=t.primaryDetails)==null?void 0:R.fragmentStart)||0,"integrated")}},skip:function(){var _=t.effectivePlayingItem,P=_==null?void 0:_.event;if(P&&!P.restrictions.skip){var O=t.findItemIndex(_);if(P.appendInPlace){var N=_.playout.start+_.event.duration;E(N+.001,"playout")}else t.advanceAfterAssetEnded(P,O,1/0)}}}}return this.manager}},{key:"effectivePlayingItem",get:function(){return this.waitingItem||this.playingItem||this.endedItem}},{key:"effectivePlayingAsset",get:function(){return this.playingAsset||this.endedAsset}},{key:"playingLastItem",get:function(){var t,i=this.playingItem,a=(t=this.schedule)==null?void 0:t.items;return!this.playbackStarted||!i||!a?!1:this.findItemIndex(i)===a.length-1}},{key:"playbackStarted",get:function(){return this.effectivePlayingItem!==null}},{key:"currentTime",get:function(){var t,i,a;if(this.mediaSelection!==null){var h=this.waitingItem||this.playingItem;if(!(this.isInterstitial(h)&&!h.event.appendInPlace)){var g=this.media;!g&&(t=this.bufferingItem)!=null&&(i=t.event)!=null&&i.appendInPlace&&(g=this.primaryMedia);var m=(a=g)==null?void 0:a.currentTime;if(!(m===void 0||!ue(m)))return m}}}},{key:"primaryMedia",get:function(){var t;return this.media||((t=this.detachedData)==null?void 0:t.media)||null}},{key:"playbackDisabled",get:function(){return this.hls.config.enableInterstitialPlayback===!1}},{key:"primaryDetails",get:function(){var t,i;return(t=this.mediaSelection)==null||(i=t.main)==null?void 0:i.details}},{key:"primaryLive",get:function(){var t;return!!((t=this.primaryDetails)!=null&&t.live)}}])}(st),oh=500,jv=function(u){function d(s,t,i){var a;return a=u.call(this,s,t,i,"subtitle-stream-controller",pe.SUBTITLE)||this,a.currentTrackId=-1,a.tracksBuffered=[],a.mainDetails=null,a.registerListeners(),a}b(d,u);var o=d.prototype;return o.onHandlerDestroying=function(){this.unregisterListeners(),u.prototype.onHandlerDestroying.call(this),this.mainDetails=null},o.registerListeners=function(){u.prototype.registerListeners.call(this);var t=this.hls;t.on(k.LEVEL_LOADED,this.onLevelLoaded,this),t.on(k.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(k.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(k.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(k.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(k.BUFFER_FLUSHING,this.onBufferFlushing,this)},o.unregisterListeners=function(){u.prototype.unregisterListeners.call(this);var t=this.hls;t.off(k.LEVEL_LOADED,this.onLevelLoaded,this),t.off(k.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(k.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(k.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(k.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(k.BUFFER_FLUSHING,this.onBufferFlushing,this)},o.startLoad=function(t,i){this.stopLoad(),this.state=fe.IDLE,this.setInterval(oh),this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=i?-1:t,this.tick()},o.onManifestLoading=function(){u.prototype.onManifestLoading.call(this),this.mainDetails=null},o.onMediaDetaching=function(t,i){this.tracksBuffered=[],u.prototype.onMediaDetaching.call(this,t,i)},o.onLevelLoaded=function(t,i){this.mainDetails=i.details},o.onSubtitleFragProcessed=function(t,i){var a=i.frag,h=i.success;if(ct(a)&&(this.fragPrevious=a),this.state=fe.IDLE,!!h){var g=this.tracksBuffered[this.currentTrackId];if(g){for(var m,p=a.start,E=0;E<g.length;E++)if(p>=g[E].start&&p<=g[E].end){m=g[E];break}var x=a.start+a.duration;m?m.end=x:(m={start:p,end:x},g.push(m)),this.fragmentTracker.fragBuffered(a),this.fragBufferedComplete(a,null),this.media&&this.tick()}}},o.onBufferFlushing=function(t,i){var a=i.startOffset,h=i.endOffset;if(a===0&&h!==Number.POSITIVE_INFINITY){var g=h-1;if(g<=0)return;i.endOffsetSubtitles=Math.max(0,g),this.tracksBuffered.forEach(function(m){for(var p=0;p<m.length;){if(m[p].end<=g){m.shift();continue}else if(m[p].start<g)m[p].start=g;else break;p++}}),this.fragmentTracker.removeFragmentsInRange(a,g,pe.SUBTITLE)}},o.onError=function(t,i){var a=i.frag;(a==null?void 0:a.type)===pe.SUBTITLE&&(i.details===q.FRAG_GAP&&this.fragmentTracker.fragBuffered(a,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==fe.STOPPED&&(this.state=fe.IDLE))},o.onSubtitleTracksUpdated=function(t,i){var a=this,h=i.subtitleTracks;if(this.levels&&Hu(this.levels,h)){this.levels=h.map(function(g){return new Mi(g)});return}this.tracksBuffered=[],this.levels=h.map(function(g){var m=new Mi(g);return a.tracksBuffered[m.id]=[],m}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,pe.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null},o.onSubtitleTrackSwitch=function(t,i){var a;if(this.currentTrackId=i.id,!((a=this.levels)!=null&&a.length)||this.currentTrackId===-1){this.clearInterval();return}var h=this.levels[this.currentTrackId];h!=null&&h.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,h&&this.state!==fe.STOPPED&&this.setInterval(oh)},o.onSubtitleTrackLoaded=function(t,i){var a,h=this.currentTrackId,g=this.levels,m=i.details,p=i.id;if(!g){this.warn("Subtitle tracks were reset while loading level "+p);return}var E=g[p];if(!(p>=g.length||!E)){this.log("Subtitle track "+p+" loaded ["+m.startSN+","+m.endSN+"]"+(m.lastPartSn?"[part-"+m.lastPartSn+"-"+m.lastPartIndex+"]":"")+",duration:"+m.totalduration),this.mediaBuffer=this.mediaBufferTimeRanges;var x=0;if(m.live||(a=E.details)!=null&&a.live){var I=this.mainDetails;if(m.deltaUpdateFailed||!I)return;var R=I.fragments[0];if(!E.details)m.hasProgramDateTime&&I.hasProgramDateTime?(bs(m,I),x=m.fragmentStart):R&&(x=R.start,ia(m,x));else{var _;x=this.alignPlaylists(m,E.details,(_=this.levelLastLoaded)==null?void 0:_.details),x===0&&R&&(x=R.start,ia(m,x))}}if(E.details=m,this.levelLastLoaded=E,p===h&&(this.hls.trigger(k.SUBTITLE_TRACK_UPDATED,{details:m,id:p,groupId:i.groupId}),this.tick(),m.live&&!this.fragCurrent&&this.media&&this.state===fe.IDLE)){var P=Xr(null,m.fragments,this.media.currentTime,0);P||(this.warn("Subtitle playlist not aligned with playback"),E.details=void 0)}}},o._handleFragmentLoadComplete=function(t){var i=this,a=t.frag,h=t.payload,g=a.decryptdata,m=this.hls;if(!this.fragContextChanged(a)&&h&&h.byteLength>0&&g!=null&&g.key&&g.iv&&li(g.method)){var p=performance.now();this.decrypter.decrypt(new Uint8Array(h),g.key.buffer,g.iv.buffer,qn(g.method)).catch(function(E){throw m.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.FRAG_DECRYPT_ERROR,fatal:!1,error:E,reason:E.message,frag:a}),E}).then(function(E){var x=performance.now();m.trigger(k.FRAG_DECRYPTED,{frag:a,payload:E,stats:{tstart:p,tdecrypt:x}})}).catch(function(E){i.warn(E.name+": "+E.message),i.state=fe.IDLE})}},o.doTick=function(){if(!this.media){this.state=fe.IDLE;return}if(this.state===fe.IDLE){var t=this.currentTrackId,i=this.levels,a=i==null?void 0:i[t];if(!a||!i.length||!a.details||this.waitForLive(a))return;var h=this.config,g=this.getLoadPosition(),m=We.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],g,h.maxBufferHole),p=m.end,E=m.len,x=a.details,I=this.hls.maxBufferLength+x.levelTargetDuration;if(E>I)return;var R=x.fragments,_=R.length,P=x.edge,O=null,N=this.fragPrevious;if(p<P){var U=h.maxFragLookUpTolerance,B=p>P-U?0:U;O=Xr(N,R,Math.max(R[0].start,p),B),!O&&N&&N.start<R[0].start&&(O=R[0])}else O=R[_-1];if(O=this.filterReplacedPrimary(O,a.details),!O)return;var G=O.sn-x.startSN,Y=R[G-1];if(Y&&Y.cc===O.cc&&this.fragmentTracker.getState(Y)===xt.NOT_LOADED&&(O=Y),this.fragmentTracker.getState(O)===xt.NOT_LOADED){var V=this.mapToInitFragWhenRequired(O);V&&this.loadFragment(V,a,p)}}},o.loadFragment=function(t,i,a){ct(t)?u.prototype.loadFragment.call(this,t,i,a):this._loadInitSegment(t,i)},y(d,[{key:"mediaBufferTimeRanges",get:function(){return new Xv(this.tracksBuffered[this.currentTrackId]||[])}}])}(sa),Xv=function(d){this.buffered=void 0;var o=function(t,i,a){if(i=i>>>0,i>a-1)throw new DOMException("Failed to execute '"+t+"' on 'TimeRanges': The index provided ("+i+") is greater than the maximum bound ("+a+")");return d[i][t]};this.buffered={get length(){return d.length},end:function(t){return o("end",t,d.length)},start:function(t){return o("start",t,d.length)}}};function lh(u,d){var o;try{o=new Event("addtrack")}catch{o=document.createEvent("Event"),o.initEvent("addtrack",!1,!1)}o.track=u,d.dispatchEvent(o)}function uh(u,d){var o=u.mode;if(o==="disabled"&&(u.mode="hidden"),u.cues&&!u.cues.getCueById(d.id))try{if(u.addCue(d),!u.cues.getCueById(d.id))throw new Error("addCue is failed for: "+d)}catch(t){Ye.debug("[texttrack-utils]: "+t);try{var s=new self.TextTrackCue(d.startTime,d.endTime,d.text);s.id=d.id,u.addCue(s)}catch(i){Ye.debug("[texttrack-utils]: Legacy TextTrackCue fallback failed: "+i)}}o==="disabled"&&(u.mode=o)}function vi(u,d){var o=u.mode;if(o==="disabled"&&(u.mode="hidden"),u.cues)for(var s=u.cues.length;s--;)d&&u.cues[s].removeEventListener("enter",d),u.removeCue(u.cues[s]);o==="disabled"&&(u.mode=o)}function Da(u,d,o,s){var t=u.mode;if(t==="disabled"&&(u.mode="hidden"),u.cues&&u.cues.length>0)for(var i=Qv(u.cues,d,o),a=0;a<i.length;a++)(!s||s(i[a]))&&u.removeCue(i[a]);t==="disabled"&&(u.mode=t)}function zv(u,d){if(d<=u[0].startTime)return 0;var o=u.length-1;if(d>u[o].endTime)return-1;for(var s=0,t=o,i;s<=t;)if(i=Math.floor((t+s)/2),d<u[i].startTime)t=i-1;else if(d>u[i].startTime&&s<o)s=i+1;else return i;return u[s].startTime-d<d-u[t].startTime?s:t}function Qv(u,d,o){var s=[],t=zv(u,d);if(t>-1)for(var i=t,a=u.length;i<a;i++){var h=u[i];if(h.startTime>=d&&h.endTime<=o)s.push(h);else if(h.startTime>o)return s}return s}function Ns(u){for(var d=[],o=0;o<u.length;o++){var s=u[o];(s.kind==="subtitles"||s.kind==="captions")&&s.label&&d.push(u[o])}return d}var Zv=function(u){function d(s){var t;return t=u.call(this,s,"subtitle-track-controller")||this,t.media=null,t.tracks=[],t.groupIds=null,t.tracksInGroup=[],t.trackId=-1,t.currentTrack=null,t.selectDefaultTrack=!0,t.queuedDefaultTrack=-1,t.useTextTrackPolling=!1,t.subtitlePollingInterval=-1,t._subtitleDisplay=!0,t.asyncPollTrackChange=function(){return t.pollTrackChange(0)},t.onTextTracksChanged=function(){if(t.useTextTrackPolling||self.clearInterval(t.subtitlePollingInterval),!(!t.media||!t.hls.config.renderTextTracksNatively)){for(var i=null,a=Ns(t.media.textTracks),h=0;h<a.length;h++)if(a[h].mode==="hidden")i=a[h];else if(a[h].mode==="showing"){i=a[h];break}var g=t.findTrackForTextTrack(i);t.subtitleTrack!==g&&t.setSubtitleTrack(g)}},t.registerListeners(),t}b(d,u);var o=d.prototype;return o.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,u.prototype.destroy.call(this)},o.registerListeners=function(){var t=this.hls;t.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.MANIFEST_PARSED,this.onManifestParsed,this),t.on(k.LEVEL_LOADING,this.onLevelLoading,this),t.on(k.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(k.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(k.ERROR,this.onError,this)},o.unregisterListeners=function(){var t=this.hls;t.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.MANIFEST_PARSED,this.onManifestParsed,this),t.off(k.LEVEL_LOADING,this.onLevelLoading,this),t.off(k.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(k.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(k.ERROR,this.onError,this)},o.onMediaAttached=function(t,i){this.media=i.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},o.pollTrackChange=function(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,t)},o.onMediaDetaching=function(t,i){var a=this.media;if(a){var h=!!i.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||a.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,!h){var g=Ns(a.textTracks);g.forEach(function(m){vi(m)})}}},o.onManifestLoading=function(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0},o.onManifestParsed=function(t,i){this.tracks=i.subtitleTracks},o.onSubtitleTrackLoaded=function(t,i){var a=i.id,h=i.groupId,g=i.details,m=this.tracksInGroup[a];if(!m||m.groupId!==h){this.warn("Subtitle track with id:"+a+" and group:"+h+" not found in active group "+(m==null?void 0:m.groupId));return}var p=m.details;m.details=i.details,this.log("Subtitle track "+a+' "'+m.name+'" lang:'+m.lang+" group:"+h+" loaded ["+g.startSN+"-"+g.endSN+"]"),a===this.trackId&&this.playlistLoaded(a,i,p)},o.onLevelLoading=function(t,i){this.switchLevel(i.level)},o.onLevelSwitching=function(t,i){this.switchLevel(i.level)},o.switchLevel=function(t){var i=this.hls.levels[t];if(i){var a=i.subtitleGroups||null,h=this.groupIds,g=this.currentTrack;if(!a||(h==null?void 0:h.length)!==(a==null?void 0:a.length)||a!=null&&a.some(function(_){return(h==null?void 0:h.indexOf(_))===-1})){this.groupIds=a,this.trackId=-1,this.currentTrack=null;var m=this.tracks.filter(function(_){return!a||a.indexOf(_.groupId)!==-1});if(m.length)this.selectDefaultTrack&&!m.some(function(_){return _.default})&&(this.selectDefaultTrack=!1),m.forEach(function(_,P){_.id=P});else if(!g&&!this.tracksInGroup.length)return;this.tracksInGroup=m;var p=this.hls.config.subtitlePreference;if(!g&&p){this.selectDefaultTrack=!1;var E=or(p,m);if(E>-1)g=m[E];else{var x=or(p,this.tracks);g=this.tracks[x]}}var I=this.findTrackId(g);I===-1&&g&&(I=this.findTrackId(null));var R={subtitleTracks:m};this.log("Updating subtitle tracks, "+m.length+' track(s) found in "'+(a==null?void 0:a.join(","))+'" group-id'),this.hls.trigger(k.SUBTITLE_TRACKS_UPDATED,R),I!==-1&&this.trackId===-1&&this.setSubtitleTrack(I)}}},o.findTrackId=function(t){for(var i=this.tracksInGroup,a=this.selectDefaultTrack,h=0;h<i.length;h++){var g=i[h];if(!(a&&!g.default||!a&&!t)&&(!t||qr(g,t)))return h}if(t){for(var m=0;m<i.length;m++){var p=i[m];if(Vi(t.attrs,p.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return m}for(var E=0;E<i.length;E++){var x=i[E];if(Vi(t.attrs,x.attrs,["LANGUAGE"]))return E}}return-1},o.findTrackForTextTrack=function(t){if(t)for(var i=this.tracksInGroup,a=0;a<i.length;a++){var h=i[a];if(Sa(h,t))return a}return-1},o.onError=function(t,i){i.fatal||!i.context||i.context.type===Te.SUBTITLE_TRACK&&i.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(i.context.groupId)!==-1)&&this.checkRetry(i)},o.setSubtitleOption=function(t){if(this.hls.config.subtitlePreference=t,t){if(t.id===-1)return this.setSubtitleTrack(-1),null;var i=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,i.length){var a=this.currentTrack;if(a&&qr(t,a))return a;var h=or(t,this.tracksInGroup);if(h>-1){var g=this.tracksInGroup[h];return this.setSubtitleTrack(h),g}else{if(a)return null;var m=or(t,i);if(m>-1)return i[m]}}}return null},o.loadPlaylist=function(t){u.prototype.loadPlaylist.call(this),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,t)},o.loadingPlaylist=function(t,i){u.prototype.loadingPlaylist.call(this,t,i);var a=t.id,h=t.groupId,g=this.getUrlWithDirectives(t.url,i),m=t.details,p=m==null?void 0:m.age;this.log("Loading subtitle "+a+' "'+t.name+'" lang:'+t.lang+" group:"+h+((i==null?void 0:i.msn)!==void 0?" at sn "+i.msn+" part "+i.part:"")+(p&&m.live?" age "+p.toFixed(1)+(m.type&&" "+m.type||""):"")+" "+g),this.hls.trigger(k.SUBTITLE_TRACK_LOADING,{url:g,id:a,groupId:h,deliveryDirectives:i||null,track:t})},o.toggleTrackModes=function(){var t=this.media;if(t){var i=Ns(t.textTracks),a=this.currentTrack,h;if(a&&(h=i.filter(function(m){return Sa(a,m)})[0],h||this.warn('Unable to find subtitle TextTrack with name "'+a.name+'" and language "'+a.lang+'"')),[].slice.call(i).forEach(function(m){m.mode!=="disabled"&&m!==h&&(m.mode="disabled")}),h){var g=this.subtitleDisplay?"showing":"hidden";h.mode!==g&&(h.mode=g)}}},o.setSubtitleTrack=function(t){var i=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=t;return}if(t<-1||t>=i.length||!ue(t)){this.warn("Invalid subtitle track id: "+t);return}this.selectDefaultTrack=!1;var a=this.currentTrack,h=i[t]||null;if(this.trackId=t,this.currentTrack=h,this.toggleTrackModes(),!h){this.hls.trigger(k.SUBTITLE_TRACK_SWITCH,{id:t});return}var g=!!h.details&&!h.details.live;if(!(t===this.trackId&&h===a&&g)){this.log("Switching to subtitle-track "+t+(h?' "'+h.name+'" lang:'+h.lang+" group:"+h.groupId:""));var m=h.id,p=h.groupId,E=p===void 0?"":p,x=h.name,I=h.type,R=h.url;this.hls.trigger(k.SUBTITLE_TRACK_SWITCH,{id:m,groupId:E,name:x,type:I,url:R});var _=this.switchParams(h.url,a==null?void 0:a.details,h.details);this.loadPlaylist(_)}},y(d,[{key:"subtitleDisplay",get:function(){return this._subtitleDisplay},set:function(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes()}},{key:"allSubtitleTracks",get:function(){return this.tracks}},{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t)}}])}(Ta),Jv={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},hh=function(d){return String.fromCharCode(Jv[d]||d)},Jt=15,Lr=100,em={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},tm={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rm={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},im={25:2,26:4,29:6,30:8,31:10,27:13,28:15},sm=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],nm=function(){function u(){this.time=null,this.verboseLevel=0}var d=u.prototype;return d.log=function(s,t){if(this.verboseLevel>=s){var i=typeof t=="function"?t():t;Ye.log(this.time+" ["+s+"] "+i)}},u}(),Qr=function(d){for(var o=[],s=0;s<d.length;s++)o.push(d[s].toString(16));return o},fh=function(){function u(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}var d=u.prototype;return d.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},d.setStyles=function(s){for(var t=["foreground","underline","italics","background","flash"],i=0;i<t.length;i++){var a=t[i];s.hasOwnProperty(a)&&(this[a]=s[a])}},d.isDefault=function(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash},d.equals=function(s){return this.foreground===s.foreground&&this.underline===s.underline&&this.italics===s.italics&&this.background===s.background&&this.flash===s.flash},d.copy=function(s){this.foreground=s.foreground,this.underline=s.underline,this.italics=s.italics,this.background=s.background,this.flash=s.flash},d.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},u}(),am=function(){function u(){this.uchar=" ",this.penState=new fh}var d=u.prototype;return d.reset=function(){this.uchar=" ",this.penState.reset()},d.setChar=function(s,t){this.uchar=s,this.penState.copy(t)},d.setPenState=function(s){this.penState.copy(s)},d.equals=function(s){return this.uchar===s.uchar&&this.penState.equals(s.penState)},d.copy=function(s){this.uchar=s.uchar,this.penState.copy(s.penState)},d.isEmpty=function(){return this.uchar===" "&&this.penState.isDefault()},u}(),om=function(){function u(o){this.chars=[],this.pos=0,this.currPenState=new fh,this.cueStartTime=null,this.logger=void 0;for(var s=0;s<Lr;s++)this.chars.push(new am);this.logger=o}var d=u.prototype;return d.equals=function(s){for(var t=0;t<Lr;t++)if(!this.chars[t].equals(s.chars[t]))return!1;return!0},d.copy=function(s){for(var t=0;t<Lr;t++)this.chars[t].copy(s.chars[t])},d.isEmpty=function(){for(var s=!0,t=0;t<Lr;t++)if(!this.chars[t].isEmpty()){s=!1;break}return s},d.setCursor=function(s){this.pos!==s&&(this.pos=s),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Lr&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Lr)},d.moveCursor=function(s){var t=this.pos+s;if(s>1)for(var i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)},d.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},d.insertChar=function(s){var t=this;s>=144&&this.backSpace();var i=hh(s);if(this.pos>=Lr){this.logger.log(0,function(){return"Cannot insert "+s.toString(16)+" ("+i+") at position "+t.pos+". Skipping it!"});return}this.chars[this.pos].setChar(i,this.currPenState),this.moveCursor(1)},d.clearFromPos=function(s){var t;for(t=s;t<Lr;t++)this.chars[t].reset()},d.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},d.clearToEndOfRow=function(){this.clearFromPos(this.pos)},d.getTextString=function(){for(var s=[],t=!0,i=0;i<Lr;i++){var a=this.chars[i].uchar;a!==" "&&(t=!1),s.push(a)}return t?"":s.join("")},d.setPenStyles=function(s){this.currPenState.setStyles(s);var t=this.chars[this.pos];t.setPenState(this.currPenState)},u}(),Ca=function(){function u(o){this.rows=[],this.currRow=Jt-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(var s=0;s<Jt;s++)this.rows.push(new om(o));this.logger=o}var d=u.prototype;return d.reset=function(){for(var s=0;s<Jt;s++)this.rows[s].clear();this.currRow=Jt-1},d.equals=function(s){for(var t=!0,i=0;i<Jt;i++)if(!this.rows[i].equals(s.rows[i])){t=!1;break}return t},d.copy=function(s){for(var t=0;t<Jt;t++)this.rows[t].copy(s.rows[t])},d.isEmpty=function(){for(var s=!0,t=0;t<Jt;t++)if(!this.rows[t].isEmpty()){s=!1;break}return s},d.backSpace=function(){var s=this.rows[this.currRow];s.backSpace()},d.clearToEndOfRow=function(){var s=this.rows[this.currRow];s.clearToEndOfRow()},d.insertChar=function(s){var t=this.rows[this.currRow];t.insertChar(s)},d.setPen=function(s){var t=this.rows[this.currRow];t.setPenStyles(s)},d.moveCursor=function(s){var t=this.rows[this.currRow];t.moveCursor(s)},d.setCursor=function(s){this.logger.log(2,"setCursor: "+s);var t=this.rows[this.currRow];t.setCursor(s)},d.setPAC=function(s){this.logger.log(2,function(){return"pacData = "+at(s)});var t=s.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(var i=0;i<Jt;i++)this.rows[i].clear();var a=this.currRow+1-this.nrRollUpRows,h=this.lastOutputScreen;if(h){var g=h.rows[a].cueStartTime,m=this.logger.time;if(g!==null&&m!==null&&g<m)for(var p=0;p<this.nrRollUpRows;p++)this.rows[t-this.nrRollUpRows+p+1].copy(h.rows[a+p])}}this.currRow=t;var E=this.rows[this.currRow];if(s.indent!==null){var x=s.indent,I=Math.max(x-1,0);E.setCursor(s.indent),s.color=E.chars[I].penState.foreground}var R={foreground:s.color,underline:s.underline,italics:s.italics,background:"black",flash:!1};this.setPen(R)},d.setBkgData=function(s){this.logger.log(2,function(){return"bkgData = "+at(s)}),this.backSpace(),this.setPen(s),this.insertChar(32)},d.setRollUpRows=function(s){this.nrRollUpRows=s},d.rollUp=function(){var s=this;if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,function(){return s.getDisplayText()});var t=this.currRow+1-this.nrRollUpRows,i=this.rows.splice(t,1)[0];i.clear(),this.rows.splice(this.currRow,0,i),this.logger.log(2,"Rolling up")},d.getDisplayText=function(s){s=s||!1;for(var t=[],i="",a=-1,h=0;h<Jt;h++){var g=this.rows[h].getTextString();g&&(a=h+1,s?t.push("Row "+a+": '"+g+"'"):t.push(g.trim()))}return t.length>0&&(s?i="["+t.join(" | ")+"]":i=t.join(`
`)),i},d.getTextAndFormat=function(){return this.rows},u}(),dh=function(){function u(o,s,t){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=o,this.outputFilter=s,this.mode=null,this.verbose=0,this.displayedMemory=new Ca(t),this.nonDisplayedMemory=new Ca(t),this.lastOutputScreen=new Ca(t),this.currRollUpRow=this.displayedMemory.rows[Jt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=t}var d=u.prototype;return d.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Jt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},d.getHandler=function(){return this.outputFilter},d.setHandler=function(s){this.outputFilter=s},d.setPAC=function(s){this.writeScreen.setPAC(s)},d.setBkgData=function(s){this.writeScreen.setBkgData(s)},d.setMode=function(s){s!==this.mode&&(this.mode=s,this.logger.log(2,function(){return"MODE="+s}),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=s)},d.insertChars=function(s){for(var t=this,i=0;i<s.length;i++)this.writeScreen.insertChar(s[i]);var a=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,function(){return a+": "+t.writeScreen.getDisplayText(!0)}),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,function(){return"DISPLAYED: "+t.displayedMemory.getDisplayText(!0)}),this.outputDataUpdate())},d.ccRCL=function(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},d.ccBS=function(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},d.ccAOF=function(){},d.ccAON=function(){},d.ccDER=function(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},d.ccRU=function(s){this.logger.log(2,"RU("+s+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(s)},d.ccFON=function(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},d.ccRDC=function(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},d.ccTR=function(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")},d.ccRTD=function(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")},d.ccEDM=function(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},d.ccCR=function(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},d.ccENM=function(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},d.ccEOC=function(){var s=this;if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){var t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,function(){return"DISP: "+s.displayedMemory.getDisplayText()})}this.outputDataUpdate(!0)},d.ccTO=function(s){this.logger.log(2,"TO("+s+") - Tab Offset"),this.writeScreen.moveCursor(s)},d.ccMIDROW=function(s){var t={flash:!1};if(t.underline=s%2===1,t.italics=s>=46,t.italics)t.foreground="white";else{var i=Math.floor(s/2)-16,a=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=a[i]}this.logger.log(2,"MIDROW: "+at(t)),this.writeScreen.setPen(t)},d.outputDataUpdate=function(s){s===void 0&&(s=!1);var t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),s&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))},d.cueSplitAtTime=function(s){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,s,this.displayedMemory),this.cueStartTime=s))},u}(),ch=function(){function u(o,s,t){this.channels=void 0,this.currentChannel=0,this.cmdHistory=um(),this.logger=void 0;var i=this.logger=new nm;this.channels=[null,new dh(o,s,i),new dh(o+1,t,i)]}var d=u.prototype;return d.getHandler=function(s){return this.channels[s].getHandler()},d.setHandler=function(s,t){this.channels[s].setHandler(t)},d.addData=function(s,t){var i=this;this.logger.time=s;for(var a=function(p){var E=t[p]&127,x=t[p+1]&127,I=!1,R=null;if(E===0&&x===0)return 0;i.logger.log(3,function(){return"["+Qr([t[p],t[p+1]])+"] -> ("+Qr([E,x])+")"});var _=i.cmdHistory,P=E>=16&&E<=31;if(P){if(lm(E,x,_))return Us(null,null,_),i.logger.log(3,function(){return"Repeated command ("+Qr([E,x])+") is dropped"}),0;Us(E,x,i.cmdHistory),I=i.parseCmd(E,x),I||(I=i.parseMidrow(E,x)),I||(I=i.parsePAC(E,x)),I||(I=i.parseBackgroundAttributes(E,x))}else Us(null,null,_);if(!I&&(R=i.parseChars(E,x),R)){var O=i.currentChannel;if(O&&O>0){var N=i.channels[O];N.insertChars(R)}else i.logger.log(2,"No channel found yet. TEXT-MODE?")}!I&&!R&&i.logger.log(2,function(){return"Couldn't parse cleaned data "+Qr([E,x])+" orig: "+Qr([t[p],t[p+1]])})},h,g=0;g<t.length;g+=2)h=a(g)},d.parseCmd=function(s,t){var i=(s===20||s===28||s===21||s===29)&&t>=32&&t<=47,a=(s===23||s===31)&&t>=33&&t<=35;if(!(i||a))return!1;var h=s===20||s===21||s===23?1:2,g=this.channels[h];return s===20||s===21||s===28||s===29?t===32?g.ccRCL():t===33?g.ccBS():t===34?g.ccAOF():t===35?g.ccAON():t===36?g.ccDER():t===37?g.ccRU(2):t===38?g.ccRU(3):t===39?g.ccRU(4):t===40?g.ccFON():t===41?g.ccRDC():t===42?g.ccTR():t===43?g.ccRTD():t===44?g.ccEDM():t===45?g.ccCR():t===46?g.ccENM():t===47&&g.ccEOC():g.ccTO(t-32),this.currentChannel=h,!0},d.parseMidrow=function(s,t){var i=0;if((s===17||s===25)&&t>=32&&t<=47){if(s===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;var a=this.channels[i];return a?(a.ccMIDROW(t),this.logger.log(3,function(){return"MIDROW ("+Qr([s,t])+")"}),!0):!1}return!1},d.parsePAC=function(s,t){var i,a=(s>=17&&s<=23||s>=25&&s<=31)&&t>=64&&t<=127,h=(s===16||s===24)&&t>=64&&t<=95;if(!(a||h))return!1;var g=s<=23?1:2;t>=64&&t<=95?i=g===1?em[s]:rm[s]:i=g===1?tm[s]:im[s];var m=this.channels[g];return m?(m.setPAC(this.interpretPAC(i,t)),this.currentChannel=g,!0):!1},d.interpretPAC=function(s,t){var i,a={color:null,italics:!1,indent:null,underline:!1,row:s};return t>95?i=t-96:i=t-64,a.underline=(i&1)===1,i<=13?a.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(a.italics=!0,a.color="white"):a.indent=Math.floor((i-16)/2)*4,a},d.parseChars=function(s,t){var i,a=null,h=null;if(s>=25?(i=2,h=s-8):(i=1,h=s),h>=17&&h<=19){var g;h===17?g=t+80:h===18?g=t+112:g=t+144,this.logger.log(2,function(){return"Special char '"+hh(g)+"' in channel "+i}),a=[g]}else s>=32&&s<=127&&(a=t===0?[s]:[s,t]);return a&&this.logger.log(3,function(){return"Char codes =  "+Qr(a).join(",")}),a},d.parseBackgroundAttributes=function(s,t){var i=(s===16||s===24)&&t>=32&&t<=47,a=(s===23||s===31)&&t>=45&&t<=47;if(!(i||a))return!1;var h,g={};s===16||s===24?(h=Math.floor((t-32)/2),g.background=sm[h],t%2===1&&(g.background=g.background+"_semi")):t===45?g.background="transparent":(g.foreground="black",t===47&&(g.underline=!0));var m=s<=23?1:2,p=this.channels[m];return p.setBkgData(g),!0},d.reset=function(){for(var s=0;s<Object.keys(this.channels).length;s++){var t=this.channels[s];t&&t.reset()}Us(null,null,this.cmdHistory)},d.cueSplitAtTime=function(s){for(var t=0;t<this.channels.length;t++){var i=this.channels[t];i&&i.cueSplitAtTime(s)}},u}();function Us(u,d,o){o.a=u,o.b=d}function lm(u,d,o){return o.a===u&&o.b===d}function um(){return{a:null,b:null}}var Pa=function(){if(xs!=null&&xs.VTTCue)return self.VTTCue;var u=["","lr","rl"],d=["start","middle","end","left","right"];function o(h,g){if(typeof g!="string"||!Array.isArray(h))return!1;var m=g.toLowerCase();return~h.indexOf(m)?m:!1}function s(h){return o(u,h)}function t(h){return o(d,h)}function i(h){for(var g=arguments.length,m=new Array(g>1?g-1:0),p=1;p<g;p++)m[p-1]=arguments[p];for(var E=1;E<arguments.length;E++){var x=arguments[E];for(var I in x)h[I]=x[I]}return h}function a(h,g,m){var p=this,E={enumerable:!0};p.hasBeenReset=!1;var x="",I=!1,R=h,_=g,P=m,O=null,N="",U=!0,B="auto",G="start",Y=50,V="middle",j=50,ae="middle";Object.defineProperty(p,"id",i({},E,{get:function(){return x},set:function(W){x=""+W}})),Object.defineProperty(p,"pauseOnExit",i({},E,{get:function(){return I},set:function(W){I=!!W}})),Object.defineProperty(p,"startTime",i({},E,{get:function(){return R},set:function(W){if(typeof W!="number")throw new TypeError("Start time must be set to a number.");R=W,this.hasBeenReset=!0}})),Object.defineProperty(p,"endTime",i({},E,{get:function(){return _},set:function(W){if(typeof W!="number")throw new TypeError("End time must be set to a number.");_=W,this.hasBeenReset=!0}})),Object.defineProperty(p,"text",i({},E,{get:function(){return P},set:function(W){P=""+W,this.hasBeenReset=!0}})),Object.defineProperty(p,"region",i({},E,{get:function(){return O},set:function(W){O=W,this.hasBeenReset=!0}})),Object.defineProperty(p,"vertical",i({},E,{get:function(){return N},set:function(W){var J=s(W);if(J===!1)throw new SyntaxError("An invalid or illegal string was specified.");N=J,this.hasBeenReset=!0}})),Object.defineProperty(p,"snapToLines",i({},E,{get:function(){return U},set:function(W){U=!!W,this.hasBeenReset=!0}})),Object.defineProperty(p,"line",i({},E,{get:function(){return B},set:function(W){if(typeof W!="number"&&W!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");B=W,this.hasBeenReset=!0}})),Object.defineProperty(p,"lineAlign",i({},E,{get:function(){return G},set:function(W){var J=t(W);if(!J)throw new SyntaxError("An invalid or illegal string was specified.");G=J,this.hasBeenReset=!0}})),Object.defineProperty(p,"position",i({},E,{get:function(){return Y},set:function(W){if(W<0||W>100)throw new Error("Position must be between 0 and 100.");Y=W,this.hasBeenReset=!0}})),Object.defineProperty(p,"positionAlign",i({},E,{get:function(){return V},set:function(W){var J=t(W);if(!J)throw new SyntaxError("An invalid or illegal string was specified.");V=J,this.hasBeenReset=!0}})),Object.defineProperty(p,"size",i({},E,{get:function(){return j},set:function(W){if(W<0||W>100)throw new Error("Size must be between 0 and 100.");j=W,this.hasBeenReset=!0}})),Object.defineProperty(p,"align",i({},E,{get:function(){return ae},set:function(W){var J=t(W);if(!J)throw new SyntaxError("An invalid or illegal string was specified.");ae=J,this.hasBeenReset=!0}})),p.displayState=void 0}return a.prototype.getCueAsHTML=function(){var h=self.WebVTT;return h.convertCueToDOMTree(self,this.text)},a}(),hm=function(){function u(){}var d=u.prototype;return d.decode=function(s,t){if(!s)return"";if(typeof s!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(s))},u}();function gh(u){function d(s,t,i,a){return(s|0)*3600+(t|0)*60+(i|0)+parseFloat(a||0)}var o=u.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return o?parseFloat(o[2])>59?d(o[2],o[3],0,o[4]):d(o[1],o[2],o[3],o[4]):null}var fm=function(){function u(){this.values=Object.create(null)}var d=u.prototype;return d.set=function(s,t){!this.get(s)&&t!==""&&(this.values[s]=t)},d.get=function(s,t,i){return i?this.has(s)?this.values[s]:t[i]:this.has(s)?this.values[s]:t},d.has=function(s){return s in this.values},d.alt=function(s,t,i){for(var a=0;a<i.length;++a)if(t===i[a]){this.set(s,t);break}},d.integer=function(s,t){/^-?\d+$/.test(t)&&this.set(s,parseInt(t,10))},d.percent=function(s,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){var i=parseFloat(t);if(i>=0&&i<=100)return this.set(s,i),!0}return!1},u}();function vh(u,d,o,s){var t=s?u.split(s):[u];for(var i in t)if(typeof t[i]=="string"){var a=t[i].split(o);if(a.length===2){var h=a[0],g=a[1];d(h,g)}}}var ka=new Pa(0,0,""),Bs=ka.align==="middle"?"middle":"center";function dm(u,d,o){var s=u;function t(){var h=gh(u);if(h===null)throw new Error("Malformed timestamp: "+s);return u=u.replace(/^[^\sa-zA-Z-]+/,""),h}function i(h,g){var m=new fm;vh(h,function(x,I){var R;switch(x){case"region":for(var _=o.length-1;_>=0;_--)if(o[_].id===I){m.set(x,o[_].region);break}break;case"vertical":m.alt(x,I,["rl","lr"]);break;case"line":R=I.split(","),m.integer(x,R[0]),m.percent(x,R[0])&&m.set("snapToLines",!1),m.alt(x,R[0],["auto"]),R.length===2&&m.alt("lineAlign",R[1],["start",Bs,"end"]);break;case"position":R=I.split(","),m.percent(x,R[0]),R.length===2&&m.alt("positionAlign",R[1],["start",Bs,"end","line-left","line-right","auto"]);break;case"size":m.percent(x,I);break;case"align":m.alt(x,I,["start",Bs,"end","left","right"]);break}},/:/,/\s/),g.region=m.get("region",null),g.vertical=m.get("vertical","");var p=m.get("line","auto");p==="auto"&&ka.line===-1&&(p=-1),g.line=p,g.lineAlign=m.get("lineAlign","start"),g.snapToLines=m.get("snapToLines",!0),g.size=m.get("size",100),g.align=m.get("align",Bs);var E=m.get("position","auto");E==="auto"&&ka.position===50&&(E=g.align==="start"||g.align==="left"?0:g.align==="end"||g.align==="right"?100:50),g.position=E}function a(){u=u.replace(/^\s+/,"")}if(a(),d.startTime=t(),a(),u.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+s);u=u.slice(3),a(),d.endTime=t(),a(),i(u,d)}function mh(u){return u.replace(/<br(?: \/)?>/gi,`
`)}var cm=function(){function u(){this.state="INITIAL",this.buffer="",this.decoder=new hm,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var d=u.prototype;return d.parse=function(s){var t=this;s&&(t.buffer+=t.decoder.decode(s,{stream:!0}));function i(){var E=t.buffer,x=0;for(E=mh(E);x<E.length&&E[x]!=="\r"&&E[x]!==`
`;)++x;var I=E.slice(0,x);return E[x]==="\r"&&++x,E[x]===`
`&&++x,t.buffer=E.slice(x),I}function a(E){vh(E,function(x,I){},/:/)}try{var h="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;h=i();var g=h.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(g!=null&&g[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}for(var m=!1;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(m?m=!1:h=i(),t.state){case"HEADER":/:/.test(h)?a(h):h||(t.state="ID");continue;case"NOTE":h||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(h)){t.state="NOTE";break}if(!h)continue;if(t.cue=new Pa(0,0,""),t.state="CUE",h.indexOf("-->")===-1){t.cue.id=h;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{dm(h,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{var p=h.indexOf("-->")!==-1;if(!h||p&&(m=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=h}continue;case"BADCUE":h||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this},d.flush=function(){var s=this;try{if((s.cue||s.state==="HEADER")&&(s.buffer+=`

`,s.parse()),s.state==="INITIAL"||s.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){s.onparsingerror&&s.onparsingerror(t)}return s.onflush&&s.onflush(),this},u}(),gm=/\r\n|\n\r|\n|\r/g,wa=function(d,o,s){return s===void 0&&(s=0),d.slice(s,s+o.length)===o},vm=function(d){var o=parseInt(d.slice(-3)),s=parseInt(d.slice(-6,-4)),t=parseInt(d.slice(-9,-7)),i=d.length>9?parseInt(d.substring(0,d.indexOf(":"))):0;if(!ue(o)||!ue(s)||!ue(t)||!ue(i))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+d);return o+=1e3*s,o+=60*1e3*t,o+=60*60*1e3*i,o};function Oa(u,d,o){return Yi(u.toString())+Yi(d.toString())+Yi(o)}var mm=function(d,o,s){var t=d[o],i=d[t.prevCC];if(!i||!i.new&&t.new){d.ccOffset=d.presentationOffset=t.start,t.new=!1;return}for(;(a=i)!=null&&a.new;){var a;d.ccOffset+=t.start-i.start,t.new=!1,t=i,i=d[t.prevCC]}d.presentationOffset=s};function pm(u,d,o,s,t,i,a){var h=new cm,g=mt(new Uint8Array(u)).trim().replace(gm,`
`).split(`
`),m=[],p=d?b0(d.baseTime,d.timescale):0,E="00:00.000",x=0,I=0,R,_=!0;h.oncue=function(P){var O=o[s],N=o.ccOffset,U=(x-p)/9e4;if(O!=null&&O.new&&(I!==void 0?N=o.ccOffset=O.start:mm(o,s,U)),U){if(!d){R=new Error("Missing initPTS for VTT MPEGTS");return}N=U-o.presentationOffset}var B=P.endTime-P.startTime,G=Wt((P.startTime+N-I)*9e4,t*9e4)/9e4;P.startTime=Math.max(G,0),P.endTime=Math.max(G+B,0);var Y=P.text.trim();P.text=decodeURIComponent(encodeURIComponent(Y)),P.id||(P.id=Oa(P.startTime,P.endTime,Y)),P.endTime>0&&m.push(P)},h.onparsingerror=function(P){R=P},h.onflush=function(){if(R){a(R);return}i(m)},g.forEach(function(P){if(_)if(wa(P,"X-TIMESTAMP-MAP=")){_=!1,P.slice(16).split(",").forEach(function(O){wa(O,"LOCAL:")?E=O.slice(6):wa(O,"MPEGTS:")&&(x=parseInt(O.slice(7)))});try{I=vm(E)/1e3}catch(O){R=O}return}else P===""&&(_=!1);h.parse(P+`
`)}),h.flush()}var Ma="stpp.ttml.im1t",ph=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,yh=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,ym={left:"start",center:"center",right:"end",start:"start",end:"end"};function Eh(u,d,o,s){var t=we(new Uint8Array(u),["mdat"]);if(t.length===0){s(new Error("Could not parse IMSC1 mdat"));return}var i=t.map(function(h){return mt(h)}),a=R0(d.baseTime,1,d.timescale);try{i.forEach(function(h){return o(Em(h,a))})}catch(h){s(h)}}function Em(u,d){var o=new DOMParser,s=o.parseFromString(u,"text/xml"),t=s.getElementsByTagName("tt")[0];if(!t)throw new Error("Invalid ttml");var i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},a=Object.keys(i).reduce(function(E,x){return E[x]=t.getAttribute("ttp:"+x)||i[x],E},{}),h=t.getAttribute("xml:space")!=="preserve",g=Th(Fa(t,"styling","style")),m=Th(Fa(t,"layout","region")),p=Fa(t,"body","[begin]");return[].map.call(p,function(E){var x=Sh(E,h);if(!x||!E.hasAttribute("begin"))return null;var I=Ua(E.getAttribute("begin"),a),R=Ua(E.getAttribute("dur"),a),_=Ua(E.getAttribute("end"),a);if(I===null)throw Ah(E);if(_===null){if(R===null)throw Ah(E);_=I+R}var P=new Pa(I-d,_-d,x);P.id=Oa(P.startTime,P.endTime,P.text);var O=m[E.getAttribute("region")],N=g[E.getAttribute("style")],U=Tm(O,N,g),B=U.textAlign;if(B){var G=ym[B];G&&(P.lineAlign=G),P.align=B}return A(P,U),P}).filter(function(E){return E!==null})}function Fa(u,d,o){var s=u.getElementsByTagName(d)[0];return s?[].slice.call(s.querySelectorAll(o)):[]}function Th(u){return u.reduce(function(d,o){var s=o.getAttribute("xml:id");return s&&(d[s]=o),d},{})}function Sh(u,d){return[].slice.call(u.childNodes).reduce(function(o,s,t){var i;return s.nodeName==="br"&&t?o+`
`:(i=s.childNodes)!=null&&i.length?Sh(s,d):d?o+s.textContent.trim().replace(/\s+/g," "):o+s.textContent},"")}function Tm(u,d,o){var s="http://www.w3.org/ns/ttml#styling",t=null,i=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=u!=null&&u.hasAttribute("style")?u.getAttribute("style"):null;return a&&o.hasOwnProperty(a)&&(t=o[a]),i.reduce(function(h,g){var m=Na(d,s,g)||Na(u,s,g)||Na(t,s,g);return m&&(h[g]=m),h},{})}function Na(u,d,o){return u&&u.hasAttributeNS(d,o)?u.getAttributeNS(d,o):null}function Ah(u){return new Error("Could not parse ttml timestamp "+u)}function Ua(u,d){if(!u)return null;var o=gh(u);return o===null&&(ph.test(u)?o=Sm(u,d):yh.test(u)&&(o=Am(u,d))),o}function Sm(u,d){var o=ph.exec(u),s=(o[4]|0)+(o[5]|0)/d.subFrameRate;return(o[1]|0)*3600+(o[2]|0)*60+(o[3]|0)+s/d.frameRate}function Am(u,d){var o=yh.exec(u),s=Number(o[1]),t=o[2];switch(t){case"h":return s*3600;case"m":return s*60;case"ms":return s*1e3;case"f":return s/d.frameRate;case"t":return s/d.tickRate}return s}var Gs=function(){function u(o,s){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=o,this.trackName=s}var d=u.prototype;return d.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},d.newCue=function(s,t,i){(this.startTime===null||this.startTime>s)&&(this.startTime=s),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)},d.reset=function(){this.cueRanges=[],this.startTime=null},u}(),xm=function(){function u(o){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ih(),this.captionsProperties=void 0,this.hls=o,this.config=o.config,this.Cues=o.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},o.on(k.MEDIA_ATTACHING,this.onMediaAttaching,this),o.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),o.on(k.MANIFEST_LOADING,this.onManifestLoading,this),o.on(k.MANIFEST_LOADED,this.onManifestLoaded,this),o.on(k.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),o.on(k.FRAG_LOADING,this.onFragLoading,this),o.on(k.FRAG_LOADED,this.onFragLoaded,this),o.on(k.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),o.on(k.FRAG_DECRYPTED,this.onFragDecrypted,this),o.on(k.INIT_PTS_FOUND,this.onInitPtsFound,this),o.on(k.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),o.on(k.BUFFER_FLUSHING,this.onBufferFlushing,this)}var d=u.prototype;return d.destroy=function(){var s=this.hls;s.off(k.MEDIA_ATTACHING,this.onMediaAttaching,this),s.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),s.off(k.MANIFEST_LOADING,this.onManifestLoading,this),s.off(k.MANIFEST_LOADED,this.onManifestLoaded,this),s.off(k.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),s.off(k.FRAG_LOADING,this.onFragLoading,this),s.off(k.FRAG_LOADED,this.onFragLoaded,this),s.off(k.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),s.off(k.FRAG_DECRYPTED,this.onFragDecrypted,this),s.off(k.INIT_PTS_FOUND,this.onInitPtsFound,this),s.off(k.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),s.off(k.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0},d.initCea608Parsers=function(){var s=new Gs(this,"textTrack1"),t=new Gs(this,"textTrack2"),i=new Gs(this,"textTrack3"),a=new Gs(this,"textTrack4");this.cea608Parser1=new ch(1,s,t),this.cea608Parser2=new ch(3,i,a)},d.addCues=function(s,t,i,a,h){for(var g=!1,m=h.length;m--;){var p=h[m],E=Lm(p[0],p[1],t,i);if(E>=0&&(p[0]=Math.min(p[0],t),p[1]=Math.max(p[1],i),g=!0,E/(i-t)>.5))return}if(g||h.push([t,i]),this.config.renderTextTracksNatively){var x=this.captionsTracks[s];this.Cues.newCue(x,t,i,a)}else{var I=this.Cues.newCue(null,t,i,a);this.hls.trigger(k.CUES_PARSED,{type:"captions",cues:I,track:s})}},d.onInitPtsFound=function(s,t){var i=this,a=t.frag,h=t.id,g=t.initPTS,m=t.timescale,p=this.unparsedVttFrags;h===pe.MAIN&&(this.initPTS[a.cc]={baseTime:g,timescale:m}),p.length&&(this.unparsedVttFrags=[],p.forEach(function(E){i.onFragLoaded(k.FRAG_LOADED,E)}))},d.getExistingTrack=function(s,t){var i=this.media;if(i)for(var a=0;a<i.textTracks.length;a++){var h=i.textTracks[a];if(Lh(h,{name:s,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return h}return null},d.createCaptionsTrack=function(s){this.config.renderTextTracksNatively?this.createNativeTrack(s):this.createNonNativeTrack(s)},d.createNativeTrack=function(s){if(!this.captionsTracks[s]){var t=this.captionsProperties,i=this.captionsTracks,a=this.media,h=t[s],g=h.label,m=h.languageCode,p=this.getExistingTrack(g,m);if(p)i[s]=p,vi(i[s]),lh(i[s],a);else{var E=this.createTextTrack("captions",g,m);E&&(E[s]=!0,i[s]=E)}}},d.createNonNativeTrack=function(s){if(!this.nonNativeCaptionsTracks[s]){var t=this.captionsProperties[s];if(t){var i=t.label,a={_id:s,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[s]=a,this.hls.trigger(k.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[a]})}}},d.createTextTrack=function(s,t,i){var a=this.media;if(a)return a.addTextTrack(s,t,i)},d.onMediaAttaching=function(s,t){this.media=t.media,t.mediaSource||this._cleanTracks()},d.onMediaDetaching=function(s,t){var i=!!t.transferMedia;if(this.media=null,!i){var a=this.captionsTracks;Object.keys(a).forEach(function(h){vi(a[h]),delete a[h]}),this.nonNativeCaptionsTracks={}}},d.onManifestLoading=function(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Ih(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},d._cleanTracks=function(){var s=this.media;if(s){var t=s.textTracks;if(t)for(var i=0;i<t.length;i++)vi(t[i])}},d.onSubtitleTracksUpdated=function(s,t){var i=this,a=t.subtitleTracks||[],h=a.some(function(I){return I.textCodec===Ma});if(this.config.enableWebVTT||h&&this.config.enableIMSC1){var g=Hu(this.tracks,a);if(g){this.tracks=a;return}if(this.textTracks=[],this.tracks=a,this.config.renderTextTracksNatively){var m=this.media,p=m?Ns(m.textTracks):null;if(this.tracks.forEach(function(I,R){var _;if(p){for(var P=null,O=0;O<p.length;O++)if(p[O]&&Lh(p[O],I)){P=p[O],p[O]=null;break}P&&(_=P)}if(_)vi(_);else{var N=xh(I);_=i.createTextTrack(N,I.name,I.lang),_&&(_.mode="disabled")}_&&i.textTracks.push(_)}),p!=null&&p.length){var E=p.filter(function(I){return I!==null}).map(function(I){return I.label});E.length&&this.hls.logger.warn("Media element contains unused subtitle tracks: "+E.join(", ")+". Replace media element for each source to clear TextTracks and captions menu.")}}else if(this.tracks.length){var x=this.tracks.map(function(I){return{label:I.name,kind:I.type.toLowerCase(),default:I.default,subtitleTrack:I}});this.hls.trigger(k.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:x})}}},d.onManifestLoaded=function(s,t){var i=this;this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(function(a){var h=/(?:CC|SERVICE)([1-4])/.exec(a.instreamId);if(h){var g="textTrack"+h[1],m=i.captionsProperties[g];m&&(m.label=a.name,a.lang&&(m.languageCode=a.lang),m.media=a)}})},d.closedCaptionsForLevel=function(s){var t=this.hls.levels[s.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]},d.onFragLoading=function(s,t){if(this.enabled&&t.frag.type===pe.MAIN){var i,a,h=this.cea608Parser1,g=this.cea608Parser2,m=this.lastSn,p=t.frag,E=p.cc,x=p.sn,I=(i=(a=t.part)==null?void 0:a.index)!=null?i:-1;h&&g&&(x!==m+1||x===m&&I!==this.lastPartIndex+1||E!==this.lastCc)&&(h.reset(),g.reset()),this.lastCc=E,this.lastSn=x,this.lastPartIndex=I}},d.onFragLoaded=function(s,t){var i=t.frag,a=t.payload;if(i.type===pe.SUBTITLE)if(a.byteLength){var h=i.decryptdata,g="stats"in t;if(h==null||!h.encrypted||g){var m=this.tracks[i.level],p=this.vttCCs;p[i.cc]||(p[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),m&&m.textCodec===Ma?this._parseIMSC1(i,a):this._parseVTTs(t)}}else this.hls.trigger(k.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})},d._parseIMSC1=function(s,t){var i=this,a=this.hls;Eh(t,this.initPTS[s.cc],function(h){i._appendCues(h,s.level),a.trigger(k.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:s})},function(h){a.logger.log("Failed to parse IMSC1: "+h),a.trigger(k.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:h})})},d._parseVTTs=function(s){var t,i=this,a=s.frag,h=s.payload,g=this.initPTS,m=this.unparsedVttFrags,p=g.length-1;if(!g[a.cc]&&p===-1){m.push(s);return}var E=this.hls,x=(t=a.initSegment)!=null&&t.data?Yt(a.initSegment.data,new Uint8Array(h)).buffer:h;pm(x,this.initPTS[a.cc],this.vttCCs,a.cc,a.start,function(I){i._appendCues(I,a.level),E.trigger(k.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:a})},function(I){var R=I.message==="Missing initPTS for VTT MPEGTS";R?m.push(s):i._fallbackToIMSC1(a,h),E.logger.log("Failed to parse VTT cue: "+I),!(R&&p>a.cc)&&E.trigger(k.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:a,error:I})})},d._fallbackToIMSC1=function(s,t){var i=this,a=this.tracks[s.level];a.textCodec||Eh(t,this.initPTS[s.cc],function(){a.textCodec=Ma,i._parseIMSC1(s,t)},function(){a.textCodec="wvtt"})},d._appendCues=function(s,t){var i=this.hls;if(this.config.renderTextTracksNatively){var a=this.textTracks[t];if(!a||a.mode==="disabled")return;s.forEach(function(m){return uh(a,m)})}else{var h=this.tracks[t];if(!h)return;var g=h.default?"default":"subtitles"+t;i.trigger(k.CUES_PARSED,{type:"subtitles",cues:s,track:g})}},d.onFragDecrypted=function(s,t){var i=t.frag;i.type===pe.SUBTITLE&&this.onFragLoaded(k.FRAG_LOADED,t)},d.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},d.onFragParsingUserdata=function(s,t){if(!(!this.enabled||!this.config.enableCEA708Captions)){var i=t.frag,a=t.samples;if(!(i.type===pe.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(var h=0;h<a.length;h++){var g=a[h].bytes;if(g){this.cea608Parser1||this.initCea608Parsers();var m=this.extractCea608Data(g);this.cea608Parser1.addData(a[h].pts,m[0]),this.cea608Parser2.addData(a[h].pts,m[1])}}}},d.onBufferFlushing=function(s,t){var i=t.startOffset,a=t.endOffset,h=t.endOffsetSubtitles,g=t.type,m=this.media;if(!(!m||m.currentTime<a)){if(!g||g==="video"){var p=this.captionsTracks;Object.keys(p).forEach(function(x){return Da(p[x],i,a)})}if(this.config.renderTextTracksNatively&&i===0&&h!==void 0){var E=this.textTracks;Object.keys(E).forEach(function(x){return Da(E[x],i,h)})}}},d.extractCea608Data=function(s){for(var t=[[],[]],i=s[0]&31,a=2,h=0;h<i;h++){var g=s[a++],m=127&s[a++],p=127&s[a++];if(!(m===0&&p===0)){var E=(4&g)!==0;if(E){var x=3&g;(x===0||x===1)&&(t[x].push(m),t[x].push(p))}}}return t},u}();function xh(u){return u.characteristics&&/transcribes-spoken-dialog/gi.test(u.characteristics)&&/describes-music-and-sound/gi.test(u.characteristics)?"captions":"subtitles"}function Lh(u,d){return!!u&&u.kind===xh(d)&&Sa(d,u)}function Lm(u,d,o,s){return Math.min(d,s)-Math.max(u,o)}function Ih(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}var Im=/\s/,Rm={newCue:function(d,o,s,t){for(var i=[],a,h,g,m,p,E=self.VTTCue||self.TextTrackCue,x=0;x<t.rows.length;x++)if(a=t.rows[x],g=!0,m=0,p="",!a.isEmpty()){for(var I,R=0;R<a.chars.length;R++)Im.test(a.chars[R].uchar)&&g?m++:(p+=a.chars[R].uchar,g=!1);a.cueStartTime=o,o===s&&(s+=1e-4),m>=16?m--:m++;var _=mh(p.trim()),P=Oa(o,s,_);d!=null&&(I=d.cues)!=null&&I.getCueById(P)||(h=new E(o,s,_),h.id=P,h.line=x+1,h.align="left",h.position=10+Math.min(80,Math.floor(m*8/32)*10),i.push(h))}return d&&i.length&&(i.sort(function(O,N){return O.line==="auto"||N.line==="auto"?0:O.line>8&&N.line>8?N.line-O.line:O.line-N.line}),i.forEach(function(O){return uh(d,O)})),i}};function bm(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var _m=/(\d+)-(\d+)\/(\d+)/,Rh=function(){function u(o){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=o.fetchSetup||km,this.controller=new self.AbortController,this.stats=new sr}var d=u.prototype;return d.destroy=function(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null},d.abortInternal=function(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())},d.abort=function(){var s;this.abortInternal(),(s=this.callbacks)!=null&&s.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},d.load=function(s,t,i){var a=this,h=this.stats;if(h.loading.start)throw new Error("Loader can only be used once.");h.loading.start=self.performance.now();var g=Dm(s,this.controller.signal),m=s.responseType==="arraybuffer",p=m?"byteLength":"length",E=t.loadPolicy,x=E.maxTimeToFirstByteMs,I=E.maxLoadTimeMs;this.context=s,this.config=t,this.callbacks=i,this.request=this.fetchSetup(s,g),self.clearTimeout(this.requestTimeout),t.timeout=x&&ue(x)?x:I,this.requestTimeout=self.setTimeout(function(){a.callbacks&&(a.abortInternal(),a.callbacks.onTimeout(h,s,a.response))},t.timeout);var R=zr(this.request)?this.request.then(self.fetch):self.fetch(this.request);R.then(function(_){var P;a.response=a.loader=_;var O=Math.max(self.performance.now(),h.loading.start);if(self.clearTimeout(a.requestTimeout),t.timeout=I,a.requestTimeout=self.setTimeout(function(){a.callbacks&&(a.abortInternal(),a.callbacks.onTimeout(h,s,a.response))},I-(O-h.loading.start)),!_.ok){var N=_.status,U=_.statusText;throw new wm(U||"fetch, bad network response",N,_)}h.loading.first=O,h.total=Pm(_.headers)||h.total;var B=(P=a.callbacks)==null?void 0:P.onProgress;return B&&ue(t.highWaterMark)?a.loadProgressively(_,h,s,t.highWaterMark,B):m?_.arrayBuffer():s.responseType==="json"?_.json():_.text()}).then(function(_){var P,O,N=a.response;if(!N)throw new Error("loader destroyed");self.clearTimeout(a.requestTimeout),h.loading.end=Math.max(self.performance.now(),h.loading.first);var U=_[p];U&&(h.loaded=h.total=U);var B={url:N.url,data:_,code:N.status},G=(P=a.callbacks)==null?void 0:P.onProgress;G&&!ue(t.highWaterMark)&&G(h,s,_,N),(O=a.callbacks)==null||O.onSuccess(B,h,s,N)}).catch(function(_){var P;if(self.clearTimeout(a.requestTimeout),!h.aborted){var O=_&&_.code||0,N=_?_.message:null;(P=a.callbacks)==null||P.onError({code:O,text:N},s,_?_.details:null,h)}})},d.getCacheAge=function(){var s=null;if(this.response){var t=this.response.headers.get("age");s=t?parseFloat(t):null}return s},d.getResponseHeader=function(s){return this.response?this.response.headers.get(s):null},d.loadProgressively=function(s,t,i,a,h){a===void 0&&(a=0);var g=new gu,m=s.body.getReader(),p=function(){return m.read().then(function(x){if(x.done)return g.dataLength&&h(t,i,g.flush().buffer,s),Promise.resolve(new ArrayBuffer(0));var I=x.value,R=I.length;return t.loaded+=R,R<a||g.dataLength?(g.push(I),g.dataLength>=a&&h(t,i,g.flush().buffer,s)):h(t,i,I.buffer,s),p()}).catch(function(){return Promise.reject()})};return p()},u}();function Dm(u,d){var o={method:"GET",mode:"cors",credentials:"same-origin",signal:d,headers:new self.Headers(A({},u.headers))};return u.rangeEnd&&o.headers.set("Range","bytes="+u.rangeStart+"-"+String(u.rangeEnd-1)),o}function Cm(u){var d=_m.exec(u);if(d)return parseInt(d[2])-parseInt(d[1])+1}function Pm(u){var d=u.get("Content-Range");if(d){var o=Cm(d);if(ue(o))return o}var s=u.get("Content-Length");if(s)return parseInt(s)}function km(u,d){return new self.Request(u.url,d)}var wm=function(u){function d(o,s,t){var i;return i=u.call(this,o)||this,i.code=void 0,i.details=void 0,i.code=s,i.details=t,i}return b(d,u),d}(Q(Error)),Om=/^age:\s*[\d.]+\s*$/im,bh=function(){function u(o){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=o&&o.xhrSetup||null,this.stats=new sr,this.retryDelay=0}var d=u.prototype;return d.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null},d.abortInternal=function(){var s=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),s&&(s.onreadystatechange=null,s.onprogress=null,s.readyState!==4&&(this.stats.aborted=!0,s.abort()))},d.abort=function(){var s;this.abortInternal(),(s=this.callbacks)!=null&&s.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},d.load=function(s,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=s,this.config=t,this.callbacks=i,this.loadInternal()},d.loadInternal=function(){var s=this,t=this.config,i=this.context;if(!(!t||!i)){var a=this.loader=new self.XMLHttpRequest,h=this.stats;h.loading.first=0,h.loaded=0,h.aborted=!1;var g=this.xhrSetup;g?Promise.resolve().then(function(){if(!(s.loader!==a||s.stats.aborted))return g(a,i.url)}).catch(function(m){if(!(s.loader!==a||s.stats.aborted))return a.open("GET",i.url,!0),g(a,i.url)}).then(function(){s.loader!==a||s.stats.aborted||s.openAndSendXhr(a,i,t)}).catch(function(m){var p;(p=s.callbacks)==null||p.onError({code:a.status,text:m.message},i,a,h)}):this.openAndSendXhr(a,i,t)}},d.openAndSendXhr=function(s,t,i){s.readyState||s.open("GET",t.url,!0);var a=t.headers,h=i.loadPolicy,g=h.maxTimeToFirstByteMs,m=h.maxLoadTimeMs;if(a)for(var p in a)s.setRequestHeader(p,a[p]);t.rangeEnd&&s.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),s.onreadystatechange=this.readystatechange.bind(this),s.onprogress=this.loadprogress.bind(this),s.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=g&&ue(g)?g:m,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),s.send()},d.readystatechange=function(){var s=this.context,t=this.loader,i=this.stats;if(!(!s||!t)){var a=t.readyState,h=this.config;if(!i.aborted&&a>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),h.timeout!==h.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),h.timeout=h.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),h.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),a===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;var g=t.status,m=t.responseType==="text"?t.responseText:null;if(g>=200&&g<300){var p=m??t.response;if(p!=null){var E,x;i.loading.end=Math.max(self.performance.now(),i.loading.first);var I=t.responseType==="arraybuffer"?p.byteLength:p.length;i.loaded=i.total=I,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);var R=(E=this.callbacks)==null?void 0:E.onProgress;R&&R(i,s,p,t);var _={url:t.responseURL,data:p,code:g};(x=this.callbacks)==null||x.onSuccess(_,i,s,t);return}}var P=h.loadPolicy.errorRetry,O=i.retry,N={url:s.url,data:void 0,code:g};if(Ts(P,O,!1,N))this.retry(P);else{var U;Ye.error(g+" while loading "+s.url),(U=this.callbacks)==null||U.onError({code:g,text:t.statusText},s,t,i)}}}},d.loadtimeout=function(){if(this.config){var s=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Ts(s,t,!0))this.retry(s);else{var i;Ye.warn("timeout while loading "+((i=this.context)==null?void 0:i.url));var a=this.callbacks;a&&(this.abortInternal(),a.onTimeout(this.stats,this.context,this.loader))}}},d.retry=function(s){var t=this.context,i=this.stats;this.retryDelay=Vn(s,i.retry),i.retry++,Ye.warn((status?"HTTP Status "+status:"Timeout")+" while loading "+(t==null?void 0:t.url)+", retrying "+i.retry+"/"+s.maxNumRetry+" in "+this.retryDelay+"ms"),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)},d.loadprogress=function(s){var t=this.stats;t.loaded=s.loaded,s.lengthComputable&&(t.total=s.total)},d.getCacheAge=function(){var s=null;if(this.loader&&Om.test(this.loader.getAllResponseHeaders())){var t=this.loader.getResponseHeader("age");s=t?parseFloat(t):null}return s},d.getResponseHeader=function(s){return this.loader&&new RegExp("^"+s+":\\s*[\\d.]+\\s*$","im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(s):null},u}(),Mm={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Fm=F(F({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:bh,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:rg,bufferController:X0,capLevelController:Q0,errorController:lg,fpsController:Gv,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Yl,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,certLoadPolicy:{default:Mm},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Nm()),{},{subtitleStreamController:jv,subtitleTrackController:Zv,timelineController:xm,audioStreamController:Y0,audioTrackController:W0,emeController:ih,cmcdController:Nv,contentSteeringController:Bv,interstitialsController:qv});function Nm(){return{cueHandler:Rm,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Um(u,d,o){if((d.liveSyncDurationCount||d.liveMaxLatencyDurationCount)&&(d.liveSyncDuration||d.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(d.liveMaxLatencyDurationCount!==void 0&&(d.liveSyncDurationCount===void 0||d.liveMaxLatencyDurationCount<=d.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(d.liveMaxLatencyDuration!==void 0&&(d.liveSyncDuration===void 0||d.liveMaxLatencyDuration<=d.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');var s=Ba(u),t=["manifest","level","frag"],i=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return t.forEach(function(a){var h=(a==="level"?"playlist":a)+"LoadPolicy",g=d[h]===void 0,m=[];i.forEach(function(p){var E=a+"Loading"+p,x=d[E];if(x!==void 0&&g){m.push(E);var I=s[h].default;switch(d[h]={default:I},p){case"TimeOut":I.maxLoadTimeMs=x,I.maxTimeToFirstByteMs=x;break;case"MaxRetry":I.errorRetry.maxNumRetry=x,I.timeoutRetry.maxNumRetry=x;break;case"RetryDelay":I.errorRetry.retryDelayMs=x,I.timeoutRetry.retryDelayMs=x;break;case"MaxRetryTimeout":I.errorRetry.maxRetryDelayMs=x,I.timeoutRetry.maxRetryDelayMs=x;break}}}),m.length&&o.warn('hls.js config: "'+m.join('", "')+'" setting(s) are deprecated, use "'+h+'": '+at(d[h]))}),F(F({},s),d)}function Ba(u){return u&&typeof u=="object"?Array.isArray(u)?u.map(Ba):Object.keys(u).reduce(function(d,o){return d[o]=Ba(u[o]),d},{}):u}function Bm(u,d){var o=u.loader;if(o!==Rh&&o!==bh)d.log("[config]: Custom loader detected, cannot enable progressive streaming"),u.progressive=!1;else{var s=bm();s&&(u.loader=Rh,u.progressive=!0,u.enableSoftwareAES=!0,d.log("[config]: Progressive streaming enabled, using FetchLoader"))}}var $s=2,Gm=.1,$m=.05,Km=100,Vm=function(u){function d(s,t){var i;return i=u.call(this,"gap-controller",s.logger)||this,i.hls=null,i.fragmentTracker=null,i.media=null,i.mediaSource=void 0,i.nudgeRetry=0,i.stallReported=!1,i.stalled=null,i.moved=!1,i.seeking=!1,i.buffered={},i.lastCurrentTime=0,i.ended=0,i.waiting=0,i.onMediaPlaying=function(){i.ended=0,i.waiting=0},i.onMediaWaiting=function(){var a;(a=i.media)!=null&&a.seeking||(i.waiting=self.performance.now(),i.tick())},i.onMediaEnded=function(){if(i.hls){var a;i.ended=((a=i.media)==null?void 0:a.currentTime)||1,i.hls.trigger(k.MEDIA_ENDED,{stalled:!1})}},i.hls=s,i.fragmentTracker=t,i.registerListeners(),i}b(d,u);var o=d.prototype;return o.registerListeners=function(){var t=this.hls;t&&(t.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(k.BUFFER_APPENDED,this.onBufferAppended,this))},o.unregisterListeners=function(){var t=this.hls;t&&(t.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(k.BUFFER_APPENDED,this.onBufferAppended,this))},o.destroy=function(){u.prototype.destroy.call(this),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0},o.onMediaAttached=function(t,i){this.setInterval(Km),this.mediaSource=i.mediaSource;var a=this.media=i.media;xr(a,"playing",this.onMediaPlaying),xr(a,"waiting",this.onMediaWaiting),xr(a,"ended",this.onMediaEnded)},o.onMediaDetaching=function(t,i){this.clearInterval();var a=this.media;a&&(hr(a,"playing",this.onMediaPlaying),hr(a,"waiting",this.onMediaWaiting),hr(a,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0},o.onBufferAppended=function(t,i){this.buffered=i.timeRanges},o.tick=function(){var t;if(!(!((t=this.media)!=null&&t.readyState)||!this.hasBuffered)){var i=this.media.currentTime;this.poll(i,this.lastCurrentTime),this.lastCurrentTime=i}},o.poll=function(t,i){var a,h,g=(a=this.hls)==null?void 0:a.config;if(g){var m=this.media,p=this.stalled;if(m){var E=m.seeking,x=this.seeking&&!E,I=!this.seeking&&E,R=m.paused&&!E||m.ended||m.playbackRate===0;if(this.seeking=E,t!==i){i&&(this.ended=0),this.moved=!0,E||(this.nudgeRetry=0,g.nudgeOnVideoHole&&!R&&t>i&&this.nudgeOnVideoHole(t,i)),this.waiting===0&&this.stallResolved(t);return}if(I||x){x&&this.stallResolved(t);return}if(R){this.nudgeRetry=0,this.stallResolved(t),!this.ended&&m.ended&&this.hls&&(this.ended=t||1,this.hls.trigger(k.MEDIA_ENDED,{stalled:!1}));return}if(!We.getBuffered(m).length){this.nudgeRetry=0;return}var _=We.bufferInfo(m,t,0),P=_.nextStart||0,O=this.fragmentTracker;if(E&&O&&this.hls){var N=_h(this.hls.inFlightFragments,t),U=_.len>$s,B=!P||N||P-t>$s&&!O.getPartialFragment(t);if(U||B)return;this.moved=!1}var G=(h=this.hls)==null?void 0:h.latestLevelDetails;if(!this.moved&&this.stalled!==null&&O){var Y=_.len>0;if(!Y&&!P)return;var V=Math.max(P,_.start||0)-t,j=!!(G!=null&&G.live),ae=j?G.targetduration*2:$s,X=O.getPartialFragment(t);if(V>0&&(V<=ae||X)){m.paused||this._trySkipBufferHole(X);return}}var W=g.detectStallWithCurrentTimeMs,J=self.performance.now(),oe=this.waiting;if(p===null){oe>0&&J-oe<W?this.stalled=oe:this.stalled=J;return}var ge=J-p;if(!E&&(ge>=W||oe)&&this.hls){var ce;if(((ce=this.mediaSource)==null?void 0:ce.readyState)==="ended"&&!(G!=null&&G.live)&&Math.abs(t-((G==null?void 0:G.edge)||0))<1){if(this.ended)return;this.ended=t||1,this.hls.trigger(k.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(_),!this.media||!this.hls)return}var he=We.bufferInfo(m,t,g.maxBufferHole);this._tryFixBufferStall(he,ge)}}},o.stallResolved=function(t){var i=this.stalled;if(i&&this.hls&&(this.stalled=null,this.stallReported)){var a=self.performance.now()-i;this.log("playback not stuck anymore @"+t+", after "+Math.round(a)+"ms"),this.stallReported=!1,this.waiting=0,this.hls.trigger(k.STALL_RESOLVED,{})}},o.nudgeOnVideoHole=function(t,i){var a,h=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(a=this.buffered.audio)!=null&&a.length&&h&&h.length>1&&t>h.end(0)){var g=We.bufferedInfo(We.timeRangesToArray(this.buffered.audio),t,0);if(g.len>1&&i>=g.start){var m=We.timeRangesToArray(h),p=We.bufferedInfo(m,i,0).bufferedIndex;if(p>-1&&p<m.length-1){var E=We.bufferedInfo(m,t,0).bufferedIndex,x=m[p].end,I=m[p+1].start;if((E===-1||E>p)&&I-x<1&&t-x<2){var R=new Error("nudging playhead to flush pipeline after video hole. currentTime: "+t+" hole: "+x+" -> "+I+" buffered index: "+E);this.warn(R.message),this.media.currentTime+=1e-6;var _=this.fragmentTracker.getPartialFragment(t)||void 0,P=We.bufferInfo(this.media,t,0);this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:R,reason:R.message,frag:_,buffer:P.len,bufferInfo:P})}}}}},o._tryFixBufferStall=function(t,i){var a,h,g=this.fragmentTracker,m=this.media,p=(a=this.hls)==null?void 0:a.config;if(!(!m||!g||!p)){var E=m.currentTime,x=(h=this.hls)==null?void 0:h.latestLevelDetails,I=g.getPartialFragment(E);if(I||x!=null&&x.live&&E<x.fragmentStart){var R=this._trySkipBufferHole(I);if(R||!this.media)return}var _=t.buffered;(_&&_.length>1&&t.len>p.maxBufferHole||t.nextStart&&t.nextStart-E<p.maxBufferHole)&&(i>p.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(t))}},o._reportStall=function(t){var i=this.hls,a=this.media,h=this.stallReported,g=this.stalled;if(!h&&g!==null&&a&&i){this.stallReported=!0;var m=new Error("Playback stalling at @"+a.currentTime+" due to low buffer ("+at(t)+")");this.warn(m.message),i.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_STALLED_ERROR,fatal:!1,error:m,buffer:t.len,bufferInfo:t,stalled:{start:g}})}},o._trySkipBufferHole=function(t){var i,a=this.fragmentTracker,h=this.media,g=(i=this.hls)==null?void 0:i.config;if(!h||!a||!g)return 0;var m=h.currentTime,p=We.bufferInfo(h,m,0),E=m<p.start?p.start:p.nextStart;if(E&&this.hls){var x=p.len<=g.maxBufferHole,I=p.len>0&&p.len<1&&h.readyState<3,R=E-m;if(R>0&&(x||I)){if(R>g.maxBufferHole){var _=!1;if(m===0){var P=a.getAppendedFrag(0,pe.MAIN);P&&E<P.end&&(_=!0)}if(!_){var O=t||a.getAppendedFrag(m,pe.MAIN);if(O){var N;if(!((N=this.hls.loadLevelObj)!=null&&N.details))return 0;var U=_h(this.hls.inFlightFragments,E);if(U)return 0;for(var B=!1,G=O.end;G<E;){var Y=a.getPartialFragment(G);if(Y)G+=Y.duration;else{B=!0;break}}if(B)return 0}}}var V=Math.max(E+$m,m+Gm);if(this.warn("skipping hole, adjusting currentTime from "+m+" to "+V),this.moved=!0,h.currentTime=V,!(t!=null&&t.gap)){var j=new Error("fragment loaded with buffer holes, seeking from "+m+" to "+V);this.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:j,reason:j.message,frag:t||void 0,buffer:p.len,bufferInfo:p})}return V}}return 0},o._tryNudgeBuffer=function(t){var i=this.hls,a=this.media,h=this.nudgeRetry,g=i==null?void 0:i.config;if(!a||!g)return 0;var m=a.currentTime;if(this.nudgeRetry++,h<g.nudgeMaxRetry){var p=m+(h+1)*g.nudgeOffset,E=new Error("Nudging 'currentTime' from "+m+" to "+p);this.warn(E.message),a.currentTime=p,i.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_NUDGE_ON_STALL,error:E,fatal:!1,buffer:t.len,bufferInfo:t})}else{var x=new Error("Playhead still not moving while enough data buffered @"+m+" after "+g.nudgeMaxRetry+" nudges");this.error(x.message),i.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.BUFFER_STALLED_ERROR,error:x,fatal:!0,buffer:t.len,bufferInfo:t})}},y(d,[{key:"hasBuffered",get:function(){return Object.keys(this.buffered).length>0}}])}(Ul);function _h(u,d){var o=Dh(u.main);if(o&&o.start<=d)return o;var s=Dh(u.audio);return s&&s.start<=d?s:null}function Dh(u){if(!u)return null;switch(u.state){case fe.IDLE:case fe.STOPPED:case fe.ENDED:case fe.ERROR:return null}return u.frag}var Hm=.25;function Ga(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function Ch(u,d,o,s,t){var i=new u(d,o,"");try{i.value=s,t&&(i.type=t)}catch{i=new u(d,o,at(t?F({type:t},s):s))}return i}var Ks=function(){var u=Ga();try{u&&new u(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY}();function Ym(u){return Uint8Array.from(u.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}var Wm=function(){function u(o){var s=this;this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=function(){s.hls&&s.hls.trigger(k.EVENT_CUE_ENTER,{})},this.hls=o,this._registerListeners()}var d=u.prototype;return d.destroy=function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null},d._registerListeners=function(){var s=this.hls;s.on(k.MEDIA_ATTACHING,this.onMediaAttaching,this),s.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),s.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),s.on(k.MANIFEST_LOADING,this.onManifestLoading,this),s.on(k.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),s.on(k.BUFFER_FLUSHING,this.onBufferFlushing,this),s.on(k.LEVEL_UPDATED,this.onLevelUpdated,this),s.on(k.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)},d._unregisterListeners=function(){var s=this.hls;s.off(k.MEDIA_ATTACHING,this.onMediaAttaching,this),s.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),s.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),s.off(k.MANIFEST_LOADING,this.onManifestLoading,this),s.off(k.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),s.off(k.BUFFER_FLUSHING,this.onBufferFlushing,this),s.off(k.LEVEL_UPDATED,this.onLevelUpdated,this),s.off(k.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)},d.onMediaAttaching=function(s,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)},d.onMediaAttached=function(){var s=this.hls.latestLevelDetails;s&&this.updateDateRangeCues(s)},d.onMediaDetaching=function(s,t){this.media=null;var i=!!t.transferMedia;i||(this.id3Track&&(this.removeCues&&vi(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})},d.onManifestLoading=function(){this.dateRangeCuesAppended={}},d.createTrack=function(s){var t=this.getID3Track(s.textTracks);return t.mode="hidden",t},d.getID3Track=function(s){if(this.media){for(var t=0;t<s.length;t++){var i=s[t];if(i.kind==="metadata"&&i.label==="id3")return lh(i,this.media),i}return this.media.addTextTrack("metadata","id3")}},d.onFragParsingMetadata=function(s,t){if(this.media){var i=this.hls.config,a=i.enableEmsgMetadataCues,h=i.enableID3MetadataCues;if(!(!a&&!h)){var g=t.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));var m=Ga();if(m)for(var p=0;p<g.length;p++){var E=g[p].type;if(!(E===Kt.emsg&&!a||!h)){var x=Au(g[p].data);if(x){var I=g[p].pts,R=I+g[p].duration;R>Ks&&(R=Ks);var _=R-I;_<=0&&(R=I+Hm);for(var P=0;P<x.length;P++){var O=x[P];if(!xu(O)){this.updateId3CueEnds(I,E);var N=Ch(m,I,R,O,E);N&&this.id3Track.addCue(N)}}}}}}}},d.updateId3CueEnds=function(s,t){var i,a=(i=this.id3Track)==null?void 0:i.cues;if(a)for(var h=a.length;h--;){var g=a[h];g.type===t&&g.startTime<s&&g.endTime===Ks&&(g.endTime=s)}},d.onBufferFlushing=function(s,t){var i=t.startOffset,a=t.endOffset,h=t.type,g=this.id3Track,m=this.hls;if(m){var p=m.config,E=p.enableEmsgMetadataCues,x=p.enableID3MetadataCues;if(g&&(E||x)){var I;h==="audio"?I=function(_){return _.type===Kt.audioId3&&x}:h==="video"?I=function(_){return _.type===Kt.emsg&&E}:I=function(_){return _.type===Kt.audioId3&&x||_.type===Kt.emsg&&E},Da(g,i,a,I)}}},d.onLevelUpdated=function(s,t){var i=t.details;this.updateDateRangeCues(i,!0)},d.onLevelPtsUpdated=function(s,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)},d.updateDateRangeCues=function(s,t){var i=this;if(!(!this.media||!s.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)){var a=this.id3Track,h=s.dateRanges,g=Object.keys(h),m=this.dateRangeCuesAppended;if(a&&t){var p;if((p=a.cues)!=null&&p.length)for(var E=Object.keys(m).filter(function(N){return!g.includes(N)}),x=function(){var U=E[I],B=m[U].cues;delete m[U],Object.keys(B).forEach(function(G){try{var Y=B[G];Y.removeEventListener("enter",i.onEventCueEnter),a.removeCue(Y)}catch{}})},I=E.length;I--;)x();else m=this.dateRangeCuesAppended={}}var R=s.fragments[s.fragments.length-1];if(!(g.length===0||!ue(R==null?void 0:R.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var _=Ga(),P=function(){var U=g[O],B=h[U],G=B.startTime,Y=m[U],V=(Y==null?void 0:Y.cues)||{},j=(Y==null?void 0:Y.durationKnown)||!1,ae=Ks,X=B.duration,W=B.endDate;if(W&&X!==null)ae=G+X,j=!0;else if(B.endOnNext&&!j){var J=g.reduce(function(Ie,He){if(He!==B.id){var Oe=h[He];if(Oe.class===B.class&&Oe.startDate>B.startDate&&(!Ie||B.startDate<Ie.startDate))return Oe}return Ie},null);J&&(ae=J.startTime,j=!0)}for(var oe=Object.keys(B.attr),ge=0;ge<oe.length;ge++){var ce=oe[ge];if(Sg(ce)){var he=V[ce];if(he)j&&!Y.durationKnown?he.endTime=ae:Math.abs(he.startTime-G)>.01&&(he.startTime=G,he.endTime=ae);else if(_){var ye=B.attr[ce];Ag(ce)&&(ye=Ym(ye));var Se={key:ce,data:ye},Le=Ch(_,G,ae,Se,Kt.dateRange);Le&&(Le.id=U,i.id3Track.addCue(Le),V[ce]=Le,i.hls.config.interstitialsController&&(ce==="X-ASSET-LIST"||ce==="X-ASSET-URL")&&Le.addEventListener("enter",i.onEventCueEnter))}}}m[U]={cues:V,dateRange:B,durationKnown:j}},O=0;O<g.length;O++)P()}}},u}(),qm=function(){function u(o){var s=this;this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=function(){var t=s.media,i=s.levelDetails;if(!(!t||!i)){s.currentTime=t.currentTime;var a=s.computeLatency();if(a!==null){s._latency=a;var h=s.config,g=h.lowLatencyMode,m=h.maxLiveSyncPlaybackRate;if(!(!g||m===1||!i.live)){var p=s.targetLatency;if(p!==null){var E=a-p,x=Math.min(s.maxLatency,p+i.targetduration),I=E<x;if(I&&E>.05&&s.forwardBufferLength>1){var R=Math.min(2,Math.max(1,m)),_=Math.round(2/(1+Math.exp(-.75*E-s.edgeStalled))*20)/20,P=Math.min(R,Math.max(1,_));s.changeMediaPlaybackRate(t,P)}else t.playbackRate!==1&&t.playbackRate!==0&&s.changeMediaPlaybackRate(t,1)}}}}},this.hls=o,this.config=o.config,this.registerListeners()}var d=u.prototype;return d.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null},d.registerListeners=function(){var s=this.hls;s&&(s.on(k.MEDIA_ATTACHED,this.onMediaAttached,this),s.on(k.MEDIA_DETACHING,this.onMediaDetaching,this),s.on(k.MANIFEST_LOADING,this.onManifestLoading,this),s.on(k.LEVEL_UPDATED,this.onLevelUpdated,this),s.on(k.ERROR,this.onError,this))},d.unregisterListeners=function(){var s=this.hls;s&&(s.off(k.MEDIA_ATTACHED,this.onMediaAttached,this),s.off(k.MEDIA_DETACHING,this.onMediaDetaching,this),s.off(k.MANIFEST_LOADING,this.onManifestLoading,this),s.off(k.LEVEL_UPDATED,this.onLevelUpdated,this),s.off(k.ERROR,this.onError,this))},d.onMediaAttached=function(s,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)},d.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)},d.onManifestLoading=function(){this._latency=null,this.stallCount=0},d.onLevelUpdated=function(s,t){var i=t.details;i.advanced&&this.onTimeupdate(),!i.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)},d.onError=function(s,t){var i;t.details===q.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))},d.changeMediaPlaybackRate=function(s,t){var i,a;s.playbackRate!==t&&((i=this.hls)==null||i.logger.debug("[latency-controller]: latency="+this.latency.toFixed(3)+", targetLatency="+((a=this.targetLatency)==null?void 0:a.toFixed(3))+", forwardBufferLength="+this.forwardBufferLength.toFixed(3)+": adjusting playback rate from "+s.playbackRate+" to "+t),s.playbackRate=t)},d.estimateLiveEdge=function(){var s=this.levelDetails;return s===null?null:s.edge+s.age},d.computeLatency=function(){var s=this.estimateLiveEdge();return s===null?null:s-this.currentTime},y(u,[{key:"levelDetails",get:function(){var s;return((s=this.hls)==null?void 0:s.latestLevelDetails)||null}},{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var s=this.config;if(s.liveMaxLatencyDuration!==void 0)return s.liveMaxLatencyDuration;var t=this.levelDetails;return t?s.liveMaxLatencyDurationCount*t.targetduration:0}},{key:"targetLatency",get:function(){var s=this.levelDetails;if(s===null||this.hls===null)return null;var t=s.holdBack,i=s.partHoldBack,a=s.targetduration,h=this.config,g=h.liveSyncDuration,m=h.liveSyncDurationCount,p=h.lowLatencyMode,E=this.hls.userConfig,x=p&&i||t;(this._targetLatencyUpdated||E.liveSyncDuration||E.liveSyncDurationCount||x===0)&&(x=g!==void 0?g:m*a);var I=a;return x+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,I)},set:function(s){this.stallCount=0,this.config.liveSyncDuration=s,this._targetLatencyUpdated=!0}},{key:"liveSyncPosition",get:function(){var s=this.estimateLiveEdge(),t=this.targetLatency;if(s===null||t===null)return null;var i=this.levelDetails;if(i===null)return null;var a=i.edge,h=s-t-this.edgeStalled,g=a-i.totalduration,m=a-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(g,h),m)}},{key:"drift",get:function(){var s=this.levelDetails;return s===null?1:s.drift}},{key:"edgeStalled",get:function(){var s=this.levelDetails;if(s===null)return 0;var t=(this.config.lowLatencyMode&&s.partTarget||s.targetduration)*3;return Math.max(s.age-t,0)}},{key:"forwardBufferLength",get:function(){var s=this.media,t=this.levelDetails;if(!s||!t)return 0;var i=s.buffered.length;return(i?s.buffered.end(i-1):t.edge)-this.currentTime}}])}(),jm=function(u){function d(s,t){var i;return i=u.call(this,s,"level-controller")||this,i._levels=[],i._firstLevel=-1,i._maxAutoLevel=-1,i._startLevel=void 0,i.currentLevel=null,i.currentLevelIndex=-1,i.manualLevelIndex=-1,i.steering=void 0,i.onParsedComplete=void 0,i.steering=t,i._registerListeners(),i}b(d,u);var o=d.prototype;return o._registerListeners=function(){var t=this.hls;t.on(k.MANIFEST_LOADING,this.onManifestLoading,this),t.on(k.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(k.LEVEL_LOADED,this.onLevelLoaded,this),t.on(k.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(k.FRAG_BUFFERED,this.onFragBuffered,this),t.on(k.ERROR,this.onError,this)},o._unregisterListeners=function(){var t=this.hls;t.off(k.MANIFEST_LOADING,this.onManifestLoading,this),t.off(k.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(k.LEVEL_LOADED,this.onLevelLoaded,this),t.off(k.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(k.FRAG_BUFFERED,this.onFragBuffered,this),t.off(k.ERROR,this.onError,this)},o.destroy=function(){this._unregisterListeners(),this.steering=null,this.resetLevels(),u.prototype.destroy.call(this)},o.stopLoad=function(){var t=this._levels;t.forEach(function(i){i.loadError=0,i.fragmentError=0}),u.prototype.stopLoad.call(this)},o.resetLevels=function(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1},o.onManifestLoading=function(t,i){this.resetLevels()},o.onManifestLoaded=function(t,i){var a=this,h=this.hls.config.preferManagedMediaSource,g=[],m={},p={},E=!1,x=!1,I=!1;i.levels.forEach(function(R){var _,P=R.attrs,O=R.audioCodec,N=R.videoCodec;O&&(R.audioCodec=O=gs(O,h)||void 0),((_=N)==null?void 0:_.indexOf("avc1"))===0&&(N=R.videoCodec=Kc(N));var U=R.width,B=R.height,G=R.unknownCodecs,Y=G?G.length:0;if(G)for(var V=Y;V--;){var j=G[V];a.isAudioSupported(j)?(R.audioCodec=O=O?O+","+j:j,Y--,ai.audio[O.substring(0,4)]=2):a.isVideoSupported(j)&&(R.videoCodec=N=N?N+","+j:j,Y--,ai.video[N.substring(0,4)]=2)}if(E||(E=!!(U&&B)),x||(x=!!N),I||(I=!!O),Y||O&&!a.isAudioSupported(O)||N&&!a.isVideoSupported(N)){a.log('Some or all CODECS not supported "'+P.CODECS+'"');return}var ae=P.CODECS,X=P["FRAME-RATE"],W=P["HDCP-LEVEL"],J=P["PATHWAY-ID"],oe=P.RESOLUTION,ge=P["VIDEO-RANGE"],ce=(J||".")+"-",he=""+ce+R.bitrate+"-"+oe+"-"+X+"-"+ae+"-"+ge+"-"+W;if(m[he])if(m[he].uri!==R.url&&!R.attrs["PATHWAY-ID"]){var Se=p[he]+=1;R.attrs["PATHWAY-ID"]=new Array(Se+1).join(".");var Le=a.createLevel(R);m[he]=Le,g.push(Le)}else m[he].addGroupId("audio",P.AUDIO),m[he].addGroupId("text",P.SUBTITLES);else{var ye=a.createLevel(R);m[he]=ye,p[he]=1,g.push(ye)}}),this.filterAndSortMediaOptions(g,i,E,x,I)},o.createLevel=function(t){var i=new Mi(t),a=t.supplemental;if(a!=null&&a.videoCodec&&!this.isVideoSupported(a.videoCodec)){var h=new Error('SUPPLEMENTAL-CODECS not supported "'+a.videoCodec+'"');this.log(h.message),i.supportedResult=Al(h,[])}return i},o.isAudioSupported=function(t){return Bn(t,"audio",this.hls.config.preferManagedMediaSource)},o.isVideoSupported=function(t){return Bn(t,"video",this.hls.config.preferManagedMediaSource)},o.filterAndSortMediaOptions=function(t,i,a,h,g){var m=this,p=[],E=[],x=t;if((a||h)&&g&&(x=x.filter(function(V){var j=V.videoCodec,ae=V.videoRange,X=V.width,W=V.height;return(!!j||!!(X&&W))&&qc(ae)})),x.length===0){Promise.resolve().then(function(){if(m.hls){var V="no level with compatible codecs found in manifest",j=V;i.levels.length&&(j="one or more CODECS in variant not supported: "+at(i.levels.map(function(X){return X.attrs.CODECS}).filter(function(X,W,J){return J.indexOf(X)===W})),m.warn(j),V+=" ("+j+")");var ae=new Error(V);m.hls.trigger(k.ERROR,{type:se.MEDIA_ERROR,details:q.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:i.url,error:ae,reason:j})}});return}i.audioTracks&&(p=i.audioTracks.filter(function(V){return!V.audioCodec||m.isAudioSupported(V.audioCodec)}),Ph(p)),i.subtitles&&(E=i.subtitles,Ph(E));var I=x.slice(0);x.sort(function(V,j){if(V.attrs["HDCP-LEVEL"]!==j.attrs["HDCP-LEVEL"])return(V.attrs["HDCP-LEVEL"]||"")>(j.attrs["HDCP-LEVEL"]||"")?1:-1;if(a&&V.height!==j.height)return V.height-j.height;if(V.frameRate!==j.frameRate)return V.frameRate-j.frameRate;if(V.videoRange!==j.videoRange)return ms.indexOf(V.videoRange)-ms.indexOf(j.videoRange);if(V.videoCodec!==j.videoCodec){var ae=yl(V.videoCodec),X=yl(j.videoCodec);if(ae!==X)return X-ae}if(V.uri===j.uri&&V.codecSet!==j.codecSet){var W=cs(V.codecSet),J=cs(j.codecSet);if(W!==J)return J-W}return V.averageBitrate!==j.averageBitrate?V.averageBitrate-j.averageBitrate:0});var R=I[0];if(this.steering&&(x=this.steering.filterParsedLevels(x),x.length!==I.length)){for(var _=0;_<I.length;_++)if(I[_].pathwayId===x[0].pathwayId){R=I[_];break}}this._levels=x;for(var P=0;P<x.length;P++)if(x[P]===R){var O;this._firstLevel=P;var N=R.bitrate,U=this.hls.bandwidthEstimate;if(this.log("manifest loaded, "+x.length+" level(s) found, first bitrate: "+N),((O=this.hls.userConfig)==null?void 0:O.abrEwmaDefaultEstimate)===void 0){var B=Math.min(N,this.hls.config.abrEwmaDefaultEstimateMax);B>U&&U===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=B)}break}var G=g&&!h,Y={levels:x,audioTracks:p,subtitleTracks:E,sessionData:i.sessionData,sessionKeys:i.sessionKeys,firstLevel:this._firstLevel,stats:i.stats,audio:g,video:h,altAudio:!G&&p.some(function(V){return!!V.url})};this.hls.trigger(k.MANIFEST_PARSED,Y)},o.onError=function(t,i){i.fatal||!i.context||i.context.type===Te.LEVEL&&i.context.level===this.level&&this.checkRetry(i)},o.onFragBuffered=function(t,i){var a=i.frag;if(a!==void 0&&a.type===pe.MAIN){var h=a.elementaryStreams;if(!Object.keys(h).some(function(m){return!!h[m]}))return;var g=this._levels[a.level];g!=null&&g.loadError&&(this.log("Resetting level error count of "+g.loadError+" on frag buffered"),g.loadError=0)}},o.onLevelLoaded=function(t,i){var a,h=i.level,g=i.details,m=i.levelInfo;if(!m){var p;this.warn("Invalid level index "+h),(p=i.deliveryDirectives)!=null&&p.skip&&(g.deltaUpdateFailed=!0);return}if(m===this.currentLevel||i.withoutMultiVariant){m.fragmentError===0&&(m.loadError=0);var E=m.details;E===i.details&&E.advanced&&(E=void 0),this.playlistLoaded(h,i,E)}else(a=i.deliveryDirectives)!=null&&a.skip&&(g.deltaUpdateFailed=!0)},o.loadPlaylist=function(t){u.prototype.loadPlaylist.call(this),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,t)},o.loadingPlaylist=function(t,i){u.prototype.loadingPlaylist.call(this,t,i);var a=this.getUrlWithDirectives(t.uri,i),h=this.currentLevelIndex,g=t.attrs["PATHWAY-ID"],m=t.details,p=m==null?void 0:m.age;this.log("Loading level index "+h+((i==null?void 0:i.msn)!==void 0?" at sn "+i.msn+" part "+i.part:"")+(g?" Pathway "+g:"")+(p&&m.live?" age "+p.toFixed(1)+(m.type&&" "+m.type||""):"")+" "+a),this.hls.trigger(k.LEVEL_LOADING,{url:a,level:h,levelInfo:t,pathwayId:t.attrs["PATHWAY-ID"],id:0,deliveryDirectives:i||null})},o.removeLevel=function(t){var i=this,a;if(this._levels.length!==1){var h=this._levels.filter(function(m,p){return p!==t?!0:(i.steering&&i.steering.removeLevel(m),m===i.currentLevel&&(i.currentLevel=null,i.currentLevelIndex=-1,m.details&&m.details.fragments.forEach(function(E){return E.level=-1})),!1)});uu(h),this._levels=h,this.currentLevelIndex>-1&&(a=this.currentLevel)!=null&&a.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);var g=h.length-1;this._firstLevel=Math.min(this._firstLevel,g),this._startLevel&&(this._startLevel=Math.min(this._startLevel,g)),this.hls.trigger(k.LEVELS_UPDATED,{levels:h})}},o.onLevelsUpdated=function(t,i){var a=i.levels;this._levels=a},o.checkMaxAutoUpdated=function(){var t=this.hls,i=t.autoLevelCapping,a=t.maxAutoLevel,h=t.maxHdcpLevel;this._maxAutoLevel!==a&&(this._maxAutoLevel=a,this.hls.trigger(k.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:i,levels:this.levels,maxAutoLevel:a,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:h}))},y(d,[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"loadLevelObj",get:function(){return this.currentLevel}},{key:"level",get:function(){return this.currentLevelIndex},set:function(t){var i=this._levels;if(i.length!==0){if(t<0||t>=i.length){var a=new Error("invalid level idx"),h=t<0;if(this.hls.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.LEVEL_SWITCH_ERROR,level:t,fatal:h,error:a,reason:a.message}),h)return;t=Math.min(t,i.length-1)}var g=this.currentLevelIndex,m=this.currentLevel,p=m?m.attrs["PATHWAY-ID"]:void 0,E=i[t],x=E.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=E,!(g===t&&m&&p===x)){this.log("Switching to level "+t+" ("+(E.height?E.height+"p ":"")+(E.videoRange?E.videoRange+" ":"")+(E.codecSet?E.codecSet+" ":"")+"@"+E.bitrate+")"+(x?" with Pathway "+x:"")+" from level "+g+(p?" with Pathway "+p:""));var I={level:t,attrs:E.attrs,details:E.details,bitrate:E.bitrate,averageBitrate:E.averageBitrate,maxBitrate:E.maxBitrate,realBitrate:E.realBitrate,width:E.width,height:E.height,codecSet:E.codecSet,audioCodec:E.audioCodec,videoCodec:E.videoCodec,audioGroups:E.audioGroups,subtitleGroups:E.subtitleGroups,loaded:E.loaded,loadError:E.loadError,fragmentError:E.fragmentError,name:E.name,id:E.id,uri:E.uri,url:E.url,urlId:0,audioGroupIds:E.audioGroupIds,textGroupIds:E.textGroupIds};this.hls.trigger(k.LEVEL_SWITCHING,I);var R=E.details;if(!R||R.live){var _=this.switchParams(E.uri,m==null?void 0:m.details,R);this.loadPlaylist(_)}}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(t){this.manualLevelIndex=t,this._startLevel===void 0&&(this._startLevel=t),t!==-1&&(this.level=t)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(t){this._firstLevel=t}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var t=this.hls.config.startLevel;return t!==void 0?t:this.hls.firstAutoLevel}return this._startLevel},set:function(t){this._startLevel=t}},{key:"pathways",get:function(){return this.steering?this.steering.pathways():[]}},{key:"pathwayPriority",get:function(){return this.steering?this.steering.pathwayPriority:null},set:function(t){if(this.steering){var i=this.steering.pathways(),a=t.filter(function(h){return i.indexOf(h)!==-1});if(t.length<1){this.warn("pathwayPriority "+t+" should contain at least one pathway from list: "+i);return}this.steering.pathwayPriority=a}}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(t){this.level=t,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=t)}}])}(Ta);function Ph(u){var d={};u.forEach(function(o){var s=o.groupId||"";o.id=d[s]=d[s]||0,d[s]++})}function kh(){return self.SourceBuffer||self.WebKitSourceBuffer}function wh(){var u=Ue();if(!u)return!1;var d=kh();return!d||d.prototype&&typeof d.prototype.appendBuffer=="function"&&typeof d.prototype.remove=="function"}function Xm(){if(!wh())return!1;var u=Ue();return typeof(u==null?void 0:u.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(function(d){return u.isTypeSupported(Oi(d,"video"))})||["mp4a.40.2","fLaC"].some(function(d){return u.isTypeSupported(Oi(d,"audio"))}))}function zm(){var u,d=kh();return typeof(d==null||(u=d.prototype)==null?void 0:u.changeType)=="function"}var Qm=100,Zm=function(u){function d(s,t,i){var a;return a=u.call(this,s,t,i,"stream-controller",pe.MAIN)||this,a.audioCodecSwap=!1,a.level=-1,a._forceStartLoad=!1,a._hasEnoughToStart=!1,a.altAudio=0,a.audioOnly=!1,a.fragPlaying=null,a.fragLastKbps=0,a.couldBacktrack=!1,a.backtrackFragment=null,a.audioCodecSwitch=!1,a.videoBuffer=null,a.onMediaPlaying=function(){a.tick()},a.onMediaSeeked=function(){var h=a.media,g=h?h.currentTime:null;if(!(g===null||!ue(g))&&(a.log("Media seeked to "+g.toFixed(3)),!!a.getBufferedFrag(g))){var m=a.getFwdBufferInfoAtPos(h,g,pe.MAIN,0);if(m===null||m.len===0){a.warn("Main forward buffer length at "+g+' on "seeked" event '+(m?m.len:"empty")+")");return}a.tick()}},a.registerListeners(),a}b(d,u);var o=d.prototype;return o.registerListeners=function(){u.prototype.registerListeners.call(this);var t=this.hls;t.on(k.MANIFEST_PARSED,this.onManifestParsed,this),t.on(k.LEVEL_LOADING,this.onLevelLoading,this),t.on(k.LEVEL_LOADED,this.onLevelLoaded,this),t.on(k.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(k.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(k.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(k.BUFFER_CREATED,this.onBufferCreated,this),t.on(k.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(k.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(k.FRAG_BUFFERED,this.onFragBuffered,this)},o.unregisterListeners=function(){u.prototype.unregisterListeners.call(this);var t=this.hls;t.off(k.MANIFEST_PARSED,this.onManifestParsed,this),t.off(k.LEVEL_LOADED,this.onLevelLoaded,this),t.off(k.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(k.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(k.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(k.BUFFER_CREATED,this.onBufferCreated,this),t.off(k.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(k.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(k.FRAG_BUFFERED,this.onFragBuffered,this)},o.onHandlerDestroying=function(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),u.prototype.onHandlerDestroying.call(this)},o.startLoad=function(t,i){if(this.levels){var a=this.lastCurrentTime,h=this.hls;if(this.stopLoad(),this.setInterval(Qm),this.level=-1,!this.startFragRequested){var g=h.startLevel;g===-1&&(h.config.testBandwidth&&this.levels.length>1?(g=0,this.bitrateTest=!0):g=h.firstAutoLevel),h.nextLoadLevel=g,this.level=h.loadLevel,this._hasEnoughToStart=!!i}a>0&&t===-1&&!i&&(this.log("Override startPosition with lastCurrentTime @"+a.toFixed(3)),t=a),this.state=fe.IDLE,this.nextLoadPosition=this.lastCurrentTime=t+this.timelineOffset,this.startPosition=i?-1:t,this.tick()}else this._forceStartLoad=!0,this.state=fe.STOPPED},o.stopLoad=function(){this._forceStartLoad=!1,u.prototype.stopLoad.call(this)},o.doTick=function(){switch(this.state){case fe.WAITING_LEVEL:{var t=this.levels,i=this.level,a=t==null?void 0:t[i],h=a==null?void 0:a.details;if(h&&(!h.live||this.levelLastLoaded===a&&!this.waitForLive(a))){if(this.waitForCdnTuneIn(h))break;this.state=fe.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=fe.IDLE;break}break}case fe.FRAG_LOADING_WAITING_RETRY:{var g,m=self.performance.now(),p=this.retryDate;if(!p||m>=p||(g=this.media)!=null&&g.seeking){var E=this.levels,x=this.level,I=E==null?void 0:E[x];this.resetStartWhenNotLoaded(I||null),this.state=fe.IDLE}}break}this.state===fe.IDLE&&this.doTickIdle(),this.onTickEnd()},o.onTickEnd=function(){var t;u.prototype.onTickEnd.call(this),(t=this.media)!=null&&t.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()},o.doTickIdle=function(){var t=this.hls,i=this.levelLastLoaded,a=this.levels,h=this.media;if(!(i===null||!h&&!this.primaryPrefetch&&(this.startFragRequested||!t.config.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)){var g=this.buffering?t.nextLoadLevel:t.loadLevel;if(a!=null&&a[g]){var m=a[g],p=this.getMainFwdBufferInfo();if(p!==null){var E=this.getLevelDetails();if(E&&this._streamEnded(p,E)){var x={};this.altAudio===2&&(x.type="video"),this.hls.trigger(k.BUFFER_EOS,x),this.state=fe.ENDED;return}if(this.buffering){t.loadLevel!==g&&t.manualLevel===-1&&this.log("Adapting to level "+g+" from level "+this.level),this.level=t.nextLoadLevel=g;var I=m.details;if(!I||this.state===fe.WAITING_LEVEL||this.waitForLive(m)){this.level=g,this.state=fe.WAITING_LEVEL,this.startFragRequested=!1;return}var R=p.len,_=this.getMaxBufferLength(m.maxBitrate);if(!(R>=_)){this.backtrackFragment&&this.backtrackFragment.start>p.end&&(this.backtrackFragment=null);var P=this.backtrackFragment?this.backtrackFragment.start:p.end,O=this.getNextFragment(P,I);if(this.couldBacktrack&&!this.fragPrevious&&O&&ct(O)&&this.fragmentTracker.getState(O)!==xt.OK){var N,U=((N=this.backtrackFragment)!=null?N:O).sn,B=U-I.startSN,G=I.fragments[B-1];G&&O.cc===G.cc&&(O=G,this.fragmentTracker.removeFragment(G))}else this.backtrackFragment&&p.len&&(this.backtrackFragment=null);if(O&&this.isLoopLoading(O,P)){var Y=O.gap;if(!Y){var V=this.audioOnly&&!this.altAudio?Ve.AUDIO:Ve.VIDEO,j=(V===Ve.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;j&&this.afterBufferFlushed(j,V,pe.MAIN)}O=this.getNextFragmentLoopLoading(O,I,p,pe.MAIN,_)}O&&(O.initSegment&&!O.initSegment.data&&!this.bitrateTest&&(O=O.initSegment),this.loadFragment(O,m,P))}}}}}},o.loadFragment=function(t,i,a){var h=this.fragmentTracker.getState(t);h===xt.NOT_LOADED||h===xt.PARTIAL?ct(t)?this.bitrateTest?(this.log("Fragment "+t.sn+" of level "+t.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(t,i)):u.prototype.loadFragment.call(this,t,i,a):this._loadInitSegment(t,i):this.clearTrackerIfNeeded(t)},o.getBufferedFrag=function(t){return this.fragmentTracker.getBufferedFrag(t,pe.MAIN)},o.followingBufferedFrag=function(t){return t?this.getBufferedFrag(t.end+.5):null},o.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},o.nextLevelSwitch=function(){var t=this.levels,i=this.media;if(i!=null&&i.readyState){var a,h=this.getAppendedFrag(i.currentTime);h&&h.start>1&&this.flushMainBuffer(0,h.start-1);var g=this.getLevelDetails();if(g!=null&&g.live){var m=this.getMainFwdBufferInfo();if(!m||m.len<g.targetduration*2)return}if(!i.paused&&t){var p=this.hls.nextLoadLevel,E=t[p],x=this.fragLastKbps;x&&this.fragCurrent?a=this.fragCurrent.duration*E.maxBitrate/(1e3*x)+1:a=0}else a=0;var I=this.getBufferedFrag(i.currentTime+a);if(I){var R=this.followingBufferedFrag(I);if(R){this.abortCurrentFrag();var _=R.maxStartPTS?R.maxStartPTS:R.start,P=R.duration,O=Math.max(I.end,_+Math.min(Math.max(P-this.config.maxFragLookUpTolerance,P*(this.couldBacktrack?.5:.125)),P*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(O,Number.POSITIVE_INFINITY)}}}},o.abortCurrentFrag=function(){var t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case fe.KEY_LOADING:case fe.FRAG_LOADING:case fe.FRAG_LOADING_WAITING_RETRY:case fe.PARSING:case fe.PARSED:this.state=fe.IDLE;break}this.nextLoadPosition=this.getLoadPosition()},o.flushMainBuffer=function(t,i){u.prototype.flushMainBuffer.call(this,t,i,this.altAudio===2?"video":null)},o.onMediaAttached=function(t,i){u.prototype.onMediaAttached.call(this,t,i);var a=i.media;xr(a,"playing",this.onMediaPlaying),xr(a,"seeked",this.onMediaSeeked)},o.onMediaDetaching=function(t,i){var a=this.media;a&&(hr(a,"playing",this.onMediaPlaying),hr(a,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,u.prototype.onMediaDetaching.call(this,t,i);var h=!!i.transferMedia;h||(this._hasEnoughToStart=!1)},o.onManifestLoading=function(){u.prototype.onManifestLoading.call(this),this.log("Trigger BUFFER_RESET"),this.hls.trigger(k.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1},o.onManifestParsed=function(t,i){var a=!1,h=!1;i.levels.forEach(function(g){var m=g.audioCodec;m&&(a=a||m.indexOf("mp4a.40.2")!==-1,h=h||m.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=a&&h&&!zm(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=i.levels,this.startFragRequested=!1},o.onLevelLoading=function(t,i){var a=this.levels;if(!(!a||this.state!==fe.IDLE)){var h=i.levelInfo;(!h.details||h.details.live&&(this.levelLastLoaded!==h||h.details.expired)||this.waitForCdnTuneIn(h.details))&&(this.state=fe.WAITING_LEVEL)}},o.onLevelLoaded=function(t,i){var a,h=this.levels,g=this.startFragRequested,m=i.level,p=i.details,E=p.totalduration;if(!h){this.warn("Levels were reset while loading level "+m);return}this.log("Level "+m+" loaded ["+p.startSN+","+p.endSN+"]"+(p.lastPartSn?"[part-"+p.lastPartSn+"-"+p.lastPartIndex+"]":"")+", cc ["+p.startCC+", "+p.endCC+"] duration:"+E);var x=i.levelInfo,I=this.fragCurrent;I&&(this.state===fe.FRAG_LOADING||this.state===fe.FRAG_LOADING_WAITING_RETRY)&&I.level!==i.level&&I.loader&&this.abortCurrentFrag();var R=0;if(p.live||(a=x.details)!=null&&a.live){var _;if(this.checkLiveUpdate(p),p.deltaUpdateFailed)return;R=this.alignPlaylists(p,x.details,(_=this.levelLastLoaded)==null?void 0:_.details)}if(x.details=p,this.levelLastLoaded=x,g||this.setStartPosition(p,R),this.hls.trigger(k.LEVEL_UPDATED,{details:p,level:m}),this.state===fe.WAITING_LEVEL){if(this.waitForCdnTuneIn(p))return;this.state=fe.IDLE}g&&p.live&&this.synchronizeToLiveEdge(p),this.tick()},o.synchronizeToLiveEdge=function(t){var i=this.config,a=this.media;if(a){var h=this.hls.liveSyncPosition,g=this.getLoadPosition(),m=t.fragmentStart,p=t.edge,E=g>=m-i.maxFragLookUpTolerance&&g<=p;if(h!==null&&a.duration>h&&(g<h||!E)){var x=i.liveMaxLatencyDuration!==void 0?i.liveMaxLatencyDuration:i.liveMaxLatencyDurationCount*t.targetduration;(!E&&a.readyState<4||g<p-x)&&(this._hasEnoughToStart||(this.nextLoadPosition=h),a.readyState&&(this.warn("Playback: "+g.toFixed(3)+" is located too far from the end of live sliding playlist: "+p+", reset currentTime to : "+h.toFixed(3)),a.currentTime=h))}}},o._handleFragmentLoadProgress=function(t){var i,a=t.frag,h=t.part,g=t.payload,m=this.levels;if(!m){this.warn("Levels were reset while fragment load was in progress. Fragment "+a.sn+" of level "+a.level+" will not be buffered");return}var p=m[a.level];if(!p){this.warn("Level "+a.level+" not found on progress");return}var E=p.details;if(!E){this.warn("Dropping fragment "+a.sn+" of level "+a.level+" after level details were reset"),this.fragmentTracker.removeFragment(a);return}var x=p.videoCodec,I=E.PTSKnown||!E.live,R=(i=a.initSegment)==null?void 0:i.data,_=this._getAudioCodec(p),P=this.transmuxer=this.transmuxer||new Ku(this.hls,pe.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),O=h?h.index:-1,N=O!==-1,U=new Yn(a.level,a.sn,a.stats.chunkCount,g.byteLength,O,N),B=this.initPTS[a.cc];P.push(g,R,_,x,a,h,E.totalduration,I,U,B)},o.onAudioTrackSwitching=function(t,i){var a=this,h=this.hls,g=this.altAudio===2,m=ys(i.url,h);if(m)this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var p=this.fragCurrent;p&&(this.log("Switching to main audio track, cancel main fragment load"),p.abortRequests(),this.fragmentTracker.removeFragment(p)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(g){this.fragmentTracker.removeAllFragments(),h.once(k.BUFFER_FLUSHED,function(){var E;(E=a.hls)==null||E.trigger(k.AUDIO_TRACK_SWITCHED,i)}),h.trigger(k.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}h.trigger(k.AUDIO_TRACK_SWITCHED,i)}},o.onAudioTrackSwitched=function(t,i){var a=ys(i.url,this.hls);if(a){var h=this.videoBuffer;h&&this.mediaBuffer!==h&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=h)}this.altAudio=a?2:0,this.tick()},o.onBufferCreated=function(t,i){var a=i.tracks,h,g,m=!1;for(var p in a){var E=a[p];if(E.id==="main"){if(g=p,h=E,p==="video"){var x=a[p];x&&(this.videoBuffer=x.buffer)}}else m=!0}m&&h?(this.log("Alternate track found, use "+g+".buffered to schedule main fragment loading"),this.mediaBuffer=h.buffer):this.mediaBuffer=this.media},o.onFragBuffered=function(t,i){var a=i.frag,h=i.part,g=a.type===pe.MAIN;if(g){if(this.fragContextChanged(a)){this.warn("Fragment "+a.sn+(h?" p: "+h.index:"")+" of level "+a.level+" finished buffering, but was aborted. state: "+this.state),this.state===fe.PARSED&&(this.state=fe.IDLE);return}var m=h?h.stats:a.stats;this.fragLastKbps=Math.round(8*m.total/(m.buffering.end-m.loading.first)),ct(a)&&(this.fragPrevious=a),this.fragBufferedComplete(a,h)}var p=this.media;p&&(!this._hasEnoughToStart&&We.getBuffered(p).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),g&&this.tick())},o.onError=function(t,i){var a;if(i.fatal){this.state=fe.ERROR;return}switch(i.details){case q.FRAG_GAP:case q.FRAG_PARSING_ERROR:case q.FRAG_DECRYPT_ERROR:case q.FRAG_LOAD_ERROR:case q.FRAG_LOAD_TIMEOUT:case q.KEY_LOAD_ERROR:case q.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(pe.MAIN,i);break;case q.LEVEL_LOAD_ERROR:case q.LEVEL_LOAD_TIMEOUT:case q.LEVEL_PARSING_ERROR:!i.levelRetry&&this.state===fe.WAITING_LEVEL&&((a=i.context)==null?void 0:a.type)===Te.LEVEL&&(this.state=fe.IDLE);break;case q.BUFFER_ADD_CODEC_ERROR:case q.BUFFER_APPEND_ERROR:if(i.parent!=="main")return;this.resetLoadingState();break;case q.BUFFER_FULL_ERROR:if(i.parent!=="main")return;this.reduceLengthAndFlushBuffer(i)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case q.INTERNAL_EXCEPTION:this.recoverWorkerError(i);break}},o.onFragLoadEmergencyAborted=function(){this.state=fe.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()},o.onBufferFlushed=function(t,i){var a=i.type;if(a!==Ve.AUDIO||!this.altAudio){var h=(a===Ve.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;h&&(this.afterBufferFlushed(h,a,pe.MAIN),this.tick())}},o.onLevelsUpdated=function(t,i){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=i.levels},o.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},o.seekToStartPos=function(){var t=this.media;if(t){var i=t.currentTime,a=this.startPosition;if(a>=0&&i<a){if(t.seeking){this.log("could not seek to "+a+", already seeking at "+i);return}var h=this.timelineOffset;h&&a&&(a+=h);var g=this.getLevelDetails(),m=We.getBuffered(t),p=m.length?m.start(0):0,E=p-a,x=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);E>0&&(E<x||this.loadingParts&&E<2*((g==null?void 0:g.partTarget)||0))&&(this.log("adjusting start position by "+E+" to match buffer start"),a+=E,this.startPosition=a),i<a&&(this.log("seek to target start position "+a+" from current time "+i+" buffer start "+p),t.currentTime=a)}}},o._getAudioCodec=function(t){var i=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&i&&(this.log("Swapping audio codec"),i.indexOf("mp4a.40.5")!==-1?i="mp4a.40.2":i="mp4a.40.5"),i},o._loadBitrateTestFrag=function(t,i){var a=this;t.bitrateTest=!0,this._doFragLoad(t,i).then(function(h){var g=a.hls,m=h==null?void 0:h.frag;if(!(!m||a.fragContextChanged(m))){i.fragmentError=0,a.state=fe.IDLE,a.startFragRequested=!1,a.bitrateTest=!1;var p=m.stats;p.parsing.start=p.parsing.end=p.buffering.start=p.buffering.end=self.performance.now(),g.trigger(k.FRAG_LOADED,h),m.bitrateTest=!1}})},o._handleTransmuxComplete=function(t){var i,a=this.playlistType,h=this.hls,g=t.remuxResult,m=t.chunkMeta,p=this.getCurrentContext(m);if(!p){this.resetWhenMissingContext(m);return}var E=p.frag,x=p.part,I=p.level,R=g.video,_=g.text,P=g.id3,O=g.initSegment,N=I.details,U=this.altAudio?void 0:g.audio;if(this.fragContextChanged(E)){this.fragmentTracker.removeFragment(E);return}if(this.state=fe.PARSING,O){if(O!=null&&O.tracks){var B=E.initSegment||E;this._bufferInitSegment(I,O.tracks,B,m),h.trigger(k.FRAG_PARSING_INIT_SEGMENT,{frag:B,id:a,tracks:O.tracks})}var G=O.initPTS,Y=O.timescale;ue(G)&&(this.initPTS[E.cc]={baseTime:G,timescale:Y},h.trigger(k.INIT_PTS_FOUND,{frag:E,id:a,initPTS:G,timescale:Y}))}if(R&&N){var V=N.fragments[E.sn-1-N.startSN],j=E.sn===N.startSN,ae=!V||E.cc>V.cc;if(g.independent!==!1){var X=R.startPTS,W=R.endPTS,J=R.startDTS,oe=R.endDTS;if(x)x.elementaryStreams[R.type]={startPTS:X,endPTS:W,startDTS:J,endDTS:oe};else if(R.firstKeyFrame&&R.independent&&m.id===1&&!ae&&(this.couldBacktrack=!0),R.dropped&&R.independent){var ge=this.getMainFwdBufferInfo(),ce=(ge?ge.end:this.getLoadPosition())+this.config.maxBufferHole,he=R.firstKeyFramePTS?R.firstKeyFramePTS:X;if(!j&&ce<he-this.config.maxBufferHole&&!ae){this.backtrack(E);return}else ae&&(E.gap=!0);E.setElementaryStreamInfo(R.type,E.start,W,E.start,oe,!0)}else j&&X-(N.appliedTimelineOffset||0)>$s&&(E.gap=!0);E.setElementaryStreamInfo(R.type,X,W,J,oe),this.backtrackFragment&&(this.backtrackFragment=E),this.bufferFragmentData(R,E,x,m,j||ae)}else if(j||ae)E.gap=!0;else{this.backtrack(E);return}}if(U){var ye=U.startPTS,Se=U.endPTS,Le=U.startDTS,Ie=U.endDTS;x&&(x.elementaryStreams[Ve.AUDIO]={startPTS:ye,endPTS:Se,startDTS:Le,endDTS:Ie}),E.setElementaryStreamInfo(Ve.AUDIO,ye,Se,Le,Ie),this.bufferFragmentData(U,E,x,m)}if(N&&P!=null&&(i=P.samples)!=null&&i.length){var He={id:a,frag:E,details:N,samples:P.samples};h.trigger(k.FRAG_PARSING_METADATA,He)}if(N&&_){var Oe={id:a,frag:E,details:N,samples:_.samples};h.trigger(k.FRAG_PARSING_USERDATA,Oe)}},o._bufferInitSegment=function(t,i,a,h){var g=this;if(this.state===fe.PARSING){this.audioOnly=!!i.audio&&!i.video,this.altAudio&&!this.audioOnly&&delete i.audio;var m=i.audio,p=i.video,E=i.audiovideo;if(m){var x=vs(m.codec,t.audioCodec);x==="mp4a"&&(x="mp4a.40.5");var I=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){x&&(x.indexOf("mp4a.40.5")!==-1?x="mp4a.40.2":x="mp4a.40.5");var R=m.metadata;R&&"channelCount"in R&&(R.channelCount||1)!==1&&I.indexOf("firefox")===-1&&(x="mp4a.40.5")}x&&x.indexOf("mp4a.40.5")!==-1&&I.indexOf("android")!==-1&&m.container!=="audio/mpeg"&&(x="mp4a.40.2",this.log("Android: force audio codec to "+x)),t.audioCodec&&t.audioCodec!==x&&this.log('Swapping manifest audio codec "'+t.audioCodec+'" for "'+x+'"'),m.levelCodec=x,m.id=pe.MAIN,this.log("Init audio buffer, container:"+m.container+", codecs[selected/level/parsed]=["+(x||"")+"/"+(t.audioCodec||"")+"/"+m.codec+"]"),delete i.audiovideo}if(p){p.levelCodec=t.videoCodec,p.id=pe.MAIN;var _=p.codec;if((_==null?void 0:_.length)===4)switch(_){case"hvc1":case"hev1":p.codec="hvc1.1.6.L120.90";break;case"av01":p.codec="av01.0.04M.08";break;case"avc1":p.codec="avc1.42e01e";break}this.log("Init video buffer, container:"+p.container+", codecs[level/parsed]=["+(t.videoCodec||"")+"/"+_+"]"+(p.codec!==_?" parsed-corrected="+p.codec:"")+(p.supplemental?" supplemental="+p.supplemental:"")),delete i.audiovideo}E&&(this.log("Init audiovideo buffer, container:"+E.container+", codecs[level/parsed]=["+t.codecs+"/"+E.codec+"]"),delete i.video,delete i.audio);var P=Object.keys(i);if(P.length){if(this.hls.trigger(k.BUFFER_CODECS,i),!this.hls)return;P.forEach(function(O){var N=i[O],U=N.initSegment;U!=null&&U.byteLength&&g.hls.trigger(k.BUFFER_APPENDING,{type:O,data:U,frag:a,part:null,chunkMeta:h,parent:a.type})})}this.tickImmediate()}},o.getMainFwdBufferInfo=function(){var t=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(t,pe.MAIN)},o.backtrack=function(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=fe.IDLE},o.checkFragmentChanged=function(){var t=this.media,i=null;if(t&&t.readyState>1&&t.seeking===!1){var a=t.currentTime;if(We.isBuffered(t,a)?i=this.getAppendedFrag(a):We.isBuffered(t,a+.1)&&(i=this.getAppendedFrag(a+.1)),i){this.backtrackFragment=null;var h=this.fragPlaying,g=i.level;(!h||i.sn!==h.sn||h.level!==g)&&(this.fragPlaying=i,this.hls.trigger(k.FRAG_CHANGED,{frag:i}),(!h||h.level!==g)&&this.hls.trigger(k.LEVEL_SWITCHED,{level:g}))}}},y(d,[{key:"hasEnoughToStart",get:function(){return this._hasEnoughToStart}},{key:"maxBufferLength",get:function(){var t=this.levels,i=this.level,a=t==null?void 0:t[i];return a?this.getMaxBufferLength(a.maxBitrate):this.config.maxBufferLength}},{key:"nextLevel",get:function(){var t=this.nextBufferedFrag;return t?t.level:-1}},{key:"currentFrag",get:function(){var t;if(this.fragPlaying)return this.fragPlaying;var i=((t=this.media)==null?void 0:t.currentTime)||this.lastCurrentTime;return ue(i)?this.getAppendedFrag(i):null}},{key:"currentProgramDateTime",get:function(){var t,i=((t=this.media)==null?void 0:t.currentTime)||this.lastCurrentTime;if(ue(i)){var a=this.getLevelDetails(),h=this.currentFrag||(a?Xr(null,a.fragments,i):null);if(h){var g=h.programDateTime;if(g!==null){var m=g+(i-h.start)*1e3;return new Date(m)}}}return null}},{key:"currentLevel",get:function(){var t=this.currentFrag;return t?t.level:-1}},{key:"nextBufferedFrag",get:function(){var t=this.currentFrag;return t?this.followingBufferedFrag(t):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}])}(sa),Jm=function(){function u(o){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=o}var d=u.prototype;return d.abort=function(s){for(var t in this.keyUriToKeyInfo){var i=this.keyUriToKeyInfo[t].loader;if(i){var a;if(s&&s!==((a=i.context)==null?void 0:a.frag.type))return;i.abort()}}},d.detach=function(){for(var s in this.keyUriToKeyInfo){var t=this.keyUriToKeyInfo[s];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[s]}},d.destroy=function(){this.detach();for(var s in this.keyUriToKeyInfo){var t=this.keyUriToKeyInfo[s].loader;t&&t.destroy()}this.keyUriToKeyInfo={}},d.createKeyLoadError=function(s,t,i,a,h){return t===void 0&&(t=q.KEY_LOAD_ERROR),new Tr({type:se.NETWORK_ERROR,details:t,fatal:!1,frag:s,response:h,error:i,networkDetails:a})},d.loadClear=function(s,t){var i=this;if(this.emeController&&this.config.emeEnabled)for(var a=s.sn,h=s.cc,g=function(){var E=t[m];if(h<=E.cc&&(a==="initSegment"||E.sn==="initSegment"||a<E.sn))return i.emeController.selectKeySystemFormat(E).then(function(x){E.setKeyFormat(x)}),1},m=0;m<t.length&&!g();m++);},d.load=function(s){var t=this;return!s.decryptdata&&s.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(s).then(function(i){return t.loadInternal(s,i)}):this.loadInternal(s)},d.loadInternal=function(s,t){var i,a;t&&s.setKeyFormat(t);var h=s.decryptdata;if(!h){var g=new Error(t?"Expected frag.decryptdata to be defined after setting format "+t:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(s,q.KEY_LOAD_ERROR,g))}var m=h.uri;if(!m)return Promise.reject(this.createKeyLoadError(s,q.KEY_LOAD_ERROR,new Error('Invalid key URI: "'+m+'"')));var p=this.keyUriToKeyInfo[m];if((i=p)!=null&&i.decryptdata.key)return h.key=p.decryptdata.key,Promise.resolve({frag:s,keyInfo:p});if((a=p)!=null&&a.keyLoadPromise){var E;switch((E=p.mediaKeySessionContext)==null?void 0:E.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return p.keyLoadPromise.then(function(x){return h.key=x.keyInfo.decryptdata.key,{frag:s,keyInfo:p}})}}switch(p=this.keyUriToKeyInfo[m]={decryptdata:h,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},h.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return h.keyFormat==="identity"?this.loadKeyHTTP(p,s):this.loadKeyEME(p,s);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(p,s);default:return Promise.reject(this.createKeyLoadError(s,q.KEY_LOAD_ERROR,new Error('Key supplied with unsupported METHOD: "'+h.method+'"')))}},d.loadKeyEME=function(s,t){var i={frag:t,keyInfo:s};if(this.emeController&&this.config.emeEnabled){var a=this.emeController.loadKey(i);if(a)return(s.keyLoadPromise=a.then(function(h){return s.mediaKeySessionContext=h,i})).catch(function(h){throw s.keyLoadPromise=null,h})}return Promise.resolve(i)},d.loadKeyHTTP=function(s,t){var i=this,a=this.config,h=a.loader,g=new h(a);return t.keyLoader=s.loader=g,s.keyLoadPromise=new Promise(function(m,p){var E={keyInfo:s,frag:t,responseType:"arraybuffer",url:s.decryptdata.uri},x=a.keyLoadPolicy.default,I={loadPolicy:x,timeout:x.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},R={onSuccess:function(P,O,N,U){var B=N.frag,G=N.keyInfo,Y=N.url;if(!B.decryptdata||G!==i.keyUriToKeyInfo[Y])return p(i.createKeyLoadError(B,q.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),U));G.decryptdata.key=B.decryptdata.key=new Uint8Array(P.data),B.keyLoader=null,G.loader=null,m({frag:B,keyInfo:G})},onError:function(P,O,N,U){i.resetLoader(O),p(i.createKeyLoadError(t,q.KEY_LOAD_ERROR,new Error("HTTP Error "+P.code+" loading key "+P.text),N,F({url:E.url,data:void 0},P)))},onTimeout:function(P,O,N){i.resetLoader(O),p(i.createKeyLoadError(t,q.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),N))},onAbort:function(P,O,N){i.resetLoader(O),p(i.createKeyLoadError(t,q.INTERNAL_ABORTED,new Error("key loading aborted"),N))}};g.load(E,I,R)})},d.resetLoader=function(s){var t=s.frag,i=s.keyInfo,a=s.url,h=i.loader;t.keyLoader===h&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[a],h&&h.destroy()},u}();function Oh(u){var d=u.type;switch(d){case Te.AUDIO_TRACK:return pe.AUDIO;case Te.SUBTITLE_TRACK:return pe.SUBTITLE;default:return pe.MAIN}}function $a(u,d){var o=u.url;return(o===void 0||o.indexOf("data:")===0)&&(o=d.url),o}var ep=function(){function u(o){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=o,this.registerListeners()}var d=u.prototype;return d.startLoad=function(s){},d.stopLoad=function(){this.destroyInternalLoaders()},d.registerListeners=function(){var s=this.hls;s.on(k.MANIFEST_LOADING,this.onManifestLoading,this),s.on(k.LEVEL_LOADING,this.onLevelLoading,this),s.on(k.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),s.on(k.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),s.on(k.LEVELS_UPDATED,this.onLevelsUpdated,this)},d.unregisterListeners=function(){var s=this.hls;s.off(k.MANIFEST_LOADING,this.onManifestLoading,this),s.off(k.LEVEL_LOADING,this.onLevelLoading,this),s.off(k.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),s.off(k.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),s.off(k.LEVELS_UPDATED,this.onLevelsUpdated,this)},d.createInternalLoader=function(s){var t=this.hls.config,i=t.pLoader,a=t.loader,h=i||a,g=new h(t);return this.loaders[s.type]=g,g},d.getInternalLoader=function(s){return this.loaders[s.type]},d.resetInternalLoader=function(s){this.loaders[s]&&delete this.loaders[s]},d.destroyInternalLoaders=function(){for(var s in this.loaders){var t=this.loaders[s];t&&t.destroy(),this.resetInternalLoader(s)}},d.destroy=function(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()},d.onManifestLoading=function(s,t){var i=t.url;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Te.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})},d.onLevelLoading=function(s,t){var i=t.id,a=t.level,h=t.pathwayId,g=t.url,m=t.deliveryDirectives,p=t.levelInfo;this.load({id:i,level:a,pathwayId:h,responseType:"text",type:Te.LEVEL,url:g,deliveryDirectives:m,levelOrTrack:p})},d.onAudioTrackLoading=function(s,t){var i=t.id,a=t.groupId,h=t.url,g=t.deliveryDirectives,m=t.track;this.load({id:i,groupId:a,level:null,responseType:"text",type:Te.AUDIO_TRACK,url:h,deliveryDirectives:g,levelOrTrack:m})},d.onSubtitleTrackLoading=function(s,t){var i=t.id,a=t.groupId,h=t.url,g=t.deliveryDirectives,m=t.track;this.load({id:i,groupId:a,level:null,responseType:"text",type:Te.SUBTITLE_TRACK,url:h,deliveryDirectives:g,levelOrTrack:m})},d.onLevelsUpdated=function(s,t){var i=this.loaders[Te.LEVEL];if(i){var a=i.context;a&&!t.levels.some(function(h){return h===a.levelOrTrack})&&(i.abort(),delete this.loaders[Te.LEVEL])}},d.load=function(s){var t,i=this,a=this.hls.config,h=this.getInternalLoader(s);if(h){var g=this.hls.logger,m=h.context;if(m&&m.levelOrTrack===s.levelOrTrack&&(m.url===s.url||m.deliveryDirectives&&!s.deliveryDirectives)){m.url===s.url?g.log("[playlist-loader]: ignore "+s.url+" ongoing request"):g.log("[playlist-loader]: ignore "+s.url+" in favor of "+m.url);return}g.log("[playlist-loader]: aborting previous loader for type: "+s.type),h.abort()}var p;if(s.type===Te.MANIFEST?p=a.manifestLoadPolicy.default:p=A({},a.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),h=this.createInternalLoader(s),ue((t=s.deliveryDirectives)==null?void 0:t.part)){var E;if(s.type===Te.LEVEL&&s.level!==null?E=this.hls.levels[s.level].details:s.type===Te.AUDIO_TRACK&&s.id!==null?E=this.hls.audioTracks[s.id].details:s.type===Te.SUBTITLE_TRACK&&s.id!==null&&(E=this.hls.subtitleTracks[s.id].details),E){var x=E.partTarget,I=E.targetduration;if(x&&I){var R=Math.max(x*3,I*.8)*1e3;p=A({},p,{maxTimeToFirstByteMs:Math.min(R,p.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(R,p.maxTimeToFirstByteMs)})}}}var _=p.errorRetry||p.timeoutRetry||{},P={loadPolicy:p,timeout:p.maxLoadTimeMs,maxRetry:_.maxNumRetry||0,retryDelay:_.retryDelayMs||0,maxRetryDelay:_.maxRetryDelayMs||0},O={onSuccess:function(U,B,G,Y){var V=i.getInternalLoader(G);i.resetInternalLoader(G.type);var j=U.data;if(j.indexOf("#EXTM3U")!==0){i.handleManifestParsingError(U,G,new Error("no EXTM3U delimiter"),Y||null,B);return}B.parsing.start=performance.now(),Ni.isMediaPlaylist(j)||G.type!==Te.MANIFEST?i.handleTrackOrLevelPlaylist(U,B,G,Y||null,V):i.handleMasterPlaylist(U,B,G,Y)},onError:function(U,B,G,Y){i.handleNetworkError(B,G,!1,U,Y)},onTimeout:function(U,B,G){i.handleNetworkError(B,G,!0,void 0,U)}};h.load(s,P,O)},d.checkAutostartLoad=function(){if(this.hls){var s=this.hls,t=s.config,i=t.autoStartLoad,a=t.startPosition,h=s.forceStartLoad;(i||h)&&(this.hls.logger.log((i?"auto":"force")+" startLoad with configured startPosition "+a),this.hls.startLoad(a))}},d.handleMasterPlaylist=function(s,t,i,a){var h=this.hls,g=s.data,m=$a(s,i),p=Ni.parseMasterPlaylist(g,m);if(p.playlistParsingError){this.handleManifestParsingError(s,i,p.playlistParsingError,a,t);return}var E=p.contentSteering,x=p.levels,I=p.sessionData,R=p.sessionKeys,_=p.startTimeOffset,P=p.variableList;this.variableList=P;var O=Ni.parseMasterPlaylistMedia(g,m,p),N=O.AUDIO,U=N===void 0?[]:N,B=O.SUBTITLES,G=O["CLOSED-CAPTIONS"];if(U.length){var Y=U.some(function(V){return!V.url});!Y&&x[0].audioCodec&&!x[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),U.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new pt({}),bitrate:0,url:""}))}h.trigger(k.MANIFEST_LOADED,{levels:x,audioTracks:U,subtitles:B,captions:G,contentSteering:E,url:m,stats:t,networkDetails:a,sessionData:I,sessionKeys:R,startTimeOffset:_,variableList:P})},d.handleTrackOrLevelPlaylist=function(s,t,i,a,h){var g=this.hls,m=i.id,p=i.level,E=i.type,x=$a(s,i),I=ue(p)?p:ue(m)?m:0,R=Oh(i),_=Ni.parseLevelPlaylist(s.data,x,I,R,0,this.variableList);if(E===Te.MANIFEST){var P={attrs:new pt({}),bitrate:0,details:_,name:"",url:x};_.requestScheduled=t.loading.start+au(_,0),g.trigger(k.MANIFEST_LOADED,{levels:[P],audioTracks:[],url:x,stats:t,networkDetails:a,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=_,this.handlePlaylistLoaded(_,s,t,i,a,h)},d.handleManifestParsingError=function(s,t,i,a,h){this.hls.trigger(k.ERROR,{type:se.NETWORK_ERROR,details:q.MANIFEST_PARSING_ERROR,fatal:t.type===Te.MANIFEST,url:s.url,err:i,error:i,reason:i.message,response:s,context:t,networkDetails:a,stats:h})},d.handleNetworkError=function(s,t,i,a,h){i===void 0&&(i=!1);var g="A network "+(i?"timeout":"error"+(a?" (status "+a.code+")":""))+" occurred while loading "+s.type;s.type===Te.LEVEL?g+=": "+s.level+" id: "+s.id:(s.type===Te.AUDIO_TRACK||s.type===Te.SUBTITLE_TRACK)&&(g+=" id: "+s.id+' group-id: "'+s.groupId+'"');var m=new Error(g);this.hls.logger.warn("[playlist-loader]: "+g);var p=q.UNKNOWN,E=!1,x=this.getInternalLoader(s);switch(s.type){case Te.MANIFEST:p=i?q.MANIFEST_LOAD_TIMEOUT:q.MANIFEST_LOAD_ERROR,E=!0;break;case Te.LEVEL:p=i?q.LEVEL_LOAD_TIMEOUT:q.LEVEL_LOAD_ERROR,E=!1;break;case Te.AUDIO_TRACK:p=i?q.AUDIO_TRACK_LOAD_TIMEOUT:q.AUDIO_TRACK_LOAD_ERROR,E=!1;break;case Te.SUBTITLE_TRACK:p=i?q.SUBTITLE_TRACK_LOAD_TIMEOUT:q.SUBTITLE_LOAD_ERROR,E=!1;break}x&&this.resetInternalLoader(s.type);var I={type:se.NETWORK_ERROR,details:p,fatal:E,url:s.url,loader:x,context:s,error:m,networkDetails:t,stats:h};if(a){var R=(t==null?void 0:t.url)||s.url;I.response=F({url:R,data:void 0},a)}this.hls.trigger(k.ERROR,I)},d.handlePlaylistLoaded=function(s,t,i,a,h,g){var m=this.hls,p=a.type,E=a.level,x=a.id,I=a.groupId,R=a.deliveryDirectives,_=$a(t,a),P=Oh(a),O=typeof a.level=="number"&&P===pe.MAIN?E:void 0;if(!s.fragments.length){var N=s.playlistParsingError=new Error("No Segments found in Playlist");m.trigger(k.ERROR,{type:se.NETWORK_ERROR,details:q.LEVEL_EMPTY_ERROR,fatal:!1,url:_,error:N,reason:N.message,response:t,context:a,level:O,parent:P,networkDetails:h,stats:i});return}s.targetduration||(s.playlistParsingError=new Error("Missing Target Duration"));var U=s.playlistParsingError;if(U){if(this.hls.logger.warn(U),!m.config.ignorePlaylistParsingErrors){m.trigger(k.ERROR,{type:se.NETWORK_ERROR,details:q.LEVEL_PARSING_ERROR,fatal:!1,url:_,error:U,reason:U.message,response:t,context:a,level:O,parent:P,networkDetails:h,stats:i});return}s.playlistParsingError=null}switch(s.live&&g&&(g.getCacheAge&&(s.ageHeader=g.getCacheAge()||0),(!g.getCacheAge||isNaN(s.ageHeader))&&(s.ageHeader=0)),p){case Te.MANIFEST:case Te.LEVEL:m.trigger(k.LEVEL_LOADED,{details:s,levelInfo:a.levelOrTrack||m.levels[0],level:O||0,id:x||0,stats:i,networkDetails:h,deliveryDirectives:R,withoutMultiVariant:p===Te.MANIFEST});break;case Te.AUDIO_TRACK:m.trigger(k.AUDIO_TRACK_LOADED,{details:s,track:a.levelOrTrack,id:x||0,groupId:I||"",stats:i,networkDetails:h,deliveryDirectives:R});break;case Te.SUBTITLE_TRACK:m.trigger(k.SUBTITLE_TRACK_LOADED,{details:s,track:a.levelOrTrack,id:x||0,groupId:I||"",stats:i,networkDetails:h,deliveryDirectives:R});break}},u}(),Mh=function(){function u(o){o===void 0&&(o={}),this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Ee,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;var s=this.logger=si(o.debug||!1,"Hls instance",o.assetPlayerId),t=this.config=Um(u.DefaultConfig,o,s);this.userConfig=o,t.progressive&&Bm(t,s);var i=t.abrController,a=t.bufferController,h=t.capLevelController,g=t.errorController,m=t.fpsController,p=new g(this),E=this.abrController=new i(this),x=new ug(this),I=t.interstitialsController,R=I?this.interstitialsController=new I(this,u):null,_=this.bufferController=new a(this,x),P=this.capLevelController=new h(this),O=new m(this),N=new ep(this),U=t.contentSteeringController,B=U?new U(this):null,G=this.levelController=new jm(this,B),Y=new Wm(this),V=new Jm(this.config),j=this.streamController=new Zm(this,x,V),ae=this.gapController=new Vm(this,x);P.setStreamController(j),O.setStreamController(j);var X=[N,G,j];R&&X.splice(1,0,R),B&&X.splice(1,0,B),this.networkControllers=X;var W=[E,_,ae,P,O,Y,x];this.audioTrackController=this.createController(t.audioTrackController,X);var J=t.audioStreamController;J&&X.push(this.audioStreamController=new J(this,x,V)),this.subtitleTrackController=this.createController(t.subtitleTrackController,X);var oe=t.subtitleStreamController;oe&&X.push(this.subtititleStreamController=new oe(this,x,V)),this.createController(t.timelineController,W),V.emeController=this.emeController=this.createController(t.emeController,W),this.cmcdController=this.createController(t.cmcdController,W),this.latencyController=this.createController(qm,W),this.coreComponents=W,X.push(p);var ge=p.onErrorOut;typeof ge=="function"&&this.on(k.ERROR,ge,p),this.on(k.MANIFEST_LOADED,N.onManifestLoaded,N)}u.isMSESupported=function(){return wh()},u.isSupported=function(){return Xm()},u.getMediaSource=function(){return Ue()};var d=u.prototype;return d.createController=function(s,t){if(s){var i=new s(this);return t&&t.push(i),i}return null},d.on=function(s,t,i){i===void 0&&(i=this),this._emitter.on(s,t,i)},d.once=function(s,t,i){i===void 0&&(i=this),this._emitter.once(s,t,i)},d.removeAllListeners=function(s){this._emitter.removeAllListeners(s)},d.off=function(s,t,i,a){i===void 0&&(i=this),this._emitter.off(s,t,i,a)},d.listeners=function(s){return this._emitter.listeners(s)},d.emit=function(s,t,i){return this._emitter.emit(s,t,i)},d.trigger=function(s,t){if(this.config.debug)return this.emit(s,s,t);try{return this.emit(s,s,t)}catch(a){if(this.logger.error("An internal error happened while handling event "+s+'. Error message: "'+a.message+'". Here is a stacktrace:',a),!this.triggeringException){this.triggeringException=!0;var i=s===k.ERROR;this.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.INTERNAL_EXCEPTION,fatal:i,event:s,error:a}),this.triggeringException=!1}}return!1},d.listenerCount=function(s){return this._emitter.listenerCount(s)},d.destroy=function(){this.logger.log("destroy"),this.trigger(k.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(function(t){return t.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(t){return t.destroy()}),this.coreComponents.length=0;var s=this.config;s.xhrSetup=s.fetchSetup=void 0,this.userConfig=null},d.attachMedia=function(s){if(!s||"media"in s&&!s.media){var t=new Error("attachMedia failed: invalid argument ("+s+")");this.trigger(k.ERROR,{type:se.OTHER_ERROR,details:q.ATTACH_MEDIA_ERROR,fatal:!0,error:t});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());var i="media"in s,a=i?s.media:s,h=i?s:{media:a};this._media=a,this.trigger(k.MEDIA_ATTACHING,h)},d.detachMedia=function(){this.logger.log("detachMedia"),this.trigger(k.MEDIA_DETACHING,{}),this._media=null},d.transferMedia=function(){this._media=null;var s=this.bufferController.transferMedia();return this.trigger(k.MEDIA_DETACHING,{transferMedia:s}),s},d.loadSource=function(s){this.stopLoad();var t=this.media,i=this._url,a=this._url=xe.buildAbsoluteURL(self.location.href,s,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log("loadSource:"+a),t&&i&&(i!==a||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(k.MANIFEST_LOADING,{url:s})},d.startLoad=function(s,t){s===void 0&&(s=-1),this.logger.log("startLoad("+(s+(t?", <skip seek to start>":""))+")"),this.started=!0,this.resumeBuffering();for(var i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(s,t),!(!this.started||!this.networkControllers));i++);},d.stopLoad=function(){this.logger.log("stopLoad"),this.started=!1;for(var s=0;s<this.networkControllers.length&&(this.networkControllers[s].stopLoad(),!(this.started||!this.networkControllers));s++);},d.resumeBuffering=function(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(function(s){s.resumeBuffering&&s.resumeBuffering()}))},d.pauseBuffering=function(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(function(s){s.pauseBuffering&&s.pauseBuffering()}))},d.swapAudioCodec=function(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},d.recoverMediaError=function(){this.logger.log("recoverMediaError");var s=this._media,t=s==null?void 0:s.currentTime;this.detachMedia(),s&&(this.attachMedia(s),t&&this.startLoad(t))},d.removeLevel=function(s){this.levelController.removeLevel(s)},d.setAudioOption=function(s){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(s))||null},d.setSubtitleOption=function(s){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(s))||null},d.getMediaDecodingInfo=function(s,t){t===void 0&&(t=this.allAudioTracks);var i=_l(t);return Ll(s,i,navigator.mediaCapabilities)},y(u,[{key:"url",get:function(){return this._url}},{key:"hasEnoughToStart",get:function(){return this.streamController.hasEnoughToStart}},{key:"startPosition",get:function(){return this.streamController.startPositionValue}},{key:"loadingEnabled",get:function(){return this.started}},{key:"bufferingEnabled",get:function(){return this.streamController.bufferingEnabled}},{key:"inFlightFragments",get:function(){var s,t=(s={},s[pe.MAIN]=this.streamController.inFlightFrag,s);return this.audioStreamController&&(t[pe.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(t[pe.SUBTITLE]=this.subtititleStreamController.inFlightFrag),t}},{key:"sessionId",get:function(){var s=this._sessionId;return s||(s=this._sessionId=ne()),s}},{key:"levels",get:function(){var s=this.levelController.levels;return s||[]}},{key:"latestLevelDetails",get:function(){return this.streamController.getLevelDetails()||null}},{key:"loadLevelObj",get:function(){return this.levelController.loadLevelObj}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(s){this.logger.log("set currentLevel:"+s),this.levelController.manualLevel=s,this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(s){this.logger.log("set nextLevel:"+s),this.levelController.manualLevel=s,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(s){this.logger.log("set loadLevel:"+s),this.levelController.manualLevel=s}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(s){this.levelController.nextLoadLevel=s}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(s){this.logger.log("set firstLevel:"+s),this.levelController.firstLevel=s}},{key:"startLevel",get:function(){var s=this.levelController.startLevel;return s===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:s},set:function(s){this.logger.log("set startLevel:"+s),s!==-1&&(s=Math.max(s,this.minAutoLevel)),this.levelController.startLevel=s}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(s){var t=!!s;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(s){this._autoLevelCapping!==s&&(this.logger.log("set autoLevelCapping:"+s),this._autoLevelCapping=s,this.levelController.checkMaxAutoUpdated())}},{key:"bandwidthEstimate",get:function(){var s=this.abrController.bwEstimator;return s?s.getEstimate():NaN},set:function(s){this.abrController.resetEstimator(s)}},{key:"abrEwmaDefaultEstimate",get:function(){var s=this.abrController.bwEstimator;return s?s.defaultEstimate:NaN}},{key:"ttfbEstimate",get:function(){var s=this.abrController.bwEstimator;return s?s.getEstimateTTFB():NaN}},{key:"maxHdcpLevel",get:function(){return this._maxHdcpLevel},set:function(s){Wc(s)&&this._maxHdcpLevel!==s&&(this._maxHdcpLevel=s,this.levelController.checkMaxAutoUpdated())}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var s=this.levels,t=this.config.minAutoBitrate;if(!s)return 0;for(var i=s.length,a=0;a<i;a++)if(s[a].maxBitrate>=t)return a;return 0}},{key:"maxAutoLevel",get:function(){var s=this.levels,t=this.autoLevelCapping,i=this.maxHdcpLevel,a;if(t===-1&&s!=null&&s.length?a=s.length-1:a=t,i)for(var h=a;h--;){var g=s[h].attrs["HDCP-LEVEL"];if(g&&g<=i)return h}return a}},{key:"firstAutoLevel",get:function(){return this.abrController.firstAutoLevel}},{key:"nextAutoLevel",get:function(){return this.abrController.nextAutoLevel},set:function(s){this.abrController.nextAutoLevel=s}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function(){return this.streamController.getMainFwdBufferInfo()}},{key:"maxBufferLength",get:function(){return this.streamController.maxBufferLength}},{key:"allAudioTracks",get:function(){var s=this.audioTrackController;return s?s.allAudioTracks:[]}},{key:"audioTracks",get:function(){var s=this.audioTrackController;return s?s.audioTracks:[]}},{key:"audioTrack",get:function(){var s=this.audioTrackController;return s?s.audioTrack:-1},set:function(s){var t=this.audioTrackController;t&&(t.audioTrack=s)}},{key:"allSubtitleTracks",get:function(){var s=this.subtitleTrackController;return s?s.allSubtitleTracks:[]}},{key:"subtitleTracks",get:function(){var s=this.subtitleTrackController;return s?s.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var s=this.subtitleTrackController;return s?s.subtitleTrack:-1},set:function(s){var t=this.subtitleTrackController;t&&(t.subtitleTrack=s)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var s=this.subtitleTrackController;return s?s.subtitleDisplay:!1},set:function(s){var t=this.subtitleTrackController;t&&(t.subtitleDisplay=s)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(s){this.config.lowLatencyMode=s}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency},set:function(s){this.latencyController.targetLatency=s}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}},{key:"pathways",get:function(){return this.levelController.pathways}},{key:"pathwayPriority",get:function(){return this.levelController.pathwayPriority},set:function(s){this.levelController.pathwayPriority=s}},{key:"bufferedToEnd",get:function(){var s;return!!((s=this.bufferController)!=null&&s.bufferedToEnd)}},{key:"interstitialsManager",get:function(){var s;return((s=this.interstitialsController)==null?void 0:s.interstitialsManager)||null}}],[{key:"version",get:function(){return Ki}},{key:"Events",get:function(){return k}},{key:"MetadataSchema",get:function(){return Kt}},{key:"ErrorTypes",get:function(){return se}},{key:"ErrorDetails",get:function(){return q}},{key:"DefaultConfig",get:function(){return u.defaultConfig?u.defaultConfig:Fm},set:function(s){u.defaultConfig=s}}])}();return Mh.defaultConfig=void 0,Mh})})(!1)}(za)),za.exports}const Ae=Number.isFinite||function(v){return typeof v=="number"&&isFinite(v)},ap=Number.isSafeInteger||function(v){return typeof v=="number"&&Math.abs(v)<=op},op=Number.MAX_SAFE_INTEGER||9007199254740991;let De=function(v){return v.NETWORK_ERROR="networkError",v.MEDIA_ERROR="mediaError",v.KEY_SYSTEM_ERROR="keySystemError",v.MUX_ERROR="muxError",v.OTHER_ERROR="otherError",v}({}),re=function(v){return v.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",v.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",v.KEY_SYSTEM_NO_SESSION="keySystemNoSession",v.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",v.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",v.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",v.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",v.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",v.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",v.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",v.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",v.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",v.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",v.MANIFEST_LOAD_ERROR="manifestLoadError",v.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",v.MANIFEST_PARSING_ERROR="manifestParsingError",v.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",v.LEVEL_EMPTY_ERROR="levelEmptyError",v.LEVEL_LOAD_ERROR="levelLoadError",v.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",v.LEVEL_PARSING_ERROR="levelParsingError",v.LEVEL_SWITCH_ERROR="levelSwitchError",v.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",v.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",v.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",v.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",v.FRAG_LOAD_ERROR="fragLoadError",v.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",v.FRAG_DECRYPT_ERROR="fragDecryptError",v.FRAG_PARSING_ERROR="fragParsingError",v.FRAG_GAP="fragGap",v.REMUX_ALLOC_ERROR="remuxAllocError",v.KEY_LOAD_ERROR="keyLoadError",v.KEY_LOAD_TIMEOUT="keyLoadTimeOut",v.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",v.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",v.BUFFER_APPEND_ERROR="bufferAppendError",v.BUFFER_APPENDING_ERROR="bufferAppendingError",v.BUFFER_STALLED_ERROR="bufferStalledError",v.BUFFER_FULL_ERROR="bufferFullError",v.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",v.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",v.ASSET_LIST_LOAD_ERROR="assetListLoadError",v.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",v.ASSET_LIST_PARSING_ERROR="assetListParsingError",v.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",v.INTERNAL_EXCEPTION="internalException",v.INTERNAL_ABORTED="aborted",v.ATTACH_MEDIA_ERROR="attachMediaError",v.UNKNOWN="unknown",v}({}),w=function(v){return v.MEDIA_ATTACHING="hlsMediaAttaching",v.MEDIA_ATTACHED="hlsMediaAttached",v.MEDIA_DETACHING="hlsMediaDetaching",v.MEDIA_DETACHED="hlsMediaDetached",v.MEDIA_ENDED="hlsMediaEnded",v.STALL_RESOLVED="hlsStallResolved",v.BUFFER_RESET="hlsBufferReset",v.BUFFER_CODECS="hlsBufferCodecs",v.BUFFER_CREATED="hlsBufferCreated",v.BUFFER_APPENDING="hlsBufferAppending",v.BUFFER_APPENDED="hlsBufferAppended",v.BUFFER_EOS="hlsBufferEos",v.BUFFERED_TO_END="hlsBufferedToEnd",v.BUFFER_FLUSHING="hlsBufferFlushing",v.BUFFER_FLUSHED="hlsBufferFlushed",v.MANIFEST_LOADING="hlsManifestLoading",v.MANIFEST_LOADED="hlsManifestLoaded",v.MANIFEST_PARSED="hlsManifestParsed",v.LEVEL_SWITCHING="hlsLevelSwitching",v.LEVEL_SWITCHED="hlsLevelSwitched",v.LEVEL_LOADING="hlsLevelLoading",v.LEVEL_LOADED="hlsLevelLoaded",v.LEVEL_UPDATED="hlsLevelUpdated",v.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",v.LEVELS_UPDATED="hlsLevelsUpdated",v.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",v.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",v.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",v.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",v.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",v.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",v.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",v.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",v.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",v.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",v.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",v.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",v.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",v.CUES_PARSED="hlsCuesParsed",v.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",v.INIT_PTS_FOUND="hlsInitPtsFound",v.FRAG_LOADING="hlsFragLoading",v.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",v.FRAG_LOADED="hlsFragLoaded",v.FRAG_DECRYPTED="hlsFragDecrypted",v.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",v.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",v.FRAG_PARSING_METADATA="hlsFragParsingMetadata",v.FRAG_PARSED="hlsFragParsed",v.FRAG_BUFFERED="hlsFragBuffered",v.FRAG_CHANGED="hlsFragChanged",v.FPS_DROP="hlsFpsDrop",v.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",v.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",v.ERROR="hlsError",v.DESTROYING="hlsDestroying",v.KEY_LOADING="hlsKeyLoading",v.KEY_LOADED="hlsKeyLoaded",v.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",v.BACK_BUFFER_REACHED="hlsBackBufferReached",v.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",v.ASSET_LIST_LOADING="hlsAssetListLoading",v.ASSET_LIST_LOADED="hlsAssetListLoaded",v.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",v.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",v.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",v.INTERSTITIAL_STARTED="hlsInterstitialStarted",v.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",v.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",v.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",v.INTERSTITIAL_ENDED="hlsInterstitialEnded",v.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",v.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",v.EVENT_CUE_ENTER="hlsEventCueEnter",v}({});var $e={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},be={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class Si{constructor(e,r=0,n=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=r,this.totalWeight_=n}sample(e,r){const n=Math.pow(this.alpha_,e);this.estimate_=r*(1-n)+n*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class lp{constructor(e,r,n,l=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Si(e),this.fast_=new Si(r),this.defaultTTFB_=l,this.ttfb_=new Si(e)}update(e,r){const{slow_:n,fast_:l,ttfb_:f}=this;n.halfLife!==e&&(this.slow_=new Si(e,n.getEstimate(),n.getTotalWeight())),l.halfLife!==r&&(this.fast_=new Si(r,l.getEstimate(),l.getTotalWeight())),f.halfLife!==e&&(this.ttfb_=new Si(e,f.getEstimate(),f.getTotalWeight()))}sample(e,r){e=Math.max(e,this.minDelayMs_);const n=8*r,l=e/1e3,f=n/l;this.fast_.sample(l,f),this.slow_.sample(l,f)}sampleTTFB(e){const r=e/1e3,n=Math.sqrt(2)*Math.exp(-Math.pow(r,2)/2);this.ttfb_.sample(n,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function up(v,e,r){return(e=fp(e))in v?Object.defineProperty(v,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):v[e]=r,v}function rt(){return rt=Object.assign?Object.assign.bind():function(v){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)({}).hasOwnProperty.call(r,n)&&(v[n]=r[n])}return v},rt.apply(null,arguments)}function Hh(v,e){var r=Object.keys(v);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(v);e&&(n=n.filter(function(l){return Object.getOwnPropertyDescriptor(v,l).enumerable})),r.push.apply(r,n)}return r}function Ze(v){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};e%2?Hh(Object(r),!0).forEach(function(n){up(v,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(v,Object.getOwnPropertyDescriptors(r)):Hh(Object(r)).forEach(function(n){Object.defineProperty(v,n,Object.getOwnPropertyDescriptor(r,n))})}return v}function hp(v,e){if(typeof v!="object"||!v)return v;var r=v[Symbol.toPrimitive];if(r!==void 0){var n=r.call(v,e);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(v)}function fp(v){var e=hp(v,"string");return typeof e=="symbol"?e:e+""}class Cr{constructor(e,r){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const n=`[${e}]:`;this.trace=Gr,this.debug=r.debug.bind(null,n),this.log=r.log.bind(null,n),this.warn=r.warn.bind(null,n),this.info=r.info.bind(null,n),this.error=r.error.bind(null,n)}}const Gr=function(){},dp={trace:Gr,debug:Gr,log:Gr,warn:Gr,info:Gr,error:Gr};function Ao(){return rt({},dp)}function cp(v,e){const r=self.console[v];return r?r.bind(self.console,`${e?"["+e+"] ":""}[${v}] >`):Gr}function Yh(v,e,r){return e[v]?e[v].bind(e):cp(v,r)}const xo=Ao();function gp(v,e,r){const n=Ao();if(typeof console=="object"&&v===!0||typeof v=="object"){const l=["debug","log","info","warn","error"];l.forEach(f=>{n[f]=Yh(f,v,r)});try{n.log(`Debug logs enabled for "${e}" in hls.js version 1.6.0`)}catch{return Ao()}l.forEach(f=>{xo[f]=Yh(f,v)})}else rt(xo,n);return n}const qe=xo;function Kr(v=!0){return typeof self>"u"?void 0:(v||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function vp(v){return typeof self<"u"&&v===self.ManagedMediaSource}function sd(v,e){const r=Object.keys(v),n=Object.keys(e),l=r.length,f=n.length;return!l||!f||l===f&&!r.some(c=>n.indexOf(c)===-1)}function Ht(v,e=!1){if(typeof TextDecoder<"u"){const T=new TextDecoder("utf-8").decode(v);if(e){const A=T.indexOf("\0");return A!==-1?T.substring(0,A):T}return T.replace(/\0/g,"")}const r=v.length;let n,l,f,c="",y=0;for(;y<r;){if(n=v[y++],n===0&&e)return c;if(n===0||n===3)continue;switch(n>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:c+=String.fromCharCode(n);break;case 12:case 13:l=v[y++],c+=String.fromCharCode((n&31)<<6|l&63);break;case 14:l=v[y++],f=v[y++],c+=String.fromCharCode((n&15)<<12|(l&63)<<6|(f&63)<<0);break}}return c}const gr={hexDump:function(v){let e="";for(let r=0;r<v.length;r++){let n=v[r].toString(16);n.length<2&&(n="0"+n),e+=n}return e}};function mp(v){return v&&v.__esModule&&Object.prototype.hasOwnProperty.call(v,"default")?v.default:v}var Qa={exports:{}},Wh;function pp(){return Wh||(Wh=1,function(v,e){(function(r){var n=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,l=/^(?=([^\/?#]*))\1([^]*)$/,f=/(?:\/|^)\.(?=\/)/g,c=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,y={buildAbsoluteURL:function(S,T,A){if(A=A||{},S=S.trim(),T=T.trim(),!T){if(!A.alwaysNormalize)return S;var L=y.parseURL(S);if(!L)throw new Error("Error trying to parse base URL.");return L.path=y.normalizePath(L.path),y.buildURLFromParts(L)}var b=y.parseURL(T);if(!b)throw new Error("Error trying to parse relative URL.");if(b.scheme)return A.alwaysNormalize?(b.path=y.normalizePath(b.path),y.buildURLFromParts(b)):T;var C=y.parseURL(S);if(!C)throw new Error("Error trying to parse base URL.");if(!C.netLoc&&C.path&&C.path[0]!=="/"){var D=l.exec(C.path);C.netLoc=D[1],C.path=D[2]}C.netLoc&&!C.path&&(C.path="/");var M={scheme:C.scheme,netLoc:b.netLoc,path:null,params:b.params,query:b.query,fragment:b.fragment};if(!b.netLoc&&(M.netLoc=C.netLoc,b.path[0]!=="/"))if(!b.path)M.path=C.path,b.params||(M.params=C.params,b.query||(M.query=C.query));else{var F=C.path,$=F.substring(0,F.lastIndexOf("/")+1)+b.path;M.path=y.normalizePath($)}return M.path===null&&(M.path=A.alwaysNormalize?y.normalizePath(b.path):b.path),y.buildURLFromParts(M)},parseURL:function(S){var T=n.exec(S);return T?{scheme:T[1]||"",netLoc:T[2]||"",path:T[3]||"",params:T[4]||"",query:T[5]||"",fragment:T[6]||""}:null},normalizePath:function(S){for(S=S.split("").reverse().join("").replace(f,"");S.length!==(S=S.replace(c,"")).length;);return S.split("").reverse().join("")},buildURLFromParts:function(S){return S.scheme+S.netLoc+S.path+S.params+S.query+S.fragment}};v.exports=y})()}(Qa)),Qa.exports}var Go=pp();class $o{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var tt={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class nd{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,Ep(this,"stats")}setByteRange(e,r){const n=e.split("@",2);let l;n.length===1?l=(r==null?void 0:r.byteRangeEndOffset)||0:l=parseInt(n[1]),this._byteRange=[l,parseInt(n[0])+l]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[tt.AUDIO]:null,[tt.VIDEO]:null,[tt.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new $o),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Go.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[tt.AUDIO]=null,e[tt.VIDEO]=null,e[tt.AUDIOVIDEO]=null}}function wt(v){return v.sn!=="initSegment"}class Za extends nd{constructor(e,r){super(r),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange){const e=this.byteRange[0],r=this.byteRange[1];if(Ae(e)&&Ae(r))return r-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const r=this.levelkeys.identity;if(r)this._decryptdata=r.getDecryptData(this.sn);else{const n=Object.keys(this.levelkeys);if(n.length===1)return this._decryptdata=this.levelkeys[n[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=Ae(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){const r=Object.keys(this.levelkeys),n=r.length;if(n>1||n===1&&this.levelkeys[r[0]].encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!Ae(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return wt(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){const r=this.levelkeys[e];r&&!this._decryptdata&&(this._decryptdata=r.getDecryptData(this.sn))}}abortRequests(){var e,r;(e=this.loader)==null||e.abort(),(r=this.keyLoader)==null||r.abort()}setElementaryStreamInfo(e,r,n,l,f,c=!1){const{elementaryStreams:y}=this,S=y[e];if(!S){y[e]={startPTS:r,endPTS:n,startDTS:l,endDTS:f,partial:c};return}S.startPTS=Math.min(S.startPTS,r),S.endPTS=Math.max(S.endPTS,n),S.startDTS=Math.min(S.startDTS,l),S.endDTS=Math.max(S.endDTS,f)}}class yp extends nd{constructor(e,r,n,l,f){super(n),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=r,this.index=l;const c=e.enumeratedString("BYTERANGE");c&&this.setByteRange(c,f),f&&(this.fragOffset=f.fragOffset+f.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function ad(v,e){const r=Object.getPrototypeOf(v);if(r){const n=Object.getOwnPropertyDescriptor(r,e);return n||ad(r,e)}}function Ep(v,e){const r=ad(v,e);r&&(r.enumerable=!0,Object.defineProperty(v,e,r))}const Sn=Math.pow(2,32)-1,Tp=[].push,od={video:1,audio:2,id3:3,text:4};function It(v){return String.fromCharCode.apply(null,v)}function ld(v,e){const r=v[e]<<8|v[e+1];return r<0?65536+r:r}function ke(v,e){const r=ud(v,e);return r<0?4294967296+r:r}function qh(v,e){let r=ke(v,e);return r*=Math.pow(2,32),r+=ke(v,e+4),r}function ud(v,e){return v[e]<<24|v[e+1]<<16|v[e+2]<<8|v[e+3]}function Ja(v,e,r){v[e]=r>>24,v[e+1]=r>>16&255,v[e+2]=r>>8&255,v[e+3]=r&255}function Sp(v){const e=v.byteLength;for(let r=0;r<e;){const n=ke(v,r);if(n>8&&v[r+4]===109&&v[r+5]===111&&v[r+6]===111&&v[r+7]===102)return!0;r=n>1?r+n:e}return!1}function Me(v,e){const r=[];if(!e.length)return r;const n=v.byteLength;for(let l=0;l<n;){const f=ke(v,l),c=It(v.subarray(l+4,l+8)),y=f>1?l+f:n;if(c===e[0])if(e.length===1)r.push(v.subarray(l+8,y));else{const S=Me(v.subarray(l+8,y),e.slice(1));S.length&&Tp.apply(r,S)}l=y}return r}function Ap(v){const e=[],r=v[0];let n=8;const l=ke(v,n);n+=4;let f=0,c=0;r===0?(f=ke(v,n),c=ke(v,n+4),n+=8):(f=qh(v,n),c=qh(v,n+8),n+=16),n+=2;let y=v.length+c;const S=ld(v,n);n+=2;for(let T=0;T<S;T++){let A=n;const L=ke(v,A);A+=4;const b=L&2147483647;if((L&2147483648)>>>31===1)return qe.warn("SIDX has hierarchical references (not supported)"),null;const D=ke(v,A);A+=4,e.push({referenceSize:b,subsegmentDuration:D,info:{duration:D/l,start:y,end:y+b-1}}),y+=b,A+=4,n=A}return{earliestPresentationTime:f,timescale:l,version:r,referencesCount:S,references:e}}function hd(v){const e=[],r=Me(v,["moov","trak"]);for(let l=0;l<r.length;l++){const f=r[l],c=Me(f,["tkhd"])[0];if(c){let y=c[0];const S=ke(c,y===0?12:20),T=Me(f,["mdia","mdhd"])[0];if(T){y=T[0];const A=ke(T,y===0?12:20),L=Me(f,["mdia","hdlr"])[0];if(L){const b=It(L.subarray(8,12)),C={soun:tt.AUDIO,vide:tt.VIDEO}[b],D=Me(f,["mdia","minf","stbl","stsd"])[0],M=xp(D);C?(e[S]={timescale:A,type:C,stsd:M},e[C]=Ze({timescale:A,id:S},M)):e[S]={timescale:A,type:b,stsd:M}}}}}return Me(v,["moov","mvex","trex"]).forEach(l=>{const f=ke(l,4),c=e[f];c&&(c.default={duration:ke(l,12),flags:ke(l,20)})}),e}function xp(v){const e=v.subarray(8),r=e.subarray(86),n=It(e.subarray(4,8));let l=n,f;const c=n==="enca"||n==="encv";if(c){const T=Me(e,[n])[0].subarray(n==="enca"?28:78);Me(T,["sinf"]).forEach(L=>{const b=Me(L,["schm"])[0];if(b){const C=It(b.subarray(4,8));if(C==="cbcs"||C==="cenc"){const D=Me(L,["frma"])[0];D&&(l=It(D))}}})}const y=l;switch(l){case"avc1":case"avc2":case"avc3":case"avc4":{const S=Me(r,["avcC"])[0];l+="."+en(S[1])+en(S[2])+en(S[3]),f=Js(y==="avc1"?"dva1":"dvav",r);break}case"mp4a":{const S=Me(e,[n])[0],T=Me(S.subarray(28),["esds"])[0];if(T&&T.length>7){let A=4;if(T[A++]!==3)break;A=eo(T,A),A+=2;const L=T[A++];if(L&128&&(A+=2),L&64&&(A+=T[A++]),T[A++]!==4)break;A=eo(T,A);const b=T[A++];if(b===64)l+="."+en(b);else break;if(A+=12,T[A++]!==5)break;A=eo(T,A);const C=T[A++];let D=(C&248)>>3;D===31&&(D+=1+((C&7)<<3)+((T[A]&224)>>5)),l+="."+D}break}case"hvc1":case"hev1":{const S=Me(r,["hvcC"]);if(S){const T=S[0],A=T[1],L=["","A","B","C"][A>>6],b=A&31,C=ke(T,2),D=(A&32)>>5?"H":"L",M=T[12],F=T.subarray(6,12);l+="."+L+b,l+="."+C.toString(16).toUpperCase(),l+="."+D+M;let $="";for(let H=F.length;H--;){const K=F[H];(K||$)&&($="."+K.toString(16).toUpperCase()+$)}l+=$}f=Js(y=="hev1"?"dvhe":"dvh1",r);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{l=Js(l,r)||l;break}case"vp09":{const S=Me(r,["vpcC"])[0],T=S[4],A=S[5],L=S[6]>>4&15;l+="."+cr(T)+"."+cr(A)+"."+cr(L);break}case"av01":{const S=Me(r,["av1C"])[0],T=S[1]>>>5,A=S[1]&31,L=S[2]>>>7?"H":"M",b=(S[2]&64)>>6,C=(S[2]&32)>>5,D=T===2&&b?C?12:10:b?10:8,M=(S[2]&16)>>4,F=(S[2]&8)>>3,$=(S[2]&4)>>2,H=S[2]&3;l+="."+T+"."+cr(A)+L+"."+cr(D)+"."+M+"."+F+$+H+"."+cr(1)+"."+cr(1)+"."+cr(1)+"."+0,f=Js("dav1",r);break}}return{codec:l,encrypted:c,supplemental:f}}function Js(v,e){const r=Me(e,["dvvC"]),n=r.length?r[0]:Me(e,["dvcC"])[0];if(n){const l=n[2]>>1&127,f=n[2]<<5&32|n[3]>>3&31;return v+"."+cr(l)+"."+cr(f)}}function eo(v,e){const r=e+5;for(;v[e++]&128&&e<r;);return e}function en(v){return("0"+v.toString(16).toUpperCase()).slice(-2)}function cr(v){return(v<10?"0":"")+v}function Lp(v,e){if(!v||!e)return v;const r=e.keyId;return r&&e.isCommonEncryption&&Me(v,["moov","trak"]).forEach(l=>{const c=Me(l,["mdia","minf","stbl","stsd"])[0].subarray(8);let y=Me(c,["enca"]);const S=y.length>0;S||(y=Me(c,["encv"])),y.forEach(T=>{const A=S?T.subarray(28):T.subarray(78);Me(A,["sinf"]).forEach(b=>{const C=fd(b);if(C){const D=C.subarray(8,24);D.some(M=>M!==0)||(qe.log(`[eme] Patching keyId in 'enc${S?"a":"v"}>sinf>>tenc' box: ${gr.hexDump(D)} -> ${gr.hexDump(r)}`),C.set(r,8))}})})}),v}function fd(v){const e=Me(v,["schm"])[0];if(e){const r=It(e.subarray(4,8));if(r==="cbcs"||r==="cenc")return Me(v,["schi","tenc"])[0]}return null}function Ip(v,e){return Me(e,["moof","traf"]).reduce((r,n)=>{const l=Me(n,["tfdt"])[0],f=l[0],c=Me(n,["tfhd"]).reduce((y,S)=>{const T=ke(S,4),A=v[T];if(A){let L=ke(l,4);if(f===1){if(L===Sn)return qe.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),y;L*=Sn+1,L+=ke(l,8)}const b=A.timescale||9e4,C=L/b;if(Ae(C)&&(y===null||C<y))return C}return y},null);return c!==null&&Ae(c)&&(r===null||c<r)?c:r},null)}function Rp(v,e){let r=0,n=0,l=0;const f=Me(v,["moof","traf"]);for(let c=0;c<f.length;c++){const y=f[c],S=Me(y,["tfhd"])[0],T=ke(S,4),A=e[T];if(!A)continue;const L=A.default,b=ke(S,0)|(L==null?void 0:L.flags);let C=L==null?void 0:L.duration;b&8&&(b&2?C=ke(S,12):C=ke(S,8));const D=A.timescale||9e4,M=Me(y,["trun"]);for(let F=0;F<M.length;F++){if(r=bp(M[F]),!r&&C){const $=ke(M[F],4);r=C*$}A.type===tt.VIDEO?n+=r/D:A.type===tt.AUDIO&&(l+=r/D)}}if(n===0&&l===0){let c=1/0,y=0,S=0;const T=Me(v,["sidx"]);for(let A=0;A<T.length;A++){const L=Ap(T[A]);if(L!=null&&L.references){c=Math.min(c,L.earliestPresentationTime/L.timescale);const b=L.references.reduce((C,D)=>C+D.info.duration||0,0);y=Math.max(y,b+L.earliestPresentationTime/L.timescale),S=y-c}}if(S&&Ae(S))return S}return n||l}function bp(v){const e=ke(v,0);let r=8;e&1&&(r+=4),e&4&&(r+=4);let n=0;const l=ke(v,4);for(let f=0;f<l;f++){if(e&256){const c=ke(v,r);n+=c,r+=4}e&512&&(r+=4),e&1024&&(r+=4),e&2048&&(r+=4)}return n}function _p(v,e,r){Me(e,["moof","traf"]).forEach(n=>{Me(n,["tfhd"]).forEach(l=>{const f=ke(l,4),c=v[f];if(!c)return;const y=c.timescale||9e4;Me(n,["tfdt"]).forEach(S=>{const T=S[0],A=r*y;if(A){let L=ke(S,4);if(T===0)L-=A,L=Math.max(L,0),Ja(S,4,L);else{L*=Math.pow(2,32),L+=ke(S,8),L-=A,L=Math.max(L,0);const b=Math.floor(L/(Sn+1)),C=Math.floor(L%(Sn+1));Ja(S,4,b),Ja(S,8,C)}}})})})}function Dp(v){const e={valid:null,remainder:null},r=Me(v,["moof"]);if(r.length<2)return e.remainder=v,e;const n=r[r.length-1];return e.valid=v.slice(0,n.byteOffset-8),e.remainder=v.slice(n.byteOffset-8),e}function Qt(v,e){const r=new Uint8Array(v.length+e.length);return r.set(v),r.set(e,v.length),r}function jh(v,e){const r=[],n=e.samples,l=e.timescale,f=e.id;let c=!1;return Me(n,["moof"]).map(S=>{const T=S.byteOffset-8;Me(S,["traf"]).map(L=>{const b=Me(L,["tfdt"]).map(C=>{const D=C[0];let M=ke(C,4);return D===1&&(M*=Math.pow(2,32),M+=ke(C,8)),M/l})[0];return b!==void 0&&(v=b),Me(L,["tfhd"]).map(C=>{const D=ke(C,4),M=ke(C,0)&16777215,F=(M&1)!==0,$=(M&2)!==0,H=(M&8)!==0;let K=0;const z=(M&16)!==0;let Q=0;const ne=(M&32)!==0;let Z=8;D===f&&(F&&(Z+=8),$&&(Z+=4),H&&(K=ke(C,Z),Z+=4),z&&(Q=ke(C,Z),Z+=4),ne&&(Z+=4),e.type==="video"&&(c=kn(e.codec)),Me(L,["trun"]).map(ie=>{const le=ie[0],ee=ke(ie,0)&16777215,ve=(ee&1)!==0;let Ee=0;const Ne=(ee&4)!==0,Ce=(ee&256)!==0;let _e=0;const xe=(ee&512)!==0;let ue=0;const Re=(ee&1024)!==0,me=(ee&2048)!==0;let se=0;const q=ke(ie,4);let k=8;ve&&(Ee=ke(ie,k),k+=4),Ne&&(k+=4);let Te=Ee+T;for(let pe=0;pe<q;pe++){if(Ce?(_e=ke(ie,k),k+=4):_e=K,xe?(ue=ke(ie,k),k+=4):ue=Q,Re&&(k+=4),me&&(le===0?se=ke(ie,k):se=ud(ie,k),k+=4),e.type===tt.VIDEO){let Ke=0;for(;Ke<ue;){const et=ke(n,Te);if(Te+=4,Cp(c,n[Te])){const st=n.subarray(Te,Te+et);Ko(st,c?2:1,v+se/l,r)}Te+=et,Ke+=et+4}}v+=_e/l}}))})})}),r}function kn(v){if(!v)return!1;const e=v.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function Cp(v,e){if(v){const r=e>>1&63;return r===39||r===40}else return(e&31)===6}function Ko(v,e,r,n){const l=dd(v);let f=0;f+=e;let c=0,y=0,S=0;for(;f<l.length;){c=0;do{if(f>=l.length)break;S=l[f++],c+=S}while(S===255);y=0;do{if(f>=l.length)break;S=l[f++],y+=S}while(S===255);const T=l.length-f;let A=f;if(y<T)f+=y;else if(y>T){qe.error(`Malformed SEI payload. ${y} is too small, only ${T} bytes left to parse.`);break}if(c===4){if(l[A++]===181){const b=ld(l,A);if(A+=2,b===49){const C=ke(l,A);if(A+=4,C===1195456820){const D=l[A++];if(D===3){const M=l[A++],F=31&M,$=64&M,H=$?2+F*3:0,K=new Uint8Array(H);if($){K[0]=M;for(let z=1;z<H;z++)K[z]=l[A++]}n.push({type:D,payloadType:c,pts:r,bytes:K})}}}}}else if(c===5&&y>16){const L=[];for(let D=0;D<16;D++){const M=l[A++].toString(16);L.push(M.length==1?"0"+M:M),(D===3||D===5||D===7||D===9)&&L.push("-")}const b=y-16,C=new Uint8Array(b);for(let D=0;D<b;D++)C[D]=l[A++];n.push({payloadType:c,pts:r,uuid:L.join(""),userData:Ht(C),userDataBytes:C})}}}function dd(v){const e=v.byteLength,r=[];let n=1;for(;n<e-2;)v[n]===0&&v[n+1]===0&&v[n+2]===3?(r.push(n+2),n+=2):n++;if(r.length===0)return v;const l=e-r.length,f=new Uint8Array(l);let c=0;for(n=0;n<l;c++,n++)c===r[0]&&(c++,r.shift()),f[n]=v[c];return f}function Pp(v){const e=v[0];let r="",n="",l=0,f=0,c=0,y=0,S=0,T=0;if(e===0){for(;It(v.subarray(T,T+1))!=="\0";)r+=It(v.subarray(T,T+1)),T+=1;for(r+=It(v.subarray(T,T+1)),T+=1;It(v.subarray(T,T+1))!=="\0";)n+=It(v.subarray(T,T+1)),T+=1;n+=It(v.subarray(T,T+1)),T+=1,l=ke(v,12),f=ke(v,16),y=ke(v,20),S=ke(v,24),T=28}else if(e===1){T+=4,l=ke(v,T),T+=4;const L=ke(v,T);T+=4;const b=ke(v,T);for(T+=4,c=2**32*L+b,ap(c)||(c=Number.MAX_SAFE_INTEGER,qe.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),y=ke(v,T),T+=4,S=ke(v,T),T+=4;It(v.subarray(T,T+1))!=="\0";)r+=It(v.subarray(T,T+1)),T+=1;for(r+=It(v.subarray(T,T+1)),T+=1;It(v.subarray(T,T+1))!=="\0";)n+=It(v.subarray(T,T+1)),T+=1;n+=It(v.subarray(T,T+1)),T+=1}const A=v.subarray(T,v.byteLength);return{schemeIdUri:r,value:n,timeScale:l,presentationTime:c,presentationTimeDelta:f,eventDuration:y,id:S,payload:A}}function kp(v,...e){const r=e.length;let n=8,l=r;for(;l--;)n+=e[l].byteLength;const f=new Uint8Array(n);for(f[0]=n>>24&255,f[1]=n>>16&255,f[2]=n>>8&255,f[3]=n&255,f.set(v,4),l=0,n=8;l<r;l++)f.set(e[l],n),n+=e[l].byteLength;return f}function wp(v,e,r){if(v.byteLength!==16)throw new RangeError("Invalid system id");let n,l;n=0,l=new Uint8Array;let f;n>0?(f=new Uint8Array(4),e.length>0&&new DataView(f.buffer).setUint32(0,e.length,!1)):f=new Uint8Array;const c=new Uint8Array(4);return r&&r.byteLength>0&&new DataView(c.buffer).setUint32(0,r.byteLength,!1),kp([112,115,115,104],new Uint8Array([n,0,0,0]),v,f,l,c,r||new Uint8Array)}function Op(v){const e=[];if(v instanceof ArrayBuffer){const r=v.byteLength;let n=0;for(;n+32<r;){const l=new DataView(v,n),f=Mp(l);e.push(f),n+=f.size}}return e}function Mp(v){const e=v.getUint32(0),r=v.byteOffset,n=v.byteLength;if(n<e)return{offset:r,size:n};if(v.getUint32(4)!==1886614376)return{offset:r,size:e};const f=v.getUint32(8)>>>24;if(f!==0&&f!==1)return{offset:r,size:e};const c=v.buffer,y=gr.hexDump(new Uint8Array(c,r+12,16)),S=v.getUint32(28);let T=null,A=null;if(f===0){if(e-32<S||S<22)return{offset:r,size:e};A=new Uint8Array(c,r+32,S)}else if(f===1){if(!S||n<r+32+S*16+16)return{offset:r,size:e};T=[];for(let L=0;L<S;L++)T.push(new Uint8Array(c,r+32+L*16,16))}return{version:f,systemId:y,kids:T,data:A,offset:r,size:e}}const cd=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Di={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function gd(v,e){const r=Di[e];return!!r&&!!r[v.slice(0,4)]}function Lo(v,e,r=!0){return!v.split(",").some(n=>!vd(n,e,r))}function vd(v,e,r=!0){var n;const l=Kr(r);return(n=l==null?void 0:l.isTypeSupported(es(v,e)))!=null?n:!1}function es(v,e){return`${e}/mp4;codecs=${v}`}function Xh(v){if(v){const e=v.substring(0,4);return Di.video[e]}return 2}function An(v){const e=cd();return v.split(",").reduce((r,n)=>{const f=e&&kn(n)?9:Di.video[n];return f?(f*2+r)/(r?3:2):(Di.audio[n]+r)/(r?2:1)},0)}const to={};function Fp(v,e=!0){if(to[v])return to[v];const r={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[v];for(let l=0;l<r.length;l++){var n;if(vd(r[l],"audio",e))return to[v]=r[l],r[l];if(r[l]==="mp3"&&(n=Kr(e))!=null&&n.isTypeSupported("audio/mpeg"))return""}return v}const Np=/flac|opus|mp4a\.40\.34/i;function xn(v,e=!0){return v.replace(Np,r=>Fp(r.toLowerCase(),e))}function Up(v,e){const r=[];if(v){const n=v.split(",");for(let l=0;l<n.length;l++)gd(n[l],"video")||r.push(n[l])}return e&&r.push(e),r.join(",")}function gn(v,e){if(v&&(v.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(v)!==-1))return v;if(e){const r=e.split(",");if(r.length>1){if(v){for(let n=r.length;n--;)if(r[n].substring(0,4)===v.substring(0,4))return r[n]}return r[0]}}return e||v}function Bp(v){const e=v.split(",");for(let r=0;r<e.length;r++){const n=e[r].split(".");if(n.length>2){let l=n.shift()+".";l+=parseInt(n.shift()).toString(16),l+=("000"+parseInt(n.shift()).toString(16)).slice(-4),e[r]=l}}return e.join(",")}function Gp(v){if(v.startsWith("av01.")){const e=v.split("."),r=["0","111","01","01","01","0"];for(let n=e.length;n>4&&n<10;n++)e[n]=r[n-4];return e.join(".")}return v}function zh(v){const e=Kr(v)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function md(v){return v.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const pd={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function yd(v,e){return{supported:!1,configurations:e,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:v}}const Qh={};function $p(v,e,r,n,l,f){const c=v.audioCodec?v.audioGroups:null,y=f==null?void 0:f.audioCodec,S=f==null?void 0:f.channels,T=S?parseInt(S):y?1/0:2;let A=null;if(c!=null&&c.length)try{c.length===1&&c[0]?A=e.groups[c[0]].channels:A=c.reduce((L,b)=>{if(b){const C=e.groups[b];if(!C)throw new Error(`Audio track group ${b} not found`);Object.keys(C.channels).forEach(D=>{L[D]=(L[D]||0)+C.channels[D]})}return L},{2:0})}catch{return!0}return v.videoCodec!==void 0&&(v.width>1920&&v.height>1088||v.height>1920&&v.width>1088||v.frameRate>Math.max(n,30)||v.videoRange!=="SDR"&&v.videoRange!==r||v.bitrate>Math.max(l,8e6))||!!A&&Ae(T)&&Object.keys(A).some(L=>parseInt(L)>T)}function Ed(v,e,r){const n=v.videoCodec,l=v.audioCodec;if(!n&&!l||!r)return Promise.resolve(pd);const f=[];if(n){const c={width:v.width,height:v.height,bitrate:Math.ceil(Math.max(v.bitrate*.9,v.averageBitrate)),framerate:v.frameRate||30},y=v.videoRange;y!=="SDR"&&(c.transferFunction=y.toLowerCase());const S=n.split(","),T=navigator.userAgent;if(S.some(A=>kn(A))&&cd())return Promise.resolve(yd(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: (${T})`),f));f.push.apply(f,S.map(A=>({type:"media-source",video:Ze(Ze({},c),{},{contentType:es(Gp(A),"video")})})))}return l&&v.audioGroups&&v.audioGroups.forEach(c=>{var y;c&&((y=e.groups[c])==null||y.tracks.forEach(S=>{if(S.groupId===c){const T=S.channels||"",A=parseFloat(T);Ae(A)&&A>2&&f.push.apply(f,l.split(",").map(L=>({type:"media-source",audio:{contentType:es(L,"audio"),channels:""+A}})))}}))}),Promise.all(f.map(c=>{const y=Kp(c);return Qh[y]||(Qh[y]=r.decodingInfo(c))})).then(c=>({supported:!c.some(y=>!y.supported),configurations:f,decodingInfoResults:c})).catch(c=>({supported:!1,configurations:f,decodingInfoResults:[],error:c}))}function Kp(v){const{audio:e,video:r}=v,n=r||e;if(n){const l=md(n.contentType);if(r)return`r${r.height}x${r.width}f${Math.ceil(r.framerate)}${r.transferFunction||"sd"}_${l}_${Math.ceil(r.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${l}`}return""}const Io=["NONE","TYPE-0","TYPE-1",null];function Vp(v){return Io.indexOf(v)>-1}const Ln=["SDR","PQ","HLG"];function Hp(v){return!!v&&Ln.indexOf(v)>-1}var vn={No:"",Yes:"YES",v2:"v2"};function Zh(v){const{canSkipUntil:e,canSkipDateRanges:r,age:n}=v,l=n<e/2;return e&&l?r?vn.v2:vn.Yes:vn.No}class Jh{constructor(e,r,n){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=r,this.skip=n}addDirectives(e){const r=new self.URL(e);return this.msn!==void 0&&r.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&r.searchParams.set("_HLS_part",this.part.toString()),this.skip&&r.searchParams.set("_HLS_skip",this.skip),r.href}}class ts{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(n=>!!n).map(n=>n.substring(0,4)).join(","),"supplemental"in e){var r;this.supplemental=e.supplemental;const n=(r=e.supplemental)==null?void 0:r.videoCodec;n&&n!==e.videoCodec&&(this.codecSet+=`,${n.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return ef(this._audioGroups,e)}hasSubtitleGroup(e){return ef(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,r){if(r){if(e==="audio"){let n=this._audioGroups;n||(n=this._audioGroups=[]),n.indexOf(r)===-1&&n.push(r)}else if(e==="text"){let n=this._subtitleGroups;n||(n=this._subtitleGroups=[]),n.indexOf(r)===-1&&n.push(r)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function ef(v,e){return!e||!v?!1:v.indexOf(e)!==-1}function Yp(){if(typeof matchMedia=="function"){const v=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(v.media!==e.media)return v.matches===!0}return!1}function Wp(v,e){let r=!1,n=[];if(v&&(r=v!=="SDR",n=[v]),e){n=e.allowedVideoRanges||Ln.slice(0);const l=n.join("")!=="SDR"&&!e.videoCodec;r=e.preferHDR!==void 0?e.preferHDR:l&&Yp(),r||(n=["SDR"])}return{preferHDR:r,allowedVideoRanges:n}}const qp=v=>{const e=new WeakSet;return(r,n)=>{if(v&&(n=v(r,n)),typeof n=="object"&&n!==null){if(e.has(n))return;e.add(n)}return n}},ot=(v,e)=>JSON.stringify(v,qp(e));function jp(v,e,r,n,l){const f=Object.keys(v),c=n==null?void 0:n.channels,y=n==null?void 0:n.audioCodec,S=l==null?void 0:l.videoCodec,T=c&&parseInt(c)===2;let A=!1,L=!1,b=1/0,C=1/0,D=1/0,M=1/0,F=0,$=[];const{preferHDR:H,allowedVideoRanges:K}=Wp(e,l);for(let ie=f.length;ie--;){const le=v[f[ie]];A||(A=le.channels[2]>0),b=Math.min(b,le.minHeight),C=Math.min(C,le.minFramerate),D=Math.min(D,le.minBitrate),K.filter(ve=>le.videoRanges[ve]>0).length>0&&(L=!0)}b=Ae(b)?b:0,C=Ae(C)?C:0;const z=Math.max(1080,b),Q=Math.max(30,C);D=Ae(D)?D:r,r=Math.max(D,r),L||(e=void 0);const ne=f.length>1;return{codecSet:f.reduce((ie,le)=>{const ee=v[le];if(le===ie)return ie;if($=L?K.filter(ve=>ee.videoRanges[ve]>0):[],ne){if(ee.minBitrate>r)return dr(le,`min bitrate of ${ee.minBitrate} > current estimate of ${r}`),ie;if(!ee.hasDefaultAudio)return dr(le,"no renditions with default or auto-select sound found"),ie;if(y&&le.indexOf(y.substring(0,4))%5!==0)return dr(le,`audio codec preference "${y}" not found`),ie;if(c&&!T){if(!ee.channels[c])return dr(le,`no renditions with ${c} channel sound found (channels options: ${Object.keys(ee.channels)})`),ie}else if((!y||T)&&A&&ee.channels[2]===0)return dr(le,"no renditions with stereo sound found"),ie;if(ee.minHeight>z)return dr(le,`min resolution of ${ee.minHeight} > maximum of ${z}`),ie;if(ee.minFramerate>Q)return dr(le,`min framerate of ${ee.minFramerate} > maximum of ${Q}`),ie;if(!$.some(ve=>ee.videoRanges[ve]>0))return dr(le,`no variants with VIDEO-RANGE of ${ot($)} found`),ie;if(S&&le.indexOf(S.substring(0,4))%5!==0)return dr(le,`video codec preference "${S}" not found`),ie;if(ee.maxScore<F)return dr(le,`max score of ${ee.maxScore} < selected max of ${F}`),ie}return ie&&(An(le)>=An(ie)||ee.fragmentError>v[ie].fragmentError)?ie:(M=ee.minIndex,F=ee.maxScore,le)},void 0),videoRanges:$,preferHDR:H,minFramerate:C,minBitrate:D,minIndex:M}}function dr(v,e){qe.log(`[abr] start candidates with "${v}" ignored because ${e}`)}function Td(v){return v.reduce((e,r)=>{let n=e.groups[r.groupId];n||(n=e.groups[r.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),n.tracks.push(r);const l=r.channels||"2";return n.channels[l]=(n.channels[l]||0)+1,n.hasDefault=n.hasDefault||r.default,n.hasAutoSelect=n.hasAutoSelect||r.autoselect,n.hasDefault&&(e.hasDefaultAudio=!0),n.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Xp(v,e,r,n){return v.slice(r,n+1).reduce((l,f,c)=>{if(!f.codecSet)return l;const y=f.audioGroups;let S=l[f.codecSet];S||(l[f.codecSet]=S={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:c,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!y,fragmentError:0}),S.minBitrate=Math.min(S.minBitrate,f.bitrate);const T=Math.min(f.height,f.width);return S.minHeight=Math.min(S.minHeight,T),S.minFramerate=Math.min(S.minFramerate,f.frameRate),S.minIndex=Math.min(S.minIndex,c),S.maxScore=Math.max(S.maxScore,f.score),S.fragmentError+=f.fragmentError,S.videoRanges[f.videoRange]=(S.videoRanges[f.videoRange]||0)+1,y&&y.forEach(A=>{if(!A)return;const L=e.groups[A];L&&(S.hasDefaultAudio=S.hasDefaultAudio||e.hasDefaultAudio?L.hasDefault:L.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(L.channels).forEach(b=>{S.channels[b]=(S.channels[b]||0)+L.channels[b]}))}),l},{})}function tf(v){if(!v)return v;const{lang:e,assocLang:r,characteristics:n,channels:l,audioCodec:f}=v;return{lang:e,assocLang:r,characteristics:n,channels:l,audioCodec:f}}function mr(v,e,r){if("attrs"in v){const n=e.indexOf(v);if(n!==-1)return n}for(let n=0;n<e.length;n++){const l=e[n];if(ti(v,l,r))return n}return-1}function ti(v,e,r){const{groupId:n,name:l,lang:f,assocLang:c,default:y}=v,S=v.forced;return(n===void 0||e.groupId===n)&&(l===void 0||e.name===l)&&(f===void 0||zp(f,e.lang))&&(f===void 0||e.assocLang===c)&&(y===void 0||e.default===y)&&(S===void 0||e.forced===S)&&(!("characteristics"in v)||Qp(v.characteristics||"",e.characteristics))&&(r===void 0||r(v,e))}function zp(v,e="--"){return v.length===e.length?v===e:v.startsWith(e)||e.startsWith(v)}function Qp(v,e=""){const r=v.split(","),n=e.split(",");return r.length===n.length&&!r.some(l=>n.indexOf(l)===-1)}function Jr(v,e){const{audioCodec:r,channels:n}=v;return(r===void 0||(e.audioCodec||"").substring(0,4)===r.substring(0,4))&&(n===void 0||n===(e.channels||"2"))}function Zp(v,e,r,n,l){const f=e[n],y=e.reduce((b,C,D)=>{const M=C.uri;return(b[M]||(b[M]=[])).push(D),b},{})[f.uri];y.length>1&&(n=Math.max.apply(Math,y));const S=f.videoRange,T=f.frameRate,A=f.codecSet.substring(0,4),L=rf(e,n,b=>{if(b.videoRange!==S||b.frameRate!==T||b.codecSet.substring(0,4)!==A)return!1;const C=b.audioGroups,D=r.filter(M=>!C||C.indexOf(M.groupId)!==-1);return mr(v,D,l)>-1});return L>-1?L:rf(e,n,b=>{const C=b.audioGroups,D=r.filter(M=>!C||C.indexOf(M.groupId)!==-1);return mr(v,D,l)>-1})}function rf(v,e,r){for(let n=e;n>-1;n--)if(r(v[n]))return n;for(let n=e+1;n<v.length;n++)if(r(v[n]))return n;return-1}function In(v,e){var r;return!!v&&v!==((r=e.loadLevelObj)==null?void 0:r.uri)}class Jp extends Cr{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.bwEstimator=void 0,this._abandonRulesCheck=r=>{var n;const{fragCurrent:l,partCurrent:f,hls:c}=this,{autoLevelEnabled:y,media:S}=c;if(!l||!S)return;const T=performance.now(),A=f?f.stats:l.stats,L=f?f.duration:l.duration,b=T-A.loading.start,C=c.minAutoLevel,D=l.level,M=this._nextAutoLevel;if(A.aborted||A.loaded&&A.loaded===A.total||D<=C){this.clearTimer(),this._nextAutoLevel=-1;return}if(!y)return;const F=M>-1&&M!==D,$=!!r||F;if(!$&&(S.paused||!S.playbackRate||!S.readyState))return;const H=c.mainForwardBufferInfo;if(!$&&H===null)return;const K=this.bwEstimator.getEstimateTTFB(),z=Math.abs(S.playbackRate);if(b<=Math.max(K,1e3*(L/(z*2))))return;const Q=H?H.len/z:0,ne=A.loading.first?A.loading.first-A.loading.start:-1,Z=A.loaded&&ne>-1,ie=this.getBwEstimate(),le=c.levels,ee=le[D],ve=Math.max(A.loaded,Math.round(L*(l.bitrate||ee.averageBitrate)/8));let Ee=Z?b-ne:b;Ee<1&&Z&&(Ee=Math.min(b,A.loaded*8/ie));const Ne=Z?A.loaded*1e3/Ee:0,Ce=K/1e3,_e=Ne?(ve-A.loaded)/Ne:ve*8/ie+Ce;if(_e<=Q)return;const xe=Ne?Ne*8:ie,ue=((n=(r==null?void 0:r.details)||this.hls.latestLevelDetails)==null?void 0:n.live)===!0,Re=this.hls.config.abrBandWidthUpFactor;let me=Number.POSITIVE_INFINITY,se;for(se=D-1;se>C;se--){const pe=le[se].maxBitrate,Ke=!le[se].details||ue;if(me=this.getTimeToLoadFrag(Ce,xe,L*pe,Ke),me<Math.min(Q,L+Ce))break}if(me>=_e||me>L*10)return;Z?this.bwEstimator.sample(b-Math.min(K,ne),A.loaded):this.bwEstimator.sampleTTFB(b);const q=le[se].maxBitrate;this.getBwEstimate()*Re>q&&this.resetEstimator(q);const k=this.findBestLevel(q,C,se,0,Q,1,1);k>-1&&(se=k),this.warn(`Fragment ${l.sn}${f?" part "+f.index:""} of level ${D} is loading too slowly;
      Fragment duration: ${l.duration.toFixed(3)}
      Time to underbuffer: ${Q.toFixed(3)} s
      Estimated load time for current fragment: ${_e.toFixed(3)} s
      Estimated load time for down switch fragment: ${me.toFixed(3)} s
      TTFB estimate: ${ne|0} ms
      Current BW estimate: ${Ae(ie)?ie|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${se} @ ${q|0} bps`),c.nextLoadLevel=c.nextAutoLevel=se,this.clearTimer();const Te=()=>{if(this.clearTimer(),this.fragCurrent===l&&this.hls.loadLevel===se&&se>0){const pe=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${se>0?"and switching down":""}
      Fragment duration: ${l.duration.toFixed(3)} s
      Time to underbuffer: ${pe.toFixed(3)} s`),l.abortRequests(),this.fragCurrent=this.partCurrent=null,se>C){let Ke=this.findBestLevel(this.hls.levels[C].bitrate,C,se,0,pe,1,1);Ke===-1&&(Ke=C),this.hls.nextLoadLevel=this.hls.nextAutoLevel=Ke,this.resetEstimator(this.hls.levels[Ke].bitrate)}}};F||_e>me*2?Te():this.timer=self.setInterval(Te,me*1e3),c.trigger(w.FRAG_LOAD_EMERGENCY_ABORTED,{frag:l,part:f,stats:A})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new lp(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.FRAG_LOADING,this.onFragLoading,this),e.on(w.FRAG_LOADED,this.onFragLoaded,this),e.on(w.FRAG_BUFFERED,this.onFragBuffered,this),e.on(w.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(w.LEVEL_LOADED,this.onLevelLoaded,this),e.on(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(w.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(w.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.FRAG_LOADING,this.onFragLoading,this),e.off(w.FRAG_LOADED,this.onFragLoaded,this),e.off(w.FRAG_BUFFERED,this.onFragBuffered,this),e.off(w.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(w.LEVEL_LOADED,this.onLevelLoaded,this),e.off(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(w.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(w.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,r){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,r){const n=r.frag;if(!this.ignoreFragment(n)){if(!n.bitrateTest){var l;this.fragCurrent=n,this.partCurrent=(l=r.part)!=null?l:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,r){this.clearTimer()}onError(e,r){if(!r.fatal)switch(r.details){case re.BUFFER_ADD_CODEC_ERROR:case re.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case re.FRAG_LOAD_TIMEOUT:{const n=r.frag,{fragCurrent:l,partCurrent:f}=this;if(n&&l&&n.sn===l.sn&&n.level===l.level){const c=performance.now(),y=f?f.stats:n.stats,S=c-y.loading.start,T=y.loading.first?y.loading.first-y.loading.start:-1;if(y.loaded&&T>-1){const L=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(S-Math.min(L,T),y.loaded)}else this.bwEstimator.sampleTTFB(S)}break}}}getTimeToLoadFrag(e,r,n,l){const f=e+n/r,c=l?e+this.lastLevelLoadSec:0;return f+c}onLevelLoaded(e,r){const n=this.hls.config,{loading:l}=r.stats,f=l.end-l.first;Ae(f)&&(this.lastLevelLoadSec=f/1e3),r.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(r.levelInfo)}onFragLoaded(e,{frag:r,part:n}){const l=n?n.stats:r.stats;if(r.type===be.MAIN&&this.bwEstimator.sampleTTFB(l.loading.first-l.loading.start),!this.ignoreFragment(r)){if(this.clearTimer(),r.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const f=n?n.duration:r.duration,c=this.hls.levels[r.level],y=(c.loaded?c.loaded.bytes:0)+l.loaded,S=(c.loaded?c.loaded.duration:0)+f;c.loaded={bytes:y,duration:S},c.realBitrate=Math.round(8*y/S)}if(r.bitrateTest){const f={stats:l,frag:r,part:n,id:r.type};this.onFragBuffered(w.FRAG_BUFFERED,f),r.bitrateTest=!1}else this.lastLoadedFragLevel=r.level}}onFragBuffered(e,r){const{frag:n,part:l}=r,f=l!=null&&l.stats.loaded?l.stats:n.stats;if(f.aborted||this.ignoreFragment(n))return;const c=f.parsing.end-f.loading.start-Math.min(f.loading.first-f.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(c,f.loaded),f.bwEstimate=this.getBwEstimate(),n.bitrateTest?this.bitrateTestDelay=c/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==be.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:r}=this.hls,n=this.getBwEstimate(),l=this.hls.config.maxStarvationDelay,f=this.findBestLevel(n,r,e,0,l,1,1);if(f>-1)return f;const c=this.hls.firstLevel,y=Math.min(Math.max(c,r),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${c} clamped to ${y}`),y}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,n=this.bwEstimator.canEstimate(),l=this.lastLoadedFragLevel>-1;if(e!==-1&&(!n||!l||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const f=n&&l?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const c=this.hls.levels;if(c.length>Math.max(e,f)&&c[e].loadError<=c[f].loadError)return e}return this._nextAutoLevel=f,this.nextAutoLevelKey=this.getAutoLevelKey(),f}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:r,hls:n}=this;if(n.levels.length<=1)return n.loadLevel;const{maxAutoLevel:l,config:f,minAutoLevel:c}=n,y=r?r.duration:e?e.duration:0,S=this.getBwEstimate(),T=this.getStarvationDelay();let A=f.abrBandWidthFactor,L=f.abrBandWidthUpFactor;if(T){const F=this.findBestLevel(S,c,l,T,0,A,L);if(F>=0)return this.rebufferNotice=-1,F}let b=y?Math.min(y,f.maxStarvationDelay):f.maxStarvationDelay;if(!T){const F=this.bitrateTestDelay;F&&(b=(y?Math.min(y,f.maxLoadingDelay):f.maxLoadingDelay)-F,this.info(`bitrate test took ${Math.round(1e3*F)}ms, set first fragment max fetchDuration to ${Math.round(1e3*b)} ms`),A=L=1)}const C=this.findBestLevel(S,c,l,T,b,A,L);if(this.rebufferNotice!==C&&(this.rebufferNotice=C,this.info(`${T?"rebuffering expected":"buffer is empty"}, optimal quality level ${C}`)),C>-1)return C;const D=n.levels[c],M=n.loadLevelObj;return M&&(D==null?void 0:D.bitrate)<M.bitrate?c:n.loadLevel}getStarvationDelay(){const e=this.hls,r=e.media;if(!r)return 1/0;const n=r&&r.playbackRate!==0?Math.abs(r.playbackRate):1,l=e.mainForwardBufferInfo;return(l?l.len:0)/n}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,r,n,l,f,c,y){var S;const T=l+f,A=this.lastLoadedFragLevel,L=A===-1?this.hls.firstLevel:A,{fragCurrent:b,partCurrent:C}=this,{levels:D,allAudioTracks:M,loadLevel:F,config:$}=this.hls;if(D.length===1)return 0;const H=D[L],K=!!((S=this.hls.latestLevelDetails)!=null&&S.live),z=F===-1||A===-1;let Q,ne="SDR",Z=(H==null?void 0:H.frameRate)||0;const{audioPreference:ie,videoPreference:le}=$,ee=this.audioTracksByGroup||(this.audioTracksByGroup=Td(M));let ve=-1;if(z){if(this.firstSelection!==-1)return this.firstSelection;const xe=this.codecTiers||(this.codecTiers=Xp(D,ee,r,n)),ue=jp(xe,ne,e,ie,le),{codecSet:Re,videoRanges:me,minFramerate:se,minBitrate:q,minIndex:k,preferHDR:Te}=ue;ve=k,Q=Re,ne=Te?me[me.length-1]:me[0],Z=se,e=Math.max(e,q),this.log(`picked start tier ${ot(ue)}`)}else Q=H==null?void 0:H.codecSet,ne=H==null?void 0:H.videoRange;const Ee=C?C.duration:b?b.duration:0,Ne=this.bwEstimator.getEstimateTTFB()/1e3,Ce=[];for(let xe=n;xe>=r;xe--){var _e;const ue=D[xe],Re=xe>L;if(!ue)continue;if($.useMediaCapabilities&&!ue.supportedResult&&!ue.supportedPromise){const Ke=navigator.mediaCapabilities;typeof(Ke==null?void 0:Ke.decodingInfo)=="function"&&($p(ue,ee,ne,Z,e,ie)||kn(ue.videoCodec))?(ue.supportedPromise=Ed(ue,ee,Ke),ue.supportedPromise.then(et=>{if(!this.hls)return;ue.supportedResult=et;const st=this.hls.levels,lt=st.indexOf(ue);et.error?this.warn(`MediaCapabilities decodingInfo error: "${et.error}" for level ${lt} ${ot(et)}`):et.supported||(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${lt} ${ot(et)}`),lt>-1&&st.length>1&&(this.log(`Removing unsupported level ${lt}`),this.hls.removeLevel(lt),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))})):ue.supportedResult=pd}if((Q&&ue.codecSet!==Q||ne&&ue.videoRange!==ne||Re&&Z>ue.frameRate||!Re&&Z>0&&Z<ue.frameRate||ue.supportedResult&&!((_e=ue.supportedResult.decodingInfoResults)!=null&&_e[0].smooth))&&(!z||xe!==ve)){Ce.push(xe);continue}const me=ue.details,se=(C?me==null?void 0:me.partTarget:me==null?void 0:me.averagetargetduration)||Ee;let q;Re?q=y*e:q=c*e;const k=Ee&&l>=Ee*2&&f===0?ue.averageBitrate:ue.maxBitrate,Te=this.getTimeToLoadFrag(Ne,q,k*se,me===void 0);if(q>=k&&(xe===A||ue.loadError===0&&ue.fragmentError===0)&&(Te<=Ne||!Ae(Te)||K&&!this.bitrateTestDelay||Te<T)){const Ke=this.forcedAutoLevel;return xe!==F&&(Ke===-1||Ke!==F)&&(Ce.length&&this.trace(`Skipped level(s) ${Ce.join(",")} of ${n} max with CODECS and VIDEO-RANGE:"${D[Ce[0]].codecs}" ${D[Ce[0]].videoRange}; not compatible with "${Q}" ${ne}`),this.info(`switch candidate:${L}->${xe} adjustedbw(${Math.round(q)})-bitrate=${Math.round(q-k)} ttfb:${Ne.toFixed(1)} avgDuration:${se.toFixed(1)} maxFetchDuration:${T.toFixed(1)} fetchDuration:${Te.toFixed(1)} firstSelection:${z} codecSet:${ue.codecSet} videoRange:${ue.videoRange} hls.loadLevel:${F}`)),z&&(this.firstSelection=xe),xe}}return-1}set nextAutoLevel(e){const r=this.deriveNextAutoLevel(e);this._nextAutoLevel!==r&&(this.nextAutoLevelKey="",this._nextAutoLevel=r)}deriveNextAutoLevel(e){const{maxAutoLevel:r,minAutoLevel:n}=this.hls;return Math.min(Math.max(e,n),r)}}const Vo={search:function(v,e){let r=0,n=v.length-1,l=null,f=null;for(;r<=n;){l=(r+n)/2|0,f=v[l];const c=e(f);if(c>0)r=l+1;else if(c<0)n=l-1;else return f}return null}};function ey(v,e,r){if(e===null||!Array.isArray(v)||!v.length||!Ae(e))return null;const n=v[0].programDateTime;if(e<(n||0))return null;const l=v[v.length-1].endProgramDateTime;if(e>=(l||0))return null;r=r||0;for(let f=0;f<v.length;++f){const c=v[f];if(ry(e,r,c))return c}return null}function ri(v,e,r=0,n=0,l=.005){let f=null;if(v){f=e[1+v.sn-e[0].sn]||null;const y=v.endDTS-r;y>0&&y<15e-7&&(r+=15e-7),f&&v.level!==f.level&&f.end<=v.end&&(f=e[2+v.sn-e[0].sn]||null)}else r===0&&e[0].start===0&&(f=e[0]);if(f&&((!v||v.level===f.level)&&sf(r,n,f)===0||ty(f,v,Math.min(l,n))))return f;const c=Vo.search(e,sf.bind(null,r,n));return c&&(c!==v||!f)?c:f}function ty(v,e,r){if(e&&e.start===0&&e.level<v.level&&(e.endPTS||0)>0){const n=e.tagList.reduce((l,f)=>(f[0]==="INF"&&(l+=parseFloat(f[1])),l),r);return v.start<=n}return!1}function sf(v=0,e=0,r){if(r.start<=v&&r.start+r.duration>v)return 0;const n=Math.min(e,r.duration+(r.deltaPTS?r.deltaPTS:0));return r.start+r.duration-n<=v?1:r.start-n>v&&r.start?-1:0}function ry(v,e,r){const n=Math.min(e,r.duration+(r.deltaPTS?r.deltaPTS:0))*1e3;return(r.endProgramDateTime||0)-n>v}function Sd(v,e){return Vo.search(v,r=>r.cc<e?1:r.cc>e?-1:0)}function iy(v,e,r){if(v&&v.startCC<=e&&v.endCC>=e){const n=r.start,l=r.end;let f=v.fragments;if(!r.relurl){const{fragmentHint:c}=v;c&&(f=f.concat(c))}return Vo.search(f,c=>c.cc<e||c.end<=n?1:c.cc>e||c.start>=l?-1:0)}return null}function Rn(v){switch(v.details){case re.FRAG_LOAD_TIMEOUT:case re.KEY_LOAD_TIMEOUT:case re.LEVEL_LOAD_TIMEOUT:case re.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function nf(v,e){const r=Rn(e);return v.default[`${r?"timeout":"error"}Retry`]}function Ho(v,e){const r=v.backoff==="linear"?1:Math.pow(2,e);return Math.min(r*v.retryDelayMs,v.maxRetryDelayMs)}function af(v){return Ze(Ze({},v),{errorRetry:null,timeoutRetry:null})}function bn(v,e,r,n){if(!v)return!1;const l=n==null?void 0:n.code,f=e<v.maxNumRetry&&(sy(l)||!!r);return v.shouldRetry?v.shouldRetry(v,e,r,n,f):f}function sy(v){return v===0&&navigator.onLine===!1||!!v&&(v<400||v>499)}var Ft={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},rr={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2};class ny extends Cr{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(w.ERROR,this.onError,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(w.ERROR,this.onError,this),e.off(w.ERROR,this.onErrorOut,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===be.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,r){var n;if(r.fatal)return;const l=this.hls,f=r.context;switch(r.details){case re.FRAG_LOAD_ERROR:case re.FRAG_LOAD_TIMEOUT:case re.KEY_LOAD_ERROR:case re.KEY_LOAD_TIMEOUT:r.errorAction=this.getFragRetryOrSwitchAction(r);return;case re.FRAG_PARSING_ERROR:if((n=r.frag)!=null&&n.gap){r.errorAction=rs();return}case re.FRAG_GAP:case re.FRAG_DECRYPT_ERROR:{r.errorAction=this.getFragRetryOrSwitchAction(r),r.errorAction.action=Ft.SendAlternateToPenaltyBox;return}case re.LEVEL_EMPTY_ERROR:case re.LEVEL_PARSING_ERROR:{var c,y;const T=r.parent===be.MAIN?r.level:l.loadLevel;r.details===re.LEVEL_EMPTY_ERROR&&((c=r.context)!=null&&(y=c.levelDetails)!=null&&y.live)?r.errorAction=this.getPlaylistRetryOrSwitchAction(r,T):(r.levelRetry=!1,r.errorAction=this.getLevelSwitchAction(r,T))}return;case re.LEVEL_LOAD_ERROR:case re.LEVEL_LOAD_TIMEOUT:typeof(f==null?void 0:f.level)=="number"&&(r.errorAction=this.getPlaylistRetryOrSwitchAction(r,f.level));return;case re.AUDIO_TRACK_LOAD_ERROR:case re.AUDIO_TRACK_LOAD_TIMEOUT:case re.SUBTITLE_LOAD_ERROR:case re.SUBTITLE_TRACK_LOAD_TIMEOUT:if(f){const T=l.loadLevelObj;if(T&&(f.type===$e.AUDIO_TRACK&&T.hasAudioGroup(f.groupId)||f.type===$e.SUBTITLE_TRACK&&T.hasSubtitleGroup(f.groupId))){r.errorAction=this.getPlaylistRetryOrSwitchAction(r,l.loadLevel),r.errorAction.action=Ft.SendAlternateToPenaltyBox,r.errorAction.flags=rr.MoveAllAlternatesMatchingHost;return}}return;case re.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const T=l.loadLevelObj,A=T==null?void 0:T.attrs["HDCP-LEVEL"];A?r.errorAction={action:Ft.SendAlternateToPenaltyBox,flags:rr.MoveAllAlternatesMatchingHDCP,hdcpLevel:A}:this.keySystemError(r)}return;case re.BUFFER_ADD_CODEC_ERROR:case re.REMUX_ALLOC_ERROR:case re.BUFFER_APPEND_ERROR:if(!r.errorAction){var S;r.errorAction=this.getLevelSwitchAction(r,(S=r.level)!=null?S:l.loadLevel)}return;case re.INTERNAL_EXCEPTION:case re.BUFFER_APPENDING_ERROR:case re.BUFFER_FULL_ERROR:case re.LEVEL_SWITCH_ERROR:case re.BUFFER_STALLED_ERROR:case re.BUFFER_SEEK_OVER_HOLE:case re.BUFFER_NUDGE_ON_STALL:r.errorAction=rs();return}r.type===De.KEY_SYSTEM_ERROR&&this.keySystemError(r)}keySystemError(e){const r=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,r)}getPlaylistRetryOrSwitchAction(e,r){const n=this.hls,l=nf(n.config.playlistLoadPolicy,e),f=this.playlistError++;if(bn(l,f,Rn(e),e.response))return{action:Ft.RetryRequest,flags:rr.None,retryConfig:l,retryCount:f};const y=this.getLevelSwitchAction(e,r);return l&&(y.retryConfig=l,y.retryCount=f),y}getFragRetryOrSwitchAction(e){const r=this.hls,n=this.getVariantLevelIndex(e.frag),l=r.levels[n],{fragLoadPolicy:f,keyLoadPolicy:c}=r.config,y=nf(e.details.startsWith("key")?c:f,e),S=r.levels.reduce((A,L)=>A+L.fragmentError,0);if(l&&(e.details!==re.FRAG_GAP&&l.fragmentError++,bn(y,S,Rn(e),e.response)))return{action:Ft.RetryRequest,flags:rr.None,retryConfig:y,retryCount:S};const T=this.getLevelSwitchAction(e,n);return y&&(T.retryConfig=y,T.retryCount=S),T}getLevelSwitchAction(e,r){const n=this.hls;r==null&&(r=n.loadLevel);const l=this.hls.levels[r];if(l){var f,c;const T=e.details;l.loadError++,T===re.BUFFER_APPEND_ERROR&&l.fragmentError++;let A=-1;const{levels:L,loadLevel:b,minAutoLevel:C,maxAutoLevel:D}=n;n.autoLevelEnabled||(n.loadLevel=-1);const M=(f=e.frag)==null?void 0:f.type,$=(M===be.AUDIO&&T===re.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(T===re.BUFFER_ADD_CODEC_ERROR||T===re.BUFFER_APPEND_ERROR))&&L.some(({audioCodec:ne})=>l.audioCodec!==ne),K=e.sourceBufferName==="video"&&(T===re.BUFFER_ADD_CODEC_ERROR||T===re.BUFFER_APPEND_ERROR)&&L.some(({codecSet:ne,audioCodec:Z})=>l.codecSet!==ne&&l.audioCodec===Z),{type:z,groupId:Q}=(c=e.context)!=null?c:{};for(let ne=L.length;ne--;){const Z=(ne+b)%L.length;if(Z!==b&&Z>=C&&Z<=D&&L[Z].loadError===0){var y,S;const ie=L[Z];if(T===re.FRAG_GAP&&M===be.MAIN&&e.frag){const le=L[Z].details;if(le){const ee=ri(e.frag,le.fragments,e.frag.start);if(ee!=null&&ee.gap)continue}}else{if(z===$e.AUDIO_TRACK&&ie.hasAudioGroup(Q)||z===$e.SUBTITLE_TRACK&&ie.hasSubtitleGroup(Q))continue;if(M===be.AUDIO&&(y=l.audioGroups)!=null&&y.some(le=>ie.hasAudioGroup(le))||M===be.SUBTITLE&&(S=l.subtitleGroups)!=null&&S.some(le=>ie.hasSubtitleGroup(le))||$&&l.audioCodec===ie.audioCodec||!$&&l.audioCodec!==ie.audioCodec||K&&l.codecSet===ie.codecSet)continue}A=Z;break}}if(A>-1&&n.loadLevel!==A)return e.levelRetry=!0,this.playlistError=0,{action:Ft.SendAlternateToPenaltyBox,flags:rr.None,nextAutoLevel:A}}return{action:Ft.SendAlternateToPenaltyBox,flags:rr.MoveAllAlternatesMatchingHost}}onErrorOut(e,r){var n;switch((n=r.errorAction)==null?void 0:n.action){case Ft.DoNothing:break;case Ft.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(r),!r.errorAction.resolved&&r.details!==re.FRAG_GAP?r.fatal=!0:/MediaSource readyState: ended/.test(r.error.message)&&(this.warn(`MediaSource ended after "${r.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(r.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const r=this.hls,n=e.errorAction;if(!n)return;const{flags:l,hdcpLevel:f,nextAutoLevel:c}=n;switch(l){case rr.None:this.switchLevel(e,c);break;case rr.MoveAllAlternatesMatchingHDCP:f&&(r.maxHdcpLevel=Io[Io.indexOf(f)-1],n.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${r.maxHdcpLevel}" or lower`);break}n.resolved||this.switchLevel(e,c)}switchLevel(e,r){if(r!==void 0&&e.errorAction&&(this.warn(`switching to level ${r} after ${e.details}`),this.hls.nextAutoLevel=r,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===re.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const n=md(e.mimeType),l=this.hls.levels;for(let f=l.length;f--;)l[f][`${e.sourceBufferName}Codec`]===n&&this.hls.removeLevel(f)}}}function rs(v){const e={action:Ft.DoNothing,flags:rr.None};return v&&(e.resolved=!0),e}var Rt={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class ay{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.BUFFER_APPENDED,this.onBufferAppended,this),e.on(w.FRAG_BUFFERED,this.onFragBuffered,this),e.on(w.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.BUFFER_APPENDED,this.onBufferAppended,this),e.off(w.FRAG_BUFFERED,this.onFragBuffered,this),e.off(w.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,r){const n=this.activePartLists[r];if(n)for(let l=n.length;l--;){const f=n[l];if(!f)break;const c=f.end;if(f.start<=e&&c!==null&&e<=c)return f}return this.getBufferedFrag(e,r)}getBufferedFrag(e,r){return this.getFragAtPos(e,r,!0)}getFragAtPos(e,r,n){const{fragments:l}=this,f=Object.keys(l);for(let c=f.length;c--;){const y=l[f[c]];if((y==null?void 0:y.body.type)===r&&(!n||y.buffered)){const S=y.body;if(S.start<=e&&e<=S.end)return S}}return null}detectEvictedFragments(e,r,n,l,f){this.timeRanges&&(this.timeRanges[e]=r);const c=(l==null?void 0:l.fragment.sn)||-1;Object.keys(this.fragments).forEach(y=>{const S=this.fragments[y];if(!S||c>=S.body.sn)return;if(!S.buffered&&(!S.loaded||f)){S.body.type===n&&this.removeFragment(S.body);return}const T=S.range[e];if(T){if(T.time.length===0){this.removeFragment(S.body);return}T.time.some(A=>{const L=!this.isTimeBuffered(A.startPTS,A.endPTS,r);return L&&this.removeFragment(S.body),L})}})}detectPartialFragments(e){const r=this.timeRanges;if(!r||e.frag.sn==="initSegment")return;const n=e.frag,l=Ai(n),f=this.fragments[l];if(!f||f.buffered&&n.gap)return;const c=!n.relurl;Object.keys(r).forEach(y=>{const S=n.elementaryStreams[y];if(!S)return;const T=r[y],A=c||S.partial===!0;f.range[y]=this.getBufferedTimes(n,e.part,A,T)}),f.loaded=null,Object.keys(f.range).length?(f.buffered=!0,(f.body.endList=n.endList||f.body.endList)&&(this.endListFragments[f.body.type]=f),tn(f)||this.removeParts(n.sn-1,n.type)):this.removeFragment(f.body)}removeParts(e,r){const n=this.activePartLists[r];n&&(this.activePartLists[r]=n.filter(l=>l.fragment.sn>=e))}fragBuffered(e,r){const n=Ai(e);let l=this.fragments[n];!l&&r&&(l=this.fragments[n]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),l&&(l.loaded=null,l.buffered=!0)}getBufferedTimes(e,r,n,l){const f={time:[],partial:n},c=e.start,y=e.end,S=e.minEndPTS||y,T=e.maxStartPTS||c;for(let A=0;A<l.length;A++){const L=l.start(A)-this.bufferPadding,b=l.end(A)+this.bufferPadding;if(T>=L&&S<=b){f.time.push({startPTS:Math.max(c,l.start(A)),endPTS:Math.min(y,l.end(A))});break}else if(c<b&&y>L){const C=Math.max(c,l.start(A)),D=Math.min(y,l.end(A));D>C&&(f.partial=!0,f.time.push({startPTS:C,endPTS:D}))}else if(y<=L)break}return f}getPartialFragment(e){let r=null,n,l,f,c=0;const{bufferPadding:y,fragments:S}=this;return Object.keys(S).forEach(T=>{const A=S[T];A&&tn(A)&&(l=A.body.start-y,f=A.body.end+y,e>=l&&e<=f&&(n=Math.min(e-l,f-e),c<=n&&(r=A.body,c=n)))}),r}isEndListAppended(e){const r=this.endListFragments[e];return r!==void 0&&(r.buffered||tn(r))}getState(e){const r=Ai(e),n=this.fragments[r];return n?n.buffered?tn(n)?Rt.PARTIAL:Rt.OK:Rt.APPENDING:Rt.NOT_LOADED}isTimeBuffered(e,r,n){let l,f;for(let c=0;c<n.length;c++){if(l=n.start(c)-this.bufferPadding,f=n.end(c)+this.bufferPadding,e>=l&&r<=f)return!0;if(r<=l)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,r){if(r.frag.sn==="initSegment"||r.frag.bitrateTest)return;const n=r.frag,l=r.part?null:r,f=Ai(n);this.fragments[f]={body:n,appendedPTS:null,loaded:l,buffered:!1,range:Object.create(null)}}onBufferAppended(e,r){const{frag:n,part:l,timeRanges:f,type:c}=r;if(n.sn==="initSegment")return;const y=n.type;if(l){let T=this.activePartLists[y];T||(this.activePartLists[y]=T=[]),T.push(l)}this.timeRanges=f;const S=f[c];this.detectEvictedFragments(c,S,y,l)}onFragBuffered(e,r){this.detectPartialFragments(r)}hasFragment(e){const r=Ai(e);return!!this.fragments[r]}hasFragments(e){const{fragments:r}=this,n=Object.keys(r);if(!e)return n.length>0;for(let l=n.length;l--;){const f=r[n[l]];if((f==null?void 0:f.body.type)===e)return!0}return!1}hasParts(e){var r;return!!((r=this.activePartLists[e])!=null&&r.length)}removeFragmentsInRange(e,r,n,l,f){l&&!this.hasGaps||Object.keys(this.fragments).forEach(c=>{const y=this.fragments[c];if(!y)return;const S=y.body;S.type!==n||l&&!S.gap||S.start<r&&S.end>e&&(y.buffered||f)&&this.removeFragment(S)})}removeFragment(e){const r=Ai(e);e.clearElementaryStreamInfo();const n=this.activePartLists[e.type];if(n){const l=e.sn;this.activePartLists[e.type]=n.filter(f=>f.fragment.sn!==l)}delete this.fragments[r],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e,r;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const n=(e=this.hls)==null||(r=e.latestLevelDetails)==null?void 0:r.partList;n&&n.forEach(l=>l.clearElementaryStreamInfo())}}function tn(v){var e,r,n;return v.buffered&&(v.body.gap||((e=v.range.video)==null?void 0:e.partial)||((r=v.range.audio)==null?void 0:r.partial)||((n=v.range.audiovideo)==null?void 0:n.partial))}function Ai(v){return`${v.type}_${v.level}_${v.sn}`}var Vr={cbc:0,ctr:1};class oy{constructor(e,r,n){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=r,this.aesMode=n}decrypt(e,r){switch(this.aesMode){case Vr.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},r,e);case Vr.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},r,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function ly(v){const e=v.byteLength,r=e&&new DataView(v.buffer).getUint8(e-1);return r?v.slice(0,e-r):v}class uy{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const r=new DataView(e),n=new Uint32Array(4);for(let l=0;l<4;l++)n[l]=r.getUint32(l*4);return n}initTable(){const e=this.sBox,r=this.invSBox,n=this.subMix,l=n[0],f=n[1],c=n[2],y=n[3],S=this.invSubMix,T=S[0],A=S[1],L=S[2],b=S[3],C=new Uint32Array(256);let D=0,M=0,F=0;for(F=0;F<256;F++)F<128?C[F]=F<<1:C[F]=F<<1^283;for(F=0;F<256;F++){let $=M^M<<1^M<<2^M<<3^M<<4;$=$>>>8^$&255^99,e[D]=$,r[$]=D;const H=C[D],K=C[H],z=C[K];let Q=C[$]*257^$*16843008;l[D]=Q<<24|Q>>>8,f[D]=Q<<16|Q>>>16,c[D]=Q<<8|Q>>>24,y[D]=Q,Q=z*16843009^K*65537^H*257^D*16843008,T[$]=Q<<24|Q>>>8,A[$]=Q<<16|Q>>>16,L[$]=Q<<8|Q>>>24,b[$]=Q,D?(D=H^C[C[C[z^H]]],M^=C[C[M]]):D=M=1}}expandKey(e){const r=this.uint8ArrayToUint32Array_(e);let n=!0,l=0;for(;l<r.length&&n;)n=r[l]===this.key[l],l++;if(n)return;this.key=r;const f=this.keySize=r.length;if(f!==4&&f!==6&&f!==8)throw new Error("Invalid aes key size="+f);const c=this.ksRows=(f+6+1)*4;let y,S;const T=this.keySchedule=new Uint32Array(c),A=this.invKeySchedule=new Uint32Array(c),L=this.sBox,b=this.rcon,C=this.invSubMix,D=C[0],M=C[1],F=C[2],$=C[3];let H,K;for(y=0;y<c;y++){if(y<f){H=T[y]=r[y];continue}K=H,y%f===0?(K=K<<8|K>>>24,K=L[K>>>24]<<24|L[K>>>16&255]<<16|L[K>>>8&255]<<8|L[K&255],K^=b[y/f|0]<<24):f>6&&y%f===4&&(K=L[K>>>24]<<24|L[K>>>16&255]<<16|L[K>>>8&255]<<8|L[K&255]),T[y]=H=(T[y-f]^K)>>>0}for(S=0;S<c;S++)y=c-S,S&3?K=T[y]:K=T[y-4],S<4||y<=4?A[S]=K:A[S]=D[L[K>>>24]]^M[L[K>>>16&255]]^F[L[K>>>8&255]]^$[L[K&255]],A[S]=A[S]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,r,n){const l=this.keySize+6,f=this.invKeySchedule,c=this.invSBox,y=this.invSubMix,S=y[0],T=y[1],A=y[2],L=y[3],b=this.uint8ArrayToUint32Array_(n);let C=b[0],D=b[1],M=b[2],F=b[3];const $=new Int32Array(e),H=new Int32Array($.length);let K,z,Q,ne,Z,ie,le,ee,ve,Ee,Ne,Ce,_e,xe;const ue=this.networkToHostOrderSwap;for(;r<$.length;){for(ve=ue($[r]),Ee=ue($[r+1]),Ne=ue($[r+2]),Ce=ue($[r+3]),Z=ve^f[0],ie=Ce^f[1],le=Ne^f[2],ee=Ee^f[3],_e=4,xe=1;xe<l;xe++)K=S[Z>>>24]^T[ie>>16&255]^A[le>>8&255]^L[ee&255]^f[_e],z=S[ie>>>24]^T[le>>16&255]^A[ee>>8&255]^L[Z&255]^f[_e+1],Q=S[le>>>24]^T[ee>>16&255]^A[Z>>8&255]^L[ie&255]^f[_e+2],ne=S[ee>>>24]^T[Z>>16&255]^A[ie>>8&255]^L[le&255]^f[_e+3],Z=K,ie=z,le=Q,ee=ne,_e=_e+4;K=c[Z>>>24]<<24^c[ie>>16&255]<<16^c[le>>8&255]<<8^c[ee&255]^f[_e],z=c[ie>>>24]<<24^c[le>>16&255]<<16^c[ee>>8&255]<<8^c[Z&255]^f[_e+1],Q=c[le>>>24]<<24^c[ee>>16&255]<<16^c[Z>>8&255]<<8^c[ie&255]^f[_e+2],ne=c[ee>>>24]<<24^c[Z>>16&255]<<16^c[ie>>8&255]<<8^c[le&255]^f[_e+3],H[r]=ue(K^C),H[r+1]=ue(ne^D),H[r+2]=ue(Q^M),H[r+3]=ue(z^F),C=ve,D=Ee,M=Ne,F=Ce,r=r+4}return H.buffer}}class hy{constructor(e,r,n){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=r,this.aesMode=n}expandKey(){const e=fy(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function fy(v){switch(v){case Vr.cbc:return"AES-CBC";case Vr.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${v}`)}}const dy=16;class Yo{constructor(e,{removePKCS7Padding:r=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=r,r)try{const n=self.crypto;n&&(this.subtle=n.subtle||n.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:r}=this;if(!e||r)return this.reset(),null;const n=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?ly(n):n}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,r,n,l){return this.useSoftware?new Promise((f,c)=>{const y=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(y,r,n,l);const S=this.flush();S?f(S.buffer):c(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),r,n,l)}softwareDecrypt(e,r,n,l){const{currentIV:f,currentResult:c,remainderData:y}=this;if(l!==Vr.cbc||r.byteLength!==16)return qe.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),y&&(e=Qt(y,e),this.remainderData=null);const S=this.getValidChunk(e);if(!S.length)return null;f&&(n=f);let T=this.softwareDecrypter;T||(T=this.softwareDecrypter=new uy),T.expandKey(r);const A=c;return this.currentResult=T.decrypt(S.buffer,0,n),this.currentIV=S.slice(-16).buffer,A||null}webCryptoDecrypt(e,r,n,l){if(this.key!==r||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,r,n,l));this.key=r,this.fastAesKey=new hy(this.subtle,r,l)}return this.fastAesKey.expandKey().then(f=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new oy(this.subtle,new Uint8Array(n),l).decrypt(e.buffer,f)):Promise.reject(new Error("web crypto not initialized"))).catch(f=>(qe.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${f.name}: ${f.message}`),this.onWebCryptoError(e,r,n,l)))}onWebCryptoError(e,r,n,l){const f=this.enableSoftwareAES;if(f){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,r,n,l);const c=this.flush();if(c)return c.buffer}throw new Error("WebCrypto"+(f?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let r=e;const n=e.length-e.length%dy;return n!==e.length&&(r=e.slice(0,n),this.remainderData=e.slice(n)),r}logOnce(e){this.logEnabled&&(qe.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const of=Math.pow(2,17);class cy{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,r){const n=e.url;if(!n)return Promise.reject(new br({type:De.NETWORK_ERROR,details:re.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${n?"part list":"url"}`),networkDetails:null}));this.abort();const l=this.config,f=l.fLoader,c=l.loader;return new Promise((y,S)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(D=>D[0]==="GAP")){S(uf(e));return}else e.gap=!1;const T=this.loader=f?new f(l):new c(l),A=lf(e);e.loader=T;const L=af(l.fragLoadPolicy.default),b={loadPolicy:L,timeout:L.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:of};e.stats=T.stats;const C={onSuccess:(D,M,F,$)=>{this.resetLoader(e,T);let H=D.data;F.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(H.slice(0,16)),H=H.slice(16)),y({frag:e,part:null,payload:H,networkDetails:$})},onError:(D,M,F,$)=>{this.resetLoader(e,T),S(new br({type:De.NETWORK_ERROR,details:re.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:Ze({url:n,data:void 0},D),error:new Error(`HTTP Error ${D.code} ${D.text}`),networkDetails:F,stats:$}))},onAbort:(D,M,F)=>{this.resetLoader(e,T),S(new br({type:De.NETWORK_ERROR,details:re.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:F,stats:D}))},onTimeout:(D,M,F)=>{this.resetLoader(e,T),S(new br({type:De.NETWORK_ERROR,details:re.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${b.timeout}ms`),networkDetails:F,stats:D}))}};r&&(C.onProgress=(D,M,F,$)=>r({frag:e,part:null,payload:F,networkDetails:$})),T.load(A,b,C)})}loadPart(e,r,n){this.abort();const l=this.config,f=l.fLoader,c=l.loader;return new Promise((y,S)=>{if(this.loader&&this.loader.destroy(),e.gap||r.gap){S(uf(e,r));return}const T=this.loader=f?new f(l):new c(l),A=lf(e,r);e.loader=T;const L=af(l.fragLoadPolicy.default),b={loadPolicy:L,timeout:L.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:of};r.stats=T.stats,T.load(A,b,{onSuccess:(C,D,M,F)=>{this.resetLoader(e,T),this.updateStatsFromPart(e,r);const $={frag:e,part:r,payload:C.data,networkDetails:F};n($),y($)},onError:(C,D,M,F)=>{this.resetLoader(e,T),S(new br({type:De.NETWORK_ERROR,details:re.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:r,response:Ze({url:A.url,data:void 0},C),error:new Error(`HTTP Error ${C.code} ${C.text}`),networkDetails:M,stats:F}))},onAbort:(C,D,M)=>{e.stats.aborted=r.stats.aborted,this.resetLoader(e,T),S(new br({type:De.NETWORK_ERROR,details:re.INTERNAL_ABORTED,fatal:!1,frag:e,part:r,error:new Error("Aborted"),networkDetails:M,stats:C}))},onTimeout:(C,D,M)=>{this.resetLoader(e,T),S(new br({type:De.NETWORK_ERROR,details:re.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:r,error:new Error(`Timeout after ${b.timeout}ms`),networkDetails:M,stats:C}))}})})}updateStatsFromPart(e,r){const n=e.stats,l=r.stats,f=l.total;if(n.loaded+=l.loaded,f){const S=Math.round(e.duration/r.duration),T=Math.min(Math.round(n.loaded/f),S),L=(S-T)*Math.round(n.loaded/T);n.total=n.loaded+L}else n.total=Math.max(n.loaded,n.total);const c=n.loading,y=l.loading;c.start?c.first+=y.first-y.start:(c.start=y.start,c.first=y.first),c.end=y.end}resetLoader(e,r){e.loader=null,this.loader===r&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),r.destroy()}}function lf(v,e=null){const r=e||v,n={frag:v,part:e,responseType:"arraybuffer",url:r.url,headers:{},rangeStart:0,rangeEnd:0},l=r.byteRangeStartOffset,f=r.byteRangeEndOffset;if(Ae(l)&&Ae(f)){var c;let y=l,S=f;if(v.sn==="initSegment"&&gy((c=v.decryptdata)==null?void 0:c.method)){const T=f-l;T%16&&(S=f+(16-T%16)),l!==0&&(n.resetIV=!0,y=l-16)}n.rangeStart=y,n.rangeEnd=S}return n}function uf(v,e){const r=new Error(`GAP ${v.gap?"tag":"attribute"} found`),n={type:De.MEDIA_ERROR,details:re.FRAG_GAP,fatal:!1,frag:v,error:r,networkDetails:null};return e&&(n.part=e),(e||v).stats.aborted=!0,new br(n)}function gy(v){return v==="AES-128"||v==="AES-256"}class br extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Ad extends Cr{constructor(e,r){super(e,r),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Wo{constructor(e,r,n,l=0,f=-1,c=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=rn(),this.buffering={audio:rn(),video:rn(),audiovideo:rn()},this.level=e,this.sn=r,this.id=n,this.size=l,this.part=f,this.partial=c}}function rn(){return{start:0,executeStart:0,executeEnd:0,end:0}}const hf={length:0,start:()=>0,end:()=>0};class Be{static isBuffered(e,r){if(e){const n=Be.getBuffered(e);for(let l=n.length;l--;)if(r>=n.start(l)&&r<=n.end(l))return!0}return!1}static bufferedRanges(e){if(e){const r=Be.getBuffered(e);return Be.timeRangesToArray(r)}return[]}static timeRangesToArray(e){const r=[];for(let n=0;n<e.length;n++)r.push({start:e.start(n),end:e.end(n)});return r}static bufferInfo(e,r,n){if(e){const l=Be.bufferedRanges(e);if(l.length)return Be.bufferedInfo(l,r,n)}return{len:0,start:r,end:r,bufferedIndex:-1}}static bufferedInfo(e,r,n){r=Math.max(0,r),e.length>1&&e.sort((A,L)=>A.start-L.start||L.end-A.end);let l=-1,f=[];if(n)for(let A=0;A<e.length;A++){r>=e[A].start&&r<=e[A].end&&(l=A);const L=f.length;if(L){const b=f[L-1].end;e[A].start-b<n?e[A].end>b&&(f[L-1].end=e[A].end):f.push(e[A])}else f.push(e[A])}else f=e;let c=0,y,S=r,T=r;for(let A=0;A<f.length;A++){const L=f[A].start,b=f[A].end;if(l===-1&&r>=L&&r<=b&&(l=A),r+n>=L&&r<b)S=L,T=b,c=T-r;else if(r+n<L){y=L;break}}return{len:c,start:S||0,end:T||0,nextStart:y,buffered:e,bufferedIndex:l}}static getBuffered(e){try{return e.buffered||hf}catch(r){return qe.log("failed to get media.buffered",r),hf}}}const xd=/\{\$([a-zA-Z0-9-_]+)\}/g;function ff(v){return xd.test(v)}function Ro(v,e){if(v.variableList!==null||v.hasVariableRefs){const r=v.variableList;return e.replace(xd,n=>{const l=n.substring(2,n.length-1),f=r==null?void 0:r[l];return f===void 0?(v.playlistParsingError||(v.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${l}"`)),n):f})}return e}function df(v,e,r){let n=v.variableList;n||(v.variableList=n={});let l,f;if("QUERYPARAM"in e){l=e.QUERYPARAM;try{const c=new self.URL(r).searchParams;if(c.has(l))f=c.get(l);else throw new Error(`"${l}" does not match any query parameter in URI: "${r}"`)}catch(c){v.playlistParsingError||(v.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${c.message}`))}}else l=e.NAME,f=e.VALUE;l in n?v.playlistParsingError||(v.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${l}"`)):n[l]=f||""}function vy(v,e,r){const n=e.IMPORT;if(r&&n in r){let l=v.variableList;l||(v.variableList=l={}),l[n]=r[n]}else v.playlistParsingError||(v.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${n}"`))}const my=/^(\d+)x(\d+)$/,cf=/(.+?)=(".*?"|.*?)(?:,|$)/g;class ft{constructor(e,r){typeof e=="string"&&(e=ft.parseAttrList(e,r)),rt(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const r=parseInt(this[e],10);return r>Number.MAX_SAFE_INTEGER?1/0:r}hexadecimalInteger(e){if(this[e]){let r=(this[e]||"0x").slice(2);r=(r.length&1?"0":"")+r;const n=new Uint8Array(r.length/2);for(let l=0;l<r.length/2;l++)n[l]=parseInt(r.slice(l*2,l*2+2),16);return n}return null}hexadecimalIntegerAsNumber(e){const r=parseInt(this[e],16);return r>Number.MAX_SAFE_INTEGER?1/0:r}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,r){const n=this[e];return n?parseFloat(n):r}enumeratedString(e){return this[e]}enumeratedStringList(e,r){const n=this[e];return(n?n.split(/[ ,]+/):[]).reduce((l,f)=>(l[f.toLowerCase()]=!0,l),r)}bool(e){return this[e]==="YES"}decimalResolution(e){const r=my.exec(this[e]);if(r!==null)return{width:parseInt(r[1],10),height:parseInt(r[2],10)}}static parseAttrList(e,r){let n;const l={},f='"';for(cf.lastIndex=0;(n=cf.exec(e))!==null;){const c=n[1].trim();let y=n[2];const S=y.indexOf(f)===0&&y.lastIndexOf(f)===y.length-1;let T=!1;if(S)y=y.slice(1,-1);else switch(c){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":T=!0}if(r&&(S||T))y=Ro(r,y);else if(!T&&!S)switch(c){case"CLOSED-CAPTIONS":if(y==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":qe.warn(`${e}: attribute ${c} is missing quotes`)}l[c]=y}return l}}const py="com.apple.hls.interstitial";function yy(v){return v!=="ID"&&v!=="CLASS"&&v!=="CUE"&&v!=="START-DATE"&&v!=="DURATION"&&v!=="END-DATE"&&v!=="END-ON-NEXT"}function Ey(v){return v==="SCTE35-OUT"||v==="SCTE35-IN"||v==="SCTE35-CMD"}class Ld{constructor(e,r,n=0){var l;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(r==null?void 0:r.tagAnchor)||null,this.tagOrder=(l=r==null?void 0:r.tagOrder)!=null?l:n,r){const f=r.attr;for(const c in f)if(Object.prototype.hasOwnProperty.call(e,c)&&e[c]!==f[c]){qe.warn(`DATERANGE tag attribute: "${c}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=c;break}e=rt(new ft({}),f,e)}if(this.attr=e,r?(this._startDate=r._startDate,this._cue=r._cue,this._endDate=r._endDate,this._dateAtEnd=r._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const f=(r==null?void 0:r.endDate)||new Date(this.attr["END-DATE"]);Ae(f.getTime())&&(this._endDate=f)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(qe.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const r=this.duration;return r!==null?this._dateAtEnd=new Date(this._startDate.getTime()+r*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(Ae(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===py}get isValid(){return!!this.id&&!this._badValueForSameId&&Ae(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const Ty=10;class Sy{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const r=this.lastPartSn-e.lastPartSn,n=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!n||!!r||!this.live,this.advanced=this.endSN>e.endSN||r>0||r===0&&n>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}get hasProgramDateTime(){return this.fragments.length?Ae(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Ty}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const r=this.lastPartIndex;if(r!==-1){for(let n=e.length;n--;)if(e[n].index>r)return e[n].index;return r}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function Ri(v){return v==="AES-128"||v==="AES-256"||v==="AES-256-CTR"}function qo(v){switch(v){case"AES-128":case"AES-256":return Vr.cbc;case"AES-256-CTR":return Vr.ctr;default:throw new Error(`invalid full segment method ${v}`)}}function jo(v){return Uint8Array.from(atob(v),e=>e.charCodeAt(0))}function bo(v){return Uint8Array.from(unescape(encodeURIComponent(v)),e=>e.charCodeAt(0))}function Ay(v){const e=bo(v).subarray(0,16),r=new Uint8Array(16);return r.set(e,16-e.length),r}function xy(v){const e=function(n,l,f){const c=n[l];n[l]=n[f],n[f]=c};e(v,0,3),e(v,1,2),e(v,4,5),e(v,6,7)}function Ly(v){const e=v.split(":");let r=null;if(e[0]==="data"&&e.length===2){const n=e[1].split(";"),l=n[n.length-1].split(",");if(l.length===2){const f=l[0]==="base64",c=l[1];f?(n.splice(-1,1),r=jo(c)):r=Ay(c)}}return r}const _n=typeof self<"u"?self:void 0;var Je={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},$t={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function ro(v){switch(v){case $t.FAIRPLAY:return Je.FAIRPLAY;case $t.PLAYREADY:return Je.PLAYREADY;case $t.WIDEVINE:return Je.WIDEVINE;case $t.CLEARKEY:return Je.CLEARKEY}}var sn={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function io(v){if(v===sn.WIDEVINE)return Je.WIDEVINE;if(v===sn.PLAYREADY)return Je.PLAYREADY;if(v===sn.CENC||v===sn.CLEARKEY)return Je.CLEARKEY}function so(v){switch(v){case Je.FAIRPLAY:return $t.FAIRPLAY;case Je.PLAYREADY:return $t.PLAYREADY;case Je.WIDEVINE:return $t.WIDEVINE;case Je.CLEARKEY:return $t.CLEARKEY}}function nn(v){const{drmSystems:e,widevineLicenseUrl:r}=v,n=e?[Je.FAIRPLAY,Je.WIDEVINE,Je.PLAYREADY,Je.CLEARKEY].filter(l=>!!e[l]):[];return!n[Je.WIDEVINE]&&r&&n.push(Je.WIDEVINE),n}const Id=function(v){return _n!=null&&(v=_n.navigator)!=null&&v.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function Iy(v,e,r,n){let l;switch(v){case Je.FAIRPLAY:l=["cenc","sinf"];break;case Je.WIDEVINE:case Je.PLAYREADY:l=["cenc"];break;case Je.CLEARKEY:l=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${v}`)}return Ry(l,e,r,n)}function Ry(v,e,r,n){return[{initDataTypes:v,persistentState:n.persistentState||"optional",distinctiveIdentifier:n.distinctiveIdentifier||"optional",sessionTypes:n.sessionTypes||[n.sessionType||"temporary"],audioCapabilities:e.map(f=>({contentType:`audio/mp4; codecs=${f}`,robustness:n.audioRobustness||"",encryptionScheme:n.audioEncryptionScheme||null})),videoCapabilities:r.map(f=>({contentType:`video/mp4; codecs=${f}`,robustness:n.videoRobustness||"",encryptionScheme:n.videoEncryptionScheme||null}))}]}function Rd(v){const e=new Uint16Array(v.buffer,v.byteOffset,v.byteLength/2),r=String.fromCharCode.apply(null,Array.from(e)),n=r.substring(r.indexOf("<"),r.length),c=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("KID")[0];if(c){const y=c.childNodes[0]?c.childNodes[0].nodeValue:c.getAttribute("VALUE");if(y){const S=jo(y).subarray(0,16);return xy(S),S}}return null}let an={};class is{static clearKeyUriToKeyIdMap(){an={}}constructor(e,r,n,l=[1],f=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=r,this.keyFormat=n,this.keyFormatVersions=l,this.iv=f,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!Ri(e)}isSupported(){if(this.method){if(Ri(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case $t.FAIRPLAY:case $t.WIDEVINE:case $t.PLAYREADY:case $t.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(Ri(this.method)&&this.uri&&!this.iv){typeof e!="number"&&(qe.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const n=by(e);return new is(this.method,this.uri,"identity",this.keyFormatVersions,n)}const r=Ly(this.uri);if(r)switch(this.keyFormat){case $t.WIDEVINE:this.pssh=r,r.length>=22&&(this.keyId=r.subarray(r.length-22,r.length-6));break;case $t.PLAYREADY:{const n=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=wp(n,null,r),this.keyId=Rd(r);break}default:{let n=r.subarray(0,16);if(n.length!==16){const l=new Uint8Array(16);l.set(n,16-n.length),n=l}this.keyId=n;break}}if(!this.keyId||this.keyId.byteLength!==16){let n=an[this.uri];if(!n){const l=Object.keys(an).length%Number.MAX_SAFE_INTEGER;n=new Uint8Array(16),new DataView(n.buffer,12,4).setUint32(0,l),an[this.uri]=n}this.keyId=n}return this}}function by(v){const e=new Uint8Array(16);for(let r=12;r<16;r++)e[r]=v>>8*(15-r)&255;return e}const gf=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,vf=/#EXT-X-MEDIA:(.*)/g,_y=/^#EXT(?:INF|-X-TARGETDURATION):/m,no=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),Dy=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class pr{static findGroup(e,r){for(let n=0;n<e.length;n++){const l=e[n];if(l.id===r)return l}}static resolve(e,r){return Go.buildAbsoluteURL(r,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return _y.test(e)}static parseMasterPlaylist(e,r){const n=ff(e),l={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:n},f=[];gf.lastIndex=0;let c;for(;(c=gf.exec(e))!=null;)if(c[1]){var y;const T=new ft(c[1],l),A=Ro(l,c[2]),L={attrs:T,bitrate:T.decimalInteger("BANDWIDTH")||T.decimalInteger("AVERAGE-BANDWIDTH"),name:T.NAME,url:pr.resolve(A,r)},b=T.decimalResolution("RESOLUTION");b&&(L.width=b.width,L.height=b.height),yf(T.CODECS,L);const C=T["SUPPLEMENTAL-CODECS"];C&&(L.supplemental={},yf(C,L.supplemental)),(y=L.unknownCodecs)!=null&&y.length||f.push(L),l.levels.push(L)}else if(c[3]){const T=c[3],A=c[4];switch(T){case"SESSION-DATA":{const L=new ft(A,l),b=L["DATA-ID"];b&&(l.sessionData===null&&(l.sessionData={}),l.sessionData[b]=L);break}case"SESSION-KEY":{const L=mf(A,r,l);L.encrypted&&L.isSupported()?(l.sessionKeys===null&&(l.sessionKeys=[]),l.sessionKeys.push(L)):qe.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${A}"`);break}case"DEFINE":{{const L=new ft(A,l);df(l,L,r)}break}case"CONTENT-STEERING":{const L=new ft(A,l);l.contentSteering={uri:pr.resolve(L["SERVER-URI"],r),pathwayId:L["PATHWAY-ID"]||"."};break}case"START":{l.startTimeOffset=pf(A);break}}}const S=f.length>0&&f.length<l.levels.length;return l.levels=S?f:l.levels,l.levels.length===0&&(l.playlistParsingError=new Error("no levels found in manifest")),l}static parseMasterPlaylistMedia(e,r,n){let l;const f={},c=n.levels,y={AUDIO:c.map(T=>({id:T.attrs.AUDIO,audioCodec:T.audioCodec})),SUBTITLES:c.map(T=>({id:T.attrs.SUBTITLES,textCodec:T.textCodec})),"CLOSED-CAPTIONS":[]};let S=0;for(vf.lastIndex=0;(l=vf.exec(e))!==null;){const T=new ft(l[1],n),A=T.TYPE;if(A){const L=y[A],b=f[A]||[];f[A]=b;const C=T.LANGUAGE,D=T["ASSOC-LANGUAGE"],M=T.CHANNELS,F=T.CHARACTERISTICS,$=T["INSTREAM-ID"],H={attrs:T,bitrate:0,id:S++,groupId:T["GROUP-ID"]||"",name:T.NAME||C||"",type:A,default:T.bool("DEFAULT"),autoselect:T.bool("AUTOSELECT"),forced:T.bool("FORCED"),lang:C,url:T.URI?pr.resolve(T.URI,r):""};if(D&&(H.assocLang=D),M&&(H.channels=M),F&&(H.characteristics=F),$&&(H.instreamId=$),L!=null&&L.length){const K=pr.findGroup(L,H.groupId)||L[0];Ef(H,K,"audioCodec"),Ef(H,K,"textCodec")}b.push(H)}}return f}static parseLevelPlaylist(e,r,n,l,f,c){var y;const S={url:r},T=new Sy(r),A=T.fragments,L=[];let b=null,C=0,D=0,M=0,F=0,$=0,H=null,K=new Za(l,S),z,Q,ne,Z=-1,ie=!1,le=null,ee;if(no.lastIndex=0,T.m3u8=e,T.hasVariableRefs=ff(e),((y=no.exec(e))==null?void 0:y[0])!=="#EXTM3U")return T.playlistParsingError=new Error("Missing format identifier #EXTM3U"),T;for(;(z=no.exec(e))!==null;){ie&&(ie=!1,K=new Za(l,S),K.playlistOffset=M,K.start=M,K.sn=C,K.cc=F,$&&(K.bitrate=$),K.level=n,b&&(K.initSegment=b,b.rawProgramDateTime&&(K.rawProgramDateTime=b.rawProgramDateTime,b.rawProgramDateTime=null),le&&(K.setByteRange(le),le=null)));const Ce=z[1];if(Ce){K.duration=parseFloat(Ce);const _e=(" "+z[2]).slice(1);K.title=_e||null,K.tagList.push(_e?["INF",Ce,_e]:["INF",Ce])}else if(z[3]){if(Ae(K.duration)){K.playlistOffset=M,K.start=M,ne&&Sf(K,ne,T),K.sn=C,K.level=n,K.cc=F,A.push(K);const _e=(" "+z[3]).slice(1);K.relurl=Ro(T,_e),_o(K,H,L),H=K,M+=K.duration,C++,D=0,ie=!0}}else{if(z=z[0].match(Dy),!z){qe.warn("No matches on slow regex match for level playlist!");continue}for(Q=1;Q<z.length&&z[Q]===void 0;Q++);const _e=(" "+z[Q]).slice(1),xe=(" "+z[Q+1]).slice(1),ue=z[Q+2]?(" "+z[Q+2]).slice(1):null;switch(_e){case"BYTERANGE":H?K.setByteRange(xe,H):K.setByteRange(xe);break;case"PROGRAM-DATE-TIME":K.rawProgramDateTime=xe,K.tagList.push(["PROGRAM-DATE-TIME",xe]),Z===-1&&(Z=A.length);break;case"PLAYLIST-TYPE":T.type&&Ir(T,_e,z),T.type=xe.toUpperCase();break;case"MEDIA-SEQUENCE":T.startSN!==0?Ir(T,_e,z):A.length>0&&Af(T,_e,z),C=T.startSN=parseInt(xe);break;case"SKIP":{T.skippedSegments&&Ir(T,_e,z);const Re=new ft(xe,T),me=Re.decimalInteger("SKIPPED-SEGMENTS");if(Ae(me)){T.skippedSegments+=me;for(let q=me;q--;)A.push(null);C+=me}const se=Re.enumeratedString("RECENTLY-REMOVED-DATERANGES");se&&(T.recentlyRemovedDateranges=(T.recentlyRemovedDateranges||[]).concat(se.split("	")));break}case"TARGETDURATION":T.targetduration!==0&&Ir(T,_e,z),T.targetduration=Math.max(parseInt(xe),1);break;case"VERSION":T.version!==null&&Ir(T,_e,z),T.version=parseInt(xe);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":T.live||Ir(T,_e,z),T.live=!1;break;case"#":(xe||ue)&&K.tagList.push(ue?[xe,ue]:[xe]);break;case"DISCONTINUITY":F++,K.tagList.push(["DIS"]);break;case"GAP":K.gap=!0,K.tagList.push([_e]);break;case"BITRATE":K.tagList.push([_e,xe]),$=parseInt(xe)*1e3,Ae($)?K.bitrate=$:$=0;break;case"DATERANGE":{const Re=new ft(xe,T),me=new Ld(Re,T.dateRanges[Re.ID],T.dateRangeTagCount);T.dateRangeTagCount++,me.isValid||T.skippedSegments?T.dateRanges[me.id]=me:qe.warn(`Ignoring invalid DATERANGE tag: "${xe}"`),K.tagList.push(["EXT-X-DATERANGE",xe]);break}case"DEFINE":{{const Re=new ft(xe,T);"IMPORT"in Re?vy(T,Re,c):df(T,Re,r)}break}case"DISCONTINUITY-SEQUENCE":T.startCC!==0?Ir(T,_e,z):A.length>0&&Af(T,_e,z),T.startCC=F=parseInt(xe);break;case"KEY":{const Re=mf(xe,r,T);if(Re.isSupported()){if(Re.method==="NONE"){ne=void 0;break}ne||(ne={}),ne[Re.keyFormat]&&(ne=rt({},ne)),ne[Re.keyFormat]=Re}else qe.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${xe}"`);break}case"START":T.startTimeOffset=pf(xe);break;case"MAP":{const Re=new ft(xe,T);if(K.duration){const me=new Za(l,S);Tf(me,Re,n,ne),b=me,K.initSegment=b,b.rawProgramDateTime&&!K.rawProgramDateTime&&(K.rawProgramDateTime=b.rawProgramDateTime)}else{const me=K.byteRangeEndOffset;if(me){const se=K.byteRangeStartOffset;le=`${me-se}@${se}`}else le=null;Tf(K,Re,n,ne),b=K,ie=!0}b.cc=F;break}case"SERVER-CONTROL":{ee&&Ir(T,_e,z),ee=new ft(xe),T.canBlockReload=ee.bool("CAN-BLOCK-RELOAD"),T.canSkipUntil=ee.optionalFloat("CAN-SKIP-UNTIL",0),T.canSkipDateRanges=T.canSkipUntil>0&&ee.bool("CAN-SKIP-DATERANGES"),T.partHoldBack=ee.optionalFloat("PART-HOLD-BACK",0),T.holdBack=ee.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{T.partTarget&&Ir(T,_e,z);const Re=new ft(xe);T.partTarget=Re.decimalFloatingPoint("PART-TARGET");break}case"PART":{let Re=T.partList;Re||(Re=T.partList=[]);const me=D>0?Re[Re.length-1]:void 0,se=D++,q=new ft(xe,T),k=new yp(q,K,S,se,me);Re.push(k),K.duration+=k.duration;break}case"PRELOAD-HINT":{const Re=new ft(xe,T);T.preloadHint=Re;break}case"RENDITION-REPORT":{const Re=new ft(xe,T);T.renditionReports=T.renditionReports||[],T.renditionReports.push(Re);break}default:qe.warn(`line parsed but not handled: ${z}`);break}}}H&&!H.relurl?(A.pop(),M-=H.duration,T.partList&&(T.fragmentHint=H)):T.partList&&(_o(K,H,L),K.cc=F,T.fragmentHint=K,ne&&Sf(K,ne,T)),T.targetduration||(T.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));const ve=A.length,Ee=A[0],Ne=A[ve-1];if(M+=T.skippedSegments*T.targetduration,M>0&&ve&&Ne){T.averagetargetduration=M/ve;const Ce=Ne.sn;T.endSN=Ce!=="initSegment"?Ce:0,T.live||(Ne.endList=!0),Ee&&T.startCC===void 0&&(T.startCC=Ee.cc),Z>0&&(Py(A,Z),Ee&&L.unshift(Ee))}else T.endSN=0,T.startCC=0;return T.fragmentHint&&(M+=T.fragmentHint.duration),T.totalduration=M,L.length&&T.dateRangeTagCount&&Ee&&bd(L,T),T.endCC=F,T}}function bd(v,e){const r=v.length,n=v[r-1],l=e.live?1/0:e.totalduration,f=Object.keys(e.dateRanges);for(let c=f.length;c--;){const y=e.dateRanges[f[c]],S=y.startDate.getTime();y.tagAnchor=n.ref;for(let T=r;T--;){const A=Cy(e,S,v,T,l);if(A!==-1){y.tagAnchor=e.fragments[A].ref;break}}}}function Cy(v,e,r,n,l){const f=r[n];if(f){const y=f.programDateTime;if(e>=y||n===0){var c;const S=(((c=r[n+1])==null?void 0:c.start)||l)-f.start;if(e<=y+S*1e3){const T=r[n].sn-v.startSN,A=v.fragments;if(A.length>r.length){const b=(r[n+1]||A[A.length-1]).sn-v.startSN;for(let C=b;C>T;C--){const D=A[C].programDateTime;if(e>=D&&e<D+A[C].duration*1e3)return C}}return T}}}return-1}function mf(v,e,r){var n,l;const f=new ft(v,r),c=(n=f.METHOD)!=null?n:"",y=f.URI,S=f.hexadecimalInteger("IV"),T=f.KEYFORMATVERSIONS,A=(l=f.KEYFORMAT)!=null?l:"identity";y&&f.IV&&!S&&qe.error(`Invalid IV: ${f.IV}`);const L=y?pr.resolve(y,e):"",b=(T||"1").split("/").map(Number).filter(Number.isFinite);return new is(c,L,A,b,S)}function pf(v){const r=new ft(v).decimalFloatingPoint("TIME-OFFSET");return Ae(r)?r:null}function yf(v,e){let r=(v||"").split(/[ ,]+/).filter(n=>n);["video","audio","text"].forEach(n=>{const l=r.filter(f=>gd(f,n));l.length&&(e[`${n}Codec`]=l.map(f=>f.split("/")[0]).join(","),r=r.filter(f=>l.indexOf(f)===-1))}),e.unknownCodecs=r}function Ef(v,e,r){const n=e[r];n&&(v[r]=n)}function Py(v,e){let r=v[e];for(let n=e;n--;){const l=v[n];if(!l)return;l.programDateTime=r.programDateTime-l.duration*1e3,r=l}}function _o(v,e,r){v.rawProgramDateTime?r.push(v):e!=null&&e.programDateTime&&(v.programDateTime=e.endProgramDateTime)}function Tf(v,e,r,n){v.relurl=e.URI,e.BYTERANGE&&v.setByteRange(e.BYTERANGE),v.level=r,v.sn="initSegment",n&&(v.levelkeys=n),v.initSegment=null}function Sf(v,e,r){v.levelkeys=e;const{encryptedFragments:n}=r;(!n.length||n[n.length-1].levelkeys!==e)&&Object.keys(e).some(l=>e[l].isCommonEncryption)&&n.push(v)}function Ir(v,e,r){v.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${r[0]})`)}function Af(v,e,r){v.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${r[0]})`)}function ao(v,e){const r=e.startPTS;if(Ae(r)){let n=0,l;e.sn>v.sn?(n=r-v.start,l=v):(n=v.start-r,l=e),l.duration!==n&&l.setDuration(n)}else e.sn>v.sn?v.cc===e.cc&&v.minEndPTS?e.setStart(v.start+(v.minEndPTS-v.start)):e.setStart(v.start+v.duration):e.setStart(Math.max(v.start-e.duration,0))}function _d(v,e,r,n,l,f){n-r<=0&&(qe.warn("Fragment should have a positive duration",e),n=r+e.duration,f=l+e.duration);let y=r,S=n;const T=e.startPTS,A=e.endPTS;if(Ae(T)){const F=Math.abs(T-r);Ae(e.deltaPTS)?e.deltaPTS=Math.max(F,e.deltaPTS):e.deltaPTS=F,y=Math.max(r,T),r=Math.min(r,T),l=Math.min(l,e.startDTS),S=Math.min(n,A),n=Math.max(n,A),f=Math.max(f,e.endDTS)}const L=r-e.start;e.start!==0&&e.setStart(r),e.setDuration(n-e.start),e.startPTS=r,e.maxStartPTS=y,e.startDTS=l,e.endPTS=n,e.minEndPTS=S,e.endDTS=f;const b=e.sn;if(!v||b<v.startSN||b>v.endSN)return 0;let C;const D=b-v.startSN,M=v.fragments;for(M[D]=e,C=D;C>0;C--)ao(M[C],M[C-1]);for(C=D;C<M.length-1;C++)ao(M[C],M[C+1]);return v.fragmentHint&&ao(M[M.length-1],v.fragmentHint),v.PTSKnown=v.alignedSliding=!0,L}function ky(v,e){if(v===e)return;let r=null;const n=v.fragments;for(let S=n.length-1;S>=0;S--){const T=n[S].initSegment;if(T){r=T;break}}v.fragmentHint&&delete v.fragmentHint.endPTS;let l;My(v,e,(S,T,A,L)=>{if(e.skippedSegments&&T.cc!==S.cc){const b=S.cc-T.cc;for(let C=A;C<L.length;C++)L[C].cc+=b}Ae(S.startPTS)&&Ae(S.endPTS)&&(T.setStart(T.startPTS=S.startPTS),T.startDTS=S.startDTS,T.maxStartPTS=S.maxStartPTS,T.endPTS=S.endPTS,T.endDTS=S.endDTS,T.minEndPTS=S.minEndPTS,T.setDuration(S.endPTS-S.startPTS),T.duration&&(l=T),e.PTSKnown=e.alignedSliding=!0),S.hasStreams&&(T.elementaryStreams=S.elementaryStreams),T.loader=S.loader,S.hasStats&&(T.stats=S.stats),S.initSegment&&(T.initSegment=S.initSegment,r=S.initSegment)});const f=e.fragments,c=e.fragmentHint?f.concat(e.fragmentHint):f;if(r&&c.forEach(S=>{var T;S&&(!S.initSegment||S.initSegment.relurl===((T=r)==null?void 0:T.relurl))&&(S.initSegment=r)}),e.skippedSegments)if(e.deltaUpdateFailed=f.some(S=>!S),e.deltaUpdateFailed){qe.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let S=e.skippedSegments;S--;)f.shift();e.startSN=f[0].sn}else{e.endCC=f[f.length-1].cc,e.canSkipDateRanges&&(e.dateRanges=wy(v.dateRanges,e));const S=v.fragments.filter(T=>T.rawProgramDateTime);if(v.hasProgramDateTime&&!e.hasProgramDateTime)for(let T=1;T<c.length;T++)c[T].programDateTime===null&&_o(c[T],c[T-1],S);bd(S,e)}Oy(v.partList,e.partList,(S,T)=>{T.elementaryStreams=S.elementaryStreams,T.stats=S.stats}),l?_d(e,l,l.startPTS,l.endPTS,l.startDTS,l.endDTS):Dd(v,e),f.length&&(e.totalduration=e.edge-f[0].start),e.driftStartTime=v.driftStartTime,e.driftStart=v.driftStart;const y=e.advancedDateTime;if(e.advanced&&y){const S=e.edge;e.driftStart||(e.driftStartTime=y,e.driftStart=S),e.driftEndTime=y,e.driftEnd=S}else e.driftEndTime=v.driftEndTime,e.driftEnd=v.driftEnd,e.advancedDateTime=v.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=v.requestScheduled)}function wy(v,e){const{dateRanges:r,recentlyRemovedDateranges:n}=e,l=rt({},v);n&&n.forEach(y=>{delete l[y]});const c=Object.keys(l).length;return c&&Object.keys(r).forEach(y=>{const S=l[y],T=new Ld(r[y].attr,S);T.isValid?(l[y]=T,S||(T.tagOrder+=c)):qe.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${ot(r[y].attr)}"`)}),l}function Oy(v,e,r){if(v&&e){let n=0;for(let l=0,f=v.length;l<=f;l++){const c=v[l],y=e[l+n];c&&y&&c.index===y.index&&c.fragment.sn===y.fragment.sn?r(c,y):n--}}}function My(v,e,r){const n=e.skippedSegments,l=Math.max(v.startSN,e.startSN)-e.startSN,f=(v.fragmentHint?1:0)+(n?e.endSN:Math.min(v.endSN,e.endSN))-e.startSN,c=e.startSN-v.startSN,y=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,S=v.fragmentHint?v.fragments.concat(v.fragmentHint):v.fragments;for(let T=l;T<=f;T++){const A=S[c+T];let L=y[T];if(n&&!L&&A&&(L=e.fragments[T]=A),A&&L){if(r(A,L,T,y),A.url&&A.url!==L.url){e.playlistParsingError=xf(`media sequence mismatch ${L.sn}:`,v,e,A,L);return}else if(A.cc!==L.cc){e.playlistParsingError=xf(`discontinuity sequence mismatch (${A.cc}!=${L.cc})`,v,e,A,L);return}}}}function xf(v,e,r,n,l){return new Error(`${v} ${l.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${r.startSN}
${r.m3u8}`)}function Dd(v,e,r=!0){const n=e.startSN+e.skippedSegments-v.startSN,l=v.fragments,f=n>=0;let c=0;if(f&&n<l.length)c=l[n].start;else if(f&&e.startSN===v.endSN+1)c=v.fragmentEnd;else if(f&&r)c=v.fragmentStart+n*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)c=v.fragmentStart;else return;Do(e,c)}function Do(v,e){if(e){const r=v.fragments;for(let n=v.skippedSegments;n<r.length;n++)r[n].addStart(e);v.fragmentHint&&v.fragmentHint.addStart(e)}}function Cd(v,e=1/0){let r=1e3*v.targetduration;if(v.updated){const n=v.fragments;if(n.length&&r*4>e){const f=n[n.length-1].duration*1e3;f<r&&(r=f)}}else r/=2;return Math.round(r)}function Fy(v,e,r){if(!v)return null;let n=v.fragments[e-v.startSN];return n||(n=v.fragmentHint,n&&n.sn===e)?n:e<v.startSN&&r&&r.sn===e?r:null}function Lf(v,e,r){return v?Pd(v.partList,e,r):null}function Pd(v,e,r){if(v)for(let n=v.length;n--;){const l=v[n];if(l.index===r&&l.fragment.sn===e)return l}return null}function kd(v){v.forEach((e,r)=>{var n;(n=e.details)==null||n.fragments.forEach(l=>{l.level=r,l.initSegment&&(l.initSegment.level=r)})})}function Qi(v,e){for(let n=0,l=v.length;n<l;n++){var r;if(((r=v[n])==null?void 0:r.cc)===e)return v[n]}return null}function Ny(v,e){return!!(v&&e.startCC<v.endCC&&e.endCC>v.startCC)}function If(v,e){if(v){const r=v.start+e;v.start=v.startPTS=r,v.endPTS=r+v.duration}}function wd(v,e){const r=e.fragments;for(let n=0,l=r.length;n<l;n++)If(r[n],v);e.fragmentHint&&If(e.fragmentHint,v),e.alignedSliding=!0}function Uy(v,e){v&&(Od(e,v),!e.alignedSliding&&v&&Dn(e,v),!e.alignedSliding&&v&&!e.skippedSegments&&Dd(v,e,!1))}function Od(v,e){if(!Ny(e,v))return;const r=Math.min(e.endCC,v.endCC),n=Qi(e.fragments,r),l=Qi(v.fragments,r);if(!n||!l)return;qe.log(`Aligning playlist at start of dicontinuity sequence ${r}`);const f=n.start-l.start;wd(f,v)}function Dn(v,e){if(!v.hasProgramDateTime||!e.hasProgramDateTime)return;const r=v.fragments,n=e.fragments;if(!r.length||!n.length)return;let l,f;const c=Math.min(e.endCC,v.endCC);e.startCC<c&&v.startCC<c&&(l=Qi(n,c),f=Qi(r,c)),(!l||!f)&&(l=n[Math.floor(n.length/2)],f=Qi(r,l.cc)||r[Math.floor(r.length/2)]);const y=l.programDateTime,S=f.programDateTime;if(!y||!S)return;const T=(S-y)/1e3-(f.start-l.start);wd(T,v)}const By={toString:function(v){let e="";const r=v.length;for(let n=0;n<r;n++)e+=`[${v.start(n).toFixed(3)}-${v.end(n).toFixed(3)}]`;return e}},de={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class Xo extends Ad{constructor(e,r,n,l,f){super(l,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=de.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:c,fragCurrent:y,media:S,mediaBuffer:T,state:A}=this,L=S?S.currentTime:0,b=Be.bufferInfo(T||S,L,c.maxBufferHole);if(this.log(`media seeking to ${Ae(L)?L.toFixed(3):L}, state: ${A}`),this.state===de.ENDED)this.resetLoadingState();else if(y){const C=c.maxFragLookUpTolerance,D=y.start-C,M=y.start+y.duration+C;if(!b.len||M<b.start||D>b.end){const F=L>M;(L<D||F)&&(F&&y.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),y.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(S){this.fragmentTracker.removeFragmentsInRange(L,1/0,this.playlistType,!0);const C=this.lastCurrentTime;if(L>C&&(this.lastCurrentTime=L),!this.loadingParts){const D=Math.max(b.end,L),M=this.shouldLoadParts(this.getLevelDetails(),D);M&&(this.log(`LL-Part loading ON after seeking to ${L.toFixed(2)} with buffer @${D.toFixed(2)}`),this.loadingParts=M)}}!this.hls.hasEnoughToStart&&!b.len&&(this.log(`setting startPosition to ${L} because of seek before start`),this.nextLoadPosition=this.startPosition=L),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=f,this.hls=e,this.fragmentLoader=new cy(e.config),this.keyLoader=n,this.fragmentTracker=r,this.config=e.config,this.decrypter=new Yo(e.config)}registerListeners(){const{hls:e}=this;e.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(w.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(w.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===de.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=de.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:r}=this;return r===-1&&e?e:r}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,r){if(r.live||!this.media)return!1;const n=e.end||0,l=this.config.timelineOffset||0;if(n<=l)return!1;const f=e.nextStart;if(f&&f>l&&f<r.edge||this.media.currentTime<e.start)return!1;const y=r.partList;if(y!=null&&y.length){const T=y[y.length-1];return Be.isBuffered(this.media,T.start+T.duration/2)}const S=r.fragments[r.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(S)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}get timelineOffset(){const e=this.config.timelineOffset;if(e){var r;return((r=this.getLevelDetails())==null?void 0:r.appliedTimelineOffset)||e}return 0}onMediaAttached(e,r){const n=this.media=this.mediaBuffer=r.media;n.removeEventListener("seeking",this.onMediaSeeking),n.removeEventListener("ended",this.onMediaEnded),n.addEventListener("seeking",this.onMediaSeeking),n.addEventListener("ended",this.onMediaEnded);const l=this.config;this.levels&&l.autoStartLoad&&this.state===de.STOPPED&&this.startLoad(l.startPosition)}onMediaDetaching(e,r){const n=!!r.transferMedia,l=this.media;if(l!==null){if(l.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),l.removeEventListener("seeking",this.onMediaSeeking),l.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!n&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,n){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,r){}onManifestLoaded(e,r){this.startTimeOffset=r.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=de.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,r,n){this.startFragRequested=!0,this._loadFragForPlayback(e,r,n)}_loadFragForPlayback(e,r,n){const l=f=>{const c=f.frag;if(this.fragContextChanged(c)){this.warn(`${c.type} sn: ${c.sn}${f.part?" part: "+f.part.index:""} of ${this.fragInfo(c,!1,f.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(c);return}c.stats.chunkCount++,this._handleFragmentLoadProgress(f)};this._doFragLoad(e,r,n,l).then(f=>{if(!f)return;const c=this.state,y=f.frag;if(this.fragContextChanged(y)){(c===de.FRAG_LOADING||!this.fragCurrent&&c===de.PARSING)&&(this.fragmentTracker.removeFragment(y),this.state=de.IDLE);return}"payload"in f&&(this.log(`Loaded ${y.type} sn: ${y.sn} of ${this.playlistLabel()} ${y.level}`),this.hls.trigger(w.FRAG_LOADED,f)),this._handleFragmentLoadComplete(f)}).catch(f=>{this.state===de.STOPPED||this.state===de.ERROR||(this.warn(`Frag error: ${(f==null?void 0:f.message)||f}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var r;const{fragmentTracker:n}=this;if(n.getState(e)===Rt.APPENDING){const f=e.type,c=this.getFwdBufferInfo(this.mediaBuffer,f),y=Math.max(e.duration,c?c.len:this.config.maxBufferLength),S=this.backtrackFragment;((S?e.sn-S.sn:0)===1||this.reduceMaxBufferLength(y,e.duration))&&n.removeFragment(e)}else((r=this.mediaBuffer)==null?void 0:r.buffered.length)===0?n.removeAllFragments():n.hasParts(e.type)&&(n.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),n.getState(e)===Rt.PARTIAL&&n.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const r=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:r,part:null,stats:r.stats,id:r.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const r=e.details;return(r==null?void 0:r.live)&&r.type!=="EVENT"&&(this.levelLastLoaded!==e||r.expired)}flushMainBuffer(e,r,n=null){if(!(e-r))return;const l={startOffset:e,endOffset:r,type:n};this.hls.trigger(w.BUFFER_FLUSHING,l)}_loadInitSegment(e,r){this._doFragLoad(e,r).then(n=>{const l=n==null?void 0:n.frag;if(!l||this.fragContextChanged(l)||!this.levels)throw new Error("init load aborted");return n}).then(n=>{const{hls:l}=this,{frag:f,payload:c}=n,y=f.decryptdata;if(c&&c.byteLength>0&&y!=null&&y.key&&y.iv&&Ri(y.method)){const S=self.performance.now();return this.decrypter.decrypt(new Uint8Array(c),y.key.buffer,y.iv.buffer,qo(y.method)).catch(T=>{throw l.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.FRAG_DECRYPT_ERROR,fatal:!1,error:T,reason:T.message,frag:f}),T}).then(T=>{const A=self.performance.now();return l.trigger(w.FRAG_DECRYPTED,{frag:f,payload:T,stats:{tstart:S,tdecrypt:A}}),n.payload=T,this.completeInitSegmentLoad(n)})}return this.completeInitSegmentLoad(n)}).catch(n=>{this.state===de.STOPPED||this.state===de.ERROR||(this.warn(n),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:r}=this;if(!r)throw new Error("init load aborted, missing levels");const n=e.frag.stats;this.state!==de.STOPPED&&(this.state=de.IDLE),e.frag.data=new Uint8Array(e.payload),n.parsing.start=n.buffering.start=self.performance.now(),n.parsing.end=n.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:r}=this;return!e||!r||e.sn!==r.sn||e.level!==r.level}fragBufferedComplete(e,r){const n=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${r?" part: "+r.index:""} of ${this.fragInfo(e,!1,r)} > buffer:${n?By.toString(Be.getBuffered(n)):"(detached)"})`),wt(e)){var l;if(e.type!==be.SUBTITLE){const c=e.elementaryStreams;if(!Object.keys(c).some(y=>!!c[y])){this.state=de.IDLE;return}}const f=(l=this.levels)==null?void 0:l[e.level];f!=null&&f.fragmentError&&(this.log(`Resetting level fragment error count of ${f.fragmentError} on frag buffered`),f.fragmentError=0)}this.state=de.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:r}=this;if(!r)return;const{frag:n,part:l,partsLoaded:f}=e,c=!f||f.length===0||f.some(S=>!S),y=new Wo(n.level,n.sn,n.stats.chunkCount+1,0,l?l.index:-1,!c);r.flush(y)}_handleFragmentLoadProgress(e){}_doFragLoad(e,r,n=null,l){var f;this.fragCurrent=e;const c=r==null?void 0:r.details;if(!this.levels||!c)throw new Error(`frag load aborted, missing level${c?"":" detail"}s`);let y=null;e.encrypted&&!((f=e.decryptdata)!=null&&f.key)?(this.log(`Loading key for ${e.sn} of [${c.startSN}-${c.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=de.KEY_LOADING,this.fragCurrent=e,y=this.keyLoader.load(e).then(L=>{if(!this.fragContextChanged(L.frag))return this.hls.trigger(w.KEY_LOADED,L),this.state===de.KEY_LOADING&&(this.state=de.IDLE),L}),this.hls.trigger(w.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(y=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&c.encryptedFragments.length&&this.keyLoader.loadClear(e,c.encryptedFragments);const S=this.fragPrevious;if(wt(e)&&(!S||e.sn!==S.sn)){const L=this.shouldLoadParts(r.details,e.end);L!==this.loadingParts&&(this.log(`LL-Part loading ${L?"ON":"OFF"} loading sn ${S==null?void 0:S.sn}->${e.sn}`),this.loadingParts=L)}if(n=Math.max(e.start,n||0),this.loadingParts&&wt(e)){const L=c.partList;if(L&&l){n>e.end&&c.fragmentHint&&(e=c.fragmentHint);const b=this.getNextPart(L,e,n);if(b>-1){const C=L[b];e=this.fragCurrent=C.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${C.index} (${b}/${L.length-1}) of ${this.fragInfo(e,!1,C)}) cc: ${e.cc} [${c.startSN}-${c.endSN}], target: ${parseFloat(n.toFixed(3))}`),this.nextLoadPosition=C.start+C.duration,this.state=de.FRAG_LOADING;let D;return y?D=y.then(M=>!M||this.fragContextChanged(M.frag)?null:this.doFragPartsLoad(e,C,r,l)).catch(M=>this.handleFragLoadError(M)):D=this.doFragPartsLoad(e,C,r,l).catch(M=>this.handleFragLoadError(M)),this.hls.trigger(w.FRAG_LOADING,{frag:e,part:C,targetBufferTime:n}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):D}else if(!e.url||this.loadedEndOfParts(L,n))return Promise.resolve(null)}}if(wt(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${n.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${c?"["+c.startSN+"-"+c.endSN+"]":""}, target: ${parseFloat(n.toFixed(3))}`),Ae(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=de.FRAG_LOADING;const T=this.config.progressive;let A;return T&&y?A=y.then(L=>!L||this.fragContextChanged(L==null?void 0:L.frag)?null:this.fragmentLoader.load(e,l)).catch(L=>this.handleFragLoadError(L)):A=Promise.all([this.fragmentLoader.load(e,T?l:void 0),y]).then(([L])=>(!T&&L&&l&&l(L),L)).catch(L=>this.handleFragLoadError(L)),this.hls.trigger(w.FRAG_LOADING,{frag:e,targetBufferTime:n}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):A}doFragPartsLoad(e,r,n,l){return new Promise((f,c)=>{var y;const S=[],T=(y=n.details)==null?void 0:y.partList,A=L=>{this.fragmentLoader.loadPart(e,L,l).then(b=>{S[L.index]=b;const C=b.part;this.hls.trigger(w.FRAG_LOADED,b);const D=Lf(n.details,e.sn,L.index+1)||Pd(T,e.sn,L.index+1);if(D)A(D);else return f({frag:e,part:C,partsLoaded:S})}).catch(c)};A(r)})}handleFragLoadError(e){if("data"in e){const r=e.data;e.data&&r.details===re.INTERNAL_ABORTED?this.handleFragLoadAborted(r.frag,r.part):this.hls.trigger(w.ERROR,r)}else this.hls.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const r=this.getCurrentContext(e);if(!r||this.state!==de.PARSING){!this.fragCurrent&&this.state!==de.STOPPED&&this.state!==de.ERROR&&(this.state=de.IDLE);return}const{frag:n,part:l,level:f}=r,c=self.performance.now();n.stats.parsing.end=c,l&&(l.stats.parsing.end=c);const y=this.getLevelDetails(),T=y&&n.sn>y.endSN||this.shouldLoadParts(y,n.end);T!==this.loadingParts&&(this.log(`LL-Part loading ${T?"ON":"OFF"} after parsing segment ending @${n.end.toFixed(2)}`),this.loadingParts=T),this.updateLevelTiming(n,l,f,e.partial)}shouldLoadParts(e,r){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e!=null&&e.partList){var n;const f=e.partList[0],c=f.end+(((n=e.fragmentHint)==null?void 0:n.duration)||0);if(r>=c){var l;if((this.hls.hasEnoughToStart?((l=this.media)==null?void 0:l.currentTime)||this.lastCurrentTime:this.getLoadPosition())>f.start-f.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:r,fragCurrent:n}=this,{level:l,sn:f,part:c}=e;if(!(r!=null&&r[l]))return this.warn(`Levels object was unset while buffering fragment ${f} of ${this.playlistLabel()} ${l}. The current chunk will not be buffered.`),null;const y=r[l],S=y.details,T=c>-1?Lf(S,f,c):null,A=T?T.fragment:Fy(S,f,n);return A?(n&&n!==A&&(A.stats=n.stats),{frag:A,part:T,level:y}):null}bufferFragmentData(e,r,n,l,f){var c;if(!e||this.state!==de.PARSING)return;const{data1:y,data2:S}=e;let T=y;if(y&&S&&(T=Qt(y,S)),!((c=T)!=null&&c.length))return;const A={type:e.type,frag:r,part:n,chunkMeta:l,parent:r.type,data:T};if(this.hls.trigger(w.BUFFER_APPENDING,A),e.dropped&&e.independent&&!n){if(f)return;this.flushBufferGap(r)}}flushBufferGap(e){const r=this.media;if(!r)return;if(!Be.isBuffered(r,r.currentTime)){this.flushMainBuffer(0,e.start);return}const n=r.currentTime,l=Be.bufferInfo(r,n,0),f=e.duration,c=Math.min(this.config.maxFragLookUpTolerance*2,f*.25),y=Math.max(Math.min(e.start-c,l.end-c),n+c);e.start-y>c&&this.flushMainBuffer(y,e.start)}getFwdBufferInfo(e,r){var n;const l=this.getLoadPosition();if(!Ae(l))return null;const c=this.lastCurrentTime>l||(n=this.media)!=null&&n.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,l,r,c)}getFwdBufferInfoAtPos(e,r,n,l){const f=Be.bufferInfo(e,r,l);if(f.len===0&&f.nextStart!==void 0){const c=this.fragmentTracker.getBufferedFrag(r,n);if(c&&(f.nextStart<=c.end||c.gap)){const y=Math.max(Math.min(f.nextStart,c.end)-r,l);return Be.bufferInfo(e,r,y)}}return f}getMaxBufferLength(e){const{config:r}=this;let n;return e?n=Math.max(8*r.maxBufferSize/e,r.maxBufferLength):n=r.maxBufferLength,Math.min(n,r.maxMaxBufferLength)}reduceMaxBufferLength(e,r){const n=this.config,l=Math.max(Math.min(e-r,n.maxBufferLength),r),f=Math.max(e-r*3,n.maxMaxBufferLength/2,l);return f>=l?(n.maxMaxBufferLength=f,this.warn(`Reduce max buffer length to ${f}s`),!0):!1}getAppendedFrag(e,r=be.MAIN){var n;const l=(n=this.fragmentTracker)==null?void 0:n.getAppendedFrag(e,r);return l&&"fragment"in l?l.fragment:l}getNextFragment(e,r){const n=r.fragments,l=n.length;if(!l)return null;const{config:f}=this,c=n[0].start,y=f.lowLatencyMode&&!!r.partList;let S=null;if(r.live){const L=f.initialLiveManifestSize;if(l<L)return this.warn(`Not enough fragments to start playback (have: ${l}, need: ${L})`),null;if(!r.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<c){var T;y&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),S=this.getInitialLiveFragment(r,n);const b=this.hls.startPosition,C=this.hls.liveSyncPosition,D=S?(b!==-1&&b>=c?b:C)||S.start:e;this.log(`Setting startPosition to ${D} to match start frag at live edge. mainStart: ${b} liveSyncPosition: ${C} frag.start: ${(T=S)==null?void 0:T.start}`),this.startPosition=this.nextLoadPosition=D}}else e<=c&&(S=n[0]);if(!S){const L=this.loadingParts?r.partEnd:r.fragmentEnd;S=this.getFragmentAtPosition(e,L,r)}let A=this.filterReplacedPrimary(S,r);if(!A&&S){const L=S.sn-r.startSN;A=this.filterReplacedPrimary(n[L+1]||null,r)}return this.mapToInitFragWhenRequired(A)}isLoopLoading(e,r){const n=this.fragmentTracker.getState(e);return(n===Rt.OK||n===Rt.PARTIAL&&!!e.gap)&&this.nextLoadPosition>r}getNextFragmentLoopLoading(e,r,n,l,f){let c=null;if(e.gap&&(c=this.getNextFragment(this.nextLoadPosition,r),c&&!c.gap&&n.nextStart)){const y=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,n.nextStart,l,0);if(y!==null&&n.len+y.len>=f){const S=c.sn;return this.loopSn!==S&&(this.log(`buffer full after gaps in "${l}" playlist starting at sn: ${S}`),this.loopSn=S),null}}return this.loopSn=void 0,c}get primaryPrefetch(){if(Rf(this.hls.config)){var e,r;if((e=this.hls.interstitialsManager)==null||(r=e.playingItem)==null?void 0:r.event)return!0}return!1}filterReplacedPrimary(e,r){if(!e)return e;if(Rf(this.hls.config)&&e.type!==be.SUBTITLE){const n=this.hls.interstitialsManager,l=n==null?void 0:n.bufferingItem;if(l){const c=l.event;if(c){if(c.appendInPlace||Math.abs(e.start-l.start)>1||l.start===0)return null}else if(e.end<=l.start&&(r==null?void 0:r.live)===!1||e.start>l.end&&l.nextEvent&&(l.nextEvent.appendInPlace||e.start-l.end>1))return null}const f=n==null?void 0:n.playerQueue;if(f)for(let c=f.length;c--;){const y=f[c].interstitial;if(y.appendInPlace&&e.start>=y.startTime&&e.end<=y.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,r,n){let l=-1,f=!1,c=!0;for(let y=0,S=e.length;y<S;y++){const T=e[y];if(c=c&&!T.independent,l>-1&&n<T.start)break;const A=T.loaded;A?l=-1:(f||T.independent||c)&&T.fragment===r&&(l=y),f=A}return l}loadedEndOfParts(e,r){const n=e[e.length-1];return n&&r>n.start&&n.loaded}getInitialLiveFragment(e,r){const n=this.fragPrevious;let l=null;if(n){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${n.programDateTime}`),l=ey(r,n.endProgramDateTime,this.config.maxFragLookUpTolerance)),!l){const f=n.sn+1;if(f>=e.startSN&&f<=e.endSN){const c=r[f-e.startSN];n.cc===c.cc&&(l=c,this.log(`Live playlist, switching playlist, load frag with next SN: ${l.sn}`))}l||(l=Sd(r,n.cc),l&&this.log(`Live playlist, switching playlist, load frag with same CC: ${l.sn}`))}}else{const f=this.hls.liveSyncPosition;f!==null&&(l=this.getFragmentAtPosition(f,this.bitrateTest?e.fragmentEnd:e.edge,e))}return l}getFragmentAtPosition(e,r,n){const{config:l}=this;let{fragPrevious:f}=this,{fragments:c,endSN:y}=n;const{fragmentHint:S}=n,{maxFragLookUpTolerance:T}=l,A=n.partList,L=!!(this.loadingParts&&A!=null&&A.length&&S);L&&S&&!this.bitrateTest&&A[A.length-1].fragment.sn===S.sn&&(c=c.concat(S),y=S.sn);let b;if(e<r){var C;const M=e<this.lastCurrentTime||e>r-T||(C=this.media)!=null&&C.paused||!this.startFragRequested?0:T;b=ri(f,c,e,M)}else b=c[c.length-1];if(b){const D=b.sn-n.startSN,M=this.fragmentTracker.getState(b);if((M===Rt.OK||M===Rt.PARTIAL&&b.gap)&&(f=b),f&&b.sn===f.sn&&(!L||A[0].fragment.sn>b.sn||!n.live&&!L)&&f&&b.level===f.level){const $=c[D+1];b.sn<y&&this.fragmentTracker.getState($)!==Rt.OK?b=$:b=null}}return b}alignPlaylists(e,r,n){const l=e.fragments.length;if(!l)return this.warn("No fragments in live playlist"),0;const f=e.fragmentStart,c=!r,y=e.alignedSliding&&Ae(f);if(c||!y&&!f){Uy(n,e);const S=e.fragmentStart;return this.log(`Live playlist sliding: ${S.toFixed(2)} start-sn: ${r?r.startSN:"na"}->${e.startSN} fragments: ${l}`),S}return f}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,r){let n=this.startPosition;n<r&&(n=-1);const l=this.timelineOffset;if(n===-1){const f=this.startTimeOffset!==null,c=f?this.startTimeOffset:e.startTimeOffset;c!==null&&Ae(c)?(n=r+c,c<0&&(n+=e.edge),n=Math.min(Math.max(r,n),r+e.totalduration),this.log(`Setting startPosition to ${n} for start time offset ${c} found in ${f?"multivariant":"media"} playlist`),this.startPosition=n):e.live?(n=this.hls.liveSyncPosition||r,this.log(`Setting startPosition to -1 to start at live edge ${n}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=n=0),this.lastCurrentTime=n+l}this.nextLoadPosition=n+l}getLoadPosition(){var e;const{media:r}=this;let n=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&r?n=r.currentTime:this.nextLoadPosition>=0&&(n=this.nextLoadPosition),n}handleFragLoadAborted(e,r){this.transmuxer&&e.type===this.playlistType&&wt(e)&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${r?" part "+r.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==de.FRAG_LOADING_WAITING_RETRY)&&(this.state=de.IDLE)}onFragmentOrKeyLoadError(e,r){if(r.chunkMeta&&!r.frag){const D=this.getCurrentContext(r.chunkMeta);D&&(r.frag=D.frag)}const n=r.frag;if(!n||n.type!==e||!this.levels)return;if(this.fragContextChanged(n)){var l;this.warn(`Frag load error must match current frag to retry ${n.url} > ${(l=this.fragCurrent)==null?void 0:l.url}`);return}const f=r.details===re.FRAG_GAP;f&&this.fragmentTracker.fragBuffered(n,!0);const c=r.errorAction,{action:y,flags:S,retryCount:T=0,retryConfig:A}=c||{},L=!!c&&!!A,b=L&&y===Ft.RetryRequest,C=L&&!c.resolved&&S===rr.MoveAllAlternatesMatchingHost;if(!b&&C&&wt(n)&&!n.endList)this.resetFragmentErrors(e),this.treatAsGap(n),c.resolved=!0;else if((b||C)&&T<A.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const D=Ho(A,T);this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${r.details}, retrying loading ${T+1}/${A.maxNumRetry} in ${D}ms`),c.resolved=!0,this.retryDate=self.performance.now()+D,this.state=de.FRAG_LOADING_WAITING_RETRY}else if(A&&c)if(this.resetFragmentErrors(e),T<A.maxNumRetry)!f&&y!==Ft.RemoveAlternatePermanently&&(c.resolved=!0);else{this.warn(`${r.details} reached or exceeded max retry (${T})`);return}else y===Ft.SendAlternateToPenaltyBox?this.state=de.WAITING_LEVEL:this.state=de.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===de.PARSING||this.state===de.PARSED){const r=e.frag,n=e.parent,l=this.getFwdBufferInfo(this.mediaBuffer,n),f=l&&l.len>.5;f&&this.reduceMaxBufferLength(l.len,(r==null?void 0:r.duration)||10);const c=!f;return c&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${n} buffer`),r&&(this.fragmentTracker.removeFragment(r),this.nextLoadPosition=r.start),this.resetLoadingState(),c}return!1}resetFragmentErrors(e){e===be.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==de.STOPPED&&(this.state=de.IDLE)}afterBufferFlushed(e,r,n){if(!e)return;const l=Be.getBuffered(e);this.fragmentTracker.detectEvictedFragments(r,l,n),this.state===de.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==de.STOPPED&&(this.state=de.IDLE)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const r=e?e.details:null;r!=null&&r.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(r,r.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,r,n,l){const f=n.details;if(!f){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((S,T)=>{const A=e.elementaryStreams[T];if(A){const L=A.endPTS-A.startPTS;if(L<=0)return this.warn(`Could not parse fragment ${e.sn} ${T} duration reliably (${L})`),S||!1;const b=l?0:_d(f,e,A.startPTS,A.endPTS,A.startDTS,A.endDTS);return this.hls.trigger(w.LEVEL_PTS_UPDATED,{details:f,level:n,drift:b,type:T,frag:e,start:A.startPTS,end:A.endPTS}),!0}return S},!1)){var y;if(n.fragmentError===0&&this.treatAsGap(e,n),((y=this.transmuxer)==null?void 0:y.error)===null){const S=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(S.message),this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.FRAG_PARSING_ERROR,fatal:!1,error:S,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${n.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=de.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${r?" part: "+r.index:""} of ${this.fragInfo(e,!1,r)})`),this.hls.trigger(w.FRAG_PARSED,{frag:e,part:r})}playlistLabel(){return this.playlistType===be.MAIN?"level":"track"}fragInfo(e,r=!0,n){var l,f;return`${this.playlistLabel()} ${e.level} (${n?"part":"frag"}:[${((l=r&&!n?e.startPTS:(n||e).start)!=null?l:NaN).toFixed(3)}-${((f=r&&!n?e.endPTS:(n||e).end)!=null?f:NaN).toFixed(3)}]${n&&e.type==="main"?"INDEPENDENT="+(n.independent?"YES":"NO"):""}`}treatAsGap(e,r){r&&r.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const r=this._state;r!==e&&(this._state=e,this.log(`${r}->${e}`))}get state(){return this._state}}function Rf(v){return!!v.interstitialsController&&v.enableInterstitialPlayback!==!1}class Md{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:r}=this;let n;if(e.length)e.length===1?n=e[0]:n=Gy(e,r);else return new Uint8Array(0);return this.reset(),n}reset(){this.chunks.length=0,this.dataLength=0}}function Gy(v,e){const r=new Uint8Array(e);let n=0;for(let l=0;l<v.length;l++){const f=v[l];r.set(f,n),n+=f.length}return r}var oo={exports:{}},bf;function $y(){return bf||(bf=1,function(v){var e=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function l(S,T,A){this.fn=S,this.context=T,this.once=A||!1}function f(S,T,A,L,b){if(typeof A!="function")throw new TypeError("The listener must be a function");var C=new l(A,L||S,b),D=r?r+T:T;return S._events[D]?S._events[D].fn?S._events[D]=[S._events[D],C]:S._events[D].push(C):(S._events[D]=C,S._eventsCount++),S}function c(S,T){--S._eventsCount===0?S._events=new n:delete S._events[T]}function y(){this._events=new n,this._eventsCount=0}y.prototype.eventNames=function(){var T=[],A,L;if(this._eventsCount===0)return T;for(L in A=this._events)e.call(A,L)&&T.push(r?L.slice(1):L);return Object.getOwnPropertySymbols?T.concat(Object.getOwnPropertySymbols(A)):T},y.prototype.listeners=function(T){var A=r?r+T:T,L=this._events[A];if(!L)return[];if(L.fn)return[L.fn];for(var b=0,C=L.length,D=new Array(C);b<C;b++)D[b]=L[b].fn;return D},y.prototype.listenerCount=function(T){var A=r?r+T:T,L=this._events[A];return L?L.fn?1:L.length:0},y.prototype.emit=function(T,A,L,b,C,D){var M=r?r+T:T;if(!this._events[M])return!1;var F=this._events[M],$=arguments.length,H,K;if(F.fn){switch(F.once&&this.removeListener(T,F.fn,void 0,!0),$){case 1:return F.fn.call(F.context),!0;case 2:return F.fn.call(F.context,A),!0;case 3:return F.fn.call(F.context,A,L),!0;case 4:return F.fn.call(F.context,A,L,b),!0;case 5:return F.fn.call(F.context,A,L,b,C),!0;case 6:return F.fn.call(F.context,A,L,b,C,D),!0}for(K=1,H=new Array($-1);K<$;K++)H[K-1]=arguments[K];F.fn.apply(F.context,H)}else{var z=F.length,Q;for(K=0;K<z;K++)switch(F[K].once&&this.removeListener(T,F[K].fn,void 0,!0),$){case 1:F[K].fn.call(F[K].context);break;case 2:F[K].fn.call(F[K].context,A);break;case 3:F[K].fn.call(F[K].context,A,L);break;case 4:F[K].fn.call(F[K].context,A,L,b);break;default:if(!H)for(Q=1,H=new Array($-1);Q<$;Q++)H[Q-1]=arguments[Q];F[K].fn.apply(F[K].context,H)}}return!0},y.prototype.on=function(T,A,L){return f(this,T,A,L,!1)},y.prototype.once=function(T,A,L){return f(this,T,A,L,!0)},y.prototype.removeListener=function(T,A,L,b){var C=r?r+T:T;if(!this._events[C])return this;if(!A)return c(this,C),this;var D=this._events[C];if(D.fn)D.fn===A&&(!b||D.once)&&(!L||D.context===L)&&c(this,C);else{for(var M=0,F=[],$=D.length;M<$;M++)(D[M].fn!==A||b&&!D[M].once||L&&D[M].context!==L)&&F.push(D[M]);F.length?this._events[C]=F.length===1?F[0]:F:c(this,C)}return this},y.prototype.removeAllListeners=function(T){var A;return T?(A=r?r+T:T,this._events[A]&&c(this,A)):(this._events=new n,this._eventsCount=0),this},y.prototype.off=y.prototype.removeListener,y.prototype.addListener=y.prototype.on,y.prefixed=r,y.EventEmitter=y,v.exports=y}(oo)),oo.exports}var Ky=$y(),zo=mp(Ky);const ss="1.6.0",Ci={};function Vy(){return typeof __HLS_WORKER_BUNDLE__=="function"}function Hy(){const v=Ci[ss];if(v)return v.clientCount++,v;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),r=self.URL.createObjectURL(e),l={worker:new self.Worker(r),objectURL:r,clientCount:1};return Ci[ss]=l,l}function Yy(v){const e=Ci[v];if(e)return e.clientCount++,e;const r=new self.URL(v,self.location.href).href,l={worker:new self.Worker(r),scriptURL:r,clientCount:1};return Ci[v]=l,l}function Wy(v){const e=Ci[v||ss];if(e&&e.clientCount--===1){const{worker:n,objectURL:l}=e;delete Ci[v||ss],l&&self.URL.revokeObjectURL(l),n.terminate()}}function Fd(v,e){return e+10<=v.length&&v[e]===51&&v[e+1]===68&&v[e+2]===73&&v[e+3]<255&&v[e+4]<255&&v[e+6]<128&&v[e+7]<128&&v[e+8]<128&&v[e+9]<128}function Qo(v,e){return e+10<=v.length&&v[e]===73&&v[e+1]===68&&v[e+2]===51&&v[e+3]<255&&v[e+4]<255&&v[e+6]<128&&v[e+7]<128&&v[e+8]<128&&v[e+9]<128}function wn(v,e){let r=0;return r=(v[e]&127)<<21,r|=(v[e+1]&127)<<14,r|=(v[e+2]&127)<<7,r|=v[e+3]&127,r}function ns(v,e){const r=e;let n=0;for(;Qo(v,e);){n+=10;const l=wn(v,e+6);n+=l,Fd(v,e+10)&&(n+=10),e+=n}if(n>0)return v.subarray(r,r+n)}function qy(v,e,r,n){const l=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],f=e[r+2],c=f>>2&15;if(c>12){const C=new Error(`invalid ADTS sampling index:${c}`);v.emit(w.ERROR,w.ERROR,{type:De.MEDIA_ERROR,details:re.FRAG_PARSING_ERROR,fatal:!0,error:C,reason:C.message});return}const y=(f>>6&3)+1,S=e[r+3]>>6&3|(f&1)<<2,T="mp4a.40."+y,A=l[c];let L=c;(y===5||y===29)&&(L-=3);const b=[y<<3|(L&14)>>1,(L&1)<<7|S<<3];return qe.log(`manifest codec:${n}, parsed codec:${T}, channels:${S}, rate:${A} (ADTS object type:${y} sampling index:${c})`),{config:b,samplerate:A,channelCount:S,codec:T,parsedCodec:T,manifestCodec:n}}function Nd(v,e){return v[e]===255&&(v[e+1]&246)===240}function Ud(v,e){return v[e+1]&1?7:9}function Zo(v,e){return(v[e+3]&3)<<11|v[e+4]<<3|(v[e+5]&224)>>>5}function jy(v,e){return e+5<v.length}function Cn(v,e){return e+1<v.length&&Nd(v,e)}function Xy(v,e){return jy(v,e)&&Nd(v,e)&&Zo(v,e)<=v.length-e}function zy(v,e){if(Cn(v,e)){const r=Ud(v,e);if(e+r>=v.length)return!1;const n=Zo(v,e);if(n<=r)return!1;const l=e+n;return l===v.length||Cn(v,l)}return!1}function Bd(v,e,r,n,l){if(!v.samplerate){const f=qy(e,r,n,l);if(!f)return;rt(v,f)}}function Gd(v){return 1024*9e4/v}function Qy(v,e){const r=Ud(v,e);if(e+r<=v.length){const n=Zo(v,e)-r;if(n>0)return{headerLength:r,frameLength:n}}}function $d(v,e,r,n,l){const f=Gd(v.samplerate),c=n+l*f,y=Qy(e,r);let S;if(y){const{frameLength:L,headerLength:b}=y,C=b+L,D=Math.max(0,r+C-e.length);D?(S=new Uint8Array(C-b),S.set(e.subarray(r+b,e.length),0)):S=e.subarray(r+b,r+C);const M={unit:S,pts:c};return D||v.samples.push(M),{sample:M,length:C,missing:D}}const T=e.length-r;return S=new Uint8Array(T),S.set(e.subarray(r,e.length),0),{sample:{unit:S,pts:c},length:T,missing:-1}}function Zy(v,e){return Qo(v,e)&&wn(v,e+6)+10<=v.length-e}function Jy(v){if(v.size<2)return;const e=Ht(v.data,!0),r=new Uint8Array(v.data.subarray(e.length+1));return{key:v.type,info:e,data:r.buffer}}function eE(v){if(v.size<2)return;if(v.type==="TXXX"){let r=1;const n=Ht(v.data.subarray(r),!0);r+=n.length+1;const l=Ht(v.data.subarray(r));return{key:v.type,info:n,data:l}}const e=Ht(v.data.subarray(1));return{key:v.type,info:"",data:e}}function tE(v){if(v.type==="WXXX"){if(v.size<2)return;let r=1;const n=Ht(v.data.subarray(r),!0);r+=n.length+1;const l=Ht(v.data.subarray(r));return{key:v.type,info:n,data:l}}const e=Ht(v.data);return{key:v.type,info:"",data:e}}function rE(v){return btoa(String.fromCharCode(...v))}function Kd(v,e){if(v<0)return-Kd(-v,e);const r=Math.pow(10,e);if(Math.abs(v*r%1-.5)<Number.EPSILON){const l=Math.floor(v*r);return(l%2===0?l:l+1)/r}else return Math.round(v*r)/r}function iE(v,e){const r=new URL(v),n=new URL(e);if(r.origin!==n.origin)return v;const l=r.pathname.split("/").slice(1),f=n.pathname.split("/").slice(1,-1);for(;l[0]===f[0];)l.shift(),f.shift();for(;f.length;)f.shift(),l.unshift("..");return l.join("/")}function sE(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),r=e.toString();return URL.revokeObjectURL(e),r.slice(r.lastIndexOf("/")+1)}catch{let r=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,l=>{const f=(r+Math.random()*16)%16|0;return r=Math.floor(r/16),(l=="x"?f:f&3|8).toString(16)})}}}function nE(v){return v instanceof ArrayBuffer?v:v.byteOffset==0&&v.byteLength==v.buffer.byteLength?v.buffer:new Uint8Array(v).buffer}function lo(v,e=0,r=1/0){return aE(v,e,r,Uint8Array)}function aE(v,e,r,n){const l=oE(v);let f=1;"BYTES_PER_ELEMENT"in n&&(f=n.BYTES_PER_ELEMENT);const c=lE(v)?v.byteOffset:0,y=(c+v.byteLength)/f,S=(c+e)/f,T=Math.floor(Math.max(0,Math.min(S,y))),A=Math.floor(Math.min(T+Math.max(r,0),y));return new n(l,T,A-T)}function oE(v){return v instanceof ArrayBuffer?v:v.buffer}function lE(v){return v&&v.buffer instanceof ArrayBuffer&&v.byteLength!==void 0&&v.byteOffset!==void 0}function uE(v){const e={key:v.type,description:"",data:"",mimeType:null,pictureType:null},r=3;if(v.size<2)return;if(v.data[0]!==r){console.log("Ignore frame with unrecognized character encoding");return}const n=v.data.subarray(1).indexOf(0);if(n===-1)return;const l=Ht(lo(v.data,1,n)),f=v.data[2+n],c=v.data.subarray(3+n).indexOf(0);if(c===-1)return;const y=Ht(lo(v.data,3+n,c));let S;return l==="-->"?S=Ht(lo(v.data,4+n+c)):S=nE(v.data.subarray(4+n+c)),e.mimeType=l,e.pictureType=f,e.description=y,e.data=S,e}function hE(v){return v.type==="PRIV"?Jy(v):v.type[0]==="W"?tE(v):v.type==="APIC"?uE(v):eE(v)}function fE(v){const e=String.fromCharCode(v[0],v[1],v[2],v[3]),r=wn(v,4),n=10;return{type:e,size:r,data:v.subarray(n,n+r)}}const on=10,dE=10;function Vd(v){let e=0;const r=[];for(;Qo(v,e);){const n=wn(v,e+6);v[e+5]>>6&1&&(e+=on),e+=on;const l=e+n;for(;e+dE<l;){const f=fE(v.subarray(e)),c=hE(f);c&&r.push(c),e+=f.size+on}Fd(v,e)&&(e+=on)}return r}function Hd(v){return v&&v.key==="PRIV"&&v.info==="com.apple.streaming.transportStreamTimestamp"}function cE(v){if(v.data.byteLength===8){const e=new Uint8Array(v.data),r=e[3]&1;let n=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return n/=45,r&&(n+=4772185884e-2),Math.round(n)}}function Jo(v){const e=Vd(v);for(let r=0;r<e.length;r++){const n=e[r];if(Hd(n))return cE(n)}}let Vt=function(v){return v.audioId3="org.id3",v.dateRange="com.apple.quicktime.HLS",v.emsg="https://aomedia.org/emsg/ID3",v.misbklv="urn:misb:KLV:bin:1910.1",v}({});function vr(v="",e=9e4){return{type:v,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class el{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,r,n,l){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,r){return!1}appendFrame(e,r,n){}demux(e,r){this.cachedData&&(e=Qt(this.cachedData,e),this.cachedData=null);let n=ns(e,0),l=n?n.length:0,f;const c=this._audioTrack,y=this._id3Track,S=n?Jo(n):void 0,T=e.length;for((this.basePTS===null||this.frameIndex===0&&Ae(S))&&(this.basePTS=gE(S,r,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),n&&n.length>0&&y.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:Vt.audioId3,duration:Number.POSITIVE_INFINITY});l<T;){if(this.canParse(e,l)){const A=this.appendFrame(c,e,l);A?(this.frameIndex++,this.lastPTS=A.sample.pts,l+=A.length,f=l):l=T}else Zy(e,l)?(n=ns(e,l),y.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:Vt.audioId3,duration:Number.POSITIVE_INFINITY}),l+=n.length,f=l):l++;if(l===T&&f!==T){const A=e.slice(f);this.cachedData?this.cachedData=Qt(this.cachedData,A):this.cachedData=A}}return{audioTrack:c,videoTrack:vr(),id3Track:y,textTrack:vr()}}demuxSampleAes(e,r,n){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const r=this.cachedData;return r&&(this.cachedData=null,this.demux(r,0)),{audioTrack:this._audioTrack,videoTrack:vr(),id3Track:this._id3Track,textTrack:vr()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const gE=(v,e,r)=>{if(Ae(v))return v*90;const n=r?r.baseTime*9e4/r.timescale:0;return e*9e4+n};let ln=null;const vE=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],mE=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],pE=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],yE=[0,1,1,4];function Yd(v,e,r,n,l){if(r+24>e.length)return;const f=Wd(e,r);if(f&&r+f.frameLength<=e.length){const c=f.samplesPerFrame*9e4/f.sampleRate,y=n+l*c,S={unit:e.subarray(r,r+f.frameLength),pts:y,dts:y};return v.config=[],v.channelCount=f.channelCount,v.samplerate=f.sampleRate,v.samples.push(S),{sample:S,length:f.frameLength,missing:0}}}function Wd(v,e){const r=v[e+1]>>3&3,n=v[e+1]>>1&3,l=v[e+2]>>4&15,f=v[e+2]>>2&3;if(r!==1&&l!==0&&l!==15&&f!==3){const c=v[e+2]>>1&1,y=v[e+3]>>6,S=r===3?3-n:n===3?3:4,T=vE[S*14+l-1]*1e3,L=mE[(r===3?0:r===2?1:2)*3+f],b=y===3?1:2,C=pE[r][n],D=yE[n],M=C*8*D,F=Math.floor(C*T/L+c)*D;if(ln===null){const K=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);ln=K?parseInt(K[1]):0}return!!ln&&ln<=87&&n===2&&T>=224e3&&y===0&&(v[e+3]=v[e+3]|128),{sampleRate:L,channelCount:b,frameLength:F,samplesPerFrame:M}}}function tl(v,e){return v[e]===255&&(v[e+1]&224)===224&&(v[e+1]&6)!==0}function qd(v,e){return e+1<v.length&&tl(v,e)}function EE(v,e){return tl(v,e)&&4<=v.length-e}function jd(v,e){if(e+1<v.length&&tl(v,e)){const n=Wd(v,e);let l=4;n!=null&&n.frameLength&&(l=n.frameLength);const f=e+l;return f===v.length||qd(v,f)}return!1}class TE extends el{constructor(e,r){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=r}resetInitSegment(e,r,n,l){super.resetInitSegment(e,r,n,l),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:r,duration:l,inputTimeScale:9e4,dropped:0}}static probe(e,r){if(!e)return!1;const n=ns(e,0);let l=(n==null?void 0:n.length)||0;if(jd(e,l))return!1;for(let f=e.length;l<f;l++)if(zy(e,l))return r.log("ADTS sync word found !"),!0;return!1}canParse(e,r){return Xy(e,r)}appendFrame(e,r,n){Bd(e,this.observer,r,n,e.manifestCodec);const l=$d(e,r,n,this.basePTS,this.frameIndex);if(l&&l.missing===0)return l}}const Xd=(v,e)=>{let r=0,n=5;e+=n;const l=new Uint32Array(1),f=new Uint32Array(1),c=new Uint8Array(1);for(;n>0;){c[0]=v[e];const y=Math.min(n,8),S=8-y;f[0]=4278190080>>>24+S<<S,l[0]=(c[0]&f[0])>>S,r=r?r<<y|l[0]:l[0],e+=1,n-=y}return r};class SE extends el{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,r,n,l){super.resetInitSegment(e,r,n,l),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:r,duration:l,inputTimeScale:9e4,dropped:0}}canParse(e,r){return r+64<e.length}appendFrame(e,r,n){const l=zd(e,r,n,this.basePTS,this.frameIndex);if(l!==-1)return{sample:e.samples[e.samples.length-1],length:l,missing:0}}static probe(e){if(!e)return!1;const r=ns(e,0);if(!r)return!1;const n=r.length;return e[n]===11&&e[n+1]===119&&Jo(r)!==void 0&&Xd(e,n)<16}}function zd(v,e,r,n,l){if(r+8>e.length||e[r]!==11||e[r+1]!==119)return-1;const f=e[r+4]>>6;if(f>=3)return-1;const y=[48e3,44100,32e3][f],S=e[r+4]&63,A=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][S*3+f]*2;if(r+A>e.length)return-1;const L=e[r+6]>>5;let b=0;L===2?b+=2:(L&1&&L!==1&&(b+=2),L&4&&(b+=2));const C=(e[r+6]<<8|e[r+7])>>12-b&1,M=[2,1,2,3,3,4,4,5][L]+C,F=e[r+5]>>3,$=e[r+5]&7,H=new Uint8Array([f<<6|F<<1|$>>2,($&3)<<6|L<<3|C<<2|S>>4,S<<4&224]),K=1536/y*9e4,z=n+l*K,Q=e.subarray(r,r+A);return v.config=H,v.channelCount=M,v.samplerate=y,v.samples.push({unit:Q,pts:z}),A}class AE extends el{resetInitSegment(e,r,n,l){super.resetInitSegment(e,r,n,l),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:r,duration:l,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const r=ns(e,0);let n=(r==null?void 0:r.length)||0;if(r&&e[n]===11&&e[n+1]===119&&Jo(r)!==void 0&&Xd(e,n)<=16)return!1;for(let l=e.length;n<l;n++)if(jd(e,n))return qe.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,r){return EE(e,r)}appendFrame(e,r,n){if(this.basePTS!==null)return Yd(e,r,n,this.basePTS,this.frameIndex)}}const xE=/\/emsg[-/]ID3/i;class LE{constructor(e,r){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=r}resetTimeStamp(){}resetInitSegment(e,r,n,l){const f=this.videoTrack=vr("video",1),c=this.audioTrack=vr("audio",1),y=this.txtTrack=vr("text",1);if(this.id3Track=vr("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const S=hd(e);if(S.video){const{id:T,timescale:A,codec:L,supplemental:b}=S.video;f.id=T,f.timescale=y.timescale=A,f.codec=L,f.supplemental=b}if(S.audio){const{id:T,timescale:A,codec:L}=S.audio;c.id=T,c.timescale=A,c.codec=L}y.id=od.text,f.sampleDuration=0,f.duration=c.duration=l}resetContiguity(){this.remainderData=null}static probe(e){return Sp(e)}demux(e,r){this.timeOffset=r;let n=e;const l=this.videoTrack,f=this.txtTrack;if(this.config.progressive){this.remainderData&&(n=Qt(this.remainderData,e));const y=Dp(n);this.remainderData=y.remainder,l.samples=y.valid||new Uint8Array}else l.samples=n;const c=this.extractID3Track(l,r);return f.samples=jh(r,l),{videoTrack:l,audioTrack:this.audioTrack,id3Track:c,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,r=this.videoTrack,n=this.txtTrack;r.samples=this.remainderData||new Uint8Array,this.remainderData=null;const l=this.extractID3Track(r,this.timeOffset);return n.samples=jh(e,r),{videoTrack:r,audioTrack:vr(),id3Track:l,textTrack:vr()}}extractID3Track(e,r){const n=this.id3Track;if(e.samples.length){const l=Me(e.samples,["emsg"]);l&&l.forEach(f=>{const c=Pp(f);if(xE.test(c.schemeIdUri)){const y=_f(c,r);let S=c.eventDuration===4294967295?Number.POSITIVE_INFINITY:c.eventDuration/c.timeScale;S<=.001&&(S=Number.POSITIVE_INFINITY);const T=c.payload;n.samples.push({data:T,len:T.byteLength,dts:y,pts:y,type:Vt.emsg,duration:S})}else if(this.config.enableEmsgKLVMetadata&&c.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const y=_f(c,r);n.samples.push({data:c.payload,len:c.payload.byteLength,dts:y,pts:y,type:Vt.misbklv,duration:Number.POSITIVE_INFINITY})}})}return n}demuxSampleAes(e,r,n){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function _f(v,e){return Ae(v.presentationTime)?v.presentationTime/v.timeScale:e+v.presentationTimeDelta/v.timeScale}class IE{constructor(e,r,n){this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new Yo(r,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Vr.cbc)}decryptAacSample(e,r,n){const l=e[r].unit;if(l.length<=16)return;const f=l.subarray(16,l.length-l.length%16),c=f.buffer.slice(f.byteOffset,f.byteOffset+f.length);this.decryptBuffer(c).then(y=>{const S=new Uint8Array(y);l.set(S,16),this.decrypter.isSync()||this.decryptAacSamples(e,r+1,n)})}decryptAacSamples(e,r,n){for(;;r++){if(r>=e.length){n();return}if(!(e[r].unit.length<32)&&(this.decryptAacSample(e,r,n),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const r=Math.floor((e.length-48)/160)*16+16,n=new Int8Array(r);let l=0;for(let f=32;f<e.length-16;f+=160,l+=16)n.set(e.subarray(f,f+16),l);return n}getAvcDecryptedUnit(e,r){const n=new Uint8Array(r);let l=0;for(let f=32;f<e.length-16;f+=160,l+=16)e.set(n.subarray(l,l+16),f);return e}decryptAvcSample(e,r,n,l,f){const c=dd(f.data),y=this.getAvcEncryptedData(c);this.decryptBuffer(y.buffer).then(S=>{f.data=this.getAvcDecryptedUnit(c,S),this.decrypter.isSync()||this.decryptAvcSamples(e,r,n+1,l)})}decryptAvcSamples(e,r,n,l){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;r++,n=0){if(r>=e.length){l();return}const f=e[r].units;for(;!(n>=f.length);n++){const c=f[n];if(!(c.data.length<=48||c.type!==1&&c.type!==5)&&(this.decryptAvcSample(e,r,n,l,c),!this.decrypter.isSync()))return}}}}class Qd{constructor(){this.VideoSample=null}createVideoSample(e,r,n){return{key:e,frame:!1,pts:r,dts:n,units:[],length:0}}getLastNalUnit(e){var r;let n=this.VideoSample,l;if((!n||n.units.length===0)&&(n=e[e.length-1]),(r=n)!=null&&r.units){const f=n.units;l=f[f.length-1]}return l}pushAccessUnit(e,r){if(e.units.length&&e.frame){if(e.pts===void 0){const n=r.samples,l=n.length;if(l){const f=n[l-1];e.pts=f.pts,e.dts=f.dts}else{r.dropped++;return}}r.samples.push(e)}}parseNALu(e,r,n){const l=r.byteLength;let f=e.naluState||0;const c=f,y=[];let S=0,T,A,L,b=-1,C=0;for(f===-1&&(b=0,C=this.getNALuType(r,0),f=0,S=1);S<l;){if(T=r[S++],!f){f=T?0:1;continue}if(f===1){f=T?0:2;continue}if(!T)f=3;else if(T===1){if(A=S-f-1,b>=0){const D={data:r.subarray(b,A),type:C};y.push(D)}else{const D=this.getLastNalUnit(e.samples);D&&(c&&S<=4-c&&D.state&&(D.data=D.data.subarray(0,D.data.byteLength-c)),A>0&&(D.data=Qt(D.data,r.subarray(0,A)),D.state=0))}S<l?(L=this.getNALuType(r,S),b=S,C=L,f=0):f=-1}else f=0}if(b>=0&&f>=0){const D={data:r.subarray(b,l),type:C,state:f};y.push(D)}if(y.length===0){const D=this.getLastNalUnit(e.samples);D&&(D.data=Qt(D.data,r))}return e.naluState=f,y}}class Zi{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,r=this.bytesAvailable,n=e.byteLength-r,l=new Uint8Array(4),f=Math.min(4,r);if(f===0)throw new Error("no bytes available");l.set(e.subarray(n,n+f)),this.word=new DataView(l.buffer).getUint32(0),this.bitsAvailable=f*8,this.bytesAvailable-=f}skipBits(e){let r;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,r=e>>3,e-=r<<3,this.bytesAvailable-=r,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let r=Math.min(this.bitsAvailable,e);const n=this.word>>>32-r;if(e>32&&qe.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=r,this.bitsAvailable>0)this.word<<=r;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return r=e-r,r>0&&this.bitsAvailable?n<<r|this.readBits(r):n}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class Df extends Qd{parsePES(e,r,n,l){const f=this.parseNALu(e,n.data,l);let c=this.VideoSample,y,S=!1;n.data=null,c&&f.length&&!e.audFound&&(this.pushAccessUnit(c,e),c=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),f.forEach(T=>{var A,L;switch(T.type){case 1:{let M=!1;y=!0;const F=T.data;if(S&&F.length>4){const $=this.readSliceType(F);($===2||$===4||$===7||$===9)&&(M=!0)}if(M){var b;(b=c)!=null&&b.frame&&!c.key&&(this.pushAccessUnit(c,e),c=this.VideoSample=null)}c||(c=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),c.frame=!0,c.key=M;break}case 5:y=!0,(A=c)!=null&&A.frame&&!c.key&&(this.pushAccessUnit(c,e),c=this.VideoSample=null),c||(c=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),c.key=!0,c.frame=!0;break;case 6:{y=!0,Ko(T.data,1,n.pts,r.samples);break}case 7:{var C,D;y=!0,S=!0;const M=T.data,F=this.readSPS(M);if(!e.sps||e.width!==F.width||e.height!==F.height||((C=e.pixelRatio)==null?void 0:C[0])!==F.pixelRatio[0]||((D=e.pixelRatio)==null?void 0:D[1])!==F.pixelRatio[1]){e.width=F.width,e.height=F.height,e.pixelRatio=F.pixelRatio,e.sps=[M];const $=M.subarray(1,4);let H="avc1.";for(let K=0;K<3;K++){let z=$[K].toString(16);z.length<2&&(z="0"+z),H+=z}e.codec=H}break}case 8:y=!0,e.pps=[T.data];break;case 9:y=!0,e.audFound=!0,(L=c)!=null&&L.frame&&(this.pushAccessUnit(c,e),c=null),c||(c=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts));break;case 12:y=!0;break;default:y=!1;break}c&&y&&c.units.push(T)}),l&&c&&(this.pushAccessUnit(c,e),this.VideoSample=null)}getNALuType(e,r){return e[r]&31}readSliceType(e){const r=new Zi(e);return r.readUByte(),r.readUEG(),r.readUEG()}skipScalingList(e,r){let n=8,l=8,f;for(let c=0;c<e;c++)l!==0&&(f=r.readEG(),l=(n+f+256)%256),n=l===0?n:l}readSPS(e){const r=new Zi(e);let n=0,l=0,f=0,c=0,y,S,T;const A=r.readUByte.bind(r),L=r.readBits.bind(r),b=r.readUEG.bind(r),C=r.readBoolean.bind(r),D=r.skipBits.bind(r),M=r.skipEG.bind(r),F=r.skipUEG.bind(r),$=this.skipScalingList.bind(this);A();const H=A();if(L(5),D(3),A(),F(),H===100||H===110||H===122||H===244||H===44||H===83||H===86||H===118||H===128){const ie=b();if(ie===3&&D(1),F(),F(),D(1),C())for(S=ie!==3?8:12,T=0;T<S;T++)C()&&(T<6?$(16,r):$(64,r))}F();const K=b();if(K===0)b();else if(K===1)for(D(1),M(),M(),y=b(),T=0;T<y;T++)M();F(),D(1);const z=b(),Q=b(),ne=L(1);ne===0&&D(1),D(1),C()&&(n=b(),l=b(),f=b(),c=b());let Z=[1,1];if(C()&&C())switch(A()){case 1:Z=[1,1];break;case 2:Z=[12,11];break;case 3:Z=[10,11];break;case 4:Z=[16,11];break;case 5:Z=[40,33];break;case 6:Z=[24,11];break;case 7:Z=[20,11];break;case 8:Z=[32,11];break;case 9:Z=[80,33];break;case 10:Z=[18,11];break;case 11:Z=[15,11];break;case 12:Z=[64,33];break;case 13:Z=[160,99];break;case 14:Z=[4,3];break;case 15:Z=[3,2];break;case 16:Z=[2,1];break;case 255:{Z=[A()<<8|A(),A()<<8|A()];break}}return{width:Math.ceil((z+1)*16-n*2-l*2),height:(2-ne)*(Q+1)*16-(ne?2:4)*(f+c),pixelRatio:Z}}}class Cf extends Qd{constructor(...e){super(...e),this.initVPS=null}parsePES(e,r,n,l){const f=this.parseNALu(e,n.data,l);let c=this.VideoSample,y,S=!1;n.data=null,c&&f.length&&!e.audFound&&(this.pushAccessUnit(c,e),c=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),f.forEach(T=>{var A,L;switch(T.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:c||(c=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),c.frame=!0,y=!0;break;case 16:case 17:case 18:case 21:if(y=!0,S){var b;(b=c)!=null&&b.frame&&!c.key&&(this.pushAccessUnit(c,e),c=this.VideoSample=null)}c||(c=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),c.key=!0,c.frame=!0;break;case 19:case 20:y=!0,(A=c)!=null&&A.frame&&!c.key&&(this.pushAccessUnit(c,e),c=this.VideoSample=null),c||(c=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),c.key=!0,c.frame=!0;break;case 39:y=!0,Ko(T.data,2,n.pts,r.samples);break;case 32:y=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=rt(e.params,this.readVPS(T.data)),this.initVPS=T.data),e.vps=[T.data];break;case 33:if(y=!0,S=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],T.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const C=this.readSPS(T.data);e.width=C.width,e.height=C.height,e.pixelRatio=C.pixelRatio,e.codec=C.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const D in C.params)e.params[D]=C.params[D]}this.pushParameterSet(e.sps,T.data,e.vps),c||(c=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts)),c.key=!0;break;case 34:if(y=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const C=this.readPPS(T.data);for(const D in C)e.params[D]=C[D]}this.pushParameterSet(e.pps,T.data,e.vps)}break;case 35:y=!0,e.audFound=!0,(L=c)!=null&&L.frame&&(this.pushAccessUnit(c,e),c=null),c||(c=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts));break;default:y=!1;break}c&&y&&c.units.push(T)}),l&&c&&(this.pushAccessUnit(c,e),this.VideoSample=null)}pushParameterSet(e,r,n){(n&&n[0]===this.initVPS||!n&&!e.length)&&e.push(r)}getNALuType(e,r){return(e[r]&126)>>>1}ebsp2rbsp(e){const r=new Uint8Array(e.byteLength);let n=0;for(let l=0;l<e.byteLength;l++)l>=2&&e[l]===3&&e[l-1]===0&&e[l-2]===0||(r[n]=e[l],n++);return new Uint8Array(r.buffer,0,n)}pushAccessUnit(e,r){super.pushAccessUnit(e,r),this.initVPS&&(this.initVPS=null)}readVPS(e){const r=new Zi(e);r.readUByte(),r.readUByte(),r.readBits(4),r.skipBits(2),r.readBits(6);const n=r.readBits(3),l=r.readBoolean();return{numTemporalLayers:n+1,temporalIdNested:l}}readSPS(e){const r=new Zi(this.ebsp2rbsp(e));r.readUByte(),r.readUByte(),r.readBits(4);const n=r.readBits(3);r.readBoolean();const l=r.readBits(2),f=r.readBoolean(),c=r.readBits(5),y=r.readUByte(),S=r.readUByte(),T=r.readUByte(),A=r.readUByte(),L=r.readUByte(),b=r.readUByte(),C=r.readUByte(),D=r.readUByte(),M=r.readUByte(),F=r.readUByte(),$=r.readUByte(),H=[],K=[];for(let Ue=0;Ue<n;Ue++)H.push(r.readBoolean()),K.push(r.readBoolean());if(n>0)for(let Ue=n;Ue<8;Ue++)r.readBits(2);for(let Ue=0;Ue<n;Ue++)H[Ue]&&(r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte(),r.readUByte()),K[Ue]&&r.readUByte();r.readUEG();const z=r.readUEG();z==3&&r.skipBits(1);const Q=r.readUEG(),ne=r.readUEG(),Z=r.readBoolean();let ie=0,le=0,ee=0,ve=0;Z&&(ie+=r.readUEG(),le+=r.readUEG(),ee+=r.readUEG(),ve+=r.readUEG());const Ee=r.readUEG(),Ne=r.readUEG(),Ce=r.readUEG(),_e=r.readBoolean();for(let Ue=_e?0:n;Ue<=n;Ue++)r.skipUEG(),r.skipUEG(),r.skipUEG();if(r.skipUEG(),r.skipUEG(),r.skipUEG(),r.skipUEG(),r.skipUEG(),r.skipUEG(),r.readBoolean()&&r.readBoolean())for(let bt=0;bt<4;bt++)for(let Nt=0;Nt<(bt===3?2:6);Nt++)if(!r.readBoolean())r.readUEG();else{const dt=Math.min(64,1<<4+(bt<<1));bt>1&&r.readEG();for(let sr=0;sr<dt;sr++)r.readEG()}r.readBoolean(),r.readBoolean(),r.readBoolean()&&(r.readUByte(),r.skipUEG(),r.skipUEG(),r.readBoolean());const Re=r.readUEG();let me=0;for(let Ue=0;Ue<Re;Ue++){let bt=!1;if(Ue!==0&&(bt=r.readBoolean()),bt){Ue===Re&&r.readUEG(),r.readBoolean(),r.readUEG();let Nt=0;for(let mt=0;mt<=me;mt++){const dt=r.readBoolean();let sr=!1;dt||(sr=r.readBoolean()),(dt||sr)&&Nt++}me=Nt}else{const Nt=r.readUEG(),mt=r.readUEG();me=Nt+mt;for(let dt=0;dt<Nt;dt++)r.readUEG(),r.readBoolean();for(let dt=0;dt<mt;dt++)r.readUEG(),r.readBoolean()}}if(r.readBoolean()){const Ue=r.readUEG();for(let bt=0;bt<Ue;bt++){for(let Nt=0;Nt<Ce+4;Nt++)r.readBits(1);r.readBits(1)}}let q=0,k=1,Te=1,pe=!0,Ke=1,et=0;r.readBoolean(),r.readBoolean();let st=!1;if(r.readBoolean()){if(r.readBoolean()){const Ve=r.readUByte(),ki=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],ct=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Ve>0&&Ve<16?(k=ki[Ve-1],Te=ct[Ve-1]):Ve===255&&(k=r.readBits(16),Te=r.readBits(16))}if(r.readBoolean()&&r.readBoolean(),r.readBoolean()&&(r.readBits(3),r.readBoolean(),r.readBoolean()&&(r.readUByte(),r.readUByte(),r.readUByte())),r.readBoolean()&&(r.readUEG(),r.readUEG()),r.readBoolean(),r.readBoolean(),r.readBoolean(),st=r.readBoolean(),st&&(ie+=r.readUEG(),le+=r.readUEG(),ee+=r.readUEG(),ve+=r.readUEG()),r.readBoolean()&&(Ke=r.readBits(32),et=r.readBits(32),r.readBoolean()&&r.readUEG(),r.readBoolean())){const ct=r.readBoolean(),ni=r.readBoolean();let Yr=!1;(ct||ni)&&(Yr=r.readBoolean(),Yr&&(r.readUByte(),r.readBits(5),r.readBoolean(),r.readBits(5)),r.readBits(4),r.readBits(4),Yr&&r.readBits(4),r.readBits(5),r.readBits(5),r.readBits(5));for(let wi=0;wi<=n;wi++){pe=r.readBoolean();const Mn=pe||r.readBoolean();let Wr=!1;Mn?r.readEG():Wr=r.readBoolean();const us=Wr?1:r.readUEG()+1;if(ct)for(let Pr=0;Pr<us;Pr++)r.readUEG(),r.readUEG(),Yr&&(r.readUEG(),r.readUEG()),r.skipBits(1);if(ni)for(let Pr=0;Pr<us;Pr++)r.readUEG(),r.readUEG(),Yr&&(r.readUEG(),r.readUEG()),r.skipBits(1)}}r.readBoolean()&&(r.readBoolean(),r.readBoolean(),r.readBoolean(),q=r.readUEG())}let ir=Q,ii=ne;if(Z||st){let Ue=1,bt=1;z===1?Ue=bt=2:z==2&&(Ue=2),ir=Q-Ue*le-Ue*ie,ii=ne-bt*ve-bt*ee}const On=l?["A","B","C"][l]:"",ls=y<<24|S<<16|T<<8|A;let Hr=0;for(let Ue=0;Ue<32;Ue++)Hr=(Hr|(ls>>Ue&1)<<31-Ue)>>>0;let si=Hr.toString(16);return c===1&&si==="2"&&(si="6"),{codecString:`hvc1.${On}${c}.${si}.${f?"H":"L"}${$}.B0`,params:{general_tier_flag:f,general_profile_idc:c,general_profile_space:l,general_profile_compatibility_flags:[y,S,T,A],general_constraint_indicator_flags:[L,b,C,D,M,F],general_level_idc:$,bit_depth:Ee+8,bit_depth_luma_minus8:Ee,bit_depth_chroma_minus8:Ne,min_spatial_segmentation_idc:q,chroma_format_idc:z,frame_rate:{fixed:pe,fps:et/Ke}},width:ir,height:ii,pixelRatio:[k,Te]}}readPPS(e){const r=new Zi(this.ebsp2rbsp(e));r.readUByte(),r.readUByte(),r.skipUEG(),r.skipUEG(),r.skipBits(2),r.skipBits(3),r.skipBits(2),r.skipUEG(),r.skipUEG(),r.skipEG(),r.skipBits(2),r.readBoolean()&&r.skipUEG(),r.skipEG(),r.skipEG(),r.skipBits(4);const l=r.readBoolean(),f=r.readBoolean();let c=1;return f&&l?c=0:f?c=3:l&&(c=2),{parallelismType:c}}matchSPS(e,r){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,r).substr(3)}}const Ct=188;class $r{constructor(e,r,n,l){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=r,this.typeSupported=n,this.logger=l,this.videoParser=null}static probe(e,r){const n=$r.syncOffset(e);return n>0&&r.warn(`MPEG2-TS detected but first sync word found @ offset ${n}`),n!==-1}static syncOffset(e){const r=e.length;let n=Math.min(Ct*5,r-Ct)+1,l=0;for(;l<n;){let f=!1,c=-1,y=0;for(let S=l;S<r;S+=Ct)if(e[S]===71&&(r-S===Ct||e[S+Ct]===71)){if(y++,c===-1&&(c=S,c!==0&&(n=Math.min(c+Ct*99,e.length-Ct)+1)),f||(f=Co(e,S)===0),f&&y>1&&(c===0&&y>2||S+Ct>n))return c}else{if(y)return-1;break}l++}return-1}static createTrack(e,r){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:od[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?r:void 0}}resetInitSegment(e,r,n,l){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=$r.createTrack("video"),this._videoTrack.duration=l,this._audioTrack=$r.createTrack("audio",l),this._id3Track=$r.createTrack("id3"),this._txtTrack=$r.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=r,this.videoCodec=n}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:r,_id3Track:n}=this;e&&(e.pesData=null),r&&(r.pesData=null),n&&(n.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,r,n=!1,l=!1){n||(this.sampleAes=null);let f;const c=this._videoTrack,y=this._audioTrack,S=this._id3Track,T=this._txtTrack;let A=c.pid,L=c.pesData,b=y.pid,C=S.pid,D=y.pesData,M=S.pesData,F=null,$=this.pmtParsed,H=this._pmtId,K=e.length;if(this.remainderData&&(e=Qt(this.remainderData,e),K=e.length,this.remainderData=null),K<Ct&&!l)return this.remainderData=e,{audioTrack:y,videoTrack:c,id3Track:S,textTrack:T};const z=Math.max(0,$r.syncOffset(e));K-=(K-z)%Ct,K<e.byteLength&&!l&&(this.remainderData=new Uint8Array(e.buffer,K,e.buffer.byteLength-K));let Q=0;for(let Z=z;Z<K;Z+=Ct)if(e[Z]===71){const ie=!!(e[Z+1]&64),le=Co(e,Z),ee=(e[Z+3]&48)>>4;let ve;if(ee>1){if(ve=Z+5+e[Z+4],ve===Z+Ct)continue}else ve=Z+4;switch(le){case A:if(ie){if(L&&(f=xi(L,this.logger))){if(this.videoParser===null)switch(c.segmentCodec){case"avc":this.videoParser=new Df;break;case"hevc":this.videoParser=new Cf;break}this.videoParser!==null&&this.videoParser.parsePES(c,T,f,!1)}L={data:[],size:0}}L&&(L.data.push(e.subarray(ve,Z+Ct)),L.size+=Z+Ct-ve);break;case b:if(ie){if(D&&(f=xi(D,this.logger)))switch(y.segmentCodec){case"aac":this.parseAACPES(y,f);break;case"mp3":this.parseMPEGPES(y,f);break;case"ac3":this.parseAC3PES(y,f);break}D={data:[],size:0}}D&&(D.data.push(e.subarray(ve,Z+Ct)),D.size+=Z+Ct-ve);break;case C:ie&&(M&&(f=xi(M,this.logger))&&this.parseID3PES(S,f),M={data:[],size:0}),M&&(M.data.push(e.subarray(ve,Z+Ct)),M.size+=Z+Ct-ve);break;case 0:ie&&(ve+=e[ve]+1),H=this._pmtId=RE(e,ve);break;case H:{ie&&(ve+=e[ve]+1);const Ee=bE(e,ve,this.typeSupported,n,this.observer,this.logger);A=Ee.videoPid,A>0&&(c.pid=A,c.segmentCodec=Ee.segmentVideoCodec),b=Ee.audioPid,b>0&&(y.pid=b,y.segmentCodec=Ee.segmentAudioCodec),C=Ee.id3Pid,C>0&&(S.pid=C),F!==null&&!$&&(this.logger.warn(`MPEG-TS PMT found at ${Z} after unknown PID '${F}'. Backtracking to sync byte @${z} to parse all TS packets.`),F=null,Z=z-188),$=this.pmtParsed=!0;break}case 17:case 8191:break;default:F=le;break}}else Q++;Q>0&&Po(this.observer,new Error(`Found ${Q} TS packet/s that do not start with 0x47`),void 0,this.logger),c.pesData=L,y.pesData=D,S.pesData=M;const ne={audioTrack:y,videoTrack:c,id3Track:S,textTrack:T};return l&&this.extractRemainingSamples(ne),ne}flush(){const{remainderData:e}=this;this.remainderData=null;let r;return e?r=this.demux(e,-1,!1,!0):r={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(r),this.sampleAes?this.decrypt(r,this.sampleAes):r}extractRemainingSamples(e){const{audioTrack:r,videoTrack:n,id3Track:l,textTrack:f}=e,c=n.pesData,y=r.pesData,S=l.pesData;let T;if(c&&(T=xi(c,this.logger))){if(this.videoParser===null)switch(n.segmentCodec){case"avc":this.videoParser=new Df;break;case"hevc":this.videoParser=new Cf;break}this.videoParser!==null&&(this.videoParser.parsePES(n,f,T,!0),n.pesData=null)}else n.pesData=c;if(y&&(T=xi(y,this.logger))){switch(r.segmentCodec){case"aac":this.parseAACPES(r,T);break;case"mp3":this.parseMPEGPES(r,T);break;case"ac3":this.parseAC3PES(r,T);break}r.pesData=null}else y!=null&&y.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),r.pesData=y;S&&(T=xi(S,this.logger))?(this.parseID3PES(l,T),l.pesData=null):l.pesData=S}demuxSampleAes(e,r,n){const l=this.demux(e,n,!0,!this.config.progressive),f=this.sampleAes=new IE(this.observer,this.config,r);return this.decrypt(l,f)}decrypt(e,r){return new Promise(n=>{const{audioTrack:l,videoTrack:f}=e;l.samples&&l.segmentCodec==="aac"?r.decryptAacSamples(l.samples,0,()=>{f.samples?r.decryptAvcSamples(f.samples,0,0,()=>{n(e)}):n(e)}):f.samples&&r.decryptAvcSamples(f.samples,0,0,()=>{n(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,r){let n=0;const l=this.aacOverFlow;let f=r.data;if(l){this.aacOverFlow=null;const L=l.missing,b=l.sample.unit.byteLength;if(L===-1)f=Qt(l.sample.unit,f);else{const C=b-L;l.sample.unit.set(f.subarray(0,L),C),e.samples.push(l.sample),n=l.missing}}let c,y;for(c=n,y=f.length;c<y-1&&!Cn(f,c);c++);if(c!==n){let L;const b=c<y-1;if(b?L=`AAC PES did not start with ADTS header,offset:${c}`:L="No ADTS header found in AAC PES",Po(this.observer,new Error(L),b,this.logger),!b)return}Bd(e,this.observer,f,c,this.audioCodec);let S;if(r.pts!==void 0)S=r.pts;else if(l){const L=Gd(e.samplerate);S=l.sample.pts+L}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let T=0,A;for(;c<y;)if(A=$d(e,f,c,S,T),c+=A.length,A.missing){this.aacOverFlow=A;break}else for(T++;c<y-1&&!Cn(f,c);c++);}parseMPEGPES(e,r){const n=r.data,l=n.length;let f=0,c=0;const y=r.pts;if(y===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;c<l;)if(qd(n,c)){const S=Yd(e,n,c,y,f);if(S)c+=S.length,f++;else break}else c++}parseAC3PES(e,r){{const n=r.data,l=r.pts;if(l===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const f=n.length;let c=0,y=0,S;for(;y<f&&(S=zd(e,n,y,l,c++))>0;)y+=S}}parseID3PES(e,r){if(r.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const n=rt({},r,{type:this._videoTrack?Vt.emsg:Vt.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(n)}}function Co(v,e){return((v[e+1]&31)<<8)+v[e+2]}function RE(v,e){return(v[e+10]&31)<<8|v[e+11]}function bE(v,e,r,n,l,f){const c={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},y=(v[e+1]&15)<<8|v[e+2],S=e+3+y-4,T=(v[e+10]&15)<<8|v[e+11];for(e+=12+T;e<S;){const A=Co(v,e),L=(v[e+3]&15)<<8|v[e+4];switch(v[e]){case 207:if(!n){uo("ADTS AAC",f);break}case 15:c.audioPid===-1&&(c.audioPid=A);break;case 21:c.id3Pid===-1&&(c.id3Pid=A);break;case 219:if(!n){uo("H.264",f);break}case 27:c.videoPid===-1&&(c.videoPid=A);break;case 3:case 4:!r.mpeg&&!r.mp3?f.log("MPEG audio found, not supported in this browser"):c.audioPid===-1&&(c.audioPid=A,c.segmentAudioCodec="mp3");break;case 193:if(!n){uo("AC-3",f);break}case 129:r.ac3?c.audioPid===-1&&(c.audioPid=A,c.segmentAudioCodec="ac3"):f.log("AC-3 audio found, not supported in this browser");break;case 6:if(c.audioPid===-1&&L>0){let b=e+5,C=L;for(;C>2;){switch(v[b]){case 106:r.ac3!==!0?f.log("AC-3 audio found, not supported in this browser for now"):(c.audioPid=A,c.segmentAudioCodec="ac3");break}const M=v[b+1]+2;b+=M,C-=M}}break;case 194:case 135:return Po(l,new Error("Unsupported EC-3 in M2TS found"),void 0,f),c;case 36:c.videoPid===-1&&(c.videoPid=A,c.segmentVideoCodec="hevc",f.log("HEVC in M2TS found"));break}e+=L+5}return c}function Po(v,e,r,n){n.warn(`parsing error: ${e.message}`),v.emit(w.ERROR,w.ERROR,{type:De.MEDIA_ERROR,details:re.FRAG_PARSING_ERROR,fatal:!1,levelRetry:r,error:e,reason:e.message})}function uo(v,e){e.log(`${v} with AES-128-CBC encryption found in unencrypted stream`)}function xi(v,e){let r=0,n,l,f,c,y;const S=v.data;if(!v||v.size===0)return null;for(;S[0].length<19&&S.length>1;)S[0]=Qt(S[0],S[1]),S.splice(1,1);if(n=S[0],(n[0]<<16)+(n[1]<<8)+n[2]===1){if(l=(n[4]<<8)+n[5],l&&l>v.size-6)return null;const A=n[7];A&192&&(c=(n[9]&14)*536870912+(n[10]&255)*4194304+(n[11]&254)*16384+(n[12]&255)*128+(n[13]&254)/2,A&64?(y=(n[14]&14)*536870912+(n[15]&255)*4194304+(n[16]&254)*16384+(n[17]&255)*128+(n[18]&254)/2,c-y>60*9e4&&(e.warn(`${Math.round((c-y)/9e4)}s delta between PTS and DTS, align them`),c=y)):y=c),f=n[8];let L=f+9;if(v.size<=L)return null;v.size-=L;const b=new Uint8Array(v.size);for(let C=0,D=S.length;C<D;C++){n=S[C];let M=n.byteLength;if(L)if(L>M){L-=M;continue}else n=n.subarray(L),M-=L,L=0;b.set(n,r),r+=M}return l&&(l-=f+3),{data:b,pts:c,dts:y,len:l}}return null}class _E{static getSilentFrame(e,r){switch(e){case"mp4a.40.2":if(r===1)return new Uint8Array([0,200,0,128,35,128]);if(r===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(r===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(r===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(r===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(r===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(r===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(r===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(r===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Ur=Math.pow(2,32)-1;class te{static init(){te.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in te.types)te.types.hasOwnProperty(e)&&(te.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const r=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);te.HDLR_TYPES={video:r,audio:n};const l=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),f=new Uint8Array([0,0,0,0,0,0,0,0]);te.STTS=te.STSC=te.STCO=f,te.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),te.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),te.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),te.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const c=new Uint8Array([105,115,111,109]),y=new Uint8Array([97,118,99,49]),S=new Uint8Array([0,0,0,1]);te.FTYP=te.box(te.types.ftyp,c,S,c,y),te.DINF=te.box(te.types.dinf,te.box(te.types.dref,l))}static box(e,...r){let n=8,l=r.length;const f=l;for(;l--;)n+=r[l].byteLength;const c=new Uint8Array(n);for(c[0]=n>>24&255,c[1]=n>>16&255,c[2]=n>>8&255,c[3]=n&255,c.set(e,4),l=0,n=8;l<f;l++)c.set(r[l],n),n+=r[l].byteLength;return c}static hdlr(e){return te.box(te.types.hdlr,te.HDLR_TYPES[e])}static mdat(e){return te.box(te.types.mdat,e)}static mdhd(e,r){r*=e;const n=Math.floor(r/(Ur+1)),l=Math.floor(r%(Ur+1));return te.box(te.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,n>>24,n>>16&255,n>>8&255,n&255,l>>24,l>>16&255,l>>8&255,l&255,85,196,0,0]))}static mdia(e){return te.box(te.types.mdia,te.mdhd(e.timescale||0,e.duration||0),te.hdlr(e.type),te.minf(e))}static mfhd(e){return te.box(te.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?te.box(te.types.minf,te.box(te.types.smhd,te.SMHD),te.DINF,te.stbl(e)):te.box(te.types.minf,te.box(te.types.vmhd,te.VMHD),te.DINF,te.stbl(e))}static moof(e,r,n){return te.box(te.types.moof,te.mfhd(e),te.traf(n,r))}static moov(e){let r=e.length;const n=[];for(;r--;)n[r]=te.trak(e[r]);return te.box.apply(null,[te.types.moov,te.mvhd(e[0].timescale||0,e[0].duration||0)].concat(n).concat(te.mvex(e)))}static mvex(e){let r=e.length;const n=[];for(;r--;)n[r]=te.trex(e[r]);return te.box.apply(null,[te.types.mvex,...n])}static mvhd(e,r){r*=e;const n=Math.floor(r/(Ur+1)),l=Math.floor(r%(Ur+1)),f=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,n>>24,n>>16&255,n>>8&255,n&255,l>>24,l>>16&255,l>>8&255,l&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return te.box(te.types.mvhd,f)}static sdtp(e){const r=e.samples||[],n=new Uint8Array(4+r.length);let l,f;for(l=0;l<r.length;l++)f=r[l].flags,n[l+4]=f.dependsOn<<4|f.isDependedOn<<2|f.hasRedundancy;return te.box(te.types.sdtp,n)}static stbl(e){return te.box(te.types.stbl,te.stsd(e),te.box(te.types.stts,te.STTS),te.box(te.types.stsc,te.STSC),te.box(te.types.stsz,te.STSZ),te.box(te.types.stco,te.STCO))}static avc1(e){let r=[],n=[],l,f,c;for(l=0;l<e.sps.length;l++)f=e.sps[l],c=f.byteLength,r.push(c>>>8&255),r.push(c&255),r=r.concat(Array.prototype.slice.call(f));for(l=0;l<e.pps.length;l++)f=e.pps[l],c=f.byteLength,n.push(c>>>8&255),n.push(c&255),n=n.concat(Array.prototype.slice.call(f));const y=te.box(te.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|e.sps.length].concat(r).concat([e.pps.length]).concat(n))),S=e.width,T=e.height,A=e.pixelRatio[0],L=e.pixelRatio[1];return te.box(te.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,S>>8&255,S&255,T>>8&255,T&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),y,te.box(te.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),te.box(te.types.pasp,new Uint8Array([A>>24,A>>16&255,A>>8&255,A&255,L>>24,L>>16&255,L>>8&255,L&255])))}static esds(e){const r=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...r,6,1,2])}static audioStsd(e){const r=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,r>>8&255,r&255,0,0])}static mp4a(e){return te.box(te.types.mp4a,te.audioStsd(e),te.box(te.types.esds,te.esds(e)))}static mp3(e){return te.box(te.types[".mp3"],te.audioStsd(e))}static ac3(e){return te.box(te.types["ac-3"],te.audioStsd(e),te.box(te.types.dac3,e.config))}static stsd(e){const{segmentCodec:r}=e;if(e.type==="audio"){if(r==="aac")return te.box(te.types.stsd,te.STSD,te.mp4a(e));if(r==="ac3"&&e.config)return te.box(te.types.stsd,te.STSD,te.ac3(e));if(r==="mp3"&&e.codec==="mp3")return te.box(te.types.stsd,te.STSD,te.mp3(e))}else if(e.pps&&e.sps){if(r==="avc")return te.box(te.types.stsd,te.STSD,te.avc1(e));if(r==="hevc"&&e.vps)return te.box(te.types.stsd,te.STSD,te.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${r}/${e.codec})`)}static tkhd(e){const r=e.id,n=(e.duration||0)*(e.timescale||0),l=e.width||0,f=e.height||0,c=Math.floor(n/(Ur+1)),y=Math.floor(n%(Ur+1));return te.box(te.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,r>>24&255,r>>16&255,r>>8&255,r&255,0,0,0,0,c>>24,c>>16&255,c>>8&255,c&255,y>>24,y>>16&255,y>>8&255,y&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,l>>8&255,l&255,0,0,f>>8&255,f&255,0,0]))}static traf(e,r){const n=te.sdtp(e),l=e.id,f=Math.floor(r/(Ur+1)),c=Math.floor(r%(Ur+1));return te.box(te.types.traf,te.box(te.types.tfhd,new Uint8Array([0,0,0,0,l>>24,l>>16&255,l>>8&255,l&255])),te.box(te.types.tfdt,new Uint8Array([1,0,0,0,f>>24,f>>16&255,f>>8&255,f&255,c>>24,c>>16&255,c>>8&255,c&255])),te.trun(e,n.length+16+20+8+16+8+8),n)}static trak(e){return e.duration=e.duration||4294967295,te.box(te.types.trak,te.tkhd(e),te.mdia(e))}static trex(e){const r=e.id;return te.box(te.types.trex,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,r){const n=e.samples||[],l=n.length,f=12+16*l,c=new Uint8Array(f);let y,S,T,A,L,b;for(r+=8+f,c.set([e.type==="video"?1:0,0,15,1,l>>>24&255,l>>>16&255,l>>>8&255,l&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255],0),y=0;y<l;y++)S=n[y],T=S.duration,A=S.size,L=S.flags,b=S.cts,c.set([T>>>24&255,T>>>16&255,T>>>8&255,T&255,A>>>24&255,A>>>16&255,A>>>8&255,A&255,L.isLeading<<2|L.dependsOn,L.isDependedOn<<6|L.hasRedundancy<<4|L.paddingValue<<1|L.isNonSync,L.degradPrio&61440,L.degradPrio&15,b>>>24&255,b>>>16&255,b>>>8&255,b&255],12+16*y);return te.box(te.types.trun,c)}static initSegment(e){te.types||te.init();const r=te.moov(e);return Qt(te.FTYP,r)}static hvc1(e){const r=e.params,n=[e.vps,e.sps,e.pps],l=4,f=new Uint8Array([1,r.general_profile_space<<6|(r.general_tier_flag?32:0)|r.general_profile_idc,r.general_profile_compatibility_flags[0],r.general_profile_compatibility_flags[1],r.general_profile_compatibility_flags[2],r.general_profile_compatibility_flags[3],r.general_constraint_indicator_flags[0],r.general_constraint_indicator_flags[1],r.general_constraint_indicator_flags[2],r.general_constraint_indicator_flags[3],r.general_constraint_indicator_flags[4],r.general_constraint_indicator_flags[5],r.general_level_idc,240|r.min_spatial_segmentation_idc>>8,255&r.min_spatial_segmentation_idc,252|r.parallelismType,252|r.chroma_format_idc,248|r.bit_depth_luma_minus8,248|r.bit_depth_chroma_minus8,0,parseInt(r.frame_rate.fps),l-1|r.temporal_id_nested<<2|r.num_temporal_layers<<3|(r.frame_rate.fixed?64:0),n.length]);let c=f.length;for(let D=0;D<n.length;D+=1){c+=3;for(let M=0;M<n[D].length;M+=1)c+=2+n[D][M].length}const y=new Uint8Array(c);y.set(f,0),c=f.length;const S=n.length-1;for(let D=0;D<n.length;D+=1){y.set(new Uint8Array([32+D|(D===S?128:0),0,n[D].length]),c),c+=3;for(let M=0;M<n[D].length;M+=1)y.set(new Uint8Array([n[D][M].length>>8,n[D][M].length&255]),c),c+=2,y.set(n[D][M],c),c+=n[D][M].length}const T=te.box(te.types.hvcC,y),A=e.width,L=e.height,b=e.pixelRatio[0],C=e.pixelRatio[1];return te.box(te.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,A>>8&255,A&255,L>>8&255,L&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),T,te.box(te.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),te.box(te.types.pasp,new Uint8Array([b>>24,b>>16&255,b>>8&255,b&255,C>>24,C>>16&255,C>>8&255,C&255])))}}te.types=void 0;te.HDLR_TYPES=void 0;te.STTS=void 0;te.STSC=void 0;te.STCO=void 0;te.STSZ=void 0;te.VMHD=void 0;te.SMHD=void 0;te.STSD=void 0;te.FTYP=void 0;te.DINF=void 0;const Zd=9e4;function rl(v,e,r=1,n=!1){const l=v*e*r;return n?Math.round(l):l}function DE(v,e,r=1,n=!1){return rl(v,e,1/r,n)}function Xi(v,e=!1){return rl(v,1e3,1/Zd,e)}function CE(v,e=1){return rl(v,Zd,1/e)}const PE=10*1e3,kE=1024,wE=1152,OE=1536;let Li=null,ho=null;function Pf(v,e,r,n){return{duration:e,size:r,cts:n,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:v?2:1,isNonSync:v?0:1}}}class mn{constructor(e,r,n,l){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=r,this.typeSupported=n,this.logger=l,this.ISGenerated=!1,Li===null){const c=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Li=c?parseInt(c[1]):0}if(ho===null){const f=navigator.userAgent.match(/Safari\/(\d+)/i);ho=f?parseInt(f[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let r=!1;const n=e[0].pts,l=e.reduce((f,c)=>{let y=c.pts,S=y-f;return S<-4294967296&&(r=!0,y=zt(y,n),S=y-f),S>0?f:y},n);return r&&this.logger.debug("PTS rollover detected"),l}remux(e,r,n,l,f,c,y,S){let T,A,L,b,C,D,M=f,F=f;const $=e.pid>-1,H=r.pid>-1,K=r.samples.length,z=e.samples.length>0,Q=y&&K>0||K>1;if((!$||z)&&(!H||Q)||this.ISGenerated||y){if(this.ISGenerated){var Z,ie,le,ee;const Ce=this.videoTrackConfig;(Ce&&(r.width!==Ce.width||r.height!==Ce.height||((Z=r.pixelRatio)==null?void 0:Z[0])!==((ie=Ce.pixelRatio)==null?void 0:ie[0])||((le=r.pixelRatio)==null?void 0:le[1])!==((ee=Ce.pixelRatio)==null?void 0:ee[1]))||!Ce&&Q||this.nextAudioPts===null&&z)&&this.resetInitSegment()}this.ISGenerated||(L=this.generateIS(e,r,f,c));const ve=this.isVideoContiguous;let Ee=-1,Ne;if(Q&&(Ee=ME(r.samples),!ve&&this.config.forceKeyFrameOnDiscontinuity))if(D=!0,Ee>0){this.logger.warn(`[mp4-remuxer]: Dropped ${Ee} out of ${K} video samples due to a missing keyframe`);const Ce=this.getVideoStartPts(r.samples);r.samples=r.samples.slice(Ee),r.dropped+=Ee,F+=(r.samples[0].pts-Ce)/r.inputTimeScale,Ne=F}else Ee===-1&&(this.logger.warn(`[mp4-remuxer]: No keyframe found out of ${K} video samples`),D=!1);if(this.ISGenerated){if(z&&Q){const Ce=this.getVideoStartPts(r.samples),xe=(zt(e.samples[0].pts,Ce)-Ce)/r.inputTimeScale;M+=Math.max(0,xe),F+=Math.max(0,-xe)}if(z){if(e.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),L=this.generateIS(e,r,f,c)),A=this.remuxAudio(e,M,this.isAudioContiguous,c,H||Q||S===be.AUDIO?F:void 0),Q){const Ce=A?A.endPTS-A.startPTS:0;r.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),L=this.generateIS(e,r,f,c)),T=this.remuxVideo(r,F,ve,Ce)}}else Q&&(T=this.remuxVideo(r,F,ve,0));T&&(T.firstKeyFrame=Ee,T.independent=Ee!==-1,T.firstKeyFramePTS=Ne)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(n.samples.length&&(C=Jd(n,f,this._initPTS,this._initDTS)),l.samples.length&&(b=ec(l,f,this._initPTS))),{audio:A,video:T,initSegment:L,independent:D,text:b,id3:C}}generateIS(e,r,n,l){const f=e.samples,c=r.samples,y=this.typeSupported,S={},T=this._initPTS;let A=!T||l,L="audio/mp4",b,C,D;if(A&&(b=C=1/0),e.config&&f.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":y.mpeg?(L="audio/mpeg",e.codec=""):y.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}S.audio={id:"audio",container:L,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&y.mpeg?new Uint8Array(0):te.initSegment([e]),metadata:{channelCount:e.channelCount}},A&&(D=e.inputTimeScale,!T||D!==T.timescale?b=C=f[0].pts-Math.round(D*n):A=!1)}if(r.sps&&r.pps&&c.length){if(r.timescale=r.inputTimeScale,S.video={id:"main",container:"video/mp4",codec:r.codec,initSegment:te.initSegment([r]),metadata:{width:r.width,height:r.height}},A)if(D=r.inputTimeScale,!T||D!==T.timescale){const M=this.getVideoStartPts(c),F=Math.round(D*n);C=Math.min(C,zt(c[0].dts,M)-F),b=Math.min(b,M-F)}else A=!1;this.videoTrackConfig={width:r.width,height:r.height,pixelRatio:r.pixelRatio}}if(Object.keys(S).length)return this.ISGenerated=!0,A?(this._initPTS={baseTime:b,timescale:D},this._initDTS={baseTime:C,timescale:D}):b=D=void 0,{tracks:S,initPTS:b,timescale:D}}remuxVideo(e,r,n,l){const f=e.inputTimeScale,c=e.samples,y=[],S=c.length,T=this._initPTS;let A=this.nextAvcDts,L=8,b=this.videoSampleDuration,C,D,M=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,$=!1;if(!n||A===null){const me=r*f,se=c[0].pts-zt(c[0].dts,c[0].pts);Li&&A!==null&&Math.abs(me-se-A)<15e3?n=!0:A=me-se}const H=T.baseTime*f/T.timescale;for(let me=0;me<S;me++){const se=c[me];se.pts=zt(se.pts-H,A),se.dts=zt(se.dts-H,A),se.dts<c[me>0?me-1:me].dts&&($=!0)}$&&c.sort(function(me,se){const q=me.dts-se.dts,k=me.pts-se.pts;return q||k}),C=c[0].dts,D=c[c.length-1].dts;const K=D-C,z=K?Math.round(K/(S-1)):b||e.inputTimeScale/30;if(n){const me=C-A,se=me>z,q=me<-1;if((se||q)&&(se?this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Xi(me,!0)} ms (${me}dts) hole between fragments detected at ${r.toFixed(3)}`):this.logger.warn(`${(e.segmentCodec||"").toUpperCase()}: ${Xi(-me,!0)} ms (${me}dts) overlapping between fragments detected at ${r.toFixed(3)}`),!q||A>=c[0].pts||Li)){C=A;const k=c[0].pts-me;if(se)c[0].dts=C,c[0].pts=k;else{let Te=!0;for(let pe=0;pe<c.length&&!(c[pe].dts>k&&Te);pe++){const Ke=c[pe].pts;if(c[pe].dts-=me,c[pe].pts-=me,pe<c.length-1){const et=c[pe+1].pts,st=c[pe].pts,lt=et<=st,ir=et<=Ke;Te=lt==ir}}}this.logger.log(`Video: Initial PTS/DTS adjusted: ${Xi(k,!0)}/${Xi(C,!0)}, delta: ${Xi(me,!0)} ms`)}}C=Math.max(0,C);let Q=0,ne=0,Z=C;for(let me=0;me<S;me++){const se=c[me],q=se.units,k=q.length;let Te=0;for(let pe=0;pe<k;pe++)Te+=q[pe].data.length;ne+=Te,Q+=k,se.length=Te,se.dts<Z?(se.dts=Z,Z+=z/4|0||1):Z=se.dts,M=Math.min(se.pts,M),F=Math.max(se.pts,F)}D=c[S-1].dts;const ie=ne+4*Q+8;let le;try{le=new Uint8Array(ie)}catch(me){this.observer.emit(w.ERROR,w.ERROR,{type:De.MUX_ERROR,details:re.REMUX_ALLOC_ERROR,fatal:!1,error:me,bytes:ie,reason:`fail allocating video mdat ${ie}`});return}const ee=new DataView(le.buffer);ee.setUint32(0,ie),le.set(te.types.mdat,4);let ve=!1,Ee=Number.POSITIVE_INFINITY,Ne=Number.POSITIVE_INFINITY,Ce=Number.NEGATIVE_INFINITY,_e=Number.NEGATIVE_INFINITY;for(let me=0;me<S;me++){const se=c[me],q=se.units;let k=0;for(let Ke=0,et=q.length;Ke<et;Ke++){const st=q[Ke],lt=st.data,ir=st.data.byteLength;ee.setUint32(L,ir),L+=4,le.set(lt,L),L+=ir,k+=4+ir}let Te;if(me<S-1)b=c[me+1].dts-se.dts,Te=c[me+1].pts-se.pts;else{const Ke=this.config,et=me>0?se.dts-c[me-1].dts:z;if(Te=me>0?se.pts-c[me-1].pts:z,Ke.stretchShortVideoTrack&&this.nextAudioPts!==null){const st=Math.floor(Ke.maxBufferHole*f),lt=(l?M+l*f:this.nextAudioPts)-se.pts;lt>st?(b=lt-et,b<0?b=et:ve=!0,this.logger.log(`[mp4-remuxer]: It is approximately ${lt/90} ms to the next segment; using duration ${b/90} ms for the last video frame.`)):b=et}else b=et}const pe=Math.round(se.pts-se.dts);Ee=Math.min(Ee,b),Ce=Math.max(Ce,b),Ne=Math.min(Ne,Te),_e=Math.max(_e,Te),y.push(Pf(se.key,b,k,pe))}if(y.length){if(Li){if(Li<70){const me=y[0].flags;me.dependsOn=2,me.isNonSync=0}}else if(ho&&_e-Ne<Ce-Ee&&z/Ce<.025&&y[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let me=C;for(let se=0,q=y.length;se<q;se++){const k=me+y[se].duration,Te=me+y[se].cts;if(se<q-1){const pe=k+y[se+1].cts;y[se].duration=pe-Te}else y[se].duration=se?y[se-1].duration:z;y[se].cts=0,me=k}}}b=ve||!b?z:b,this.nextAvcDts=A=D+b,this.videoSampleDuration=b,this.isVideoContiguous=!0;const Re={data1:te.moof(e.sequenceNumber++,C,rt(e,{samples:y})),data2:le,startPTS:M/f,endPTS:(F+b)/f,startDTS:C/f,endDTS:A/f,type:"video",hasAudio:!1,hasVideo:!0,nb:y.length,dropped:e.dropped};return e.samples=[],e.dropped=0,Re}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return wE;case"ac3":return OE;default:return kE}}remuxAudio(e,r,n,l,f){const c=e.inputTimeScale,y=e.samplerate?e.samplerate:c,S=c/y,T=this.getSamplesPerFrame(e),A=T*S,L=this._initPTS,b=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,C=[],D=f!==void 0;let M=e.samples,F=b?0:8,$=this.nextAudioPts||-1;const H=r*c,K=L.baseTime*c/L.timescale;if(this.isAudioContiguous=n=n||M.length&&$>0&&(l&&Math.abs(H-$)<9e3||Math.abs(zt(M[0].pts-K,H)-$)<20*A),M.forEach(function(xe){xe.pts=zt(xe.pts-K,H)}),!n||$<0){if(M=M.filter(xe=>xe.pts>=0),!M.length)return;f===0?$=0:l&&!D?$=Math.max(0,H):$=M[0].pts}if(e.segmentCodec==="aac"){const xe=this.config.maxAudioFramesDrift;for(let ue=0,Re=$;ue<M.length;ue++){const me=M[ue],se=me.pts,q=se-Re,k=Math.abs(1e3*q/c);if(q<=-xe*A&&D)ue===0&&(this.logger.warn(`Audio frame @ ${(se/c).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*q/c)} ms.`),this.nextAudioPts=$=Re=se);else if(q>=xe*A&&k<PE&&D){let Te=Math.round(q/A);Re=se-Te*A,Re<0&&(Te--,Re+=A),ue===0&&(this.nextAudioPts=$=Re),this.logger.warn(`[mp4-remuxer]: Injecting ${Te} audio frame @ ${(Re/c).toFixed(3)}s due to ${Math.round(1e3*q/c)} ms gap.`);for(let pe=0;pe<Te;pe++){const Ke=Math.max(Re,0);let et=_E.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);et||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),et=me.unit.subarray()),M.splice(ue,0,{unit:et,pts:Ke}),Re+=A,ue++}}me.pts=Re,Re+=A}}let z=null,Q=null,ne,Z=0,ie=M.length;for(;ie--;)Z+=M[ie].unit.byteLength;for(let xe=0,ue=M.length;xe<ue;xe++){const Re=M[xe],me=Re.unit;let se=Re.pts;if(Q!==null){const k=C[xe-1];k.duration=Math.round((se-Q)/S)}else if(n&&e.segmentCodec==="aac"&&(se=$),z=se,Z>0){Z+=F;try{ne=new Uint8Array(Z)}catch(k){this.observer.emit(w.ERROR,w.ERROR,{type:De.MUX_ERROR,details:re.REMUX_ALLOC_ERROR,fatal:!1,error:k,bytes:Z,reason:`fail allocating audio mdat ${Z}`});return}b||(new DataView(ne.buffer).setUint32(0,Z),ne.set(te.types.mdat,4))}else return;ne.set(me,F);const q=me.byteLength;F+=q,C.push(Pf(!0,T,q,0)),Q=se}const le=C.length;if(!le)return;const ee=C[C.length-1];this.nextAudioPts=$=Q+S*ee.duration;const ve=b?new Uint8Array(0):te.moof(e.sequenceNumber++,z/S,rt({},e,{samples:C}));e.samples=[];const Ee=z/c,Ne=$/c,_e={data1:ve,data2:ne,startPTS:Ee,endPTS:Ne,startDTS:Ee,endDTS:Ne,type:"audio",hasAudio:!0,hasVideo:!1,nb:le};return this.isAudioContiguous=!0,_e}}function zt(v,e){let r;if(e===null)return v;for(e<v?r=-8589934592:r=8589934592;Math.abs(v-e)>4294967296;)v+=r;return v}function ME(v){for(let e=0;e<v.length;e++)if(v[e].key)return e;return-1}function Jd(v,e,r,n){const l=v.samples.length;if(!l)return;const f=v.inputTimeScale;for(let y=0;y<l;y++){const S=v.samples[y];S.pts=zt(S.pts-r.baseTime*f/r.timescale,e*f)/f,S.dts=zt(S.dts-n.baseTime*f/n.timescale,e*f)/f}const c=v.samples;return v.samples=[],{samples:c}}function ec(v,e,r){const n=v.samples.length;if(!n)return;const l=v.inputTimeScale;for(let c=0;c<n;c++){const y=v.samples[c];y.pts=zt(y.pts-r.baseTime*l/r.timescale,e*l)/l}v.samples.sort((c,y)=>c.pts-y.pts);const f=v.samples;return v.samples=[],{samples:f}}class FE{constructor(e,r,n,l){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.logger=l}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,r,n,l){this.audioCodec=r,this.videoCodec=n,this.generateInitSegment(Lp(e,l)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:r,videoCodec:n}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const l=this.initData=hd(e);l.audio&&(r=kf(l.audio,tt.AUDIO)),l.video&&(n=kf(l.video,tt.VIDEO));const f={};l.audio&&l.video?f.audiovideo={container:"video/mp4",codec:r+","+n,supplemental:l.video.supplemental,initSegment:e,id:"main"}:l.audio?f.audio={container:"audio/mp4",codec:r,initSegment:e,id:"audio"}:l.video?f.video={container:"video/mp4",codec:n,supplemental:l.video.supplemental,initSegment:e,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=f}remux(e,r,n,l,f,c){var y,S;let{initPTS:T,lastEndTime:A}=this;const L={audio:void 0,video:void 0,text:l,id3:n,initSegment:void 0};Ae(A)||(A=this.lastEndTime=f||0);const b=r.samples;if(!(b!=null&&b.length))return L;const C={initPTS:void 0,timescale:1};let D=this.initData;if((y=D)!=null&&y.length||(this.generateInitSegment(b),D=this.initData),!((S=D)!=null&&S.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),L;this.emitInitSegment&&(C.tracks=this.initTracks,this.emitInitSegment=!1);const M=Rp(b,D),F=Ip(D,b),$=F===null?f:F;(c||!T)&&(NE(T,$,f,M)||C.timescale!==T.timescale)&&(C.initPTS=$-f,T&&T.timescale===1&&this.logger.warn(`Adjusting initPTS @${f} from ${T.baseTime/T.timescale} to ${C.initPTS}`),this.initPTS=T={baseTime:C.initPTS,timescale:1});const H=e?$-T.baseTime/T.timescale:A,K=H+M;_p(D,b,T.baseTime/T.timescale),M>0?this.lastEndTime=K:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const z=!!D.audio,Q=!!D.video;let ne="";z&&(ne+="audio"),Q&&(ne+="video");const Z={data1:b,startPTS:H,startDTS:H,endPTS:K,endDTS:K,type:ne,hasAudio:z,hasVideo:Q,nb:1,dropped:0};return L.audio=Z.type==="audio"?Z:void 0,L.video=Z.type!=="audio"?Z:void 0,L.initSegment=C,L.id3=Jd(n,f,T,T),l.samples.length&&(L.text=ec(l,f,T)),L}}function NE(v,e,r,n){if(v===null)return!0;const l=Math.max(n,1),f=e-v.baseTime/v.timescale;return Math.abs(f-r)>l}function kf(v,e){const r=v==null?void 0:v.codec;return r&&r.length>4?r:e===tt.AUDIO?r==="ec-3"||r==="ac-3"||r==="alac"?r:r==="fLaC"||r==="Opus"?xn(r,!1):(qe.warn(`Unhandled audio codec "${r}" in mp4 MAP`),r||"mp4a"):(qe.warn(`Unhandled video codec "${r}" in mp4 MAP`),r||"avc1")}let _r;try{_r=self.performance.now.bind(self.performance)}catch{_r=Date.now}const pn=[{demux:LE,remux:FE},{demux:$r,remux:mn},{demux:TE,remux:mn},{demux:AE,remux:mn}];pn.splice(2,0,{demux:SE,remux:mn});class wf{constructor(e,r,n,l,f,c){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=r,this.config=n,this.id=f,this.logger=c}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,r,n,l){const f=n.transmuxing;f.executeStart=_r();let c=new Uint8Array(e);const{currentTransmuxState:y,transmuxConfig:S}=this;l&&(this.currentTransmuxState=l);const{contiguous:T,discontinuity:A,trackSwitch:L,accurateTimeOffset:b,timeOffset:C,initSegmentChange:D}=l||y,{audioCodec:M,videoCodec:F,defaultInitPts:$,duration:H,initSegmentData:K}=S,z=UE(c,r);if(z&&Ri(z.method)){const ie=this.getDecrypter(),le=qo(z.method);if(ie.isSync()){let ee=ie.softwareDecrypt(c,z.key.buffer,z.iv.buffer,le);if(n.part>-1){const Ee=ie.flush();ee=Ee&&Ee.buffer}if(!ee)return f.executeEnd=_r(),fo(n);c=new Uint8Array(ee)}else return this.asyncResult=!0,this.decryptionPromise=ie.webCryptoDecrypt(c,z.key.buffer,z.iv.buffer,le).then(ee=>{const ve=this.push(ee,null,n);return this.decryptionPromise=null,ve}),this.decryptionPromise}const Q=this.needsProbing(A,L);if(Q){const ie=this.configureTransmuxer(c);if(ie)return this.logger.warn(`[transmuxer] ${ie.message}`),this.observer.emit(w.ERROR,w.ERROR,{type:De.MEDIA_ERROR,details:re.FRAG_PARSING_ERROR,fatal:!1,error:ie,reason:ie.message}),f.executeEnd=_r(),fo(n)}(A||L||D||Q)&&this.resetInitSegment(K,M,F,H,r),(A||D||Q)&&this.resetInitialTimestamp($),T||this.resetContiguity();const ne=this.transmux(c,z,C,b,n);this.asyncResult=as(ne);const Z=this.currentTransmuxState;return Z.contiguous=!0,Z.discontinuity=!1,Z.trackSwitch=!1,f.executeEnd=_r(),ne}flush(e){const r=e.transmuxing;r.executeStart=_r();const{decrypter:n,currentTransmuxState:l,decryptionPromise:f}=this;if(f)return this.asyncResult=!0,f.then(()=>this.flush(e));const c=[],{timeOffset:y}=l;if(n){const L=n.flush();L&&c.push(this.push(L.buffer,null,e))}const{demuxer:S,remuxer:T}=this;if(!S||!T){r.executeEnd=_r();const L=[fo(e)];return this.asyncResult?Promise.resolve(L):L}const A=S.flush(y);return as(A)?(this.asyncResult=!0,A.then(L=>(this.flushRemux(c,L,e),c))):(this.flushRemux(c,A,e),this.asyncResult?Promise.resolve(c):c)}flushRemux(e,r,n){const{audioTrack:l,videoTrack:f,id3Track:c,textTrack:y}=r,{accurateTimeOffset:S,timeOffset:T}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${n.sn}${n.part>-1?" part: "+n.part:""} of ${this.id===be.MAIN?"level":"track"} ${n.level}`);const A=this.remuxer.remux(l,f,c,y,T,S,!0,this.id);e.push({remuxResult:A,chunkMeta:n}),n.transmuxing.executeEnd=_r()}resetInitialTimestamp(e){const{demuxer:r,remuxer:n}=this;!r||!n||(r.resetTimeStamp(e),n.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:r}=this;!e||!r||(e.resetContiguity(),r.resetNextTimestamp())}resetInitSegment(e,r,n,l,f){const{demuxer:c,remuxer:y}=this;!c||!y||(c.resetInitSegment(e,r,n,l),y.resetInitSegment(e,r,n,f))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,r,n,l,f){let c;return r&&r.method==="SAMPLE-AES"?c=this.transmuxSampleAes(e,r,n,l,f):c=this.transmuxUnencrypted(e,n,l,f),c}transmuxUnencrypted(e,r,n,l){const{audioTrack:f,videoTrack:c,id3Track:y,textTrack:S}=this.demuxer.demux(e,r,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(f,c,y,S,r,n,!1,this.id),chunkMeta:l}}transmuxSampleAes(e,r,n,l,f){return this.demuxer.demuxSampleAes(e,r,n).then(c=>({remuxResult:this.remuxer.remux(c.audioTrack,c.videoTrack,c.id3Track,c.textTrack,n,l,!1,this.id),chunkMeta:f}))}configureTransmuxer(e){const{config:r,observer:n,typeSupported:l}=this;let f;for(let L=0,b=pn.length;L<b;L++){var c;if((c=pn[L].demux)!=null&&c.probe(e,this.logger)){f=pn[L];break}}if(!f)return new Error("Failed to find demuxer by probing fragment data");const y=this.demuxer,S=this.remuxer,T=f.remux,A=f.demux;(!S||!(S instanceof T))&&(this.remuxer=new T(n,r,l,this.logger)),(!y||!(y instanceof A))&&(this.demuxer=new A(n,r,l,this.logger),this.probe=A.probe)}needsProbing(e,r){return!this.demuxer||!this.remuxer||e||r}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new Yo(this.config)),e}}function UE(v,e){let r=null;return v.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(r=e),r}const fo=v=>({remuxResult:{},chunkMeta:v});function as(v){return"then"in v&&v.then instanceof Function}class BE{constructor(e,r,n,l,f){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=r,this.initSegmentData=n,this.duration=l,this.defaultInitPts=f||null}}class GE{constructor(e,r,n,l,f,c){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=r,this.accurateTimeOffset=n,this.trackSwitch=l,this.timeOffset=f,this.initSegmentChange=c}}let Of=0;class tc{constructor(e,r,n,l){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=Of++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=S=>{const T=S.data,A=this.hls;if(!(!A||!(T!=null&&T.event)||T.instanceNo!==this.instanceNo))switch(T.event){case"init":{var L;const b=(L=this.workerContext)==null?void 0:L.objectURL;b&&self.URL.revokeObjectURL(b);break}case"transmuxComplete":{this.handleTransmuxComplete(T.data);break}case"flush":{this.onFlush(T.data);break}case"workerLog":{A.logger[T.data.logType]&&A.logger[T.data.logType](T.data.message);break}default:{T.data=T.data||{},T.data.frag=this.frag,T.data.part=this.part,T.data.id=this.id,A.trigger(T.event,T.data);break}}},this.onWorkerError=S=>{if(!this.hls)return;const T=new Error(`${S.message}  (${S.filename}:${S.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:T})};const f=e.config;this.hls=e,this.id=r,this.useWorker=!!f.enableWorker,this.onTransmuxComplete=n,this.onFlush=l;const c=(S,T)=>{T=T||{},T.frag=this.frag||void 0,S===w.ERROR&&(T=T,T.parent=this.id,T.part=this.part,this.error=T.error),this.hls.trigger(S,T)};this.observer=new zo,this.observer.on(w.FRAG_DECRYPTED,c),this.observer.on(w.ERROR,c);const y=zh(f.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const S=this.hls.logger;if(f.workerPath||Vy()){try{f.workerPath?(S.log(`loading Web Worker ${f.workerPath} for "${r}"`),this.workerContext=Yy(f.workerPath)):(S.log(`injecting Web Worker for "${r}"`),this.workerContext=Hy());const{worker:A}=this.workerContext;A.addEventListener("message",this.onWorkerMessage),A.addEventListener("error",this.onWorkerError),A.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:y,id:r,config:ot(f)})}catch(A){S.warn(`Error setting up "${r}" Web Worker, fallback to inline`,A),this.terminateWorker(),this.error=null,this.transmuxer=new wf(this.observer,y,f,"",r,e.logger)}return}}this.transmuxer=new wf(this.observer,y,f,"",r,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=Of++;const r=this.hls.config,n=zh(r.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:n,id:this.id,config:ot(r)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),Wy(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const r=this.transmuxer;r&&(r.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,r,n,l,f,c,y,S,T,A){var L,b;T.transmuxing.start=self.performance.now();const{instanceNo:C,transmuxer:D}=this,M=c?c.start:f.start,F=f.decryptdata,$=this.frag,H=!($&&f.cc===$.cc),K=!($&&T.level===$.level),z=$?T.sn-$.sn:-1,Q=this.part?T.part-this.part.index:-1,ne=z===0&&T.id>1&&T.id===($==null?void 0:$.stats.chunkCount),Z=!K&&(z===1||z===0&&(Q===1||ne&&Q<=0)),ie=self.performance.now();(K||z||f.stats.parsing.start===0)&&(f.stats.parsing.start=ie),c&&(Q||!Z)&&(c.stats.parsing.start=ie);const le=!($&&((L=f.initSegment)==null?void 0:L.url)===((b=$.initSegment)==null?void 0:b.url)),ee=new GE(H,Z,S,K,M,le);if(!Z||H||le){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${f.type} sn: ${T.sn}${T.part>-1?" part: "+T.part:""} ${this.id===be.MAIN?"level":"track"}: ${T.level} id: ${T.id}
        discontinuity: ${H}
        trackSwitch: ${K}
        contiguous: ${Z}
        accurateTimeOffset: ${S}
        timeOffset: ${M}
        initSegmentChange: ${le}`);const ve=new BE(n,l,r,y,A);this.configureTransmuxer(ve)}if(this.frag=f,this.part=c,this.workerContext)this.workerContext.worker.postMessage({instanceNo:C,cmd:"demux",data:e,decryptdata:F,chunkMeta:T,state:ee},e instanceof ArrayBuffer?[e]:[]);else if(D){const ve=D.push(e,F,T,ee);as(ve)?ve.then(Ee=>{this.handleTransmuxComplete(Ee)}).catch(Ee=>{this.transmuxerError(Ee,T,"transmuxer-interface push error")}):this.handleTransmuxComplete(ve)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:r,transmuxer:n}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:r,cmd:"flush",chunkMeta:e});else if(n){const l=n.flush(e);as(l)?l.then(f=>{this.handleFlushResult(f,e)}).catch(f=>{this.transmuxerError(f,e,"transmuxer-interface flush error")}):this.handleFlushResult(l,e)}}transmuxerError(e,r,n){this.hls&&(this.error=e,this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.FRAG_PARSING_ERROR,chunkMeta:r,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:n}))}handleFlushResult(e,r){e.forEach(n=>{this.handleTransmuxComplete(n)}),this.onFlush(r)}configureTransmuxer(e){const{instanceNo:r,transmuxer:n}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:r,cmd:"configure",config:e}):n&&n.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const Mf=100;class $E extends Xo{constructor(e,r,n){super(e,r,n,"audio-stream-controller",be.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(w.LEVEL_LOADED,this.onLevelLoaded,this),e.on(w.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(w.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(w.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(w.BUFFER_RESET,this.onBufferReset,this),e.on(w.BUFFER_CREATED,this.onBufferCreated,this),e.on(w.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(w.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(w.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(w.FRAG_LOADING,this.onFragLoading,this),e.on(w.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(w.LEVEL_LOADED,this.onLevelLoaded,this),e.off(w.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(w.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(w.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(w.BUFFER_RESET,this.onBufferReset,this),e.off(w.BUFFER_CREATED,this.onBufferCreated,this),e.off(w.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(w.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(w.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(w.FRAG_LOADING,this.onFragLoading,this),e.off(w.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:r,id:n,initPTS:l,timescale:f}){if(n===be.MAIN){const c=r.cc,y=this.fragCurrent;if(this.initPTS[c]={baseTime:l,timescale:f},this.log(`InitPTS for cc: ${c} found from main: ${l}/${f}`),this.mainAnchor=r,this.state===de.WAITING_INIT_PTS){const S=this.waitingData;(!S&&!this.loadingParts||S&&S.frag.cc!==c)&&(this.nextLoadPosition=this.findSyncFrag(r).start),this.tick()}else!this.hls.hasEnoughToStart&&y&&y.cc!==c?(this.startFragRequested=!1,this.nextLoadPosition=this.findSyncFrag(r).start,y.abortRequests(),this.resetLoadingState()):this.state===de.IDLE&&this.tick()}}findSyncFrag(e){const r=this.getLevelDetails(),n=e.cc;return iy(r,n,e)||r&&Sd(r.fragments,n)||e}startLoad(e,r){if(!this.levels){this.startPosition=e,this.state=de.STOPPED;return}const n=this.lastCurrentTime;this.stopLoad(),this.setInterval(Mf),n>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${n.toFixed(3)}`),e=n,this.state=de.IDLE):this.state=de.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=r?-1:e,this.tick()}doTick(){switch(this.state){case de.IDLE:this.doTickIdle();break;case de.WAITING_TRACK:{const{levels:r,trackId:n}=this,l=r==null?void 0:r[n],f=l==null?void 0:l.details;if(f&&!this.waitForLive(l)){if(this.waitForCdnTuneIn(f))break;this.state=de.WAITING_INIT_PTS}break}case de.FRAG_LOADING_WAITING_RETRY:{var e;const r=performance.now(),n=this.retryDate;if(!n||r>=n||(e=this.media)!=null&&e.seeking){const{levels:l,trackId:f}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((l==null?void 0:l[f])||null),this.state=de.IDLE}break}case de.WAITING_INIT_PTS:{const r=this.waitingData;if(r){const{frag:n,part:l,cache:f,complete:c}=r,y=this.mainAnchor;if(this.initPTS[n.cc]!==void 0){this.waitingData=null,this.state=de.FRAG_LOADING;const S=f.flush().buffer,T={frag:n,part:l,payload:S,networkDetails:null};this._handleFragmentLoadProgress(T),c&&super._handleFragmentLoadComplete(T)}else y&&y.cc!==r.frag.cc&&(this.log(`Waiting fragment cc (${n.cc}) cancelled because video is at cc ${y.cc}`),this.nextLoadPosition=this.findSyncFrag(y).start,this.clearWaitingFragment())}else this.state=de.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.state!==de.STOPPED&&(this.state=de.IDLE))}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:r,levels:n,media:l,trackId:f}=this,c=r.config;if(!this.buffering||!l&&!this.primaryPrefetch&&(this.startFragRequested||!c.startFragPrefetch)||!(n!=null&&n[f]))return;const y=n[f],S=y.details;if(!S||this.waitForLive(y)||this.waitForCdnTuneIn(S)){this.state=de.WAITING_TRACK,this.startFragRequested=!1;return}const T=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&T&&(this.bufferFlushed=!1,this.afterBufferFlushed(T,tt.AUDIO,be.AUDIO));const A=this.getFwdBufferInfo(T,be.AUDIO);if(A===null)return;if(!this.switchingTrack&&this._streamEnded(A,S)){r.trigger(w.BUFFER_EOS,{type:"audio"}),this.state=de.ENDED;return}const L=A.len,b=r.maxBufferLength,C=S.fragments,D=C[0].start,M=this.getLoadPosition(),F=this.flushing?M:A.end;if(this.switchingTrack&&l){const K=M;S.PTSKnown&&K<D&&(A.end>D||A.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),l.currentTime=D+.05)}if(L>=b&&!this.switchingTrack&&F<C[C.length-1].start)return;let $=this.getNextFragment(F,S);if($&&this.isLoopLoading($,F)&&($=this.getNextFragmentLoopLoading($,S,A,be.MAIN,b)),!$){this.bufferFlushed=!0;return}let H=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&H&&wt($)&&!$.endList&&(!S.live||!this.loadingParts&&F<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(H)===Rt.OK&&(this.mainFragLoading=H=null),H&&wt(H))){if($.start>H.end){const z=this.fragmentTracker.getFragAtPos(F,be.MAIN);z&&z.end>H.end&&(H=z,this.mainFragLoading={frag:z,targetBufferTime:null})}if($.start>H.end)return}this.loadFragment($,y,F)}onMediaDetaching(e,r){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,r)}onAudioTracksUpdated(e,{audioTracks:r}){this.resetTransmuxer(),this.levels=r.map(n=>new ts(n))}onAudioTrackSwitching(e,r){const n=!!r.url;this.trackId=r.id;const{fragCurrent:l}=this;l&&(l.abortRequests(),this.removeUnbufferedFrags(l.start)),this.resetLoadingState(),n?(this.switchingTrack=r,this.flushAudioIfNeeded(r),this.state!==de.STOPPED&&(this.setInterval(Mf),this.state=de.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=r,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,r){this.mainDetails=r.details;const n=this.cachedTrackLoadedData;n&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(w.AUDIO_TRACK_LOADED,n))}onAudioTrackLoaded(e,r){var n;const{levels:l}=this,{details:f,id:c,groupId:y,track:S}=r;if(!l){this.warn(`Audio tracks reset while loading track ${c} "${S.name}" of "${y}"`);return}const T=this.mainDetails;if(!T||f.endCC>T.endCC||T.expired){this.cachedTrackLoadedData=r,this.state!==de.STOPPED&&(this.state=de.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${c} "${S.name}" of "${y}" loaded [${f.startSN},${f.endSN}]${f.lastPartSn?`[part-${f.lastPartSn}-${f.lastPartIndex}]`:""},duration:${f.totalduration}`);const A=l[c];let L=0;if(f.live||(n=A.details)!=null&&n.live){if(this.checkLiveUpdate(f),f.deltaUpdateFailed)return;if(A.details){var b;L=this.alignPlaylists(f,A.details,(b=this.levelLastLoaded)==null?void 0:b.details)}f.alignedSliding||(Od(f,T),f.alignedSliding||Dn(f,T),L=f.fragmentStart)}A.details=f,this.levelLastLoaded=A,this.startFragRequested||this.setStartPosition(T,L),this.hls.trigger(w.AUDIO_TRACK_UPDATED,{details:f,id:c,groupId:r.groupId}),this.state===de.WAITING_TRACK&&!this.waitForCdnTuneIn(f)&&(this.state=de.IDLE),this.tick()}_handleFragmentLoadProgress(e){var r;const n=e.frag,{part:l,payload:f}=e,{config:c,trackId:y,levels:S}=this;if(!S){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);return}const T=S[y];if(!T){this.warn("Audio track is undefined on fragment load progress");return}const A=T.details;if(!A){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(n.start);return}const L=c.defaultAudioCodec||T.audioCodec||"mp4a.40.2";let b=this.transmuxer;b||(b=this.transmuxer=new tc(this.hls,be.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const C=this.initPTS[n.cc],D=(r=n.initSegment)==null?void 0:r.data;if(C!==void 0){const F=l?l.index:-1,$=F!==-1,H=new Wo(n.level,n.sn,n.stats.chunkCount,f.byteLength,F,$);b.push(f,D,L,"",n,l,A.totalduration,!1,H,C)}else{this.log(`Unknown video PTS for cc ${n.cc}, waiting for video PTS before demuxing audio frag ${n.sn} of [${A.startSN} ,${A.endSN}],track ${y}`);const{cache:M}=this.waitingData=this.waitingData||{frag:n,part:l,cache:new Md,complete:!1};M.push(new Uint8Array(f)),this.state!==de.STOPPED&&(this.state=de.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,r){this.bufferFlushed=this.flushing=!1;const n=r.tracks.audio;n&&(this.mediaBuffer=n.buffer||null)}onFragLoading(e,r){!this.audioOnly&&r.frag.type===be.MAIN&&wt(r.frag)&&(this.mainFragLoading=r,this.state===de.IDLE&&this.tick())}onFragBuffered(e,r){const{frag:n,part:l}=r;if(n.type!==be.AUDIO){!this.audioOnly&&n.type===be.MAIN&&!n.elementaryStreams.video&&!n.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(n)){this.warn(`Fragment ${n.sn}${l?" p: "+l.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(wt(n)){this.fragPrevious=n;const f=this.switchingTrack;f&&(this.bufferedTrack=f,this.switchingTrack=null,this.hls.trigger(w.AUDIO_TRACK_SWITCHED,Ze({},f)))}this.fragBufferedComplete(n,l),this.media&&this.tick()}onError(e,r){var n;if(r.fatal){this.state=de.ERROR;return}switch(r.details){case re.FRAG_GAP:case re.FRAG_PARSING_ERROR:case re.FRAG_DECRYPT_ERROR:case re.FRAG_LOAD_ERROR:case re.FRAG_LOAD_TIMEOUT:case re.KEY_LOAD_ERROR:case re.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(be.AUDIO,r);break;case re.AUDIO_TRACK_LOAD_ERROR:case re.AUDIO_TRACK_LOAD_TIMEOUT:case re.LEVEL_PARSING_ERROR:!r.levelRetry&&this.state===de.WAITING_TRACK&&((n=r.context)==null?void 0:n.type)===$e.AUDIO_TRACK&&(this.state=de.IDLE);break;case re.BUFFER_ADD_CODEC_ERROR:case re.BUFFER_APPEND_ERROR:if(r.parent!=="audio")return;this.resetLoadingState();break;case re.BUFFER_FULL_ERROR:if(r.parent!=="audio")return;this.reduceLengthAndFlushBuffer(r)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case re.INTERNAL_EXCEPTION:this.recoverWorkerError(r);break}}onBufferFlushing(e,{type:r}){r!==tt.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:r}){if(r!==tt.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===de.ENDED&&(this.state=de.IDLE);const n=this.mediaBuffer||this.media;n&&(this.afterBufferFlushed(n,r,be.AUDIO),this.tick())}}_handleTransmuxComplete(e){var r;const n="audio",{hls:l}=this,{remuxResult:f,chunkMeta:c}=e,y=this.getCurrentContext(c);if(!y){this.resetWhenMissingContext(c);return}const{frag:S,part:T,level:A}=y,{details:L}=A,{audio:b,text:C,id3:D,initSegment:M}=f;if(this.fragContextChanged(S)||!L){this.fragmentTracker.removeFragment(S);return}if(this.state=de.PARSING,this.switchingTrack&&b&&this.completeAudioSwitch(this.switchingTrack),M!=null&&M.tracks){const F=S.initSegment||S;this._bufferInitSegment(A,M.tracks,F,c),l.trigger(w.FRAG_PARSING_INIT_SEGMENT,{frag:F,id:n,tracks:M.tracks})}if(b){const{startPTS:F,endPTS:$,startDTS:H,endDTS:K}=b;T&&(T.elementaryStreams[tt.AUDIO]={startPTS:F,endPTS:$,startDTS:H,endDTS:K}),S.setElementaryStreamInfo(tt.AUDIO,F,$,H,K),this.bufferFragmentData(b,S,T,c)}if(D!=null&&(r=D.samples)!=null&&r.length){const F=rt({id:n,frag:S,details:L},D);l.trigger(w.FRAG_PARSING_METADATA,F)}if(C){const F=rt({id:n,frag:S,details:L},C);l.trigger(w.FRAG_PARSING_USERDATA,F)}}_bufferInitSegment(e,r,n,l){if(this.state!==de.PARSING||(r.video&&delete r.video,r.audiovideo&&delete r.audiovideo,!r.audio))return;const f=r.audio;f.id=be.AUDIO;const c=e.audioCodec;this.log(`Init audio buffer, container:${f.container}, codecs[level/parsed]=[${c}/${f.codec}]`),c&&c.split(",").length===1&&(f.levelCodec=c),this.hls.trigger(w.BUFFER_CODECS,r);const y=f.initSegment;if(y!=null&&y.byteLength){const S={type:"audio",frag:n,part:null,chunkMeta:l,parent:n.type,data:y};this.hls.trigger(w.BUFFER_APPENDING,S)}this.tickImmediate()}loadFragment(e,r,n){const l=this.fragmentTracker.getState(e);if(this.switchingTrack||l===Rt.NOT_LOADED||l===Rt.PARTIAL){var f;if(!wt(e))this._loadInitSegment(e,r);else if((f=r.details)!=null&&f.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=de.WAITING_INIT_PTS;const c=this.mainDetails;c&&c.fragmentStart!==r.details.fragmentStart&&Dn(r.details,c)}else super.loadFragment(e,r,n)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:r,lang:n,assocLang:l,characteristics:f,audioCodec:c,channels:y}=this.bufferedTrack;ti({name:r,lang:n,assocLang:l,characteristics:f,audioCodec:c,channels:y},e,Jr)||(In(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:r}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,r.trigger(w.AUDIO_TRACK_SWITCHED,Ze({},e))}}class il extends Cr{constructor(e,r){super(r,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,r,n){const l=r==null?void 0:r.renditionReports;if(l){let f=-1;for(let c=0;c<l.length;c++){const y=l[c];let S;try{S=new self.URL(y.URI,r.url).href}catch(T){this.warn(`Could not construct new URL for Rendition Report: ${T}`),S=y.URI||""}if(S===e){f=c;break}else S===e.substring(0,S.length)&&(f=c)}if(f!==-1){const c=l[f],y=parseInt(c["LAST-MSN"])||(r==null?void 0:r.lastPartSn);let S=parseInt(c["LAST-PART"])||(r==null?void 0:r.lastPartIndex);if(this.hls.config.lowLatencyMode){const A=Math.min(r.age-r.partTarget,r.targetduration);S>=0&&A>r.partTarget&&(S+=1)}const T=n&&Zh(n);return new Jh(y,S>=0?S:void 0,T)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,r){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,r){if(r)try{return r.addDirectives(e)}catch(n){this.warn(`Could not construct new URL with HLS Delivery Directives: ${n}`)}return e}playlistLoaded(e,r,n){const{details:l,stats:f}=r,c=self.performance.now(),y=f.loading.first?Math.max(0,c-f.loading.first):0;l.advancedDateTime=Date.now()-y;const S=this.hls.config.timelineOffset;if(S!==l.appliedTimelineOffset){const A=Math.max(S||0,0);l.appliedTimelineOffset=A,l.fragments.forEach(L=>{L.start=L.playlistOffset+A})}if(l.live||n!=null&&n.live){const A="levelInfo"in r?r.levelInfo:r.track;if(l.reloaded(n),n&&l.fragments.length>0){ky(n,l);const H=l.playlistParsingError;if(H){this.warn(H);const K=this.hls;if(!K.config.ignorePlaylistParsingErrors){var T;const{networkDetails:z}=r;K.trigger(w.ERROR,{type:De.NETWORK_ERROR,details:re.LEVEL_PARSING_ERROR,fatal:!1,url:l.url,error:H,reason:H.message,level:r.level||void 0,parent:(T=l.fragments[0])==null?void 0:T.type,networkDetails:z,stats:f});return}l.playlistParsingError=null}}l.requestScheduled===-1&&(l.requestScheduled=f.loading.start);const L=this.hls.mainForwardBufferInfo,b=L?L.end-L.len:0,C=(l.edge-b)*1e3,D=Cd(l,C);if(l.requestScheduled+D<c?l.requestScheduled=c:l.requestScheduled+=D,this.log(`live playlist ${e} ${l.advanced?"REFRESHED "+l.lastPartSn+"-"+l.lastPartIndex:l.updated?"UPDATED":"MISSED"}`),!this.canLoad||!l.live)return;let M,F,$;if(l.canBlockReload&&l.endSN&&l.advanced){const H=this.hls.config.lowLatencyMode,K=l.lastPartSn,z=l.endSN,Q=l.lastPartIndex,ne=Q!==-1,Z=K===z;ne?Z?(F=z+1,$=H?0:Q):(F=K,$=H?Q+1:l.maxPartIndex):F=z+1;const ie=l.age,le=ie+l.ageHeader;let ee=Math.min(le-l.partTarget,l.targetduration*1.5);if(ee>0){if(le>l.targetduration*3)this.log(`Playlist last advanced ${ie.toFixed(2)}s ago. Omitting segment and part directives.`),F=void 0,$=void 0;else if(n!=null&&n.tuneInGoal&&le-l.partTarget>n.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${n.tuneInGoal} to: ${ee} with playlist age: ${l.age}`),ee=0;else{const ve=Math.floor(ee/l.targetduration);if(F+=ve,$!==void 0){const Ee=Math.round(ee%l.targetduration/l.partTarget);$+=Ee}this.log(`CDN Tune-in age: ${l.ageHeader}s last advanced ${ie.toFixed(2)}s goal: ${ee} skip sn ${ve} to part ${$}`)}l.tuneInGoal=ee}if(M=this.getDeliveryDirectives(l,r.deliveryDirectives,F,$),H||!Z){l.requestScheduled=c,this.loadingPlaylist(A,M);return}}else(l.canBlockReload||l.canSkipUntil)&&(M=this.getDeliveryDirectives(l,r.deliveryDirectives,F,$));M&&F!==void 0&&l.canBlockReload&&(l.requestScheduled=f.loading.first+Math.max(D-y*2,D/2)),this.scheduleLoading(A,M,l)}else this.clearTimer()}scheduleLoading(e,r,n){const l=n||e.details;if(!l){this.loadingPlaylist(e,r);return}const f=self.performance.now(),c=l.requestScheduled;if(f>=c){this.loadingPlaylist(e,r);return}const y=c-f;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(y)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,r),y)}getDeliveryDirectives(e,r,n,l){let f=Zh(e);return r!=null&&r.skip&&e.deltaUpdateFailed&&(n=r.msn,l=r.part,f=vn.No),new Jh(n,l,f)}checkRetry(e){const r=e.details,n=Rn(e),l=e.errorAction,{action:f,retryCount:c=0,retryConfig:y}=l||{},S=!!l&&!!y&&(f===Ft.RetryRequest||!l.resolved&&f===Ft.SendAlternateToPenaltyBox);if(S){var T;if(c>=y.maxNumRetry)return!1;if(n&&(T=e.context)!=null&&T.deliveryDirectives)this.warn(`Retrying playlist loading ${c+1}/${y.maxNumRetry} after "${r}" without delivery-directives`),this.loadPlaylist();else{const A=Ho(y,c);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),A),this.warn(`Retrying playlist loading ${c+1}/${y.maxNumRetry} after "${r}" in ${A}ms`)}e.levelRetry=!0,l.resolved=!0}return S}}function rc(v,e){if(v.length!==e.length)return!1;for(let r=0;r<v.length;r++)if(!os(v[r].attrs,e[r].attrs))return!1;return!0}function os(v,e,r){const n=v["STABLE-RENDITION-ID"];return n&&!r?n===e["STABLE-RENDITION-ID"]:!(r||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(l=>v[l]!==e[l])}function ko(v,e){return e.label.toLowerCase()===v.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(v.lang||"").toLowerCase())}class KE extends il{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.MANIFEST_PARSED,this.onManifestParsed,this),e.on(w.LEVEL_LOADING,this.onLevelLoading,this),e.on(w.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(w.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(w.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.MANIFEST_PARSED,this.onManifestParsed,this),e.off(w.LEVEL_LOADING,this.onLevelLoading,this),e.off(w.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(w.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(w.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,r){this.tracks=r.audioTracks||[]}onAudioTrackLoaded(e,r){const{id:n,groupId:l,details:f}=r,c=this.tracksInGroup[n];if(!c||c.groupId!==l){this.warn(`Audio track with id:${n} and group:${l} not found in active group ${c==null?void 0:c.groupId}`);return}const y=c.details;c.details=r.details,this.log(`Audio track ${n} "${c.name}" lang:${c.lang} group:${l} loaded [${f.startSN}-${f.endSN}]`),n===this.trackId&&this.playlistLoaded(n,r,y)}onLevelLoading(e,r){this.switchLevel(r.level)}onLevelSwitching(e,r){this.switchLevel(r.level)}switchLevel(e){const r=this.hls.levels[e];if(!r)return;const n=r.audioGroups||null,l=this.groupIds;let f=this.currentTrack;if(!n||(l==null?void 0:l.length)!==(n==null?void 0:n.length)||n!=null&&n.some(y=>(l==null?void 0:l.indexOf(y))===-1)){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const y=this.tracks.filter(b=>!n||n.indexOf(b.groupId)!==-1);if(y.length)this.selectDefaultTrack&&!y.some(b=>b.default)&&(this.selectDefaultTrack=!1),y.forEach((b,C)=>{b.id=C});else if(!f&&!this.tracksInGroup.length)return;this.tracksInGroup=y;const S=this.hls.config.audioPreference;if(!f&&S){const b=mr(S,y,Jr);if(b>-1)f=y[b];else{const C=mr(S,this.tracks);f=this.tracks[C]}}let T=this.findTrackId(f);T===-1&&f&&(T=this.findTrackId(null));const A={audioTracks:y};this.log(`Updating audio tracks, ${y.length} track(s) found in group(s): ${n==null?void 0:n.join(",")}`),this.hls.trigger(w.AUDIO_TRACKS_UPDATED,A);const L=this.trackId;if(T!==-1&&L===-1)this.setAudioTrack(T);else if(y.length&&L===-1){var c;const b=new Error(`No audio track selected for current audio group-ID(s): ${(c=this.groupIds)==null?void 0:c.join(",")} track count: ${y.length}`);this.warn(b.message),this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:b})}}}onError(e,r){r.fatal||!r.context||r.context.type===$e.AUDIO_TRACK&&r.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(r.context.groupId)!==-1)&&this.checkRetry(r)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const r=this.hls;if(r.config.audioPreference=e,e){const n=this.allAudioTracks;if(this.selectDefaultTrack=!1,n.length){const l=this.currentTrack;if(l&&ti(e,l,Jr))return l;const f=mr(e,this.tracksInGroup,Jr);if(f>-1){const c=this.tracksInGroup[f];return this.setAudioTrack(f),c}else if(l){let c=r.loadLevel;c===-1&&(c=r.firstAutoLevel);const y=Zp(e,r.levels,n,c,Jr);if(y===-1)return null;r.nextLoadLevel=y}if(e.channels||e.audioCodec){const c=mr(e,n);if(c>-1)return n[c]}}}return null}setAudioTrack(e){const r=this.tracksInGroup;if(e<0||e>=r.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const n=this.currentTrack,l=r[e],f=l.details&&!l.details.live;if(e===this.trackId&&l===n&&f||(this.log(`Switching to audio-track ${e} "${l.name}" lang:${l.lang} group:${l.groupId} channels:${l.channels}`),this.trackId=e,this.currentTrack=l,this.hls.trigger(w.AUDIO_TRACK_SWITCHING,Ze({},l)),f))return;const c=this.switchParams(l.url,n==null?void 0:n.details,l.details);this.loadPlaylist(c)}findTrackId(e){const r=this.tracksInGroup;for(let n=0;n<r.length;n++){const l=r[n];if(!(this.selectDefaultTrack&&!l.default)&&(!e||ti(e,l,Jr)))return n}if(e){const{name:n,lang:l,assocLang:f,characteristics:c,audioCodec:y,channels:S}=e;for(let T=0;T<r.length;T++){const A=r[T];if(ti({name:n,lang:l,assocLang:f,characteristics:c,audioCodec:y,channels:S},A,Jr))return T}for(let T=0;T<r.length;T++){const A=r[T];if(os(e.attrs,A.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return T}for(let T=0;T<r.length;T++){const A=r[T];if(os(e.attrs,A.attrs,["LANGUAGE"]))return T}}return-1}loadPlaylist(e){super.loadPlaylist();const r=this.currentTrack;this.shouldLoadPlaylist(r)&&In(r.url,this.hls)&&this.scheduleLoading(r,e)}loadingPlaylist(e,r){super.loadingPlaylist(e,r);const n=e.id,l=e.groupId,f=this.getUrlWithDirectives(e.url,r),c=e.details,y=c==null?void 0:c.age;this.log(`Loading audio-track ${n} "${e.name}" lang:${e.lang} group:${l}${(r==null?void 0:r.msn)!==void 0?" at sn "+r.msn+" part "+r.part:""}${y&&c.live?" age "+y.toFixed(1)+(c.type&&" "+c.type||""):""} ${f}`),this.hls.trigger(w.AUDIO_TRACK_LOADING,{url:f,id:n,groupId:l,deliveryDirectives:r||null,track:e})}}class VE{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,r,n){if(this.queues===null||this.tracks===null)return;const l=this.queues[r];l.push(e),l.length===1&&!n&&this.executeNext(r)}appendBlocker(e){return new Promise(r=>{const n={label:"async-blocker",execute:r,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(n,e)})}prependBlocker(e){return new Promise(r=>{if(this.queues){const n={label:"async-blocker-prepend",execute:r,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(n)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var r;const n=(r=e[0])==null?void 0:r.label;(n==="async-blocker"||n==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const r=this.queues[e];if(r.length){const l=r[0];try{l.execute()}catch(f){var n;if(l.onError(f),this.queues===null||this.tracks===null)return;const c=(n=this.tracks[e])==null?void 0:n.buffer;c!=null&&c.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var r;return((r=this.queues)==null?void 0:r[e][0])||null}toString(){const{queues:e,tracks:r}=this;return e===null||r===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var r,n;return(r=this.queues)!=null&&r[e]||(n=this.tracks)!=null&&n[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var r;const n=(r=this.tracks)==null?void 0:r[e],l=n==null?void 0:n.buffer;return l?`SourceBuffer${l.updating?" updating":""}${n.ended?" ended":""}${n.ending?" ending":""}`:"none"}listOps(e){var r;return((r=this.queues)==null?void 0:r[e].map(n=>n.label).join(", "))||""}}const Ff=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,ic="HlsJsTrackRemovedError";class HE extends Error{constructor(e){super(e),this.name=ic}}class YE extends Cr{constructor(e,r){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=n=>{var l;this.hls&&((l=this.mediaSource)==null?void 0:l.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=n=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=n=>{const{media:l,mediaSource:f}=this;n&&this.log("Media source opened"),!(!l||!f)&&(f.removeEventListener("sourceopen",this._onMediaSourceOpen),l.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(w.MEDIA_ATTACHED,{media:l,mediaSource:f}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:n,_objectUrl:l}=this;n!==l&&this.error(`Media element src was set while attaching MediaSource (${l} > ${n})`)},this.hls=e,this.fragmentTracker=r,this.appendSource=vp(Kr(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.MANIFEST_PARSED,this.onManifestParsed,this),e.on(w.BUFFER_RESET,this.onBufferReset,this),e.on(w.BUFFER_APPENDING,this.onBufferAppending,this),e.on(w.BUFFER_CODECS,this.onBufferCodecs,this),e.on(w.BUFFER_EOS,this.onBufferEos,this),e.on(w.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(w.FRAG_PARSED,this.onFragParsed,this),e.on(w.FRAG_CHANGED,this.onFragChanged,this),e.on(w.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.MANIFEST_PARSED,this.onManifestParsed,this),e.off(w.BUFFER_RESET,this.onBufferReset,this),e.off(w.BUFFER_APPENDING,this.onBufferAppending,this),e.off(w.BUFFER_CODECS,this.onBufferCodecs,this),e.off(w.BUFFER_EOS,this.onBufferEos,this),e.off(w.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(w.FRAG_PARSED,this.onFragParsed,this),e.off(w.FRAG_CHANGED,this.onFragChanged,this),e.off(w.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:r}=this;if(!e)return null;const n={};if(this.operationQueue){const f=this.isUpdating();f||this.operationQueue.removeBlockers();const c=this.isQueued();(f||c)&&this.warn(`Transfering MediaSource with${c?" operations in queue":""}${f?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const l=this.transferData;return!this.sourceBufferCount&&l&&l.mediaSource===r?rt(n,l.tracks):this.sourceBuffers.forEach(f=>{const[c]=f;c&&(n[c]=rt({},this.tracks[c]),this.removeBuffer(c)),f[0]=f[1]=null}),{media:e,mediaSource:r,tracks:n}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,r){var n;let l=2;(r.audio&&!r.video||!r.altAudio)&&(l=1),this.bufferCodecEventsTotal=l,this.log(`${l} bufferCodec event(s) expected.`),(n=this.transferData)!=null&&n.mediaSource&&this.sourceBufferCount&&l&&this.bufferCreated()}onMediaAttaching(e,r){const n=this.media=r.media,l=Kr(this.appendSource);if(this.transferData=this.overrides=void 0,n&&l){const f=!!r.mediaSource;(f||r.overrides)&&(this.transferData=r,this.overrides=r.overrides);const c=this.mediaSource=r.mediaSource||new l;if(this.assignMediaSource(c),f)this._objectUrl=n.src,this.attachTransferred();else{const y=this._objectUrl=self.URL.createObjectURL(c);if(this.appendSource)try{n.removeAttribute("src");const S=self.ManagedMediaSource;n.disableRemotePlayback=n.disableRemotePlayback||S&&c instanceof S,Nf(n),WE(n,y),n.load()}catch{n.src=y}else n.src=y}n.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var r,n;this.log(`${((r=this.transferData)==null?void 0:r.mediaSource)===e?"transferred":"created"} media source: ${(n=e.constructor)==null?void 0:n.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,r=this.transferData;if(!r||!e)return;const n=this.tracks,l=r.tracks,f=l?Object.keys(l):null,c=f?f.length:0,y=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(l&&f&&c){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${ot(n,(S,T)=>S==="initSegment"?void 0:T)};
transfer tracks: ${ot(l,(S,T)=>S==="initSegment"?void 0:T)}}`),!sd(l,n)){r.mediaSource=null,r.tracks=void 0;const S=e.currentTime,T=this.details,A=Math.max(S,(T==null?void 0:T.fragments[0].start)||0);if(A-S>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${S} -> ${A}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(l)}"->"${Object.keys(n)}") start time: ${A} currentTime: ${S}`),this.onMediaDetaching(w.MEDIA_DETACHING,{}),this.onMediaAttaching(w.MEDIA_ATTACHING,r),e.currentTime=A;return}this.transferData=void 0,f.forEach(S=>{const T=S,A=l[T];if(A){const L=A.buffer;if(L){const b=this.fragmentTracker,C=A.id;if(b.hasFragments(C)||b.hasParts(C)){const F=Be.getBuffered(L);b.detectEvictedFragments(T,F,C,null,!0)}const D=co(T),M=[T,L];this.sourceBuffers[D]=M,L.updating&&this.operationQueue&&this.operationQueue.prependBlocker(T),this.trackSourceBuffer(T,A)}}}),y(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),y()}get mediaSourceOpenOrEnded(){var e;const r=(e=this.mediaSource)==null?void 0:e.readyState;return r==="open"||r==="ended"}onMediaDetaching(e,r){const n=!!r.transferMedia;this.transferData=this.overrides=void 0;const{media:l,mediaSource:f,_objectUrl:c}=this;if(f){if(this.log(`media source ${n?"transferring":"detaching"}`),n)this.sourceBuffers.forEach(([y])=>{y&&this.removeBuffer(y)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const y=f.readyState==="open";try{const S=f.sourceBuffers;for(let T=S.length;T--;)y&&S[T].abort(),f.removeSourceBuffer(S[T]);y&&f.endOfStream()}catch(S){this.warn(`onMediaDetaching: ${S.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}f.removeEventListener("sourceopen",this._onMediaSourceOpen),f.removeEventListener("sourceended",this._onMediaSourceEnded),f.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(f.removeEventListener("startstreaming",this._onStartStreaming),f.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}l&&(l.removeEventListener("emptied",this._onMediaEmptied),n||(c&&self.URL.revokeObjectURL(c),this.mediaSrc===c?(l.removeAttribute("src"),this.appendSource&&Nf(l),l.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(w.MEDIA_DETACHED,r)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var r;const n=(r=this.tracks[e])==null?void 0:r.buffer;if(this.removeBuffer(e),n)try{var l;(l=this.mediaSource)!=null&&l.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(n)}catch(f){this.warn(`onBufferReset ${e}`,f)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[co(e)]=[null,null];const r=this.tracks[e];r&&(r.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new VE(this.tracks)}onBufferCodecs(e,r){const n=this.tracks,l=Object.keys(r);this.log(`BUFFER_CODECS: "${l}" (current SB count ${this.sourceBufferCount})`);const f="audiovideo"in r&&(n.audio||n.video)||n.audiovideo&&("audio"in r||"video"in r),c=!f&&this.sourceBufferCount&&this.media&&l.some(y=>!n[y]);if(f||c){this.warn(`Unsupported transition between "${Object.keys(n)}" and "${l}" SourceBuffers`);return}l.forEach(y=>{var S,T,A;const L=r[y],{id:b,codec:C,levelCodec:D,container:M,metadata:F,supplemental:$}=L;let H=n[y];const K=(S=this.transferData)==null||(T=S.tracks)==null?void 0:T[y],z=K!=null&&K.buffer?K:H,Q=(z==null?void 0:z.pendingCodec)||(z==null?void 0:z.codec),ne=z==null?void 0:z.levelCodec;H||(H=n[y]={buffer:void 0,listeners:[],codec:C,supplemental:$,container:M,levelCodec:D,metadata:F,id:b});const Z=gn(Q,ne),ie=Z==null?void 0:Z.replace(Ff,"$1");let le=gn(C,D);const ee=(A=le)==null?void 0:A.replace(Ff,"$1");le&&Z&&ie!==ee&&(y.slice(0,5)==="audio"&&(le=xn(le,this.appendSource)),this.log(`switching codec ${Q} to ${le}`),le!==(H.pendingCodec||H.codec)&&(H.pendingCodec=le),H.container=M,this.appendChangeType(y,M,le))}),(this.tracksReady||this.sourceBufferCount)&&(r.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,r)=>{const n=this.tracks[r];return e[r]={id:n.id,container:n.container,codec:n.codec,levelCodec:n.levelCodec},e},{})}appendChangeType(e,r,n){const l=`${r};codecs=${n}`,f={label:`change-type=${l}`,execute:()=>{const c=this.tracks[e];if(c){const y=c.buffer;y!=null&&y.changeType&&(this.log(`changing ${e} sourceBuffer type to ${l}`),y.changeType(l),c.codec=n,c.container=r)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:c=>{this.warn(`Failed to change ${e} SourceBuffer type`,c)}};this.append(f,e,this.isPending(this.tracks[e]))}blockAudio(e){var r;const n=e.start,l=n+e.duration*.05;if(((r=this.fragmentTracker.getAppendedFrag(n,be.MAIN))==null?void 0:r.gap)===!0)return;const c={label:"block-audio",execute:()=>{var y;const S=this.tracks.video;(this.lastVideoAppendEnd>l||S!=null&&S.buffer&&Be.isBuffered(S.buffer,l)||((y=this.fragmentTracker.getAppendedFrag(l,be.MAIN))==null?void 0:y.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:y=>{this.warn("Error executing block-audio operation",y)}};this.blockedAudioAppend={op:c,frag:e},this.append(c,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:r}=this;e&&r&&(this.blockedAudioAppend=null,r.unblockAudio(e.op))}onBufferAppending(e,r){const{tracks:n}=this,{data:l,type:f,parent:c,frag:y,part:S,chunkMeta:T}=r,A=T.buffering[f],L=y.sn,b=self.performance.now();A.start=b;const C=y.stats.buffering,D=S?S.stats.buffering:null;C.start===0&&(C.start=b),D&&D.start===0&&(D.start=b);const M=n.audio;let F=!1;f==="audio"&&(M==null?void 0:M.container)==="audio/mpeg"&&(F=!this.lastMpegAudioChunk||T.id===1||this.lastMpegAudioChunk.sn!==T.sn,this.lastMpegAudioChunk=T);const $=this.tracks.video,H=$==null?void 0:$.buffer;if(H&&L!=="initSegment"){const Q=S||y,ne=this.blockedAudioAppend;if(f==="audio"&&c!=="main"&&!this.blockedAudioAppend){const ie=Q.start+Q.duration*.05,le=H.buffered,ee=this.currentOp("video");!le.length&&!ee?this.blockAudio(Q):!ee&&!Be.isBuffered(H,ie)&&this.lastVideoAppendEnd<ie&&this.blockAudio(Q)}else if(f==="video"){const Z=Q.end;if(ne){const ie=ne.frag.start;(Z>ie||Z<this.lastVideoAppendEnd||Be.isBuffered(H,ie))&&this.unblockAudio()}this.lastVideoAppendEnd=Z}}const K=(S||y).start,z={label:`append-${f}`,execute:()=>{if(A.executeStart=self.performance.now(),F){const Q=this.tracks[f];if(Q){const ne=Q.buffer;if(ne){const Z=K-ne.timestampOffset;Math.abs(Z)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${K} (delta: ${Z}) sn: ${L})`),ne.timestampOffset=K)}}}this.appendExecutor(l,f)},onStart:()=>{},onComplete:()=>{const Q=self.performance.now();A.executeEnd=A.end=Q,C.first===0&&(C.first=Q),D&&D.first===0&&(D.first=Q);const ne={};this.sourceBuffers.forEach(([Z,ie])=>{Z&&(ne[Z]=Be.getBuffered(ie))}),this.appendErrors[f]=0,f==="audio"||f==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(w.BUFFER_APPENDED,{type:f,frag:y,part:S,chunkMeta:T,parent:y.type,timeRanges:ne})},onError:Q=>{var ne;const Z={type:De.MEDIA_ERROR,parent:y.type,details:re.BUFFER_APPEND_ERROR,sourceBufferName:f,frag:y,part:S,chunkMeta:T,error:Q,err:Q,fatal:!1};if(Q.code===DOMException.QUOTA_EXCEEDED_ERR)Z.details=re.BUFFER_FULL_ERROR;else if(Q.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!((ne=this.media)!=null&&ne.error))Z.errorAction=rs(!0);else if(Q.name===ic)this.sourceBufferCount===0?Z.errorAction=rs(!0):++this.appendErrors[f];else{const ie=++this.appendErrors[f];this.warn(`Failed ${ie}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${f}" sourceBuffer`),ie>=this.hls.config.appendErrorMaxRetry&&(Z.fatal=!0)}this.hls.trigger(w.ERROR,Z)}};this.append(z,f,this.isPending(this.tracks[f]))}getFlushOp(e,r,n){return this.log(`queuing "${e}" remove ${r}-${n}`),{label:"remove",execute:()=>{this.removeExecutor(e,r,n)},onStart:()=>{},onComplete:()=>{this.hls.trigger(w.BUFFER_FLUSHED,{type:e})},onError:l=>{this.warn(`Failed to remove ${r}-${n} from "${e}" SourceBuffer`,l)}}}onBufferFlushing(e,r){const{type:n,startOffset:l,endOffset:f}=r;n?this.append(this.getFlushOp(n,l,f),n):this.sourceBuffers.forEach(([c])=>{c&&this.append(this.getFlushOp(c,l,f),c)})}onFragParsed(e,r){const{frag:n,part:l}=r,f=[],c=l?l.elementaryStreams:n.elementaryStreams;c[tt.AUDIOVIDEO]?f.push("audiovideo"):(c[tt.AUDIO]&&f.push("audio"),c[tt.VIDEO]&&f.push("video"));const y=()=>{const S=self.performance.now();n.stats.buffering.end=S,l&&(l.stats.buffering.end=S);const T=l?l.stats:n.stats;this.hls.trigger(w.FRAG_BUFFERED,{frag:n,part:l,stats:T,id:n.type})};f.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${n.type} level: ${n.level} sn: ${n.sn}`),this.blockBuffers(y,f)}onFragChanged(e,r){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var r,n;return e&&(!((r=this.tracks[e])!=null&&r.ended)||((n=this.tracks[e])==null?void 0:n.ending))})}onBufferEos(e,r){var n;this.sourceBuffers.forEach(([c])=>{if(c){const y=this.tracks[c];(!r.type||r.type===c)&&(y.ending=!0,y.ended||(y.ended=!0,this.log(`${c} buffer reached EOS`)))}});const l=((n=this.overrides)==null?void 0:n.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([c])=>{var y;return c&&!((y=this.tracks[c])!=null&&y.ended)})&&(l?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:c}=this;if(!c||c.readyState!=="open"){c&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${c.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),c.endOfStream(),this.hls.trigger(w.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(w.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const r=this.tracks[e];r&&(r.ending=!1)}})}onLevelUpdated(e,{details:r}){r.fragments.length&&(this.details=r,this.updateDuration())}updateDuration(){const e=this.getDurationAndRange();e&&this.blockUntilOpen(()=>this.updateMediaSource(e))}onError(e,r){if(r.details===re.BUFFER_APPEND_ERROR&&r.frag){var n;const l=(n=r.errorAction)==null?void 0:n.nextAutoLevel;Ae(l)&&l!==r.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:r,media:n}=this;if(!n||r===null||!this.sourceBufferCount)return;const l=e.config,f=n.currentTime,c=r.levelTargetDuration,y=r.live&&l.liveBackBufferLength!==null?l.liveBackBufferLength:l.backBufferLength;if(Ae(y)&&y>=0){const S=Math.max(y,c),T=Math.floor(f/c)*c-S;this.flushBackBuffer(f,c,T)}if(Ae(l.frontBufferFlushThreshold)&&l.frontBufferFlushThreshold>0){const S=Math.max(l.maxBufferLength,l.frontBufferFlushThreshold),T=Math.max(S,c),A=Math.floor(f/c)*c+T;this.flushFrontBuffer(f,c,A)}}flushBackBuffer(e,r,n){this.sourceBuffers.forEach(([l,f])=>{if(f){const y=Be.getBuffered(f);if(y.length>0&&n>y.start(0)){var c;this.hls.trigger(w.BACK_BUFFER_REACHED,{bufferEnd:n});const S=this.tracks[l];if((c=this.details)!=null&&c.live)this.hls.trigger(w.LIVE_BACK_BUFFER_REACHED,{bufferEnd:n});else if(S!=null&&S.ended){this.log(`Cannot flush ${l} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(w.BUFFER_FLUSHING,{startOffset:0,endOffset:n,type:l})}}})}flushFrontBuffer(e,r,n){this.sourceBuffers.forEach(([l,f])=>{if(f){const c=Be.getBuffered(f),y=c.length;if(y<2)return;const S=c.start(y-1),T=c.end(y-1);if(n>S||e>=S&&e<=T)return;this.hls.trigger(w.BUFFER_FLUSHING,{startOffset:S,endOffset:1/0,type:l})}})}getDurationAndRange(){var e;const{details:r,mediaSource:n}=this;if(!r||!this.media||(n==null?void 0:n.readyState)!=="open")return null;const l=r.edge;if(r.live&&this.hls.config.liveDurationInfinity){if(r.fragments.length&&r.live&&n.setLiveSeekableRange){const T=Math.max(0,r.fragmentStart),A=Math.max(T,l);return{duration:1/0,start:T,end:A}}return{duration:1/0}}const f=(e=this.overrides)==null?void 0:e.duration;if(f)return Ae(f)?{duration:f}:null;const c=this.media.duration,y=Ae(n.duration)?n.duration:0;return l>y&&l>c||!Ae(c)?{duration:l}:null}updateMediaSource({duration:e,start:r,end:n}){const l=this.mediaSource;!this.media||!l||l.readyState!=="open"||(l.duration!==e&&(Ae(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),l.duration=e),r!==void 0&&n!==void 0&&(this.log(`MediaSource duration is set to ${l.duration}. Setting seekable range to ${r}-${n}.`),l.setLiveSeekableRange(r,n)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:r,tracks:n}=this;if(this.log(`checkPendingTracks (pending: ${r} codec events expected: ${e}) ${ot(n)}`),this.tracksReady){var l;const f=(l=this.transferData)==null?void 0:l.tracks;f&&Object.keys(f).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([r,n])=>{if(r){const l=this.tracks[r];e[r]={buffer:n,container:l.container,codec:l.codec,supplemental:l.supplemental,levelCodec:l.levelCodec,id:l.id,metadata:l.metadata}}}),this.hls.trigger(w.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([r])=>{this.executeNext(r)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:r,mediaSource:n}=this;if(!n)throw new Error("createSourceBuffers called when mediaSource was null");for(const f in e){const c=f,y=e[c];if(this.isPending(y)){const S=this.getTrackCodec(y,c),T=`${y.container};codecs=${S}`;y.codec=S,this.log(`creating sourceBuffer(${T})${this.currentOp(c)?" Queued":""} ${ot(y)}`);try{const A=n.addSourceBuffer(T),L=co(c),b=[c,A];r[L]=b,y.buffer=A}catch(A){var l;this.error(`error while trying to add sourceBuffer: ${A.message}`),this.shiftAndExecuteNext(c),(l=this.operationQueue)==null||l.removeBlockers(),delete this.tracks[c],this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:A,sourceBufferName:c,mimeType:T,parent:y.id});return}this.trackSourceBuffer(c,y)}}this.bufferCreated()}getTrackCodec(e,r){const n=e.supplemental;let l=e.codec;n&&(r==="video"||r==="audiovideo")&&Lo(n,"video")&&(l=Up(l,n));const f=gn(l,e.levelCodec);return f?r.slice(0,5)==="audio"?xn(f,this.appendSource):f:""}trackSourceBuffer(e,r){const n=r.buffer;if(!n)return;const l=this.getTrackCodec(r,e);this.tracks[e]={buffer:n,codec:l,container:r.container,levelCodec:r.levelCodec,supplemental:r.supplemental,metadata:r.metadata,id:r.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(f,c)=>{const y=c.removedRanges;y!=null&&y.length&&this.hls.trigger(w.BUFFER_FLUSHED,{type:f})})}get mediaSrc(){var e,r;const n=((e=this.media)==null||(r=e.querySelector)==null?void 0:r.call(e,"source"))||this.media;return n==null?void 0:n.src}onSBUpdateStart(e){const r=this.currentOp(e);r&&r.onStart()}onSBUpdateEnd(e){var r;if(((r=this.mediaSource)==null?void 0:r.readyState)==="closed"){this.resetBuffer(e);return}const n=this.currentOp(e);n&&(n.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,r){var n;const l=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(n=this.mediaSource)==null?void 0:n.readyState}`);this.error(`${l}`,r),this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:l,fatal:!1});const f=this.currentOp(e);f&&f.onError(l)}removeExecutor(e,r,n){const{media:l,mediaSource:f}=this,c=this.tracks[e],y=c==null?void 0:c.buffer;if(!l||!f||!y){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const S=Ae(l.duration)?l.duration:1/0,T=Ae(f.duration)?f.duration:1/0,A=Math.max(0,r),L=Math.min(n,S,T);L>A&&(!c.ending||c.ended)?(c.ended=!1,this.log(`Removing [${A},${L}] from the ${e} SourceBuffer`),y.remove(A,L)):this.shiftAndExecuteNext(e)}appendExecutor(e,r){const n=this.tracks[r],l=n==null?void 0:n.buffer;if(!l)throw new HE(`Attempting to append to the ${r} SourceBuffer, but it does not exist`);n.ending=!1,n.ended=!1,l.appendBuffer(e)}blockUntilOpen(e){this.isUpdating()||this.isQueued()?this.blockBuffers(e):e()}isUpdating(){return this.sourceBuffers.some(([e,r])=>e&&r.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,r=this.sourceBufferTypes){if(!r.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);return}const{operationQueue:n}=this,l=r.map(c=>this.appendBlocker(c));r.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(l).then(c=>{n===this.operationQueue&&(e(),this.stepOperationQueue(r))})}stepOperationQueue(e){e.forEach(r=>{var n;const l=(n=this.tracks[r])==null?void 0:n.buffer;!l||l.updating||this.shiftAndExecuteNext(r)})}append(e,r,n){this.operationQueue&&this.operationQueue.append(e,r,n)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,r)=>e+(this.isPending(this.tracks[r])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[r])=>e+(r?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,r,n){const l=this.tracks[e];if(!l)return;const f=l.buffer;if(!f)return;const c=n.bind(this,e);l.listeners.push({event:r,listener:c}),f.addEventListener(r,c)}removeBufferListeners(e){const r=this.tracks[e];if(!r)return;const n=r.buffer;n&&(r.listeners.forEach(l=>{n.removeEventListener(l.event,l.listener)}),r.listeners.length=0)}}function Nf(v){const e=v.querySelectorAll("source");[].slice.call(e).forEach(r=>{v.removeChild(r)})}function WE(v,e){const r=self.document.createElement("source");r.type="video/mp4",r.src=e,v.appendChild(r)}function co(v){return v==="audio"?1:0}class sl{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(w.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(w.MANIFEST_PARSED,this.onManifestParsed,this),e.on(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(w.BUFFER_CODECS,this.onBufferCodecs,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(w.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(w.MANIFEST_PARSED,this.onManifestParsed,this),e.off(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(w.BUFFER_CODECS,this.onBufferCodecs,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,r){const n=this.hls.levels[r.droppedLevel];this.isLevelAllowed(n)&&this.restrictedLevels.push({bitrate:n.bitrate,height:n.height,width:n.width})}onMediaAttaching(e,r){this.media=r.media instanceof HTMLVideoElement?r.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,r){const n=this.hls;this.restrictedLevels=[],this.firstLevel=r.firstLevel,n.config.capLevelToPlayerSize&&r.video&&this.startCapping()}onLevelsUpdated(e,r){this.timer&&Ae(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,r){this.hls.config.capLevelToPlayerSize&&r.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const r=this.hls,n=this.getMaxLevel(e.length-1);n!==this.autoLevelCapping&&r.logger.log(`Setting autoLevelCapping to ${n}: ${e[n].height}p@${e[n].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),r.autoLevelCapping=n,r.autoLevelEnabled&&r.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=r.autoLevelCapping}}}getMaxLevel(e){const r=this.hls.levels;if(!r.length)return-1;const n=r.filter((l,f)=>this.isLevelAllowed(l)&&f<=e);return this.clientRect=null,sl.getMaxLevelByMediaSize(n,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,r={width:0,height:0};if(e){const n=e.getBoundingClientRect();r.width=n.width,r.height=n.height,!r.width&&!r.height&&(r.width=n.right-n.left||e.width||0,r.height=n.bottom-n.top||e.height||0)}return this.clientRect=r,r}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(n=>e.bitrate===n.bitrate&&e.width===n.width&&e.height===n.height)}static getMaxLevelByMediaSize(e,r,n){if(!(e!=null&&e.length))return-1;const l=(y,S)=>S?y.width!==S.width||y.height!==S.height:!0;let f=e.length-1;const c=Math.max(r,n);for(let y=0;y<e.length;y+=1){const S=e[y];if((S.width>=c||S.height>=c)&&l(S,e[y+1])){f=y;break}}return f}}const qE={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Gt=qE,jE={HLS:"h"},XE=jE,zE="CMCD-Object",QE="CMCD-Request",ZE="CMCD-Session",JE="CMCD-Status",zi={OBJECT:zE,REQUEST:QE,SESSION:ZE,STATUS:JE},eT={[zi.OBJECT]:["br","d","ot","tb"],[zi.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[zi.SESSION]:["cid","pr","sf","sid","st","v"],[zi.STATUS]:["bs","rtp"]};class Pi{constructor(e,r){Array.isArray(e)&&(e=e.map(n=>n instanceof Pi?n:new Pi(n))),this.value=e,this.params=r}}const tT="Dict";function rT(v){return Array.isArray(v)?JSON.stringify(v):v instanceof Map?"Map{}":v instanceof Set?"Set{}":typeof v=="object"?JSON.stringify(v):String(v)}function iT(v,e,r,n){return new Error(`failed to ${v} "${rT(e)}" as ${r}`,{cause:n})}function Er(v,e,r){return iT("serialize",v,e,r)}class sc{constructor(e){this.description=e}}const Uf="Bare Item",sT="Boolean";function nT(v){if(typeof v!="boolean")throw Er(v,sT);return v?"?1":"?0"}const aT="Byte Sequence";function oT(v){if(ArrayBuffer.isView(v)===!1)throw Er(v,aT);return`:${rE(v)}:`}const lT="Integer";function uT(v){return v<-999999999999999||999999999999999<v}function nc(v){if(uT(v))throw Er(v,lT);return v.toString()}function hT(v){return`@${nc(v.getTime()/1e3)}`}const fT="Decimal";function dT(v){const e=Kd(v,3);if(Math.floor(Math.abs(e)).toString().length>12)throw Er(v,fT);const r=e.toString();return r.includes(".")?r:`${r}.0`}const cT="String",gT=/[\x00-\x1f\x7f]+/;function vT(v){if(gT.test(v))throw Er(v,cT);return`"${v.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function mT(v){return v.description||v.toString().slice(7,-1)}const pT="Token";function Bf(v){const e=mT(v);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw Er(e,pT);return e}function wo(v){switch(typeof v){case"number":if(!Ae(v))throw Er(v,Uf);return Number.isInteger(v)?nc(v):dT(v);case"string":return vT(v);case"symbol":return Bf(v);case"boolean":return nT(v);case"object":if(v instanceof Date)return hT(v);if(v instanceof Uint8Array)return oT(v);if(v instanceof sc)return Bf(v);default:throw Er(v,Uf)}}const yT="Key";function Oo(v){if(/^[a-z*][a-z0-9\-_.*]*$/.test(v)===!1)throw Er(v,yT);return v}function nl(v){return v==null?"":Object.entries(v).map(([e,r])=>r===!0?`;${Oo(e)}`:`;${Oo(e)}=${wo(r)}`).join("")}function ac(v){return v instanceof Pi?`${wo(v.value)}${nl(v.params)}`:wo(v)}function ET(v){return`(${v.value.map(ac).join(" ")})${nl(v.params)}`}function TT(v,e={whitespace:!0}){if(typeof v!="object")throw Er(v,tT);const r=v instanceof Map?v.entries():Object.entries(v),n=e!=null&&e.whitespace?" ":"";return Array.from(r).map(([l,f])=>{f instanceof Pi||(f=new Pi(f));let c=Oo(l);return f.value===!0?c+=nl(f.params):(c+="=",Array.isArray(f.value)?c+=ET(f):c+=ac(f)),c}).join(`,${n}`)}function ST(v,e){return TT(v,e)}function AT(v){return v==="ot"||v==="sf"||v==="st"}function xT(v){return typeof v=="number"?Ae(v):v!=null&&v!==""&&v!==!1}const yn=v=>Math.round(v),LT=(v,e)=>(e!=null&&e.baseUrl&&(v=iE(v,e.baseUrl)),encodeURIComponent(v)),un=v=>yn(v/100)*100,IT={br:yn,d:yn,bl:un,dl:un,mtp:un,nor:LT,rtp:un,tb:yn};function RT(v,e){const r={};if(v==null||typeof v!="object")return r;const n=Object.keys(v).sort(),l=rt({},IT,e==null?void 0:e.formatters),f=e==null?void 0:e.filter;return n.forEach(c=>{if(f!=null&&f(c))return;let y=v[c];const S=l[c];S&&(y=S(y,e)),!(c==="v"&&y===1)&&(c=="pr"&&y===1||xT(y)&&(AT(c)&&typeof y=="string"&&(y=new sc(y)),r[c]=y))}),r}function oc(v,e={}){return v?ST(RT(v,e),rt({whitespace:!1},e)):""}function bT(v,e={}){const r={};if(!v)return r;const n=Object.entries(v),l=Object.entries(eT).concat(Object.entries((e==null?void 0:e.customHeaderMap)||{})),f=n.reduce((c,y)=>{var S,T;const[A,L]=y,b=((S=l.find(C=>C[1].includes(A)))===null||S===void 0?void 0:S[0])||zi.REQUEST;return(T=c[b])!==null&&T!==void 0||(c[b]={}),c[b][A]=L,c},{});return Object.entries(f).reduce((c,[y,S])=>(c[y]=oc(S,e),c),r)}function _T(v,e,r){return rt(v,bT(e,r))}const DT="CMCD";function CT(v,e={}){if(!v)return"";const r=oc(v,e);return`${DT}=${encodeURIComponent(r)}`}const Gf=/CMCD=[^&#]+/;function PT(v,e,r){const n=CT(e,r);if(!n)return v;if(Gf.test(v))return v.replace(Gf,n);const l=v.includes("?")?"&":"?";return`${v}${l}${n}`}class kT{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=l=>{try{this.apply(l,{ot:Gt.MANIFEST,su:!this.initialized})}catch(f){this.hls.logger.warn("Could not generate manifest CMCD data.",f)}},this.applyFragmentData=l=>{try{const{frag:f,part:c}=l,y=this.hls.levels[f.level],S=this.getObjectType(f),T={d:(c||f).duration*1e3,ot:S};(S===Gt.VIDEO||S===Gt.AUDIO||S==Gt.MUXED)&&(T.br=y.bitrate/1e3,T.tb=this.getTopBandwidth(S)/1e3,T.bl=this.getBufferLength(S));const A=c?this.getNextPart(c):this.getNextFrag(f);A!=null&&A.url&&A.url!==f.url&&(T.nor=A.url),this.apply(l,T)}catch(f){this.hls.logger.warn("Could not generate segment CMCD data.",f)}},this.hls=e;const r=this.config=e.config,{cmcd:n}=r;n!=null&&(r.pLoader=this.createPlaylistLoader(),r.fLoader=this.createFragmentLoader(),this.sid=n.sessionId||e.sessionId,this.cid=n.contentId,this.useHeaders=n.useHeaders===!0,this.includeKeys=n.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(w.MEDIA_DETACHED,this.onMediaDetached,this),e.on(w.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(w.MEDIA_DETACHED,this.onMediaDetached,this),e.off(w.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,r){this.media=r.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,r){var n,l;this.audioBuffer=(n=r.tracks.audio)==null?void 0:n.buffer,this.videoBuffer=(l=r.tracks.video)==null?void 0:l.buffer}createData(){var e;return{v:1,sf:XE.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,r={}){rt(r,this.createData());const n=r.ot===Gt.INIT||r.ot===Gt.VIDEO||r.ot===Gt.MUXED;this.starved&&n&&(r.bs=!0,r.su=!0,this.starved=!1),r.su==null&&(r.su=this.buffering);const{includeKeys:l}=this;l&&(r=Object.keys(r).reduce((c,y)=>(l.includes(y)&&(c[y]=r[y]),c),{}));const f={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),_T(e.headers,r,f)):e.url=PT(e.url,r,f)}getNextFrag(e){var r;const n=(r=this.hls.levels[e.level])==null?void 0:r.details;if(n){const l=e.sn-n.startSN;return n.fragments[l+1]}}getNextPart(e){var r,n;const{index:l,fragment:f}=e,c=(r=this.hls.levels[f.level])==null||(n=r.details)==null?void 0:n.partList;if(c){const{sn:y}=f;for(let S=c.length-1;S>=0;S--){const T=c[S];if(T.index===l&&T.fragment.sn===y)return c[S+1]}}}getObjectType(e){const{type:r}=e;if(r==="subtitle")return Gt.TIMED_TEXT;if(e.sn==="initSegment")return Gt.INIT;if(r==="audio")return Gt.AUDIO;if(r==="main")return this.hls.audioTracks.length?Gt.VIDEO:Gt.MUXED}getTopBandwidth(e){let r=0,n;const l=this.hls;if(e===Gt.AUDIO)n=l.audioTracks;else{const f=l.maxAutoLevel,c=f>-1?f+1:l.levels.length;n=l.levels.slice(0,c)}for(const f of n)f.bitrate>r&&(r=f.bitrate);return r>0?r:NaN}getBufferLength(e){const r=this.media,n=e===Gt.AUDIO?this.audioBuffer:this.videoBuffer;return!n||!r?NaN:Be.bufferInfo(n,r.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,r=this.applyPlaylistData,n=e||this.config.loader;return class{constructor(f){this.loader=void 0,this.loader=new n(f)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(f,c,y){r(f),this.loader.load(f,c,y)}}}createFragmentLoader(){const{fLoader:e}=this.config,r=this.applyFragmentData,n=e||this.config.loader;return class{constructor(f){this.loader=void 0,this.loader=new n(f)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(f,c,y){r(f),this.loader.load(f,c,y)}}}}const wT=3e5;class OT extends Cr{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(w.MANIFEST_PARSED,this.onManifestParsed,this),e.on(w.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(w.MANIFEST_PARSED,this.onManifestParsed,this),e.off(w.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,r)=>(e.indexOf(r.pathwayId)===-1&&e.push(r.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const r=this.levels;r&&(this.levels=r.filter(n=>n!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,r){const{contentSteering:n}=r;n!==null&&(this.pathwayId=n.pathwayId,this.uri=n.uri,this.started&&this.startLoad())}onManifestParsed(e,r){this.audioTracks=r.audioTracks,this.subtitleTracks=r.subtitleTracks}onError(e,r){const{errorAction:n}=r;if((n==null?void 0:n.action)===Ft.SendAlternateToPenaltyBox&&n.flags===rr.MoveAllAlternatesMatchingHost){const l=this.levels;let f=this._pathwayPriority,c=this.pathwayId;if(r.context){const{groupId:y,pathwayId:S,type:T}=r.context;y&&l?c=this.getPathwayForGroupId(y,T,c):S&&(c=S)}c in this.penalizedPathways||(this.penalizedPathways[c]=performance.now()),!f&&l&&(f=this.pathways()),f&&f.length>1&&(this.updatePathwayPriority(f),n.resolved=this.pathwayId!==c),n.resolved||this.warn(`Could not resolve ${r.details} ("${r.error.message}") with content-steering for Pathway: ${c} levels: ${l&&l.length} priorities: ${ot(f)} penalized: ${ot(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let r=this.getLevelsForPathway(this.pathwayId);if(r.length===0){const n=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${n}"`),r=this.getLevelsForPathway(n),this.pathwayId=n}return r.length!==e.length&&this.log(`Found ${r.length}/${e.length} levels in Pathway "${this.pathwayId}"`),r}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(r=>e===r.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let r;const n=this.penalizedPathways,l=performance.now();Object.keys(n).forEach(f=>{l-n[f]>wT&&delete n[f]});for(let f=0;f<e.length;f++){const c=e[f];if(c in n)continue;if(c===this.pathwayId)return;const y=this.hls.nextLoadLevel,S=this.hls.levels[y];if(r=this.getLevelsForPathway(c),r.length>0){this.log(`Setting Pathway to "${c}"`),this.pathwayId=c,kd(r),this.hls.trigger(w.LEVELS_UPDATED,{levels:r});const T=this.hls.levels[y];S&&T&&this.levels&&(T.attrs["STABLE-VARIANT-ID"]!==S.attrs["STABLE-VARIANT-ID"]&&T.bitrate!==S.bitrate&&this.log(`Unstable Pathways change from bitrate ${S.bitrate} to ${T.bitrate}`),this.hls.nextLoadLevel=y);break}}}getPathwayForGroupId(e,r,n){const l=this.getLevelsForPathway(n).concat(this.levels||[]);for(let f=0;f<l.length;f++)if(r===$e.AUDIO_TRACK&&l[f].hasAudioGroup(e)||r===$e.SUBTITLE_TRACK&&l[f].hasSubtitleGroup(e))return l[f].pathwayId;return n}clonePathways(e){const r=this.levels;if(!r)return;const n={},l={};e.forEach(f=>{const{ID:c,"BASE-ID":y,"URI-REPLACEMENT":S}=f;if(r.some(A=>A.pathwayId===c))return;const T=this.getLevelsForPathway(y).map(A=>{const L=new ft(A.attrs);L["PATHWAY-ID"]=c;const b=L.AUDIO&&`${L.AUDIO}_clone_${c}`,C=L.SUBTITLES&&`${L.SUBTITLES}_clone_${c}`;b&&(n[L.AUDIO]=b,L.AUDIO=b),C&&(l[L.SUBTITLES]=C,L.SUBTITLES=C);const D=lc(A.uri,L["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",S),M=new ts({attrs:L,audioCodec:A.audioCodec,bitrate:A.bitrate,height:A.height,name:A.name,url:D,videoCodec:A.videoCodec,width:A.width});if(A.audioGroups)for(let F=1;F<A.audioGroups.length;F++)M.addGroupId("audio",`${A.audioGroups[F]}_clone_${c}`);if(A.subtitleGroups)for(let F=1;F<A.subtitleGroups.length;F++)M.addGroupId("text",`${A.subtitleGroups[F]}_clone_${c}`);return M});r.push(...T),$f(this.audioTracks,n,S,c),$f(this.subtitleTracks,l,S,c)})}loadSteeringManifest(e){const r=this.hls.config,n=r.loader;this.loader&&this.loader.destroy(),this.loader=new n(r);let l;try{l=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(l.protocol!=="data:"){const A=(this.hls.bandwidthEstimate||r.abrEwmaDefaultEstimate)|0;l.searchParams.set("_HLS_pathway",this.pathwayId),l.searchParams.set("_HLS_throughput",""+A)}const f={responseType:"json",url:l.href},c=r.steeringManifestLoadPolicy.default,y=c.errorRetry||c.timeoutRetry||{},S={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:y.maxNumRetry||0,retryDelay:y.retryDelayMs||0,maxRetryDelay:y.maxRetryDelayMs||0},T={onSuccess:(A,L,b,C)=>{this.log(`Loaded steering manifest: "${l}"`);const D=A.data;if((D==null?void 0:D.VERSION)!==1){this.log(`Steering VERSION ${D.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=D.TTL;const{"RELOAD-URI":M,"PATHWAY-CLONES":F,"PATHWAY-PRIORITY":$}=D;if(M)try{this.uri=new self.URL(M,l).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${M}`);return}this.scheduleRefresh(this.uri||b.url),F&&this.clonePathways(F);const H={steeringManifest:D,url:l.toString()};this.hls.trigger(w.STEERING_MANIFEST_LOADED,H),$&&this.updatePathwayPriority($)},onError:(A,L,b,C)=>{if(this.log(`Error loading steering manifest: ${A.code} ${A.text} (${L.url})`),this.stopLoad(),A.code===410){this.enabled=!1,this.log(`Steering manifest ${L.url} no longer available`);return}let D=this.timeToLoad*1e3;if(A.code===429){const M=this.loader;if(typeof(M==null?void 0:M.getResponseHeader)=="function"){const F=M.getResponseHeader("Retry-After");F&&(D=parseFloat(F)*1e3)}this.log(`Steering manifest ${L.url} rate limited`);return}this.scheduleRefresh(this.uri||L.url,D)},onTimeout:(A,L,b)=>{this.log(`Timeout loading steering manifest (${L.url})`),this.scheduleRefresh(this.uri||L.url)}};this.log(`Requesting steering manifest: ${l}`),this.loader.load(f,S,T)}scheduleRefresh(e,r=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var n;const l=(n=this.hls)==null?void 0:n.media;if(l&&!l.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},r)}}function $f(v,e,r,n){v&&Object.keys(e).forEach(l=>{const f=v.filter(c=>c.groupId===l).map(c=>{const y=rt({},c);return y.details=void 0,y.attrs=new ft(y.attrs),y.url=y.attrs.URI=lc(c.url,c.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",r),y.groupId=y.attrs["GROUP-ID"]=e[l],y.attrs["PATHWAY-ID"]=n,y});v.push(...f)})}function lc(v,e,r,n){const{HOST:l,PARAMS:f,[r]:c}=n;let y;e&&(y=c==null?void 0:c[e],y&&(v=y));const S=new self.URL(v);return l&&!y&&(S.host=l),f&&Object.keys(f).sort().forEach(T=>{T&&S.searchParams.set(T,f[T])}),S.href}class bi extends Cr{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=bi.CDMCleanupPromise?[bi.CDMCleanupPromise]:[],this.onMediaEncrypted=r=>{const{initDataType:n,initData:l}=r,f=`"${r.type}" event: init data type: "${n}"`;if(this.debug(f),l!==null){if(!this.keyFormatPromise){let c=Object.keys(this.keySystemAccessPromises);c.length||(c=nn(this.config));const y=c.map(so).filter(S=>!!S);this.keyFormatPromise=this.getKeyFormatPromise(y)}this.keyFormatPromise.then(c=>{const y=ro(c);let S,T;if(n==="sinf"){if(y!==Je.FAIRPLAY){this.warn(`Ignoring unexpected "${r.type}" event with init data type: "${n}" for selected key-system ${y}`);return}const D=It(new Uint8Array(l));try{const M=jo(JSON.parse(D).sinf),F=fd(M);if(!F)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");S=new Uint8Array(F.subarray(8,24)),T=Je.FAIRPLAY}catch(M){this.warn(`${f} Failed to parse sinf: ${M}`);return}}else{if(y!==Je.WIDEVINE&&y!==Je.PLAYREADY){this.warn(`Ignoring unexpected "${r.type}" event with init data type: "${n}" for selected key-system ${y}`);return}const D=Op(l),M=D.filter($=>!!$.systemId&&io($.systemId)===y);M.length>1&&this.warn(`${f} Using first of ${M.length} pssh found for selected key-system ${y}`);const F=M[0];if(!F){D.length===0||D.some($=>!$.systemId)?this.warn(`${f} contains incomplete or invalid pssh data`):this.log(`ignoring ${f} for ${D.map($=>io($.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(T=io(F.systemId),F.version===0&&F.data)if(T===Je.WIDEVINE){const $=F.data.length-22;S=new Uint8Array(F.data.subarray($,$+16))}else T===Je.PLAYREADY&&(S=Rd(F.data))}if(!T||!S)return;const A=gr.hexDump(S),{keyIdToKeySessionPromise:L,mediaKeySessions:b}=this;let C=L[A];for(let D=0;D<b.length;D++){const M=b[D],F=M.decryptdata;if(!F.keyId)continue;const $=gr.hexDump(F.keyId);if(A===$||F.uri.replace(/-/g,"").indexOf(A)!==-1){if(C=L[$],F.pssh)break;delete L[$],F.pssh=new Uint8Array(l),F.keyId=S,C=L[A]=C.then(()=>this.generateRequestWithPreferredKeySession(M,n,l,"encrypted-event-key-match")),C.catch(H=>this.handleError(H));break}}if(!C){if(T!==y){this.log(`Ignoring "${r.type}" event with ${T} init data for selected key-system ${y}`);return}C=L[A]=this.getKeySystemSelectionPromise([T]).then(({keySystem:D,mediaKeys:M})=>{var F;this.throwIfDestroyed();const $=new is("ISO-23001-7",A,(F=so(D))!=null?F:"");return $.pssh=new Uint8Array(l),$.keyId=S,this.attemptSetMediaKeys(D,M).then(()=>{this.throwIfDestroyed();const H=this.createMediaKeySessionContext({decryptdata:$,keySystem:D,mediaKeys:M});return this.generateRequestWithPreferredKeySession(H,n,l,"encrypted-event-no-match")})}),C.catch(D=>this.handleError(D))}})}},this.onWaitingForKey=r=>{this.log(`"${r.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){const e=this.media;this.unregisterListeners(),this.onMediaDetached(),this._clear(e);const r=this.config;r.requestMediaKeySystemAccessFunc=null,r.licenseXhrSetup=r.licenseResponseCallback=void 0,r.drmSystems=r.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(w.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(w.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(w.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(w.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(w.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(w.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:r,widevineLicenseUrl:n}=this.config,l=r[e];if(l)return l.licenseUrl;if(e===Je.WIDEVINE&&n)return n}getLicenseServerUrlOrThrow(e){const r=this.getLicenseServerUrl(e);if(r===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return r}getServerCertificateUrl(e){const{drmSystems:r}=this.config,n=r[e];if(n)return n.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const r=this.hls.levels,n=(c,y,S)=>!!c&&S.indexOf(c)===y,l=r.map(c=>c.audioCodec).filter(n),f=r.map(c=>c.videoCodec).filter(n);return l.length+f.length===0&&f.push("avc1.42e01e"),new Promise((c,y)=>{const S=T=>{const A=T.shift();this.getMediaKeysPromise(A,l,f).then(L=>c({keySystem:A,mediaKeys:L})).catch(L=>{T.length?S(T):L instanceof Xt?y(L):y(new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_NO_ACCESS,error:L,fatal:!0},L.message))})};S(e)})}requestMediaKeySystemAccess(e,r){const{requestMediaKeySystemAccessFunc:n}=this.config;if(typeof n!="function"){let l=`Configured requestMediaKeySystemAccess is not a function ${n}`;return Id===null&&self.location.protocol==="http:"&&(l=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(l))}return n(e,r)}getMediaKeysPromise(e,r,n){const l=Iy(e,r,n,this.config.drmSystemOptions),f=this.keySystemAccessPromises[e];let c=f==null?void 0:f.keySystemAccess;if(!c){this.log(`Requesting encrypted media "${e}" key-system access with config: ${ot(l)}`),c=this.requestMediaKeySystemAccess(e,l);const y=this.keySystemAccessPromises[e]={keySystemAccess:c};return c.catch(S=>{this.log(`Failed to obtain access to key-system "${e}": ${S}`)}),c.then(S=>{this.log(`Access for key-system "${S.keySystem}" obtained`);const T=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),y.mediaKeys=S.createMediaKeys().then(A=>(this.log(`Media-keys created for "${e}"`),T.then(L=>L?this.setMediaKeysServerCertificate(A,e,L):A))),y.mediaKeys.catch(A=>{this.error(`Failed to create media-keys for "${e}"}: ${A}`)}),y.mediaKeys})}return c.then(()=>f.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:r,mediaKeys:n}){this.log(`Creating key-system session "${r}" keyId: ${gr.hexDump(e.keyId||[])}`);const l=n.createSession(),f={decryptdata:e,keySystem:r,mediaKeys:n,mediaKeysSession:l,keyStatus:"status-pending"};return this.mediaKeySessions.push(f),f}renewKeySession(e){const r=e.decryptdata;if(r.pssh){const n=this.createMediaKeySessionContext(e),l=this.getKeyIdString(r),f="cenc";this.keyIdToKeySessionPromise[l]=this.generateRequestWithPreferredKeySession(n,f,r.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return gr.hexDump(e.keyId)}updateKeySession(e,r){var n;const l=e.mediaKeysSession;return this.log(`Updating key-session "${l.sessionId}" for keyID ${gr.hexDump(((n=e.decryptdata)==null?void 0:n.keyId)||[])}
      } (data length: ${r&&r.byteLength})`),l.update(r)}selectKeySystemFormat(e){const r=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${r.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(r)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((r,n)=>{const l=nn(this.config),f=e.map(ro).filter(c=>!!c&&l.indexOf(c)!==-1);return this.getKeySystemSelectionPromise(f).then(({keySystem:c})=>{const y=so(c);y?r(y):n(new Error(`Unable to find format for key-system "${c}"`))}).catch(n)})}loadKey(e){const r=e.keyInfo.decryptdata,n=this.getKeyIdString(r),l=`(keyId: ${n} format: "${r.keyFormat}" method: ${r.method} uri: ${r.uri})`;this.log(`Starting session for key ${l}`);let f=this.keyIdToKeySessionPromise[n];return f||(f=this.getKeySystemForKeyPromise(r).then(({keySystem:y,mediaKeys:S})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${l}`),this.attemptSetMediaKeys(y,S).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:y,mediaKeys:S,decryptdata:r}))))),(this.keyIdToKeySessionPromise[n]=f.then(y=>{const S="cenc",T=r.pssh?r.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(y,S,T,"playlist-key")})).catch(y=>this.handleError(y))),f}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof Xt?this.hls.trigger(w.ERROR,e.data):this.hls.trigger(w.ERROR,{type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const r=this.getKeyIdString(e),n=this.keyIdToKeySessionPromise[r];if(!n){const l=ro(e.keyFormat),f=l?[l]:nn(this.config);return this.attemptKeySystemAccess(f)}return n}getKeySystemSelectionPromise(e){if(e.length||(e=nn(this.config)),e.length===0)throw new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${ot({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,r){const n=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const l=Promise.all(n).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(r)});return this.setMediaKeysQueue.push(l),l.then(()=>{this.log(`Media-keys set for "${e}"`),n.push(l),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(f=>n.indexOf(f)===-1)})}generateRequestWithPreferredKeySession(e,r,n,l){var f,c;const y=(f=this.config.drmSystems)==null||(c=f[e.keySystem])==null?void 0:c.generateRequest;if(y)try{const D=y.call(this.hls,r,n,e);if(!D)throw new Error("Invalid response from configured generateRequest filter");r=D.initDataType,n=D.initData?D.initData:null,e.decryptdata.pssh=n?new Uint8Array(n):null}catch(D){var S;if(this.warn(D.message),(S=this.hls)!=null&&S.config.debug)throw D}if(n===null)return this.log(`Skipping key-session request for "${l}" (no initData)`),Promise.resolve(e);const T=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${l}": ${T} (init data type: ${r} length: ${n?n.byteLength:null})`);const A=new zo,L=e._onmessage=D=>{const M=e.mediaKeysSession;if(!M){A.emit("error",new Error("invalid state"));return}const{messageType:F,message:$}=D;this.log(`"${F}" message event for session "${M.sessionId}" message size: ${$.byteLength}`),F==="license-request"||F==="license-renewal"?this.renewLicense(e,$).catch(H=>{A.eventNames().length?A.emit("error",H):this.handleError(H)}):F==="license-release"?e.keySystem===Je.FAIRPLAY&&(this.updateKeySession(e,bo("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${F}"`)},b=e._onkeystatuseschange=D=>{if(!e.mediaKeysSession){A.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const F=e.keyStatus;A.emit("keyStatus",F),F==="expired"&&(this.warn(`${e.keySystem} expired for key ${T}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",L),e.mediaKeysSession.addEventListener("keystatuseschange",b);const C=new Promise((D,M)=>{A.on("error",M),A.on("keyStatus",F=>{F.startsWith("usable")?D():F==="output-restricted"?M(new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):F==="internal-error"?M(new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${F}"`)):F==="expired"?M(new Error("key expired while generating request")):this.warn(`unhandled key status change "${F}"`)})});return e.mediaKeysSession.generateRequest(r,n).then(()=>{var D;this.log(`Request generated for key-session "${(D=e.mediaKeysSession)==null?void 0:D.sessionId}" keyId: ${T}`)}).catch(D=>{throw new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_NO_SESSION,error:D,fatal:!1},`Error generating key-session request: ${D}`)}).then(()=>C).catch(D=>{throw A.removeAllListeners(),this.removeSession(e),D}).then(()=>(A.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((r,n)=>{this.log(`key status change "${r}" for keyStatuses keyId: ${gr.hexDump("buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n))} session keyId: ${gr.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=r})}fetchServerCertificate(e){const r=this.config,n=r.loader,l=new n(r),f=this.getServerCertificateUrl(e);return f?(this.log(`Fetching server certificate for "${e}"`),new Promise((c,y)=>{const S={responseType:"arraybuffer",url:f},T=r.certLoadPolicy.default,A={loadPolicy:T,timeout:T.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},L={onSuccess:(b,C,D,M)=>{c(b.data)},onError:(b,C,D,M)=>{y(new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:D,response:Ze({url:S.url,data:void 0},b)},`"${e}" certificate request failed (${f}). Status: ${b.code} (${b.text})`))},onTimeout:(b,C,D)=>{y(new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:D,response:{url:S.url,data:void 0}},`"${e}" certificate request timed out (${f})`))},onAbort:(b,C,D)=>{y(new Error("aborted"))}};l.load(S,A,L)})):Promise.resolve()}setMediaKeysServerCertificate(e,r,n){return new Promise((l,f)=>{e.setServerCertificate(n).then(c=>{this.log(`setServerCertificate ${c?"success":"not supported by CDM"} (${n==null?void 0:n.byteLength}) on "${r}"`),l(e)}).catch(c=>{f(new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:c,fatal:!0},c.message))})})}renewLicense(e,r){return this.requestLicense(e,new Uint8Array(r)).then(n=>this.updateKeySession(e,new Uint8Array(n)).catch(l=>{throw new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:l,fatal:!0},l.message)}))}unpackPlayReadyKeyMessage(e,r){const n=String.fromCharCode.apply(null,new Uint16Array(r.buffer));if(!n.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),r;const l=new DOMParser().parseFromString(n,"application/xml"),f=l.querySelectorAll("HttpHeader");if(f.length>0){let A;for(let L=0,b=f.length;L<b;L++){var c,y;A=f[L];const C=(c=A.querySelector("name"))==null?void 0:c.textContent,D=(y=A.querySelector("value"))==null?void 0:y.textContent;C&&D&&e.setRequestHeader(C,D)}}const S=l.querySelector("Challenge"),T=S==null?void 0:S.textContent;if(!T)throw new Error("Cannot find <Challenge> in key message");return bo(atob(T))}setupLicenseXHR(e,r,n,l){const f=this.config.licenseXhrSetup;return f?Promise.resolve().then(()=>{if(!n.decryptdata)throw new Error("Key removed");return f.call(this.hls,e,r,n,l)}).catch(c=>{if(!n.decryptdata)throw c;return e.open("POST",r,!0),f.call(this.hls,e,r,n,l)}).then(c=>(e.readyState||e.open("POST",r,!0),{xhr:e,licenseChallenge:c||l})):(e.open("POST",r,!0),Promise.resolve({xhr:e,licenseChallenge:l}))}requestLicense(e,r){const n=this.config.keyLoadPolicy.default;return new Promise((l,f)=>{const c=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${c}`);const y=new XMLHttpRequest;y.responseType="arraybuffer",y.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return f(new Error("invalid state"));if(y.readyState===4)if(y.status===200){this._requestLicenseFailureCount=0;let S=y.response;this.log(`License received ${S instanceof ArrayBuffer?S.byteLength:S}`);const T=this.config.licenseResponseCallback;if(T)try{S=T.call(this.hls,y,c,e)}catch(A){this.error(A)}l(S)}else{const S=n.errorRetry,T=S?S.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>T||y.status>=400&&y.status<500)f(new Xt({type:De.KEY_SYSTEM_ERROR,details:re.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:y,response:{url:c,data:void 0,code:y.status,text:y.statusText}},`License Request XHR failed (${c}). Status: ${y.status} (${y.statusText})`));else{const A=T-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${A} attempts left`),this.requestLicense(e,r).then(l,f)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=y,this.setupLicenseXHR(y,c,e,r).then(({xhr:S,licenseChallenge:T})=>{e.keySystem==Je.PLAYREADY&&(T=this.unpackPlayReadyKeyMessage(S,T)),S.send(T)})})}onMediaAttached(e,r){if(!this.config.emeEnabled)return;const n=r.media;this.media=n,n.removeEventListener("encrypted",this.onMediaEncrypted),n.removeEventListener("waitingforkey",this.onWaitingForKey),n.addEventListener("encrypted",this.onMediaEncrypted),n.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null)}_clear(e){var r;const n=this.mediaKeySessions;this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},is.clearKeyUriToKeyIdMap();const l=n.length;bi.CDMCleanupPromise=Promise.all(n.map(f=>this.removeSession(f)).concat(e==null||(r=e.setMediaKeys(null))==null?void 0:r.catch(f=>{var c;this.log(`Could not clear media keys: ${f}`),(c=this.hls)==null||c.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${f}`)})}))).then(()=>{l&&(this.log("finished closing key sessions and clearing media keys"),n.length=0)}).catch(f=>{var c;this.log(`Could not close sessions and clear media keys: ${f}`),(c=this.hls)==null||c.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${f}`)})})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:r}){if(!(!r||!this.config.emeEnabled)&&!this.keyFormatPromise){const n=r.reduce((l,f)=>(l.indexOf(f.keyFormat)===-1&&l.push(f.keyFormat),l),[]);this.log(`Selecting key-system from session-keys ${n.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(n)}}removeSession(e){const{mediaKeysSession:r,licenseXhr:n}=e;if(r){this.log(`Remove licenses and keys and close session ${r.sessionId}`),e._onmessage&&(r.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(r.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const l=this.mediaKeySessions.indexOf(e);return l>-1&&this.mediaKeySessions.splice(l,1),r.remove().catch(f=>{var c;this.log(`Could not remove session: ${f}`),(c=this.hls)==null||c.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${f}`)})}).then(()=>r.close()).catch(f=>{var c;this.log(`Could not close session: ${f}`),(c=this.hls)==null||c.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${f}`)})})}}}bi.CDMCleanupPromise=void 0;class Xt extends Error{constructor(e,r){super(r),this.data=void 0,e.error||(e.error=new Error(r)),this.data=e,e.err=e.error}}class MT{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(w.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(w.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(w.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(w.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,r){const n=this.hls.config;if(n.capLevelOnFPSDrop){const l=r.media instanceof self.HTMLVideoElement?r.media:null;this.media=l,l&&typeof l.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),n.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,r,n){const l=performance.now();if(r){if(this.lastTime){const f=l-this.lastTime,c=n-this.lastDroppedFrames,y=r-this.lastDecodedFrames,S=1e3*c/f,T=this.hls;if(T.trigger(w.FPS_DROP,{currentDropped:c,currentDecoded:y,totalDroppedFrames:n}),S>0&&c>T.config.fpsDroppedMonitoringThreshold*y){let A=T.currentLevel;T.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+A),A>0&&(T.autoLevelCapping===-1||T.autoLevelCapping>=A)&&(A=A-1,T.trigger(w.FPS_DROP_LEVEL_CAPPING,{level:A,droppedLevel:T.currentLevel}),T.autoLevelCapping=A,this.streamController.nextLevelSwitch())}}this.lastTime=l,this.lastDroppedFrames=n,this.lastDecodedFrames=r}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const r=e.getVideoPlaybackQuality();this.checkFPS(e,r.totalVideoFrames,r.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function uc(v,e){let r;try{r=new Event("addtrack")}catch{r=document.createEvent("Event"),r.initEvent("addtrack",!1,!1)}r.track=v,e.dispatchEvent(r)}function hc(v,e){const r=v.mode;if(r==="disabled"&&(v.mode="hidden"),v.cues&&!v.cues.getCueById(e.id))try{if(v.addCue(e),!v.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(n){qe.debug(`[texttrack-utils]: ${n}`);try{const l=new self.TextTrackCue(e.startTime,e.endTime,e.text);l.id=e.id,v.addCue(l)}catch(l){qe.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${l}`)}}r==="disabled"&&(v.mode=r)}function Ii(v,e){const r=v.mode;if(r==="disabled"&&(v.mode="hidden"),v.cues)for(let n=v.cues.length;n--;)e&&v.cues[n].removeEventListener("enter",e),v.removeCue(v.cues[n]);r==="disabled"&&(v.mode=r)}function Mo(v,e,r,n){const l=v.mode;if(l==="disabled"&&(v.mode="hidden"),v.cues&&v.cues.length>0){const f=NT(v.cues,e,r);for(let c=0;c<f.length;c++)(!n||n(f[c]))&&v.removeCue(f[c])}l==="disabled"&&(v.mode=l)}function FT(v,e){if(e<=v[0].startTime)return 0;const r=v.length-1;if(e>v[r].endTime)return-1;let n=0,l=r,f;for(;n<=l;)if(f=Math.floor((l+n)/2),e<v[f].startTime)l=f-1;else if(e>v[f].startTime&&n<r)n=f+1;else return f;return v[n].startTime-e<e-v[l].startTime?n:l}function NT(v,e,r){const n=[],l=FT(v,e);if(l>-1)for(let f=l,c=v.length;f<c;f++){const y=v[f];if(y.startTime>=e&&y.endTime<=r)n.push(y);else if(y.startTime>r)return n}return n}function En(v){const e=[];for(let r=0;r<v.length;r++){const n=v[r];(n.kind==="subtitles"||n.kind==="captions")&&n.label&&e.push(v[r])}return e}class UT extends il{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let r=null;const n=En(this.media.textTracks);for(let f=0;f<n.length;f++)if(n[f].mode==="hidden")r=n[f];else if(n[f].mode==="showing"){r=n[f];break}const l=this.findTrackForTextTrack(r);this.subtitleTrack!==l&&this.setSubtitleTrack(l)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.MANIFEST_PARSED,this.onManifestParsed,this),e.on(w.LEVEL_LOADING,this.onLevelLoading,this),e.on(w.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(w.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(w.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.MANIFEST_PARSED,this.onManifestParsed,this),e.off(w.LEVEL_LOADING,this.onLevelLoading,this),e.off(w.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(w.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(w.ERROR,this.onError,this)}onMediaAttached(e,r){this.media=r.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,r){const n=this.media;if(!n)return;const l=!!r.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||n.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,l)return;En(n.textTracks).forEach(c=>{Ii(c)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,r){this.tracks=r.subtitleTracks}onSubtitleTrackLoaded(e,r){const{id:n,groupId:l,details:f}=r,c=this.tracksInGroup[n];if(!c||c.groupId!==l){this.warn(`Subtitle track with id:${n} and group:${l} not found in active group ${c==null?void 0:c.groupId}`);return}const y=c.details;c.details=r.details,this.log(`Subtitle track ${n} "${c.name}" lang:${c.lang} group:${l} loaded [${f.startSN}-${f.endSN}]`),n===this.trackId&&this.playlistLoaded(n,r,y)}onLevelLoading(e,r){this.switchLevel(r.level)}onLevelSwitching(e,r){this.switchLevel(r.level)}switchLevel(e){const r=this.hls.levels[e];if(!r)return;const n=r.subtitleGroups||null,l=this.groupIds;let f=this.currentTrack;if(!n||(l==null?void 0:l.length)!==(n==null?void 0:n.length)||n!=null&&n.some(c=>(l==null?void 0:l.indexOf(c))===-1)){this.groupIds=n,this.trackId=-1,this.currentTrack=null;const c=this.tracks.filter(A=>!n||n.indexOf(A.groupId)!==-1);if(c.length)this.selectDefaultTrack&&!c.some(A=>A.default)&&(this.selectDefaultTrack=!1),c.forEach((A,L)=>{A.id=L});else if(!f&&!this.tracksInGroup.length)return;this.tracksInGroup=c;const y=this.hls.config.subtitlePreference;if(!f&&y){this.selectDefaultTrack=!1;const A=mr(y,c);if(A>-1)f=c[A];else{const L=mr(y,this.tracks);f=this.tracks[L]}}let S=this.findTrackId(f);S===-1&&f&&(S=this.findTrackId(null));const T={subtitleTracks:c};this.log(`Updating subtitle tracks, ${c.length} track(s) found in "${n==null?void 0:n.join(",")}" group-id`),this.hls.trigger(w.SUBTITLE_TRACKS_UPDATED,T),S!==-1&&this.trackId===-1&&this.setSubtitleTrack(S)}}findTrackId(e){const r=this.tracksInGroup,n=this.selectDefaultTrack;for(let l=0;l<r.length;l++){const f=r[l];if(!(n&&!f.default||!n&&!e)&&(!e||ti(f,e)))return l}if(e){for(let l=0;l<r.length;l++){const f=r[l];if(os(e.attrs,f.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<r.length;l++){const f=r[l];if(os(e.attrs,f.attrs,["LANGUAGE"]))return l}}return-1}findTrackForTextTrack(e){if(e){const r=this.tracksInGroup;for(let n=0;n<r.length;n++){const l=r[n];if(ko(l,e))return n}}return-1}onError(e,r){r.fatal||!r.context||r.context.type===$e.SUBTITLE_TRACK&&r.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(r.context.groupId)!==-1)&&this.checkRetry(r)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const r=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,r.length){const n=this.currentTrack;if(n&&ti(e,n))return n;const l=mr(e,this.tracksInGroup);if(l>-1){const f=this.tracksInGroup[l];return this.setSubtitleTrack(l),f}else{if(n)return null;{const f=mr(e,r);if(f>-1)return r[f]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,r){super.loadingPlaylist(e,r);const n=e.id,l=e.groupId,f=this.getUrlWithDirectives(e.url,r),c=e.details,y=c==null?void 0:c.age;this.log(`Loading subtitle ${n} "${e.name}" lang:${e.lang} group:${l}${(r==null?void 0:r.msn)!==void 0?" at sn "+r.msn+" part "+r.part:""}${y&&c.live?" age "+y.toFixed(1)+(c.type&&" "+c.type||""):""} ${f}`),this.hls.trigger(w.SUBTITLE_TRACK_LOADING,{url:f,id:n,groupId:l,deliveryDirectives:r||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const r=En(e.textTracks),n=this.currentTrack;let l;if(n&&(l=r.filter(f=>ko(n,f))[0],l||this.warn(`Unable to find subtitle TextTrack with name "${n.name}" and language "${n.lang}"`)),[].slice.call(r).forEach(f=>{f.mode!=="disabled"&&f!==l&&(f.mode="disabled")}),l){const f=this.subtitleDisplay?"showing":"hidden";l.mode!==f&&(l.mode=f)}}setSubtitleTrack(e){const r=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=r.length||!Ae(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const n=this.currentTrack,l=r[e]||null;if(this.trackId=e,this.currentTrack=l,this.toggleTrackModes(),!l){this.hls.trigger(w.SUBTITLE_TRACK_SWITCH,{id:e});return}const f=!!l.details&&!l.details.live;if(e===this.trackId&&l===n&&f)return;this.log(`Switching to subtitle-track ${e}`+(l?` "${l.name}" lang:${l.lang} group:${l.groupId}`:""));const{id:c,groupId:y="",name:S,type:T,url:A}=l;this.hls.trigger(w.SUBTITLE_TRACK_SWITCH,{id:c,groupId:y,name:S,type:T,url:A});const L=this.switchParams(l.url,n==null?void 0:n.details,l.details);this.loadPlaylist(L)}}function Ji(v){let e=5381,r=v.length;for(;r;)e=e*33^v.charCodeAt(--r);return(e>>>0).toString()}const _i=.025;let Pn=function(v){return v[v.Point=0]="Point",v[v.Range=1]="Range",v}({});function BT(v,e,r){return`${v.identifier}-${r+1}-${Ji(e)}`}class GT{constructor(e,r){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=r,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){if(e>=this.assetList.length)return!0;const r=this.playoutLimit;return e<=0||isNaN(r)?!1:this.assetList[e].startOffset>r}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const r=this.dateRange.tagAnchor;if(r)return go(e,r)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const r=this.dateRange.startTime,n=go(r,e);return r-n<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,r=Ae(e)?e:this.duration;return this.cumulativeDuration+r}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const r=this.resumeAnchor;if(r)return go(e,r)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<_i))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let r;return this._duration!==null?r=this._duration:this.dateRange.duration?r=this.dateRange.duration:r=this.dateRange.plannedDuration||0,!isNaN(e)&&e<r&&(r=e),r}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Pn.Range:Pn.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return $T(this)}}function go(v,e){return v-e.start<e.duration/2&&!(Math.abs(v-(e.start+e.duration))<_i)?e.start:e.start+e.duration}function fc(v,e,r){const n=new self.URL(v,r);return n.protocol!=="data:"&&n.searchParams.set("_HLS_primary_id",e),n}function $T(v){return`["${v.identifier}" ${v.cue.pre?"<pre>":v.cue.post?"<post>":""}${v.timelineStart.toFixed(2)}-${v.resumeTime.toFixed(2)}]`}function Fo(v){const e=v.timelineStart,r=v.duration||0;return`["${v.identifier}" ${e.toFixed(2)}-${(e+r).toFixed(2)}]`}class KT{constructor(e,r,n,l){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{const T=this.interstitial.playoutLimit,A=this.currentTime;this.startOffset+A>=T&&this.hls.trigger(w.PLAYOUT_LIMIT_REACHED,{})};const f=this.hls=new e(r);this.interstitial=n,this.assetItem=l;let c=l.uri;try{c=fc(c,f.sessionId).href}catch{}f.loadSource(c);const y=()=>{this.hasDetails=!0};f.once(w.LEVEL_LOADED,y),f.once(w.AUDIO_TRACK_LOADED,y),f.once(w.SUBTITLE_TRACK_LOADED,y),f.on(w.MEDIA_ATTACHING,(S,{media:T})=>{this.removeMediaListeners(),this.mediaAttached=T,this.interstitial.playoutLimit&&T.addEventListener("timeupdate",this.checkPlayout)})}bufferedInPlaceToEnd(e){var r;if(!this.interstitial.appendInPlace)return!1;if((r=this.hls)!=null&&r.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const n=this.timelineOffset,l=Be.bufferInfo(e,n,0);return this.getAssetTime(l.end)>=this._bufferedEosTime-.02}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const r=Be.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(r.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;return e||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const r=this.timelineOffset;if(e!==r){const n=e-r;if(Math.abs(n)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const r=this.timelineOffset,n=this.duration;return Math.min(Math.max(0,e-r),n)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}on(e,r,n){this.hls.on(e,r)}once(e,r,n){this.hls.once(e,r)}off(e,r,n){this.hls.off(e,r)}toString(){var e,r;return`HlsAssetPlayer: ${Fo(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${(r=this.interstitial)!=null&&r.appendInPlace?"append-in-place":""}`}}const Kf=.033;class VT extends Cr{constructor(e,r){super("interstitials-sched",r),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,r){return this.events?this.events.reduce((n,l)=>e<=l.startOffset&&r>l.startOffset?(delete l.error,n+1):n,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,r){if(e.event)return this.findEventIndex(e.event.identifier);let n=-1;e.nextEvent?n=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(n=this.findEventIndex(e.previousEvent.identifier)+1);const l=this.items;if(l)for(l[n]||(r===void 0&&(r=e.start),n=this.findItemIndexAtTime(r));n>=0&&(f=l[n])!=null&&f.event;){var f;n--}return n}findItemIndexAtTime(e,r){const n=this.items;if(n)for(let l=0;l<n.length;l++){let f=n[l];if(r&&r!=="primary"&&(f=f[r]),e===f.start||e>f.start&&e<f.end)return l}return-1}findJumpRestrictedIndex(e,r){const n=this.items;if(n)for(let l=e;l<=r&&n[l];l++){const f=n[l].event;if(f!=null&&f.restrictions.jump&&!f.appendInPlace)return l}return-1}findEventIndex(e){const r=this.items;if(r)for(let l=r.length;l--;){var n;if(((n=r[l].event)==null?void 0:n.identifier)===e)return l}return-1}findAssetIndex(e,r){const n=e.assetList,l=n.length;if(l>1)for(let f=0;f<l;f++){const c=n[f];if(!c.error){const y=c.timelineStart;if(r===y||r>y&&r<y+(c.duration||0))return f}}return 0}get assetIdAtEnd(){var e,r;const n=(e=this.items)==null||(r=e[this.length-1])==null?void 0:r.event;if(n){const l=n.assetList,f=l[l.length-1];if(f)return f.identifier}return null}parseInterstitialDateRanges(e,r){const n=e.main.details,{dateRanges:l}=n,f=this.events,c=this.parseDateRanges(l,{url:n.url},r),y=Object.keys(l),S=f?f.filter(T=>!y.includes(T.identifier)):[];c.length&&c.sort((T,A)=>{const L=T.cue.pre,b=T.cue.post,C=A.cue.pre,D=A.cue.post;if(L&&!C)return-1;if(C&&!L||b&&!D)return 1;if(D&&!b)return-1;if(!L&&!C&&!b&&!D){const M=T.startTime,F=A.startTime;if(M!==F)return M-F}return T.dateRange.tagOrder-A.dateRange.tagOrder}),this.events=c,S.forEach(T=>{this.removeEvent(T)}),this.updateSchedule(e,S)}updateSchedule(e,r=[]){const n=this.events||[];if(n.length||r.length||this.length<2){const l=this.items,f=this.parseSchedule(n,e);(r.length||(l==null?void 0:l.length)!==f.length||f.some((y,S)=>Math.abs(y.playout.start-l[S].playout.start)>.005||Math.abs(y.playout.end-l[S].playout.end)>.005))&&(this.items=f,this.onScheduleUpdate(r,l))}}parseDateRanges(e,r,n){const l=[],f=Object.keys(e);for(let c=0;c<f.length;c++){const y=f[c],S=e[y];if(S.isInterstitial){let T=this.eventMap[y];T?T.setDateRange(S):(T=new GT(S,r),this.eventMap[y]=T,n===!1&&(T.appendInPlace=n)),l.push(T)}}return l}parseSchedule(e,r){const n=[],l=r.main.details,f=l.live?1/0:l.edge;let c=0;if(e=e.filter(S=>!S.error&&!(S.cue.once&&S.hasPlayed)),e.length){this.resolveOffsets(e,r);let S=0,T=0;if(e.forEach((A,L)=>{const b=A.cue.pre,C=A.cue.post,D=e[L-1]||null,M=A.appendInPlace,F=C?f:A.startOffset,$=A.duration,H=A.timelineOccupancy===Pn.Range?$:0,K=A.resumptionOffset,z=(D==null?void 0:D.startTime)===F,Q=F+A.cumulativeDuration;let ne=M?Q+$:F+K;if(b||!C&&F<=0){const ie=T;T+=H,A.timelineStart=Q;const le=c;c+=$,n.push({event:A,start:Q,end:ne,playout:{start:le,end:c},integrated:{start:ie,end:T}})}else if(F<=f){if(!z){const ee=F-S;if(ee>Kf){const ve=S,Ee=T;T+=ee;const Ne=c;c+=ee;const Ce={previousEvent:e[L-1]||null,nextEvent:A,start:ve,end:ve+ee,playout:{start:Ne,end:c},integrated:{start:Ee,end:T}};n.push(Ce)}else ee>0&&D&&(D.cumulativeDuration+=ee,n[n.length-1].end=F)}C&&(ne=Q),A.timelineStart=Q;const ie=T;T+=H;const le=c;c+=$,n.push({event:A,start:Q,end:ne,playout:{start:le,end:c},integrated:{start:ie,end:T}})}else return;const Z=A.resumeTime;C||Z>f?S=f:S=Z}),S<f){var y;const A=S,L=T,b=f-S;T+=b;const C=c;c+=b,n.push({previousEvent:((y=n[n.length-1])==null?void 0:y.event)||null,nextEvent:null,start:S,end:A+b,playout:{start:C,end:c},integrated:{start:L,end:T}})}this.setDurations(f,c,T)}else n.push({previousEvent:null,nextEvent:null,start:0,end:f,playout:{start:0,end:f},integrated:{start:0,end:f}}),this.setDurations(f,f,f);return n}setDurations(e,r,n){this.durations={primary:e,playout:r,integrated:n}}resolveOffsets(e,r){const n=r.main.details,l=n.live?1/0:n.edge;let f=0,c=-1;e.forEach((y,S)=>{const T=y.cue.pre,A=y.cue.post,L=T?0:A?l:y.startTime;this.updateAssetDurations(y),c===L?y.cumulativeDuration=f:(f=0,c=L),!A&&y.snapOptions.in&&(y.resumeAnchor=ri(null,n.fragments,y.startOffset+y.resumptionOffset,0,0)||void 0),y.appendInPlace&&!y.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(y,r)||(y.appendInPlace=!1)),!y.appendInPlace&&S+1<e.length&&e[S+1].startTime-e[S].resumeTime<Kf&&(e[S+1].appendInPlace=!1,e[S+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${y}`));const C=Ae(y.resumeOffset)?y.resumeOffset:y.duration;f+=C})}primaryCanResumeInPlaceAt(e,r){const n=e.resumeTime,l=e.startTime+e.resumptionOffset;return Math.abs(n-l)>_i?(this.log(`"${e.identifier}" resumption ${n} not aligned with estimated timeline end ${l}`),!1):r?!Object.keys(r).some(c=>{const y=r[c].details,S=y.edge;if(n>=S)return this.log(`"${e.identifier}" resumption ${n} past ${c} playlist end ${S}`),!1;const T=ri(null,y.fragments,n);if(!T)return this.log(`"${e.identifier}" resumption ${n} does not align with any fragments in ${c} playlist (${y.fragStart}-${y.fragmentEnd})`),!0;const A=c==="audio"?.175:0;return Math.abs(T.start-n)<_i+A||Math.abs(T.end-n)<_i+A?!1:(this.log(`"${e.identifier}" resumption ${n} not aligned with ${c} fragment bounds (${T.start}-${T.end} sn: ${T.sn} cc: ${T.cc})`),!0)}):(this.log(`"${e.identifier}" resumption ${n} can not be aligned with media (none selected)`),!1)}updateAssetDurations(e){if(!e.assetListLoaded)return;const r=e.timelineStart;let n=0,l=!1,f=!1;e.assetList.forEach((c,y)=>{const S=r+n;c.startOffset=n,c.timelineStart=S,l||(l=c.duration===null),f||(f=!!c.error);const T=c.error?0:c.duration||0;n+=T}),l&&!f?e.duration=Math.max(n,e.duration):e.duration=n}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Br(v){return`[${v.event?'"'+v.event.identifier+'"':"primary"}: ${v.start.toFixed(2)}-${v.end.toFixed(2)}]`}class HT{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,r){const n=e.assetListUrl;let l;try{l=fc(n,this.hls.sessionId,e.baseUrl)}catch(b){const C=this.assignAssetListError(e,re.ASSET_LIST_LOAD_ERROR,b,n);this.hls.trigger(w.ERROR,C);return}r&&l.protocol!=="data:"&&l.searchParams.set("_HLS_start_offset",""+r);const f=this.hls.config,c=f.loader,y=new c(f),S={responseType:"json",url:l.href},T=f.interstitialAssetListLoadPolicy.default,A={loadPolicy:T,timeout:T.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},L={onSuccess:(b,C,D,M)=>{const F=b.data,$=F==null?void 0:F.ASSETS;if(!Array.isArray($)){const H=this.assignAssetListError(e,re.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),D.url,C,M);this.hls.trigger(w.ERROR,H);return}e.assetListResponse=F,this.hls.trigger(w.ASSET_LIST_LOADED,{event:e,assetListResponse:F,networkDetails:M})},onError:(b,C,D,M)=>{const F=this.assignAssetListError(e,re.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${b.code} ${b.text} (${C.url})`),C.url,M,D);this.hls.trigger(w.ERROR,F)},onTimeout:(b,C,D)=>{const M=this.assignAssetListError(e,re.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${C.url})`),C.url,b,D);this.hls.trigger(w.ERROR,M)}};return y.load(S,A,L),this.hls.trigger(w.ASSET_LIST_LOADING,{event:e}),y}assignAssetListError(e,r,n,l,f,c){return e.error=n,{type:De.NETWORK_ERROR,details:r,fatal:!1,interstitial:e,url:l,error:n,networkDetails:c,stats:f}}}function Dr(v,e,r){yr(v,e,r),v.addEventListener(e,r)}function yr(v,e,r){v.removeEventListener(e,r)}function Vf(v){v==null||v.play().catch(()=>{})}class YT extends Cr{constructor(e,r){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const n=this.currentTime;if(n===void 0||this.playbackDisabled)return;const l=n-this.timelinePos;if(Math.abs(l)<1/7056e5)return;const c=l<=-.01;this.timelinePos=n,this.bufferedPos=n;const y=this.playingItem;if(!y){this.checkBuffer();return}if(c&&this.schedule.resetErrorsInRange(n,n-l)&&this.updateSchedule(),this.checkBuffer(),c&&n<y.start||n>=y.end){var S;const b=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(y)&&(S=this.media)!=null&&S.paused&&(this.shouldPlay=!1),!c){const C=this.findItemIndex(y);if(b>C){const D=this.schedule.findJumpRestrictedIndex(C+1,b);if(D>C){this.setSchedulePosition(D);return}}}this.setSchedulePosition(b);return}const T=this.playingAsset;if(!T){if(this.playingLastItem&&this.isInterstitial(y)){const b=y.event.assetList[0];b&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(n,b))}return}const A=T.timelineStart,L=T.duration||0;(c&&n<A||n>=A+L)&&this.setScheduleToAssetAtTime(n,T)},this.onTimeupdate=()=>{const n=this.currentTime;if(n===void 0||this.playbackDisabled)return;if(n>this.timelinePos)this.timelinePos=n,n>this.bufferedPos&&this.checkBuffer();else return;const l=this.playingItem;if(!l||this.playingLastItem)return;if(n>=l.end){this.timelinePos=l.end;const y=this.findItemIndex(l);this.setSchedulePosition(y+1)}const f=this.playingAsset;if(!f)return;const c=f.timelineStart+(f.duration||0);n>=c&&this.setScheduleToAssetAtTime(n,f)},this.onScheduleUpdate=(n,l)=>{const f=this.schedule,c=this.playingItem,y=f.events||[],S=f.items||[],T=f.durations,A=n.map(C=>C.identifier),L=!!(y.length||A.length);if(L&&this.log(`INTERSTITIALS_UPDATED (${y.length}): ${y}
Schedule: ${S.map(C=>Br(C))}`),A.length&&this.log(`Removed events ${A}`),this.playerQueue.forEach(C=>{if(C.interstitial.appendInPlace){const D=C.assetItem.timelineStart,M=C.timelineOffset-D;if(M)try{C.timelineOffset=D}catch(F){Math.abs(M)>_i&&this.warn(`${F} ("${C.assetId}" ${C.timelineOffset}->${D})`)}}}),c){const C=this.updateItem(c,this.timelinePos);this.itemsMatch(c,C)&&(this.playingItem=C,this.waitingItem=this.endedItem=null)}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const b=this.bufferingItem;if(b){const C=this.updateItem(b,this.bufferedPos);this.itemsMatch(b,C)?this.bufferingItem=C:b.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(b.event,null))}if(n.forEach(C=>{C.assetList.forEach(D=>{this.clearAssetPlayer(D.identifier,null)})}),L||l){if(this.hls.trigger(w.INTERSTITIALS_UPDATED,{events:y.slice(0),schedule:S.slice(0),durations:T,removedIds:A}),this.isInterstitial(c)&&A.includes(c.event.identifier)){this.warn(`Interstitial "${c.event.identifier}" removed while playing`),this.primaryFallback(c.event);return}this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=r,this.assetListLoader=new HT(e),this.schedule=new VT(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(w.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(w.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(w.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(w.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(w.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(w.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(w.BUFFER_APPENDED,this.onBufferAppended,this),e.on(w.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(w.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(w.MEDIA_ENDED,this.onMediaEnded,this),e.on(w.ERROR,this.onError,this),e.on(w.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(w.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(w.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(w.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(w.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(w.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(w.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(w.BUFFER_CODECS,this.onBufferCodecs,this),e.off(w.BUFFER_APPENDED,this.onBufferAppended,this),e.off(w.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(w.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(w.MEDIA_ENDED,this.onMediaEnded,this),e.off(w.ERROR,this.onError,this),e.off(w.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){yr(e,"play",this.onPlay),yr(e,"pause",this.onPause),yr(e,"seeking",this.onSeeking),yr(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,r){const n=this.media=r.media;Dr(n,"seeking",this.onSeeking),Dr(n,"timeupdate",this.onTimeupdate),Dr(n,"play",this.onPlay),Dr(n,"pause",this.onPause)}onMediaAttached(e,r){const n=this.effectivePlayingItem,l=this.detachedData;if(this.detachedData=null,n===null)this.checkStart();else if(!l){this.clearScheduleState();const f=this.findItemIndex(n);this.setSchedulePosition(f)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,r){const n=!!r.transferMedia,l=this.media;if(this.media=null,!n&&(l&&this.removeMediaListeners(l),this.detachedData)){const f=this.getBufferingPlayer();f&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,f.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,r=()=>e.bufferingItem||e.waitingItem,n=L=>L&&e.getAssetPlayer(L.identifier),l=(L,b,C,D,M)=>{if(L){let F=L[b].start;const $=L.event;if($){if(b==="playout"||$.timelineOccupancy!==Pn.Point){const H=n(C);(H==null?void 0:H.interstitial)===$&&(F+=H.assetItem.startOffset+H[M])}}else{const H=D==="bufferedPos"?c():e[D];F+=H-L.start}return F}return 0},f=(L,b)=>{if(L!==0&&b!=="primary"&&e.schedule.length){var C;const D=e.schedule.findItemIndexAtTime(L),M=(C=e.schedule.items)==null?void 0:C[D];if(M){const F=M[b].start-M.start;return L+F}}return L},c=()=>{const L=e.bufferedPos;return L===Number.MAX_VALUE?y("primary"):Math.max(L,0)},y=L=>{var b;return(b=e.primaryDetails)!=null&&b.live?e.primaryDetails.edge:e.schedule.durations[L]},S=(L,b)=>{var C,D;const M=e.effectivePlayingItem;if(M!=null&&(C=M.event)!=null&&C.restrictions.skip)return;e.log(`seek to ${L} "${b}"`);const F=e.effectivePlayingItem,$=e.schedule.findItemIndexAtTime(L,b),H=(D=e.schedule.items)==null?void 0:D[$],K=e.getBufferingPlayer(),z=K==null?void 0:K.interstitial,Q=z==null?void 0:z.appendInPlace,ne=F&&e.itemsMatch(F,H);if(F&&(Q||ne)){const ie=n(e.playingAsset),le=(ie==null?void 0:ie.media)||e.primaryMedia;if(le){const ee=b==="primary"?le.currentTime:l(F,b,e.playingAsset,"timelinePos","currentTime"),ve=L-ee,Ee=(Q?ee:le.currentTime)+ve;if(Ee>=0&&(!ie||Q||Ee<=ie.duration)){le.currentTime=Ee;return}}}if(H){let ie=L;if(b!=="primary"){const ee=H[b].start,ve=L-ee;ie=H.start+ve}const le=!e.isInterstitial(H);if((!e.isInterstitial(F)||F.event.appendInPlace)&&(le||H.event.appendInPlace)){const ee=e.media||(Q?K==null?void 0:K.media:null);ee&&(ee.currentTime=ie)}else if(F){const ee=e.findItemIndex(F);if($>ee){const Ee=e.schedule.findJumpRestrictedIndex(ee+1,$);if(Ee>ee){e.setSchedulePosition(Ee);return}}let ve=0;if(le)e.timelinePos=ie,e.checkBuffer();else{var Z;const Ee=H==null||(Z=H.event)==null?void 0:Z.assetList;if(Ee){const Ne=L-(H[b]||H).start;for(let Ce=Ee.length;Ce--;){const _e=Ee[Ce];if(_e.duration&&Ne>=_e.startOffset&&Ne<_e.startOffset+_e.duration){ve=Ce;break}}}}e.setSchedulePosition($,ve)}}},T=()=>{const L=e.effectivePlayingItem;if(e.isInterstitial(L))return L;const b=r();return e.isInterstitial(b)?b:null},A={get currentTime(){const L=T(),b=e.effectivePlayingItem;return b&&b===L?l(b,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-b.playout.start:0},set currentTime(L){const b=T(),C=e.effectivePlayingItem;C&&C===b&&S(L+C.playout.start,"playout")},get duration(){const L=T();return L?L.playout.end-L.playout.start:0},get assetPlayers(){var L;const b=(L=T())==null?void 0:L.event.assetList;return b?b.map(C=>e.getAssetPlayer(C.identifier)):[]},get playingIndex(){var L;const b=(L=T())==null?void 0:L.event;return b&&e.effectivePlayingAsset?b.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return T()}};this.manager={get events(){var L,b;return((L=e.schedule)==null||(b=L.events)==null?void 0:b.slice(0))||[]},get schedule(){var L,b;return((L=e.schedule)==null||(b=L.items)==null?void 0:b.slice(0))||[]},get interstitialPlayer(){return T()?A:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return r()},get bufferingIndex(){const L=r();return e.findItemIndex(L)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const L=e.effectivePlayingItem;return e.findItemIndex(L)},primary:{get bufferedEnd(){return c()},get currentTime(){const L=e.timelinePos;return L>0?L:0},set currentTime(L){S(L,"primary")},get duration(){return y("primary")},get seekableStart(){var L;return((L=e.primaryDetails)==null?void 0:L.fragmentStart)||0}},integrated:{get bufferedEnd(){return l(r(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return l(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(L){S(L,"integrated")},get duration(){return y("integrated")},get seekableStart(){var L;return f(((L=e.primaryDetails)==null?void 0:L.fragmentStart)||0,"integrated")}},skip:()=>{const L=e.effectivePlayingItem,b=L==null?void 0:L.event;if(b&&!b.restrictions.skip){const C=e.findItemIndex(L);if(b.appendInPlace){const D=L.playout.start+L.event.duration;S(D+.001,"playout")}else e.advanceAfterAssetEnded(b,C,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const r=this.playingItem,n=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!r||!n?!1:this.findItemIndex(r)===n.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,r,n;if(this.mediaSelection===null)return;const l=this.waitingItem||this.playingItem;if(this.isInterstitial(l)&&!l.event.appendInPlace)return;let f=this.media;!f&&(e=this.bufferingItem)!=null&&(r=e.event)!=null&&r.appendInPlace&&(f=this.primaryMedia);const c=(n=f)==null?void 0:n.currentTime;if(!(c===void 0||!Ae(c)))return c}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,r){const n=this.getAssetPlayer(e);n&&this.transferMediaFromPlayer(n,r)}transferMediaFromPlayer(e,r){const n=e.interstitial.appendInPlace,l=e.media;if(n&&l===this.primaryMedia){if(this.bufferingAsset=null,(!r||this.isInterstitial(r)&&!r.event.appendInPlace)&&r&&l){this.detachedData={media:l};return}const f=e.transferMedia();this.log(`transfer MediaSource from ${e} ${ot(f)}`),this.detachedData=f}else r&&l&&(this.shouldPlay||(this.shouldPlay=!l.paused))}transferMediaTo(e,r){var n,l;if(e.media===r)return;let f=null;const c=this.hls,y=e!==c,S=y&&e.interstitial.appendInPlace,T=(n=this.detachedData)==null?void 0:n.mediaSource;let A;if(c.media)S&&(f=c.transferMedia(),this.detachedData=f),A="Primary";else if(T){const C=this.getBufferingPlayer();C?(f=C.transferMedia(),A=`${C}`):A="detached MediaSource"}else A="detached media";if(!f){if(T)f=this.detachedData,this.log(`using detachedData: MediaSource ${ot(f)}`);else if(!this.detachedData||c.media===r){const C=this.playerQueue;C.length>1&&C.forEach(D=>{if(y&&D.interstitial.appendInPlace!==S){const M=D.interstitial;this.clearInterstitial(D.interstitial,null),M.appendInPlace=!1,M.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${M}`)}}),this.hls.detachMedia(),this.detachedData={media:r}}}const L=f&&"mediaSource"in f&&((l=f.mediaSource)==null?void 0:l.readyState)!=="closed",b=L&&f?f:r;if(this.log(`${L?"transfering MediaSource":"attaching media"} to ${y?e:"Primary"} from ${A}`),b===f){const C=y&&e.assetId===this.schedule.assetIdAtEnd;b.overrides={duration:this.schedule.duration,endOfStream:!y||C,cueRemoval:!y}}e.attachMedia(b)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,r=e.events;if(!r||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const n=this.timelinePos,l=this.effectivePlayingItem;if(n===-1){const f=this.hls.startPosition;if(this.timelinePos=f,r.length&&r[0].cue.pre){const c=e.findEventIndex(r[0].identifier);this.setSchedulePosition(c)}else if(f>=0||!this.primaryLive){const c=this.timelinePos=f>0?f:0,y=e.findItemIndexAtTime(c);this.setSchedulePosition(y)}}else if(l&&!this.playingItem){const f=e.findItemIndex(l);this.setSchedulePosition(f)}}advanceAfterAssetEnded(e,r,n){const l=n+1;if(!e.isAssetPastPlayoutLimit(l)&&!e.assetList[l].error)this.setSchedulePosition(r,l);else{const f=this.schedule.items;if(f){const c=r+1,y=f.length;if(c>=y){this.setSchedulePosition(-1);return}const S=e.resumeTime;this.timelinePos<S&&(this.timelinePos=S,this.checkBuffer()),this.setSchedulePosition(c)}}}setScheduleToAssetAtTime(e,r){const n=this.schedule,l=r.parentIdentifier,f=n.getEvent(l);if(f){const c=n.findEventIndex(l),y=n.findAssetIndex(f,e);this.setSchedulePosition(c,y)}}setSchedulePosition(e,r){const n=this.schedule.items;if(!n||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${r}`);const l=e>=0?n[e]:null,f=this.playingItem,c=this.playingLastItem;if(this.isInterstitial(f)){var y;const T=f.event,A=this.playingAsset,L=A==null?void 0:A.identifier,b=L?this.getAssetPlayer(L):null;if(b&&L&&(!this.eventItemsMatch(f,l)||r!==void 0&&L!==((y=T.assetList)==null?void 0:y[r].identifier))){var S;const C=T.findAssetIndex(A);this.log(`INTERSTITIAL_ASSET_ENDED ${C+1}/${T.assetList.length} ${Fo(A)}`),this.endedAsset=A,this.playingAsset=null,this.hls.trigger(w.INTERSTITIAL_ASSET_ENDED,{asset:A,assetListIndex:C,event:T,schedule:n.slice(0),scheduleIndex:e,player:b}),this.retreiveMediaSource(L,l),b.media&&!((S=this.detachedData)!=null&&S.mediaSource)&&b.detachMedia()}if(!this.eventItemsMatch(f,l)&&(this.endedItem=f,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${T} ${Br(f)}`),T.hasPlayed=!0,this.hls.trigger(w.INTERSTITIAL_ENDED,{event:T,schedule:n.slice(0),scheduleIndex:e}),T.cue.once)){this.updateSchedule();const C=this.schedule.items;if(l&&C){const D=this.schedule.findItemIndex(l);this.advanceSchedule(D,C,r,f,c)}return}}this.advanceSchedule(e,n,r,f,c)}advanceSchedule(e,r,n,l,f){const c=e>=0?r[e]:null,y=this.primaryMedia,S=this.playerQueue;if(S.length&&S.forEach(T=>{const A=T.interstitial,L=this.schedule.findEventIndex(A.identifier);(L<e||L>e+1)&&this.clearInterstitial(A,c)}),this.isInterstitial(c)){this.timelinePos=Math.min(Math.max(this.timelinePos,c.start),c.end);const T=c.event;n===void 0&&(n=this.schedule.findAssetIndex(T,this.timelinePos));const A=this.waitingItem;this.assetsBuffered(c,y)||this.setBufferingItem(c);let L=this.preloadAssets(T,n);if(this.eventItemsMatch(c,A||l)||(this.waitingItem=c,this.log(`INTERSTITIAL_STARTED ${Br(c)} ${T.appendInPlace?"append in place":""}`),this.hls.trigger(w.INTERSTITIAL_STARTED,{event:T,schedule:r.slice(0),scheduleIndex:e})),!T.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${T}`);return}if(T.assetListLoader&&(T.assetListLoader.destroy(),T.assetListLoader=void 0),!y){this.log(`Waiting for attachMedia to start Interstitial ${T}`);return}this.waitingItem=this.endedItem=null,this.playingItem=c;const b=T.assetList[n];if(!b){const C=r[e+1],D=this.media;C&&D&&!this.isInterstitial(C)&&D.currentTime<C.start&&(D.currentTime=this.timelinePos=C.start),this.advanceAfterAssetEnded(T,e,n||0);return}if(L||(L=this.getAssetPlayer(b.identifier)),L===null||L.destroyed){const C=T.assetList.length;this.warn(`asset ${n+1}/${C} player destroyed ${T}`),L=this.createAssetPlayer(T,b,n)}if(!this.eventItemsMatch(c,this.bufferingItem)&&T.appendInPlace&&this.isAssetBuffered(b))return;this.startAssetPlayer(L,n,r,e,y),this.shouldPlay&&Vf(L.media)}else c!==null?(this.resumePrimary(c,e,l),this.shouldPlay&&Vf(this.hls.media)):f&&this.isInterstitial(l)&&(this.endedItem=null,this.playingItem=l,l.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e,r;return(e=this.mediaSelection)==null||(r=e.main)==null?void 0:r.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,r,n){var l;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Br(e)}`),!((l=this.detachedData)!=null&&l.mediaSource)){let c=this.timelinePos;(c<e.start||c>=e.end)&&(c=this.getPrimaryResumption(e,r),this.timelinePos=c),this.attachPrimary(c,e)}if(!n)return;const f=this.schedule.items;f&&(this.log(`resumed ${Br(e)}`),this.hls.trigger(w.INTERSTITIALS_PRIMARY_RESUMED,{schedule:f.slice(0),scheduleIndex:r}),this.checkBuffer())}getPrimaryResumption(e,r){const n=e.start;if(this.primaryLive){const l=this.primaryDetails;if(r===0)return this.hls.startPosition;if(l&&(n<l.fragmentStart||n>l.edge))return this.hls.liveSyncPosition||-1}return n}isAssetBuffered(e){const r=this.getAssetPlayer(e.identifier);return r!=null&&r.hls?r.hls.bufferedToEnd:Be.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,r,n){r?this.setBufferingItem(r):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const l=this.primaryMedia;if(!l)return;const f=this.hls;f.media?this.checkBuffer():(this.transferMediaTo(f,l),n&&this.startLoadingPrimaryAt(e,n)),n||(this.timelinePos=e,this.startLoadingPrimaryAt(e,n))}startLoadingPrimaryAt(e,r){var n;const l=this.hls;!l.loadingEnabled||!l.media||Math.abs((((n=l.mainForwardBufferInfo)==null?void 0:n.start)||l.media.currentTime)-e)>.5?l.startLoad(e,r):l.bufferingEnabled||l.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(w.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(w.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,r){if(r.level===-1)return;const n=this.hls.levels[r.level],l=Ze(Ze({},this.mediaSelection||this.altSelection),{},{main:n});this.mediaSelection=l,this.schedule.parseInterstitialDateRanges(l,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,r){const n=this.hls.audioTracks[r.id],l=this.mediaSelection;if(!l){this.altSelection=Ze(Ze({},this.altSelection),{},{audio:n});return}const f=Ze(Ze({},l),{},{audio:n});this.mediaSelection=f}onSubtitleTrackUpdated(e,r){const n=this.hls.subtitleTracks[r.id],l=this.mediaSelection;if(!l){this.altSelection=Ze(Ze({},this.altSelection),{},{subtitles:n});return}const f=Ze(Ze({},l),{},{subtitles:n});this.mediaSelection=f}onAudioTrackSwitching(e,r){const n=tf(r);this.playerQueue.forEach(l=>l.hls.setAudioOption(r)||l.hls.setAudioOption(n))}onSubtitleTrackSwitch(e,r){const n=tf(r);this.playerQueue.forEach(l=>l.hls.setSubtitleOption(r)||r.id!==-1&&l.hls.setSubtitleOption(n))}onBufferCodecs(e,r){const n=r.tracks;n&&(this.requiredTracks=n)}onBufferAppended(e,r){this.checkBuffer()}onBufferFlushed(e,r){const n=this.playingItem;if(n&&!this.itemsMatch(n,this.bufferingItem)&&!this.isInterstitial(n)){const l=this.timelinePos;this.bufferedPos=l,this.checkBuffer()}}onBufferedToEnd(e){const r=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&r){for(let l=0;l<r.length;l++){const f=r[l];if(f.cue.post){var n;const c=this.schedule.findEventIndex(f.identifier),y=(n=this.schedule.items)==null?void 0:n[c];this.isInterstitial(y)&&this.eventItemsMatch(y,this.bufferingItem)&&this.bufferedToItem(y,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const r=this.playingItem;if(!this.playingLastItem&&r){const n=this.findItemIndex(r);this.setSchedulePosition(n+1)}else this.shouldPlay=!1}updateItem(e,r){const n=this.schedule.items;if(e&&n){const l=this.findItemIndex(e,r);return n[l]||null}return null}itemsMatch(e,r){return!!r&&(e===r||e.event&&r.event&&this.eventItemsMatch(e,r)||!e.event&&!r.event&&this.findItemIndex(e)===this.findItemIndex(r))}eventItemsMatch(e,r){var n;return!!r&&(e===r||e.event.identifier===((n=r.event)==null?void 0:n.identifier))}findItemIndex(e,r){return e?this.schedule.findItemIndex(e,r):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const r=this.schedule.items;if(!r)return;const n=Be.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=n.len<1),this.updateBufferedPos(n.end,r,e)}updateBufferedPos(e,r,n){const l=this.schedule,f=this.bufferingItem;if(this.bufferedPos>e)return;if(r.length===1&&this.itemsMatch(r[0],f)){this.bufferedPos=e;return}const c=this.playingItem,y=this.findItemIndex(c);let S=l.findItemIndexAtTime(e);if(this.bufferedPos<e){var T,A;const L=this.findItemIndex(f),b=Math.min(L+1,r.length-1),C=r[b];if((S===-1&&f&&e>=f.end||(T=C.event)!=null&&T.appendInPlace&&e+.01>=C.start)&&(S=b),b-y>1&&(f==null||(A=f.event)==null?void 0:A.appendInPlace)===!1)return;if(this.bufferedPos=e,S>L&&S>y)this.bufferedToItem(C);else{const D=this.primaryDetails;this.primaryLive&&D&&e>D.edge-D.targetduration&&C.start<D.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(C)&&this.preloadAssets(C.event,0)}}else n&&c&&!this.itemsMatch(c,f)&&(S===y?this.bufferedToItem(c):S===y+1&&this.bufferedToItem(r[S]))}assetsBuffered(e,r){return e.event.assetList.length===0?!1:!e.event.assetList.some(l=>{const f=this.getAssetPlayer(l.identifier);return!(f!=null&&f.bufferedInPlaceToEnd(r))})}setBufferingItem(e){const r=this.bufferingItem,n=this.schedule;if(this.itemsMatch(e,r))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:l,events:f}=n;if(!l||!f)return r;const c=this.isInterstitial(e),y=this.getBufferingPlayer();if(this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos)),!this.playbackDisabled){const S=y?y.remaining:r?r.end-this.timelinePos:0;this.log(`buffered to boundary ${Br(e)}`+(r?` (${S.toFixed(2)} remaining)`:"")),c?e.event.assetList.forEach(T=>{const A=this.getAssetPlayer(T.identifier);A&&A.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(T=>T.pauseBuffering()))}this.hls.trigger(w.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:f.slice(0),schedule:l.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return r}bufferedToItem(e,r=0){const n=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,r);else if(n!==null){this.bufferingAsset=null;const l=this.detachedData;l?l.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const r=this.findItemIndex(e),n=this.getPrimaryResumption(e,r);this.startLoadingPrimaryAt(n)}bufferedToEvent(e,r){const n=e.event,l=n.assetList.length===0&&!n.assetListLoader,f=n.cue.once;if(l||!f){const c=this.preloadAssets(n,r);if(c!=null&&c.interstitial.appendInPlace){const y=n.assetList[r],S=this.primaryMedia;y&&S&&this.bufferAssetPlayer(c,S)}}}preloadAssets(e,r){const n=e.assetUrl,l=e.assetList.length,f=l===0&&!e.assetListLoader,c=e.cue.once;if(f){const S=e.timelineStart;if(e.appendInPlace){var y;const b=this.playingItem;!this.isInterstitial(b)&&(b==null||(y=b.nextEvent)==null?void 0:y.identifier)===e.identifier&&this.flushFrontBuffer(S+.25)}let T,A=0;if(!this.playingItem&&this.primaryLive&&(A=this.hls.startPosition,A===-1&&(A=this.hls.liveSyncPosition||0)),A&&!(e.cue.pre||e.cue.post)){const b=A-S;b>0&&(T=Math.round(b*1e3)/1e3)}if(this.log(`Load interstitial asset ${r+1}/${n?1:l} ${e}${T?` live-start: ${A} start-offset: ${T}`:""}`),n)return this.createAsset(e,0,0,S,e.duration,n);const L=this.assetListLoader.loadAssetList(e,T);L&&(e.assetListLoader=L)}else if(!c&&l){for(let S=r;S<l;S++){const T=e.assetList[S],A=this.getAssetPlayerQueueIndex(T.identifier);(A===-1||this.playerQueue[A].destroyed)&&!T.error&&this.createAssetPlayer(e,T,S)}return this.getAssetPlayer(e.assetList[r].identifier)}return null}flushFrontBuffer(e){const r=this.requiredTracks;if(!r)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(r).forEach(l=>{this.hls.trigger(w.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:l})})}getAssetPlayerQueueIndex(e){const r=this.playerQueue;for(let n=0;n<r.length;n++)if(e===r[n].assetId)return n;return-1}getAssetPlayer(e){const r=this.getAssetPlayerQueueIndex(e);return this.playerQueue[r]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:r}=this;if(r){for(let n=0;n<e.length;n++)if(e[n].media===r)return e[n]}return null}createAsset(e,r,n,l,f,c){const y={parentIdentifier:e.identifier,identifier:BT(e,c,r),duration:f,startOffset:n,timelineStart:l,uri:c};return this.createAssetPlayer(e,y,r)}createAssetPlayer(e,r,n){this.log(`create HLSAssetPlayer for ${Fo(r)}`);const l=this.hls,f=l.userConfig;let c=f.videoPreference;const y=l.loadLevelObj||l.levels[l.currentLevel];(c||y)&&(c=rt({},c),y.videoCodec&&(c.videoCodec=y.videoCodec),y.videoRange&&(c.allowedVideoRanges=[y.videoRange]));const S=l.audioTracks[l.audioTrack],T=l.subtitleTracks[l.subtitleTrack];let A=0;if(this.primaryLive||e.appendInPlace){const K=this.timelinePos-r.timelineStart;if(K>1){const z=r.duration;z&&K<z&&(A=K)}}const L=r.identifier,b=Ze(Ze({},f),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:l.sessionId,assetPlayerId:L,abrEwmaDefaultEstimate:l.bandwidthEstimate,interstitialsController:void 0,startPosition:A,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:c,audioPreference:S||f.audioPreference,subtitlePreference:T||f.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,r.timelineStart&&(b.timelineOffset=r.timelineStart));const C=b.cmcd;C!=null&&C.sessionId&&C.contentId&&(b.cmcd=rt({},C,{contentId:Ji(r.uri)})),this.getAssetPlayer(L)&&this.warn(`Duplicate date range identifier ${e} and asset ${L}`);const D=new KT(this.HlsPlayerClass,b,e,r);this.playerQueue.push(D),e.assetList[n]=r;const M=K=>{if(K.live){const ne=new Error(`Interstitials MUST be VOD assets ${e}`),Z={fatal:!0,type:De.OTHER_ERROR,details:re.INTERSTITIAL_ASSET_ITEM_ERROR,error:ne};this.handleAssetItemError(Z,e,this.schedule.findEventIndex(e.identifier),n,ne.message);return}const z=K.edge-K.fragmentStart,Q=r.duration;(Q===null||z>Q)&&(this.log(`Interstitial asset "${L}" duration change ${Q} > ${z}`),r.duration=z,this.updateSchedule())};D.on(w.LEVEL_UPDATED,(K,{details:z})=>M(z)),D.on(w.LEVEL_PTS_UPDATED,(K,{details:z})=>M(z));const F=(K,z)=>{const Q=this.getAssetPlayer(L);if(Q&&z.tracks){Q.off(w.BUFFER_CODECS,F),Q.tracks=z.tracks;const ne=this.primaryMedia;this.bufferingAsset===Q.assetItem&&ne&&!Q.media&&this.bufferAssetPlayer(Q,ne)}};D.on(w.BUFFER_CODECS,F);const $=()=>{var K;const z=this.getAssetPlayer(L);if(this.log(`buffered to end of asset ${z}`),!z)return;const Q=this.schedule.findEventIndex(e.identifier),ne=e.findAssetIndex(r),Z=ne+1,ie=(K=this.schedule.items)==null?void 0:K[Q];if(this.isInterstitial(ie))if(ne!==-1&&!e.isAssetPastPlayoutLimit(Z)&&!e.assetList[Z].error)this.bufferedToItem(ie,Z);else{var le;const ee=(le=this.schedule.items)==null?void 0:le[Q+1];ee&&this.bufferedToItem(ee)}};D.on(w.BUFFERED_TO_END,$);const H=K=>()=>{if(!this.getAssetPlayer(L))return;this.shouldPlay=!0;const Q=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,Q,K)};return D.once(w.MEDIA_ENDED,H(n)),D.once(w.PLAYOUT_LIMIT_REACHED,H(1/0)),D.on(w.ERROR,(K,z)=>{const Q=this.getAssetPlayer(L);if(z.details===re.BUFFER_STALLED_ERROR){if(Q!=null&&Q.media){const ne=Q.currentTime,Z=Q.duration-ne;ne&&e.appendInPlace&&Z/Q.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${L} ${e} at ${Q.media.currentTime}`),$()):(this.warn(`Stalled at ${ne} of ${ne+Z} in asset ${L} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}return}this.handleAssetItemError(z,e,this.schedule.findEventIndex(e.identifier),n,`Asset player error ${z.error} ${e}`)}),D.on(w.DESTROYING,()=>{if(!this.getAssetPlayer(L))return;const z=new Error(`Asset player destroyed unexpectedly ${L}`),Q={fatal:!0,type:De.OTHER_ERROR,details:re.INTERSTITIAL_ASSET_ITEM_ERROR,error:z};this.handleAssetItemError(Q,e,this.schedule.findEventIndex(e.identifier),n,z.message)}),this.hls.trigger(w.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:r,assetListIndex:n,event:e,player:D}),D}clearInterstitial(e,r){e.assetList.forEach(n=>{this.clearAssetPlayer(n.identifier,r)}),e.reset()}clearAssetPlayer(e,r){const n=this.getAssetPlayerQueueIndex(e);if(n!==-1){this.log(`clearAssetPlayer "${e}" toSegment: ${r&&Br(r)}`);const l=this.playerQueue[n];this.transferMediaFromPlayer(l,r),this.playerQueue.splice(n,1),l.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,r,n,l,f){const{interstitial:c,assetItem:y,assetId:S}=e,T=c.assetList.length,A=this.playingAsset;this.endedAsset=null,this.playingAsset=y,(!A||A.identifier!==S)&&(A&&(this.clearAssetPlayer(A.identifier,n[l]),delete A.error),this.log(`INTERSTITIAL_ASSET_STARTED ${r+1}/${T} ${e}`),this.hls.trigger(w.INTERSTITIAL_ASSET_STARTED,{asset:y,assetListIndex:r,event:c,schedule:n.slice(0),scheduleIndex:l,player:e})),this.bufferAssetPlayer(e,f)}bufferAssetPlayer(e,r){var n,l;const{interstitial:f,assetItem:c,assetId:y}=e,S=this.schedule.findEventIndex(f.identifier),T=(n=this.schedule.items)==null?void 0:n[S];if(!T)return;this.setBufferingItem(T),this.bufferingAsset=c;const A=this.getBufferingPlayer();if(A===e)return;const L=f.appendInPlace;if(L&&(A==null?void 0:A.interstitial.appendInPlace)===!1)return;const b=(A==null?void 0:A.tracks)||((l=this.detachedData)==null?void 0:l.tracks)||this.requiredTracks;if(L&&c!==this.playingAsset){if(!e.tracks)return;if(b&&!sd(b,e.tracks)){const C=new Error(`Asset "${y}" SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(b)}')`),D={fatal:!0,type:De.OTHER_ERROR,details:re.INTERSTITIAL_ASSET_ITEM_ERROR,error:C},M=f.findAssetIndex(c);this.handleAssetItemError(D,f,S,M,C.message);return}}this.transferMediaTo(e,r)}handleAssetItemError(e,r,n,l,f){if(e.details===re.BUFFER_STALLED_ERROR)return;const c=r.assetList[l]||null;let y=null;if(c){const L=this.getAssetPlayerQueueIndex(c.identifier);y=this.playerQueue[L]||null}const S=this.schedule.items,T=rt({},e,{fatal:!1,errorAction:rs(!0),asset:c,assetListIndex:l,event:r,schedule:S,scheduleIndex:n,player:y});if(this.warn(`Asset item error: ${e.error}`),this.hls.trigger(w.INTERSTITIAL_ASSET_ERROR,T),!e.fatal)return;const A=new Error(f);c&&(this.playingAsset!==c&&this.clearAssetPlayer(c.identifier,null),c.error=A),r.assetList.some(L=>!L.error)?r.appendInPlace&&(r.error=A):r.error=A,this.primaryFallback(r)}primaryFallback(e){const r=e.timelineStart,n=this.effectivePlayingItem;if(this.updateSchedule(),n){this.log(`Fallback to primary from event "${e.identifier}" start: ${r} pos: ${this.timelinePos} playing: ${n?Br(n):"<none>"} error: ${e.error}`),e.appendInPlace&&(this.attachPrimary(r,null),this.flushFrontBuffer(r));let l=this.timelinePos;l===-1&&(l=this.hls.startPosition);const f=this.updateItem(n,l);if(this.itemsMatch(n,f))this.clearInterstitial(e,null);else{const c=this.schedule.findItemIndexAtTime(l);this.setSchedulePosition(c)}}else this.checkStart()}onAssetListLoaded(e,r){var n;const l=r.event,f=l.identifier,c=r.assetListResponse.ASSETS;if(!this.schedule.hasEvent(f))return;const y=l.timelineStart,S=l.duration;let T=0;c.forEach((D,M)=>{const F=parseFloat(D.DURATION);this.createAsset(l,M,T,y+T,F,D.URI),T+=F}),l.duration=T,this.log(`Loaded asset-list with duration: ${T} (was: ${S}) ${l}`);const A=this.waitingItem,L=(A==null?void 0:A.event.identifier)===f;this.updateSchedule();const b=(n=this.bufferingItem)==null?void 0:n.event;if(L){var C;const D=this.schedule.findEventIndex(f),M=(C=this.schedule.items)==null?void 0:C[D];if(M){if(!this.playingItem&&this.timelinePos>M.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==D){l.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${l}`),this.primaryFallback(l);return}this.setBufferingItem(M)}this.setSchedulePosition(D)}else if((b==null?void 0:b.identifier)===f&&b.appendInPlace){const D=l.assetList[0],M=this.getAssetPlayer(D.identifier),F=this.primaryMedia;D&&M&&F&&this.bufferAssetPlayer(M,F)}}onError(e,r){switch(r.details){case re.ASSET_LIST_PARSING_ERROR:case re.ASSET_LIST_LOAD_ERROR:case re.ASSET_LIST_LOAD_TIMEOUT:{const n=r.interstitial;n&&this.primaryFallback(n);break}case re.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}}}const Hf=500;class WT extends Xo{constructor(e,r,n){super(e,r,n,"subtitle-stream-controller",be.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(w.LEVEL_LOADED,this.onLevelLoaded,this),e.on(w.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(w.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(w.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(w.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(w.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(w.LEVEL_LOADED,this.onLevelLoaded,this),e.off(w.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(w.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(w.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(w.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(w.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,r){this.stopLoad(),this.state=de.IDLE,this.setInterval(Hf),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=r?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,r){this.tracksBuffered=[],super.onMediaDetaching(e,r)}onLevelLoaded(e,r){this.mainDetails=r.details}onSubtitleFragProcessed(e,r){const{frag:n,success:l}=r;if(wt(n)&&(this.fragPrevious=n),this.state=de.IDLE,!l)return;const f=this.tracksBuffered[this.currentTrackId];if(!f)return;let c;const y=n.start;for(let T=0;T<f.length;T++)if(y>=f[T].start&&y<=f[T].end){c=f[T];break}const S=n.start+n.duration;c?c.end=S:(c={start:y,end:S},f.push(c)),this.fragmentTracker.fragBuffered(n),this.fragBufferedComplete(n,null),this.media&&this.tick()}onBufferFlushing(e,r){const{startOffset:n,endOffset:l}=r;if(n===0&&l!==Number.POSITIVE_INFINITY){const f=l-1;if(f<=0)return;r.endOffsetSubtitles=Math.max(0,f),this.tracksBuffered.forEach(c=>{for(let y=0;y<c.length;){if(c[y].end<=f){c.shift();continue}else if(c[y].start<f)c[y].start=f;else break;y++}}),this.fragmentTracker.removeFragmentsInRange(n,f,be.SUBTITLE)}}onError(e,r){const n=r.frag;(n==null?void 0:n.type)===be.SUBTITLE&&(r.details===re.FRAG_GAP&&this.fragmentTracker.fragBuffered(n,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==de.STOPPED&&(this.state=de.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:r}){if(this.levels&&rc(this.levels,r)){this.levels=r.map(n=>new ts(n));return}this.tracksBuffered=[],this.levels=r.map(n=>{const l=new ts(n);return this.tracksBuffered[l.id]=[],l}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,be.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,r){var n;if(this.currentTrackId=r.id,!((n=this.levels)!=null&&n.length)||this.currentTrackId===-1){this.clearInterval();return}const l=this.levels[this.currentTrackId];l!=null&&l.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,l&&this.state!==de.STOPPED&&this.setInterval(Hf)}onSubtitleTrackLoaded(e,r){var n;const{currentTrackId:l,levels:f}=this,{details:c,id:y}=r;if(!f){this.warn(`Subtitle tracks were reset while loading level ${y}`);return}const S=f[y];if(y>=f.length||!S)return;this.log(`Subtitle track ${y} loaded [${c.startSN},${c.endSN}]${c.lastPartSn?`[part-${c.lastPartSn}-${c.lastPartIndex}]`:""},duration:${c.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let T=0;if(c.live||(n=S.details)!=null&&n.live){const L=this.mainDetails;if(c.deltaUpdateFailed||!L)return;const b=L.fragments[0];if(!S.details)c.hasProgramDateTime&&L.hasProgramDateTime?(Dn(c,L),T=c.fragmentStart):b&&(T=b.start,Do(c,T));else{var A;T=this.alignPlaylists(c,S.details,(A=this.levelLastLoaded)==null?void 0:A.details),T===0&&b&&(T=b.start,Do(c,T))}}S.details=c,this.levelLastLoaded=S,y===l&&(this.hls.trigger(w.SUBTITLE_TRACK_UPDATED,{details:c,id:y,groupId:r.groupId}),this.tick(),c.live&&!this.fragCurrent&&this.media&&this.state===de.IDLE&&(ri(null,c.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),S.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:r,payload:n}=e,l=r.decryptdata,f=this.hls;if(!this.fragContextChanged(r)&&n&&n.byteLength>0&&l!=null&&l.key&&l.iv&&Ri(l.method)){const c=performance.now();this.decrypter.decrypt(new Uint8Array(n),l.key.buffer,l.iv.buffer,qo(l.method)).catch(y=>{throw f.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.FRAG_DECRYPT_ERROR,fatal:!1,error:y,reason:y.message,frag:r}),y}).then(y=>{const S=performance.now();f.trigger(w.FRAG_DECRYPTED,{frag:r,payload:y,stats:{tstart:c,tdecrypt:S}})}).catch(y=>{this.warn(`${y.name}: ${y.message}`),this.state=de.IDLE})}}doTick(){if(!this.media){this.state=de.IDLE;return}if(this.state===de.IDLE){const{currentTrackId:e,levels:r}=this,n=r==null?void 0:r[e];if(!n||!r.length||!n.details||this.waitForLive(n))return;const{config:l}=this,f=this.getLoadPosition(),c=Be.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],f,l.maxBufferHole),{end:y,len:S}=c,T=n.details,A=this.hls.maxBufferLength+T.levelTargetDuration;if(S>A)return;const L=T.fragments,b=L.length,C=T.edge;let D=null;const M=this.fragPrevious;if(y<C){const H=l.maxFragLookUpTolerance,K=y>C-H?0:H;D=ri(M,L,Math.max(L[0].start,y),K),!D&&M&&M.start<L[0].start&&(D=L[0])}else D=L[b-1];if(D=this.filterReplacedPrimary(D,n.details),!D)return;const F=D.sn-T.startSN,$=L[F-1];if($&&$.cc===D.cc&&this.fragmentTracker.getState($)===Rt.NOT_LOADED&&(D=$),this.fragmentTracker.getState(D)===Rt.NOT_LOADED){const H=this.mapToInitFragWhenRequired(D);H&&this.loadFragment(H,n,y)}}}loadFragment(e,r,n){wt(e)?super.loadFragment(e,r,n):this._loadInitSegment(e,r)}get mediaBufferTimeRanges(){return new qT(this.tracksBuffered[this.currentTrackId]||[])}}class qT{constructor(e){this.buffered=void 0;const r=(n,l,f)=>{if(l=l>>>0,l>f-1)throw new DOMException(`Failed to execute '${n}' on 'TimeRanges': The index provided (${l}) is greater than the maximum bound (${f})`);return e[l][n]};this.buffered={get length(){return e.length},end(n){return r("end",n,e.length)},start(n){return r("start",n,e.length)}}}}const jT={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},dc=v=>String.fromCharCode(jT[v]||v),tr=15,Rr=100,XT={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},zT={17:2,18:4,21:6,22:8,23:10,19:13,20:15},QT={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},ZT={25:2,26:4,29:6,30:8,31:10,27:13,28:15},JT=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class eS{constructor(){this.time=null,this.verboseLevel=0}log(e,r){if(this.verboseLevel>=e){const n=typeof r=="function"?r():r;qe.log(`${this.time} [${e}] ${n}`)}}}const Zr=function(e){const r=[];for(let n=0;n<e.length;n++)r.push(e[n].toString(16));return r};class cc{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const r=["foreground","underline","italics","background","flash"];for(let n=0;n<r.length;n++){const l=r[n];e.hasOwnProperty(l)&&(this[l]=e[l])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class tS{constructor(){this.uchar=" ",this.penState=new cc}reset(){this.uchar=" ",this.penState.reset()}setChar(e,r){this.uchar=e,this.penState.copy(r)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class rS{constructor(e){this.chars=[],this.pos=0,this.currPenState=new cc,this.cueStartTime=null,this.logger=void 0;for(let r=0;r<Rr;r++)this.chars.push(new tS);this.logger=e}equals(e){for(let r=0;r<Rr;r++)if(!this.chars[r].equals(e.chars[r]))return!1;return!0}copy(e){for(let r=0;r<Rr;r++)this.chars[r].copy(e.chars[r])}isEmpty(){let e=!0;for(let r=0;r<Rr;r++)if(!this.chars[r].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Rr&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Rr)}moveCursor(e){const r=this.pos+e;if(e>1)for(let n=this.pos+1;n<r+1;n++)this.chars[n].setPenState(this.currPenState);this.setCursor(r)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const r=dc(e);if(this.pos>=Rr){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+r+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(r,this.currPenState),this.moveCursor(1)}clearFromPos(e){let r;for(r=e;r<Rr;r++)this.chars[r].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let r=!0;for(let n=0;n<Rr;n++){const l=this.chars[n].uchar;l!==" "&&(r=!1),e.push(l)}return r?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class vo{constructor(e){this.rows=[],this.currRow=tr-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let r=0;r<tr;r++)this.rows.push(new rS(e));this.logger=e}reset(){for(let e=0;e<tr;e++)this.rows[e].clear();this.currRow=tr-1}equals(e){let r=!0;for(let n=0;n<tr;n++)if(!this.rows[n].equals(e.rows[n])){r=!1;break}return r}copy(e){for(let r=0;r<tr;r++)this.rows[r].copy(e.rows[r])}isEmpty(){let e=!0;for(let r=0;r<tr;r++)if(!this.rows[r].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+ot(e));let r=e.row-1;if(this.nrRollUpRows&&r<this.nrRollUpRows-1&&(r=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==r){for(let y=0;y<tr;y++)this.rows[y].clear();const f=this.currRow+1-this.nrRollUpRows,c=this.lastOutputScreen;if(c){const y=c.rows[f].cueStartTime,S=this.logger.time;if(y!==null&&S!==null&&y<S)for(let T=0;T<this.nrRollUpRows;T++)this.rows[r-this.nrRollUpRows+T+1].copy(c.rows[f+T])}}this.currRow=r;const n=this.rows[this.currRow];if(e.indent!==null){const f=e.indent,c=Math.max(f-1,0);n.setCursor(e.indent),e.color=n.chars[c].penState.foreground}const l={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(l)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+ot(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,r=this.rows.splice(e,1)[0];r.clear(),this.rows.splice(this.currRow,0,r),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const r=[];let n="",l=-1;for(let f=0;f<tr;f++){const c=this.rows[f].getTextString();c&&(l=f+1,e?r.push("Row "+l+": '"+c+"'"):r.push(c.trim()))}return r.length>0&&(e?n="["+r.join(" | ")+"]":n=r.join(`
`)),n}getTextAndFormat(){return this.rows}}class Yf{constructor(e,r,n){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=r,this.mode=null,this.verbose=0,this.displayedMemory=new vo(n),this.nonDisplayedMemory=new vo(n),this.lastOutputScreen=new vo(n),this.currRollUpRow=this.displayedMemory.rows[tr-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[tr-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let n=0;n<e.length;n++)this.writeScreen.insertChar(e[n]);const r=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>r+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const r={flash:!1};if(r.underline=e%2===1,r.italics=e>=46,r.italics)r.foreground="white";else{const n=Math.floor(e/2)-16,l=["white","green","blue","cyan","red","yellow","magenta"];r.foreground=l[n]}this.logger.log(2,"MIDROW: "+ot(r)),this.writeScreen.setPen(r)}outputDataUpdate(e=!1){const r=this.logger.time;r!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=r:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,r,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:r),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class Wf{constructor(e,r,n){this.channels=void 0,this.currentChannel=0,this.cmdHistory=sS(),this.logger=void 0;const l=this.logger=new eS;this.channels=[null,new Yf(e,r,l),new Yf(e+1,n,l)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,r){this.channels[e].setHandler(r)}addData(e,r){this.logger.time=e;for(let n=0;n<r.length;n+=2){const l=r[n]&127,f=r[n+1]&127;let c=!1,y=null;if(l===0&&f===0)continue;this.logger.log(3,()=>"["+Zr([r[n],r[n+1]])+"] -> ("+Zr([l,f])+")");const S=this.cmdHistory;if(l>=16&&l<=31){if(iS(l,f,S)){hn(null,null,S),this.logger.log(3,()=>"Repeated command ("+Zr([l,f])+") is dropped");continue}hn(l,f,this.cmdHistory),c=this.parseCmd(l,f),c||(c=this.parseMidrow(l,f)),c||(c=this.parsePAC(l,f)),c||(c=this.parseBackgroundAttributes(l,f))}else hn(null,null,S);if(!c&&(y=this.parseChars(l,f),y)){const A=this.currentChannel;A&&A>0?this.channels[A].insertChars(y):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!c&&!y&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Zr([l,f])+" orig: "+Zr([r[n],r[n+1]]))}}parseCmd(e,r){const n=(e===20||e===28||e===21||e===29)&&r>=32&&r<=47,l=(e===23||e===31)&&r>=33&&r<=35;if(!(n||l))return!1;const f=e===20||e===21||e===23?1:2,c=this.channels[f];return e===20||e===21||e===28||e===29?r===32?c.ccRCL():r===33?c.ccBS():r===34?c.ccAOF():r===35?c.ccAON():r===36?c.ccDER():r===37?c.ccRU(2):r===38?c.ccRU(3):r===39?c.ccRU(4):r===40?c.ccFON():r===41?c.ccRDC():r===42?c.ccTR():r===43?c.ccRTD():r===44?c.ccEDM():r===45?c.ccCR():r===46?c.ccENM():r===47&&c.ccEOC():c.ccTO(r-32),this.currentChannel=f,!0}parseMidrow(e,r){let n=0;if((e===17||e===25)&&r>=32&&r<=47){if(e===17?n=1:n=2,n!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const l=this.channels[n];return l?(l.ccMIDROW(r),this.logger.log(3,()=>"MIDROW ("+Zr([e,r])+")"),!0):!1}return!1}parsePAC(e,r){let n;const l=(e>=17&&e<=23||e>=25&&e<=31)&&r>=64&&r<=127,f=(e===16||e===24)&&r>=64&&r<=95;if(!(l||f))return!1;const c=e<=23?1:2;r>=64&&r<=95?n=c===1?XT[e]:QT[e]:n=c===1?zT[e]:ZT[e];const y=this.channels[c];return y?(y.setPAC(this.interpretPAC(n,r)),this.currentChannel=c,!0):!1}interpretPAC(e,r){let n;const l={color:null,italics:!1,indent:null,underline:!1,row:e};return r>95?n=r-96:n=r-64,l.underline=(n&1)===1,n<=13?l.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(n/2)]:n<=15?(l.italics=!0,l.color="white"):l.indent=Math.floor((n-16)/2)*4,l}parseChars(e,r){let n,l=null,f=null;if(e>=25?(n=2,f=e-8):(n=1,f=e),f>=17&&f<=19){let c;f===17?c=r+80:f===18?c=r+112:c=r+144,this.logger.log(2,()=>"Special char '"+dc(c)+"' in channel "+n),l=[c]}else e>=32&&e<=127&&(l=r===0?[e]:[e,r]);return l&&this.logger.log(3,()=>"Char codes =  "+Zr(l).join(",")),l}parseBackgroundAttributes(e,r){const n=(e===16||e===24)&&r>=32&&r<=47,l=(e===23||e===31)&&r>=45&&r<=47;if(!(n||l))return!1;let f;const c={};e===16||e===24?(f=Math.floor((r-32)/2),c.background=JT[f],r%2===1&&(c.background=c.background+"_semi")):r===45?c.background="transparent":(c.foreground="black",r===47&&(c.underline=!0));const y=e<=23?1:2;return this.channels[y].setBkgData(c),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const r=this.channels[e];r&&r.reset()}hn(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let r=0;r<this.channels.length;r++){const n=this.channels[r];n&&n.cueSplitAtTime(e)}}}function hn(v,e,r){r.a=v,r.b=e}function iS(v,e,r){return r.a===v&&r.b===e}function sS(){return{a:null,b:null}}var al=function(){if(_n!=null&&_n.VTTCue)return self.VTTCue;const v=["","lr","rl"],e=["start","middle","end","left","right"];function r(y,S){if(typeof S!="string"||!Array.isArray(y))return!1;const T=S.toLowerCase();return~y.indexOf(T)?T:!1}function n(y){return r(v,y)}function l(y){return r(e,y)}function f(y,...S){let T=1;for(;T<arguments.length;T++){const A=arguments[T];for(const L in A)y[L]=A[L]}return y}function c(y,S,T){const A=this,L={enumerable:!0};A.hasBeenReset=!1;let b="",C=!1,D=y,M=S,F=T,$=null,H="",K=!0,z="auto",Q="start",ne=50,Z="middle",ie=50,le="middle";Object.defineProperty(A,"id",f({},L,{get:function(){return b},set:function(ee){b=""+ee}})),Object.defineProperty(A,"pauseOnExit",f({},L,{get:function(){return C},set:function(ee){C=!!ee}})),Object.defineProperty(A,"startTime",f({},L,{get:function(){return D},set:function(ee){if(typeof ee!="number")throw new TypeError("Start time must be set to a number.");D=ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"endTime",f({},L,{get:function(){return M},set:function(ee){if(typeof ee!="number")throw new TypeError("End time must be set to a number.");M=ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"text",f({},L,{get:function(){return F},set:function(ee){F=""+ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"region",f({},L,{get:function(){return $},set:function(ee){$=ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"vertical",f({},L,{get:function(){return H},set:function(ee){const ve=n(ee);if(ve===!1)throw new SyntaxError("An invalid or illegal string was specified.");H=ve,this.hasBeenReset=!0}})),Object.defineProperty(A,"snapToLines",f({},L,{get:function(){return K},set:function(ee){K=!!ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"line",f({},L,{get:function(){return z},set:function(ee){if(typeof ee!="number"&&ee!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");z=ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"lineAlign",f({},L,{get:function(){return Q},set:function(ee){const ve=l(ee);if(!ve)throw new SyntaxError("An invalid or illegal string was specified.");Q=ve,this.hasBeenReset=!0}})),Object.defineProperty(A,"position",f({},L,{get:function(){return ne},set:function(ee){if(ee<0||ee>100)throw new Error("Position must be between 0 and 100.");ne=ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"positionAlign",f({},L,{get:function(){return Z},set:function(ee){const ve=l(ee);if(!ve)throw new SyntaxError("An invalid or illegal string was specified.");Z=ve,this.hasBeenReset=!0}})),Object.defineProperty(A,"size",f({},L,{get:function(){return ie},set:function(ee){if(ee<0||ee>100)throw new Error("Size must be between 0 and 100.");ie=ee,this.hasBeenReset=!0}})),Object.defineProperty(A,"align",f({},L,{get:function(){return le},set:function(ee){const ve=l(ee);if(!ve)throw new SyntaxError("An invalid or illegal string was specified.");le=ve,this.hasBeenReset=!0}})),A.displayState=void 0}return c.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},c}();class nS{decode(e,r){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function gc(v){function e(n,l,f,c){return(n|0)*3600+(l|0)*60+(f|0)+parseFloat(c||0)}const r=v.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return r?parseFloat(r[2])>59?e(r[2],r[3],0,r[4]):e(r[1],r[2],r[3],r[4]):null}class aS{constructor(){this.values=Object.create(null)}set(e,r){!this.get(e)&&r!==""&&(this.values[e]=r)}get(e,r,n){return n?this.has(e)?this.values[e]:r[n]:this.has(e)?this.values[e]:r}has(e){return e in this.values}alt(e,r,n){for(let l=0;l<n.length;++l)if(r===n[l]){this.set(e,r);break}}integer(e,r){/^-?\d+$/.test(r)&&this.set(e,parseInt(r,10))}percent(e,r){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(r)){const n=parseFloat(r);if(n>=0&&n<=100)return this.set(e,n),!0}return!1}}function vc(v,e,r,n){const l=n?v.split(n):[v];for(const f in l){if(typeof l[f]!="string")continue;const c=l[f].split(r);if(c.length!==2)continue;const y=c[0],S=c[1];e(y,S)}}const No=new al(0,0,""),fn=No.align==="middle"?"middle":"center";function oS(v,e,r){const n=v;function l(){const y=gc(v);if(y===null)throw new Error("Malformed timestamp: "+n);return v=v.replace(/^[^\sa-zA-Z-]+/,""),y}function f(y,S){const T=new aS;vc(y,function(b,C){let D;switch(b){case"region":for(let M=r.length-1;M>=0;M--)if(r[M].id===C){T.set(b,r[M].region);break}break;case"vertical":T.alt(b,C,["rl","lr"]);break;case"line":D=C.split(","),T.integer(b,D[0]),T.percent(b,D[0])&&T.set("snapToLines",!1),T.alt(b,D[0],["auto"]),D.length===2&&T.alt("lineAlign",D[1],["start",fn,"end"]);break;case"position":D=C.split(","),T.percent(b,D[0]),D.length===2&&T.alt("positionAlign",D[1],["start",fn,"end","line-left","line-right","auto"]);break;case"size":T.percent(b,C);break;case"align":T.alt(b,C,["start",fn,"end","left","right"]);break}},/:/,/\s/),S.region=T.get("region",null),S.vertical=T.get("vertical","");let A=T.get("line","auto");A==="auto"&&No.line===-1&&(A=-1),S.line=A,S.lineAlign=T.get("lineAlign","start"),S.snapToLines=T.get("snapToLines",!0),S.size=T.get("size",100),S.align=T.get("align",fn);let L=T.get("position","auto");L==="auto"&&No.position===50&&(L=S.align==="start"||S.align==="left"?0:S.align==="end"||S.align==="right"?100:50),S.position=L}function c(){v=v.replace(/^\s+/,"")}if(c(),e.startTime=l(),c(),v.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+n);v=v.slice(3),c(),e.endTime=l(),c(),f(v,e)}function mc(v){return v.replace(/<br(?: \/)?>/gi,`
`)}class lS{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new nS,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const r=this;e&&(r.buffer+=r.decoder.decode(e,{stream:!0}));function n(){let f=r.buffer,c=0;for(f=mc(f);c<f.length&&f[c]!=="\r"&&f[c]!==`
`;)++c;const y=f.slice(0,c);return f[c]==="\r"&&++c,f[c]===`
`&&++c,r.buffer=f.slice(c),y}function l(f){vc(f,function(c,y){},/:/)}try{let f="";if(r.state==="INITIAL"){if(!/\r\n|\n/.test(r.buffer))return this;f=n();const y=f.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(y!=null&&y[0]))throw new Error("Malformed WebVTT signature.");r.state="HEADER"}let c=!1;for(;r.buffer;){if(!/\r\n|\n/.test(r.buffer))return this;switch(c?c=!1:f=n(),r.state){case"HEADER":/:/.test(f)?l(f):f||(r.state="ID");continue;case"NOTE":f||(r.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(f)){r.state="NOTE";break}if(!f)continue;if(r.cue=new al(0,0,""),r.state="CUE",f.indexOf("-->")===-1){r.cue.id=f;continue}case"CUE":if(!r.cue){r.state="BADCUE";continue}try{oS(f,r.cue,r.regionList)}catch{r.cue=null,r.state="BADCUE";continue}r.state="CUETEXT";continue;case"CUETEXT":{const y=f.indexOf("-->")!==-1;if(!f||y&&(c=!0)){r.oncue&&r.cue&&r.oncue(r.cue),r.cue=null,r.state="ID";continue}if(r.cue===null)continue;r.cue.text&&(r.cue.text+=`
`),r.cue.text+=f}continue;case"BADCUE":f||(r.state="ID")}}}catch{r.state==="CUETEXT"&&r.cue&&r.oncue&&r.oncue(r.cue),r.cue=null,r.state=r.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(r){e.onparsingerror&&e.onparsingerror(r)}return e.onflush&&e.onflush(),this}}const uS=/\r\n|\n\r|\n|\r/g,mo=function(e,r,n=0){return e.slice(n,n+r.length)===r},hS=function(e){let r=parseInt(e.slice(-3));const n=parseInt(e.slice(-6,-4)),l=parseInt(e.slice(-9,-7)),f=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!Ae(r)||!Ae(n)||!Ae(l)||!Ae(f))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return r+=1e3*n,r+=60*1e3*l,r+=60*60*1e3*f,r};function ol(v,e,r){return Ji(v.toString())+Ji(e.toString())+Ji(r)}const fS=function(e,r,n){let l=e[r],f=e[l.prevCC];if(!f||!f.new&&l.new){e.ccOffset=e.presentationOffset=l.start,l.new=!1;return}for(;(c=f)!=null&&c.new;){var c;e.ccOffset+=l.start-f.start,l.new=!1,l=f,f=e[l.prevCC]}e.presentationOffset=n};function dS(v,e,r,n,l,f,c){const y=new lS,S=Ht(new Uint8Array(v)).trim().replace(uS,`
`).split(`
`),T=[],A=e?CE(e.baseTime,e.timescale):0;let L="00:00.000",b=0,C=0,D,M=!0;y.oncue=function(F){const $=r[n];let H=r.ccOffset;const K=(b-A)/9e4;if($!=null&&$.new&&(C!==void 0?H=r.ccOffset=$.start:fS(r,n,K)),K){if(!e){D=new Error("Missing initPTS for VTT MPEGTS");return}H=K-r.presentationOffset}const z=F.endTime-F.startTime,Q=zt((F.startTime+H-C)*9e4,l*9e4)/9e4;F.startTime=Math.max(Q,0),F.endTime=Math.max(Q+z,0);const ne=F.text.trim();F.text=decodeURIComponent(encodeURIComponent(ne)),F.id||(F.id=ol(F.startTime,F.endTime,ne)),F.endTime>0&&T.push(F)},y.onparsingerror=function(F){D=F},y.onflush=function(){if(D){c(D);return}f(T)},S.forEach(F=>{if(M)if(mo(F,"X-TIMESTAMP-MAP=")){M=!1,F.slice(16).split(",").forEach($=>{mo($,"LOCAL:")?L=$.slice(6):mo($,"MPEGTS:")&&(b=parseInt($.slice(7)))});try{C=hS(L)/1e3}catch($){D=$}return}else F===""&&(M=!1);y.parse(F+`
`)}),y.flush()}const po="stpp.ttml.im1t",pc=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,yc=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,cS={left:"start",center:"center",right:"end",start:"start",end:"end"};function qf(v,e,r,n){const l=Me(new Uint8Array(v),["mdat"]);if(l.length===0){n(new Error("Could not parse IMSC1 mdat"));return}const f=l.map(y=>Ht(y)),c=DE(e.baseTime,1,e.timescale);try{f.forEach(y=>r(gS(y,c)))}catch(y){n(y)}}function gS(v,e){const l=new DOMParser().parseFromString(v,"text/xml").getElementsByTagName("tt")[0];if(!l)throw new Error("Invalid ttml");const f={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},c=Object.keys(f).reduce((L,b)=>(L[b]=l.getAttribute(`ttp:${b}`)||f[b],L),{}),y=l.getAttribute("xml:space")!=="preserve",S=jf(yo(l,"styling","style")),T=jf(yo(l,"layout","region")),A=yo(l,"body","[begin]");return[].map.call(A,L=>{const b=Ec(L,y);if(!b||!L.hasAttribute("begin"))return null;const C=To(L.getAttribute("begin"),c),D=To(L.getAttribute("dur"),c);let M=To(L.getAttribute("end"),c);if(C===null)throw Xf(L);if(M===null){if(D===null)throw Xf(L);M=C+D}const F=new al(C-e,M-e,b);F.id=ol(F.startTime,F.endTime,F.text);const $=T[L.getAttribute("region")],H=S[L.getAttribute("style")],K=vS($,H,S),{textAlign:z}=K;if(z){const Q=cS[z];Q&&(F.lineAlign=Q),F.align=z}return rt(F,K),F}).filter(L=>L!==null)}function yo(v,e,r){const n=v.getElementsByTagName(e)[0];return n?[].slice.call(n.querySelectorAll(r)):[]}function jf(v){return v.reduce((e,r)=>{const n=r.getAttribute("xml:id");return n&&(e[n]=r),e},{})}function Ec(v,e){return[].slice.call(v.childNodes).reduce((r,n,l)=>{var f;return n.nodeName==="br"&&l?r+`
`:(f=n.childNodes)!=null&&f.length?Ec(n,e):e?r+n.textContent.trim().replace(/\s+/g," "):r+n.textContent},"")}function vS(v,e,r){const n="http://www.w3.org/ns/ttml#styling";let l=null;const f=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],c=v!=null&&v.hasAttribute("style")?v.getAttribute("style"):null;return c&&r.hasOwnProperty(c)&&(l=r[c]),f.reduce((y,S)=>{const T=Eo(e,n,S)||Eo(v,n,S)||Eo(l,n,S);return T&&(y[S]=T),y},{})}function Eo(v,e,r){return v&&v.hasAttributeNS(e,r)?v.getAttributeNS(e,r):null}function Xf(v){return new Error(`Could not parse ttml timestamp ${v}`)}function To(v,e){if(!v)return null;let r=gc(v);return r===null&&(pc.test(v)?r=mS(v,e):yc.test(v)&&(r=pS(v,e))),r}function mS(v,e){const r=pc.exec(v),n=(r[4]|0)+(r[5]|0)/e.subFrameRate;return(r[1]|0)*3600+(r[2]|0)*60+(r[3]|0)+n/e.frameRate}function pS(v,e){const r=yc.exec(v),n=Number(r[1]);switch(r[2]){case"h":return n*3600;case"m":return n*60;case"ms":return n*1e3;case"f":return n/e.frameRate;case"t":return n/e.tickRate}return n}class dn{constructor(e,r){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=r}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,r,n){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=r,this.screen=n,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class yS{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Qf(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(w.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(w.FRAG_LOADING,this.onFragLoading,this),e.on(w.FRAG_LOADED,this.onFragLoaded,this),e.on(w.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(w.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(w.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(w.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(w.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(w.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(w.FRAG_LOADING,this.onFragLoading,this),e.off(w.FRAG_LOADED,this.onFragLoaded,this),e.off(w.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(w.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(w.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(w.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(w.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new dn(this,"textTrack1"),r=new dn(this,"textTrack2"),n=new dn(this,"textTrack3"),l=new dn(this,"textTrack4");this.cea608Parser1=new Wf(1,e,r),this.cea608Parser2=new Wf(3,n,l)}addCues(e,r,n,l,f){let c=!1;for(let y=f.length;y--;){const S=f[y],T=ES(S[0],S[1],r,n);if(T>=0&&(S[0]=Math.min(S[0],r),S[1]=Math.max(S[1],n),c=!0,T/(n-r)>.5))return}if(c||f.push([r,n]),this.config.renderTextTracksNatively){const y=this.captionsTracks[e];this.Cues.newCue(y,r,n,l)}else{const y=this.Cues.newCue(null,r,n,l);this.hls.trigger(w.CUES_PARSED,{type:"captions",cues:y,track:e})}}onInitPtsFound(e,{frag:r,id:n,initPTS:l,timescale:f}){const{unparsedVttFrags:c}=this;n===be.MAIN&&(this.initPTS[r.cc]={baseTime:l,timescale:f}),c.length&&(this.unparsedVttFrags=[],c.forEach(y=>{this.onFragLoaded(w.FRAG_LOADED,y)}))}getExistingTrack(e,r){const{media:n}=this;if(n)for(let l=0;l<n.textTracks.length;l++){const f=n.textTracks[l];if(zf(f,{name:e,lang:r,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return f}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:r,captionsTracks:n,media:l}=this,{label:f,languageCode:c}=r[e],y=this.getExistingTrack(f,c);if(y)n[e]=y,Ii(n[e]),uc(n[e],l);else{const S=this.createTextTrack("captions",f,c);S&&(S[e]=!0,n[e]=S)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const r=this.captionsProperties[e];if(!r)return;const n=r.label,l={_id:e,label:n,kind:"captions",default:r.media?!!r.media.default:!1,closedCaptions:r.media};this.nonNativeCaptionsTracks[e]=l,this.hls.trigger(w.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[l]})}createTextTrack(e,r,n){const l=this.media;if(l)return l.addTextTrack(e,r,n)}onMediaAttaching(e,r){this.media=r.media,r.mediaSource||this._cleanTracks()}onMediaDetaching(e,r){const n=!!r.transferMedia;if(this.media=null,n)return;const{captionsTracks:l}=this;Object.keys(l).forEach(f=>{Ii(l[f]),delete l[f]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Qf(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const r=e.textTracks;if(r)for(let n=0;n<r.length;n++)Ii(r[n])}onSubtitleTracksUpdated(e,r){const n=r.subtitleTracks||[],l=n.some(f=>f.textCodec===po);if(this.config.enableWebVTT||l&&this.config.enableIMSC1){if(rc(this.tracks,n)){this.tracks=n;return}if(this.textTracks=[],this.tracks=n,this.config.renderTextTracksNatively){const c=this.media,y=c?En(c.textTracks):null;if(this.tracks.forEach((S,T)=>{let A;if(y){let L=null;for(let b=0;b<y.length;b++)if(y[b]&&zf(y[b],S)){L=y[b],y[b]=null;break}L&&(A=L)}if(A)Ii(A);else{const L=Tc(S);A=this.createTextTrack(L,S.name,S.lang),A&&(A.mode="disabled")}A&&this.textTracks.push(A)}),y!=null&&y.length){const S=y.filter(T=>T!==null).map(T=>T.label);S.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${S.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const c=this.tracks.map(y=>({label:y.name,kind:y.type.toLowerCase(),default:y.default,subtitleTrack:y}));this.hls.trigger(w.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:c})}}}onManifestLoaded(e,r){this.config.enableCEA708Captions&&r.captions&&r.captions.forEach(n=>{const l=/(?:CC|SERVICE)([1-4])/.exec(n.instreamId);if(!l)return;const f=`textTrack${l[1]}`,c=this.captionsProperties[f];c&&(c.label=n.name,n.lang&&(c.languageCode=n.lang),c.media=n)})}closedCaptionsForLevel(e){const r=this.hls.levels[e.level];return r==null?void 0:r.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,r){if(this.enabled&&r.frag.type===be.MAIN){var n,l;const{cea608Parser1:f,cea608Parser2:c,lastSn:y}=this,{cc:S,sn:T}=r.frag,A=(n=(l=r.part)==null?void 0:l.index)!=null?n:-1;f&&c&&(T!==y+1||T===y&&A!==this.lastPartIndex+1||S!==this.lastCc)&&(f.reset(),c.reset()),this.lastCc=S,this.lastSn=T,this.lastPartIndex=A}}onFragLoaded(e,r){const{frag:n,payload:l}=r;if(n.type===be.SUBTITLE)if(l.byteLength){const f=n.decryptdata,c="stats"in r;if(f==null||!f.encrypted||c){const y=this.tracks[n.level],S=this.vttCCs;S[n.cc]||(S[n.cc]={start:n.start,prevCC:this.prevCC,new:!0},this.prevCC=n.cc),y&&y.textCodec===po?this._parseIMSC1(n,l):this._parseVTTs(r)}}else this.hls.trigger(w.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,r){const n=this.hls;qf(r,this.initPTS[e.cc],l=>{this._appendCues(l,e.level),n.trigger(w.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},l=>{n.logger.log(`Failed to parse IMSC1: ${l}`),n.trigger(w.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:l})})}_parseVTTs(e){var r;const{frag:n,payload:l}=e,{initPTS:f,unparsedVttFrags:c}=this,y=f.length-1;if(!f[n.cc]&&y===-1){c.push(e);return}const S=this.hls,T=(r=n.initSegment)!=null&&r.data?Qt(n.initSegment.data,new Uint8Array(l)).buffer:l;dS(T,this.initPTS[n.cc],this.vttCCs,n.cc,n.start,A=>{this._appendCues(A,n.level),S.trigger(w.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})},A=>{const L=A.message==="Missing initPTS for VTT MPEGTS";L?c.push(e):this._fallbackToIMSC1(n,l),S.logger.log(`Failed to parse VTT cue: ${A}`),!(L&&y>n.cc)&&S.trigger(w.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:A})})}_fallbackToIMSC1(e,r){const n=this.tracks[e.level];n.textCodec||qf(r,this.initPTS[e.cc],()=>{n.textCodec=po,this._parseIMSC1(e,r)},()=>{n.textCodec="wvtt"})}_appendCues(e,r){const n=this.hls;if(this.config.renderTextTracksNatively){const l=this.textTracks[r];if(!l||l.mode==="disabled")return;e.forEach(f=>hc(l,f))}else{const l=this.tracks[r];if(!l)return;const f=l.default?"default":"subtitles"+r;n.trigger(w.CUES_PARSED,{type:"subtitles",cues:e,track:f})}}onFragDecrypted(e,r){const{frag:n}=r;n.type===be.SUBTITLE&&this.onFragLoaded(w.FRAG_LOADED,r)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,r){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:n,samples:l}=r;if(!(n.type===be.MAIN&&this.closedCaptionsForLevel(n)==="NONE"))for(let f=0;f<l.length;f++){const c=l[f].bytes;if(c){this.cea608Parser1||this.initCea608Parsers();const y=this.extractCea608Data(c);this.cea608Parser1.addData(l[f].pts,y[0]),this.cea608Parser2.addData(l[f].pts,y[1])}}}onBufferFlushing(e,{startOffset:r,endOffset:n,endOffsetSubtitles:l,type:f}){const{media:c}=this;if(!(!c||c.currentTime<n)){if(!f||f==="video"){const{captionsTracks:y}=this;Object.keys(y).forEach(S=>Mo(y[S],r,n))}if(this.config.renderTextTracksNatively&&r===0&&l!==void 0){const{textTracks:y}=this;Object.keys(y).forEach(S=>Mo(y[S],r,l))}}}extractCea608Data(e){const r=[[],[]],n=e[0]&31;let l=2;for(let f=0;f<n;f++){const c=e[l++],y=127&e[l++],S=127&e[l++];if(y===0&&S===0)continue;if((4&c)!==0){const A=3&c;(A===0||A===1)&&(r[A].push(y),r[A].push(S))}}return r}}function Tc(v){return v.characteristics&&/transcribes-spoken-dialog/gi.test(v.characteristics)&&/describes-music-and-sound/gi.test(v.characteristics)?"captions":"subtitles"}function zf(v,e){return!!v&&v.kind===Tc(e)&&ko(e,v)}function ES(v,e,r,n){return Math.min(e,n)-Math.max(v,r)}function Qf(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const TS=/\s/,SS={newCue(v,e,r,n){const l=[];let f,c,y,S,T;const A=self.VTTCue||self.TextTrackCue;for(let b=0;b<n.rows.length;b++)if(f=n.rows[b],y=!0,S=0,T="",!f.isEmpty()){var L;for(let M=0;M<f.chars.length;M++)TS.test(f.chars[M].uchar)&&y?S++:(T+=f.chars[M].uchar,y=!1);f.cueStartTime=e,e===r&&(r+=1e-4),S>=16?S--:S++;const C=mc(T.trim()),D=ol(e,r,C);v!=null&&(L=v.cues)!=null&&L.getCueById(D)||(c=new A(e,r,C),c.id=D,c.line=b+1,c.align="left",c.position=10+Math.min(80,Math.floor(S*8/32)*10),l.push(c))}return v&&l.length&&(l.sort((b,C)=>b.line==="auto"||C.line==="auto"?0:b.line>8&&C.line>8?C.line-b.line:b.line-C.line),l.forEach(b=>hc(v,b))),l}};function AS(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const xS=/(\d+)-(\d+)\/(\d+)/;class Zf{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||bS,this.controller=new self.AbortController,this.stats=new $o}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,r,n){const l=this.stats;if(l.loading.start)throw new Error("Loader can only be used once.");l.loading.start=self.performance.now();const f=LS(e,this.controller.signal),c=e.responseType==="arraybuffer",y=c?"byteLength":"length",{maxTimeToFirstByteMs:S,maxLoadTimeMs:T}=r.loadPolicy;this.context=e,this.config=r,this.callbacks=n,this.request=this.fetchSetup(e,f),self.clearTimeout(this.requestTimeout),r.timeout=S&&Ae(S)?S:T,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(l,e,this.response))},r.timeout),(as(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(L=>{var b;this.response=this.loader=L;const C=Math.max(self.performance.now(),l.loading.start);if(self.clearTimeout(this.requestTimeout),r.timeout=T,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(l,e,this.response))},T-(C-l.loading.start)),!L.ok){const{status:M,statusText:F}=L;throw new _S(F||"fetch, bad network response",M,L)}l.loading.first=C,l.total=RS(L.headers)||l.total;const D=(b=this.callbacks)==null?void 0:b.onProgress;return D&&Ae(r.highWaterMark)?this.loadProgressively(L,l,e,r.highWaterMark,D):c?L.arrayBuffer():e.responseType==="json"?L.json():L.text()}).then(L=>{var b,C;const D=this.response;if(!D)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),l.loading.end=Math.max(self.performance.now(),l.loading.first);const M=L[y];M&&(l.loaded=l.total=M);const F={url:D.url,data:L,code:D.status},$=(b=this.callbacks)==null?void 0:b.onProgress;$&&!Ae(r.highWaterMark)&&$(l,e,L,D),(C=this.callbacks)==null||C.onSuccess(F,l,e,D)}).catch(L=>{var b;if(self.clearTimeout(this.requestTimeout),l.aborted)return;const C=L&&L.code||0,D=L?L.message:null;(b=this.callbacks)==null||b.onError({code:C,text:D},e,L?L.details:null,l)})}getCacheAge(){let e=null;if(this.response){const r=this.response.headers.get("age");e=r?parseFloat(r):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,r,n,l=0,f){const c=new Md,y=e.body.getReader(),S=()=>y.read().then(T=>{if(T.done)return c.dataLength&&f(r,n,c.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const A=T.value,L=A.length;return r.loaded+=L,L<l||c.dataLength?(c.push(A),c.dataLength>=l&&f(r,n,c.flush().buffer,e)):f(r,n,A.buffer,e),S()}).catch(()=>Promise.reject());return S()}}function LS(v,e){const r={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(rt({},v.headers))};return v.rangeEnd&&r.headers.set("Range","bytes="+v.rangeStart+"-"+String(v.rangeEnd-1)),r}function IS(v){const e=xS.exec(v);if(e)return parseInt(e[2])-parseInt(e[1])+1}function RS(v){const e=v.get("Content-Range");if(e){const n=IS(e);if(Ae(n))return n}const r=v.get("Content-Length");if(r)return parseInt(r)}function bS(v,e){return new self.Request(v.url,e)}class _S extends Error{constructor(e,r,n){super(e),this.code=void 0,this.details=void 0,this.code=r,this.details=n}}const DS=/^age:\s*[\d.]+\s*$/im;class Sc{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new $o,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,r,n){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=r,this.callbacks=n,this.loadInternal()}loadInternal(){const{config:e,context:r}=this;if(!e||!r)return;const n=this.loader=new self.XMLHttpRequest,l=this.stats;l.loading.first=0,l.loaded=0,l.aborted=!1;const f=this.xhrSetup;f?Promise.resolve().then(()=>{if(!(this.loader!==n||this.stats.aborted))return f(n,r.url)}).catch(c=>{if(!(this.loader!==n||this.stats.aborted))return n.open("GET",r.url,!0),f(n,r.url)}).then(()=>{this.loader!==n||this.stats.aborted||this.openAndSendXhr(n,r,e)}).catch(c=>{var y;(y=this.callbacks)==null||y.onError({code:n.status,text:c.message},r,n,l)}):this.openAndSendXhr(n,r,e)}openAndSendXhr(e,r,n){e.readyState||e.open("GET",r.url,!0);const l=r.headers,{maxTimeToFirstByteMs:f,maxLoadTimeMs:c}=n.loadPolicy;if(l)for(const y in l)e.setRequestHeader(y,l[y]);r.rangeEnd&&e.setRequestHeader("Range","bytes="+r.rangeStart+"-"+(r.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=r.responseType,self.clearTimeout(this.requestTimeout),n.timeout=f&&Ae(f)?f:c,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.timeout),e.send()}readystatechange(){const{context:e,loader:r,stats:n}=this;if(!e||!r)return;const l=r.readyState,f=this.config;if(!n.aborted&&l>=2&&(n.loading.first===0&&(n.loading.first=Math.max(self.performance.now(),n.loading.start),f.timeout!==f.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),f.timeout=f.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),f.loadPolicy.maxLoadTimeMs-(n.loading.first-n.loading.start)))),l===4)){self.clearTimeout(this.requestTimeout),r.onreadystatechange=null,r.onprogress=null;const T=r.status,A=r.responseType==="text"?r.responseText:null;if(T>=200&&T<300){const D=A??r.response;if(D!=null){var c,y;n.loading.end=Math.max(self.performance.now(),n.loading.first);const M=r.responseType==="arraybuffer"?D.byteLength:D.length;n.loaded=n.total=M,n.bwEstimate=n.total*8e3/(n.loading.end-n.loading.first);const F=(c=this.callbacks)==null?void 0:c.onProgress;F&&F(n,e,D,r);const $={url:r.responseURL,data:D,code:T};(y=this.callbacks)==null||y.onSuccess($,n,e,r);return}}const L=f.loadPolicy.errorRetry,b=n.retry,C={url:e.url,data:void 0,code:T};if(bn(L,b,!1,C))this.retry(L);else{var S;qe.error(`${T} while loading ${e.url}`),(S=this.callbacks)==null||S.onError({code:T,text:r.statusText},e,r,n)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,r=this.stats.retry;if(bn(e,r,!0))this.retry(e);else{var n;qe.warn(`timeout while loading ${(n=this.context)==null?void 0:n.url}`);const l=this.callbacks;l&&(this.abortInternal(),l.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:r,stats:n}=this;this.retryDelay=Ho(e,n.retry),n.retry++,qe.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${r==null?void 0:r.url}, retrying ${n.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const r=this.stats;r.loaded=e.loaded,e.lengthComputable&&(r.total=e.total)}getCacheAge(){let e=null;if(this.loader&&DS.test(this.loader.getAllResponseHeaders())){const r=this.loader.getResponseHeader("age");e=r?parseFloat(r):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const CS={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},PS=Ze(Ze({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:Sc,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Jp,bufferController:YE,capLevelController:sl,errorController:ny,fpsController:MT,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Id,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,certLoadPolicy:{default:CS},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},kS()),{},{subtitleStreamController:WT,subtitleTrackController:UT,timelineController:yS,audioStreamController:$E,audioTrackController:KE,emeController:bi,cmcdController:kT,contentSteeringController:OT,interstitialsController:YT});function kS(){return{cueHandler:SS,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function wS(v,e,r){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const n=Uo(v),l=["manifest","level","frag"],f=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return l.forEach(c=>{const y=`${c==="level"?"playlist":c}LoadPolicy`,S=e[y]===void 0,T=[];f.forEach(A=>{const L=`${c}Loading${A}`,b=e[L];if(b!==void 0&&S){T.push(L);const C=n[y].default;switch(e[y]={default:C},A){case"TimeOut":C.maxLoadTimeMs=b,C.maxTimeToFirstByteMs=b;break;case"MaxRetry":C.errorRetry.maxNumRetry=b,C.timeoutRetry.maxNumRetry=b;break;case"RetryDelay":C.errorRetry.retryDelayMs=b,C.timeoutRetry.retryDelayMs=b;break;case"MaxRetryTimeout":C.errorRetry.maxRetryDelayMs=b,C.timeoutRetry.maxRetryDelayMs=b;break}}}),T.length&&r.warn(`hls.js config: "${T.join('", "')}" setting(s) are deprecated, use "${y}": ${ot(e[y])}`)}),Ze(Ze({},n),e)}function Uo(v){return v&&typeof v=="object"?Array.isArray(v)?v.map(Uo):Object.keys(v).reduce((e,r)=>(e[r]=Uo(v[r]),e),{}):v}function OS(v,e){const r=v.loader;r!==Zf&&r!==Sc?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),v.progressive=!1):AS()&&(v.loader=Zf,v.progressive=!0,v.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const Tn=2,MS=.1,FS=.05,NS=100;class US extends Ad{constructor(e,r){super("gap-controller",e.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var n;(n=this.media)!=null&&n.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var n;this.ended=((n=this.media)==null?void 0:n.currentTime)||1,this.hls.trigger(w.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=r,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,r){this.setInterval(NS),this.mediaSource=r.mediaSource;const n=this.media=r.media;Dr(n,"playing",this.onMediaPlaying),Dr(n,"waiting",this.onMediaWaiting),Dr(n,"ended",this.onMediaEnded)}onMediaDetaching(e,r){this.clearInterval();const{media:n}=this;n&&(yr(n,"playing",this.onMediaPlaying),yr(n,"waiting",this.onMediaWaiting),yr(n,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,r){this.buffered=r.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const r=this.media.currentTime;this.poll(r,this.lastCurrentTime),this.lastCurrentTime=r}poll(e,r){var n,l;const f=(n=this.hls)==null?void 0:n.config;if(!f)return;const{media:c,stalled:y}=this;if(!c)return;const{seeking:S}=c,T=this.seeking&&!S,A=!this.seeking&&S,L=c.paused&&!S||c.ended||c.playbackRate===0;if(this.seeking=S,e!==r){r&&(this.ended=0),this.moved=!0,S||(this.nudgeRetry=0,f.nudgeOnVideoHole&&!L&&e>r&&this.nudgeOnVideoHole(e,r)),this.waiting===0&&this.stallResolved(e);return}if(A||T){T&&this.stallResolved(e);return}if(L){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&c.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(w.MEDIA_ENDED,{stalled:!1}));return}if(!Be.getBuffered(c).length){this.nudgeRetry=0;return}const b=Be.bufferInfo(c,e,0),C=b.nextStart||0,D=this.fragmentTracker;if(S&&D&&this.hls){const ne=Jf(this.hls.inFlightFragments,e),Z=b.len>Tn,ie=!C||ne||C-e>Tn&&!D.getPartialFragment(e);if(Z||ie)return;this.moved=!1}const M=(l=this.hls)==null?void 0:l.latestLevelDetails;if(!this.moved&&this.stalled!==null&&D){if(!(b.len>0)&&!C)return;const Z=Math.max(C,b.start||0)-e,le=!!(M!=null&&M.live)?M.targetduration*2:Tn,ee=D.getPartialFragment(e);if(Z>0&&(Z<=le||ee)){c.paused||this._trySkipBufferHole(ee);return}}const F=f.detectStallWithCurrentTimeMs,$=self.performance.now(),H=this.waiting;if(y===null){H>0&&$-H<F?this.stalled=H:this.stalled=$;return}const K=$-y;if(!S&&(K>=F||H)&&this.hls){var z;if(((z=this.mediaSource)==null?void 0:z.readyState)==="ended"&&!(M!=null&&M.live)&&Math.abs(e-((M==null?void 0:M.edge)||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(w.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(b),!this.media||!this.hls)return}const Q=Be.bufferInfo(c,e,f.maxBufferHole);this._tryFixBufferStall(Q,K)}stallResolved(e){const r=this.stalled;if(r&&this.hls&&(this.stalled=null,this.stallReported)){const n=self.performance.now()-r;this.log(`playback not stuck anymore @${e}, after ${Math.round(n)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(w.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,r){var n;const l=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(n=this.buffered.audio)!=null&&n.length&&l&&l.length>1&&e>l.end(0)){const f=Be.bufferedInfo(Be.timeRangesToArray(this.buffered.audio),e,0);if(f.len>1&&r>=f.start){const c=Be.timeRangesToArray(l),y=Be.bufferedInfo(c,r,0).bufferedIndex;if(y>-1&&y<c.length-1){const S=Be.bufferedInfo(c,e,0).bufferedIndex,T=c[y].end,A=c[y+1].start;if((S===-1||S>y)&&A-T<1&&e-T<2){const L=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${T} -> ${A} buffered index: ${S}`);this.warn(L.message),this.media.currentTime+=1e-6;const b=this.fragmentTracker.getPartialFragment(e)||void 0,C=Be.bufferInfo(this.media,e,0);this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:L,reason:L.message,frag:b,buffer:C.len,bufferInfo:C})}}}}}_tryFixBufferStall(e,r){var n,l;const{fragmentTracker:f,media:c}=this,y=(n=this.hls)==null?void 0:n.config;if(!c||!f||!y)return;const S=c.currentTime,T=(l=this.hls)==null?void 0:l.latestLevelDetails,A=f.getPartialFragment(S);if((A||T!=null&&T.live&&S<T.fragmentStart)&&(this._trySkipBufferHole(A)||!this.media))return;const L=e.buffered;(L&&L.length>1&&e.len>y.maxBufferHole||e.nextStart&&e.nextStart-S<y.maxBufferHole)&&(r>y.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}_reportStall(e){const{hls:r,media:n,stallReported:l,stalled:f}=this;if(!l&&f!==null&&n&&r){this.stallReported=!0;const c=new Error(`Playback stalling at @${n.currentTime} due to low buffer (${ot(e)})`);this.warn(c.message),r.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_STALLED_ERROR,fatal:!1,error:c,buffer:e.len,bufferInfo:e,stalled:{start:f}})}}_trySkipBufferHole(e){var r;const{fragmentTracker:n,media:l}=this,f=(r=this.hls)==null?void 0:r.config;if(!l||!n||!f)return 0;const c=l.currentTime,y=Be.bufferInfo(l,c,0),S=c<y.start?y.start:y.nextStart;if(S&&this.hls){const A=y.len<=f.maxBufferHole,L=y.len>0&&y.len<1&&l.readyState<3,b=S-c;if(b>0&&(A||L)){if(b>f.maxBufferHole){let D=!1;if(c===0){const M=n.getAppendedFrag(0,be.MAIN);M&&S<M.end&&(D=!0)}if(!D){const M=e||n.getAppendedFrag(c,be.MAIN);if(M){var T;if(!((T=this.hls.loadLevelObj)!=null&&T.details)||Jf(this.hls.inFlightFragments,S))return 0;let $=!1,H=M.end;for(;H<S;){const K=n.getPartialFragment(H);if(K)H+=K.duration;else{$=!0;break}}if($)return 0}}}const C=Math.max(S+FS,c+MS);if(this.warn(`skipping hole, adjusting currentTime from ${c} to ${C}`),this.moved=!0,l.currentTime=C,!(e!=null&&e.gap)){const D=new Error(`fragment loaded with buffer holes, seeking from ${c} to ${C}`);this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:D,reason:D.message,frag:e||void 0,buffer:y.len,bufferInfo:y})}return C}}return 0}_tryNudgeBuffer(e){const{hls:r,media:n,nudgeRetry:l}=this,f=r==null?void 0:r.config;if(!n||!f)return 0;const c=n.currentTime;if(this.nudgeRetry++,l<f.nudgeMaxRetry){const y=c+(l+1)*f.nudgeOffset,S=new Error(`Nudging 'currentTime' from ${c} to ${y}`);this.warn(S.message),n.currentTime=y,r.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_NUDGE_ON_STALL,error:S,fatal:!1,buffer:e.len,bufferInfo:e})}else{const y=new Error(`Playhead still not moving while enough data buffered @${c} after ${f.nudgeMaxRetry} nudges`);this.error(y.message),r.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.BUFFER_STALLED_ERROR,error:y,fatal:!0,buffer:e.len,bufferInfo:e})}}}function Jf(v,e){const r=ed(v.main);if(r&&r.start<=e)return r;const n=ed(v.audio);return n&&n.start<=e?n:null}function ed(v){if(!v)return null;switch(v.state){case de.IDLE:case de.STOPPED:case de.ENDED:case de.ERROR:return null}return v.frag}const BS=.25;function Bo(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function td(v,e,r,n,l){let f=new v(e,r,"");try{f.value=n,l&&(f.type=l)}catch{f=new v(e,r,ot(l?Ze({type:l},n):n))}return f}const cn=(()=>{const v=Bo();try{v&&new v(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function GS(v){return Uint8Array.from(v.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class $S{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(w.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e.on(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(w.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(w.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(w.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(w.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(w.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(e,r){var n;this.media=r.media,((n=r.overrides)==null?void 0:n.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){const e=this.hls.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,r){this.media=null,!r.transferMedia&&(this.id3Track&&(this.removeCues&&Ii(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const r=this.getID3Track(e.textTracks);return r.mode="hidden",r}getID3Track(e){if(this.media){for(let r=0;r<e.length;r++){const n=e[r];if(n.kind==="metadata"&&n.label==="id3")return uc(n,this.media),n}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,r){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:n,enableID3MetadataCues:l}}}=this;if(!n&&!l)return;const{samples:f}=r;this.id3Track||(this.id3Track=this.createTrack(this.media));const c=Bo();if(c)for(let y=0;y<f.length;y++){const S=f[y].type;if(S===Vt.emsg&&!n||!l)continue;const T=Vd(f[y].data);if(T){const A=f[y].pts;let L=A+f[y].duration;L>cn&&(L=cn),L-A<=0&&(L=A+BS);for(let C=0;C<T.length;C++){const D=T[C];if(!Hd(D)){this.updateId3CueEnds(A,S);const M=td(c,A,L,D,S);M&&this.id3Track.addCue(M)}}}}}updateId3CueEnds(e,r){var n;const l=(n=this.id3Track)==null?void 0:n.cues;if(l)for(let f=l.length;f--;){const c=l[f];c.type===r&&c.startTime<e&&c.endTime===cn&&(c.endTime=e)}}onBufferFlushing(e,{startOffset:r,endOffset:n,type:l}){const{id3Track:f,hls:c}=this;if(!c)return;const{config:{enableEmsgMetadataCues:y,enableID3MetadataCues:S}}=c;if(f&&(y||S)){let T;l==="audio"?T=A=>A.type===Vt.audioId3&&S:l==="video"?T=A=>A.type===Vt.emsg&&y:T=A=>A.type===Vt.audioId3&&S||A.type===Vt.emsg&&y,Mo(f,r,n,T)}}onLevelUpdated(e,{details:r}){this.updateDateRangeCues(r,!0)}onLevelPtsUpdated(e,r){Math.abs(r.drift)>.01&&this.updateDateRangeCues(r.details)}updateDateRangeCues(e,r){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{id3Track:n}=this,{dateRanges:l}=e,f=Object.keys(l);let c=this.dateRangeCuesAppended;if(n&&r){var y;if((y=n.cues)!=null&&y.length){const A=Object.keys(c).filter(L=>!f.includes(L));for(let L=A.length;L--;){const b=A[L],C=c[b].cues;delete c[b],Object.keys(C).forEach(D=>{try{const M=C[D];M.removeEventListener("enter",this.onEventCueEnter),n.removeCue(M)}catch{}})}}else c=this.dateRangeCuesAppended={}}const S=e.fragments[e.fragments.length-1];if(f.length===0||!Ae(S==null?void 0:S.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const T=Bo();for(let A=0;A<f.length;A++){const L=f[A],b=l[L],C=b.startTime,D=c[L],M=(D==null?void 0:D.cues)||{};let F=(D==null?void 0:D.durationKnown)||!1,$=cn;const{duration:H,endDate:K}=b;if(K&&H!==null)$=C+H,F=!0;else if(b.endOnNext&&!F){const Q=f.reduce((ne,Z)=>{if(Z!==b.id){const ie=l[Z];if(ie.class===b.class&&ie.startDate>b.startDate&&(!ne||b.startDate<ne.startDate))return ie}return ne},null);Q&&($=Q.startTime,F=!0)}const z=Object.keys(b.attr);for(let Q=0;Q<z.length;Q++){const ne=z[Q];if(!yy(ne))continue;const Z=M[ne];if(Z)F&&!D.durationKnown?Z.endTime=$:Math.abs(Z.startTime-C)>.01&&(Z.startTime=C,Z.endTime=$);else if(T){let ie=b.attr[ne];Ey(ne)&&(ie=GS(ie));const ee=td(T,C,$,{key:ne,data:ie},Vt.dateRange);ee&&(ee.id=L,this.id3Track.addCue(ee),M[ne]=ee,this.hls.config.interstitialsController&&(ne==="X-ASSET-LIST"||ne==="X-ASSET-URL")&&ee.addEventListener("enter",this.onEventCueEnter))}}c[L]={cues:M,dateRange:b,durationKnown:F}}}}class KS{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:r}=this,n=this.levelDetails;if(!r||!n)return;this.currentTime=r.currentTime;const l=this.computeLatency();if(l===null)return;this._latency=l;const{lowLatencyMode:f,maxLiveSyncPlaybackRate:c}=this.config;if(!f||c===1||!n.live)return;const y=this.targetLatency;if(y===null)return;const S=l-y,T=Math.min(this.maxLatency,y+n.targetduration);if(S<T&&S>.05&&this.forwardBufferLength>1){const L=Math.min(2,Math.max(1,c)),b=Math.round(2/(1+Math.exp(-.75*S-this.edgeStalled))*20)/20,C=Math.min(L,Math.max(1,b));this.changeMediaPlaybackRate(r,C)}else r.playbackRate!==1&&r.playbackRate!==0&&this.changeMediaPlaybackRate(r,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const r=this.levelDetails;return r?e.liveMaxLatencyDurationCount*r.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:r,partHoldBack:n,targetduration:l}=e,{liveSyncDuration:f,liveSyncDurationCount:c,lowLatencyMode:y}=this.config,S=this.hls.userConfig;let T=y&&n||r;(this._targetLatencyUpdated||S.liveSyncDuration||S.liveSyncDurationCount||T===0)&&(T=f!==void 0?f:c*l);const A=l;return T+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,A)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),r=this.targetLatency;if(e===null||r===null)return null;const n=this.levelDetails;if(n===null)return null;const l=n.edge,f=e-r-this.edgeStalled,c=l-n.totalduration,y=l-(this.config.lowLatencyMode&&n.partTarget||n.targetduration);return Math.min(Math.max(c,f),y)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const r=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-r,0)}get forwardBufferLength(){const{media:e}=this,r=this.levelDetails;if(!e||!r)return 0;const n=e.buffered.length;return(n?e.buffered.end(n-1):r.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(w.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(w.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(w.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(w.ERROR,this.onError,this))}onMediaAttached(e,r){this.media=r.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:r}){r.advanced&&this.onTimeupdate(),!r.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,r){var n;r.details===re.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(n=this.levelDetails)!=null&&n.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,r){var n,l;e.playbackRate!==r&&((n=this.hls)==null||n.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(l=this.targetLatency)==null?void 0:l.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${r}`),e.playbackRate=r)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class VS extends il{constructor(e,r){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=r,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(w.LEVEL_LOADED,this.onLevelLoaded,this),e.on(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(w.FRAG_BUFFERED,this.onFragBuffered,this),e.on(w.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(w.LEVEL_LOADED,this.onLevelLoaded,this),e.off(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(w.FRAG_BUFFERED,this.onFragBuffered,this),e.off(w.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(r=>{r.loadError=0,r.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,r){this.resetLevels()}onManifestLoaded(e,r){const n=this.hls.config.preferManagedMediaSource,l=[],f={},c={};let y=!1,S=!1,T=!1;r.levels.forEach(A=>{var L;const b=A.attrs;let{audioCodec:C,videoCodec:D}=A;C&&(A.audioCodec=C=xn(C,n)||void 0),((L=D)==null?void 0:L.indexOf("avc1"))===0&&(D=A.videoCodec=Bp(D));const{width:M,height:F,unknownCodecs:$}=A;let H=$?$.length:0;if($)for(let ve=H;ve--;){const Ee=$[ve];this.isAudioSupported(Ee)?(A.audioCodec=C=C?`${C},${Ee}`:Ee,H--,Di.audio[C.substring(0,4)]=2):this.isVideoSupported(Ee)&&(A.videoCodec=D=D?`${D},${Ee}`:Ee,H--,Di.video[D.substring(0,4)]=2)}if(y||(y=!!(M&&F)),S||(S=!!D),T||(T=!!C),H||C&&!this.isAudioSupported(C)||D&&!this.isVideoSupported(D)){this.log(`Some or all CODECS not supported "${b.CODECS}"`);return}const{CODECS:K,"FRAME-RATE":z,"HDCP-LEVEL":Q,"PATHWAY-ID":ne,RESOLUTION:Z,"VIDEO-RANGE":ie}=b,ee=`${`${ne||"."}-`}${A.bitrate}-${Z}-${z}-${K}-${ie}-${Q}`;if(f[ee])if(f[ee].uri!==A.url&&!A.attrs["PATHWAY-ID"]){const ve=c[ee]+=1;A.attrs["PATHWAY-ID"]=new Array(ve+1).join(".");const Ee=this.createLevel(A);f[ee]=Ee,l.push(Ee)}else f[ee].addGroupId("audio",b.AUDIO),f[ee].addGroupId("text",b.SUBTITLES);else{const ve=this.createLevel(A);f[ee]=ve,c[ee]=1,l.push(ve)}}),this.filterAndSortMediaOptions(l,r,y,S,T)}createLevel(e){const r=new ts(e),n=e.supplemental;if(n!=null&&n.videoCodec&&!this.isVideoSupported(n.videoCodec)){const l=new Error(`SUPPLEMENTAL-CODECS not supported "${n.videoCodec}"`);this.log(l.message),r.supportedResult=yd(l,[])}return r}isAudioSupported(e){return Lo(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return Lo(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,r,n,l,f){let c=[],y=[],S=e;if((n||l)&&f&&(S=S.filter(({videoCodec:D,videoRange:M,width:F,height:$})=>(!!D||!!(F&&$))&&Hp(M))),S.length===0){Promise.resolve().then(()=>{if(this.hls){let D="no level with compatible codecs found in manifest",M=D;r.levels.length&&(M=`one or more CODECS in variant not supported: ${ot(r.levels.map($=>$.attrs.CODECS).filter(($,H,K)=>K.indexOf($)===H))}`,this.warn(M),D+=` (${M})`);const F=new Error(D);this.hls.trigger(w.ERROR,{type:De.MEDIA_ERROR,details:re.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:r.url,error:F,reason:M})}});return}r.audioTracks&&(c=r.audioTracks.filter(D=>!D.audioCodec||this.isAudioSupported(D.audioCodec)),rd(c)),r.subtitles&&(y=r.subtitles,rd(y));const T=S.slice(0);S.sort((D,M)=>{if(D.attrs["HDCP-LEVEL"]!==M.attrs["HDCP-LEVEL"])return(D.attrs["HDCP-LEVEL"]||"")>(M.attrs["HDCP-LEVEL"]||"")?1:-1;if(n&&D.height!==M.height)return D.height-M.height;if(D.frameRate!==M.frameRate)return D.frameRate-M.frameRate;if(D.videoRange!==M.videoRange)return Ln.indexOf(D.videoRange)-Ln.indexOf(M.videoRange);if(D.videoCodec!==M.videoCodec){const F=Xh(D.videoCodec),$=Xh(M.videoCodec);if(F!==$)return $-F}if(D.uri===M.uri&&D.codecSet!==M.codecSet){const F=An(D.codecSet),$=An(M.codecSet);if(F!==$)return $-F}return D.averageBitrate!==M.averageBitrate?D.averageBitrate-M.averageBitrate:0});let A=T[0];if(this.steering&&(S=this.steering.filterParsedLevels(S),S.length!==T.length)){for(let D=0;D<T.length;D++)if(T[D].pathwayId===S[0].pathwayId){A=T[D];break}}this._levels=S;for(let D=0;D<S.length;D++)if(S[D]===A){var L;this._firstLevel=D;const M=A.bitrate,F=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${S.length} level(s) found, first bitrate: ${M}`),((L=this.hls.userConfig)==null?void 0:L.abrEwmaDefaultEstimate)===void 0){const $=Math.min(M,this.hls.config.abrEwmaDefaultEstimateMax);$>F&&F===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=$)}break}const b=f&&!l,C={levels:S,audioTracks:c,subtitleTracks:y,sessionData:r.sessionData,sessionKeys:r.sessionKeys,firstLevel:this._firstLevel,stats:r.stats,audio:f,video:l,altAudio:!b&&c.some(D=>!!D.url)};this.hls.trigger(w.MANIFEST_PARSED,C)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const r=this._levels;if(r.length===0)return;if(e<0||e>=r.length){const A=new Error("invalid level idx"),L=e<0;if(this.hls.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.LEVEL_SWITCH_ERROR,level:e,fatal:L,error:A,reason:A.message}),L)return;e=Math.min(e,r.length-1)}const n=this.currentLevelIndex,l=this.currentLevel,f=l?l.attrs["PATHWAY-ID"]:void 0,c=r[e],y=c.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=c,n===e&&l&&f===y)return;this.log(`Switching to level ${e} (${c.height?c.height+"p ":""}${c.videoRange?c.videoRange+" ":""}${c.codecSet?c.codecSet+" ":""}@${c.bitrate})${y?" with Pathway "+y:""} from level ${n}${f?" with Pathway "+f:""}`);const S={level:e,attrs:c.attrs,details:c.details,bitrate:c.bitrate,averageBitrate:c.averageBitrate,maxBitrate:c.maxBitrate,realBitrate:c.realBitrate,width:c.width,height:c.height,codecSet:c.codecSet,audioCodec:c.audioCodec,videoCodec:c.videoCodec,audioGroups:c.audioGroups,subtitleGroups:c.subtitleGroups,loaded:c.loaded,loadError:c.loadError,fragmentError:c.fragmentError,name:c.name,id:c.id,uri:c.uri,url:c.url,urlId:0,audioGroupIds:c.audioGroupIds,textGroupIds:c.textGroupIds};this.hls.trigger(w.LEVEL_SWITCHING,S);const T=c.details;if(!T||T.live){const A=this.switchParams(c.uri,l==null?void 0:l.details,T);this.loadPlaylist(A)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const r=this.steering.pathways(),n=e.filter(l=>r.indexOf(l)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${r}`);return}this.steering.pathwayPriority=n}}onError(e,r){r.fatal||!r.context||r.context.type===$e.LEVEL&&r.context.level===this.level&&this.checkRetry(r)}onFragBuffered(e,{frag:r}){if(r!==void 0&&r.type===be.MAIN){const n=r.elementaryStreams;if(!Object.keys(n).some(f=>!!n[f]))return;const l=this._levels[r.level];l!=null&&l.loadError&&(this.log(`Resetting level error count of ${l.loadError} on frag buffered`),l.loadError=0)}}onLevelLoaded(e,r){var n;const{level:l,details:f}=r,c=r.levelInfo;if(!c){var y;this.warn(`Invalid level index ${l}`),(y=r.deliveryDirectives)!=null&&y.skip&&(f.deltaUpdateFailed=!0);return}if(c===this.currentLevel||r.withoutMultiVariant){c.fragmentError===0&&(c.loadError=0);let S=c.details;S===r.details&&S.advanced&&(S=void 0),this.playlistLoaded(l,r,S)}else(n=r.deliveryDirectives)!=null&&n.skip&&(f.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,r){super.loadingPlaylist(e,r);const n=this.getUrlWithDirectives(e.uri,r),l=this.currentLevelIndex,f=e.attrs["PATHWAY-ID"],c=e.details,y=c==null?void 0:c.age;this.log(`Loading level index ${l}${(r==null?void 0:r.msn)!==void 0?" at sn "+r.msn+" part "+r.part:""}${f?" Pathway "+f:""}${y&&c.live?" age "+y.toFixed(1)+(c.type&&" "+c.type||""):""} ${n}`),this.hls.trigger(w.LEVEL_LOADING,{url:n,level:l,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:r||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var r;if(this._levels.length===1)return;const n=this._levels.filter((f,c)=>c!==e?!0:(this.steering&&this.steering.removeLevel(f),f===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,f.details&&f.details.fragments.forEach(y=>y.level=-1)),!1));kd(n),this._levels=n,this.currentLevelIndex>-1&&(r=this.currentLevel)!=null&&r.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const l=n.length-1;this._firstLevel=Math.min(this._firstLevel,l),this._startLevel&&(this._startLevel=Math.min(this._startLevel,l)),this.hls.trigger(w.LEVELS_UPDATED,{levels:n})}onLevelsUpdated(e,{levels:r}){this._levels=r}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:r,maxHdcpLevel:n}=this.hls;this._maxAutoLevel!==r&&(this._maxAutoLevel=r,this.hls.trigger(w.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:r,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:n}))}}function rd(v){const e={};v.forEach(r=>{const n=r.groupId||"";r.id=e[n]=e[n]||0,e[n]++})}function Ac(){return self.SourceBuffer||self.WebKitSourceBuffer}function xc(){if(!Kr())return!1;const e=Ac();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function HS(){if(!xc())return!1;const v=Kr();return typeof(v==null?void 0:v.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>v.isTypeSupported(es(e,"video")))||["mp4a.40.2","fLaC"].some(e=>v.isTypeSupported(es(e,"audio"))))}function YS(){var v;const e=Ac();return typeof(e==null||(v=e.prototype)==null?void 0:v.changeType)=="function"}const WS=100;class qS extends Xo{constructor(e,r,n){super(e,r,n,"stream-controller",be.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const l=this.media,f=l?l.currentTime:null;if(f===null||!Ae(f)||(this.log(`Media seeked to ${f.toFixed(3)}`),!this.getBufferedFrag(f)))return;const c=this.getFwdBufferInfoAtPos(l,f,be.MAIN,0);if(c===null||c.len===0){this.warn(`Main forward buffer length at ${f} on "seeked" event ${c?c.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(w.MANIFEST_PARSED,this.onManifestParsed,this),e.on(w.LEVEL_LOADING,this.onLevelLoading,this),e.on(w.LEVEL_LOADED,this.onLevelLoaded,this),e.on(w.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(w.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(w.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(w.BUFFER_CREATED,this.onBufferCreated,this),e.on(w.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(w.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(w.MANIFEST_PARSED,this.onManifestParsed,this),e.off(w.LEVEL_LOADED,this.onLevelLoaded,this),e.off(w.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(w.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(w.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(w.BUFFER_CREATED,this.onBufferCreated,this),e.off(w.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(w.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(w.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,r){if(this.levels){const{lastCurrentTime:n,hls:l}=this;if(this.stopLoad(),this.setInterval(WS),this.level=-1,!this.startFragRequested){let f=l.startLevel;f===-1&&(l.config.testBandwidth&&this.levels.length>1?(f=0,this.bitrateTest=!0):f=l.firstAutoLevel),l.nextLoadLevel=f,this.level=l.loadLevel,this._hasEnoughToStart=!!r}n>0&&e===-1&&!r&&(this.log(`Override startPosition with lastCurrentTime @${n.toFixed(3)}`),e=n),this.state=de.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=r?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=de.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case de.WAITING_LEVEL:{const{levels:r,level:n}=this,l=r==null?void 0:r[n],f=l==null?void 0:l.details;if(f&&(!f.live||this.levelLastLoaded===l&&!this.waitForLive(l))){if(this.waitForCdnTuneIn(f))break;this.state=de.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=de.IDLE;break}break}case de.FRAG_LOADING_WAITING_RETRY:{var e;const r=self.performance.now(),n=this.retryDate;if(!n||r>=n||(e=this.media)!=null&&e.seeking){const{levels:l,level:f}=this,c=l==null?void 0:l[f];this.resetStartWhenNotLoaded(c||null),this.state=de.IDLE}}break}this.state===de.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:r,levels:n,media:l}=this;if(r===null||!l&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const f=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(n!=null&&n[f]))return;const c=n[f],y=this.getMainFwdBufferInfo();if(y===null)return;const S=this.getLevelDetails();if(S&&this._streamEnded(y,S)){const M={};this.altAudio===2&&(M.type="video"),this.hls.trigger(w.BUFFER_EOS,M),this.state=de.ENDED;return}if(!this.buffering)return;e.loadLevel!==f&&e.manualLevel===-1&&this.log(`Adapting to level ${f} from level ${this.level}`),this.level=e.nextLoadLevel=f;const T=c.details;if(!T||this.state===de.WAITING_LEVEL||this.waitForLive(c)){this.level=f,this.state=de.WAITING_LEVEL,this.startFragRequested=!1;return}const A=y.len,L=this.getMaxBufferLength(c.maxBitrate);if(A>=L)return;this.backtrackFragment&&this.backtrackFragment.start>y.end&&(this.backtrackFragment=null);const b=this.backtrackFragment?this.backtrackFragment.start:y.end;let C=this.getNextFragment(b,T);if(this.couldBacktrack&&!this.fragPrevious&&C&&wt(C)&&this.fragmentTracker.getState(C)!==Rt.OK){var D;const F=((D=this.backtrackFragment)!=null?D:C).sn-T.startSN,$=T.fragments[F-1];$&&C.cc===$.cc&&(C=$,this.fragmentTracker.removeFragment($))}else this.backtrackFragment&&y.len&&(this.backtrackFragment=null);if(C&&this.isLoopLoading(C,b)){if(!C.gap){const F=this.audioOnly&&!this.altAudio?tt.AUDIO:tt.VIDEO,$=(F===tt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;$&&this.afterBufferFlushed($,F,be.MAIN)}C=this.getNextFragmentLoopLoading(C,T,y,be.MAIN,L)}C&&(C.initSegment&&!C.initSegment.data&&!this.bitrateTest&&(C=C.initSegment),this.loadFragment(C,c,b))}loadFragment(e,r,n){const l=this.fragmentTracker.getState(e);l===Rt.NOT_LOADED||l===Rt.PARTIAL?wt(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,r)):super.loadFragment(e,r,n):this._loadInitSegment(e,r):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,be.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:r}=this;if(r!=null&&r.readyState){let n;const l=this.getAppendedFrag(r.currentTime);l&&l.start>1&&this.flushMainBuffer(0,l.start-1);const f=this.getLevelDetails();if(f!=null&&f.live){const y=this.getMainFwdBufferInfo();if(!y||y.len<f.targetduration*2)return}if(!r.paused&&e){const y=this.hls.nextLoadLevel,S=e[y],T=this.fragLastKbps;T&&this.fragCurrent?n=this.fragCurrent.duration*S.maxBitrate/(1e3*T)+1:n=0}else n=0;const c=this.getBufferedFrag(r.currentTime+n);if(c){const y=this.followingBufferedFrag(c);if(y){this.abortCurrentFrag();const S=y.maxStartPTS?y.maxStartPTS:y.start,T=y.duration,A=Math.max(c.end,S+Math.min(Math.max(T-this.config.maxFragLookUpTolerance,T*(this.couldBacktrack?.5:.125)),T*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(A,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case de.KEY_LOADING:case de.FRAG_LOADING:case de.FRAG_LOADING_WAITING_RETRY:case de.PARSING:case de.PARSED:this.state=de.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,r){super.flushMainBuffer(e,r,this.altAudio===2?"video":null)}onMediaAttached(e,r){super.onMediaAttached(e,r);const n=r.media;Dr(n,"playing",this.onMediaPlaying),Dr(n,"seeked",this.onMediaSeeked)}onMediaDetaching(e,r){const{media:n}=this;n&&(yr(n,"playing",this.onMediaPlaying),yr(n,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,r),!r.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(w.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,r){let n=!1,l=!1;r.levels.forEach(f=>{const c=f.audioCodec;c&&(n=n||c.indexOf("mp4a.40.2")!==-1,l=l||c.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=n&&l&&!YS(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=r.levels,this.startFragRequested=!1}onLevelLoading(e,r){const{levels:n}=this;if(!n||this.state!==de.IDLE)return;const l=r.levelInfo;(!l.details||l.details.live&&(this.levelLastLoaded!==l||l.details.expired)||this.waitForCdnTuneIn(l.details))&&(this.state=de.WAITING_LEVEL)}onLevelLoaded(e,r){var n;const{levels:l,startFragRequested:f}=this,c=r.level,y=r.details,S=y.totalduration;if(!l){this.warn(`Levels were reset while loading level ${c}`);return}this.log(`Level ${c} loaded [${y.startSN},${y.endSN}]${y.lastPartSn?`[part-${y.lastPartSn}-${y.lastPartIndex}]`:""}, cc [${y.startCC}, ${y.endCC}] duration:${S}`);const T=r.levelInfo,A=this.fragCurrent;A&&(this.state===de.FRAG_LOADING||this.state===de.FRAG_LOADING_WAITING_RETRY)&&A.level!==r.level&&A.loader&&this.abortCurrentFrag();let L=0;if(y.live||(n=T.details)!=null&&n.live){var b;if(this.checkLiveUpdate(y),y.deltaUpdateFailed)return;L=this.alignPlaylists(y,T.details,(b=this.levelLastLoaded)==null?void 0:b.details)}if(T.details=y,this.levelLastLoaded=T,f||this.setStartPosition(y,L),this.hls.trigger(w.LEVEL_UPDATED,{details:y,level:c}),this.state===de.WAITING_LEVEL){if(this.waitForCdnTuneIn(y))return;this.state=de.IDLE}f&&y.live&&this.synchronizeToLiveEdge(y),this.tick()}synchronizeToLiveEdge(e){const{config:r,media:n}=this;if(!n)return;const l=this.hls.liveSyncPosition,f=this.getLoadPosition(),c=e.fragmentStart,y=e.edge,S=f>=c-r.maxFragLookUpTolerance&&f<=y;if(l!==null&&n.duration>l&&(f<l||!S)){const T=r.liveMaxLatencyDuration!==void 0?r.liveMaxLatencyDuration:r.liveMaxLatencyDurationCount*e.targetduration;(!S&&n.readyState<4||f<y-T)&&(this._hasEnoughToStart||(this.nextLoadPosition=l),n.readyState&&(this.warn(`Playback: ${f.toFixed(3)} is located too far from the end of live sliding playlist: ${y}, reset currentTime to : ${l.toFixed(3)}`),n.currentTime=l))}}_handleFragmentLoadProgress(e){var r;const n=e.frag,{part:l,payload:f}=e,{levels:c}=this;if(!c){this.warn(`Levels were reset while fragment load was in progress. Fragment ${n.sn} of level ${n.level} will not be buffered`);return}const y=c[n.level];if(!y){this.warn(`Level ${n.level} not found on progress`);return}const S=y.details;if(!S){this.warn(`Dropping fragment ${n.sn} of level ${n.level} after level details were reset`),this.fragmentTracker.removeFragment(n);return}const T=y.videoCodec,A=S.PTSKnown||!S.live,L=(r=n.initSegment)==null?void 0:r.data,b=this._getAudioCodec(y),C=this.transmuxer=this.transmuxer||new tc(this.hls,be.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),D=l?l.index:-1,M=D!==-1,F=new Wo(n.level,n.sn,n.stats.chunkCount,f.byteLength,D,M),$=this.initPTS[n.cc];C.push(f,L,b,T,n,l,S.totalduration,A,F,$)}onAudioTrackSwitching(e,r){const n=this.hls,l=this.altAudio===2;if(In(r.url,n))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const c=this.fragCurrent;c&&(this.log("Switching to main audio track, cancel main fragment load"),c.abortRequests(),this.fragmentTracker.removeFragment(c)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(l){this.fragmentTracker.removeAllFragments(),n.once(w.BUFFER_FLUSHED,()=>{var c;(c=this.hls)==null||c.trigger(w.AUDIO_TRACK_SWITCHED,r)}),n.trigger(w.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}n.trigger(w.AUDIO_TRACK_SWITCHED,r)}}onAudioTrackSwitched(e,r){const n=In(r.url,this.hls);if(n){const l=this.videoBuffer;l&&this.mediaBuffer!==l&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=l)}this.altAudio=n?2:0,this.tick()}onBufferCreated(e,r){const n=r.tracks;let l,f,c=!1;for(const y in n){const S=n[y];if(S.id==="main"){if(f=y,l=S,y==="video"){const T=n[y];T&&(this.videoBuffer=T.buffer)}}else c=!0}c&&l?(this.log(`Alternate track found, use ${f}.buffered to schedule main fragment loading`),this.mediaBuffer=l.buffer):this.mediaBuffer=this.media}onFragBuffered(e,r){const{frag:n,part:l}=r,f=n.type===be.MAIN;if(f){if(this.fragContextChanged(n)){this.warn(`Fragment ${n.sn}${l?" p: "+l.index:""} of level ${n.level} finished buffering, but was aborted. state: ${this.state}`),this.state===de.PARSED&&(this.state=de.IDLE);return}const y=l?l.stats:n.stats;this.fragLastKbps=Math.round(8*y.total/(y.buffering.end-y.loading.first)),wt(n)&&(this.fragPrevious=n),this.fragBufferedComplete(n,l)}const c=this.media;c&&(!this._hasEnoughToStart&&Be.getBuffered(c).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),f&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,r){var n;if(r.fatal){this.state=de.ERROR;return}switch(r.details){case re.FRAG_GAP:case re.FRAG_PARSING_ERROR:case re.FRAG_DECRYPT_ERROR:case re.FRAG_LOAD_ERROR:case re.FRAG_LOAD_TIMEOUT:case re.KEY_LOAD_ERROR:case re.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(be.MAIN,r);break;case re.LEVEL_LOAD_ERROR:case re.LEVEL_LOAD_TIMEOUT:case re.LEVEL_PARSING_ERROR:!r.levelRetry&&this.state===de.WAITING_LEVEL&&((n=r.context)==null?void 0:n.type)===$e.LEVEL&&(this.state=de.IDLE);break;case re.BUFFER_ADD_CODEC_ERROR:case re.BUFFER_APPEND_ERROR:if(r.parent!=="main")return;this.resetLoadingState();break;case re.BUFFER_FULL_ERROR:if(r.parent!=="main")return;this.reduceLengthAndFlushBuffer(r)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case re.INTERNAL_EXCEPTION:this.recoverWorkerError(r);break}}onFragLoadEmergencyAborted(){this.state=de.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:r}){if(r!==tt.AUDIO||!this.altAudio){const n=(r===tt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;n&&(this.afterBufferFlushed(n,r,be.MAIN),this.tick())}}onLevelsUpdated(e,r){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=r.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const r=e.currentTime;let n=this.startPosition;if(n>=0&&r<n){if(e.seeking){this.log(`could not seek to ${n}, already seeking at ${r}`);return}const l=this.timelineOffset;l&&n&&(n+=l);const f=this.getLevelDetails(),c=Be.getBuffered(e),y=c.length?c.start(0):0,S=y-n,T=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);S>0&&(S<T||this.loadingParts&&S<2*((f==null?void 0:f.partTarget)||0))&&(this.log(`adjusting start position by ${S} to match buffer start`),n+=S,this.startPosition=n),r<n&&(this.log(`seek to target start position ${n} from current time ${r} buffer start ${y}`),e.currentTime=n)}}_getAudioCodec(e){let r=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&r&&(this.log("Swapping audio codec"),r.indexOf("mp4a.40.5")!==-1?r="mp4a.40.2":r="mp4a.40.5"),r}_loadBitrateTestFrag(e,r){e.bitrateTest=!0,this._doFragLoad(e,r).then(n=>{const{hls:l}=this,f=n==null?void 0:n.frag;if(!f||this.fragContextChanged(f))return;r.fragmentError=0,this.state=de.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const c=f.stats;c.parsing.start=c.parsing.end=c.buffering.start=c.buffering.end=self.performance.now(),l.trigger(w.FRAG_LOADED,n),f.bitrateTest=!1})}_handleTransmuxComplete(e){var r;const n=this.playlistType,{hls:l}=this,{remuxResult:f,chunkMeta:c}=e,y=this.getCurrentContext(c);if(!y){this.resetWhenMissingContext(c);return}const{frag:S,part:T,level:A}=y,{video:L,text:b,id3:C,initSegment:D}=f,{details:M}=A,F=this.altAudio?void 0:f.audio;if(this.fragContextChanged(S)){this.fragmentTracker.removeFragment(S);return}if(this.state=de.PARSING,D){if(D!=null&&D.tracks){const K=S.initSegment||S;this._bufferInitSegment(A,D.tracks,K,c),l.trigger(w.FRAG_PARSING_INIT_SEGMENT,{frag:K,id:n,tracks:D.tracks})}const $=D.initPTS,H=D.timescale;Ae($)&&(this.initPTS[S.cc]={baseTime:$,timescale:H},l.trigger(w.INIT_PTS_FOUND,{frag:S,id:n,initPTS:$,timescale:H}))}if(L&&M){const $=M.fragments[S.sn-1-M.startSN],H=S.sn===M.startSN,K=!$||S.cc>$.cc;if(f.independent!==!1){const{startPTS:z,endPTS:Q,startDTS:ne,endDTS:Z}=L;if(T)T.elementaryStreams[L.type]={startPTS:z,endPTS:Q,startDTS:ne,endDTS:Z};else if(L.firstKeyFrame&&L.independent&&c.id===1&&!K&&(this.couldBacktrack=!0),L.dropped&&L.independent){const ie=this.getMainFwdBufferInfo(),le=(ie?ie.end:this.getLoadPosition())+this.config.maxBufferHole,ee=L.firstKeyFramePTS?L.firstKeyFramePTS:z;if(!H&&le<ee-this.config.maxBufferHole&&!K){this.backtrack(S);return}else K&&(S.gap=!0);S.setElementaryStreamInfo(L.type,S.start,Q,S.start,Z,!0)}else H&&z-(M.appliedTimelineOffset||0)>Tn&&(S.gap=!0);S.setElementaryStreamInfo(L.type,z,Q,ne,Z),this.backtrackFragment&&(this.backtrackFragment=S),this.bufferFragmentData(L,S,T,c,H||K)}else if(H||K)S.gap=!0;else{this.backtrack(S);return}}if(F){const{startPTS:$,endPTS:H,startDTS:K,endDTS:z}=F;T&&(T.elementaryStreams[tt.AUDIO]={startPTS:$,endPTS:H,startDTS:K,endDTS:z}),S.setElementaryStreamInfo(tt.AUDIO,$,H,K,z),this.bufferFragmentData(F,S,T,c)}if(M&&C!=null&&(r=C.samples)!=null&&r.length){const $={id:n,frag:S,details:M,samples:C.samples};l.trigger(w.FRAG_PARSING_METADATA,$)}if(M&&b){const $={id:n,frag:S,details:M,samples:b.samples};l.trigger(w.FRAG_PARSING_USERDATA,$)}}_bufferInitSegment(e,r,n,l){if(this.state!==de.PARSING)return;this.audioOnly=!!r.audio&&!r.video,this.altAudio&&!this.audioOnly&&delete r.audio;const{audio:f,video:c,audiovideo:y}=r;if(f){let T=gn(f.codec,e.audioCodec);T==="mp4a"&&(T="mp4a.40.5");const A=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){T&&(T.indexOf("mp4a.40.5")!==-1?T="mp4a.40.2":T="mp4a.40.5");const L=f.metadata;L&&"channelCount"in L&&(L.channelCount||1)!==1&&A.indexOf("firefox")===-1&&(T="mp4a.40.5")}T&&T.indexOf("mp4a.40.5")!==-1&&A.indexOf("android")!==-1&&f.container!=="audio/mpeg"&&(T="mp4a.40.2",this.log(`Android: force audio codec to ${T}`)),e.audioCodec&&e.audioCodec!==T&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${T}"`),f.levelCodec=T,f.id=be.MAIN,this.log(`Init audio buffer, container:${f.container}, codecs[selected/level/parsed]=[${T||""}/${e.audioCodec||""}/${f.codec}]`),delete r.audiovideo}if(c){c.levelCodec=e.videoCodec,c.id=be.MAIN;const T=c.codec;if((T==null?void 0:T.length)===4)switch(T){case"hvc1":case"hev1":c.codec="hvc1.1.6.L120.90";break;case"av01":c.codec="av01.0.04M.08";break;case"avc1":c.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${c.container}, codecs[level/parsed]=[${e.videoCodec||""}/${T}]${c.codec!==T?" parsed-corrected="+c.codec:""}${c.supplemental?" supplemental="+c.supplemental:""}`),delete r.audiovideo}y&&(this.log(`Init audiovideo buffer, container:${y.container}, codecs[level/parsed]=[${e.codecs}/${y.codec}]`),delete r.video,delete r.audio);const S=Object.keys(r);if(S.length){if(this.hls.trigger(w.BUFFER_CODECS,r),!this.hls)return;S.forEach(T=>{const L=r[T].initSegment;L!=null&&L.byteLength&&this.hls.trigger(w.BUFFER_APPENDING,{type:T,data:L,frag:n,part:null,chunkMeta:l,parent:n.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,be.MAIN)}get maxBufferLength(){const{levels:e,level:r}=this,n=e==null?void 0:e[r];return n?this.getMaxBufferLength(n.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=de.IDLE}checkFragmentChanged(){const e=this.media;let r=null;if(e&&e.readyState>1&&e.seeking===!1){const n=e.currentTime;if(Be.isBuffered(e,n)?r=this.getAppendedFrag(n):Be.isBuffered(e,n+.1)&&(r=this.getAppendedFrag(n+.1)),r){this.backtrackFragment=null;const l=this.fragPlaying,f=r.level;(!l||r.sn!==l.sn||l.level!==f)&&(this.fragPlaying=r,this.hls.trigger(w.FRAG_CHANGED,{frag:r}),(!l||l.level!==f)&&this.hls.trigger(w.LEVEL_SWITCHED,{level:f}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const r=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return Ae(r)?this.getAppendedFrag(r):null}get currentProgramDateTime(){var e;const r=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(Ae(r)){const n=this.getLevelDetails(),l=this.currentFrag||(n?ri(null,n.fragments,r):null);if(l){const f=l.programDateTime;if(f!==null){const c=f+(r-l.start)*1e3;return new Date(c)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class jS{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const n in this.keyUriToKeyInfo){const l=this.keyUriToKeyInfo[n].loader;if(l){var r;if(e&&e!==((r=l.context)==null?void 0:r.frag.type))return;l.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[e];(r.mediaKeySessionContext||r.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[e].loader;r&&r.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,r=re.KEY_LOAD_ERROR,n,l,f){return new br({type:De.NETWORK_ERROR,details:r,fatal:!1,frag:e,response:f,error:n,networkDetails:l})}loadClear(e,r){if(this.emeController&&this.config.emeEnabled){const{sn:n,cc:l}=e;for(let f=0;f<r.length;f++){const c=r[f];if(l<=c.cc&&(n==="initSegment"||c.sn==="initSegment"||n<c.sn)){this.emeController.selectKeySystemFormat(c).then(y=>{c.setKeyFormat(y)});break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(r=>this.loadInternal(e,r)):this.loadInternal(e)}loadInternal(e,r){var n,l;r&&e.setKeyFormat(r);const f=e.decryptdata;if(!f){const T=new Error(r?`Expected frag.decryptdata to be defined after setting format ${r}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,re.KEY_LOAD_ERROR,T))}const c=f.uri;if(!c)return Promise.reject(this.createKeyLoadError(e,re.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${c}"`)));let y=this.keyUriToKeyInfo[c];if((n=y)!=null&&n.decryptdata.key)return f.key=y.decryptdata.key,Promise.resolve({frag:e,keyInfo:y});if((l=y)!=null&&l.keyLoadPromise){var S;switch((S=y.mediaKeySessionContext)==null?void 0:S.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return y.keyLoadPromise.then(T=>(f.key=T.keyInfo.decryptdata.key,{frag:e,keyInfo:y}))}}switch(y=this.keyUriToKeyInfo[c]={decryptdata:f,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},f.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return f.keyFormat==="identity"?this.loadKeyHTTP(y,e):this.loadKeyEME(y,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(y,e);default:return Promise.reject(this.createKeyLoadError(e,re.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${f.method}"`)))}}loadKeyEME(e,r){const n={frag:r,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const l=this.emeController.loadKey(n);if(l)return(e.keyLoadPromise=l.then(f=>(e.mediaKeySessionContext=f,n))).catch(f=>{throw e.keyLoadPromise=null,f})}return Promise.resolve(n)}loadKeyHTTP(e,r){const n=this.config,l=n.loader,f=new l(n);return r.keyLoader=e.loader=f,e.keyLoadPromise=new Promise((c,y)=>{const S={keyInfo:e,frag:r,responseType:"arraybuffer",url:e.decryptdata.uri},T=n.keyLoadPolicy.default,A={loadPolicy:T,timeout:T.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},L={onSuccess:(b,C,D,M)=>{const{frag:F,keyInfo:$,url:H}=D;if(!F.decryptdata||$!==this.keyUriToKeyInfo[H])return y(this.createKeyLoadError(F,re.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),M));$.decryptdata.key=F.decryptdata.key=new Uint8Array(b.data),F.keyLoader=null,$.loader=null,c({frag:F,keyInfo:$})},onError:(b,C,D,M)=>{this.resetLoader(C),y(this.createKeyLoadError(r,re.KEY_LOAD_ERROR,new Error(`HTTP Error ${b.code} loading key ${b.text}`),D,Ze({url:S.url,data:void 0},b)))},onTimeout:(b,C,D)=>{this.resetLoader(C),y(this.createKeyLoadError(r,re.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),D))},onAbort:(b,C,D)=>{this.resetLoader(C),y(this.createKeyLoadError(r,re.INTERNAL_ABORTED,new Error("key loading aborted"),D))}};f.load(S,A,L)})}resetLoader(e){const{frag:r,keyInfo:n,url:l}=e,f=n.loader;r.keyLoader===f&&(r.keyLoader=null,n.loader=null),delete this.keyUriToKeyInfo[l],f&&f.destroy()}}function id(v){const{type:e}=v;switch(e){case $e.AUDIO_TRACK:return be.AUDIO;case $e.SUBTITLE_TRACK:return be.SUBTITLE;default:return be.MAIN}}function So(v,e){let r=v.url;return(r===void 0||r.indexOf("data:")===0)&&(r=e.url),r}class XS{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(w.MANIFEST_LOADING,this.onManifestLoading,this),e.on(w.LEVEL_LOADING,this.onLevelLoading,this),e.on(w.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(w.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(w.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(w.MANIFEST_LOADING,this.onManifestLoading,this),e.off(w.LEVEL_LOADING,this.onLevelLoading,this),e.off(w.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(w.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(w.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const r=this.hls.config,n=r.pLoader,l=r.loader,f=n||l,c=new f(r);return this.loaders[e.type]=c,c}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const r=this.loaders[e];r&&r.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,r){const{url:n}=r;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:$e.MANIFEST,url:n,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,r){const{id:n,level:l,pathwayId:f,url:c,deliveryDirectives:y,levelInfo:S}=r;this.load({id:n,level:l,pathwayId:f,responseType:"text",type:$e.LEVEL,url:c,deliveryDirectives:y,levelOrTrack:S})}onAudioTrackLoading(e,r){const{id:n,groupId:l,url:f,deliveryDirectives:c,track:y}=r;this.load({id:n,groupId:l,level:null,responseType:"text",type:$e.AUDIO_TRACK,url:f,deliveryDirectives:c,levelOrTrack:y})}onSubtitleTrackLoading(e,r){const{id:n,groupId:l,url:f,deliveryDirectives:c,track:y}=r;this.load({id:n,groupId:l,level:null,responseType:"text",type:$e.SUBTITLE_TRACK,url:f,deliveryDirectives:c,levelOrTrack:y})}onLevelsUpdated(e,r){const n=this.loaders[$e.LEVEL];if(n){const l=n.context;l&&!r.levels.some(f=>f===l.levelOrTrack)&&(n.abort(),delete this.loaders[$e.LEVEL])}}load(e){var r;const n=this.hls.config;let l=this.getInternalLoader(e);if(l){const T=this.hls.logger,A=l.context;if(A&&A.levelOrTrack===e.levelOrTrack&&(A.url===e.url||A.deliveryDirectives&&!e.deliveryDirectives)){A.url===e.url?T.log(`[playlist-loader]: ignore ${e.url} ongoing request`):T.log(`[playlist-loader]: ignore ${e.url} in favor of ${A.url}`);return}T.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),l.abort()}let f;if(e.type===$e.MANIFEST?f=n.manifestLoadPolicy.default:f=rt({},n.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),l=this.createInternalLoader(e),Ae((r=e.deliveryDirectives)==null?void 0:r.part)){let T;if(e.type===$e.LEVEL&&e.level!==null?T=this.hls.levels[e.level].details:e.type===$e.AUDIO_TRACK&&e.id!==null?T=this.hls.audioTracks[e.id].details:e.type===$e.SUBTITLE_TRACK&&e.id!==null&&(T=this.hls.subtitleTracks[e.id].details),T){const A=T.partTarget,L=T.targetduration;if(A&&L){const b=Math.max(A*3,L*.8)*1e3;f=rt({},f,{maxTimeToFirstByteMs:Math.min(b,f.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(b,f.maxTimeToFirstByteMs)})}}}const c=f.errorRetry||f.timeoutRetry||{},y={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:c.maxNumRetry||0,retryDelay:c.retryDelayMs||0,maxRetryDelay:c.maxRetryDelayMs||0},S={onSuccess:(T,A,L,b)=>{const C=this.getInternalLoader(L);this.resetInternalLoader(L.type);const D=T.data;if(D.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(T,L,new Error("no EXTM3U delimiter"),b||null,A);return}A.parsing.start=performance.now(),pr.isMediaPlaylist(D)||L.type!==$e.MANIFEST?this.handleTrackOrLevelPlaylist(T,A,L,b||null,C):this.handleMasterPlaylist(T,A,L,b)},onError:(T,A,L,b)=>{this.handleNetworkError(A,L,!1,T,b)},onTimeout:(T,A,L)=>{this.handleNetworkError(A,L,!0,void 0,T)}};l.load(e,y,S)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:r},forceStartLoad:n}=this.hls;(e||n)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${r}`),this.hls.startLoad(r))}handleMasterPlaylist(e,r,n,l){const f=this.hls,c=e.data,y=So(e,n),S=pr.parseMasterPlaylist(c,y);if(S.playlistParsingError){this.handleManifestParsingError(e,n,S.playlistParsingError,l,r);return}const{contentSteering:T,levels:A,sessionData:L,sessionKeys:b,startTimeOffset:C,variableList:D}=S;this.variableList=D;const{AUDIO:M=[],SUBTITLES:F,"CLOSED-CAPTIONS":$}=pr.parseMasterPlaylistMedia(c,y,S);M.length&&!M.some(K=>!K.url)&&A[0].audioCodec&&!A[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),M.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new ft({}),bitrate:0,url:""})),f.trigger(w.MANIFEST_LOADED,{levels:A,audioTracks:M,subtitles:F,captions:$,contentSteering:T,url:y,stats:r,networkDetails:l,sessionData:L,sessionKeys:b,startTimeOffset:C,variableList:D})}handleTrackOrLevelPlaylist(e,r,n,l,f){const c=this.hls,{id:y,level:S,type:T}=n,A=So(e,n),L=Ae(S)?S:Ae(y)?y:0,b=id(n),C=pr.parseLevelPlaylist(e.data,A,L,b,0,this.variableList);if(T===$e.MANIFEST){const D={attrs:new ft({}),bitrate:0,details:C,name:"",url:A};C.requestScheduled=r.loading.start+Cd(C,0),c.trigger(w.MANIFEST_LOADED,{levels:[D],audioTracks:[],url:A,stats:r,networkDetails:l,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}r.parsing.end=performance.now(),n.levelDetails=C,this.handlePlaylistLoaded(C,e,r,n,l,f)}handleManifestParsingError(e,r,n,l,f){this.hls.trigger(w.ERROR,{type:De.NETWORK_ERROR,details:re.MANIFEST_PARSING_ERROR,fatal:r.type===$e.MANIFEST,url:e.url,err:n,error:n,reason:n.message,response:e,context:r,networkDetails:l,stats:f})}handleNetworkError(e,r,n=!1,l,f){let c=`A network ${n?"timeout":"error"+(l?" (status "+l.code+")":"")} occurred while loading ${e.type}`;e.type===$e.LEVEL?c+=`: ${e.level} id: ${e.id}`:(e.type===$e.AUDIO_TRACK||e.type===$e.SUBTITLE_TRACK)&&(c+=` id: ${e.id} group-id: "${e.groupId}"`);const y=new Error(c);this.hls.logger.warn(`[playlist-loader]: ${c}`);let S=re.UNKNOWN,T=!1;const A=this.getInternalLoader(e);switch(e.type){case $e.MANIFEST:S=n?re.MANIFEST_LOAD_TIMEOUT:re.MANIFEST_LOAD_ERROR,T=!0;break;case $e.LEVEL:S=n?re.LEVEL_LOAD_TIMEOUT:re.LEVEL_LOAD_ERROR,T=!1;break;case $e.AUDIO_TRACK:S=n?re.AUDIO_TRACK_LOAD_TIMEOUT:re.AUDIO_TRACK_LOAD_ERROR,T=!1;break;case $e.SUBTITLE_TRACK:S=n?re.SUBTITLE_TRACK_LOAD_TIMEOUT:re.SUBTITLE_LOAD_ERROR,T=!1;break}A&&this.resetInternalLoader(e.type);const L={type:De.NETWORK_ERROR,details:S,fatal:T,url:e.url,loader:A,context:e,error:y,networkDetails:r,stats:f};if(l){const b=(r==null?void 0:r.url)||e.url;L.response=Ze({url:b,data:void 0},l)}this.hls.trigger(w.ERROR,L)}handlePlaylistLoaded(e,r,n,l,f,c){const y=this.hls,{type:S,level:T,id:A,groupId:L,deliveryDirectives:b}=l,C=So(r,l),D=id(l),M=typeof l.level=="number"&&D===be.MAIN?T:void 0;if(!e.fragments.length){const $=e.playlistParsingError=new Error("No Segments found in Playlist");y.trigger(w.ERROR,{type:De.NETWORK_ERROR,details:re.LEVEL_EMPTY_ERROR,fatal:!1,url:C,error:$,reason:$.message,response:r,context:l,level:M,parent:D,networkDetails:f,stats:n});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const F=e.playlistParsingError;if(F){if(this.hls.logger.warn(F),!y.config.ignorePlaylistParsingErrors){y.trigger(w.ERROR,{type:De.NETWORK_ERROR,details:re.LEVEL_PARSING_ERROR,fatal:!1,url:C,error:F,reason:F.message,response:r,context:l,level:M,parent:D,networkDetails:f,stats:n});return}e.playlistParsingError=null}switch(e.live&&c&&(c.getCacheAge&&(e.ageHeader=c.getCacheAge()||0),(!c.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),S){case $e.MANIFEST:case $e.LEVEL:y.trigger(w.LEVEL_LOADED,{details:e,levelInfo:l.levelOrTrack||y.levels[0],level:M||0,id:A||0,stats:n,networkDetails:f,deliveryDirectives:b,withoutMultiVariant:S===$e.MANIFEST});break;case $e.AUDIO_TRACK:y.trigger(w.AUDIO_TRACK_LOADED,{details:e,track:l.levelOrTrack,id:A||0,groupId:L||"",stats:n,networkDetails:f,deliveryDirectives:b});break;case $e.SUBTITLE_TRACK:y.trigger(w.SUBTITLE_TRACK_LOADED,{details:e,track:l.levelOrTrack,id:A||0,groupId:L||"",stats:n,networkDetails:f,deliveryDirectives:b});break}}}class ei{static get version(){return ss}static isMSESupported(){return xc()}static isSupported(){return HS()}static getMediaSource(){return Kr()}static get Events(){return w}static get MetadataSchema(){return Vt}static get ErrorTypes(){return De}static get ErrorDetails(){return re}static get DefaultConfig(){return ei.defaultConfig?ei.defaultConfig:PS}static set DefaultConfig(e){ei.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new zo,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const r=this.logger=gp(e.debug||!1,"Hls instance",e.assetPlayerId),n=this.config=wS(ei.DefaultConfig,e,r);this.userConfig=e,n.progressive&&OS(n,r);const{abrController:l,bufferController:f,capLevelController:c,errorController:y,fpsController:S}=n,T=new y(this),A=this.abrController=new l(this),L=new ay(this),b=n.interstitialsController,C=b?this.interstitialsController=new b(this,ei):null,D=this.bufferController=new f(this,L),M=this.capLevelController=new c(this),F=new S(this),$=new XS(this),H=n.contentSteeringController,K=H?new H(this):null,z=this.levelController=new VS(this,K),Q=new $S(this),ne=new jS(this.config),Z=this.streamController=new qS(this,L,ne),ie=this.gapController=new US(this,L);M.setStreamController(Z),F.setStreamController(Z);const le=[$,z,Z];C&&le.splice(1,0,C),K&&le.splice(1,0,K),this.networkControllers=le;const ee=[A,D,ie,M,F,Q,L];this.audioTrackController=this.createController(n.audioTrackController,le);const ve=n.audioStreamController;ve&&le.push(this.audioStreamController=new ve(this,L,ne)),this.subtitleTrackController=this.createController(n.subtitleTrackController,le);const Ee=n.subtitleStreamController;Ee&&le.push(this.subtititleStreamController=new Ee(this,L,ne)),this.createController(n.timelineController,ee),ne.emeController=this.emeController=this.createController(n.emeController,ee),this.cmcdController=this.createController(n.cmcdController,ee),this.latencyController=this.createController(KS,ee),this.coreComponents=ee,le.push(T);const Ne=T.onErrorOut;typeof Ne=="function"&&this.on(w.ERROR,Ne,T),this.on(w.MANIFEST_LOADED,$.onManifestLoaded,$)}createController(e,r){if(e){const n=new e(this);return r&&r.push(n),n}return null}on(e,r,n=this){this._emitter.on(e,r,n)}once(e,r,n=this){this._emitter.once(e,r,n)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,r,n=this,l){this._emitter.off(e,r,n,l)}listeners(e){return this._emitter.listeners(e)}emit(e,r,n){return this._emitter.emit(e,r,n)}trigger(e,r){if(this.config.debug)return this.emit(e,e,r);try{return this.emit(e,e,r)}catch(n){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+n.message+'". Here is a stacktrace:',n),!this.triggeringException){this.triggeringException=!0;const l=e===w.ERROR;this.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.INTERNAL_EXCEPTION,fatal:l,event:e,error:n}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(w.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(r=>r.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(r=>r.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const f=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(w.ERROR,{type:De.OTHER_ERROR,details:re.ATTACH_MEDIA_ERROR,fatal:!0,error:f});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const r="media"in e,n=r?e.media:e,l=r?e:{media:n};this._media=n,this.trigger(w.MEDIA_ATTACHING,l)}detachMedia(){this.logger.log("detachMedia"),this.trigger(w.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(w.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const r=this.media,n=this._url,l=this._url=Go.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${l}`),r&&n&&(n!==l||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(r)),this.trigger(w.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,r){this.logger.log(`startLoad(${e+(r?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let n=0;n<this.networkControllers.length&&(this.networkControllers[n].startLoad(e,r),!(!this.started||!this.networkControllers));n++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[be.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[be.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[be.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,r=e==null?void 0:e.currentTime;this.detachMedia(),e&&(this.attachMedia(e),r&&this.startLoad(r))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=sE()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const r=!!e;r!==this.config.capLevelToPlayerSize&&(r?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=r)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){Vp(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:r}}=this;if(!e)return 0;const n=e.length;for(let l=0;l<n;l++)if(e[l].maxBitrate>=r)return l;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:r,maxHdcpLevel:n}=this;let l;if(r===-1&&e!=null&&e.length?l=e.length-1:l=r,n)for(let f=l;f--;){const c=e[f].attrs["HDCP-LEVEL"];if(c&&c<=n)return f}return l}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var r;return((r=this.audioTrackController)==null?void 0:r.setAudioOption(e))||null}setSubtitleOption(e){var r;return((r=this.subtitleTrackController)==null?void 0:r.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const r=this.audioTrackController;r&&(r.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const r=this.subtitleTrackController;r&&(r.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const r=this.subtitleTrackController;r&&(r.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,r=this.allAudioTracks){const n=Td(r);return Ed(e,n,navigator.mediaCapabilities)}}ei.defaultConfig=void 0;export{ei as H,ZS as a,zS as c,QS as g,JS as r};
