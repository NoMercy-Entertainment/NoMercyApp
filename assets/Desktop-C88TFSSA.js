import{C as K,Ct as n,Dt as y,Et as q,J,K as c,O as te,S as i,T as h,X as se,c as j,g as G,h as ae,j as H,k as Q,mt as x,ot as z,w as T,wt as oe}from"./i18n-fABvX7Av.js";import"./ionic-DIYphHxf.js";import{C as re,_ as ne}from"./vue-core-hXf_Oh5G.js";import"./dist-CJipjyJM.js";import"./query-BsKzQ1i8.js";import"./esm-D1nPlPuN.js";import{Ei as ie,Ki as le,mi as Y,qi as F,va as W}from"./index-D70HP9b0.js";import"./useInfiniteServerClient-CqYT9R1N.js";import"./useServerClient-FMNZVARp.js";import"./ScrollContainer-BQE8uB0u.js";import"./useMounted-C90o8FQQ.js";import"./RipperOverlay-DbFRSTLk.js";import"./ripperSocket-DQpXINAg.js";import"./FloatingBackButton-DUNFh7Ik.js";import{t as ue}from"./DashboardLayout-CYA144Ld.js";j();function de(){const D=x(!1),g=x(0),v=x(0),a=x(0),_=x(0),r=x([]),f=x(!1);let m=null;function E(){v.value=r.value.filter(o=>o.status==="completed").length}function S(){f.value||(m?.postMessage({controls:{type:"pause"}}),r.value.forEach(o=>{o.status!=="completed"&&(o.status="paused",o.children.forEach(s=>{s.status!=="completed"&&(s.status="paused")}))}),f.value=!0)}function B(){if(f.value){const o=r.value.filter(s=>s.status==="paused");o.length>0&&(o[0].status="pending",o[0].children.forEach(s=>{s.status==="paused"&&(s.status="pending")}),o.slice(1).forEach(s=>{s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})}),m?.postMessage({controls:{type:"resume",pausedIds:o.map(s=>s.id)}})),f.value=!1}}function U(o){const s=r.value.find(e=>e.id===o);s&&(s.status==="downloading"||s.status==="pending"||s.status==="waiting")&&(m?.postMessage({controls:{type:"pauseItem",itemId:o}}),s.status="paused",s.children.forEach(e=>{(e.status==="downloading"||e.status==="pending"||e.status==="waiting")&&(e.status="paused")}),r.value.every(e=>e.status==="completed"||e.status==="paused")&&(f.value=!0))}function $(o){const s=r.value.find(e=>e.id===o);s&&s.status==="paused"&&(m?.postMessage({controls:{type:"resumeItem",itemId:o}}),r.value.find(e=>e.status==="downloading"||e.status==="pending")?(s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})):(s.status="pending",s.children.forEach(e=>{e.status==="paused"&&(e.status="pending")})),r.value.some(e=>e.status==="downloading"||e.status==="pending")&&(f.value=!1))}function V(o){m?.postMessage({controls:{action:"prioritize",itemId:o}})}async function R(o,s){D.value=!0;try{const{data:e}=await le().get(`/${s}/watch`),L=e.filter(t=>!!t?.file).map(t=>t.video_id),O=r.value.map(t=>t.id),A=L.some(t=>!O.includes(t))||O.some(t=>!L.includes(t));A?(g.value=0,v.value=0,r.value=[]):r.value=r.value.filter(t=>t.status==="completed"),r.value=await Promise.all(e.filter(t=>!!t?.file).map(async(t,b)=>{const l=t.tracks?.some(d=>d.kind==="subtitles"&&d.file),w=t.tracks?.some(d=>d.kind==="fonts"&&d.file),u=t.tracks?.some(d=>["thumbnails","sprite"].includes(d.kind)&&d.file);let M=!1;if(t.file.endsWith(".m3u8"))try{M=(await(await fetch(`${F.value?.serverBaseUrl}${t.file}`,{headers:{Authorization:`Bearer ${W.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(d){console.warn("Failed to check master playlist for audio:",d)}const k=[{type:"video",name:"Video",progress:0,status:"pending"}];return M&&k.push({type:"audio",name:"Audio",progress:0,status:"pending"}),l&&k.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),u&&k.push({type:"preview",name:"Preview",progress:0,status:"pending"}),w&&k.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:t.video_id,title:`${t.show}${t.season?` S${Y(t.season,2)}`:""}${t.episode?`E${Y(t.episode,2)}`:""} - ${t.title}`,image:t.image,progress:0,status:b===0?"pending":"waiting",children:k.map(d=>({...d,status:b===0?"pending":"waiting"}))}}));const C=e.filter(t=>!!t?.file).map(t=>{const b=t.tracks?.filter(u=>u.kind==="subtitles"&&u.file)?.map(u=>u.file),l=t.tracks?.filter(u=>u.kind==="fonts"&&u.file)?.map(u=>u.file),w=t.tracks?.filter(u=>["thumbnails","sprite"].includes(u.kind)&&u.file)?.map(u=>u.file);return{mediaId:t.video_id,mediaType:"video",mediaPath:t.file,baseUrl:F.value?.serverBaseUrl||"",token:W.value?.accessToken||"",...b?.length?{subtitlePaths:b}:{},...l?.length?{fontPaths:l}:{},...w?.length?{previewPaths:w}:{}}});if(!C.length)throw new Error("No valid files to download");return a.value=C.length,console.log("Starting download with tasks:",C),await new Promise((t,b)=>{m=new Worker(new URL("/assets/downloadWorker-Bu7z8Y_c.js",""+import.meta.url),{type:"module"}),m.onerror=l=>{console.error("Worker error:",l),b(l)},m.onmessage=l=>{if(console.log("Worker message:",l.data),l.data.type==="error"&&l.data.error==="paused")return;const{type:w,progress:u,itemProgress:M,assetType:k,assetProgress:d,itemId:X,status:N,isNewQuery:Z}=l.data;if(w==="progress"){if((A||!Z)&&(g.value=Math.min(u,100)),_.value=M,X){const p=r.value.find(I=>I.id===X);if(p){if(k){const P=p.children.find(ee=>ee.type===k);P&&(P.progress=Math.min(d,100),P.status=P.progress===100?"completed":N)}const I=p.children.filter(P=>P.progress===100).length;p.progress=Math.round(I/p.children.length*100),p.progress===100?(p.status="completed",E()):N&&(p.status=N)}}}else if(w==="complete")E(),t(!0);else if(w==="error")l.data.error==="paused"?t(!1):b(l.data.error);else if(w==="status"){const p=r.value.find(I=>I.id===l.data.itemId);p&&p.status!=="completed"&&p.status!==l.data.status&&(p.status=l.data.status,p.children.forEach(I=>{I.status!=="completed"&&(I.status=l.data.status)}))}},m.postMessage({tasks:C,baseUrl:F.value?.serverBaseUrl,token:W.value?.accessToken,isNewQuery:A})}),!0}catch(e){return e==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",e),!1)}finally{f.value||(m?.terminate(),D.value=!1)}}return{isDownloading:D,progress:g,totalItems:a,completedItems:v,itemProgress:_,downloadQueue:r,isPaused:f,downloadPlaylist:R,pauseDownloads:S,resumeDownloads:B,pauseItem:U,resumeItem:$,prioritizeItem:V}}j();var pe={class:"bg-surface-900/50 rounded p-4 grid gap-2"},me={class:"flex justify-between items-center"},fe={class:"text-sm font-medium truncate flex items-center gap-2"},ce={key:0,class:"text-2xs text-slate-400"},ge={key:1,class:"text-2xs text-slate-400"},ve={class:"flex gap-2"},we=["src"],he={class:"flex-1 min-w-0 grid gap-x-4 gap-y-0.5"},ye={class:"flex justify-between leading-0"},_e={class:"w-full bg-surface-700 rounded h-1"},be=H({__name:"DownloadQueueItem",props:{item:{},onPause:{type:Function},onResume:{type:Function}},setup(D){const g=a=>({"bg-blue-500":a==="video","bg-green-500":a==="audio","bg-yellow-500":a==="subtitle","bg-purple-500":a==="preview","bg-pink-500":a==="font"}),v=a=>a==="downloading"||a==="pending"||a==="waiting";return(a,_)=>(c(),h("article",pe,[i("header",me,[i("h3",fe,[te(y(a.item.title)+" ",1),a.item.status==="downloading"?(c(),h("span",ce,"(Downloading...)")):a.item.status==="waiting"?(c(),h("span",ge,"(Waiting...)")):T("",!0)]),a.item.status!=="completed"?(c(),h("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-surface-800",onClick:_[0]||(_[0]=r=>v(a.item.status)?a.onPause(a.item.id):a.onResume(a.item.id))},y(v(a.item.status)?"Pause":"Resume"),1)):T("",!0)]),i("div",ve,[i("img",{src:`${n(ie)}${a.item.image}`,alt:"Item Image",class:"w-1/4 h-auto aspect-video object-fit rounded"},null,8,we),i("div",he,[(c(!0),h(G,null,J(a.item.children,r=>(c(),h("div",{key:r.type,class:"text-2xs"},[i("div",ye,[i("span",null,y(r.name),1),i("span",null,y(r.progress)+"%",1)]),i("div",_e,[i("div",{class:oe([g(r.type),"h-full rounded"]),style:q(`width: ${r.progress}%`)},null,6)])]))),128))])])]))}}),ke=be;j();var Ie={class:"flex gap-4 max-h-[80vh] overflow-clip"},xe=["disabled"],Pe={key:0,class:"text-xs grid gap-1"},De={class:"flex justify-between items-center"},$e={class:"w-full bg-surface-700 rounded h-1.5 relative"},Ee={key:0,class:"flex-1 overflow-y-auto available grid gap-2 content-start"},Ce=H({__name:"Desktop",setup(D){const{isDownloading:g,progress:v,totalItems:a,completedItems:_,downloadQueue:r,isPaused:f,downloadPlaylist:m,pauseDownloads:E,resumeDownloads:S,pauseItem:B,resumeItem:U}=de(),$=x("tv/138357");async function V(){await m("video",$.value)}return(R,o)=>{const s=se("InputText");return c(),K(n(re),null,{default:z(()=>[Q(n(ne),{fullscreen:!0},{default:z(()=>[Q(ue,{"grid-style":3,title:"Profile",class:"grid gap-2 p-4 col-span-12"},{default:z(()=>[o[2]||(o[2]=i("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),i("div",Ie,[i("form",{class:"w-2/5 flex flex-col gap-2",onSubmit:ae(V,["prevent"])},[Q(s,{modelValue:$.value,"onUpdate:modelValue":o[0]||(o[0]=e=>$.value=e),class:"w-full text-sm"},null,8,["modelValue"]),i("button",{disabled:n(g),class:"bg-primary p-1.5 rounded disabled:opacity-50 text-sm",type:"submit"},y(n(g)?"Downloading...":"Download Show"),9,xe),n(g)||n(_)?(c(),h("div",Pe,[i("div",De,[i("span",null,"Progress: "+y(n(v))+"% ("+y(n(_))+"/"+y(n(a))+")",1),i("button",{class:"text-xs px-2 py-0.5 rounded bg-surface-800",type:"button",onClick:o[1]||(o[1]=e=>n(f)?n(S)():n(E)())},y(n(f)?"Resume All":"Pause All"),1)]),i("div",$e,[i("div",{style:q(`width: ${n(v)}%`),class:"bg-primary h-full rounded absolute inset-0"},null,4)])])):T("",!0)],32),n(r).length?(c(),h("div",Ee,[(c(!0),h(G,null,J(n(r),e=>(c(),K(ke,{key:e.id,item:e,"on-pause":n(B),"on-resume":n(U)},null,8,["item","on-pause","on-resume"]))),128))])):T("",!0)])]),_:1})]),_:1})]),_:1})}}}),Oe=Ce;export{Oe as default};
