(function(){var z=Object.create,L=Object.defineProperty,J=Object.getOwnPropertyDescriptor,Z=Object.getOwnPropertyNames,k=Object.getPrototypeOf,tt=Object.prototype.hasOwnProperty,et=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports),it=(a,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(var r=Z(e),n=0,c=r.length,g;n<c;n++)g=r[n],!tt.call(a,g)&&g!==t&&L(a,g,{get:(f=>e[f]).bind(null,g),enumerable:!(i=J(e,g))||i.enumerable});return a},st=(a,e,t)=>(t=a!=null?z(k(a)):{},it(e||!a||!a.__esModule?L(t,"default",{value:a,enumerable:!0}):t,a)),B=function(){function a(){this.listeners={}}var e=a.prototype;return e.on=function(i,r){this.listeners[i]||(this.listeners[i]=[]),this.listeners[i].push(r)},e.off=function(i,r){if(!this.listeners[i])return!1;var n=this.listeners[i].indexOf(r);return this.listeners[i]=this.listeners[i].slice(0),this.listeners[i].splice(n,1),n>-1},e.trigger=function(i){var r=this.listeners[i];if(r)if(arguments.length===2)for(var n=r.length,c=0;c<n;++c)r[c].call(this,arguments[1]);else for(var g=Array.prototype.slice.call(arguments,1),f=r.length,m=0;m<f;++m)r[m].apply(this,g)},e.dispose=function(){this.listeners={}},e.pipe=function(i){this.on("data",function(r){i.push(r)})},a}();function y(){return y=Object.assign?Object.assign.bind():function(a){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(a[i]=t[i])}return a},y.apply(null,arguments)}var at=et((a,e)=>{var t;typeof window<"u"?t=window:typeof global<"u"?t=global:typeof self<"u"?t=self:t={},e.exports=t}),q=st(at()),rt=function(e){return q.default.atob?q.default.atob(e):Buffer.from(e,"base64").toString("binary")};function nt(a){for(var e=rt(a),t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}var ot=class extends B{constructor(){super(),this.buffer=""}push(a){let e;for(this.buffer+=a,e=this.buffer.indexOf(`
`);e>-1;e=this.buffer.indexOf(`
`))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)}};const ut=String.fromCharCode(9),Y=function(a){const e=/([0-9.]*)?@?([0-9.]*)?/.exec(a||""),t={};return e[1]&&(t.length=parseInt(e[1],10)),e[2]&&(t.offset=parseInt(e[2],10)),t},ft=function(){return new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')},P=function(a){const e={};if(!a)return e;const t=a.split(ft());let i=t.length,r;for(;i--;)t[i]!==""&&(r=/([^=]*)=(.*)/.exec(t[i]).slice(1),r[0]=r[0].replace(/^\s+|\s+$/g,""),r[1]=r[1].replace(/^\s+|\s+$/g,""),r[1]=r[1].replace(/^['"](.*)['"]$/g,"$1"),e[r[0]]=r[1]);return e},W=a=>{const e=a.split("x"),t={};return e[0]&&(t.width=parseInt(e[0],10)),e[1]&&(t.height=parseInt(e[1],10)),t};var gt=class extends B{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(a){let e,t;if(a=a.trim(),a.length!==0){if(a[0]!=="#"){this.trigger("data",{type:"uri",uri:a});return}this.tagMappers.reduce((i,r)=>{const n=r(a);return n===a?i:i.concat([n])},[a]).forEach(i=>{for(let r=0;r<this.customParsers.length;r++)if(this.customParsers[r].call(this,i))return;if(i.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:i.slice(1)});return}if(i=i.replace("\r",""),e=/^#EXTM3U/.exec(i),e){this.trigger("data",{type:"tag",tagType:"m3u"});return}if(e=/^#EXTINF:([0-9\.]*)?,?(.*)?$/.exec(i),e){t={type:"tag",tagType:"inf"},e[1]&&(t.duration=parseFloat(e[1])),e[2]&&(t.title=e[2]),this.trigger("data",t);return}if(e=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(i),e){t={type:"tag",tagType:"targetduration"},e[1]&&(t.duration=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-VERSION:([0-9.]*)?/.exec(i),e){t={type:"tag",tagType:"version"},e[1]&&(t.version=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA-SEQUENCE:(\-?[0-9.]*)?/.exec(i),e){t={type:"tag",tagType:"media-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\-?[0-9.]*)?/.exec(i),e){t={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(i),e){t={type:"tag",tagType:"playlist-type"},e[1]&&(t.playlistType=e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-BYTERANGE:(.*)?$/.exec(i),e){t=y(Y(e[1]),{type:"tag",tagType:"byterange"}),this.trigger("data",t);return}if(e=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(i),e){t={type:"tag",tagType:"allow-cache"},e[1]&&(t.allowed=!/NO/.test(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-MAP:(.*)$/.exec(i),e){if(t={type:"tag",tagType:"map"},e[1]){const r=P(e[1]);r.URI&&(t.uri=r.URI),r.BYTERANGE&&(t.byterange=Y(r.BYTERANGE))}this.trigger("data",t);return}if(e=/^#EXT-X-STREAM-INF:(.*)$/.exec(i),e){t={type:"tag",tagType:"stream-inf"},e[1]&&(t.attributes=P(e[1]),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=W(t.attributes.RESOLUTION)),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),t.attributes["PROGRAM-ID"]&&(t.attributes["PROGRAM-ID"]=parseInt(t.attributes["PROGRAM-ID"],10))),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA:(.*)$/.exec(i),e){t={type:"tag",tagType:"media"},e[1]&&(t.attributes=P(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-ENDLIST/.exec(i),e){this.trigger("data",{type:"tag",tagType:"endlist"});return}if(e=/^#EXT-X-DISCONTINUITY/.exec(i),e){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}if(e=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(i),e){t={type:"tag",tagType:"program-date-time"},e[1]&&(t.dateTimeString=e[1],t.dateTimeObject=new Date(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-KEY:(.*)$/.exec(i),e){t={type:"tag",tagType:"key"},e[1]&&(t.attributes=P(e[1]),t.attributes.IV&&(t.attributes.IV.substring(0,2).toLowerCase()==="0x"&&(t.attributes.IV=t.attributes.IV.substring(2)),t.attributes.IV=t.attributes.IV.match(/.{8}/g),t.attributes.IV[0]=parseInt(t.attributes.IV[0],16),t.attributes.IV[1]=parseInt(t.attributes.IV[1],16),t.attributes.IV[2]=parseInt(t.attributes.IV[2],16),t.attributes.IV[3]=parseInt(t.attributes.IV[3],16),t.attributes.IV=new Uint32Array(t.attributes.IV))),this.trigger("data",t);return}if(e=/^#EXT-X-START:(.*)$/.exec(i),e){t={type:"tag",tagType:"start"},e[1]&&(t.attributes=P(e[1]),t.attributes["TIME-OFFSET"]=parseFloat(t.attributes["TIME-OFFSET"]),t.attributes.PRECISE=/YES/.test(t.attributes.PRECISE)),this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(i),e){t={type:"tag",tagType:"cue-out-cont"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT:(.*)?$/.exec(i),e){t={type:"tag",tagType:"cue-out"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-IN:?(.*)?$/.exec(i),e){t={type:"tag",tagType:"cue-in"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-SKIP:(.*)$/.exec(i),e&&e[1]){t={type:"tag",tagType:"skip"},t.attributes=P(e[1]),t.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(t.attributes["SKIPPED-SEGMENTS"]=parseInt(t.attributes["SKIPPED-SEGMENTS"],10)),t.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(t.attributes["RECENTLY-REMOVED-DATERANGES"]=t.attributes["RECENTLY-REMOVED-DATERANGES"].split(ut)),this.trigger("data",t);return}if(e=/^#EXT-X-PART:(.*)$/.exec(i),e&&e[1]){t={type:"tag",tagType:"part"},t.attributes=P(e[1]),["DURATION"].forEach(function(r){t.attributes.hasOwnProperty(r)&&(t.attributes[r]=parseFloat(t.attributes[r]))}),["INDEPENDENT","GAP"].forEach(function(r){t.attributes.hasOwnProperty(r)&&(t.attributes[r]=/YES/.test(t.attributes[r]))}),t.attributes.hasOwnProperty("BYTERANGE")&&(t.attributes.byterange=Y(t.attributes.BYTERANGE)),this.trigger("data",t);return}if(e=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(i),e&&e[1]){t={type:"tag",tagType:"server-control"},t.attributes=P(e[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(r){t.attributes.hasOwnProperty(r)&&(t.attributes[r]=parseFloat(t.attributes[r]))}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(r){t.attributes.hasOwnProperty(r)&&(t.attributes[r]=/YES/.test(t.attributes[r]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PART-INF:(.*)$/.exec(i),e&&e[1]){t={type:"tag",tagType:"part-inf"},t.attributes=P(e[1]),["PART-TARGET"].forEach(function(r){t.attributes.hasOwnProperty(r)&&(t.attributes[r]=parseFloat(t.attributes[r]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(i),e&&e[1]){t={type:"tag",tagType:"preload-hint"},t.attributes=P(e[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(r){if(t.attributes.hasOwnProperty(r)){t.attributes[r]=parseInt(t.attributes[r],10);const n=r==="BYTERANGE-LENGTH"?"length":"offset";t.attributes.byterange=t.attributes.byterange||{},t.attributes.byterange[n]=t.attributes[r],delete t.attributes[r]}}),this.trigger("data",t);return}if(e=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(i),e&&e[1]){t={type:"tag",tagType:"rendition-report"},t.attributes=P(e[1]),["LAST-MSN","LAST-PART"].forEach(function(r){t.attributes.hasOwnProperty(r)&&(t.attributes[r]=parseInt(t.attributes[r],10))}),this.trigger("data",t);return}if(e=/^#EXT-X-DATERANGE:(.*)$/.exec(i),e&&e[1]){t={type:"tag",tagType:"daterange"},t.attributes=P(e[1]),["ID","CLASS"].forEach(function(n){t.attributes.hasOwnProperty(n)&&(t.attributes[n]=String(t.attributes[n]))}),["START-DATE","END-DATE"].forEach(function(n){t.attributes.hasOwnProperty(n)&&(t.attributes[n]=new Date(t.attributes[n]))}),["DURATION","PLANNED-DURATION"].forEach(function(n){t.attributes.hasOwnProperty(n)&&(t.attributes[n]=parseFloat(t.attributes[n]))}),["END-ON-NEXT"].forEach(function(n){t.attributes.hasOwnProperty(n)&&(t.attributes[n]=/YES/i.test(t.attributes[n]))}),["SCTE35-CMD"," SCTE35-OUT","SCTE35-IN"].forEach(function(n){t.attributes.hasOwnProperty(n)&&(t.attributes[n]=t.attributes[n].toString(16))});const r=/^X-([A-Z]+-)+[A-Z]+$/;for(const n in t.attributes){if(!r.test(n))continue;const c=/[0-9A-Fa-f]{6}/g.test(t.attributes[n]),g=/^\d+(\.\d+)?$/.test(t.attributes[n]);t.attributes[n]=c?t.attributes[n].toString(16):g?parseFloat(t.attributes[n]):String(t.attributes[n])}this.trigger("data",t);return}if(e=/^#EXT-X-INDEPENDENT-SEGMENTS/.exec(i),e){this.trigger("data",{type:"tag",tagType:"independent-segments"});return}if(e=/^#EXT-X-I-FRAMES-ONLY/.exec(i),e){this.trigger("data",{type:"tag",tagType:"i-frames-only"});return}if(e=/^#EXT-X-CONTENT-STEERING:(.*)$/.exec(i),e){t={type:"tag",tagType:"content-steering"},t.attributes=P(e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-I-FRAME-STREAM-INF:(.*)$/.exec(i),e){t={type:"tag",tagType:"i-frame-playlist"},t.attributes=P(e[1]),t.attributes.URI&&(t.uri=t.attributes.URI),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=W(t.attributes.RESOLUTION)),t.attributes["AVERAGE-BANDWIDTH"]&&(t.attributes["AVERAGE-BANDWIDTH"]=parseInt(t.attributes["AVERAGE-BANDWIDTH"],10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),this.trigger("data",t);return}if(e=/^#EXT-X-DEFINE:(.*)$/.exec(i),e){t={type:"tag",tagType:"define"},t.attributes=P(e[1]),this.trigger("data",t);return}this.trigger("data",{type:"tag",data:i.slice(4)})})}}addParser({expression:a,customType:e,dataParser:t,segment:i}){typeof t!="function"&&(t=r=>r),this.customParsers.push(r=>{if(a.exec(r))return this.trigger("data",{type:"custom",data:t(r),customType:e,segment:i}),!0})}addTagMapper({expression:a,map:e}){const t=i=>a.test(i)?e(i):i;this.tagMappers.push(t)}};const dt=a=>a.toLowerCase().replace(/-(\w)/g,e=>e[1].toUpperCase()),M=function(a){const e={};return Object.keys(a).forEach(function(t){e[dt(t)]=a[t]}),e},H=function(a){const{serverControl:e,targetDuration:t,partTargetDuration:i}=a;if(!e)return;const r="#EXT-X-SERVER-CONTROL",n="holdBack",c="partHoldBack",g=t&&t*3,f=i&&i*2;t&&!e.hasOwnProperty(n)&&(e[n]=g,this.trigger("info",{message:`${r} defaulting HOLD-BACK to targetDuration * 3 (${g}).`})),g&&e[n]<g&&(this.trigger("warn",{message:`${r} clamping HOLD-BACK (${e[n]}) to targetDuration * 3 (${g})`}),e[n]=g),i&&!e.hasOwnProperty(c)&&(e[c]=i*3,this.trigger("info",{message:`${r} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${e[c]}).`})),i&&e[c]<f&&(this.trigger("warn",{message:`${r} clamping PART-HOLD-BACK (${e[c]}) to partTargetDuration * 2 (${f}).`}),e[c]=f)};var K=class extends B{constructor(a={}){super(),this.lineStream=new ot,this.parseStream=new gt,this.lineStream.pipe(this.parseStream),this.mainDefinitions=a.mainDefinitions||{},this.params=new URL(a.uri,"https://a.com").searchParams,this.lastProgramDateTime=null;const e=this,t=[];let i={},r,n,c=!1;const g=function(){},f={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},m="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";let d=0;this.manifest={allowCache:!0,discontinuityStarts:[],dateRanges:[],iFramePlaylists:[],segments:[]};let I=0,b=0;const A={};this.on("end",()=>{i.uri||!i.parts&&!i.preloadHints||(!i.map&&r&&(i.map=r),!i.key&&n&&(i.key=n),!i.timeline&&typeof d=="number"&&(i.timeline=d),this.manifest.preloadSegment=i)}),this.parseStream.on("data",function(s){let R,p;if(e.manifest.definitions){for(const u in e.manifest.definitions)if(s.uri&&(s.uri=s.uri.replace(`{$${u}}`,e.manifest.definitions[u])),s.attributes)for(const o in s.attributes)typeof s.attributes[o]=="string"&&(s.attributes[o]=s.attributes[o].replace(`{$${u}}`,e.manifest.definitions[u]))}({tag(){({version(){s.version&&(this.manifest.version=s.version)},"allow-cache"(){this.manifest.allowCache=s.allowed,"allowed"in s||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){const u={};"length"in s&&(i.byterange=u,u.length=s.length,"offset"in s||(s.offset=I)),"offset"in s&&(i.byterange=u,u.offset=s.offset),I=u.offset+u.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),s.title&&(i.title=s.title),s.duration>0&&(i.duration=s.duration),s.duration===0&&(i.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=t},key(){if(!s.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(s.attributes.METHOD==="NONE"){n=null;return}if(!s.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(s.attributes.KEYFORMAT==="com.apple.streamingkeydelivery"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:s.attributes};return}if(s.attributes.KEYFORMAT==="com.microsoft.playready"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.microsoft.playready"]={uri:s.attributes.URI};return}if(s.attributes.KEYFORMAT===m){if(["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(s.attributes.METHOD)===-1){this.trigger("warn",{message:"invalid key method provided for Widevine"});return}if(s.attributes.METHOD==="SAMPLE-AES-CENC"&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),s.attributes.URI.substring(0,23)!=="data:text/plain;base64,"){this.trigger("warn",{message:"invalid key URI provided for Widevine"});return}if(!(s.attributes.KEYID&&s.attributes.KEYID.substring(0,2)==="0x")){this.trigger("warn",{message:"invalid key ID provided for Widevine"});return}this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:s.attributes.KEYFORMAT,keyId:s.attributes.KEYID.substring(2)},pssh:nt(s.attributes.URI.split(",")[1])};return}s.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),n={method:s.attributes.METHOD||"AES-128",uri:s.attributes.URI},typeof s.attributes.IV<"u"&&(n.iv=s.attributes.IV)},"media-sequence"(){if(!isFinite(s.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+s.number});return}this.manifest.mediaSequence=s.number},"discontinuity-sequence"(){if(!isFinite(s.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+s.number});return}this.manifest.discontinuitySequence=s.number,d=s.number},"playlist-type"(){if(!/VOD|EVENT/.test(s.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+s.playlist});return}this.manifest.playlistType=s.playlistType},map(){r={},s.uri&&(r.uri=s.uri),s.byterange&&(r.byterange=s.byterange),n&&(r.key=n)},"stream-inf"(){if(this.manifest.playlists=t,this.manifest.mediaGroups=this.manifest.mediaGroups||f,!s.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}i.attributes||(i.attributes={}),y(i.attributes,s.attributes)},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||f,!(s.attributes&&s.attributes.TYPE&&s.attributes["GROUP-ID"]&&s.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}const u=this.manifest.mediaGroups[s.attributes.TYPE];u[s.attributes["GROUP-ID"]]=u[s.attributes["GROUP-ID"]]||{},R=u[s.attributes["GROUP-ID"]],p={default:/yes/i.test(s.attributes.DEFAULT)},p.default?p.autoselect=!0:p.autoselect=/yes/i.test(s.attributes.AUTOSELECT),s.attributes.LANGUAGE&&(p.language=s.attributes.LANGUAGE),s.attributes.URI&&(p.uri=s.attributes.URI),s.attributes["INSTREAM-ID"]&&(p.instreamId=s.attributes["INSTREAM-ID"]),s.attributes.CHARACTERISTICS&&(p.characteristics=s.attributes.CHARACTERISTICS),s.attributes.FORCED&&(p.forced=/yes/i.test(s.attributes.FORCED)),R[s.attributes.NAME]=p},discontinuity(){d+=1,i.discontinuity=!0,this.manifest.discontinuityStarts.push(t.length)},"program-date-time"(){typeof this.manifest.dateTimeString>"u"&&(this.manifest.dateTimeString=s.dateTimeString,this.manifest.dateTimeObject=s.dateTimeObject),i.dateTimeString=s.dateTimeString,i.dateTimeObject=s.dateTimeObject;const{lastProgramDateTime:u}=this;this.lastProgramDateTime=new Date(s.dateTimeString).getTime(),u===null&&this.manifest.segments.reduceRight((o,h)=>(h.programDateTime=o-h.duration*1e3,h.programDateTime),this.lastProgramDateTime)},targetduration(){if(!isFinite(s.duration)||s.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+s.duration});return}this.manifest.targetDuration=s.duration,H.call(this,this.manifest)},start(){if(!s.attributes||isNaN(s.attributes["TIME-OFFSET"])){this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});return}this.manifest.start={timeOffset:s.attributes["TIME-OFFSET"],precise:s.attributes.PRECISE}},"cue-out"(){i.cueOut=s.data},"cue-out-cont"(){i.cueOutCont=s.data},"cue-in"(){i.cueIn=s.data},skip(){this.manifest.skip=M(s.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",s.attributes,["SKIPPED-SEGMENTS"])},part(){c=!0;const u=this.manifest.segments.length,o=M(s.attributes);i.parts=i.parts||[],i.parts.push(o),o.byterange&&(o.byterange.hasOwnProperty("offset")||(o.byterange.offset=b),b=o.byterange.offset+o.byterange.length);const h=i.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${h} for segment #${u}`,s.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((l,E)=>{l.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${E} lacks required attribute(s): LAST-PART`})})},"server-control"(){const u=this.manifest.serverControl=M(s.attributes);u.hasOwnProperty("canBlockReload")||(u.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),H.call(this,this.manifest),u.canSkipDateranges&&!u.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){const u=this.manifest.segments.length,o=M(s.attributes),h=o.type&&o.type==="PART";i.preloadHints=i.preloadHints||[],i.preloadHints.push(o),o.byterange&&(o.byterange.hasOwnProperty("offset")||(o.byterange.offset=h?b:0,h&&(b=o.byterange.offset+o.byterange.length)));const l=i.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${l} for segment #${u}`,s.attributes,["TYPE","URI"]),!!o.type)for(let E=0;E<i.preloadHints.length-1;E++){const U=i.preloadHints[E];U.type&&U.type===o.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${l} for segment #${u} has the same TYPE ${o.type} as preload hint #${E}`})}},"rendition-report"(){const u=M(s.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(u);const o=this.manifest.renditionReports.length-1,h=["LAST-MSN","URI"];c&&h.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${o}`,s.attributes,h)},"part-inf"(){this.manifest.partInf=M(s.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",s.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),H.call(this,this.manifest)},daterange(){this.manifest.dateRanges.push(M(s.attributes));const u=this.manifest.dateRanges.length-1;this.warnOnMissingAttributes_(`#EXT-X-DATERANGE #${u}`,s.attributes,["ID","START-DATE"]);const o=this.manifest.dateRanges[u];o.endDate&&o.startDate&&new Date(o.endDate)<new Date(o.startDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE END-DATE must be equal to or later than the value of the START-DATE"}),o.duration&&o.duration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE DURATION must not be negative"}),o.plannedDuration&&o.plannedDuration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE PLANNED-DURATION must not be negative"});const h=!!o.endOnNext;if(h&&!o.class&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must have a CLASS attribute"}),h&&(o.duration||o.endDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must not contain DURATION or END-DATE attributes"}),o.duration&&o.endDate){const l=o.startDate.getTime()+o.duration*1e3;this.manifest.dateRanges[u].endDate=new Date(l)}if(!A[o.id])A[o.id]=o;else{for(const E in A[o.id])if(o[E]&&JSON.stringify(A[o.id][E])!==JSON.stringify(o[E])){this.trigger("warn",{message:"EXT-X-DATERANGE tags with the same ID in a playlist must have the same attributes values"});break}const l=this.manifest.dateRanges.findIndex(E=>E.id===o.id);this.manifest.dateRanges[l]=y(this.manifest.dateRanges[l],o),A[o.id]=y(A[o.id],o),this.manifest.dateRanges.pop()}},"independent-segments"(){this.manifest.independentSegments=!0},"i-frames-only"(){this.manifest.iFramesOnly=!0,this.requiredCompatibilityversion(this.manifest.version,4)},"content-steering"(){this.manifest.contentSteering=M(s.attributes),this.warnOnMissingAttributes_("#EXT-X-CONTENT-STEERING",s.attributes,["SERVER-URI"])},define(){this.manifest.definitions=this.manifest.definitions||{};const u=(o,h)=>{if(o in this.manifest.definitions){this.trigger("error",{message:`EXT-X-DEFINE: Duplicate name ${o}`});return}this.manifest.definitions[o]=h};if("QUERYPARAM"in s.attributes){if("NAME"in s.attributes||"IMPORT"in s.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}const o=this.params.get(s.attributes.QUERYPARAM);if(!o){this.trigger("error",{message:`EXT-X-DEFINE: No query param ${s.attributes.QUERYPARAM}`});return}u(s.attributes.QUERYPARAM,decodeURIComponent(o));return}if("NAME"in s.attributes){if("IMPORT"in s.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}if(!("VALUE"in s.attributes)||typeof s.attributes.VALUE!="string"){this.trigger("error",{message:`EXT-X-DEFINE: No value for ${s.attributes.NAME}`});return}u(s.attributes.NAME,s.attributes.VALUE);return}if("IMPORT"in s.attributes){if(!this.mainDefinitions[s.attributes.IMPORT]){this.trigger("error",{message:`EXT-X-DEFINE: No value ${s.attributes.IMPORT} to import, or IMPORT used on main playlist`});return}u(s.attributes.IMPORT,this.mainDefinitions[s.attributes.IMPORT]);return}this.trigger("error",{message:"EXT-X-DEFINE: No attribute"})},"i-frame-playlist"(){this.manifest.iFramePlaylists.push({attributes:s.attributes,uri:s.uri,timeline:d}),this.warnOnMissingAttributes_("#EXT-X-I-FRAME-STREAM-INF",s.attributes,["BANDWIDTH","URI"])}}[s.tagType]||g).call(e)},uri(){i.uri=s.uri,t.push(i),this.manifest.targetDuration&&!("duration"in i)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),i.duration=this.manifest.targetDuration),n&&(i.key=n),i.timeline=d,r&&(i.map=r),b=0,this.lastProgramDateTime!==null&&(i.programDateTime=this.lastProgramDateTime,this.lastProgramDateTime+=i.duration*1e3),i={}},comment(){},custom(){s.segment?(i.custom=i.custom||{},i.custom[s.customType]=s.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[s.customType]=s.data)}})[s.type].call(e)})}requiredCompatibilityversion(a,e){(a<e||!a)&&this.trigger("warn",{message:`manifest must be at least version ${e}`})}warnOnMissingAttributes_(a,e,t){const i=[];t.forEach(function(r){e.hasOwnProperty(r)||i.push(r)}),i.length&&this.trigger("warn",{message:`${a} lacks required attribute(s): ${i.join(", ")}`})}push(a){this.lineStream.push(a)}end(){this.lineStream.push(`
`),this.manifest.dateRanges.length&&this.lastProgramDateTime===null&&this.trigger("warn",{message:"A playlist with EXT-X-DATERANGE tag must contain atleast one EXT-X-PROGRAM-DATE-TIME tag"}),this.lastProgramDateTime=null,this.trigger("end")}addParser(a){this.parseStream.addParser(a)}addTagMapper(a){this.parseStream.addTagMapper(a)}};let D=!1;const w=new Set;let T=null,j=[];async function N(a,e,t){const i=a.startsWith("http")?a:`${e}${a}`,r=await fetch(i,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok)throw new Error(`Failed to fetch ${a}: ${r.statusText}`);return r}async function S(a){return new Promise((e,t)=>{D||a&&w.has(a)?t(new Error("paused")):e()})}function O(a,e){self.postMessage({type:"status",itemId:a,status:e})}const $=new Map,V=new Map;function v(a,e){return`${a}:${e}`}async function Q(a,e,t,i){let r=0;for(const n of e){const c=n.path.substring(0,n.path.lastIndexOf("/"));for(const g of n.segments){const f=v(a,g.uri.startsWith("http")?g.uri:`${c}/${g.uri}`);await T?.match(f)&&(i.add(f),r++)}}return r}async function ct(a,e,t){if(T||(T=await caches.open("offline-content-v1")),await S(a.mediaId),D||w.has(a.mediaId))return!1;const i=new Map;$.has(a.mediaId)||$.set(a.mediaId,new Set);const r=$.get(a.mediaId);V.has(a.mediaId)||V.set(a.mediaId,new Set);const n=V.get(a.mediaId),c=(f,m,d=0)=>{if(!i.has(f)){const I={type:f,total:m,completed:d};i.set(f,I);const b=X();self.postMessage({type:"progress",progress:b.progress,currentItem:b.completedItems,totalItems:b.totalItems,itemProgress:Math.round(d/m*100),assetType:f,assetProgress:Math.round(d/m*100),itemId:a.mediaId,status:"downloading"}),d===m&&f!=="video"&&f!=="audio"&&r.add(f)}},g=f=>{const m=i.get(f);if(m){m.completed++;const d=Math.round(m.completed/m.total*100);d===100&&f!=="video"&&f!=="audio"&&r.add(f);const I=f==="video"||f==="audio",b=d===100&&!I,A=X();self.postMessage({type:"progress",progress:A.progress,currentItem:A.completedItems,totalItems:A.totalItems,itemProgress:d,assetType:f,assetProgress:d,itemId:a.mediaId,status:b?"completed":"downloading"})}};try{if(await S(a.mediaId),a.mediaPath.includes(".m3u8")){const f=await(await N(a.mediaPath,e,t)).text(),m=new K;m.push(f),m.end();const d=m.manifest,I=a.mediaPath.substring(0,a.mediaPath.lastIndexOf("/"));let b=0;const A=[];if(d.playlists?.length)for(const s of d.playlists){const R=s.uri.startsWith("http")?s.uri:`${I}/${s.uri}`,p=await(await N(R,e,t)).text(),u=new K;u.push(p),u.end(),u.manifest.segments?.length&&(b+=u.manifest.segments.length,A.push({path:R,segments:u.manifest.segments}))}else d.segments?.length&&(b=d.segments.length,A.push({path:a.mediaPath,segments:d.segments}));if(b>0){const s=await Q(a.mediaId,A,"video",n);c("video",b,s);for(const R of A){const p=R.path.substring(0,R.path.lastIndexOf("/"));for(const u of R.segments){await S(a.mediaId);const o=u.uri.startsWith("http")?u.uri:`${p}/${u.uri}`,h=v(a.mediaId,o);if(n.has(h))continue;if(await T.match(h)){n.add(h);continue}await S(a.mediaId);const l=await N(o,e,t).then(U=>U.blob()),E=new Response(l.slice(0));await T.put(h,E),n.add(h),g("video")}}}if(d.mediaGroups?.AUDIO){let s=0;const R=[];for(const p of Object.values(d.mediaGroups.AUDIO))for(const u of Object.values(p)){if(!u.uri)continue;const o=u.uri.startsWith("http")?u.uri:`${I}/${u.uri}`,h=await(await N(o,e,t)).text(),l=new K;l.push(h),l.end(),l.manifest.segments?.length&&(s+=l.manifest.segments.length,R.push({path:o,segments:l.manifest.segments}))}if(s>0){const p=await Q(a.mediaId,R,"audio",n);c("audio",s,p);for(const u of R){const o=u.path.substring(0,u.path.lastIndexOf("/"));for(const h of u.segments){await S(a.mediaId);const l=h.uri.startsWith("http")?h.uri:`${o}/${h.uri}`,E=v(a.mediaId,l);if(n.has(E))continue;if(await T.match(E)){n.add(E);continue}await S(a.mediaId);const U=await N(l,e,t).then(ht=>ht.blob()),mt=new Response(U.slice(0));await T.put(E,mt),n.add(E),g("audio")}}}}}else{const f=v(a.mediaId,a.mediaPath);if(await T.match(f))r.add("video"),self.postMessage({type:"progress",progress:X().progress,currentItem:X().completedItems,totalItems:X().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:a.mediaId,status:"downloading"});else{const m=`${e}${a.mediaPath}`,d=await fetch(m,{headers:{Authorization:`Bearer ${t}`}});if(!d.ok)throw new Error(`Failed to download video: ${d.statusText}`);await T.put(f,d.clone()),r.add("video"),self.postMessage({type:"progress",progress:X().progress,currentItem:X().completedItems,totalItems:X().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:a.mediaId,status:"downloading"})}}if(a.subtitlePaths?.length){c("subtitle",a.subtitlePaths.length);for(const f of a.subtitlePaths){const m=v(a.mediaId,f);if(!await T.match(m)){await S(a.mediaId);const d=await N(f,e,t);await T.put(m,d.clone())}g("subtitle")}}if(a.previewPaths?.length){c("preview",a.previewPaths.length);for(const f of a.previewPaths){const m=v(a.mediaId,f);if(!await T.match(m)){await S(a.mediaId);const d=await N(f,e,t);await T.put(m,d.clone())}g("preview")}}if(a.fontPaths?.length){let f=0;const m=[];for(const d of a.fontPaths){const I=await(await N(d,e,t)).json();f+=I.length,m.push({path:d,fonts:I})}c("font",f);for(const{path:d,fonts:I}of m){const b=v(a.mediaId,d);if(await T.match(b))I.forEach(()=>g("font"));else{await S(a.mediaId);const A=d.substring(0,d.lastIndexOf("/")+1);for(const s of I){await S(a.mediaId);const R=`${A}fonts/${s.file}`,p=v(a.mediaId,R);if(await T.match(p))g("font");else{const u=await N(R,e,t);await T.put(p,u.clone()),g("font")}}await T.put(b,new Response(JSON.stringify(I)))}}}}catch(f){if(f?.message==="paused")return!1;throw f}}let C=[],F="",G="";async function _(a,e,t){let i=0;for(;i<a.length;){const r=a[i];O(r.mediaId,"downloading"),a.slice(i+1).forEach(n=>{!x.get(n.mediaId)&&!w.has(n.mediaId)&&O(n.mediaId,"waiting")});try{if(D){O(r.mediaId,"paused");return}if(w.has(r.mediaId)){O(r.mediaId,"paused"),i++;continue}if(j=[{taskIndex:C.indexOf(r),promise:ct(r,e,t)}],O(r.mediaId,"downloading"),await j[0].promise===!1){if(O(r.mediaId,"paused"),D)return;i++}else O(r.mediaId,"completed"),i++}catch(n){if(n?.message==="paused"){if(O(r.mediaId,"paused"),D)return;i++}else throw O(r.mediaId,"error"),n}}if(a.filter(r=>w.has(r.mediaId)).length===0){const r=X();self.postMessage({type:"complete",progress:r.progress,currentItem:r.completedItems,totalItems:r.totalItems})}}const x=new Map;function X(){const a=Array.from(x.values()).filter(t=>t).length;let e=0;return C.forEach(t=>{if(x.get(t.mediaId))e+=100;else if($.has(t.mediaId)){const i=new Set(["video"]);t.subtitlePaths?.length&&i.add("subtitle"),t.fontPaths?.length&&i.add("font"),t.previewPaths?.length&&i.add("preview");const r=$.get(t.mediaId),n=Array.from(i).filter(c=>r.has(c)).length;e+=n/i.size*100}}),{progress:Math.round(e/C.length),completedItems:a,totalItems:C.length}}self.onmessage=async a=>{const{tasks:e,controls:t}=a.data;if(e&&(C=e,F=a.data.baseUrl,G=a.data.token,x.clear(),w.clear()),t){const{type:i,itemId:r}=t;switch(i){case"pause":D=!0,C.forEach(g=>{x.get(g.mediaId)||(w.add(g.mediaId),self.postMessage({type:"status",itemId:g.mediaId,status:"paused"}))});break;case"resume":D=!1,w.clear();const n=t.pausedIds||[],c=C.filter(g=>!x.get(g.mediaId)&&n.includes(g.mediaId));if(c.length){c.forEach(g=>{O(g.mediaId,"pending")});try{await _(c,F,G)}catch(g){console.error("Failed to resume queue:",g)}}break;case"pauseItem":r&&(w.add(r),O(r,"paused"));break;case"resumeItem":if(r){w.delete(r),O(r,"pending");const g=C.find(f=>f.mediaId===r);if(g&&!x.get(g.mediaId))try{const f=D;D=!1,await _([g],F,G),D=f}catch(f){console.error("Failed to resume item:",f),O(r,"error")}}break}return}await _(e.filter(i=>!x.get(i.mediaId)),F,G)}})();
