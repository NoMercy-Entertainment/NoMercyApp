var c=Object.defineProperty;var p=(a,n,e)=>n in a?c(a,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[n]=e;var o=(a,n,e)=>p(a,typeof n!="symbol"?n+"":n,e);import{d as y,B as u,ae as f}from"./vue-ionic-9j_oSDCB.js";import{P as v}from"./video-player-B2yH_Yz-.js";import{bI as g,az as m,r as _}from"./index-LeZxK_z9.js";const h=y({});u(()=>h.value);function k(a){h.value=a}class V extends v{constructor(){super(...arguments);o(this,"player",{});o(this,"route",{});o(this,"playerState");o(this,"connectedDevices",[]);o(this,"currentVideoDeviceId",null);o(this,"currentList",null);o(this,"socket",null)}async initialize(e){this.player=e,this.socket=g()}use(){var e,i,t;this.player.on("ready",this.ready.bind(this)),this.player.on("dispose",this.handleDispose.bind(this)),this.route=f(),(e=this.socket)==null||e.on("VideoPlayerState",this.handleVideoPlayerState.bind(this)),(i=this.socket)==null||i.on("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),(t=this.socket)==null||t.on("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}dispose(){var e,i,t;this.player.off("ready",this.ready.bind(this)),this.player.off("dispose",this.handleDispose.bind(this)),(e=this.socket)==null||e.off("VideoPlayerState",this.handleVideoPlayerState.bind(this)),(i=this.socket)==null||i.off("ConnectedDevicesState",this.handleVideoConnectedDevicesState.bind(this)),(t=this.socket)==null||t.off("ChangeDevice",this.handleVideoBroadcastStatus.bind(this))}episodeData(){var d;const e=this.player.playlistItem();let i=(d=this.route)==null?void 0:d.path;i||(i=window.location.hash.replace("#","")),i||(i=location.pathname);const t=i==null?void 0:i.split("/");let s,l,r=(e==null?void 0:e.tmdb_id)??t.at(-2);return t.at(-3)==="specials"?s=t.at(-2):t.at(-3)==="collection"&&(l=t.at(-2),r=e.id??t.at(-2)),{video_id:e==null?void 0:e.video_id,tmdb_id:r,playlist_type:t.at(-3),special_id:s,collection_id:l,video_type:e==null?void 0:e.video_type,time:Math.floor(this.player.getCurrentTime()||0)}}ready(){var i,t;const e=this.episodeData();(i=this.socket)==null||i.invoke("StartPlaybackCommand",e==null?void 0:e.playlist_type,e==null?void 0:e.tmdb_id,e==null?void 0:e.tmdb_id),(t=this.socket)==null||t.invoke("Devices").then(this.handleVideoConnectedDevicesState.bind(this))}handleDispose(){var e;(e=this.socket)==null||e.invoke("PlaybackCommand","stop",null)}handleVideoBroadcastStatus(e){if(e)for(const i of e.events){const t=i.deviceBroadcastStatus;this.currentVideoDeviceId=t.device_id,t.device_id===m.value?this.player.setMute(!1):this.player.setMute(!0)}}handleVideoPlayerState(e){if(e)for(const i of e.events){if(i.type!=="PlayerStateChanged")continue;const t=i.event.state;this.playerState=t,k(t),console.log(t),t.current_list&&_.replace(t.current_list).then();const s=(Date.now()-t.timestamp)/1e3/2,l=t.progress_ms>=1?(t.progress_ms+s)/1e3:t.progress_ms/1e3;this.currentVideoDeviceId=t.device_id,this.player.setVolume(t.volume_percentage),this.player.setMute(t.muted_state),this.setPlayState(t),this.player.once("seeked",()=>{this.setPlayState(t)}),this.player.on("item",()=>{this.setPlayState(t)}),this.setSeek(l),this.player.on("playlist",()=>{this.player.once("item",()=>{this.setSeek(l)}),this.setItemFromIndex(t)}),this.player.getPlaylist().length===0||this.currentList!=t.current_list?(this.currentList=t.current_list,this.player.setPlaylist(t.playlist)):this.setItemFromIndex(t),setTimeout(()=>{this.changeAudioTrack(t),this.changeCaptionTrack(t),this.changeQualityLevel(t)},150),this.player.on("audioTracks",()=>{this.changeAudioTrack(t)}),this.player.on("captionsList",()=>{this.changeCaptionTrack(t)}),this.player.on("levels",()=>{this.changeQualityLevel(t)})}}setSeek(e){e!==0&&Math.abs(this.player.getCurrentTime()-e)>.75&&this.player.seek(e)}setItemFromIndex(e){const i=e.playlist.findIndex(t=>t.video_id===e.item.video_id);i!==this.player.getPlaylistIndex()&&this.player.playVideo(i)}setPlayState(e){e.is_playing?this.player.play().then():this.player.pause()}changeQualityLevel(e){var i;if(((i=e.current_quality)==null?void 0:i.width)!=null){const t=this.player.getQualityLevels().findIndex(s=>s.width===e.current_quality.width);t!=null&&this.player.setCurrentQuality(t)}else this.player.setCurrentQuality(-1)}changeCaptionTrack(e){var i;if(((i=e.current_caption)==null?void 0:i.language)!=null){const t=this.player.getCaptionsList().findIndex(s=>s.language===e.current_caption.language&&s.type===e.current_caption.type&&s.ext===e.current_caption.codec);t!=null&&this.player.setCurrentCaption(t-1)}else this.player.setCurrentCaption(-1)}changeAudioTrack(e){var i;if(((i=e.current_audio)==null?void 0:i.language)!=null){const t=this.player.getAudioTracks().findIndex(s=>{var l;return s.language===((l=e.current_audio)==null?void 0:l.language)});t!=null&&this.player.setCurrentAudioTrack(t)}else this.player.setCurrentAudioTrack(-1)}handleVideoConnectedDevicesState(e){this.connectedDevices=e}}export{V};
