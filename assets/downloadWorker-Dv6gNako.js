(function(){"use strict";var j=function(){function a(){this.listeners={}}var r=a.prototype;return r.on=function(t,n){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(n)},r.off=function(t,n){if(!this.listeners[t])return!1;var s=this.listeners[t].indexOf(n);return this.listeners[t]=this.listeners[t].slice(0),this.listeners[t].splice(s,1),s>-1},r.trigger=function(t){var n=this.listeners[t];if(n)if(arguments.length===2)for(var s=n.length,o=0;o<s;++o)n[o].call(this,arguments[1]);else for(var f=Array.prototype.slice.call(arguments,1),m=n.length,l=0;l<m;++l)n[l].apply(this,f)},r.dispose=function(){this.listeners={}},r.pipe=function(t){this.on("data",function(n){t.push(n)})},a}();function H(){return H=Object.assign?Object.assign.bind():function(a){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var t in e)({}).hasOwnProperty.call(e,t)&&(a[t]=e[t])}return a},H.apply(null,arguments)}var et=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ut(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var _,it;function ft(){if(it)return _;it=1;var a;return typeof window<"u"?a=window:typeof et<"u"?a=et:typeof self<"u"?a=self:a={},_=a,_}var dt=ft(),st=ut(dt),gt=function(r){return st.atob?st.atob(r):Buffer.from(r,"base64").toString("binary")};function ct(a){for(var r=gt(a),e=new Uint8Array(r.length),t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}/*! @name m3u8-parser @version 7.2.0 @license Apache-2.0 */class mt extends j{constructor(){super(),this.buffer=""}push(r){let e;for(this.buffer+=r,e=this.buffer.indexOf(`
`);e>-1;e=this.buffer.indexOf(`
`))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)}}const ht="	",Q=function(a){const r=/([0-9.]*)?@?([0-9.]*)?/.exec(a||""),e={};return r[1]&&(e.length=parseInt(r[1],10)),r[2]&&(e.offset=parseInt(r[2],10)),e},lt=function(){const e="(?:"+"[^=]*"+")=(?:"+'"[^"]*"|[^,]*'+")";return new RegExp("(?:^|,)("+e+")")},b=function(a){const r={};if(!a)return r;const e=a.split(lt());let t=e.length,n;for(;t--;)e[t]!==""&&(n=/([^=]*)=(.*)/.exec(e[t]).slice(1),n[0]=n[0].replace(/^\s+|\s+$/g,""),n[1]=n[1].replace(/^\s+|\s+$/g,""),n[1]=n[1].replace(/^['"](.*)['"]$/g,"$1"),r[n[0]]=n[1]);return r},at=a=>{const r=a.split("x"),e={};return r[0]&&(e.width=parseInt(r[0],10)),r[1]&&(e.height=parseInt(r[1],10)),e};class pt extends j{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(r){let e,t;if(r=r.trim(),r.length===0)return;if(r[0]!=="#"){this.trigger("data",{type:"uri",uri:r});return}this.tagMappers.reduce((s,o)=>{const f=o(r);return f===r?s:s.concat([f])},[r]).forEach(s=>{for(let o=0;o<this.customParsers.length;o++)if(this.customParsers[o].call(this,s))return;if(s.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:s.slice(1)});return}if(s=s.replace("\r",""),e=/^#EXTM3U/.exec(s),e){this.trigger("data",{type:"tag",tagType:"m3u"});return}if(e=/^#EXTINF:([0-9\.]*)?,?(.*)?$/.exec(s),e){t={type:"tag",tagType:"inf"},e[1]&&(t.duration=parseFloat(e[1])),e[2]&&(t.title=e[2]),this.trigger("data",t);return}if(e=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"targetduration"},e[1]&&(t.duration=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-VERSION:([0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"version"},e[1]&&(t.version=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA-SEQUENCE:(\-?[0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"media-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\-?[0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(s),e){t={type:"tag",tagType:"playlist-type"},e[1]&&(t.playlistType=e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-BYTERANGE:(.*)?$/.exec(s),e){t=H(Q(e[1]),{type:"tag",tagType:"byterange"}),this.trigger("data",t);return}if(e=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(s),e){t={type:"tag",tagType:"allow-cache"},e[1]&&(t.allowed=!/NO/.test(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-MAP:(.*)$/.exec(s),e){if(t={type:"tag",tagType:"map"},e[1]){const o=b(e[1]);o.URI&&(t.uri=o.URI),o.BYTERANGE&&(t.byterange=Q(o.BYTERANGE))}this.trigger("data",t);return}if(e=/^#EXT-X-STREAM-INF:(.*)$/.exec(s),e){t={type:"tag",tagType:"stream-inf"},e[1]&&(t.attributes=b(e[1]),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=at(t.attributes.RESOLUTION)),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),t.attributes["PROGRAM-ID"]&&(t.attributes["PROGRAM-ID"]=parseInt(t.attributes["PROGRAM-ID"],10))),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA:(.*)$/.exec(s),e){t={type:"tag",tagType:"media"},e[1]&&(t.attributes=b(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-ENDLIST/.exec(s),e){this.trigger("data",{type:"tag",tagType:"endlist"});return}if(e=/^#EXT-X-DISCONTINUITY/.exec(s),e){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}if(e=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(s),e){t={type:"tag",tagType:"program-date-time"},e[1]&&(t.dateTimeString=e[1],t.dateTimeObject=new Date(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-KEY:(.*)$/.exec(s),e){t={type:"tag",tagType:"key"},e[1]&&(t.attributes=b(e[1]),t.attributes.IV&&(t.attributes.IV.substring(0,2).toLowerCase()==="0x"&&(t.attributes.IV=t.attributes.IV.substring(2)),t.attributes.IV=t.attributes.IV.match(/.{8}/g),t.attributes.IV[0]=parseInt(t.attributes.IV[0],16),t.attributes.IV[1]=parseInt(t.attributes.IV[1],16),t.attributes.IV[2]=parseInt(t.attributes.IV[2],16),t.attributes.IV[3]=parseInt(t.attributes.IV[3],16),t.attributes.IV=new Uint32Array(t.attributes.IV))),this.trigger("data",t);return}if(e=/^#EXT-X-START:(.*)$/.exec(s),e){t={type:"tag",tagType:"start"},e[1]&&(t.attributes=b(e[1]),t.attributes["TIME-OFFSET"]=parseFloat(t.attributes["TIME-OFFSET"]),t.attributes.PRECISE=/YES/.test(t.attributes.PRECISE)),this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-out-cont"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT:(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-out"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-IN:?(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-in"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-SKIP:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"skip"},t.attributes=b(e[1]),t.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(t.attributes["SKIPPED-SEGMENTS"]=parseInt(t.attributes["SKIPPED-SEGMENTS"],10)),t.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(t.attributes["RECENTLY-REMOVED-DATERANGES"]=t.attributes["RECENTLY-REMOVED-DATERANGES"].split(ht)),this.trigger("data",t);return}if(e=/^#EXT-X-PART:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"part"},t.attributes=b(e[1]),["DURATION"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),["INDEPENDENT","GAP"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=/YES/.test(t.attributes[o]))}),t.attributes.hasOwnProperty("BYTERANGE")&&(t.attributes.byterange=Q(t.attributes.BYTERANGE)),this.trigger("data",t);return}if(e=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"server-control"},t.attributes=b(e[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=/YES/.test(t.attributes[o]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PART-INF:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"part-inf"},t.attributes=b(e[1]),["PART-TARGET"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"preload-hint"},t.attributes=b(e[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(o){if(t.attributes.hasOwnProperty(o)){t.attributes[o]=parseInt(t.attributes[o],10);const f=o==="BYTERANGE-LENGTH"?"length":"offset";t.attributes.byterange=t.attributes.byterange||{},t.attributes.byterange[f]=t.attributes[o],delete t.attributes[o]}}),this.trigger("data",t);return}if(e=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"rendition-report"},t.attributes=b(e[1]),["LAST-MSN","LAST-PART"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseInt(t.attributes[o],10))}),this.trigger("data",t);return}if(e=/^#EXT-X-DATERANGE:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"daterange"},t.attributes=b(e[1]),["ID","CLASS"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=String(t.attributes[f]))}),["START-DATE","END-DATE"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=new Date(t.attributes[f]))}),["DURATION","PLANNED-DURATION"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=parseFloat(t.attributes[f]))}),["END-ON-NEXT"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=/YES/i.test(t.attributes[f]))}),["SCTE35-CMD"," SCTE35-OUT","SCTE35-IN"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=t.attributes[f].toString(16))});const o=/^X-([A-Z]+-)+[A-Z]+$/;for(const f in t.attributes){if(!o.test(f))continue;const m=/[0-9A-Fa-f]{6}/g.test(t.attributes[f]),l=/^\d+(\.\d+)?$/.test(t.attributes[f]);t.attributes[f]=m?t.attributes[f].toString(16):l?parseFloat(t.attributes[f]):String(t.attributes[f])}this.trigger("data",t);return}if(e=/^#EXT-X-INDEPENDENT-SEGMENTS/.exec(s),e){this.trigger("data",{type:"tag",tagType:"independent-segments"});return}if(e=/^#EXT-X-I-FRAMES-ONLY/.exec(s),e){this.trigger("data",{type:"tag",tagType:"i-frames-only"});return}if(e=/^#EXT-X-CONTENT-STEERING:(.*)$/.exec(s),e){t={type:"tag",tagType:"content-steering"},t.attributes=b(e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-I-FRAME-STREAM-INF:(.*)$/.exec(s),e){t={type:"tag",tagType:"i-frame-playlist"},t.attributes=b(e[1]),t.attributes.URI&&(t.uri=t.attributes.URI),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=at(t.attributes.RESOLUTION)),t.attributes["AVERAGE-BANDWIDTH"]&&(t.attributes["AVERAGE-BANDWIDTH"]=parseInt(t.attributes["AVERAGE-BANDWIDTH"],10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),this.trigger("data",t);return}if(e=/^#EXT-X-DEFINE:(.*)$/.exec(s),e){t={type:"tag",tagType:"define"},t.attributes=b(e[1]),this.trigger("data",t);return}this.trigger("data",{type:"tag",data:s.slice(4)})})}addParser({expression:r,customType:e,dataParser:t,segment:n}){typeof t!="function"&&(t=s=>s),this.customParsers.push(s=>{if(r.exec(s))return this.trigger("data",{type:"custom",data:t(s),customType:e,segment:n}),!0})}addTagMapper({expression:r,map:e}){const t=n=>r.test(n)?e(n):n;this.tagMappers.push(t)}}const Et=a=>a.toLowerCase().replace(/-(\w)/g,r=>r[1].toUpperCase()),x=function(a){const r={};return Object.keys(a).forEach(function(e){r[Et(e)]=a[e]}),r},z=function(a){const{serverControl:r,targetDuration:e,partTargetDuration:t}=a;if(!r)return;const n="#EXT-X-SERVER-CONTROL",s="holdBack",o="partHoldBack",f=e&&e*3,m=t&&t*2;e&&!r.hasOwnProperty(s)&&(r[s]=f,this.trigger("info",{message:`${n} defaulting HOLD-BACK to targetDuration * 3 (${f}).`})),f&&r[s]<f&&(this.trigger("warn",{message:`${n} clamping HOLD-BACK (${r[s]}) to targetDuration * 3 (${f})`}),r[s]=f),t&&!r.hasOwnProperty(o)&&(r[o]=t*3,this.trigger("info",{message:`${n} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${r[o]}).`})),t&&r[o]<m&&(this.trigger("warn",{message:`${n} clamping PART-HOLD-BACK (${r[o]}) to partTargetDuration * 2 (${m}).`}),r[o]=m)};class J extends j{constructor(r={}){super(),this.lineStream=new mt,this.parseStream=new pt,this.lineStream.pipe(this.parseStream),this.mainDefinitions=r.mainDefinitions||{},this.params=new URL(r.uri,"https://a.com").searchParams,this.lastProgramDateTime=null;const e=this,t=[];let n={},s,o,f=!1;const m=function(){},l={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},V="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";let C=0;this.manifest={allowCache:!0,discontinuityStarts:[],dateRanges:[],iFramePlaylists:[],segments:[]};let K=0,B=0;const y={};this.on("end",()=>{n.uri||!n.parts&&!n.preloadHints||(!n.map&&s&&(n.map=s),!n.key&&o&&(n.key=o),!n.timeline&&typeof C=="number"&&(n.timeline=C),this.manifest.preloadSegment=n)}),this.parseStream.on("data",function(i){let g,c;if(e.manifest.definitions){for(const d in e.manifest.definitions)if(i.uri&&(i.uri=i.uri.replace(`{$${d}}`,e.manifest.definitions[d])),i.attributes)for(const u in i.attributes)typeof i.attributes[u]=="string"&&(i.attributes[u]=i.attributes[u].replace(`{$${d}}`,e.manifest.definitions[d]))}({tag(){({version(){i.version&&(this.manifest.version=i.version)},"allow-cache"(){this.manifest.allowCache=i.allowed,"allowed"in i||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){const d={};"length"in i&&(n.byterange=d,d.length=i.length,"offset"in i||(i.offset=K)),"offset"in i&&(n.byterange=d,d.offset=i.offset),K=d.offset+d.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),i.title&&(n.title=i.title),i.duration>0&&(n.duration=i.duration),i.duration===0&&(n.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=t},key(){if(!i.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(i.attributes.METHOD==="NONE"){o=null;return}if(!i.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(i.attributes.KEYFORMAT==="com.apple.streamingkeydelivery"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:i.attributes};return}if(i.attributes.KEYFORMAT==="com.microsoft.playready"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.microsoft.playready"]={uri:i.attributes.URI};return}if(i.attributes.KEYFORMAT===V){if(["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(i.attributes.METHOD)===-1){this.trigger("warn",{message:"invalid key method provided for Widevine"});return}if(i.attributes.METHOD==="SAMPLE-AES-CENC"&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),i.attributes.URI.substring(0,23)!=="data:text/plain;base64,"){this.trigger("warn",{message:"invalid key URI provided for Widevine"});return}if(!(i.attributes.KEYID&&i.attributes.KEYID.substring(0,2)==="0x")){this.trigger("warn",{message:"invalid key ID provided for Widevine"});return}this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:i.attributes.KEYFORMAT,keyId:i.attributes.KEYID.substring(2)},pssh:ct(i.attributes.URI.split(",")[1])};return}i.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),o={method:i.attributes.METHOD||"AES-128",uri:i.attributes.URI},typeof i.attributes.IV<"u"&&(o.iv=i.attributes.IV)},"media-sequence"(){if(!isFinite(i.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+i.number});return}this.manifest.mediaSequence=i.number},"discontinuity-sequence"(){if(!isFinite(i.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+i.number});return}this.manifest.discontinuitySequence=i.number,C=i.number},"playlist-type"(){if(!/VOD|EVENT/.test(i.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+i.playlist});return}this.manifest.playlistType=i.playlistType},map(){s={},i.uri&&(s.uri=i.uri),i.byterange&&(s.byterange=i.byterange),o&&(s.key=o)},"stream-inf"(){if(this.manifest.playlists=t,this.manifest.mediaGroups=this.manifest.mediaGroups||l,!i.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}n.attributes||(n.attributes={}),H(n.attributes,i.attributes)},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||l,!(i.attributes&&i.attributes.TYPE&&i.attributes["GROUP-ID"]&&i.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}const d=this.manifest.mediaGroups[i.attributes.TYPE];d[i.attributes["GROUP-ID"]]=d[i.attributes["GROUP-ID"]]||{},g=d[i.attributes["GROUP-ID"]],c={default:/yes/i.test(i.attributes.DEFAULT)},c.default?c.autoselect=!0:c.autoselect=/yes/i.test(i.attributes.AUTOSELECT),i.attributes.LANGUAGE&&(c.language=i.attributes.LANGUAGE),i.attributes.URI&&(c.uri=i.attributes.URI),i.attributes["INSTREAM-ID"]&&(c.instreamId=i.attributes["INSTREAM-ID"]),i.attributes.CHARACTERISTICS&&(c.characteristics=i.attributes.CHARACTERISTICS),i.attributes.FORCED&&(c.forced=/yes/i.test(i.attributes.FORCED)),g[i.attributes.NAME]=c},discontinuity(){C+=1,n.discontinuity=!0,this.manifest.discontinuityStarts.push(t.length)},"program-date-time"(){typeof this.manifest.dateTimeString>"u"&&(this.manifest.dateTimeString=i.dateTimeString,this.manifest.dateTimeObject=i.dateTimeObject),n.dateTimeString=i.dateTimeString,n.dateTimeObject=i.dateTimeObject;const{lastProgramDateTime:d}=this;this.lastProgramDateTime=new Date(i.dateTimeString).getTime(),d===null&&this.manifest.segments.reduceRight((u,h)=>(h.programDateTime=u-h.duration*1e3,h.programDateTime),this.lastProgramDateTime)},targetduration(){if(!isFinite(i.duration)||i.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+i.duration});return}this.manifest.targetDuration=i.duration,z.call(this,this.manifest)},start(){if(!i.attributes||isNaN(i.attributes["TIME-OFFSET"])){this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});return}this.manifest.start={timeOffset:i.attributes["TIME-OFFSET"],precise:i.attributes.PRECISE}},"cue-out"(){n.cueOut=i.data},"cue-out-cont"(){n.cueOutCont=i.data},"cue-in"(){n.cueIn=i.data},skip(){this.manifest.skip=x(i.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",i.attributes,["SKIPPED-SEGMENTS"])},part(){f=!0;const d=this.manifest.segments.length,u=x(i.attributes);n.parts=n.parts||[],n.parts.push(u),u.byterange&&(u.byterange.hasOwnProperty("offset")||(u.byterange.offset=B),B=u.byterange.offset+u.byterange.length);const h=n.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${h} for segment #${d}`,i.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((T,p)=>{T.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${p} lacks required attribute(s): LAST-PART`})})},"server-control"(){const d=this.manifest.serverControl=x(i.attributes);d.hasOwnProperty("canBlockReload")||(d.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),z.call(this,this.manifest),d.canSkipDateranges&&!d.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){const d=this.manifest.segments.length,u=x(i.attributes),h=u.type&&u.type==="PART";n.preloadHints=n.preloadHints||[],n.preloadHints.push(u),u.byterange&&(u.byterange.hasOwnProperty("offset")||(u.byterange.offset=h?B:0,h&&(B=u.byterange.offset+u.byterange.length)));const T=n.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${T} for segment #${d}`,i.attributes,["TYPE","URI"]),!!u.type)for(let p=0;p<n.preloadHints.length-1;p++){const R=n.preloadHints[p];R.type&&R.type===u.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${T} for segment #${d} has the same TYPE ${u.type} as preload hint #${p}`})}},"rendition-report"(){const d=x(i.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(d);const u=this.manifest.renditionReports.length-1,h=["LAST-MSN","URI"];f&&h.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${u}`,i.attributes,h)},"part-inf"(){this.manifest.partInf=x(i.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",i.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),z.call(this,this.manifest)},daterange(){this.manifest.dateRanges.push(x(i.attributes));const d=this.manifest.dateRanges.length-1;this.warnOnMissingAttributes_(`#EXT-X-DATERANGE #${d}`,i.attributes,["ID","START-DATE"]);const u=this.manifest.dateRanges[d];u.endDate&&u.startDate&&new Date(u.endDate)<new Date(u.startDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE END-DATE must be equal to or later than the value of the START-DATE"}),u.duration&&u.duration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE DURATION must not be negative"}),u.plannedDuration&&u.plannedDuration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE PLANNED-DURATION must not be negative"});const h=!!u.endOnNext;if(h&&!u.class&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must have a CLASS attribute"}),h&&(u.duration||u.endDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must not contain DURATION or END-DATE attributes"}),u.duration&&u.endDate){const p=u.startDate.getTime()+u.duration*1e3;this.manifest.dateRanges[d].endDate=new Date(p)}if(!y[u.id])y[u.id]=u;else{for(const p in y[u.id])if(u[p]&&JSON.stringify(y[u.id][p])!==JSON.stringify(u[p])){this.trigger("warn",{message:"EXT-X-DATERANGE tags with the same ID in a playlist must have the same attributes values"});break}const T=this.manifest.dateRanges.findIndex(p=>p.id===u.id);this.manifest.dateRanges[T]=H(this.manifest.dateRanges[T],u),y[u.id]=H(y[u.id],u),this.manifest.dateRanges.pop()}},"independent-segments"(){this.manifest.independentSegments=!0},"i-frames-only"(){this.manifest.iFramesOnly=!0,this.requiredCompatibilityversion(this.manifest.version,4)},"content-steering"(){this.manifest.contentSteering=x(i.attributes),this.warnOnMissingAttributes_("#EXT-X-CONTENT-STEERING",i.attributes,["SERVER-URI"])},define(){this.manifest.definitions=this.manifest.definitions||{};const d=(u,h)=>{if(u in this.manifest.definitions){this.trigger("error",{message:`EXT-X-DEFINE: Duplicate name ${u}`});return}this.manifest.definitions[u]=h};if("QUERYPARAM"in i.attributes){if("NAME"in i.attributes||"IMPORT"in i.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}const u=this.params.get(i.attributes.QUERYPARAM);if(!u){this.trigger("error",{message:`EXT-X-DEFINE: No query param ${i.attributes.QUERYPARAM}`});return}d(i.attributes.QUERYPARAM,decodeURIComponent(u));return}if("NAME"in i.attributes){if("IMPORT"in i.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}if(!("VALUE"in i.attributes)||typeof i.attributes.VALUE!="string"){this.trigger("error",{message:`EXT-X-DEFINE: No value for ${i.attributes.NAME}`});return}d(i.attributes.NAME,i.attributes.VALUE);return}if("IMPORT"in i.attributes){if(!this.mainDefinitions[i.attributes.IMPORT]){this.trigger("error",{message:`EXT-X-DEFINE: No value ${i.attributes.IMPORT} to import, or IMPORT used on main playlist`});return}d(i.attributes.IMPORT,this.mainDefinitions[i.attributes.IMPORT]);return}this.trigger("error",{message:"EXT-X-DEFINE: No attribute"})},"i-frame-playlist"(){this.manifest.iFramePlaylists.push({attributes:i.attributes,uri:i.uri,timeline:C}),this.warnOnMissingAttributes_("#EXT-X-I-FRAME-STREAM-INF",i.attributes,["BANDWIDTH","URI"])}}[i.tagType]||m).call(e)},uri(){n.uri=i.uri,t.push(n),this.manifest.targetDuration&&!("duration"in n)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),n.duration=this.manifest.targetDuration),o&&(n.key=o),n.timeline=C,s&&(n.map=s),B=0,this.lastProgramDateTime!==null&&(n.programDateTime=this.lastProgramDateTime,this.lastProgramDateTime+=n.duration*1e3),n={}},comment(){},custom(){i.segment?(n.custom=n.custom||{},n.custom[i.customType]=i.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[i.customType]=i.data)}})[i.type].call(e)})}requiredCompatibilityversion(r,e){(r<e||!r)&&this.trigger("warn",{message:`manifest must be at least version ${e}`})}warnOnMissingAttributes_(r,e,t){const n=[];t.forEach(function(s){e.hasOwnProperty(s)||n.push(s)}),n.length&&this.trigger("warn",{message:`${r} lacks required attribute(s): ${n.join(", ")}`})}push(r){this.lineStream.push(r)}end(){this.lineStream.push(`
`),this.manifest.dateRanges.length&&this.lastProgramDateTime===null&&this.trigger("warn",{message:"A playlist with EXT-X-DATERANGE tag must contain atleast one EXT-X-PROGRAM-DATE-TIME tag"}),this.lastProgramDateTime=null,this.trigger("end")}addParser(r){this.parseStream.addParser(r)}addTagMapper(r){this.parseStream.addTagMapper(r)}}let w=!1;const O=new Set;let E=null,rt=[];async function M(a,r,e){const t=a.startsWith("http")?a:`${r}${a}`,n=await fetch(t,{headers:{Authorization:`Bearer ${e}`}});if(!n.ok)throw new Error(`Failed to fetch ${a}: ${n.statusText}`);return n}async function N(a){return new Promise((r,e)=>{w||a&&O.has(a)?e(new Error("paused")):r()})}function D(a,r){self.postMessage({type:"status",itemId:a,status:r})}const Y=new Map,Z=new Map;function F(a,r){return`${a}:${r}`}async function nt(a,r,e,t){let n=0;for(const s of r){const o=s.path.substring(0,s.path.lastIndexOf("/"));for(const f of s.segments){const m=f.uri.startsWith("http")?f.uri:`${o}/${f.uri}`,l=F(a,m);await(E==null?void 0:E.match(l))&&(t.add(l),n++)}}return n}async function Tt(a,r,e){var m,l,V,C,K,B,y,i;if(E||(E=await caches.open("offline-content-v1")),await N(a.mediaId),w||O.has(a.mediaId))return!1;const t=new Map;Y.has(a.mediaId)||Y.set(a.mediaId,new Set);const n=Y.get(a.mediaId);Z.has(a.mediaId)||Z.set(a.mediaId,new Set);const s=Z.get(a.mediaId),o=(g,c,d=0)=>{if(!t.has(g)){const u={type:g,total:c,completed:d};t.set(g,u);const h=v();self.postMessage({type:"progress",progress:h.progress,currentItem:h.completedItems,totalItems:h.totalItems,itemProgress:Math.round(d/c*100),assetType:g,assetProgress:Math.round(d/c*100),itemId:a.mediaId,status:"downloading"}),d===c&&g!=="video"&&g!=="audio"&&n.add(g)}},f=g=>{const c=t.get(g);if(c){c.completed++;const d=Math.round(c.completed/c.total*100);d===100&&g!=="video"&&g!=="audio"&&n.add(g);const h=d===100&&!(g==="video"||g==="audio"),T=v();self.postMessage({type:"progress",progress:T.progress,currentItem:T.completedItems,totalItems:T.totalItems,itemProgress:d,assetType:g,assetProgress:d,itemId:a.mediaId,status:h?"completed":"downloading"})}};try{if(await N(a.mediaId),a.mediaPath.includes(".m3u8")){const c=await(await M(a.mediaPath,r,e)).text(),d=new J;d.push(c),d.end();const u=d.manifest,h=a.mediaPath.substring(0,a.mediaPath.lastIndexOf("/"));let T=0;const p=[];if((m=u.playlists)!=null&&m.length)for(const R of u.playlists){const P=R.uri.startsWith("http")?R.uri:`${h}/${R.uri}`,I=await(await M(P,r,e)).text(),A=new J;A.push(I),A.end(),(l=A.manifest.segments)!=null&&l.length&&(T+=A.manifest.segments.length,p.push({path:P,segments:A.manifest.segments}))}else(V=u.segments)!=null&&V.length&&(T=u.segments.length,p.push({path:a.mediaPath,segments:u.segments}));if(T>0){const R=await nt(a.mediaId,p,"video",s);o("video",T,R);for(const P of p){const $=P.path.substring(0,P.path.lastIndexOf("/"));for(const I of P.segments){await N(a.mediaId);const A=I.uri.startsWith("http")?I.uri:`${$}/${I.uri}`,X=F(a.mediaId,A);if(s.has(X))continue;if(await E.match(X)){s.add(X);continue}await N(a.mediaId);const S=await M(A,r,e).then(tt=>tt.blob()),ot=new Response(S.slice(0));await E.put(X,ot),s.add(X),f("video")}}}if((C=u.mediaGroups)!=null&&C.AUDIO){let R=0;const P=[];for(const $ of Object.values(u.mediaGroups.AUDIO))for(const I of Object.values($)){if(!I.uri)continue;const A=I.uri.startsWith("http")?I.uri:`${h}/${I.uri}`,L=await(await M(A,r,e)).text(),S=new J;S.push(L),S.end(),(K=S.manifest.segments)!=null&&K.length&&(R+=S.manifest.segments.length,P.push({path:A,segments:S.manifest.segments}))}if(R>0){const $=await nt(a.mediaId,P,"audio",s);o("audio",R,$);for(const I of P){const A=I.path.substring(0,I.path.lastIndexOf("/"));for(const X of I.segments){await N(a.mediaId);const L=X.uri.startsWith("http")?X.uri:`${A}/${X.uri}`,S=F(a.mediaId,L);if(s.has(S))continue;if(await E.match(S)){s.add(S);continue}await N(a.mediaId);const tt=await M(L,r,e).then(It=>It.blob()),bt=new Response(tt.slice(0));await E.put(S,bt),s.add(S),f("audio")}}}}}else{const g=F(a.mediaId,a.mediaPath);if(await E.match(g))n.add("video"),self.postMessage({type:"progress",progress:v().progress,currentItem:v().completedItems,totalItems:v().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:a.mediaId,status:"downloading"});else{const d=`${r}${a.mediaPath}`,u=await fetch(d,{headers:{Authorization:`Bearer ${e}`}});if(!u.ok)throw new Error(`Failed to download video: ${u.statusText}`);await E.put(g,u.clone()),n.add("video"),self.postMessage({type:"progress",progress:v().progress,currentItem:v().completedItems,totalItems:v().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:a.mediaId,status:"downloading"})}}if((B=a.subtitlePaths)!=null&&B.length){o("subtitle",a.subtitlePaths.length);for(const g of a.subtitlePaths){const c=F(a.mediaId,g);if(!await E.match(c)){await N(a.mediaId);const u=await M(g,r,e);await E.put(c,u.clone())}f("subtitle")}}if((y=a.previewPaths)!=null&&y.length){o("preview",a.previewPaths.length);for(const g of a.previewPaths){const c=F(a.mediaId,g);if(!await E.match(c)){await N(a.mediaId);const u=await M(g,r,e);await E.put(c,u.clone())}f("preview")}}if((i=a.fontPaths)!=null&&i.length){let g=0;const c=[];for(const d of a.fontPaths){const h=await(await M(d,r,e)).json();g+=h.length,c.push({path:d,fonts:h})}o("font",g);for(const{path:d,fonts:u}of c){const h=F(a.mediaId,d);if(await E.match(h))u.forEach(()=>f("font"));else{await N(a.mediaId);const p=d.substring(0,d.lastIndexOf("/")+1);for(const R of u){await N(a.mediaId);const P=`${p}fonts/${R.file}`,$=F(a.mediaId,P);if(await E.match($))f("font");else{const A=await M(P,r,e);await E.put($,A.clone()),f("font")}}await E.put(h,new Response(JSON.stringify(u)))}}}}catch(g){if((g==null?void 0:g.message)==="paused")return!1;throw g}}let U=[],q="",W="";async function k(a,r,e){let t=0;for(;t<a.length;){const s=a[t];D(s.mediaId,"downloading"),a.slice(t+1).forEach(o=>{!G.get(o.mediaId)&&!O.has(o.mediaId)&&D(o.mediaId,"waiting")});try{if(w){D(s.mediaId,"paused");return}if(O.has(s.mediaId)){D(s.mediaId,"paused"),t++;continue}if(rt=[{taskIndex:U.indexOf(s),promise:Tt(s,r,e)}],D(s.mediaId,"downloading"),await rt[0].promise===!1){if(D(s.mediaId,"paused"),w)return;t++}else D(s.mediaId,"completed"),t++}catch(o){if((o==null?void 0:o.message)==="paused"){if(D(s.mediaId,"paused"),w)return;t++}else throw D(s.mediaId,"error"),o}}if(a.filter(s=>O.has(s.mediaId)).length===0){const s=v();self.postMessage({type:"complete",progress:s.progress,currentItem:s.completedItems,totalItems:s.totalItems})}}const G=new Map;function v(){const a=Array.from(G.values()).filter(e=>e).length;let r=0;return U.forEach(e=>{var t,n,s;if(G.get(e.mediaId))r+=100;else if(Y.has(e.mediaId)){const o=new Set(["video"]);(t=e.subtitlePaths)!=null&&t.length&&o.add("subtitle"),(n=e.fontPaths)!=null&&n.length&&o.add("font"),(s=e.previewPaths)!=null&&s.length&&o.add("preview");const f=Y.get(e.mediaId),m=Array.from(o).filter(l=>f.has(l)).length;r+=m/o.size*100}}),{progress:Math.round(r/U.length),completedItems:a,totalItems:U.length}}self.onmessage=async a=>{const{tasks:r,controls:e}=a.data;if(r&&(U=r,q=a.data.baseUrl,W=a.data.token,G.clear(),O.clear()),e){const{type:n,itemId:s}=e;switch(n){case"pause":w=!0,U.forEach(m=>{G.get(m.mediaId)||(O.add(m.mediaId),self.postMessage({type:"status",itemId:m.mediaId,status:"paused"}))});break;case"resume":w=!1,O.clear();const o=e.pausedIds||[],f=U.filter(m=>!G.get(m.mediaId)&&o.includes(m.mediaId));if(f.length){f.forEach(m=>{D(m.mediaId,"pending")});try{await k(f,q,W)}catch(m){console.error("Failed to resume queue:",m)}}break;case"pauseItem":s&&(O.add(s),D(s,"paused"));break;case"resumeItem":if(s){O.delete(s),D(s,"pending");const m=U.find(l=>l.mediaId===s);if(m&&!G.get(m.mediaId))try{const l=w;w=!1,await k([m],q,W),w=l}catch(l){console.error("Failed to resume item:",l),D(s,"error")}}break}return}const t=r.filter(n=>!G.get(n.mediaId));await k(t,q,W)}})();
//# sourceMappingURL=downloadWorker-Dv6gNako.js.map
