import{l as b,O as J,R as F,ag as Q,ad as X,I as Z,f as ee,d as se,o as g,s as R,j as O,K as i,bu as te,a as o,c as w,b as B,t as h,A as q,F as K,h as Y,q as ae,dD as oe,n as ne,bh as le}from"./index-BlsCkKvU.js";import{_ as ie}from"./DashboardLayout.vue_vue_type_script_setup_true_lang-flUV20CT.js";import"./useMounted-saEqA_9z.js";import"./useServerClient-6Bqhc4IC.js";import"./useQuery-f3S0rg_a.js";import"./useBaseQuery-z80KnmTz.js";import"./useQueryClient-DkDUGw6x.js";import"./useInfiniteServerClient-BSu1htWg.js";import"./HubConnection-CMQnVIkW.js";import"./FloatingBackButton.vue_vue_type_script_setup_true_lang-BgnfoS3j.js";import"./OptimizedIcon.vue_vue_type_script_setup_true_lang-CcyaU_rN.js";import"./Button.vue_vue_type_script_setup_true_lang-C_oWPest.js";import"./ScrollContainer.vue_vue_type_script_setup_true_lang-xwr-mDAl.js";import"./RipperOverlay.vue_vue_type_script_setup_true_lang-BPZ8n35z.js";import"./ripperSocket-D2R3KSkq.js";function re(){const E=b(!1),x=b(0),I=b(0),C=b(0),D=b(0),l=b([]),m=b(!1);let f=null;function A(){I.value=l.value.filter(a=>a.status==="completed").length}function S(){m.value||(f?.postMessage({controls:{type:"pause"}}),l.value.forEach(a=>{a.status!=="completed"&&(a.status="paused",a.children.forEach(t=>{t.status!=="completed"&&(t.status="paused")}))}),m.value=!0)}function U(){if(m.value){const a=l.value.filter(t=>t.status==="paused");a.length>0&&(a[0].status="pending",a[0].children.forEach(t=>{t.status==="paused"&&(t.status="pending")}),a.slice(1).forEach(t=>{t.status="waiting",t.children.forEach(s=>{s.status==="paused"&&(s.status="waiting")})}),f?.postMessage({controls:{type:"resume",pausedIds:a.map(t=>t.id)}})),m.value=!1}}function V(a){const t=l.value.find(s=>s.id===a);t&&(t.status==="downloading"||t.status==="pending"||t.status==="waiting")&&(f?.postMessage({controls:{type:"pauseItem",itemId:a}}),t.status="paused",t.children.forEach(n=>{(n.status==="downloading"||n.status==="pending"||n.status==="waiting")&&(n.status="paused")}),l.value.every(n=>n.status==="completed"||n.status==="paused")&&(m.value=!0))}function $(a){const t=l.value.find(s=>s.id===a);t&&t.status==="paused"&&(f?.postMessage({controls:{type:"resumeItem",itemId:a}}),l.value.find(c=>c.status==="downloading"||c.status==="pending")?(t.status="waiting",t.children.forEach(c=>{c.status==="paused"&&(c.status="waiting")})):(t.status="pending",t.children.forEach(c=>{c.status==="paused"&&(c.status="pending")})),l.value.some(c=>c.status==="downloading"||c.status==="pending")&&(m.value=!1))}function N(a){f?.postMessage({controls:{action:"prioritize",itemId:a}})}async function L(a,t){E.value=!0;try{const{data:s}=await J().get(`/${t}/watch`),n=s.filter(e=>!!e?.file).map(e=>e.video_id),c=l.value.map(e=>e.id),j=n.some(e=>!c.includes(e))||c.some(e=>!n.includes(e));j?(x.value=0,I.value=0,l.value=[]):l.value=l.value.filter(e=>e.status==="completed"),l.value=await Promise.all(s.filter(e=>!!e?.file).map(async(e,y)=>{const r=e.tracks?.some(d=>d.kind==="subtitles"&&d.file),v=e.tracks?.some(d=>d.kind==="fonts"&&d.file),u=e.tracks?.some(d=>["thumbnails","sprite"].includes(d.kind)&&d.file);let T=!1;if(e.file.endsWith(".m3u8"))try{T=(await(await fetch(`${F.value?.serverBaseUrl}${e.file}`,{headers:{Authorization:`Bearer ${Q.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(d){console.warn("Failed to check master playlist for audio:",d)}const _=[{type:"video",name:"Video",progress:0,status:"pending"}];return T&&_.push({type:"audio",name:"Audio",progress:0,status:"pending"}),r&&_.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),u&&_.push({type:"preview",name:"Preview",progress:0,status:"pending"}),v&&_.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:e.video_id,title:`${e.show}${e.season?` S${X(e.season,2)}`:""}${e.episode?`E${X(e.episode,2)}`:""} - ${e.title}`,image:e.image,progress:0,status:y===0?"pending":"waiting",children:_.map(d=>({...d,status:y===0?"pending":"waiting"}))}}));const M=s.filter(e=>!!e?.file).map(e=>{const y=e.tracks?.filter(u=>u.kind==="subtitles"&&u.file)?.map(u=>u.file),r=e.tracks?.filter(u=>u.kind==="fonts"&&u.file)?.map(u=>u.file),v=e.tracks?.filter(u=>["thumbnails","sprite"].includes(u.kind)&&u.file)?.map(u=>u.file);return{mediaId:e.video_id,mediaType:"video",mediaPath:e.file,baseUrl:F.value?.serverBaseUrl||"",token:Q.value?.accessToken||"",...y?.length?{subtitlePaths:y}:{},...r?.length?{fontPaths:r}:{},...v?.length?{previewPaths:v}:{}}});if(!M.length)throw new Error("No valid files to download");return C.value=M.length,console.log("Starting download with tasks:",M),await new Promise((e,y)=>{f=new Worker(new URL("/assets/downloadWorker-DkRajECb.js",import.meta.url),{type:"module"}),f.onerror=r=>{console.error("Worker error:",r),y(r)},f.onmessage=r=>{if(console.log("Worker message:",r.data),r.data.type==="error"&&r.data.error==="paused")return;const{type:v,progress:u,itemProgress:T,assetType:_,assetProgress:d,itemId:W,status:z,isNewQuery:G}=r.data;if(v==="progress"){if((j||!G)&&(x.value=Math.min(u,100)),D.value=T,W){const p=l.value.find(k=>k.id===W);if(p){if(_){const P=p.children.find(H=>H.type===_);P&&(P.progress=Math.min(d,100),P.status=P.progress===100?"completed":z)}const k=p.children.filter(P=>P.progress===100).length;p.progress=Math.round(k/p.children.length*100),p.progress===100?(p.status="completed",A()):z&&(p.status=z)}}}else if(v==="complete")A(),e(!0);else if(v==="error")r.data.error==="paused"?e(!1):y(r.data.error);else if(v==="status"){const p=l.value.find(k=>k.id===r.data.itemId);p&&p.status!=="completed"&&p.status!==r.data.status&&(p.status=r.data.status,p.children.forEach(k=>{k.status!=="completed"&&(k.status=r.data.status)}))}},f.postMessage({tasks:M,baseUrl:F.value?.serverBaseUrl,token:Q.value?.accessToken,isNewQuery:j})}),!0}catch(s){return s==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",s),!1)}finally{m.value||(f?.terminate(),E.value=!1)}}return{isDownloading:E,progress:x,totalItems:C,completedItems:I,itemProgress:D,downloadQueue:l,isPaused:m,downloadPlaylist:L,pauseDownloads:S,resumeDownloads:U,pauseItem:V,resumeItem:$,prioritizeItem:N}}const ue={class:"flex flex-col gap-2 p-4 overflow-clip col-span-12"},de={class:"flex gap-4 max-h-[80vh] overflow-clip"},ce={class:"w-2/5"},pe=["disabled"],fe={key:0,class:"mt-2 text-xs"},me={class:"flex justify-between items-center mb-1"},ge={class:"w-full bg-neutral-700 rounded h-1.5 mt-1"},ve={key:0,class:"flex-1 overflow-y-auto available"},we={class:"grid gap-2"},he={class:"flex justify-between items-center"},ye={class:"text-sm font-medium truncate flex items-center gap-2"},_e={key:0,class:"text-2xs text-neutral-400"},ke={key:1,class:"text-2xs text-neutral-400"},be=["onClick"],xe={class:"flex gap-2"},Ie={class:"w-1/4 flex flex-col gap-2"},Pe=["src"],De={class:"flex-1 min-w-0"},$e={class:"grid grid-cols-1 gap-x-4 gap-y-0.5"},Ee={class:"flex justify-between leading-0"},Ce={class:"w-full bg-neutral-700 rounded h-1"},Le=Z({__name:"Desktop",setup(E){const{isDownloading:x,progress:I,totalItems:C,completedItems:D,downloadQueue:l,isPaused:m,downloadPlaylist:f,pauseDownloads:A,resumeDownloads:S,pauseItem:U,resumeItem:V}=re(),$=b("tv/138357");async function N(){await f("video",$.value)}return(L,a)=>{const t=ee("InputText");return g(),se(i(le),null,{default:R(()=>[O(i(te),{fullscreen:!0},{default:R(()=>[O(ie,{"grid-style":3,title:"Profile"},{default:R(()=>[o("div",ue,[a[2]||(a[2]=o("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),o("div",de,[o("div",ce,[O(t,{modelValue:$.value,"onUpdate:modelValue":a[0]||(a[0]=s=>$.value=s),class:"w-full text-sm"},null,8,["modelValue"]),o("button",{disabled:i(x),class:"bg-primary p-1.5 rounded disabled:opacity-50 mt-2 w-full text-sm",onClick:N},h(i(x)?"Downloading...":"Download Show"),9,pe),i(x)||i(D)?(g(),w("div",fe,[o("div",me,[o("span",null,"Progress: "+h(i(I))+"% ("+h(i(D))+"/"+h(i(C))+")",1),o("button",{class:"text-xs px-2 py-0.5 rounded bg-neutral-800",onClick:a[1]||(a[1]=s=>i(m)?i(S)():i(A)())},h(i(m)?"Resume All":"Pause All"),1)]),o("div",ge,[o("div",{class:"bg-primary h-full rounded",style:q(`width: ${i(I)}%`)},null,4)])])):B("",!0)]),i(l).length?(g(),w("div",ve,[o("div",we,[(g(!0),w(K,null,Y(i(l),s=>(g(),w("div",{key:s.id,class:"bg-neutral-900/50 rounded p-4 flex flex-col gap-2"},[o("div",he,[o("div",ye,[ae(h(s.title)+" ",1),s.status==="downloading"?(g(),w("span",_e,"(Downloading...)")):s.status==="waiting"?(g(),w("span",ke,"(Waiting...)")):B("",!0)]),s.status!=="completed"?(g(),w("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-neutral-800",onClick:n=>s.status==="downloading"||s.status==="pending"||s.status==="waiting"?i(U)(s.id):i(V)(s.id)},h(s.status==="downloading"||s.status==="pending"||s.status==="waiting"?"Pause":"Resume"),9,be)):B("",!0)]),o("div",xe,[o("div",Ie,[o("img",{alt:"Item Image",src:`${i(oe)}${s.image}`,class:"w-full h-auto aspect-video object-fit my-auto rounded"},null,8,Pe)]),o("div",De,[o("div",$e,[(g(!0),w(K,null,Y(s.children,n=>(g(),w("div",{key:n.type,class:"text-2xs"},[o("div",Ee,[o("span",null,h(n.name),1),o("span",null,h(n.progress)+"%",1)]),o("div",Ce,[o("div",{class:ne([{"bg-blue-500":n.type==="video","bg-green-500":n.type==="audio","bg-yellow-500":n.type==="subtitle","bg-purple-500":n.type==="preview","bg-pink-500":n.type==="font"},"h-full rounded"]),style:q(`width: ${n.progress}%`)},null,6)])]))),128))])])])]))),128))])])):B("",!0)])])]),_:1})]),_:1})]),_:1})}}});export{Le as default};
