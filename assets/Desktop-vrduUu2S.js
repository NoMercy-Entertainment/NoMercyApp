import"./useInfiniteServerClient-ChzPawtk.js";import{$o as se,As as Q,Cl as h,Dl as W,El as te,Hl as m,Js as ae,Kl as le,Sl as S,Wi as Y,Wl as J,aa as oe,bl as r,ec as ne,es as z,gu as re,hl as K,hu as n,kl as q,ll as R,ml as ie,su as x,tu as F,vu as G,xl as H,yu as y}from"./index-Rmty3EhQ.js";import"./useServerClient-CbixTTZm.js";import"./ScrollContainer-D9yWZpjD.js";import"./useMounted-DUlgn5dG.js";import"./RipperOverlay-Di0OgBTb.js";import"./ripperSocket-CM7We1k2.js";import"./FloatingBackButton-EzlyyCkz.js";import{t as ue}from"./DashboardLayout-DPr-WzPB.js";R();function de(){const $=x(!1),g=x(0),v=x(0),a=x(0),_=x(0),o=x([]),c=x(!1);let f=null;function E(){v.value=o.value.filter(l=>l.status==="completed").length}function T(){c.value||(f?.postMessage({controls:{type:"pause"}}),o.value.forEach(l=>{l.status!=="completed"&&(l.status="paused",l.children.forEach(t=>{t.status!=="completed"&&(t.status="paused")}))}),c.value=!0)}function B(){if(c.value){const l=o.value.filter(t=>t.status==="paused");l.length>0&&(l[0].status="pending",l[0].children.forEach(t=>{t.status==="paused"&&(t.status="pending")}),l.slice(1).forEach(t=>{t.status="waiting",t.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})}),f?.postMessage({controls:{type:"resume",pausedIds:l.map(t=>t.id)}})),c.value=!1}}function A(l){const t=o.value.find(e=>e.id===l);t&&(t.status==="downloading"||t.status==="pending"||t.status==="waiting")&&(f?.postMessage({controls:{type:"pauseItem",itemId:l}}),t.status="paused",t.children.forEach(e=>{(e.status==="downloading"||e.status==="pending"||e.status==="waiting")&&(e.status="paused")}),o.value.every(e=>e.status==="completed"||e.status==="paused")&&(c.value=!0))}function D(l){const t=o.value.find(e=>e.id===l);t&&t.status==="paused"&&(f?.postMessage({controls:{type:"resumeItem",itemId:l}}),o.value.find(e=>e.status==="downloading"||e.status==="pending")?(t.status="waiting",t.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})):(t.status="pending",t.children.forEach(e=>{e.status==="paused"&&(e.status="pending")})),o.value.some(e=>e.status==="downloading"||e.status==="pending")&&(c.value=!1))}function U(l){f?.postMessage({controls:{action:"prioritize",itemId:l}})}async function j(l,t){$.value=!0;try{const{data:e}=await se().get(`/${t}/watch`),L=e.filter(s=>!!s?.file).map(s=>s.video_id),O=o.value.map(s=>s.id),V=L.some(s=>!O.includes(s))||O.some(s=>!L.includes(s));V?(g.value=0,v.value=0,o.value=[]):o.value=o.value.filter(s=>s.status==="completed"),o.value=await Promise.all(e.filter(s=>!!s?.file).map(async(s,b)=>{const i=s.tracks?.some(d=>d.kind==="subtitles"&&d.file),w=s.tracks?.some(d=>d.kind==="fonts"&&d.file),u=s.tracks?.some(d=>["thumbnails","sprite"].includes(d.kind)&&d.file);let M=!1;if(s.file.endsWith(".m3u8"))try{M=(await(await fetch(`${z.value?.serverBaseUrl}${s.file}`,{headers:{Authorization:`Bearer ${Q.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(d){console.warn("Failed to check master playlist for audio:",d)}const k=[{type:"video",name:"Video",progress:0,status:"pending"}];return M&&k.push({type:"audio",name:"Audio",progress:0,status:"pending"}),i&&k.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),u&&k.push({type:"preview",name:"Preview",progress:0,status:"pending"}),w&&k.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:s.video_id,title:`${s.show}${s.season?` S${Y(s.season,2)}`:""}${s.episode?`E${Y(s.episode,2)}`:""} - ${s.title}`,image:s.image,progress:0,status:b===0?"pending":"waiting",children:k.map(d=>({...d,status:b===0?"pending":"waiting"}))}}));const C=e.filter(s=>!!s?.file).map(s=>{const b=s.tracks?.filter(u=>u.kind==="subtitles"&&u.file)?.map(u=>u.file),i=s.tracks?.filter(u=>u.kind==="fonts"&&u.file)?.map(u=>u.file),w=s.tracks?.filter(u=>["thumbnails","sprite"].includes(u.kind)&&u.file)?.map(u=>u.file);return{mediaId:s.video_id,mediaType:"video",mediaPath:s.file,baseUrl:z.value?.serverBaseUrl||"",token:Q.value?.accessToken||"",...b?.length?{subtitlePaths:b}:{},...i?.length?{fontPaths:i}:{},...w?.length?{previewPaths:w}:{}}});if(!C.length)throw new Error("No valid files to download");return a.value=C.length,console.log("Starting download with tasks:",C),await new Promise((s,b)=>{f=new Worker(new URL("/assets/downloadWorker-Bu7z8Y_c.js",""+import.meta.url),{type:"module"}),f.onerror=i=>{console.error("Worker error:",i),b(i)},f.onmessage=i=>{if(console.log("Worker message:",i.data),i.data.type==="error"&&i.data.error==="paused")return;const{type:w,progress:u,itemProgress:M,assetType:k,assetProgress:d,itemId:X,status:N,isNewQuery:Z}=i.data;if(w==="progress"){if((V||!Z)&&(g.value=Math.min(u,100)),_.value=M,X){const p=o.value.find(I=>I.id===X);if(p){if(k){const P=p.children.find(ee=>ee.type===k);P&&(P.progress=Math.min(d,100),P.status=P.progress===100?"completed":N)}const I=p.children.filter(P=>P.progress===100).length;p.progress=Math.round(I/p.children.length*100),p.progress===100?(p.status="completed",E()):N&&(p.status=N)}}}else if(w==="complete")E(),s(!0);else if(w==="error")i.data.error==="paused"?s(!1):b(i.data.error);else if(w==="status"){const p=o.value.find(I=>I.id===i.data.itemId);p&&p.status!=="completed"&&p.status!==i.data.status&&(p.status=i.data.status,p.children.forEach(I=>{I.status!=="completed"&&(I.status=i.data.status)}))}},f.postMessage({tasks:C,baseUrl:z.value?.serverBaseUrl,token:Q.value?.accessToken,isNewQuery:V})}),!0}catch(e){return e==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",e),!1)}finally{c.value||(f?.terminate(),$.value=!1)}}return{isDownloading:$,progress:g,totalItems:a,completedItems:v,itemProgress:_,downloadQueue:o,isPaused:c,downloadPlaylist:j,pauseDownloads:T,resumeDownloads:B,pauseItem:A,resumeItem:D,prioritizeItem:U}}R();var pe={class:"bg-surface-900/50 rounded p-4 grid gap-2"},fe={class:"flex justify-between items-center"},ce={class:"text-sm font-medium truncate flex items-center gap-2"},me={key:0,class:"text-2xs text-slate-400"},ge={key:1,class:"text-2xs text-slate-400"},ve={class:"flex gap-2"},we=["src"],he={class:"flex-1 min-w-0 grid gap-x-4 gap-y-0.5"},ye={class:"flex justify-between leading-0"},_e={class:"w-full bg-surface-700 rounded h-1"},be=q({__name:"DownloadQueueItem",props:{item:{},onPause:{type:Function},onResume:{type:Function}},setup($){const g=a=>({"bg-blue-500":a==="video","bg-green-500":a==="audio","bg-yellow-500":a==="subtitle","bg-purple-500":a==="preview","bg-pink-500":a==="font"}),v=a=>a==="downloading"||a==="pending"||a==="waiting";return(a,_)=>(m(),h("article",pe,[r("header",fe,[r("h3",ce,[te(y(a.item.title)+" ",1),a.item.status==="downloading"?(m(),h("span",me,"(Downloading...)")):a.item.status==="waiting"?(m(),h("span",ge,"(Waiting...)")):S("",!0)]),a.item.status!=="completed"?(m(),h("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-surface-800",onClick:_[0]||(_[0]=o=>v(a.item.status)?a.onPause(a.item.id):a.onResume(a.item.id))},y(v(a.item.status)?"Pause":"Resume"),1)):S("",!0)]),r("div",ve,[r("img",{src:`${n(oe)}${a.item.image}`,alt:"Item Image",class:"w-1/4 h-auto aspect-video object-fit rounded"},null,8,we),r("div",he,[(m(!0),h(K,null,J(a.item.children,o=>(m(),h("div",{key:o.type,class:"text-2xs"},[r("div",ye,[r("span",null,y(o.name),1),r("span",null,y(o.progress)+"%",1)]),r("div",_e,[r("div",{class:re([g(o.type),"h-full rounded"]),style:G(`width: ${o.progress}%`)},null,6)])]))),128))])])]))}}),ke=be;R();var Ie={class:"flex gap-4 max-h-[80vh] overflow-clip"},xe=["disabled"],Pe={key:0,class:"text-xs grid gap-1"},$e={class:"flex justify-between items-center"},De={class:"w-full bg-surface-700 rounded h-1.5 relative"},Ee={key:0,class:"flex-1 overflow-y-auto available grid gap-2 content-start"},Ce=q({__name:"Desktop",setup($){const{isDownloading:g,progress:v,totalItems:a,completedItems:_,downloadQueue:o,isPaused:c,downloadPlaylist:f,pauseDownloads:E,resumeDownloads:T,pauseItem:B,resumeItem:A}=de(),D=x("tv/138357");async function U(){await f("video",D.value)}return(j,l)=>{const t=le("InputText");return m(),H(n(ne),null,{default:F(()=>[W(n(ae),{fullscreen:!0},{default:F(()=>[W(ue,{"grid-style":3,title:"Profile",class:"grid gap-2 p-4 col-span-12"},{default:F(()=>[l[2]||(l[2]=r("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),r("div",Ie,[r("form",{class:"w-2/5 flex flex-col gap-2",onSubmit:ie(U,["prevent"])},[W(t,{modelValue:D.value,"onUpdate:modelValue":l[0]||(l[0]=e=>D.value=e),class:"w-full text-sm"},null,8,["modelValue"]),r("button",{disabled:n(g),class:"bg-primary p-1.5 rounded disabled:opacity-50 text-sm",type:"submit"},y(n(g)?"Downloading...":"Download Show"),9,xe),n(g)||n(_)?(m(),h("div",Pe,[r("div",$e,[r("span",null,"Progress: "+y(n(v))+"% ("+y(n(_))+"/"+y(n(a))+")",1),r("button",{class:"text-xs px-2 py-0.5 rounded bg-surface-800",type:"button",onClick:l[1]||(l[1]=e=>n(c)?n(T)():n(E)())},y(n(c)?"Resume All":"Pause All"),1)]),r("div",De,[r("div",{style:G(`width: ${n(v)}%`),class:"bg-primary h-full rounded absolute inset-0"},null,4)])])):S("",!0)],32),n(o).length?(m(),h("div",Ee,[(m(!0),h(K,null,J(n(o),e=>(m(),H(ke,{key:e.id,item:e,"on-pause":n(B),"on-resume":n(A)},null,8,["item","on-pause","on-resume"]))),128))])):S("",!0)])]),_:1})]),_:1})]),_:1})}}}),We=Ce;export{We as default};
