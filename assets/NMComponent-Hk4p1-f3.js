import{$ as q,Cn as k,Dn as x,Gn as I,Hn as U,Ht as w,In as c,Jn as D,Kn as N,P as Q,Sn as T,Tn as _,Un as B,Vn as F,Y as C,Yn as P,Yt as $,Zn as f,_n as j,cn as H,en as Y,f as S,in as K,jn as A,nn as V,rn as G,un as J}from"./index-04Sh3wNb.js";import{t as Z}from"./currentServer-B7-kbkE-.js";import{t as E}from"./serverClient-FHPKIHPu.js";import{T as z,t as W}from"./router-C_xBvmya.js";import{N as X,O as tt,_ as O,k as et,p as st,r as nt,t as at}from"./utils-D5DD-7jP.js";import{rt as it,tt as b}from"./SocketClient-DPmgFkP-.js";import{t as rt}from"./useQueryClient-s6ZLwuD6.js";import{t as ot}from"./useQuery-C7DDAmeN.js";import{t as ut}from"./useMutationState-gvf_f5mV.js";var lt=class extends X{#s;#n=void 0;#t;#e;constructor(t,e){super(),this.#s=t,this.setOptions(e),this.bindMethods(),this.#a()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){const e=this.options;this.options=this.#s.defaultMutationOptions(t),tt(this.options,e)||this.#s.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#t,observer:this}),e?.mutationKey&&this.options.mutationKey&&O(e.mutationKey)!==O(this.options.mutationKey)?this.reset():this.#t?.state.status==="pending"&&this.#t.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#t?.removeObserver(this)}onMutationUpdate(t){this.#a(),this.#i(t)}getCurrentResult(){return this.#n}reset(){this.#t?.removeObserver(this),this.#t=void 0,this.#a(),this.#i()}mutate(t,e){return this.#e=e,this.#t?.removeObserver(this),this.#t=this.#s.getMutationCache().build(this.#s,this.options),this.#t.addObserver(this),this.#t.execute(t)}#a(){const t=this.#t?.state??it();this.#n={...t,isPending:t.status==="pending",isSuccess:t.status==="success",isError:t.status==="error",isIdle:t.status==="idle",mutate:this.mutate,reset:this.reset}}#i(t){st.batch(()=>{if(this.#e&&this.hasListeners()){const e=this.#n.variables,n=this.#n.context;t?.type==="success"?(this.#e.onSuccess?.(t.data,e,n),this.#e.onSettled?.(t.data,null,e,n)):t?.type==="error"&&(this.#e.onError?.(t.error,e,n),this.#e.onSettled?.(void 0,t.error,e,n))}this.listeners.forEach(e=>{e(this.#n)})})}};function ct(t,e){const n=e||rt(),a=Y(()=>n.defaultMutationOptions(at(t))),r=new lt(n,a.value),s=a.value.shallow?I(r.getCurrentResult()):U(r.getCurrentResult()),p=r.subscribe(o=>{nt(s,o)}),u=(o,y)=>{r.mutate(o,y).catch(()=>{})};c(a,()=>{r.setOptions(a.value)}),F(()=>{p()});const m=a.value.shallow?N(s):B(s),l=P(m);return c(()=>s.error,o=>{if(o&&et(a.value.throwOnError,[o]))throw o}),{...l,mutate:u,mutateAsync:s.mutate,reset:s.reset}}C();w();function v(t){const e=q(),n=[];return(t??e?.path)?.split("/").slice(1).forEach(a=>{a.includes("?")?(n.push(a.split("?")[0]),n.push(a.split("?")[1].split("=")[1])):n.push(a)}),n}function ht({queryKey:t,path:e}={queryKey:void 0,path:void 0}){return ut({mutationKey:t??v(e)})}var dt=S();c(dt,async t=>{t&&(await b.invalidateQueries(),b.getMutationCache().clear())});c(Z,async(t,e)=>{if(!t){z();return}e?.id&&t.id!==e.id&&(await b.invalidateQueries(),b.getMutationCache().clear())});function pt({queryKey:t,path:e}={queryKey:void 0,path:void 0}){return ot({queryKey:t??v(e),queryFn:async()=>E().get(e??W.currentRoute.value.path).then(({data:n})=>n.data)})}function mt({queryKey:t,path:e,homeData:n}){return ct({mutationKey:t??v(e),mutationFn:async a=>{const r=[...n.value?.map(s=>structuredClone(D(s)))??[]];for(const s of a)await E().post(e??s.update.link,{replace_id:s.update.body.replace_id}).then(p=>{for(let u=0;u<r.length;u++)r[u].id===s.update?.body?.replace_id&&(r[u]=p.data?.data[0])});return r}})}w();C();var ft={key:0,class:"grid w-available h-available place-items-center"},vt=J({__name:"NMComponent",props:{path:{type:String,required:!1,default:void 0},options:{type:Object,required:!1,default:()=>({keepForever:!0,queryKey:v()})}},setup(t){const e=new Set(["Home","Libraries","Music Start"]),n=t,a=n.options.queryKey??v(),r=ht({queryKey:a,path:n.path}),{data:s,isLoading:p}=pt({queryKey:a,path:n.path}),{data:u,mutate:m}=mt({queryKey:a,homeData:s}),l=S(),o=q();function y(){if(!s.value||!l.value)return;const i=s.value.filter(h=>h?.update?.when==="pageLoad")??[];i.length>0&&m(i)}function R(){if(!s.value||!l.value)return;const i=s.value.filter(h=>h?.update?.when==="online")??[];i.length>0&&m(i)}function M(i){const h=i;if(!s.value||!l.value)return;const d=s.value.filter(g=>g?.id===h.detail.id)??[];d.length>0&&m(d)}function L(){return e.has(o.name)}return T(()=>{document.addEventListener("mutateId",M),s.value&&l.value&&L()&&y()}),k(()=>{document.removeEventListener("mutateId",M)}),c(l,i=>{i&&R()}),c(s,i=>{i&&requestIdleCallback(()=>{document.dispatchEvent(new Event("indexer"))})}),c(()=>o.name,i=>{s.value&&l.value&&e.has(i)&&y()}),(i,h)=>f(p)?(_(),K("div",ft,[H(f(Q),{class:"ion-padding",name:"crescent"})])):f(r)?G("",!0):(_(!0),K($,{key:1},x(f(u)??f(s)??[],(d,g)=>(_(),V(A(d?.component),j({key:d.id,index:g},{ref_for:!0},d.props),null,16,["index"]))),128))}}),Ct=vt;export{Ct as t};
