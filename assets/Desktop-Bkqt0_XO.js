import{D as K,Dn as X,Ht as q,Qn as ee,Rn as Q,Tn as f,Wn as k,Yt as Y,Zn as i,cn as z,er as H,in as v,kn as te,nn as se,rn as B,sn as ae,tn as o,tr as w,un as oe,x as re}from"./index-04Sh3wNb.js";import"./dist-CVoPesok.js";import"./esm-BuFVrMo0.js";import"./esm-9iWgK55i.js";import"./esm-cDzTb79E.js";import"./esm-BfF1RlcU.js";import"./dist-B3n7-doU.js";import"./focus-visible-CHAJCf_J.js";import"./index5-B30D6T27.js";import"./client-rtF7IPPI.js";import"./ionic-global--aoJHCDL.js";import"./hardware-back-button-h528z6zo.js";import"./index3-CSo3jo06.js";import"./helpers-CXS86XKs.js";import"./index6-CZ6rqL_0.js";import"./index8-BpkFXja0.js";import"./keyboard-cU79cwdW.js";import"./index2-op38TIl9.js";import"./ios.transition-C8T7q-Bo.js";import"./keyboard2-DETZ41vp.js";import"./md.transition-BqH5iNQr.js";import"./dir-BUtgAzbR.js";import"./ui-BT6EUdI0.js";import"./client-DMa-uSBE.js";import{g as Z,t as j}from"./currentServer-B7-kbkE-.js";import{s as ie}from"./config-BOA2pGQM.js";import"./esm-CcKFjObu.js";import"./global-gyhCjh_P.js";import"./esm-BuRgllmc.js";import{c as F}from"./user-C1ciKa7-.js";import{t as le}from"./serverClient-FHPKIHPu.js";import"./router-C_xBvmya.js";import"./utils-D5DD-7jP.js";import"./useBaseQuery-CNJp2kAB.js";import"./useInfiniteServerClient-By5CuBlL.js";import"./SocketClient-DPmgFkP-.js";import"./useQueryClient-s6ZLwuD6.js";import"./useQuery-C7DDAmeN.js";import"./apiClient-Cw7f36ko.js";import"./notifications-Bi_dU6lP.js";import"./utils-CdenF_Jv.js";import"./bundle-mjs-Xm_uQvzT.js";import"./deviceInfo-Bcw3-ht5.js";import"./helpers-fSCF1qXj.js";import"./auth-DfyD43WY.js";import"./MoooomIcon-DNWQYuYD.js";import"./useServerClient-CroZbKWw.js";import"./ScrollContainer-3_hZWeKa.js";import"./useMounted-CBZpV1fi.js";import"./RipperOverlay-BWEr7uxe.js";import"./HubConnection-BtQMN1V5.js";import"./ripperSocket-C9kIp3Ty.js";import"./Button-BOqv4y1r.js";import"./FloatingBackButton-D3UgtlFi.js";import{t as ne}from"./DashboardLayout-CXf1x5EO.js";q();function ue(){const $=k(!1),x=k(0),b=k(0),E=k(0),P=k(0),r=k([]),c=k(!1);let m=null;function C(){b.value=r.value.filter(a=>a.status==="completed").length}function U(){c.value||(m?.postMessage({controls:{type:"pause"}}),r.value.forEach(a=>{a.status!=="completed"&&(a.status="paused",a.children.forEach(s=>{s.status!=="completed"&&(s.status="paused")}))}),c.value=!0)}function S(){if(c.value){const a=r.value.filter(s=>s.status==="paused");a.length>0&&(a[0].status="pending",a[0].children.forEach(s=>{s.status==="paused"&&(s.status="pending")}),a.slice(1).forEach(s=>{s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})}),m?.postMessage({controls:{type:"resume",pausedIds:a.map(s=>s.id)}})),c.value=!1}}function V(a){const s=r.value.find(e=>e.id===a);s&&(s.status==="downloading"||s.status==="pending"||s.status==="waiting")&&(m?.postMessage({controls:{type:"pauseItem",itemId:a}}),s.status="paused",s.children.forEach(e=>{(e.status==="downloading"||e.status==="pending"||e.status==="waiting")&&(e.status="paused")}),r.value.every(e=>e.status==="completed"||e.status==="paused")&&(c.value=!0))}function D(a){const s=r.value.find(e=>e.id===a);s&&s.status==="paused"&&(m?.postMessage({controls:{type:"resumeItem",itemId:a}}),r.value.find(e=>e.status==="downloading"||e.status==="pending")?(s.status="waiting",s.children.forEach(e=>{e.status==="paused"&&(e.status="waiting")})):(s.status="pending",s.children.forEach(e=>{e.status==="paused"&&(e.status="pending")})),r.value.some(e=>e.status==="downloading"||e.status==="pending")&&(c.value=!1))}function A(a){m?.postMessage({controls:{action:"prioritize",itemId:a}})}async function R(a,s){$.value=!0;try{const{data:e}=await le().get(`/${s}/watch`),p=e.filter(t=>!!t?.file).map(t=>t.video_id),L=r.value.map(t=>t.id),N=p.some(t=>!L.includes(t))||L.some(t=>!p.includes(t));N?(x.value=0,b.value=0,r.value=[]):r.value=r.value.filter(t=>t.status==="completed"),r.value=await Promise.all(e.filter(t=>!!t?.file).map(async(t,h)=>{const l=t.tracks?.some(u=>u.kind==="subtitles"&&u.file),g=t.tracks?.some(u=>u.kind==="fonts"&&u.file),n=t.tracks?.some(u=>["thumbnails","sprite"].includes(u.kind)&&u.file);let M=!1;if(t.file.endsWith(".m3u8"))try{M=(await(await fetch(`${j.value?.serverBaseUrl}${t.file}`,{headers:{Authorization:`Bearer ${F.value?.accessToken}`}})).text()).includes("#EXT-X-MEDIA:TYPE=AUDIO")}catch(u){console.warn("Failed to check master playlist for audio:",u)}const _=[{type:"video",name:"Video",progress:0,status:"pending"}];return M&&_.push({type:"audio",name:"Audio",progress:0,status:"pending"}),l&&_.push({type:"subtitle",name:"Subtitles",progress:0,status:"pending"}),n&&_.push({type:"preview",name:"Preview",progress:0,status:"pending"}),g&&_.push({type:"font",name:"Fonts",progress:0,status:"pending"}),{id:t.video_id,title:`${t.show}${t.season?` S${Z(t.season,2)}`:""}${t.episode?`E${Z(t.episode,2)}`:""} - ${t.title}`,image:t.image,progress:0,status:h===0?"pending":"waiting",children:_.map(u=>({...u,status:h===0?"pending":"waiting"}))}}));const T=e.filter(t=>!!t?.file).map(t=>{const h=t.tracks?.filter(n=>n.kind==="subtitles"&&n.file)?.map(n=>n.file),l=t.tracks?.filter(n=>n.kind==="fonts"&&n.file)?.map(n=>n.file),g=t.tracks?.filter(n=>["thumbnails","sprite"].includes(n.kind)&&n.file)?.map(n=>n.file);return{mediaId:t.video_id,mediaType:"video",mediaPath:t.file,baseUrl:j.value?.serverBaseUrl||"",token:F.value?.accessToken||"",...h?.length?{subtitlePaths:h}:{},...l?.length?{fontPaths:l}:{},...g?.length?{previewPaths:g}:{}}});if(!T.length)throw new Error("No valid files to download");return E.value=T.length,console.log("Starting download with tasks:",T),await new Promise((t,h)=>{m=new Worker(new URL("/assets/downloadWorker-Bef9Ut5E.js",""+import.meta.url),{type:"module"}),m.onerror=l=>{console.error("Worker error:",l),h(l)},m.onmessage=l=>{if(console.log("Worker message:",l.data),l.data.type==="error"&&l.data.error==="paused")return;const{type:g,progress:n,itemProgress:M,assetType:_,assetProgress:u,itemId:O,status:W,isNewQuery:G}=l.data;if(g==="progress"){if((N||!G)&&(x.value=Math.min(n,100)),P.value=M,O){const d=r.value.find(y=>y.id===O);if(d){if(_){const I=d.children.find(J=>J.type===_);I&&(I.progress=Math.min(u,100),I.status=I.progress===100?"completed":W)}const y=d.children.filter(I=>I.progress===100).length;d.progress=Math.round(y/d.children.length*100),d.progress===100?(d.status="completed",C()):W&&(d.status=W)}}}else if(g==="complete")C(),t(!0);else if(g==="error")l.data.error==="paused"?t(!1):h(l.data.error);else if(g==="status"){const d=r.value.find(y=>y.id===l.data.itemId);d&&d.status!=="completed"&&d.status!==l.data.status&&(d.status=l.data.status,d.children.forEach(y=>{y.status!=="completed"&&(y.status=l.data.status)}))}},m.postMessage({tasks:T,baseUrl:j.value?.serverBaseUrl,token:F.value?.accessToken,isNewQuery:N})}),!0}catch(e){return e==="paused"?(console.log("Downloads paused"),!1):(console.error("Download failed:",e),!1)}finally{c.value||(m?.terminate(),$.value=!1)}}return{isDownloading:$,progress:x,totalItems:E,completedItems:b,itemProgress:P,downloadQueue:r,isPaused:c,downloadPlaylist:R,pauseDownloads:U,resumeDownloads:S,pauseItem:V,resumeItem:D,prioritizeItem:A}}q();var de={class:"flex flex-col gap-2 p-4 overflow-clip col-span-12"},pe={class:"flex gap-4 max-h-[80vh] overflow-clip"},me={class:"w-2/5"},ce=["disabled"],fe={key:0,class:"mt-2 text-xs"},ge={class:"flex justify-between items-center mb-1"},ve={class:"w-full bg-surface-700 rounded h-1.5 mt-1"},we={key:0,class:"flex-1 overflow-y-auto available"},he={class:"grid gap-2"},_e={class:"flex justify-between items-center"},ye={class:"text-sm font-medium truncate flex items-center gap-2"},ke={key:0,class:"text-2xs text-slate-400"},xe={key:1,class:"text-2xs text-slate-400"},be=["onClick"],Ie={class:"flex gap-2"},Pe={class:"w-1/4 flex flex-col gap-2"},De=["src"],$e={class:"flex-1 min-w-0"},Ee={class:"grid grid-cols-1 gap-x-4 gap-y-0.5"},Ce={class:"flex justify-between leading-0"},Te={class:"w-full bg-surface-700 rounded h-1"},Me=oe({__name:"Desktop",setup($){const{isDownloading:x,progress:b,totalItems:E,completedItems:P,downloadQueue:r,isPaused:c,downloadPlaylist:m,pauseDownloads:C,resumeDownloads:U,pauseItem:S,resumeItem:V}=ue(),D=k("tv/138357");async function A(){await m("video",D.value)}return(R,a)=>{const s=te("InputText");return f(),se(i(K),null,{default:Q(()=>[z(i(re),{fullscreen:!0},{default:Q(()=>[z(ne,{"grid-style":3,title:"Profile"},{default:Q(()=>[o("div",de,[a[2]||(a[2]=o("h2",{class:"text-lg mb-2"}," Download for Offline Viewing ",-1)),o("div",pe,[o("div",me,[z(s,{modelValue:D.value,"onUpdate:modelValue":a[0]||(a[0]=e=>D.value=e),class:"w-full text-sm"},null,8,["modelValue"]),o("button",{disabled:i(x),class:"bg-primary p-1.5 rounded disabled:opacity-50 mt-2 w-full text-sm",onClick:A},w(i(x)?"Downloading...":"Download Show"),9,ce),i(x)||i(P)?(f(),v("div",fe,[o("div",ge,[o("span",null,"Progress: "+w(i(b))+"% ("+w(i(P))+"/"+w(i(E))+")",1),o("button",{class:"text-xs px-2 py-0.5 rounded bg-surface-800",onClick:a[1]||(a[1]=e=>i(c)?i(U)():i(C)())},w(i(c)?"Resume All":"Pause All"),1)]),o("div",ve,[o("div",{style:H(`width: ${i(b)}%`),class:"bg-primary h-full rounded"},null,4)])])):B("",!0)]),i(r).length?(f(),v("div",we,[o("div",he,[(f(!0),v(Y,null,X(i(r),e=>(f(),v("div",{key:e.id,class:"bg-surface-900/50 rounded p-4 flex flex-col gap-2"},[o("div",_e,[o("div",ye,[ae(w(e.title)+" ",1),e.status==="downloading"?(f(),v("span",ke,"(Downloading...)")):e.status==="waiting"?(f(),v("span",xe,"(Waiting...)")):B("",!0)]),e.status!=="completed"?(f(),v("button",{key:0,class:"text-2xs px-2 py-0.5 rounded bg-surface-800",onClick:p=>e.status==="downloading"||e.status==="pending"||e.status==="waiting"?i(S)(e.id):i(V)(e.id)},w(e.status==="downloading"||e.status==="pending"||e.status==="waiting"?"Pause":"Resume"),9,be)):B("",!0)]),o("div",Ie,[o("div",Pe,[o("img",{src:`${i(ie)}${e.image}`,alt:"Item Image",class:"w-full h-auto aspect-video object-fit my-auto rounded"},null,8,De)]),o("div",$e,[o("div",Ee,[(f(!0),v(Y,null,X(e.children,p=>(f(),v("div",{key:p.type,class:"text-2xs"},[o("div",Ce,[o("span",null,w(p.name),1),o("span",null,w(p.progress)+"%",1)]),o("div",Te,[o("div",{class:ee([{"bg-blue-500":p.type==="video","bg-green-500":p.type==="audio","bg-yellow-500":p.type==="subtitle","bg-purple-500":p.type==="preview","bg-pink-500":p.type==="font"},"h-full rounded"]),style:H(`width: ${p.progress}%`)},null,6)])]))),128))])])])]))),128))])])):B("",!0)])])]),_:1})]),_:1})]),_:1})}}}),Ut=Me;export{Ut as default};
