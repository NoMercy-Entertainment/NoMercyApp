import{Bt as k,Dn as I,Gt as x,I as K,In as D,Lt as U,M as w,Mn as N,Mt as B,On as Q,Pn as T,Tt as C,Vt as O,_ as F,an as P,bn as l,cn as g,en as j,jn as z,kn as A,mn as V,on as $,qt as G,un as H,zn as m,zt as J}from"./index-Dv83kAv_.js";import{t as W}from"./currentServer-CyRP1M2f.js";import{f as E}from"./core-CBi4z1eg.js";import{t as S}from"./serverClient-Dh7JrGPq.js";import{T as X,t as Y}from"./router-LUtA4OvS.js";import{N as Z,O as tt,_ as q,k as et,p as st,r as at,t as nt}from"./utils-S5luT9U1.js";import{rt as it,tt as y}from"./SocketClient-CLd4yl1R.js";import{t as rt}from"./useQueryClient-_29YjZdz.js";import{t as ot}from"./useQuery-CVx6KcJR.js";import{t as ut}from"./useMutationState-Byr2jfbw.js";var lt=class extends Z{#s;#a=void 0;#t;#e;constructor(t,e){super(),this.#s=t,this.setOptions(e),this.bindMethods(),this.#n()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){const e=this.options;this.options=this.#s.defaultMutationOptions(t),tt(this.options,e)||this.#s.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#t,observer:this}),e?.mutationKey&&this.options.mutationKey&&q(e.mutationKey)!==q(this.options.mutationKey)?this.reset():this.#t?.state.status==="pending"&&this.#t.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#t?.removeObserver(this)}onMutationUpdate(t){this.#n(),this.#i(t)}getCurrentResult(){return this.#a}reset(){this.#t?.removeObserver(this),this.#t=void 0,this.#n(),this.#i()}mutate(t,e){return this.#e=e,this.#t?.removeObserver(this),this.#t=this.#s.getMutationCache().build(this.#s,this.options),this.#t.addObserver(this),this.#t.execute(t)}#n(){const t=this.#t?.state??it();this.#a={...t,isPending:t.status==="pending",isSuccess:t.status==="success",isError:t.status==="error",isIdle:t.status==="idle",mutate:this.mutate,reset:this.reset}}#i(t){st.batch(()=>{if(this.#e&&this.hasListeners()){const e=this.#a.variables,a=this.#a.context;t?.type==="success"?(this.#e.onSuccess?.(t.data,e,a),this.#e.onSettled?.(t.data,null,e,a)):t?.type==="error"&&(this.#e.onError?.(t.error,e,a),this.#e.onSettled?.(void 0,t.error,e,a))}this.listeners.forEach(e=>{e(this.#a)})})}};function ct(t,e){const a=e||rt(),n=U(()=>a.defaultMutationOptions(nt(t))),o=new lt(a,n.value),s=n.value.shallow?z(o.getCurrentResult()):Q(o.getCurrentResult()),d=o.subscribe(i=>{at(s,i)}),u=(i,v)=>{o.mutate(i,v).catch(()=>{})};l(n,()=>{o.setOptions(n.value)}),I(()=>{d()});const p=D(n.value.shallow?N(s):A(s));return l(()=>s.error,i=>{if(i&&et(n.value.throwOnError,[i]))throw i}),{...p,mutate:u,mutateAsync:s.mutate,reset:s.reset}}w();C();function f(t){const e=K(),a=[];return(t??e?.path)?.split("/").slice(1).forEach(n=>{n.includes("?")?(a.push(n.split("?")[0]),a.push(n.split("?")[1].split("=")[1])):a.push(n)}),a}function ht({queryKey:t,path:e}={queryKey:void 0,path:void 0}){return ut({mutationKey:t??f(e)})}l(E(),async t=>{t&&(await y.invalidateQueries(),y.getMutationCache().clear())});l(W,async(t,e)=>{if(!t){X();return}e?.id&&t.id!==e.id&&(await y.invalidateQueries(),y.getMutationCache().clear())});function dt({queryKey:t,path:e}={queryKey:void 0,path:void 0}){return ot({queryKey:t??f(e),queryFn:async()=>S().get(e??Y.currentRoute.value.path,{params:{}}).then(({data:a})=>a.data)})}function pt({queryKey:t,path:e,homeData:a}){return ct({mutationKey:t??f(e),mutationFn:async n=>{const o=[...a.value?.map(s=>structuredClone(T(s)))??[]];for(const s of n)await S().post(e??s.update.link,{replace_id:s.update.body.replace_id}).then(d=>{for(let u=0;u<o.length;u++)o[u].id===s.update?.body?.replace_id&&(o[u]=d.data?.data[0])});return o}})}C();w();var mt={key:0,class:"grid w-available h-available place-items-center"},ft=G({__name:"NMComponent",props:{path:{type:String,required:!1,default:void 0},options:{type:Object,required:!1,default:()=>({keepForever:!0,queryKey:f()})}},setup(t){const e=t,a=new Set(["Home","Libraries","Music Start"]),n=e.options.queryKey??f(),o=ht({queryKey:n,path:e.path}),{data:s,isLoading:d}=dt({queryKey:n,path:e.path}),{data:u,mutate:p}=pt({queryKey:n,homeData:s}),i=E(),v=K();function _(){if(!s.value||!i.value)return;const r=s.value.filter(c=>c?.update?.when==="pageLoad")??[];r.length>0&&p(r)}function R(){if(!s.value||!i.value)return;const r=s.value.filter(c=>c?.update?.when==="online")??[];r.length>0&&p(r)}function M(r){const c=r;if(!s.value||!i.value)return;const h=s.value.filter(b=>b?.id===c.detail.id)??[];h.length>0&&p(h)}function L(){return a.has(v.name)}return P(()=>{document.addEventListener("mutateId",M),s.value&&i.value&&L()&&_()}),$(()=>{document.removeEventListener("mutateId",M)}),l(i,r=>{r&&R()}),l(s,r=>{r&&requestIdleCallback(()=>{document.dispatchEvent(new Event("indexer"))})}),l(()=>v.name,r=>{s.value&&i.value&&a.has(r)&&_()}),(r,c)=>m(d)?(g(),O("div",mt,[x(m(F),{class:"ion-padding",name:"crescent"})])):m(o)?k("",!0):(g(!0),O(B,{key:1},H(m(u)??m(s)??[],(h,b)=>(g(),J(V(h?.component),j({key:h.id,index:b},{ref_for:!0},h.props),null,16,["index"]))),128))}}),Ct=ft;export{Ct as t};
