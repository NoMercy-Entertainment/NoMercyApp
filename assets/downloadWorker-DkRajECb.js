(function(){"use strict";var H=(function(){function a(){this.listeners={}}var r=a.prototype;return r.on=function(t,n){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(n)},r.off=function(t,n){if(!this.listeners[t])return!1;var s=this.listeners[t].indexOf(n);return this.listeners[t]=this.listeners[t].slice(0),this.listeners[t].splice(s,1),s>-1},r.trigger=function(t){var n=this.listeners[t];if(n)if(arguments.length===2)for(var s=n.length,o=0;o<s;++o)n[o].call(this,arguments[1]);else for(var f=Array.prototype.slice.call(arguments,1),d=n.length,c=0;c<d;++c)n[c].apply(this,f)},r.dispose=function(){this.listeners={}},r.pipe=function(t){this.on("data",function(n){t.push(n)})},a})();function x(){return x=Object.assign?Object.assign.bind():function(a){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var t in e)({}).hasOwnProperty.call(e,t)&&(a[t]=e[t])}return a},x.apply(null,arguments)}var _=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function tt(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Y,Q;function et(){if(Q)return Y;Q=1;var a;return typeof window<"u"?a=window:typeof _<"u"?a=_:typeof self<"u"?a=self:a={},Y=a,Y}var it=et(),z=tt(it),st=function(r){return z.atob?z.atob(r):Buffer.from(r,"base64").toString("binary")};function at(a){for(var r=st(a),e=new Uint8Array(r.length),t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}/*! @name m3u8-parser @version 7.2.0 @license Apache-2.0 */class rt extends H{constructor(){super(),this.buffer=""}push(r){let e;for(this.buffer+=r,e=this.buffer.indexOf(`
`);e>-1;e=this.buffer.indexOf(`
`))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)}}const nt="	",V=function(a){const r=/([0-9.]*)?@?([0-9.]*)?/.exec(a||""),e={};return r[1]&&(e.length=parseInt(r[1],10)),r[2]&&(e.offset=parseInt(r[2],10)),e},ot=function(){const e="(?:"+"[^=]*"+")=(?:"+'"[^"]*"|[^,]*'+")";return new RegExp("(?:^|,)("+e+")")},A=function(a){const r={};if(!a)return r;const e=a.split(ot());let t=e.length,n;for(;t--;)e[t]!==""&&(n=/([^=]*)=(.*)/.exec(e[t]).slice(1),n[0]=n[0].replace(/^\s+|\s+$/g,""),n[1]=n[1].replace(/^\s+|\s+$/g,""),n[1]=n[1].replace(/^['"](.*)['"]$/g,"$1"),r[n[0]]=n[1]);return r},J=a=>{const r=a.split("x"),e={};return r[0]&&(e.width=parseInt(r[0],10)),r[1]&&(e.height=parseInt(r[1],10)),e};class ut extends H{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(r){let e,t;if(r=r.trim(),r.length===0)return;if(r[0]!=="#"){this.trigger("data",{type:"uri",uri:r});return}this.tagMappers.reduce((s,o)=>{const f=o(r);return f===r?s:s.concat([f])},[r]).forEach(s=>{for(let o=0;o<this.customParsers.length;o++)if(this.customParsers[o].call(this,s))return;if(s.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:s.slice(1)});return}if(s=s.replace("\r",""),e=/^#EXTM3U/.exec(s),e){this.trigger("data",{type:"tag",tagType:"m3u"});return}if(e=/^#EXTINF:([0-9\.]*)?,?(.*)?$/.exec(s),e){t={type:"tag",tagType:"inf"},e[1]&&(t.duration=parseFloat(e[1])),e[2]&&(t.title=e[2]),this.trigger("data",t);return}if(e=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"targetduration"},e[1]&&(t.duration=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-VERSION:([0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"version"},e[1]&&(t.version=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA-SEQUENCE:(\-?[0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"media-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\-?[0-9.]*)?/.exec(s),e){t={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(t.number=parseInt(e[1],10)),this.trigger("data",t);return}if(e=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(s),e){t={type:"tag",tagType:"playlist-type"},e[1]&&(t.playlistType=e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-BYTERANGE:(.*)?$/.exec(s),e){t=x(V(e[1]),{type:"tag",tagType:"byterange"}),this.trigger("data",t);return}if(e=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(s),e){t={type:"tag",tagType:"allow-cache"},e[1]&&(t.allowed=!/NO/.test(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-MAP:(.*)$/.exec(s),e){if(t={type:"tag",tagType:"map"},e[1]){const o=A(e[1]);o.URI&&(t.uri=o.URI),o.BYTERANGE&&(t.byterange=V(o.BYTERANGE))}this.trigger("data",t);return}if(e=/^#EXT-X-STREAM-INF:(.*)$/.exec(s),e){t={type:"tag",tagType:"stream-inf"},e[1]&&(t.attributes=A(e[1]),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=J(t.attributes.RESOLUTION)),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),t.attributes["PROGRAM-ID"]&&(t.attributes["PROGRAM-ID"]=parseInt(t.attributes["PROGRAM-ID"],10))),this.trigger("data",t);return}if(e=/^#EXT-X-MEDIA:(.*)$/.exec(s),e){t={type:"tag",tagType:"media"},e[1]&&(t.attributes=A(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-ENDLIST/.exec(s),e){this.trigger("data",{type:"tag",tagType:"endlist"});return}if(e=/^#EXT-X-DISCONTINUITY/.exec(s),e){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}if(e=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(s),e){t={type:"tag",tagType:"program-date-time"},e[1]&&(t.dateTimeString=e[1],t.dateTimeObject=new Date(e[1])),this.trigger("data",t);return}if(e=/^#EXT-X-KEY:(.*)$/.exec(s),e){t={type:"tag",tagType:"key"},e[1]&&(t.attributes=A(e[1]),t.attributes.IV&&(t.attributes.IV.substring(0,2).toLowerCase()==="0x"&&(t.attributes.IV=t.attributes.IV.substring(2)),t.attributes.IV=t.attributes.IV.match(/.{8}/g),t.attributes.IV[0]=parseInt(t.attributes.IV[0],16),t.attributes.IV[1]=parseInt(t.attributes.IV[1],16),t.attributes.IV[2]=parseInt(t.attributes.IV[2],16),t.attributes.IV[3]=parseInt(t.attributes.IV[3],16),t.attributes.IV=new Uint32Array(t.attributes.IV))),this.trigger("data",t);return}if(e=/^#EXT-X-START:(.*)$/.exec(s),e){t={type:"tag",tagType:"start"},e[1]&&(t.attributes=A(e[1]),t.attributes["TIME-OFFSET"]=parseFloat(t.attributes["TIME-OFFSET"]),t.attributes.PRECISE=/YES/.test(t.attributes.PRECISE)),this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-out-cont"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-OUT:(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-out"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-CUE-IN:?(.*)?$/.exec(s),e){t={type:"tag",tagType:"cue-in"},e[1]?t.data=e[1]:t.data="",this.trigger("data",t);return}if(e=/^#EXT-X-SKIP:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"skip"},t.attributes=A(e[1]),t.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(t.attributes["SKIPPED-SEGMENTS"]=parseInt(t.attributes["SKIPPED-SEGMENTS"],10)),t.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(t.attributes["RECENTLY-REMOVED-DATERANGES"]=t.attributes["RECENTLY-REMOVED-DATERANGES"].split(nt)),this.trigger("data",t);return}if(e=/^#EXT-X-PART:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"part"},t.attributes=A(e[1]),["DURATION"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),["INDEPENDENT","GAP"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=/YES/.test(t.attributes[o]))}),t.attributes.hasOwnProperty("BYTERANGE")&&(t.attributes.byterange=V(t.attributes.BYTERANGE)),this.trigger("data",t);return}if(e=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"server-control"},t.attributes=A(e[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=/YES/.test(t.attributes[o]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PART-INF:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"part-inf"},t.attributes=A(e[1]),["PART-TARGET"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseFloat(t.attributes[o]))}),this.trigger("data",t);return}if(e=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"preload-hint"},t.attributes=A(e[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(o){if(t.attributes.hasOwnProperty(o)){t.attributes[o]=parseInt(t.attributes[o],10);const f=o==="BYTERANGE-LENGTH"?"length":"offset";t.attributes.byterange=t.attributes.byterange||{},t.attributes.byterange[f]=t.attributes[o],delete t.attributes[o]}}),this.trigger("data",t);return}if(e=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"rendition-report"},t.attributes=A(e[1]),["LAST-MSN","LAST-PART"].forEach(function(o){t.attributes.hasOwnProperty(o)&&(t.attributes[o]=parseInt(t.attributes[o],10))}),this.trigger("data",t);return}if(e=/^#EXT-X-DATERANGE:(.*)$/.exec(s),e&&e[1]){t={type:"tag",tagType:"daterange"},t.attributes=A(e[1]),["ID","CLASS"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=String(t.attributes[f]))}),["START-DATE","END-DATE"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=new Date(t.attributes[f]))}),["DURATION","PLANNED-DURATION"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=parseFloat(t.attributes[f]))}),["END-ON-NEXT"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=/YES/i.test(t.attributes[f]))}),["SCTE35-CMD"," SCTE35-OUT","SCTE35-IN"].forEach(function(f){t.attributes.hasOwnProperty(f)&&(t.attributes[f]=t.attributes[f].toString(16))});const o=/^X-([A-Z]+-)+[A-Z]+$/;for(const f in t.attributes){if(!o.test(f))continue;const d=/[0-9A-Fa-f]{6}/g.test(t.attributes[f]),c=/^\d+(\.\d+)?$/.test(t.attributes[f]);t.attributes[f]=d?t.attributes[f].toString(16):c?parseFloat(t.attributes[f]):String(t.attributes[f])}this.trigger("data",t);return}if(e=/^#EXT-X-INDEPENDENT-SEGMENTS/.exec(s),e){this.trigger("data",{type:"tag",tagType:"independent-segments"});return}if(e=/^#EXT-X-I-FRAMES-ONLY/.exec(s),e){this.trigger("data",{type:"tag",tagType:"i-frames-only"});return}if(e=/^#EXT-X-CONTENT-STEERING:(.*)$/.exec(s),e){t={type:"tag",tagType:"content-steering"},t.attributes=A(e[1]),this.trigger("data",t);return}if(e=/^#EXT-X-I-FRAME-STREAM-INF:(.*)$/.exec(s),e){t={type:"tag",tagType:"i-frame-playlist"},t.attributes=A(e[1]),t.attributes.URI&&(t.uri=t.attributes.URI),t.attributes.BANDWIDTH&&(t.attributes.BANDWIDTH=parseInt(t.attributes.BANDWIDTH,10)),t.attributes.RESOLUTION&&(t.attributes.RESOLUTION=J(t.attributes.RESOLUTION)),t.attributes["AVERAGE-BANDWIDTH"]&&(t.attributes["AVERAGE-BANDWIDTH"]=parseInt(t.attributes["AVERAGE-BANDWIDTH"],10)),t.attributes["FRAME-RATE"]&&(t.attributes["FRAME-RATE"]=parseFloat(t.attributes["FRAME-RATE"])),this.trigger("data",t);return}if(e=/^#EXT-X-DEFINE:(.*)$/.exec(s),e){t={type:"tag",tagType:"define"},t.attributes=A(e[1]),this.trigger("data",t);return}this.trigger("data",{type:"tag",data:s.slice(4)})})}addParser({expression:r,customType:e,dataParser:t,segment:n}){typeof t!="function"&&(t=s=>s),this.customParsers.push(s=>{if(r.exec(s))return this.trigger("data",{type:"custom",data:t(s),customType:e,segment:n}),!0})}addTagMapper({expression:r,map:e}){const t=n=>r.test(n)?e(n):n;this.tagMappers.push(t)}}const ft=a=>a.toLowerCase().replace(/-(\w)/g,r=>r[1].toUpperCase()),v=function(a){const r={};return Object.keys(a).forEach(function(e){r[ft(e)]=a[e]}),r},K=function(a){const{serverControl:r,targetDuration:e,partTargetDuration:t}=a;if(!r)return;const n="#EXT-X-SERVER-CONTROL",s="holdBack",o="partHoldBack",f=e&&e*3,d=t&&t*2;e&&!r.hasOwnProperty(s)&&(r[s]=f,this.trigger("info",{message:`${n} defaulting HOLD-BACK to targetDuration * 3 (${f}).`})),f&&r[s]<f&&(this.trigger("warn",{message:`${n} clamping HOLD-BACK (${r[s]}) to targetDuration * 3 (${f})`}),r[s]=f),t&&!r.hasOwnProperty(o)&&(r[o]=t*3,this.trigger("info",{message:`${n} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${r[o]}).`})),t&&r[o]<d&&(this.trigger("warn",{message:`${n} clamping PART-HOLD-BACK (${r[o]}) to partTargetDuration * 2 (${d}).`}),r[o]=d)};class L extends H{constructor(r={}){super(),this.lineStream=new rt,this.parseStream=new ut,this.lineStream.pipe(this.parseStream),this.mainDefinitions=r.mainDefinitions||{},this.params=new URL(r.uri,"https://a.com").searchParams,this.lastProgramDateTime=null;const e=this,t=[];let n={},s,o,f=!1;const d=function(){},c={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},l="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";let m=0;this.manifest={allowCache:!0,discontinuityStarts:[],dateRanges:[],iFramePlaylists:[],segments:[]};let b=0,R=0;const S={};this.on("end",()=>{n.uri||!n.parts&&!n.preloadHints||(!n.map&&s&&(n.map=s),!n.key&&o&&(n.key=o),!n.timeline&&typeof m=="number"&&(n.timeline=m),this.manifest.preloadSegment=n)}),this.parseStream.on("data",function(i){let I,E;if(e.manifest.definitions){for(const g in e.manifest.definitions)if(i.uri&&(i.uri=i.uri.replace(`{$${g}}`,e.manifest.definitions[g])),i.attributes)for(const u in i.attributes)typeof i.attributes[u]=="string"&&(i.attributes[u]=i.attributes[u].replace(`{$${g}}`,e.manifest.definitions[g]))}({tag(){({version(){i.version&&(this.manifest.version=i.version)},"allow-cache"(){this.manifest.allowCache=i.allowed,"allowed"in i||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){const g={};"length"in i&&(n.byterange=g,g.length=i.length,"offset"in i||(i.offset=b)),"offset"in i&&(n.byterange=g,g.offset=i.offset),b=g.offset+g.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),i.title&&(n.title=i.title),i.duration>0&&(n.duration=i.duration),i.duration===0&&(n.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=t},key(){if(!i.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(i.attributes.METHOD==="NONE"){o=null;return}if(!i.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(i.attributes.KEYFORMAT==="com.apple.streamingkeydelivery"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:i.attributes};return}if(i.attributes.KEYFORMAT==="com.microsoft.playready"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.microsoft.playready"]={uri:i.attributes.URI};return}if(i.attributes.KEYFORMAT===l){if(["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(i.attributes.METHOD)===-1){this.trigger("warn",{message:"invalid key method provided for Widevine"});return}if(i.attributes.METHOD==="SAMPLE-AES-CENC"&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),i.attributes.URI.substring(0,23)!=="data:text/plain;base64,"){this.trigger("warn",{message:"invalid key URI provided for Widevine"});return}if(!(i.attributes.KEYID&&i.attributes.KEYID.substring(0,2)==="0x")){this.trigger("warn",{message:"invalid key ID provided for Widevine"});return}this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:i.attributes.KEYFORMAT,keyId:i.attributes.KEYID.substring(2)},pssh:at(i.attributes.URI.split(",")[1])};return}i.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),o={method:i.attributes.METHOD||"AES-128",uri:i.attributes.URI},typeof i.attributes.IV<"u"&&(o.iv=i.attributes.IV)},"media-sequence"(){if(!isFinite(i.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+i.number});return}this.manifest.mediaSequence=i.number},"discontinuity-sequence"(){if(!isFinite(i.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+i.number});return}this.manifest.discontinuitySequence=i.number,m=i.number},"playlist-type"(){if(!/VOD|EVENT/.test(i.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+i.playlist});return}this.manifest.playlistType=i.playlistType},map(){s={},i.uri&&(s.uri=i.uri),i.byterange&&(s.byterange=i.byterange),o&&(s.key=o)},"stream-inf"(){if(this.manifest.playlists=t,this.manifest.mediaGroups=this.manifest.mediaGroups||c,!i.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}n.attributes||(n.attributes={}),x(n.attributes,i.attributes)},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||c,!(i.attributes&&i.attributes.TYPE&&i.attributes["GROUP-ID"]&&i.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}const g=this.manifest.mediaGroups[i.attributes.TYPE];g[i.attributes["GROUP-ID"]]=g[i.attributes["GROUP-ID"]]||{},I=g[i.attributes["GROUP-ID"]],E={default:/yes/i.test(i.attributes.DEFAULT)},E.default?E.autoselect=!0:E.autoselect=/yes/i.test(i.attributes.AUTOSELECT),i.attributes.LANGUAGE&&(E.language=i.attributes.LANGUAGE),i.attributes.URI&&(E.uri=i.attributes.URI),i.attributes["INSTREAM-ID"]&&(E.instreamId=i.attributes["INSTREAM-ID"]),i.attributes.CHARACTERISTICS&&(E.characteristics=i.attributes.CHARACTERISTICS),i.attributes.FORCED&&(E.forced=/yes/i.test(i.attributes.FORCED)),I[i.attributes.NAME]=E},discontinuity(){m+=1,n.discontinuity=!0,this.manifest.discontinuityStarts.push(t.length)},"program-date-time"(){typeof this.manifest.dateTimeString>"u"&&(this.manifest.dateTimeString=i.dateTimeString,this.manifest.dateTimeObject=i.dateTimeObject),n.dateTimeString=i.dateTimeString,n.dateTimeObject=i.dateTimeObject;const{lastProgramDateTime:g}=this;this.lastProgramDateTime=new Date(i.dateTimeString).getTime(),g===null&&this.manifest.segments.reduceRight((u,p)=>(p.programDateTime=u-p.duration*1e3,p.programDateTime),this.lastProgramDateTime)},targetduration(){if(!isFinite(i.duration)||i.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+i.duration});return}this.manifest.targetDuration=i.duration,K.call(this,this.manifest)},start(){if(!i.attributes||isNaN(i.attributes["TIME-OFFSET"])){this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});return}this.manifest.start={timeOffset:i.attributes["TIME-OFFSET"],precise:i.attributes.PRECISE}},"cue-out"(){n.cueOut=i.data},"cue-out-cont"(){n.cueOutCont=i.data},"cue-in"(){n.cueIn=i.data},skip(){this.manifest.skip=v(i.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",i.attributes,["SKIPPED-SEGMENTS"])},part(){f=!0;const g=this.manifest.segments.length,u=v(i.attributes);n.parts=n.parts||[],n.parts.push(u),u.byterange&&(u.byterange.hasOwnProperty("offset")||(u.byterange.offset=R),R=u.byterange.offset+u.byterange.length);const p=n.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${p} for segment #${g}`,i.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((D,h)=>{D.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${h} lacks required attribute(s): LAST-PART`})})},"server-control"(){const g=this.manifest.serverControl=v(i.attributes);g.hasOwnProperty("canBlockReload")||(g.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),K.call(this,this.manifest),g.canSkipDateranges&&!g.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){const g=this.manifest.segments.length,u=v(i.attributes),p=u.type&&u.type==="PART";n.preloadHints=n.preloadHints||[],n.preloadHints.push(u),u.byterange&&(u.byterange.hasOwnProperty("offset")||(u.byterange.offset=p?R:0,p&&(R=u.byterange.offset+u.byterange.length)));const D=n.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${D} for segment #${g}`,i.attributes,["TYPE","URI"]),!!u.type)for(let h=0;h<n.preloadHints.length-1;h++){const U=n.preloadHints[h];U.type&&U.type===u.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${D} for segment #${g} has the same TYPE ${u.type} as preload hint #${h}`})}},"rendition-report"(){const g=v(i.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(g);const u=this.manifest.renditionReports.length-1,p=["LAST-MSN","URI"];f&&p.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${u}`,i.attributes,p)},"part-inf"(){this.manifest.partInf=v(i.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",i.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),K.call(this,this.manifest)},daterange(){this.manifest.dateRanges.push(v(i.attributes));const g=this.manifest.dateRanges.length-1;this.warnOnMissingAttributes_(`#EXT-X-DATERANGE #${g}`,i.attributes,["ID","START-DATE"]);const u=this.manifest.dateRanges[g];u.endDate&&u.startDate&&new Date(u.endDate)<new Date(u.startDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE END-DATE must be equal to or later than the value of the START-DATE"}),u.duration&&u.duration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE DURATION must not be negative"}),u.plannedDuration&&u.plannedDuration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE PLANNED-DURATION must not be negative"});const p=!!u.endOnNext;if(p&&!u.class&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must have a CLASS attribute"}),p&&(u.duration||u.endDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must not contain DURATION or END-DATE attributes"}),u.duration&&u.endDate){const h=u.startDate.getTime()+u.duration*1e3;this.manifest.dateRanges[g].endDate=new Date(h)}if(!S[u.id])S[u.id]=u;else{for(const h in S[u.id])if(u[h]&&JSON.stringify(S[u.id][h])!==JSON.stringify(u[h])){this.trigger("warn",{message:"EXT-X-DATERANGE tags with the same ID in a playlist must have the same attributes values"});break}const D=this.manifest.dateRanges.findIndex(h=>h.id===u.id);this.manifest.dateRanges[D]=x(this.manifest.dateRanges[D],u),S[u.id]=x(S[u.id],u),this.manifest.dateRanges.pop()}},"independent-segments"(){this.manifest.independentSegments=!0},"i-frames-only"(){this.manifest.iFramesOnly=!0,this.requiredCompatibilityversion(this.manifest.version,4)},"content-steering"(){this.manifest.contentSteering=v(i.attributes),this.warnOnMissingAttributes_("#EXT-X-CONTENT-STEERING",i.attributes,["SERVER-URI"])},define(){this.manifest.definitions=this.manifest.definitions||{};const g=(u,p)=>{if(u in this.manifest.definitions){this.trigger("error",{message:`EXT-X-DEFINE: Duplicate name ${u}`});return}this.manifest.definitions[u]=p};if("QUERYPARAM"in i.attributes){if("NAME"in i.attributes||"IMPORT"in i.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}const u=this.params.get(i.attributes.QUERYPARAM);if(!u){this.trigger("error",{message:`EXT-X-DEFINE: No query param ${i.attributes.QUERYPARAM}`});return}g(i.attributes.QUERYPARAM,decodeURIComponent(u));return}if("NAME"in i.attributes){if("IMPORT"in i.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}if(!("VALUE"in i.attributes)||typeof i.attributes.VALUE!="string"){this.trigger("error",{message:`EXT-X-DEFINE: No value for ${i.attributes.NAME}`});return}g(i.attributes.NAME,i.attributes.VALUE);return}if("IMPORT"in i.attributes){if(!this.mainDefinitions[i.attributes.IMPORT]){this.trigger("error",{message:`EXT-X-DEFINE: No value ${i.attributes.IMPORT} to import, or IMPORT used on main playlist`});return}g(i.attributes.IMPORT,this.mainDefinitions[i.attributes.IMPORT]);return}this.trigger("error",{message:"EXT-X-DEFINE: No attribute"})},"i-frame-playlist"(){this.manifest.iFramePlaylists.push({attributes:i.attributes,uri:i.uri,timeline:m}),this.warnOnMissingAttributes_("#EXT-X-I-FRAME-STREAM-INF",i.attributes,["BANDWIDTH","URI"])}}[i.tagType]||d).call(e)},uri(){n.uri=i.uri,t.push(n),this.manifest.targetDuration&&!("duration"in n)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),n.duration=this.manifest.targetDuration),o&&(n.key=o),n.timeline=m,s&&(n.map=s),R=0,this.lastProgramDateTime!==null&&(n.programDateTime=this.lastProgramDateTime,this.lastProgramDateTime+=n.duration*1e3),n={}},comment(){},custom(){i.segment?(n.custom=n.custom||{},n.custom[i.customType]=i.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[i.customType]=i.data)}})[i.type].call(e)})}requiredCompatibilityversion(r,e){(r<e||!r)&&this.trigger("warn",{message:`manifest must be at least version ${e}`})}warnOnMissingAttributes_(r,e,t){const n=[];t.forEach(function(s){e.hasOwnProperty(s)||n.push(s)}),n.length&&this.trigger("warn",{message:`${r} lacks required attribute(s): ${n.join(", ")}`})}push(r){this.lineStream.push(r)}end(){this.lineStream.push(`
`),this.manifest.dateRanges.length&&this.lastProgramDateTime===null&&this.trigger("warn",{message:"A playlist with EXT-X-DATERANGE tag must contain atleast one EXT-X-PROGRAM-DATE-TIME tag"}),this.lastProgramDateTime=null,this.trigger("end")}addParser(r){this.parseStream.addParser(r)}addTagMapper(r){this.parseStream.addTagMapper(r)}}let w=!1;const O=new Set;let T=null,Z=[];async function X(a,r,e){const t=a.startsWith("http")?a:`${r}${a}`,n=await fetch(t,{headers:{Authorization:`Bearer ${e}`}});if(!n.ok)throw new Error(`Failed to fetch ${a}: ${n.statusText}`);return n}async function N(a){return new Promise((r,e)=>{w||a&&O.has(a)?e(new Error("paused")):r()})}function P(a,r){self.postMessage({type:"status",itemId:a,status:r})}const F=new Map,q=new Map;function C(a,r){return`${a}:${r}`}async function k(a,r,e,t){let n=0;for(const s of r){const o=s.path.substring(0,s.path.lastIndexOf("/"));for(const f of s.segments){const d=f.uri.startsWith("http")?f.uri:`${o}/${f.uri}`,c=C(a,d);await T?.match(c)&&(t.add(c),n++)}}return n}async function dt(a,r,e){if(T||(T=await caches.open("offline-content-v1")),await N(a.mediaId),w||O.has(a.mediaId))return!1;const t=new Map;F.has(a.mediaId)||F.set(a.mediaId,new Set);const n=F.get(a.mediaId);q.has(a.mediaId)||q.set(a.mediaId,new Set);const s=q.get(a.mediaId),o=(d,c,l=0)=>{if(!t.has(d)){const m={type:d,total:c,completed:l};t.set(d,m);const b=M();self.postMessage({type:"progress",progress:b.progress,currentItem:b.completedItems,totalItems:b.totalItems,itemProgress:Math.round(l/c*100),assetType:d,assetProgress:Math.round(l/c*100),itemId:a.mediaId,status:"downloading"}),l===c&&d!=="video"&&d!=="audio"&&n.add(d)}},f=d=>{const c=t.get(d);if(c){c.completed++;const l=Math.round(c.completed/c.total*100);l===100&&d!=="video"&&d!=="audio"&&n.add(d);const b=l===100&&!(d==="video"||d==="audio"),R=M();self.postMessage({type:"progress",progress:R.progress,currentItem:R.completedItems,totalItems:R.totalItems,itemProgress:l,assetType:d,assetProgress:l,itemId:a.mediaId,status:b?"completed":"downloading"})}};try{if(await N(a.mediaId),a.mediaPath.includes(".m3u8")){const c=await(await X(a.mediaPath,r,e)).text(),l=new L;l.push(c),l.end();const m=l.manifest,b=a.mediaPath.substring(0,a.mediaPath.lastIndexOf("/"));let R=0;const S=[];if(m.playlists?.length)for(const i of m.playlists){const I=i.uri.startsWith("http")?i.uri:`${b}/${i.uri}`,g=await(await X(I,r,e)).text(),u=new L;u.push(g),u.end(),u.manifest.segments?.length&&(R+=u.manifest.segments.length,S.push({path:I,segments:u.manifest.segments}))}else m.segments?.length&&(R=m.segments.length,S.push({path:a.mediaPath,segments:m.segments}));if(R>0){const i=await k(a.mediaId,S,"video",s);o("video",R,i);for(const I of S){const E=I.path.substring(0,I.path.lastIndexOf("/"));for(const g of I.segments){await N(a.mediaId);const u=g.uri.startsWith("http")?g.uri:`${E}/${g.uri}`,p=C(a.mediaId,u);if(s.has(p))continue;if(await T.match(p)){s.add(p);continue}await N(a.mediaId);const h=await X(u,r,e).then(j=>j.blob()),U=new Response(h.slice(0));await T.put(p,U),s.add(p),f("video")}}}if(m.mediaGroups?.AUDIO){let i=0;const I=[];for(const E of Object.values(m.mediaGroups.AUDIO))for(const g of Object.values(E)){if(!g.uri)continue;const u=g.uri.startsWith("http")?g.uri:`${b}/${g.uri}`,D=await(await X(u,r,e)).text(),h=new L;h.push(D),h.end(),h.manifest.segments?.length&&(i+=h.manifest.segments.length,I.push({path:u,segments:h.manifest.segments}))}if(i>0){const E=await k(a.mediaId,I,"audio",s);o("audio",i,E);for(const g of I){const u=g.path.substring(0,g.path.lastIndexOf("/"));for(const p of g.segments){await N(a.mediaId);const D=p.uri.startsWith("http")?p.uri:`${u}/${p.uri}`,h=C(a.mediaId,D);if(s.has(h))continue;if(await T.match(h)){s.add(h);continue}await N(a.mediaId);const j=await X(D,r,e).then(ct=>ct.blob()),gt=new Response(j.slice(0));await T.put(h,gt),s.add(h),f("audio")}}}}}else{const d=C(a.mediaId,a.mediaPath);if(await T.match(d))n.add("video"),self.postMessage({type:"progress",progress:M().progress,currentItem:M().completedItems,totalItems:M().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:a.mediaId,status:"downloading"});else{const l=`${r}${a.mediaPath}`,m=await fetch(l,{headers:{Authorization:`Bearer ${e}`}});if(!m.ok)throw new Error(`Failed to download video: ${m.statusText}`);await T.put(d,m.clone()),n.add("video"),self.postMessage({type:"progress",progress:M().progress,currentItem:M().completedItems,totalItems:M().totalItems,itemProgress:100,assetType:"video",assetProgress:100,itemId:a.mediaId,status:"downloading"})}}if(a.subtitlePaths?.length){o("subtitle",a.subtitlePaths.length);for(const d of a.subtitlePaths){const c=C(a.mediaId,d);if(!await T.match(c)){await N(a.mediaId);const m=await X(d,r,e);await T.put(c,m.clone())}f("subtitle")}}if(a.previewPaths?.length){o("preview",a.previewPaths.length);for(const d of a.previewPaths){const c=C(a.mediaId,d);if(!await T.match(c)){await N(a.mediaId);const m=await X(d,r,e);await T.put(c,m.clone())}f("preview")}}if(a.fontPaths?.length){let d=0;const c=[];for(const l of a.fontPaths){const b=await(await X(l,r,e)).json();d+=b.length,c.push({path:l,fonts:b})}o("font",d);for(const{path:l,fonts:m}of c){const b=C(a.mediaId,l);if(await T.match(b))m.forEach(()=>f("font"));else{await N(a.mediaId);const S=l.substring(0,l.lastIndexOf("/")+1);for(const i of m){await N(a.mediaId);const I=`${S}fonts/${i.file}`,E=C(a.mediaId,I);if(await T.match(E))f("font");else{const u=await X(I,r,e);await T.put(E,u.clone()),f("font")}}await T.put(b,new Response(JSON.stringify(m)))}}}}catch(d){if(d?.message==="paused")return!1;throw d}}let y=[],G="",B="";async function W(a,r,e){let t=0;for(;t<a.length;){const s=a[t];P(s.mediaId,"downloading"),a.slice(t+1).forEach(o=>{!$.get(o.mediaId)&&!O.has(o.mediaId)&&P(o.mediaId,"waiting")});try{if(w){P(s.mediaId,"paused");return}if(O.has(s.mediaId)){P(s.mediaId,"paused"),t++;continue}if(Z=[{taskIndex:y.indexOf(s),promise:dt(s,r,e)}],P(s.mediaId,"downloading"),await Z[0].promise===!1){if(P(s.mediaId,"paused"),w)return;t++}else P(s.mediaId,"completed"),t++}catch(o){if(o?.message==="paused"){if(P(s.mediaId,"paused"),w)return;t++}else throw P(s.mediaId,"error"),o}}if(a.filter(s=>O.has(s.mediaId)).length===0){const s=M();self.postMessage({type:"complete",progress:s.progress,currentItem:s.completedItems,totalItems:s.totalItems})}}const $=new Map;function M(){const a=Array.from($.values()).filter(e=>e).length;let r=0;return y.forEach(e=>{if($.get(e.mediaId))r+=100;else if(F.has(e.mediaId)){const t=new Set(["video"]);e.subtitlePaths?.length&&t.add("subtitle"),e.fontPaths?.length&&t.add("font"),e.previewPaths?.length&&t.add("preview");const n=F.get(e.mediaId),s=Array.from(t).filter(o=>n.has(o)).length;r+=s/t.size*100}}),{progress:Math.round(r/y.length),completedItems:a,totalItems:y.length}}self.onmessage=async a=>{const{tasks:r,controls:e}=a.data;if(r&&(y=r,G=a.data.baseUrl,B=a.data.token,$.clear(),O.clear()),e){const{type:n,itemId:s}=e;switch(n){case"pause":w=!0,y.forEach(d=>{$.get(d.mediaId)||(O.add(d.mediaId),self.postMessage({type:"status",itemId:d.mediaId,status:"paused"}))});break;case"resume":w=!1,O.clear();const o=e.pausedIds||[],f=y.filter(d=>!$.get(d.mediaId)&&o.includes(d.mediaId));if(f.length){f.forEach(d=>{P(d.mediaId,"pending")});try{await W(f,G,B)}catch(d){console.error("Failed to resume queue:",d)}}break;case"pauseItem":s&&(O.add(s),P(s,"paused"));break;case"resumeItem":if(s){O.delete(s),P(s,"pending");const d=y.find(c=>c.mediaId===s);if(d&&!$.get(d.mediaId))try{const c=w;w=!1,await W([d],G,B),w=c}catch(c){console.error("Failed to resume item:",c),P(s,"error")}}break}return}const t=r.filter(n=>!$.get(n.mediaId));await W(t,G,B)}})();
