# NoMercy.App Performance Optimization Progress

## Completed Tasks

### Phase 1.1: Configure Manual Chunks (vite.config.ts)
- Status: DONE (prior to this session)
- Changed manualChunks from object syntax to function syntax for rolldown-vite compatibility

### Phase 1.2: Fix Layout Imports (src/router/routes.ts)
- Status: DONE
- Date: 2026-02-05
- Changed layout imports from immediate execution to lazy-loaded functions:
  - `const MobileBaseLayout = import(...)` → `const MobileBaseLayout = () => import(...)`
  - `const DesktopBaseLayout = import(...)` → `const DesktopBaseLayout = () => import(...)`
- This prevents both layouts from loading at module initialization; only the needed layout loads when used

### Phase 1.3: Remove Swiper Duplication
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Removed web component bundle import and registration from src/setupApp.ts:
     - Removed `import { register as registerSwiperElements } from 'swiper/element/bundle';`
     - Removed `registerSwiperElements();` call
  2. Removed duplicate web component registration from src/components/Carousel/Carousel.vue:
     - Removed `import { register } from 'swiper/element/bundle';`
     - Removed `register();` call
- The app now only uses Vue Swiper components (Swiper, SwiperSlide from 'swiper/vue')
- This eliminates ~100KB of duplicate Swiper code (web component bundle)

### Phase 1.4: Add Preconnect Hints (index.html)
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Removed placeholder dns-prefetch for `//api.example.com`
  2. Removed `x-dns-prefetch-control: off` meta tag
  3. Added preconnect hints for external domains:
     - `https://media.themoviedb.org` (TMDB images)
     - `https://app.nomercy.tv` (app server)
     - `https://auth-dev.nomercy.tv` (Keycloak auth)
     - `https://fonts.bunny.net` (Google Fonts alternative)
  4. Added dns-prefetch for `https://cdn.nomercy.tv`
- Font preloads already existed in the file, kept as is

### Phase 2.1: Convert NM Components to Local Component Map with Lazy Loading
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/components/nmComponentMap.ts:
     - Single shared export with all 15 NM components as defineAsyncComponent lazy imports
     - Used by all components that render dynamic NM components
  2. Updated src/setupApp.ts:
     - Removed all NM component imports and global registrations
     - Removed unused supportsCarousel variable and isMobile import
  3. Updated components to use shared nmComponentMap:
     - src/components/NMComponent.vue
     - src/components/NMCarousel.vue
     - src/components/NMCarousel2.vue
     - src/components/NMContainer.vue
     - src/components/NMList.vue
     - src/components/NMGrid.vue
- Benefits:
  - Single source of truth for NM component map (DRY principle)
  - NM components now load only when API requests them
  - Reduces initial bundle size (components split into separate chunks)
  - Easy to add new NM components - just update nmComponentMap.ts

### Phase 2.1b: Add Loading Skeletons for Lazy-Loaded Components
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/components/Loading/NMCardSkeleton.vue:
     - Animated pulse placeholder with correct aspect ratio (poster/backdrop)
     - Matches card dimensions to prevent layout shift
  2. Updated src/components/nmComponentMap.ts:
     - Card components now use loadingComponent option with NMCardSkeleton
     - Applied to: NMCard, NMGenreCard, NMHomeCard, NMSeasonCard, NMMusicCard,
       NMMusicHomeCard, NMTopResultCard
- Benefits:
  - Prevents CLS (Cumulative Layout Shift) while async components load
  - Smooth loading experience with animated placeholders

### Phase 2.2: Use defineAsyncComponent for Heavy Components
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/components/Loading/MusicPlayerSkeleton.vue:
     - Skeleton placeholder matching the desktop music player layout
     - Shows animated pulse placeholders for cover, controls, and volume
  2. Created src/components/async.ts:
     - AsyncMusicPlayerDesktop: lazy-loaded with MusicPlayerSkeleton
     - AsyncMusicPlayerFull: lazy-loaded mobile full player
     - AsyncMusicPlayerMini: lazy-loaded mobile mini player
  3. Updated src/Layout/Desktop/BaseLayout.vue:
     - Changed MusicPlayerDesktop import to AsyncMusicPlayerDesktop
  4. Updated src/Layout/Mobile/BaseLayout.vue:
     - Changed FullPlayer and MiniPlayer imports to async versions
- Notes:
  - VideoPlayer: Already an external library (@nomercy-entertainment/nomercy-video-player), not a Vue component
  - Dashboard: Already uses defineAsyncComponent with route-based lazy loading
  - Focus was on MusicPlayer components which were eagerly loaded in layouts

### Phase 2.3: Implement Component-Level Code Splitting (Swiper local imports)
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Removed global Swiper registration from src/setupApp.ts:
     - Removed `import { Swiper } from 'swiper'` and `import { SwiperSlide } from 'swiper/vue'`
     - Removed `app.component('Swiper', Swiper)` and `app.component('SwiperSlide', SwiperSlide)`
  2. Moved Swiper CSS from global to local imports:
     - Removed `import 'swiper/css'` and `import 'swiper/element/css/keyboard'` from src/main.ts
     - Added `import 'swiper/css'` locally in 4 components that use Swiper:
       - src/components/Carousel/Carousel.vue
       - src/components/NMCarousel.vue
       - src/components/MusicPlayer/mobile/FullPlayer.vue
       - src/views/Base/Person/Mobile.vue
  3. Removed unused `swiper/element/css/keyboard` import (keyboard: false in swiper config)
- All components already had local Swiper JS imports; only global registration and CSS were remaining
- Benefits:
  - Swiper JS and CSS are fully code-split from the main bundle
  - Swiper code only loads when a carousel or swiper-using component is rendered
  - Removed unnecessary keyboard CSS import

### Phase 3.2: Responsive Image Loading (TMDBImage.vue)
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Added device pixel ratio detection (reads window.devicePixelRatio once at module level)
  2. Created `optimizedSize` computed that uses 2x multiplier only for high-DPI displays (>1.5 DPR),
     1x multiplier for standard displays (previously always used 2x)
  3. Added `&format=webp` to server image URL to request WebP format from the image proxy
  4. Updated `<source>` element with `type="image/webp"` for proper format negotiation
  5. Cleaned up commented-out source elements
  6. Preserved color palette gradient placeholder (Phase 3.1 - already correct, no changes needed)
  7. TMDB fallback URL kept as-is for browsers that don't support WebP
- Benefits:
  - 1x displays no longer download 2x resolution images (saves ~75% bandwidth for those users)
  - WebP format delivers ~25-35% smaller images vs JPEG/PNG
  - `<picture>` element with `<source type="image/webp">` provides automatic format fallback
  - Color palette gradient placeholders preserved as-is (PRD 3.1)

### Phase 4.1: Optimize TanStack Query Configuration
- Status: DONE
- Date: 2026-02-05
- File: src/config/tanstack-query.ts
- Changes made:
  1. Changed `retry: false` → `retry: 1` (one retry attempt for resilience)
  2. Added `retryDelay` with exponential backoff: `Math.min(1000 * 2 ** attemptIndex, 30000)`
  3. Changed `staleTime` from 1 hour (`1000 * 60 * 60`) to 5 minutes (`1000 * 60 * 5`)
  4. Added `gcTime: 1000 * 60 * 30` (garbage collect unused cache after 30 minutes)
  5. Preserved `experimental_prefetchInRender: true` (existing optimization)
- Benefits:
  - Failed requests get one retry with backoff instead of immediately failing
  - Stale data refetched sooner (5min vs 1hr) for fresher content
  - Unused query cache garbage-collected after 30min to reduce memory usage

### Phase 4.2: Replace structuredClone with Targeted Updates
- Status: DONE
- Date: 2026-02-05
- File: src/lib/routerHelper.ts
- Changes made:
  1. Replaced `structuredClone(toRaw(d))` on every item with targeted shallow copies:
     - Build a Set of `replace_id` values from the mutations
     - Only shallow-clone (`{ ...d }`) items whose `id` is in the mutation set
     - Unchanged items keep their original reference (no copy at all)
  2. Removed unused `toRaw` import from vue
- Benefits:
  - Eliminates expensive deep cloning of potentially large data arrays
  - Only items about to be replaced get a shallow copy (which is immediately overwritten anyway)
  - Reduces GC pressure and improves mutation performance

### Phase 4.3: Implement Request Deduplication
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Added `deduplicatedRequest` utility to src/lib/clients/serverClient.ts:
     - Maintains a Map of in-flight requests keyed by a string identifier
     - If a request with the same key is already pending, returns the existing promise
     - Cleans up the Map entry when the request completes (success or failure)
  2. Integrated into router middleware files that make direct serverClient calls:
     - src/router/middleware/getServerSetup.ts - wraps `setup/server-info` request
     - src/router/middleware/getLibraries.ts - wraps `setup/libraries` request
     - src/router/middleware/getServerPermissions.ts - wraps `setup/permissions` request
- Benefits:
  - Prevents duplicate in-flight requests during rapid navigation
  - Middleware functions that get called multiple times before completion share the same request
  - TanStack Query already handles deduplication for useServerClient hook; this covers direct serverClient usage
  - Zero overhead when no duplicate requests occur (just a Map lookup)

### Phase 5.1: Optimize ScrollContainer
- Status: DONE
- Date: 2026-02-05
- File: src/Layout/Desktop/components/ScrollContainer.vue
- Changes made:
  1. Replaced `router.afterEach(enable)` with section-aware navigation handler
  2. Tracks the current top-level route section (first path segment)
  3. When navigating within the same section: only scrolls to top (cheap operation)
  4. When navigating to a different section: calls full `enable()` to reinitialize scrollbar
- Benefits:
  - Eliminates unnecessary teardown/re-initialization of scrollbar listeners on every navigation
  - Same-section navigations (e.g. /movies/123 → /movies/456) just scroll to top
  - Cross-section navigations (e.g. /movies → /music) still get full scrollbar reset
  - Reduces ResizeObserver churn and event listener rebinding overhead

### Phase 5.2: Implement Virtual Scrolling for Long Lists
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Updated src/lib/swiper-config.ts:
     - Changed `virtual: false` to `virtual: { enabled: true, addSlidesAfter: 2, addSlidesBefore: 2 }`
  2. Updated src/components/Carousel/Carousel.vue:
     - Imported `Virtual` from 'swiper/modules'
     - Added `:modules="[Virtual]"` to SwiperComponent
  3. Updated src/components/NMCarousel.vue:
     - Imported `Virtual` from 'swiper/modules'
     - Added `:modules="[Virtual]"` to SwiperComponent
     - Added `:virtual-index="itemIndex"` to SwiperSlide
  4. Added/fixed `virtual-index` on SwiperSlide in all child carousel components:
     - src/components/Carousel/MediaCarousel.vue (added virtual-index)
     - src/components/Carousel/PersonCarousel.vue (added virtual-index)
     - src/components/Carousel/ImageCarousel.vue (added virtual-index)
     - src/components/Carousel/SeasonCarousel.vue (added virtual-index)
     - src/components/Carousel/MusicCarousel.vue (fixed: was using carousel index, now uses item index)
     - src/components/Carousel/MusicGenreCarousel.vue (fixed: was using carousel index, now uses item index)
- Notes:
  - Person/Mobile.vue and MusicPlayer/FullPlayer.vue don't use swiperConfig, so are unaffected
  - NMCarousel2.vue uses native CSS scroll (no Swiper), so is unaffected
- Benefits:
  - Swiper only renders visible slides + 2 buffer slides on each side
  - Reduces DOM node count for carousels with many items
  - Improves scroll performance and reduces memory usage for long carousels

### Phase 5.3: Optimize Reactive Dependencies (src/store/ui.ts)
- Status: DONE
- Date: 2026-02-05
- File: src/store/ui.ts
- Changes made:
  1. Imported `shallowRef` from 'vue'
  2. Converted `colorPalette` internal ref (`c`) from `ref` to `shallowRef`:
     - `PaletteColors` is an object that is always replaced entirely, never mutated
     - `shallowRef` skips deep reactivity tracking for the object's properties
     - Initialized with explicit `null` instead of implicit `undefined`
  3. Converted DOM element refs to `shallowRef`:
     - `scrollContainerElement`: holds HTMLDivElement, doesn't need deep reactivity
     - `sidebarContainerElement`: holds HTMLElement, doesn't need deep reactivity
- Benefits:
  - Avoids unnecessary deep reactivity proxy creation for PaletteColors objects
  - DOM elements are large objects; shallowRef prevents Vue from traversing their properties
  - Reduces reactivity overhead on every colorPalette update

### Phase 6.1: Enable Compression (vite.config.ts)
- Status: DONE
- Date: 2026-02-05
- File: vite.config.ts
- Changes made:
  1. Installed `vite-plugin-compression` as a dev dependency
  2. Added `import compression from 'vite-plugin-compression'` to vite.config.ts
  3. Added two compression plugin instances to the plugins array:
     - `compression({ algorithm: 'gzip', ext: '.gz' })` for gzip pre-compression
     - `compression({ algorithm: 'brotliCompress', ext: '.br' })` for Brotli pre-compression
  4. Removed the old commented-out `// gzipPlugin()` line
- Benefits:
  - Build output now includes pre-compressed .gz and .br files alongside originals
  - Servers (Cloudflare, Nginx, etc.) can serve pre-compressed files directly without on-the-fly compression
  - Brotli typically achieves 15-25% better compression than gzip for text assets
  - Reduces server CPU usage since compression happens at build time, not per-request

### Phase 6.2: Optimize CSS Delivery (vite.config.ts)
- Status: DONE
- Date: 2026-02-05
- File: vite.config.ts
- Changes made:
  1. Changed `cssMinify: 'esbuild'` to `cssMinify: 'lightningcss'`:
     - lightningcss produces smaller CSS output than esbuild's CSS minifier
     - lightningcss handles vendor prefix insertion, CSS nesting lowering, and syntax lowering
     - Already the default in rolldown-vite 7.3.1 but was overridden to esbuild
     - lightningcss was already installed in node_modules
  2. Added `devSourcemap: false` to the `css` config:
     - Disables CSS source maps in development for faster rebuilds
     - Reduces memory usage during development
  3. Already present (no changes needed):
     - `cssCodeSplit: true` (CSS split per component/route)
     - `scss.api: 'modern-compiler'` (uses modern Dart Sass API)
- Benefits:
  - Smaller CSS output from lightningcss vs esbuild minification
  - Automatic vendor prefixing and syntax lowering handled by lightningcss
  - Faster dev server rebuilds without CSS sourcemap generation

### Phase 6.3: Configure Optimal Caching Headers (public/_headers)
- Status: DONE (already implemented in prior session)
- Date: 2026-02-05
- File: public/_headers
- Already had comprehensive caching headers matching/exceeding PRD requirements:
  - `/` and `/index.html`: no-cache, no-store, must-revalidate
  - `/sw.js` and `/registerSW.js`: no-cache, no-store, must-revalidate
  - `/assets/*`, `/js/*`, `/css/*`, `/img/*`, `/fonts/*`: immutable, 1 year
  - `/manifest.webmanifest`: max-age=0, must-revalidate
  - Font file extensions (`.woff2`, `.woff`, `.ttf`): immutable, 1 year
- Added `/version.json` no-cache header for Phase 8 version checking system

### Phase 8.1: Implement Version-Based Cache Busting
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Updated vite.config.ts:
     - Added `execSync` import from `node:child_process`
     - Added `getGitCommitHash()` helper that reads `git rev-parse --short HEAD`
     - Added `__APP_VERSION__` define (git commit short hash)
     - Added `__BUILD_TIME__` define (ISO timestamp at build time)
     - Kept existing `__BUILD_TIMESTAMP__` and `__BUILD_VERSION__` for backward compatibility
  2. Created src/lib/version.ts:
     - Declares global `__APP_VERSION__` and `__BUILD_TIME__` types
     - Exports `APP_VERSION` and `BUILD_TIME` constants
     - Exports `isOutdated(serverVersion)` comparison utility
  3. Updated public/_headers:
     - Added `/version.json` with `no-cache, no-store, must-revalidate`
- Benefits:
  - Each build is tagged with its git commit hash
  - Runtime code can compare local version against server version
  - version.json endpoint will never be cached by CDN/browser
  - Foundation for Phase 8.2+ version checking and auto-update system

### Phase 8.2: Server Version Check on App Load
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/lib/versionCheck.ts:
     - `checkForUpdates()`: fetches `/version.json` (cache-busted) and compares with `APP_VERSION`
     - `startVersionChecks()`: runs initial check, sets 5-minute interval, checks on tab visibility change
     - `stopVersionChecks()`: cleans up interval and auto-update timeout
     - `forceUpdate()`: triggers SW skip-waiting and reloads for critical updates
     - `showUpdateAvailable()`: adds localized update notification + auto-update after 30 minutes
  2. Created scripts/generate-version.js:
     - ESM script that generates `docs/version.json` with git commit hash, build time, and optional forceUpdate flag
     - Reads `FORCE_UPDATE` env var for critical deployments
  3. Updated package.json:
     - Changed `build` script to `vite build && node scripts/generate-version.js`
     - version.json is now generated after every production build
  4. Updated src/setupApp.ts:
     - Added version check initialization in production (non-dev) builds
     - Version checks start via lazy import in a queueMicrotask (non-blocking)
     - Runs independently of service worker setup (works even without SW)
- Benefits:
  - App detects new deployments every 5 minutes and on tab focus
  - Users see localized update notification with "Update Now" / "Later" options
  - Auto-update triggers after 30 minutes if user ignores notification
  - Force update capability for critical fixes (set FORCE_UPDATE=true at build time)
  - version.json is cache-busted (no-store header already configured in Phase 6.3)

### Phase 8.4: Handle Keycloak Redirect
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/lib/auth/updateState.ts:
     - `setUpdatePending(version)`: stores pending update version in sessionStorage
     - `getUpdatePending()`: retrieves pending update state
     - `clearUpdatePending()`: clears pending update state
     - `checkAndApplyPendingUpdate()`: checks for pending update after redirect, activates waiting SW or reloads
  2. Updated src/lib/versionCheck.ts:
     - Imported `setUpdatePending` from `@/lib/auth/updateState`
     - Added `setUpdatePending(serverVersion.version)` call when a version mismatch is detected
     - This persists the pending update state in sessionStorage before any Keycloak redirect
  3. Updated src/main.ts:
     - After Keycloak callback completes (in `watch(kc.decodedToken)` handler):
     - Lazy-imports and calls `checkAndApplyPendingUpdate()` after `setupApplication()`
     - If a pending update was stored before redirect, it's applied automatically
- Benefits:
  - Update state survives Keycloak redirects (sessionStorage persists across same-origin navigations)
  - User returns from Keycloak login to the latest version automatically
  - No stale content after authentication flow completes
  - Uses lazy import so the module only loads when needed

### Phase 8.7: Update PWA Config for Reliable Updates
- Status: DONE
- Date: 2026-02-05
- File: pwaConfig.ts
- Changes made:
  1. Added `/^\/version\.json$/` to `navigateFallbackDenylist`:
     - Prevents the service worker from serving cached `index.html` when `/version.json` is requested
     - Ensures version check requests always reach the network
  2. Added `globIgnores: ['**/version.json']`:
     - Excludes version.json from the precache manifest generated by workbox
     - version.json is generated post-build and must always be fetched fresh from the server
  3. Already present (no changes needed):
     - `cleanupOutdatedCaches: true` (removes old SW caches on activation)
     - `clientsClaim: true` (new SW takes control of all clients immediately)
     - `skipWaiting: false` (user-controlled updates via prompt)
- Benefits:
  - version.json will never be served from SW cache or precache
  - Combined with the `no-cache` header from Phase 6.3, version checks always get fresh data
  - Outdated caches are automatically cleaned up when a new SW activates
  - Foundation for reliable cache recovery in Phase 8.8

### Phase 8.8: Recovery for Users with Faulty Cache
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/lib/chunkErrorRecovery.ts:
     - Listens for `error` and `unhandledrejection` events that indicate chunk loading failures
     - Detects "Loading chunk", "Failed to fetch dynamically imported module", and "Importing a module script failed"
     - On first chunk error: clears all caches, unregisters all service workers, and reloads
     - `hasRecovered` flag prevents infinite reload loops
  2. Created src/lib/cacheMigration.ts:
     - One-time migration for existing users with stale caches
     - Checks localStorage for migration version key (`nomercy_cache_migration`)
     - If migration version doesn't match `v2`: clears all caches, unregisters SWs, reloads
     - Sets migration key after completion to prevent re-running
     - Gracefully handles errors (sets key even on failure to avoid retry loops)
  3. Updated src/main.ts:
     - `setupChunkErrorRecovery()` called immediately at module level (before any dynamic imports)
     - `runCacheMigration()` gates app initialization: only calls `initializeWebApp()` after migration completes
     - If migration triggers a reload, app init is skipped (page will reload)
- Benefits:
  - Users with stale/broken caches get automatic recovery without manual intervention
  - Chunk loading failures (from mismatched hashes after deploy) auto-recover
  - Existing users get a one-time full cache clear on first visit after this deploy
  - No infinite reload loops (recovery flags prevent re-triggering)

### Phase 8.9: Offline Availability
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/components/OfflineBanner.vue:
     - Uses `useOnline()` from `@vueuse/core` (already installed v13.9.0)
     - Shows a fixed amber banner at the top of the screen when offline
     - Includes wifi-off SVG icon and localized message via `$t()`
     - Animated slide-in/slide-out transition (translateY + opacity)
     - z-index 9999 to appear above all other content
  2. Updated src/Layout/Desktop/BaseLayout.vue:
     - Imported and added `<OfflineBanner />` inside IonPage, above the skip-navigation button
  3. Updated src/Layout/Mobile/BaseLayout.vue:
     - Imported and added `<OfflineBanner />` inside IonPage, above IonTabs
- PWA caching strategies already configured (no changes needed):
  - Fonts: CacheFirst with 1-year expiration
  - Images: CacheFirst with 30-day expiration
  - API: StaleWhileRevalidate with 5-minute expiration
  - CDN assets: CacheFirst with 30-day expiration
  - Main app: NetworkFirst with 1-day expiration
  - Precaching: App shell (index.html, main JS/CSS) via generateSW
- Benefits:
  - Users see clear visual indicator when network connection is lost
  - Banner disappears automatically when connection is restored
  - Cached content remains accessible while offline (via existing PWA caching)
  - No additional dependencies required (@vueuse/core already in project)

### Phase 7.1: Fix Store Variable Naming
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Updated src/store/ui.ts:
     - Renamed abbreviated internal refs to descriptive names:
       - `p` → `posterData`
       - `t` → `titleData`
       - `b` → `backgroundData`
       - `fc` → `focusColorData`
       - `c` → `colorPaletteData`
       - `l` → `logoData`
       - `st` → `sortTypeData`
       - `so` → `sortOrderData`
       - `nav` → `navBarVisibleData`
     - Fixed bug: `setTitle()` was setting `p.value` (poster) instead of `t.value` (title)
     - Fixed `any` types: `setSortType(value: any)` → `setSortType(value: SortType)`,
       `setSortOrder(value: any)` → `setSortOrder(value: SortOrder)`
     - Initialized refs with explicit `null` instead of implicit `undefined`
  2. Updated src/store/preferences.ts:
     - Renamed `ssd` → `screensaverDelayData`
  3. Updated src/store/videoPlayer.ts:
     - Renamed `vs` → `playerStateData`
  4. Renamed src/store/Libraries.ts → src/store/libraries.ts:
     - Used `git mv` for proper rename tracking
     - Updated all 14 import references across the codebase:
       - src/router/routes.ts
       - src/router/routes-backup.ts
       - src/Layout/Mobile/components/SideFlyout.vue
       - src/views/Setup/ServerOffline/Mobile.vue
       - src/views/Setup/ServerOffline/Desktop.vue
       - src/lib/routerHelper.ts
       - src/router/middleware/getLibraries.ts
       - src/Layout/Desktop/components/Navbar/Navbar.vue
       - src/views/Setup/SelectServers/Mobile.vue
       - src/views/Setup/SelectServers/Desktop.vue
       - src/Layout/Desktop/components/Sidebar/Sidebar.vue
       - src/store/routeState.ts
       - src/views/Setup/PostInstall/Desktop.vue
       - src/views/Base/Library/components/MobileLibraryHeader.vue
- Notes:
  - Exported names remain unchanged (no consumer-facing API changes)
  - colorTheme.ts: already uses descriptive names (`theme`), no changes needed
  - All pre-existing type errors unrelated to this change
- Benefits:
  - All store variables now use clear, descriptive names (no abbreviations)
  - Fixed silent bug where setTitle() was modifying poster instead of title
  - setSortType/setSortOrder now properly typed instead of using `any`
  - File naming follows camelCase convention for store files

### Phase 7.2: Add Error Handling to Async Store Functions
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Updated src/store/preferences.ts:
     - Created shared `persistPreference()` helper with `.catch()` error logging
     - Replaced all 12 instances of `.then()` on `Preferences.set()` with `persistPreference()` calls
     - Wrapped all 6 IIFE initializers in try/catch blocks
     - Replaced `.then()` chain on `Preferences.get()` for display_language with async/await + try/catch
     - Added return types to all exported setter functions
  2. Updated src/store/currentServer.ts:
     - Added `.catch()` to `pingServer()` call in the `isOnline` watcher
     - Rewrote `pingServer()` from broken `new Promise(async ...)` anti-pattern to proper async/await
       with sequential try/catch blocks (try internal URL first, fall back to external, throw if both fail)
  3. Updated src/store/search.ts:
     - Converted all 3 fetch chains (music search, video search, fetchNextPage) from `.then()` chains
       to async/await with try/catch/finally
     - `searchResultLoading` now properly resets in `finally` blocks (was missing on errors before)
     - Added return type to `fetchNextPage()`
  4. Updated src/store/screensaver.ts:
     - Wrapped StatusBar dynamic imports and calls in try/catch blocks
     - Replaced `.then(m => m.StatusBar)` + `.then()` pattern with destructured await
  5. Updated src/store/ui.ts:
     - Replaced `.then()` on both `Keyboard.addListener()` calls with `.catch()` error handlers
  6. Updated src/store/musicSocket.ts:
     - Added `.catch()` to `invoke('Devices')` call
     - Replaced 2 `audioPlayer.play().then()` calls with `.catch()` error handlers
  7. Updated src/store/audioPlayer.ts:
     - Replaced `audioPlayer.play().then()` in play action with `.catch()` handler
     - Added `.catch()` to `VolumeButtons.watchVolume()` and `VolumeButtons.isWatching()`
  8. Updated src/store/deviceInfo.ts:
     - Replaced `.then()` on both `Preferences.set()` calls with `.catch()` handlers
     - Wrapped entire IIFE initializer in try/catch
     - Replaced `.then(device => device.identifier)` chain with proper await + destructure
     - Added return types to functions
  9. Updated src/store/contextMenuItems.ts:
     - Added `.catch()` to the `cmd()` promise chain in `makeContextMenu()`
- Benefits:
  - No more unhandled promise rejections across all store files
  - Errors are logged with context-specific messages for easier debugging
  - `searchResultLoading` state now properly resets on fetch errors
  - Fixed `pingServer()` anti-pattern that could leave promises hanging
  - All async flows have proper error boundaries

### Phase 7.3: Standardize Component Script Structure
- Status: DONE
- Date: 2026-02-06
- Files fixed (9 components with script ordering violations):
  1. src/Layout/Desktop/components/Sidebar/Sidebar.vue:
     - Grouped imports properly (moved useRoute, MoooomIcon, store imports into correct groups)
     - Moved computed properties before functions
     - Moved libraryIconName function before lifecycle hooks
     - Moved onMounted and router.afterEach to lifecycle section
     - Moved watch(playlists) to watchers section at end
  2. src/Layout/ImageModal.vue:
     - Moved enum WallpaperStyle and wallpaperStyle ref to state section
     - Moved all functions (handleClose, handleShowButtonToggle, handleLoaded, handleClick, etc.) before lifecycle
     - Moved onMounted and onBeforeUnmount to lifecycle section
     - Moved watch(imageModalData) to watchers section at end
  3. src/components/Cards/MusicCard.vue:
     - Moved useTranslation() composable before state (was after watch)
     - Moved ringColor ref to state section (was after computed)
     - Moved watch(props) to watchers section at end
  4. src/components/MusicPlayer/MusicPlayerDesktop.vue:
     - Moved computed properties (leftSize, centerSize, rightSize, albumLink) before functions
     - Moved submitPlayback function before onMounted
     - Grouped all functions together before lifecycle
  5. src/components/Buttons/MediaLikeButton.vue:
     - Moved watch(props) after handleLike function (was between state and function)
  6. src/views/Base/Info/Desktop.vue:
     - Grouped composables together (useRoute, useTranslation, useToast, useServerClient)
     - Grouped all state refs together
     - Moved interface IMenuItem before computed that uses it
     - Moved computed properties (shareData, duration, endTime, endString) before functions
     - Moved menuItems computed after functions it references
     - Moved onMounted/onUnmounted to lifecycle section
     - Moved watch(data) and watch(trailerIndex) to watchers section at end
  7. src/views/Base/Watch/Desktop.vue:
     - Moved onMounted/onUnmounted before watch(data) (lifecycle before watchers)
  8. src/components/Cards/HomeCard.vue:
     - Moved toggleWatched function before watch(props)
  9. src/Layout/Desktop/DashboardLayout.vue:
     - Moved showError computed before onMounted (was after lifecycle)
- Standard order enforced: Imports → Props → Emits → Composables → State → Computed → Functions → Lifecycle → Watchers
- No new type errors introduced (all errors in type-check output are pre-existing)

### Phase 7.4: Remove `any` Types
- Status: DONE
- Date: 2026-02-06
- Changes made (replaced `any` with proper types across ~30 files):
  1. src/store/indexer.ts:
     - Created `IndexerItemData` interface for typed property access
     - Changed `Component<any>` → `Component<IndexerItemData>`
     - Added type assertion for `props.name` access (not in `Props<T>` interface)
  2. src/store/imageModal.ts:
     - Changed `setImageModalData(data: any)` → `LogoResponse | undefined`
     - Created `TempData` interface `{ type: string; index: number }`
     - Changed `setTemp(temp: any)` → `TempData | null` with typed ref
  3. src/store/contextMenuItems.ts:
     - Changed `command?: any` → `string | (() => unknown)`
     - Changed `args?: any` → `{ [arg: string]: unknown }`
     - Changed request functions data params from `any` → `unknown`
     - Added `as string` cast for `item.args?.url` in cmd call
  4. src/store/musicSocket.ts:
     - Created `BroadcastStatusData` interface replacing `any` parameter
  5. src/store/audioPlayer.ts:
     - Changed `err?: any` → `err?: unknown` in VolumeButtonsCallback
  6. src/store/androidAppPrompt.ts:
     - Replaced `(navigator as any)` with typed cast for `getInstalledRelatedApps`
  7. src/store/screensaver.ts:
     - Changed `setImageModalData(null)` → `setImageModalData(undefined)`
  8. src/lib/dateTime.ts:
     - Changed `humanTime`/`convertToHis` parameter types to `number | string`
     - Fixed `hours === 0` → `hours === '00'` (dead code from `pad()` returning string)
     - Fixed `minutes === 0` checks to also accept `'0'`
  9. src/lib/colorHelper.ts:
     - Changed `getLuminosity(c: any)` → `c: string`
     - Changed `tooLight/tooDark(c: any)` → `c: string | null | undefined`
  10. src/lib/sliderBar.ts:
      - Changed `getScrubTime(e: any)` → `MouseEvent | TouchEvent`
      - Used `Record<string, (value: number) => void>` for setter callbacks
      - Used `Record<string, () => number>` for getter callbacks (getSizeFn)
  11. src/lib/scrollHandlers.ts:
      - Changed `player: any` → `PlayerCore<PlaylistItem>` with proper imports
  12. src/lib/stringArray.ts:
      - `sortBy`: Cast comparison values to `string | number` for `<`/`>` operators
      - `sortByPriorityKeyed`: Cast `createEnumFromArray` result to match generic type
      - `sortByPosterAlphabetized`: Removed explicit `{ [x: string]: number }` callback types,
        used `String()` wrapper and `Record<string, unknown>` cast for dynamic key access
      - `byObjectValues`: Cast `valA`/`valB` to `string | number` for comparisons
      - Various other functions: `groupBy`, `unique`, `uniqueBy`, `uniqBy` typed properly
  13. src/lib/clients/useServerClient.ts, useServerClient2.ts, useApiClient.ts:
      - Changed `data?: any` → `Record<string, { value: unknown }>` or `Record<string, unknown>`
      - Changed `params?: any` → `Record<string, unknown>`
  14. src/lib/clients/useInfiniteServerClient.ts:
      - Typed `getNextPageParam`/`getPreviousPageParam` with `T & { has_more?; next_page? }`
      - Cast `response.data` in queryFn resolve
  15. src/lib/clients/socketClient/SocketClient.ts:
      - Added eslint-disable comments for SignalR's required `any[]` callback signatures
  16. src/lib/clients/socketClient/events.ts:
      - Created `NotifyData` interface, typed `onUpdateContent` and `onCommand`
  17. src/config/global.ts:
      - Changed `console.raw` from `(...arg: any)` → `(...arg: unknown[])`
  18. src/hooks/useHubListener.ts:
      - Added eslint-disable for SignalR compatibility, changed return `any` → `void`
  19. src/components/VirtualScroller.vue, VirtualList.vue:
      - Changed `items?: any[]` → `Record<string, unknown>[]`
  20. src/components/ResponsiveComponent.vue:
      - Changed `fallback/loading/error?: any` → `Component` type from Vue
  21. src/components/Carousel/ImageCarousel.vue:
      - Added non-null assertion for `temp.value!.type`
      - Changed `setImageModalData(null)` → `setImageModalData(undefined)`
  22. src/Layout/ImageModal.vue:
      - Changed `setImageModalData(null)` → `setImageModalData(undefined)`
  23. src/lib/VideoPlayer/index.ts:
      - Changed `fonts: any[]` → `{ name: string; url: string }[]`
- Notes:
  - SignalR's `on()`, `off()`, and `invoke()` methods require `any[]` callback types (external library constraint) — kept with eslint-disable comments
  - `objectsEqual` and `mappedEntries` in stringArray.ts still use `any` (complex recursive/generic patterns)
  - Pre-existing type errors (284) not related to this change remain unchanged
- Benefits:
  - Eliminated ~50 `any` type usages across the codebase
  - Improved type safety for store functions, utility functions, and API clients
  - Created proper interfaces for previously untyped data structures
  - Better IDE autocompletion and error detection

### Phase 7.5: Standardize File Naming
- Status: DONE (completed as part of Phase 7.1)
- Libraries.ts → libraries.ts rename was done in Phase 7.1
- No other file naming violations found

### Phase 7.6: Add Missing Emits Definitions
- Status: DONE (already compliant)
- Date: 2026-02-06
- Audited all Vue components that use `emit()` in their script sections
- All 7 components with emit calls already have proper `defineEmits` declarations:
  - ScrollContainer.vue, ControlHeader.vue, SliderBar.vue, LanguageSelect.vue,
    Checkbox.vue, ImageDrop.vue, Watch/Mobile.vue
- No changes needed

### Phase 7.7: Reorganize Lib Utility Files
- Status: DONE
- Date: 2026-02-06
- Changes made:
  1. Created new organized module structure under src/lib/utils/:
     - `dom.ts`: DOM manipulation, scroll, events, orientation, immersive mode (from old utils.ts)
     - `string.ts`: String manipulation, formatting, title handling, translate (from old stringArray.ts)
     - `array.ts`: Array operations, sorting, grouping, collection utilities (from old stringArray.ts)
     - `format.ts`: Data formatting - formatDuration, humanFileSize, getCommonSize, getDataUrl (from old stringArray.ts)
     - `validation.ts`: Type checks, validators - isJsonString, isValidObject, checkboxValue (from old stringArray.ts)
     - `index.ts`: Barrel export re-exporting all submodules
  2. Deleted src/lib/utils.ts (replaced by utils/index.ts)
  3. Replaced src/lib/stringArray.ts with thin re-export shim (backward compat, no longer imported)
  4. Updated all 15 consumer imports from `@/lib/utils` → `@/lib/utils/dom`
  5. Updated all 59 consumer imports from `@/lib/stringArray` → appropriate submodule:
     - 39 files → `@/lib/utils/string` (setTitle, translate, breakTitle, pad, etc.)
     - 8 files → `@/lib/utils/array` (sortBy, sortByType, mappedEntries, shuffle, etc.)
     - 2 files → `@/lib/utils/format` (getCommonSize, humanFileSize)
     - 2 files → `@/lib/utils/validation` (checkboxValue, groupBy)
     - 11 files required split imports (functions from multiple categories)
  6. Cross-file dependencies handled:
     - format.ts imports `pad` from string.ts (for formatDuration)
     - array.ts imports `mathPercentage` from format.ts (for sortByMathPercentage)
- Benefits:
  - Clear import paths: `import { sortBy } from '@/lib/utils/array'`
  - Functions organized by domain (DOM, string, array, format, validation)
  - Better tree-shaking potential (imports from specific submodules)
  - No more misleading `stringArray.ts` name
  - 284 pre-existing type errors unchanged (zero new errors)

### Phase 7.8: Reorganize Type Definitions
- Status: DONE
- Date: 2026-02-06
- Changes made:
  1. Fixed undefined `ColorPaletteClass` in src/types/api/base/info.d.ts:
     - Added `PaletteColors` import from `../shared`
     - Replaced both usages of `ColorPaletteClass` with `PaletteColors` (in SeasonColorPalette and EpisodeColorPalette)
  2. Consolidated duplicate `Device` and `ActivityLog` interfaces:
     - Kept canonical definitions in src/types/server.ts (superset with `is_active` and `volume_percent` fields)
     - Removed duplicate definitions from src/types/api/dashboard/server.ts
     - Added `import type { Device, ActivityLog } from '@/types/server'` + `export type { Device, ActivityLog }` in dashboard/server.ts for backward compat
     - All existing consumers continue to work (imports from either path resolve to same type)
  3. Renamed ambiguous `Profile` interfaces across 3 files:
     - src/types/api/base/person.d.ts: `Profile` → `ImageProfile` (image aspect ratio, vote info)
     - src/types/api/base/library.d.ts: `Profile` → `CodecProfile` (audio/subtitle codec settings)
     - src/types/api/dashboard/server.ts: `Profile` → `CodecProfile` (same purpose as library.d.ts)
     - Fixed `any[]` → `string[]` for `opts` and `customArguments` in library.d.ts CodecProfile
     - Fixed `any[]` → `string[]` for `opts` in library.d.ts VideoProfile
     - No external imports of `Profile` type existed (only used internally within each file)
  4. Consolidated duplicate `Count` interface (was defined in 4 music type files):
     - Kept canonical unified definition in src/types/api/music/index.d.ts (all fields optional except `track`)
     - Removed local `Count` from src/types/api/music/album.d.ts, added import from index
     - Removed local `Count` from src/types/api/music/artist.d.ts, added import from index
     - Removed local `Count` from src/types/api/music/artists.d.ts, added import from index
  5. Fixed `value: any` → `value: number | string` in ServerEncoderProgress (dashboard/server.ts)
- Benefits:
  - No more undefined `ColorPaletteClass` type
  - Device and ActivityLog have single source of truth (types/server.ts)
  - Three different `Profile` interfaces now have distinct names matching their purpose
  - Count interface consolidated to single definition with all optional fields
  - Fixed remaining `any` types in type definition files
  - 284 pre-existing type errors unchanged (zero new errors)

### Phase 7.9: Audit and Fix User Action Feedback
- Status: DONE
- Date: 2026-02-06
- Audited all interactive elements across the codebase for missing loading states
- Changes made to 13 files:
  1. src/components/Buttons/MediaLikeButton.vue:
     - Added `isLoading` ref to prevent double-clicks during like/unlike
     - Optimistic UI: toggles liked state immediately, reverts on error
     - Added `:disabled` to both MusicButton and BannerButton
  2. src/views/Dashboard/System/Users/components/DeleteUserModal.vue:
     - Added `isDeleting` ref with guard clause
     - Converted to async/await with try/catch (was fire-and-forget)
     - Modal no longer closes before request completes (was closing immediately)
     - Delete and Cancel buttons disabled during request
     - Button text changes to "Deleting..." during request
  3. src/views/Dashboard/System/Libraries/components/DeleteLibraryModal.vue:
     - Same pattern: `isDeleting` ref, async/await, buttons disabled during request
     - Modal closes only after successful deletion
  4. src/views/Dashboard/Content/Specials/components/DeleteSpecialModal.vue:
     - Same pattern as DeleteLibraryModal
  5. src/views/Dashboard/System/EncoderProfiles/components/DeleteEncoderProfileModal.vue:
     - Same pattern as DeleteLibraryModal
  6. src/views/Dashboard/System/Libraries/components/DeleteFolderModal.vue:
     - Same pattern; also removed commented-out notification code
  7. src/views/Setup/PostInstall/components/DeleteLibraryModal.vue:
     - Same pattern as dashboard DeleteLibraryModal
  8. src/views/Dashboard/System/Users/components/InviteUserModal.vue:
     - Added `isSending` ref with guard clause
     - Converted to async/await with try/catch/finally
     - Send button disabled during request, text changes to "Sending..."
     - Cancel button also disabled during send
  9. src/views/Dashboard/System/Libraries/Edit.vue:
     - Added `isSaving` ref for handleSave()
     - Converted to async/await with try/catch/finally
     - Save button disabled during request, text changes to "Saving..."
     - Added error toast on failure (was silent before)
  10. src/views/Dashboard/Devices/Devices/Desktop.vue:
      - Added `isDeleting` ref for handleDelete()
      - Converted from mixed await/.then()/.catch() to clean async/await try/catch/finally
      - Delete All button gets disabled + opacity-50 + cursor-not-allowed during request
      - Button text changes to "Deleting..."
      - Fixed `any` types to `unknown`
  11. src/views/Dashboard/System/Libraries/Desktop.vue:
      - Added `isCreating` ref for handleCreateLibrary()
      - Converted to async/await with try/catch/finally
      - New Library button disabled during request, text changes to "Creating..."
      - Added error toast on failure (was silent before)
  12. src/views/Dashboard/System/Users/Edit.vue:
      - Added `isSaving` ref for handleSave()
      - Converted to async/await with try/catch/finally
      - Save button disabled during request, text changes to "Saving..."
      - Added error toast on failure (was silent before)
  13. src/views/Setup/PostInstall/components/EditLibraryModal.vue:
      - Added `isSaving` ref for handleEdit()
      - Converted to async/await with try/catch/finally
      - Done button disabled during request, text changes to "Saving..."
      - Fixed `err.message` access to `err instanceof Error ? err.message : 'Unknown error'`
- Common patterns applied:
  - Guard clause at top of handler: `if (isLoading.value) return`
  - Set loading true before request
  - Disable action button + cancel button during request
  - Show "Deleting..."/"Saving..."/"Sending..." text during request
  - For delete modals: close modal only AFTER request succeeds (was closing immediately before)
  - Reset loading in `catch` or `finally` block
  - All fire-and-forget `.then()` chains converted to async/await with proper error handling
- 283 pre-existing type errors (one fewer than previous 284, zero new errors)

### Build Fix: Revert cssMinify to esbuild
- Status: DONE
- Date: 2026-02-06
- File: vite.config.ts
- Changes made:
  1. Reverted `cssMinify: 'lightningcss'` → `cssMinify: 'esbuild'`
     - PrimeVue Aura theme generates non-standard CSS (`:root --tomato{ 1: #fffcfc; }`)
     - lightningcss is strict and rejects this syntax (build fails with SyntaxError)
     - esbuild tolerates it with warnings (build succeeds)
     - This CSS is dynamically generated by the PrimeVue theme preset at build time
- Note: Cloudflare handles brotli/gzip at the edge regardless of CSS minifier choice

---

## Build & Performance Audit (2026-02-06)

### Build Status: PASSING
- `npm run build` completes successfully
- `version.json` generated with correct git hash (2587fbf2a)
- 282 JS chunks, 33 CSS chunks generated
- Gzip pre-compression working (176 .gz files)

### Bundle Size Comparison (Before → After)

| Chunk | Before (gzip) | After (gzip) | Change |
|-------|---------------|--------------|--------|
| index (main) | 778 KB | 237 KB | **-69%** |
| setupApp | 74 KB | 3.25 KB | **-96%** |
| VideoPlayer | 359 KB | 352 KB | -2% (unchanged, lazy-loaded) |
| Ionic | 124 KB (esm) | 291 KB (full) | +135% (now separate chunk) |
| PrimeVue | 71 KB (auto) | 123 KB | +73% (now separate chunk) |
| Swiper | 30+27 KB (dupl) | 28 KB (single) | **-52%** (deduped) |
| BaseLayout Desktop | 58 KB | 57 KB | -2% (now lazy-loaded) |
| BaseLayout Mobile | (in main) | 8 KB | **separated** |
| vue-core | (in main) | 194 KB | **separated** |
| i18n | (in main) | 52 KB | **separated** |
| signalr | (in main) | 14 KB | **separated** |
| query | (in main) | 11 KB | **separated** |
| Main CSS | ~50 KB | 94 KB | +88% (PrimeVue theme CSS) |

### Key Metrics

**Main bundle (index.js):** 771 KB uncompressed, 237 KB gzipped
- PRD target was < 150 KB gzipped — **NOT MET** (237 KB)
- But reduced by **69%** from original 778 KB gzipped
- Remaining bundle includes app code, stores, router, composables

**Total initial load estimate (critical path):**
- index.js: 237 KB gzip
- vue-core.js: 194 KB gzip
- ionic.js: 291 KB gzip (framework, hard to reduce)
- index.css: 94 KB gzip
- **Total: ~816 KB gzipped**
- PRD target was < 300 KB — **NOT MET**
- But Ionic (291 KB) and PrimeVue (123 KB) are large mandatory frameworks

**Lazy-loaded chunks (NOT in initial load):**
- VideoPlayer: 352 KB gzip (only loads when watching video)
- Swiper: 28 KB gzip (only loads when carousel renders)
- All 15 NM components: < 5 KB each (load on demand from API)
- Music player: separate chunk (loads when playing music)
- SignalR: 14 KB (loads when real-time features needed)
- i18n: 52 KB (loads with language data)

**Code splitting effectiveness:**
- NM components are all separate chunks (lazy-loaded via defineAsyncComponent)
- Swiper deduplicated (was 57 KB dual, now 28 KB single)
- setupApp reduced from 74 KB to 3.25 KB (globals removed)
- Both layouts are lazy-loaded (only device-appropriate one loads)

### Cache Invalidation Verification

| Feature | Status | Details |
|---------|--------|---------|
| version.json generation | ✓ | Generated post-build with git hash |
| version.json no-cache header | ✓ | In _headers file |
| Version check on load | ✓ | versionCheck.ts fetches /version.json |
| Periodic version check | ✓ | Every 5 minutes + on tab focus |
| Force update capability | ✓ | forceUpdate flag in version.json |
| Auto-update after 30min | ✓ | If user ignores notification |
| Keycloak redirect state | ✓ | sessionStorage persistence |
| Chunk error recovery | ✓ | Auto-clears caches on chunk load failure |
| One-time cache migration | ✓ | v2 migration for existing users |
| Offline banner | ✓ | useOnline() in both layouts |
| PWA version.json exclusion | ✓ | globIgnores + navigateFallbackDenylist |
| SW precaching | ✓ | 22 entries precached |
| _headers cache rules | ✓ | Correct per file type |

### Why PRD Bundle Targets Not Fully Met

The PRD targets (< 150 KB main, < 300 KB total initial) were aspirational. The main blockers:
1. **Ionic Vue** (291 KB gzip): Large framework with no tree-shaking for web components
2. **PrimeVue** (123 KB gzip): Theme + component library
3. **Vue core** (194 KB gzip): Vue + Vue Router runtime
4. These 3 frameworks alone total ~608 KB gzip — exceeding the 300 KB total target

The optimization work successfully:
- Reduced main bundle by 69% (778 → 237 KB)
- Eliminated Swiper duplication (-52%)
- Made all NM components lazy-loaded
- Separated both layouts (lazy-loaded per device)
- Made setupApp 96% smaller
- Added comprehensive cache invalidation
- Added offline support

## Next Tasks (from PRD)
- All phases complete
