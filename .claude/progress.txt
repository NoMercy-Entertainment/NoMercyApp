# NoMercy.App Performance Optimization Progress

## Completed Tasks

### Phase 1.1: Configure Manual Chunks (vite.config.ts)
- Status: DONE (prior to this session)
- Changed manualChunks from object syntax to function syntax for rolldown-vite compatibility

### Phase 1.2: Fix Layout Imports (src/router/routes.ts)
- Status: DONE
- Date: 2026-02-05
- Changed layout imports from immediate execution to lazy-loaded functions:
  - `const MobileBaseLayout = import(...)` → `const MobileBaseLayout = () => import(...)`
  - `const DesktopBaseLayout = import(...)` → `const DesktopBaseLayout = () => import(...)`
- This prevents both layouts from loading at module initialization; only the needed layout loads when used

### Phase 1.3: Remove Swiper Duplication
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Removed web component bundle import and registration from src/setupApp.ts:
     - Removed `import { register as registerSwiperElements } from 'swiper/element/bundle';`
     - Removed `registerSwiperElements();` call
  2. Removed duplicate web component registration from src/components/Carousel/Carousel.vue:
     - Removed `import { register } from 'swiper/element/bundle';`
     - Removed `register();` call
- The app now only uses Vue Swiper components (Swiper, SwiperSlide from 'swiper/vue')
- This eliminates ~100KB of duplicate Swiper code (web component bundle)

### Phase 1.4: Add Preconnect Hints (index.html)
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Removed placeholder dns-prefetch for `//api.example.com`
  2. Removed `x-dns-prefetch-control: off` meta tag
  3. Added preconnect hints for external domains:
     - `https://media.themoviedb.org` (TMDB images)
     - `https://app.nomercy.tv` (app server)
     - `https://auth-dev.nomercy.tv` (Keycloak auth)
     - `https://fonts.bunny.net` (Google Fonts alternative)
  4. Added dns-prefetch for `https://cdn.nomercy.tv`
- Font preloads already existed in the file, kept as is

### Phase 2.1: Convert NM Components to Local Component Map with Lazy Loading
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/components/nmComponentMap.ts:
     - Single shared export with all 15 NM components as defineAsyncComponent lazy imports
     - Used by all components that render dynamic NM components
  2. Updated src/setupApp.ts:
     - Removed all NM component imports and global registrations
     - Removed unused supportsCarousel variable and isMobile import
  3. Updated components to use shared nmComponentMap:
     - src/components/NMComponent.vue
     - src/components/NMCarousel.vue
     - src/components/NMCarousel2.vue
     - src/components/NMContainer.vue
     - src/components/NMList.vue
     - src/components/NMGrid.vue
- Benefits:
  - Single source of truth for NM component map (DRY principle)
  - NM components now load only when API requests them
  - Reduces initial bundle size (components split into separate chunks)
  - Easy to add new NM components - just update nmComponentMap.ts

### Phase 2.1b: Add Loading Skeletons for Lazy-Loaded Components
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/components/Loading/NMCardSkeleton.vue:
     - Animated pulse placeholder with correct aspect ratio (poster/backdrop)
     - Matches card dimensions to prevent layout shift
  2. Updated src/components/nmComponentMap.ts:
     - Card components now use loadingComponent option with NMCardSkeleton
     - Applied to: NMCard, NMGenreCard, NMHomeCard, NMSeasonCard, NMMusicCard,
       NMMusicHomeCard, NMTopResultCard
- Benefits:
  - Prevents CLS (Cumulative Layout Shift) while async components load
  - Smooth loading experience with animated placeholders

### Phase 2.2: Use defineAsyncComponent for Heavy Components
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Created src/components/Loading/MusicPlayerSkeleton.vue:
     - Skeleton placeholder matching the desktop music player layout
     - Shows animated pulse placeholders for cover, controls, and volume
  2. Created src/components/async.ts:
     - AsyncMusicPlayerDesktop: lazy-loaded with MusicPlayerSkeleton
     - AsyncMusicPlayerFull: lazy-loaded mobile full player
     - AsyncMusicPlayerMini: lazy-loaded mobile mini player
  3. Updated src/Layout/Desktop/BaseLayout.vue:
     - Changed MusicPlayerDesktop import to AsyncMusicPlayerDesktop
  4. Updated src/Layout/Mobile/BaseLayout.vue:
     - Changed FullPlayer and MiniPlayer imports to async versions
- Notes:
  - VideoPlayer: Already an external library (@nomercy-entertainment/nomercy-video-player), not a Vue component
  - Dashboard: Already uses defineAsyncComponent with route-based lazy loading
  - Focus was on MusicPlayer components which were eagerly loaded in layouts

### Phase 2.3: Implement Component-Level Code Splitting (Swiper local imports)
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Removed global Swiper registration from src/setupApp.ts:
     - Removed `import { Swiper } from 'swiper'` and `import { SwiperSlide } from 'swiper/vue'`
     - Removed `app.component('Swiper', Swiper)` and `app.component('SwiperSlide', SwiperSlide)`
  2. Moved Swiper CSS from global to local imports:
     - Removed `import 'swiper/css'` and `import 'swiper/element/css/keyboard'` from src/main.ts
     - Added `import 'swiper/css'` locally in 4 components that use Swiper:
       - src/components/Carousel/Carousel.vue
       - src/components/NMCarousel.vue
       - src/components/MusicPlayer/mobile/FullPlayer.vue
       - src/views/Base/Person/Mobile.vue
  3. Removed unused `swiper/element/css/keyboard` import (keyboard: false in swiper config)
- All components already had local Swiper JS imports; only global registration and CSS were remaining
- Benefits:
  - Swiper JS and CSS are fully code-split from the main bundle
  - Swiper code only loads when a carousel or swiper-using component is rendered
  - Removed unnecessary keyboard CSS import

### Phase 3.2: Responsive Image Loading (TMDBImage.vue)
- Status: DONE
- Date: 2026-02-05
- Changes made:
  1. Added device pixel ratio detection (reads window.devicePixelRatio once at module level)
  2. Created `optimizedSize` computed that uses 2x multiplier only for high-DPI displays (>1.5 DPR),
     1x multiplier for standard displays (previously always used 2x)
  3. Added `&format=webp` to server image URL to request WebP format from the image proxy
  4. Updated `<source>` element with `type="image/webp"` for proper format negotiation
  5. Cleaned up commented-out source elements
  6. Preserved color palette gradient placeholder (Phase 3.1 - already correct, no changes needed)
  7. TMDB fallback URL kept as-is for browsers that don't support WebP
- Benefits:
  - 1x displays no longer download 2x resolution images (saves ~75% bandwidth for those users)
  - WebP format delivers ~25-35% smaller images vs JPEG/PNG
  - `<picture>` element with `<source type="image/webp">` provides automatic format fallback
  - Color palette gradient placeholders preserved as-is (PRD 3.1)

### Phase 4.1: Optimize TanStack Query Configuration
- Status: DONE
- Date: 2026-02-05
- File: src/config/tanstack-query.ts
- Changes made:
  1. Changed `retry: false` → `retry: 1` (one retry attempt for resilience)
  2. Added `retryDelay` with exponential backoff: `Math.min(1000 * 2 ** attemptIndex, 30000)`
  3. Changed `staleTime` from 1 hour (`1000 * 60 * 60`) to 5 minutes (`1000 * 60 * 5`)
  4. Added `gcTime: 1000 * 60 * 30` (garbage collect unused cache after 30 minutes)
  5. Preserved `experimental_prefetchInRender: true` (existing optimization)
- Benefits:
  - Failed requests get one retry with backoff instead of immediately failing
  - Stale data refetched sooner (5min vs 1hr) for fresher content
  - Unused query cache garbage-collected after 30min to reduce memory usage

### Phase 4.2: Replace structuredClone with Targeted Updates
- Status: DONE
- Date: 2026-02-05
- File: src/lib/routerHelper.ts
- Changes made:
  1. Replaced `structuredClone(toRaw(d))` on every item with targeted shallow copies:
     - Build a Set of `replace_id` values from the mutations
     - Only shallow-clone (`{ ...d }`) items whose `id` is in the mutation set
     - Unchanged items keep their original reference (no copy at all)
  2. Removed unused `toRaw` import from vue
- Benefits:
  - Eliminates expensive deep cloning of potentially large data arrays
  - Only items about to be replaced get a shallow copy (which is immediately overwritten anyway)
  - Reduces GC pressure and improves mutation performance

## Next Tasks (from PRD)
- Phase 4.3: Implement Request Deduplication (src/lib/clients/serverClient.ts)
